/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import"../geometry.js";import{id as e}from"../kernel.js";import t from"../request.js";import r from"../core/Error.js";import{L as o}from"../chunks/Logger.js";import n from"./knowledgeGraph/GraphQueryResult.js";import a from"./knowledgeGraph/GraphQueryStreamingResult.js";import i from"./knowledgeGraph/KnowledgeGraph.js";import{g as s}from"../chunks/assets.js";import{h as l}from"../chunks/object.js";import d from"../geometry/Multipoint.js";import p from"../geometry/Point.js";import u from"../geometry/Polygon.js";import c from"../geometry/Polyline.js";import y from"../geometry/Geometry.js";import g from"./knowledgeGraph/Entity.js";import h from"./knowledgeGraph/Relationship.js";import m from"../geometry/SpatialReference.js";import f from"./knowledgeGraph/DataModel.js";import{_}from"../chunks/tslib.es6.js";import w from"../core/Accessor.js";import{property as E}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import"../chunks/ensureType.js";import{subclass as b}from"../core/accessorSupport/decorators/subclass.js";import T from"./knowledgeGraph/EntityType.js";import G from"./knowledgeGraph/FieldIndex.js";import"./knowledgeGraph/GraphObjectType.js";import I from"./knowledgeGraph/GraphProperty.js";import k from"./knowledgeGraph/RelationshipType.js";import F from"./knowledgeGraph/GraphObject.js";import M from"./knowledgeGraph/Path.js";import R from"./knowledgeGraph/GraphApplyEditsResult.js";import"../geometry/Extent.js";import"../chunks/maybe.js";import"../chunks/string.js";import"../geometry/support/webMercatorUtils.js";import"../chunks/Ellipsoid.js";import"../core/JSONSupport.js";import"../chunks/get.js";import"../chunks/utils.js";import"../chunks/handleUtils.js";import"../core/Handles.js";import"../chunks/metadata.js";import"../chunks/ArrayPool.js";import"../chunks/tracking.js";import"../chunks/watch.js";import"../core/scheduling.js";import"../chunks/nextTick.js";import"../core/promiseUtils.js";import"../config.js";import"../chunks/writer.js";import"../chunks/reader.js";import"../core/accessorSupport/decorators/cast.js";import"../chunks/typeUtils.js";import"../chunks/jsonMap.js";import"../geometry/support/jsonUtils.js";import"../chunks/zmUtils.js";import"../chunks/extentUtils.js";import"../core/urlUtils.js";import"./knowledgeGraph/GraphNamedObject.js";let j;async function O(){if(j)return j;const e=l("wasm-simd");return j=async function(e){if(e){const{default:e}=await import("../chunks/arcgis-knowledge-client-core-simd.js").then((e=>e.a));return e({locateFile:e=>s("esri/rest/knowledgeGraph/wasmInterface/"+e)})}const{default:t}=await import("../chunks/arcgis-knowledge-client-core.js").then((e=>e.a));return t({locateFile:e=>s("esri/rest/knowledgeGraph/wasmInterface/"+e)})}(e),j}function v(e,t){const r=new t.ArrayValue;return r.deleteLater(),e.forEach((e=>{r.add_value(A(e,t))})),r}function x(e,t){const r=new t.ObjectValue;r.deleteLater();for(const[o,n]of Object.entries(e))r.set_key_value(o,A(n,t));return r}function S(e,t){if(e instanceof d)return function(e,t){const r=new t.GeometryValue;r.deleteLater(),r.geometry_type=r.geometry_type=t.esriGeometryType.esriGeometryMultipoint,r.has_z=e.hasZ,r.has_m=e.hasM;const o=[],n=[];n[0]=e.points.length;let a=0;return e.points.forEach((e=>{e.forEach((e=>{o[a]=e,a++}))})),r.coords=new Float64Array(o),r.lengths=new Uint32Array(n),r}(e,t);if(e instanceof p)return function(e,t){const r=new t.GeometryValue;r.deleteLater(),r.geometry_type=t.esriGeometryType.esriGeometryPoint,r.has_z=e.hasZ,r.has_m=e.hasM;const o=[],n=[];n[0]=1,o[0]=e.x,o[1]=e.y;let a=2;return e.hasZ&&(o[a]=e.z,a++),e.hasM&&(o[a]=e.m,a++),r.coords=new Float64Array(o),r.lengths=new Uint32Array(n),r}(e,t);if(e instanceof c||e instanceof u)return function(e,t){const r=new t.GeometryValue;r.deleteLater(),r.has_z=e.hasZ,r.has_m=e.hasM;const o=[],n=[];let a=[];e instanceof c?(r.geometry_type=t.esriGeometryType.esriGeometryPolyline,a=e.paths):e instanceof u&&(r.geometry_type=t.esriGeometryType.esriGeometryPolygon,a=e.rings);let i=0,s=0;return a.forEach((e=>{let t=0;e.forEach((e=>{t++,e.forEach((e=>{o[s]=e,s++}))})),n[i]=t,i++})),r.coords=new Float64Array(o),r.lengths=new Uint32Array(n),r}(e,t);throw new r("knowledge-graph:unsupported-geometry","Only Point, Multipoint, Polyline, and Polygon geometry are supported by ArcGIS Knowledge",{geometry:e})}function A(e,t){if(null==e)return"";if("object"!=typeof e)return e;if(e instanceof Date)return e;if(e instanceof y)return S(e,t);if(Array.isArray(e)){const r=new t.ArrayValue;return r.deleteLater(),e.forEach((e=>{r.add_value(A(e,t))})),r}return x(e,t)}function L(e,t){if(!e.typeName)throw new r("knowledge-graph:no-type-name","You must indicate the entity/relationship named object type to apply edits");if(e instanceof g){const r=new t.EntityValue;r.deleteLater(),r.type_name=e.typeName;for(const[o,n]of Object.entries(e.properties))r.set_key_value(o,P(n,t));return r}if(e instanceof h){const r=new t.RelationshipValue;r.deleteLater(),r.type_name=e.typeName;for(const[o,n]of Object.entries(e.properties))r.set_key_value(o,P(n,t));return r}throw new r("knowledge-graph:applyEdits-encoding-failure","Could not determine the type of a named graph object passed to the encoder")}function P(e,t){return null==e?"":"object"!=typeof e||e instanceof Date?e:e instanceof y?S(e,t):""}let z=class extends w{constructor(e){super(e),this.nameField=null,this.titleField=null,this.urlField=null,this.textField=null,this.keywordsField=null,this.contentTypeField=null,this.metadataField=null,this.fileExtensionField=null}};_([E()],z.prototype,"nameField",void 0),_([E()],z.prototype,"titleField",void 0),_([E()],z.prototype,"urlField",void 0),_([E()],z.prototype,"textField",void 0),_([E()],z.prototype,"keywordsField",void 0),_([E()],z.prototype,"contentTypeField",void 0),_([E()],z.prototype,"metadataField",void 0),_([E()],z.prototype,"fileExtensionField",void 0),z=_([b("esri.rest.knowledgeGraph.DocumentEntityTypeInfo")],z);const Y=z;var N,q,U;function C(e){return{name:e.name,alias:e.alias,role:N[e.role.value]?N[e.role.value]:null,strict:e.strict,properties:K(e.properties),fieldIndexes:W(e.field_indexes)}}function D(e){e.deleteLater();const t=C(e);return new k(Object.assign({strictOrigin:e.strict_origin,strictDestination:e.strict_destination,originEntityTypes:B(e.origin_entity_types),destinationEntityTypes:Q(e.destination_entity_types)},t))}function Q(e){const t=[];for(let r=0;r<e.size();r++)t.push(e.get(r));return t}function H(e){const t=[];for(let o=0;o<e.size();o++)t.push(((r=e.get(o)).deleteLater(),new T(C(r))));var r;return t}function V(e){const t=[];for(let r=0;r<e.size();r++)t.push(e.get(r));return t}function K(e){const t=[];for(let o=0;o<e.size();o++)t.push(((r=e.get(o)).deleteLater(),new I({alias:r.alias,name:r.name,fieldType:q[r.field_type.value]?q[r.field_type.value]:null,geometryType:U[r.geometry_type.value]?U[r.geometry_type.value]:null,hasM:r.has_m,hasZ:r.has_z,nullable:r.nullable,editable:r.editable,required:r.required,defaultVisibility:r.default_visibility,systemMaintained:r.system_maintained,searchable:r.searchable,defaultValue:r.default_value})));var r;return t}function W(e){const t=[];for(let o=0;o<e.size();o++)t.push(((r=e.get(o)).deleteLater(),new G({name:r.name,unique:r.unique,ascending:r.ascending,description:r.description,fieldNames:V(r.fields)})));var r;return t}function B(e){const t=[];for(let r=0;r<e.size();r++)t.push(e.get(r));return t}function Z(e){const t=[];for(let r=0;r<e.size();r++)t.push(D(e.get(r)));return t}!function(e){e[e.Regular=0]="Regular",e[e.Provenance=1]="Provenance",e[e.Document=2]="Document"}(N||(N={})),function(e){e[e.esriFieldTypeSmallInteger=0]="esriFieldTypeSmallInteger",e[e.esriFieldTypeInteger=1]="esriFieldTypeInteger",e[e.esriFieldTypeSingle=2]="esriFieldTypeSingle",e[e.esriFieldTypeDouble=3]="esriFieldTypeDouble",e[e.esriFieldTypeString=4]="esriFieldTypeString",e[e.esriFieldTypeDate=5]="esriFieldTypeDate",e[e.esriFieldTypeOID=6]="esriFieldTypeOID",e[e.esriFieldTypeGeometry=7]="esriFieldTypeGeometry",e[e.esriFieldTypeBlob=8]="esriFieldTypeBlob",e[e.esriFieldTypeRaster=9]="esriFieldTypeRaster",e[e.esriFieldTypeGUID=10]="esriFieldTypeGUID",e[e.esriFieldTypeGlobalID=11]="esriFieldTypeGlobalID",e[e.esriFieldTypeXML=12]="esriFieldTypeXML",e[e.esriFieldTypeBigInteger=13]="esriFieldTypeBigInteger"}(q||(q={})),function(e){e[e.esriGeometryNull=0]="esriGeometryNull",e[e.esriGeometryPoint=1]="esriGeometryPoint",e[e.esriGeometryMultipoint=2]="esriGeometryMultipoint",e[e.esriGeometryPolyline=3]="esriGeometryPolyline",e[e.esriGeometryPolygon=4]="esriGeometryPolygon",e[e.esriGeometryEnvelope=5]="esriGeometryEnvelope",e[e.esriGeometryAny=6]="esriGeometryAny",e[e.esriGeometryMultiPatch=7]="esriGeometryMultiPatch"}(U||(U={}));let $=class extends F{constructor(e){super(e)}};$=_([b("esri.rest.knowledgeGraph.ObjectValue")],$);const J=$;var X,ee,te;function re(e){const t={},o=oe(e,t),n=e.lengths,a=e.coords;let i="";if(e.geometry_type.value===X.ESRI_GEOMETRY_POLYGON)i="rings";else{if(e.geometry_type.value!==X.ESRI_GEOMETRY_POLYLINE)throw new r("KnowledgeGraph:illegal-geometry-type","Illegal Geometry type for multipath conversion");i="paths"}t[i]=[];let s=0;return n.forEach((e=>{const r=[];for(let t=0;t<e;t++){const e=[];for(let t=0;t<o;t++)e[t]=a[s],s++;r.push(e)}t[i].push(r)})),t}function oe(e,t){let r=2;return e.has_z?(t.hasZ=e.has_z,r++):t.hasZ=!1,e.has_m?(t.hasM=e.has_m,r++):t.hasM=!1,r}!function(e){e[e.ESRI_GEOMETRY_NULL=0]="ESRI_GEOMETRY_NULL",e[e.ESRI_GEOMETRY_POINT=1]="ESRI_GEOMETRY_POINT",e[e.ESRI_GEOMETRY_MULTIPOINT=2]="ESRI_GEOMETRY_MULTIPOINT",e[e.ESRI_GEOMETRY_POLYLINE=3]="ESRI_GEOMETRY_POLYLINE",e[e.ESRI_GEOMETRY_POLYGON=4]="ESRI_GEOMETRY_POLYGON",e[e.ESRI_GEOMETRY_ENVELOPE=5]="ESRI_GEOMETRY_ENVELOPE",e[e.ESRI_GEOMETRY_ANY=6]="ESRI_GEOMETRY_ANY",e[e.ESRI_GEOMETRY_MULTI_PATCH=7]="ESRI_GEOMETRY_MULTI_PATCH"}(X||(X={})),function(e){e[e.OBJECT=0]="OBJECT",e[e.ENTITY=1]="ENTITY",e[e.RELATIONSHIP=2]="RELATIONSHIP",e[e.PATH=3]="PATH",e[e.ARRAY=4]="ARRAY"}(ee||(ee={})),function(e){e[e.view=0]="view",e[e.edit=1]="edit"}(te||(te={}));const ne=o.getLogger("esri.rest.knowledgeGraph.WasmToQueryResponseObjConstructors");function ae(e,t){if(null==e)return null;if("object"!=typeof e)return e;if("getDate"in e)return e;if("geometry_type"in e)switch(e.geometry_type.value){case null:return null;case X.ESRI_GEOMETRY_POINT:return function(e){const t={};let r=2;oe(e,t);const o=e.coords;return t.x=o[0],t.y=o[1],e.has_z&&(t.z=o[r],r++),e.has_m&&(t.m=o[r]),new p(t)}(e);case X.ESRI_GEOMETRY_MULTIPOINT:return function(e){const t={},r=oe(e,t),o=e.lengths,n=e.coords,a=o[0];t.points=[];let i=0;for(let e=0;e<a;e++){const e=[];for(let t=0;t<r;t++)e[t]=n[i],i++;t.points.push(e)}return new d(t)}(e);case X.ESRI_GEOMETRY_POLYLINE:return new c(re(e));case X.ESRI_GEOMETRY_POLYGON:return new u(re(e));case X.ESRI_GEOMETRY_ENVELOPE:case X.ESRI_GEOMETRY_MULTI_PATCH:return ne.warnOnce("Envelope and Multipatch are not supported on knowledge entities, but one of those geometry types was detected.  Result interpreted as null"),null;case X.ESRI_GEOMETRY_NULL:case X.ESRI_GEOMETRY_ANY:default:return ne.warnOnce("Unknown or blank geometry type returned - Result interpreted as null"),null}else{if(!("object_value_type"in e))return ne.warnOnce("A decoded value came back of a type that is not supported.  Result interpreted as null"),null;switch(e.object_value_type.value){case ee.OBJECT:return function(e,t){return new J(se(e,t))}(e,t);case ee.ENTITY:return ie(e,t);case ee.RELATIONSHIP:return le(e,t);case ee.PATH:return function(e,t){const r=e.entity_count(),o=e.relationship_count(),n=[];for(let a=0;a<r;a++)n.push(ie(e.get_entity_at(a),t)),a<o&&n.push(le(e.get_relationship_at(a),t));return new M({path:n})}(e,t);case ee.ARRAY:return function(e,t){const r=[],o=e.count();for(let n=0;n<o;n++){const o=e.get_value_at(n);r.push(ae(o,t))}return r}(e,t);default:return ne.warnOnce("Unknown graph object type detected!  Result interpreted as null"),null}}}function ie(e,t){const r=e.type_name,o=se(e,t),n=t.globalIdField&&o.properties?o.properties[t.globalIdField]:"";return new g(Object.assign({typeName:r,id:n},o))}function se(e,t){const r={},o=e.key_count();for(let n=0;n<o;n++)r[e.get_key_at(n)]=ae(e.get_value_at(n),t);return{properties:r}}function le(e,t){const r=e.type_name,o=se(e,t);return new h(Object.assign({typeName:r,id:t.globalIdField&&o.properties?o.properties[t.globalIdField]:"",originId:t.originEntityGlobalIdField&&o.properties?o.properties[t.originEntityGlobalIdField]:"",destinationId:t.destEntityGlobalIdField&&o.properties?o.properties[t.destEntityGlobalIdField]:""},o))}async function de(e,t,o){const n=`${e.url}/graph/applyEdits`;await me(e);const a=await we(n,o);return a.data.body=await async function(e,t){if(t.dataModel||await he(t),!t.dataModel)throw new r("knowledge-graph:data-model-undefined","Encoding could not proceed because a data model was not provided and it could not be determined from the service");const o=await O(),n=!!e.options?.cascadeDelete,a=new o.GraphApplyEditsEncoder(!0,t.dataModel.objectIdField,t.dataModel.globalIdField,o.SpatialReferenceUtil.WGS84(),e.options?.inputQuantizationParameters?(i=e.options?.inputQuantizationParameters,{xy_resolution:i.xyResolution,x_false_origin:i.xFalseOrigin,y_false_origin:i.yFalseOrigin,z_resolution:i.zResolution,z_false_origin:i.zFalseOrigin,m_resolution:i.mResolution,m_false_origin:i.mFalseOrigin}):o.InputQuantizationUtil.WGS84_lossless());var i;a.deleteLater(),a.cascade_delete=n;try{let n;e.entityAdds?.forEach((e=>{n=a.add_entity(L(e,o)),fe(n,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - an entity failed to be added to the encoder")})),e.relationshipAdds?.forEach((e=>{if(!e.originId||!e.destinationId)throw new r("knowledge-graph:relationship-origin-destination-missing","When adding a new relationship, you must provide both an origin and destination globalid on the appropriate class property");t.dataModel?.originEntityGlobalIdField&&e.properties&&(e.properties[t.dataModel.originEntityGlobalIdField]=e.originId),t.dataModel?.destEntityGlobalIdField&&e.properties&&(e.properties[t.dataModel.destEntityGlobalIdField]=e.destinationId),n=a.add_relationship(L(e,o)),fe(n,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - an relationship failed to be added to the encoder")})),e.entityUpdates?.forEach((e=>{if(!e.id)throw new r("knowledge-graph:entity-id-missing","When updating an entity or relationship, you must specify the id on the class level property");t.dataModel?.globalIdField&&e.properties&&(e.properties[t.dataModel.globalIdField]=e.id),n=a.update_entity(L(e,o)),fe(n,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - an entity failed to be added to the encoder")})),e.relationshipUpdates?.forEach((e=>{if(!e.id)throw new r("knowledge-graph:relationship-id-missing","When updating an entity or relationship, you must specify the id on the class level property");t.dataModel?.globalIdField&&e.properties&&(e.properties[t.dataModel.globalIdField]=e.id),t.dataModel?.originEntityGlobalIdField&&e.properties&&e.originId&&(e.properties[t.dataModel.originEntityGlobalIdField]=e.originId),t.dataModel?.destEntityGlobalIdField&&e.properties&&e.destinationId&&(e.properties[t.dataModel.destEntityGlobalIdField]=e.destinationId),n=a.update_relationship(L(e,o)),fe(n,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - a relationship failed to be added to the encoder")})),e.entityDeletes?.forEach((e=>{if(!e.typeName)throw new r("knowledge-graph:no-type-name","You must indicate the entity/relationship named object type to apply edits - delete");const t=a.make_delete_helper(e.typeName,!0);t.deleteLater(),e.ids?.forEach((e=>{if("string"!=typeof e)throw new r("knowledge-graph:id-type-mismatch","All delete Ids must be globalIds for Enterprise 11.0 ArcGIS Knowledge Services");t.delete_by_globalid(e)}))})),e.relationshipDeletes?.forEach((e=>{if(!e.typeName)throw new r("knowledge-graph:no-type-name","You must indicate the entity/relationship named object type to apply edits - delete");const t=a.make_delete_helper(e.typeName,!1);e.ids?.forEach((e=>{if("string"!=typeof e)throw new r("knowledge-graph:id-type-mismatch","All delete Ids must be globalIds for Enterprise 11.0 ArcGIS Knowledge Services");t.delete_by_globalid(e)}))})),a.encode()}catch(e){throw new r("knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits failed",{error:e})}const s=a.get_encoding_result();return fe(s.error,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits failed"),s.get_byte_buffer()}(t,e),async function(e){const t=e.headers.get("content-type");if(t?.includes("application/x-protobuf")){const t=await e.arrayBuffer(),r=new((await O()).GraphApplyEditsDecoder);return r.deleteLater(),r.decode(new Uint8Array(t)),function(e){const t=new R;t.hasError=e.has_error(),t.hasError&&(t.error={errorCode:e.error.error_code,errorMessage:e.error.error_message});const r=e.get_edit_results_count();for(let o=0;o<r;o++){const r=e.get_edit_results_at(o),n=e.get_edit_results_type_name_at(o),a=[],i=[],s=[],l=r.get_add_results_count(),d=r.get_update_results_count(),p=r.get_delete_results_count();for(let e=0;e<l;e++){const t=r.get_add_result_at(e);a.push({id:t.globalId,error:{errorCode:t.error.error_code,errorMessage:t.error.error_message}})}for(let e=0;e<d;e++){const t=r.get_update_result_at(e);i.push({id:t.globalId,error:{errorCode:t.error.error_code,errorMessage:t.error.error_message}})}for(let e=0;e<p;e++){const t=r.get_delete_result_at(e);s.push({id:t.globalId,error:{errorCode:t.error.error_code,errorMessage:t.error.error_message}})}t.editResults.push({typeName:n,adds:a,updates:i,deletes:s})}return t}(r)}throw new r("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:t,data:e.text()})}(await fetch(a.data.url,a.data))}async function pe(e,o,a){const i=`${e.url}/graph/query`,s=await t(i,{responseType:"array-buffer",query:{f:"pbf",openCypherQuery:o.openCypherQuery,...a?.query},signal:a?.signal,timeout:a?.timeout}),l=s.getHeader?.("content-type"),d=s.data;if(l?.includes("application/x-protobuf")){const t=new((await O()).GraphQueryDecoder);if(t.deleteLater(),e.dataModel)return new n({resultRows:Ee(t,d,e.dataModel)});throw new r("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")}throw new r("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:l,data:s.data})}async function ue(e,t,o){const n=`${e.url}/graph/query`;await me(e);const i=await we(n,o);i.data.body=await async function(e,t){const o=await O(),n=new o.GraphQueryRequestEncoder;if(n.deleteLater(),n.output_spatial_reference=o.SpatialReferenceUtil.WGS84(),n.open_cypher_query=e.openCypherQuery,e.bindParameters)for(const[t,r]of Object.entries(e.bindParameters))_e(t,r,n,o);if(e.bindGeometryQuantizationParameters)a=e.bindGeometryQuantizationParameters,n.input_quantization_parameters={xy_resolution:a.xyResolution,x_false_origin:a.xFalseOrigin,y_false_origin:a.yFalseOrigin,z_resolution:a.zResolution,z_false_origin:a.zFalseOrigin,m_resolution:a.mResolution,m_false_origin:a.mFalseOrigin};else{if(t.dataModel||await he(t),4326!==t.dataModel?.spatialReference?.wkid)throw new r("knowledge-graph:SR-quantization-mismatch","If the DataModel indicates a coordinate system other than WGS84, inputQuantizationParameters must be provided to the query encoder");n.input_quantization_parameters=o.InputQuantizationUtil.WGS84_lossless()}var a;e.outputQuantizationParameters&&function(e,t,o){if(!e.extent)throw new r("knowledge-graph:illegal-output-quantization","The Output quantization provided to the encoder had an illegal value as part of its extent",e.extent);if(!e.quantizeMode)throw new r("knowledge-graph:illegal-output-quantization","The Output quantization contained an illegal mode setting",e.quantizeMode);if(!e.tolerance)throw new r("knowledge-graph:illegal-output-quantization","The Output quantization contained an illegal tolerance setting",e.quantizeMode);t.output_quantization_parameters={extent:{xmax:e.extent.xmax,ymax:e.extent.ymax,xmin:e.extent.xmin,ymin:e.extent.ymin},quantize_mode:o.esriQuantizeMode[e.quantizeMode],tolerance:e.tolerance}}(e.outputQuantizationParameters,n,o);try{n.encode()}catch(e){throw new r("knowledge-graph:query-encoding-failed","Attempting to encode the query failed",{error:e})}const i=n.get_encoding_result();if(0!==i.error.error_code)throw new r("knowledge-graph:query-encoding-failed","Attempting to encode the query failed",{errorCode:i.error.error_code,errorMessage:i.error.error_message});return i.get_byte_buffer()}(t,e);const s=await fetch(i.data.url,i.data);if(e.dataModel)return new a({resultRowsStream:await be(s,e.dataModel)});throw new r("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")}async function ce(e,o,a){let i=o.typeCategoryFilter;"entity"===o.typeCategoryFilter?i="entities":"relationship"===o.typeCategoryFilter&&(i="relationships");const s=`${e.url}/graph/search`,l=await t(s,{responseType:"array-buffer",query:{f:"pbf",searchQuery:`"${o.searchQuery}"`,typeCategoryFilter:i,...a?.query},signal:a?.signal,timeout:a?.timeout}),d=l.getHeader?.("content-type"),p=l.data;if(d?.includes("application/x-protobuf")){const t=new((await O()).GraphQueryDecoder);if(t.deleteLater(),e.dataModel)return new n({resultRows:Ee(t,p,e.dataModel)});throw new r("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")}throw new r("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:d,data:l.data})}async function ye(e,t,o){const n=`${e.url}/graph/search`;await me(e);const i=await we(n,o);i.data.body=await async function(e){const t=await O(),o=new t.GraphSearchRequestEncoder;if(o.deleteLater(),o.search_query=e.searchQuery,o.type_category_filter=t.esriNamedTypeCategory[e.typeCategoryFilter.toString()],!0===e.returnSearchContext&&(o.return_search_context=e.returnSearchContext),void 0!==e.start&&e.start>0&&(o.start_index=e.start),void 0!==e.num&&(o.max_num_results=e.num),void 0!==e.globalIdsFilter&&Array.isArray(e.globalIdsFilter)&&e.globalIdsFilter.length>0)try{o.set_globalids_filter(v(e.globalIdsFilter,t))}catch(e){throw new r("knowledge-graph:globalIds-format-error","Attempting to set globalids filter failed.  This is usually caused by an incorrectly formatted UUID string",{error:e})}e.namedTypesFilter?.forEach((e=>{o.add_named_type_filter(e)}));try{o.encode()}catch(e){throw new r("knowledge-graph:search-encoding-failed","Attempting to encode the search failed",{error:e})}const n=o.get_encoding_result();if(0!==n.error.error_code)throw new r("knowledge-graph:search-encoding-failed","Attempting to encode the search failed",{errorCode:n.error.error_code,errorMessage:n.error.error_message});return n.get_byte_buffer()}(t);const s=await fetch(i.data.url,i.data);if(e.dataModel)return new a({resultRowsStream:await be(s,e.dataModel)});throw new r("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model")}async function ge(e){const t=new i({url:e});return await he(t),t}async function he(e){e.dataModel=await Te(e)}async function me(t){const r=e?.findCredential(t.url);r||(t.dataModel?await Te(t):await he(t))}function fe(e,t,o){if(0!==e.error_code)throw new r(t,o,{errorCode:e.error_code,errorMessage:e.error_message})}function _e(e,t,r,o){null==t?r.set_param_key_value(e,""):"object"!=typeof t||t instanceof Date?r.set_param_key_value(e,t):t instanceof y?r.set_param_key_value(e,S(t,o)):t instanceof Array?r.set_param_key_value(e,v(t,o)):r.set_param_key_value(e,x(t,o))}async function we(e,r){return t(e,{responseType:"native-request-init",method:"post",query:{f:"pbf",...r?.query},body:"x",headers:{"Content-Type":"application/octet-stream"},signal:r?.signal,timeout:r?.timeout})}function Ee(e,t,o){e.push_buffer(new Uint8Array(t));const n=[];let a=0;for(;e.next_row();){a||(a=e.get_header_keys().size());const t=new Array(a);for(let r=0;r<a;r++){const n=e.get_value(r);t[r]=ae(n,o)}n.push(t)}if(e.has_error())throw new r("knowledge-graph:stream-decoding-error","One or more result rows were not successfully decoded",{errorCode:e.error.error_code,errorMessage:e.error.error_message});return n}async function be(e,t){const n=e.headers.get("content-type");if(e.headers.get("content-length")&&o.getLogger("esri.rest.knowledgeGraph.knowledgeGraphService").warnOnce("Found `Content-Length` header when expecting a streaming HTTP response! Please investigate whether all intermediate HTTP proxies and/or load balancers are configured such that they don't forcefully buffer the entire response before returning it to the client. A valid HTTP streaming response should use Chunked Transfer Encoding and not have a Content Length defined."),n?.includes("application/x-protobuf")){const o=e.body?.getReader(),n=new((await O()).GraphQueryDecoder);return n.deleteLater(),new ReadableStream({async start(e){try{return function a(){return o?.read().then((({done:i,value:s})=>{if(i){let t;if(n.has_error()&&(t=new r("knowledge-graph:stream-decoding-error","One or more result rows were not successfully decoded",{errorCode:n.error.error_code,errorMessage:n.error.error_message})),o.releaseLock(),t)throw e.error(t),t;return void e.close()}const l=Ee(n,s,t);return l.length>0&&e.enqueue(l),a()}))}()}catch(t){o?.releaseLock(),e.error(new r("knowledge-graph:stream-decoding-error","The server returned a valid response, but there was an error decoding the response stream",{error:t})),e.close()}}})}throw new r("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:n,data:e.text()})}async function Te(e){const o=`${e.url}/dataModel/queryDataModel`,n=await t(o,{responseType:"array-buffer",query:{f:"pbf"}}),a=n.getHeader?.("content-type"),i=n.data;if(a?.includes("application/x-protobuf"))return(s=(await O()).decode_data_model_from_protocol_buffer(new Uint8Array(i))).deleteLater(),new f({timestamp:s.timestamp,spatialReference:new m(s.spatial_reference),strict:s.strict,objectIdField:s.objectid_property,globalIdField:s.globalid_property,originEntityGlobalIdField:s.origin_entity_globalid_property,destEntityGlobalIdField:s.dest_entity_globalid_property,documentEntityTypeInfo:(l=s.document_entity_type_info,l.deleteLater(),new Y({nameField:l.name,titleField:l.title_property,urlField:l.url_property,textField:l.text_property,keywordsField:l.keywords_property,contentTypeField:l.content_type_property,metadataField:l.metadata_property,fileExtensionField:l.file_extension_property})),entityTypes:H(s.entity_types),relationshipTypes:Z(s.relationship_types)});var s,l;throw new r("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:a,data:n.data})}export{de as executeApplyEdits,pe as executeQuery,ue as executeQueryStreaming,ce as executeSearch,ye as executeSearchStreaming,ge as fetchKnowledgeGraph,he as refreshDataModel};
