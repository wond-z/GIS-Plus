/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import e from"../../core/Collection.js";import s from"../../core/Error.js";import r from"../../core/Evented.js";import{HandleOwnerMixin as o}from"../../core/HandleOwner.js";import{L as i}from"../../chunks/Logger.js";import{i as l}from"../../chunks/maybe.js";import{when as a}from"../../core/reactiveUtils.js";import{property as n}from"../../core/accessorSupport/decorators/property.js";import"../../core/lang.js";import"../../chunks/ensureType.js";import{subclass as p}from"../../core/accessorSupport/decorators/subclass.js";import c from"../../geometry/Point.js";import{g as m,a as h}from"../../chunks/utils10.js";import{trace as u}from"../../rest/networks/trace.js";import d from"../../rest/networks/support/TraceLocation.js";import g from"../../rest/networks/support/TraceParameters.js";import{cut as y,planarLength as j}from"../../geometry/geometryEngine.js";import f from"../../geometry/Polyline.js";import{project as b,load as w}from"../../geometry/projection.js";import k from"../../Graphic.js";import"../../chunks/ArrayPool.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../core/promiseUtils.js";import"../../chunks/object.js";import"../../config.js";import"../../chunks/string.js";import"../../chunks/shared.js";import"../../chunks/tracking.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/SimpleObservable.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/get.js";import"../../chunks/metadata.js";import"../../chunks/watch.js";import"../../chunks/WatchUpdatingTracking.js";import"../../core/accessorSupport/decorators/cast.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../geometry/Geometry.js";import"../../core/JSONSupport.js";import"../../geometry/SpatialReference.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/Ellipsoid.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/featureQueryAll.js";import"../../rest/support/Query.js";import"../../geometry.js";import"../../geometry/Extent.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../chunks/typeUtils.js";import"../../chunks/jsonMap.js";import"../../geometry/support/jsonUtils.js";import"../../TimeExtent.js";import"../../chunks/timeUtils.js";import"../../chunks/enumeration.js";import"../../chunks/DataLayerSource.js";import"../../layers/support/Field.js";import"../../chunks/domains.js";import"../../layers/support/CodedValueDomain.js";import"../../layers/support/Domain.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"../../chunks/fieldType.js";import"../../chunks/FullTextSearch.js";import"../../core/Clonable.js";import"../../rest/support/StatisticDefinition.js";import"../../portal/PortalItem.js";import"../../chunks/assets.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../portal/Portal.js";import"../../chunks/locale.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../portal/PortalGroup.js";import"../../portal/PortalItemResource.js";import"../../portal/PortalRating.js";import"../../rest/support/FeatureSet.js";import"../../PopupTemplate.js";import"../../layers/support/fieldUtils.js";import"../../chunks/arcadeOnDemand.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../popup/support/FieldInfoFormat.js";import"../../chunks/date.js";import"../../chunks/number.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/RelationshipContent.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/content/TextContent.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../core/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../symbols.js";import"../../symbols/CIMSymbol.js";import"../../symbols/Symbol.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../chunks/mathUtils.js";import"../../chunks/vec3.js";import"../../chunks/common.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils2.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol.js";import"../../symbols/SimpleLineSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/lineMarkers.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils3.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/aaBoundingBox.js";import"../../chunks/aaBoundingRect.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../chunks/persistableUrlUtils.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../chunks/Thumbnail.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/SimpleFillSymbol.js";import"../../symbols/SimpleMarkerSymbol.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../chunks/utils4.js";import"../../rest/networks/support/TraceResult.js";import"../../rest/networks/support/AggregatedGeometry.js";import"../../rest/networks/support/FunctionResult.js";import"../../rest/networks/support/NetworkElement.js";import"../../networks/support/TraceConfiguration.js";import"../../chunks/typeUtils2.js";import"../../chunks/geometryEngineBase.js";import"../../chunks/hydrated.js";import"../../chunks/unitUtils.js";import"../../chunks/projectionEllipsoid.js";import"../../chunks/mat4.js";import"../../chunks/pe.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../chunks/zscale.js";class _{getPercentageAlong(t,e,s){let r=t;const o=this._createPolyline(t.paths,s.wkid);if("point"===e.type){const t=e.x-50,i=e.x+50,l=[[t,e.y-50],[i,e.y+50]];r=this._createPolyline(l,e.spatialReference.wkid),r=b(r,s);const a=y(o,r);if(a.length>0){const t=j(o,"feet");let e;return e=a[0].paths[0][0][0]===o.paths[0][0][0]?j(a[0],"feet"):j(a[1],"feet"),[e/t]}return[.5]}r=b(e,s);const i=y(o,r);if(i.length>0){const t=j(o,"feet");return[j(i[0],"feet")/t]}return[.5]}async projectGeometry(t,e){return await w(),b(t,e)}_createPolyline(t,e){return new f({hasZ:!1,hasM:!0,paths:t,spatialReference:{wkid:e}})}}const S=[227,27,21,.6],I=[21,244,21,.6],v=[{color:[255,0,0,.6],haloOpacity:.9,fillOpacity:.2,hex:"#ff0000"},{color:[255,0,255,.6],haloOpacity:.9,fillOpacity:.2,hex:"#ff00ff"},{color:[217,188,255,.6],haloOpacity:.9,fillOpacity:.2,hex:"#D9BCFF"},{color:[0,255,0,.6],haloOpacity:.9,fillOpacity:.2,hex:"#00ff00"},{color:[255,255,0,.6],haloOpacity:.9,fillOpacity:.2,hex:"#ffff00"},{color:[0,0,255,.6],haloOpacity:.9,fillOpacity:.2,hex:"#0000ff"}];class T{constructor(){this._geometryHandler=new _}getFlagGraphic(t,e,s,r){const o="starting-point"===e?I:S;return"polygon"===t.type&&(t=t.centroid),r?this.makeGraphic(t,o,s.attributes,null,r):this.makeGraphic(t,o,s.attributes)}getHighlightColor(t){return v[t]}makeGraphic(t,e,s,r,o){let i,l=t;switch(t.type){case"multipoint":i={type:"simple-marker",color:e,size:12,outline:{color:e,width:0}},r&&(l=t);break;case"point":i=o||{type:"simple-marker",color:e,size:12,outline:{color:e,width:0}},r&&(l=t);break;case"polyline":i={type:"simple-line",color:e,width:12},r&&(l=t);break;case"polygon":i={type:"simple-fill",color:e,outline:{color:e,width:12}},r&&(l=t)}return new k({geometry:l,symbol:i,attributes:s||null})}}let F=class extends(o(r.EventedAccessor)){constructor(t){super(t),this._activeProgress=!1,this._clickHandler=null,this._flags=[],this._geometryHandler=null,this._graphicHandler=null,this._highlightHandler=[],this._traces=[],this._traceResults=[],this._unObject=null,this._watchHandler=null,this.defaultGraphicColor={color:[255,255,0,.6],haloOpacity:.9,fillOpacity:.2,hex:"#FFFF00"},this.flags=[],this.gdbVersion="sde.DEFAULT",this.selectedTraces=[],this.selectOnComplete=!0,this.showGraphicsOnComplete=!0,this.showSelectionAttributes=!0}initialize(){this._geometryHandler=new _,this._graphicHandler=new T}destroy(){this.view=null}get state(){return this.view?.ready?"ready":"loading"}get view(){return this._get("view")}set view(t){t&&"2d"!==t.type&&i.getLogger(this.declaredClass).error(new s("view:invalid-view","SceneView is not supported",{view:t})),this._set("view",t)}addFlagByHit(t,e){return new Promise(((s,r)=>{this.view.popup.autoOpenEnabled=!1,this._clickHandler&&this._clickHandler.remove(),this.emit("add-flag",{type:t}),this._clickHandler=this.view.on("click",(o=>{this.queryFlagByHitTest(o,t,e).then((r=>{this.view.popup.autoOpenEnabled=!0,this._clickHandler.remove(),this.emit("add-flag-complete",{type:t,symbol:e}),s(r)})).catch((s=>{this.view.popup.autoOpenEnabled=!0,this._clickHandler.remove(),this.emit("add-flag-error",{type:t,symbol:e}),r(s)}))}))}))}async addFlagsOnLoad(){return new Promise((t=>{const e=[];this._watchHandler=a((()=>!this.view.updating),(async()=>{if(this._flags.length>0)t(e);else{const s=this.flags.map((async t=>{if(t.mapPoint){const s=new c({x:t.mapPoint.x,y:t.mapPoint.y,spatialReference:t.mapPoint.spatialReference.wkid}),r={screenPoint:this.view.toScreen(s),mapPoint:s};await this.queryFlagByHitTest(r,t.type)||("barrier"===t.type?e.push("barrier"):e.push("starting-point"))}}));await Promise.all(s),t(e)}}),{initial:!0})}))}async addResultGraphicToView(t,e){for(const s in t.results.aggregatedGeometry)if("line,multipoint,polygon".includes(s)&&null!==t.results.aggregatedGeometry[s]){t.results.aggregatedGeometry[s].spatialReference=this._unObject.spatialReference,t.graphicEnabled=!0;const r=await this._geometryHandler.projectGeometry(t.results.aggregatedGeometry[s],this.view.spatialReference),o={globalid:t.trace.globalId};if(null!==r){const t=this._graphicHandler.makeGraphic(r,e.color,o,this.view.spatialReference);this.view.graphics.add(t)}}}addTerminal(t,e){const s=[...this._flags];s.forEach((s=>{s.globalId===e.globalId&&(e.selectedTerminals.includes(parseInt(t,10))||s.selectedTerminals.push(parseInt(t,10)))})),this._flags=s}async callTrace(){const t=this._traces.filter((t=>t.selected));return t.length>0&&(this._traceResults.length>0&&this._traceResults.forEach((t=>{this.removeResultGraphicFromView(t)})),this._traceResults=[],this.removeSelection(),await Promise.all(t.map((async(t,e)=>{const s=t,r=new g({gdbVersion:this.gdbVersion,moment:null,traceType:s.traceType,traceLocations:this._flags,namedTraceConfigurationGlobalId:s.globalId,traceConfiguration:null,outSpatialReference:null,resultTypes:null});await this.executeTrace(s,this._unObject.networkServiceUrl,r).then((t=>{if(t.hasOwnProperty("results")){const s={...t};if(null!==s.results){const t=[...s.results.elements];s.results.elements.length=0;const r=new Map;for(const e of t)r.has(e.globalId)||(r.set(e.globalId,!0),s.results.elements.push(e));const o=[...this._traceResults];o.splice(e,0,s),this._traceResults=o,null!==s.results&&(this.selectOnComplete&&this.mergeSelection(!0,s.trace),this.showGraphicsOnComplete&&this.addResultGraphicToView(s,s.graphicColor))}else{const s=[...this._traceResults];s.splice(e,0,t),this._traceResults=s}this._activeProgress=!1}else{this._activeProgress=!1;const s=[...this._traceResults];s.splice(e,0,t),this._traceResults=s}})).catch((t=>{throw this._activeProgress=!1,t}))}))),!0)}changeResultGraphicColor(t,e){const s=[...this._traceResults];s.length>0&&s.forEach((s=>{s.trace.globalId===e.trace.globalId&&(s.graphicColor=t,s.graphicEnabled=!0)})),this._traceResults=s,this.removeResultGraphicFromView(e),this.addResultGraphicToView(e,t)}changeFlagSymbol(t,e){this._flags.length>0&&this._flags.forEach((s=>{s.type===t&&e&&(s.mapGraphic.symbol=e)}))}checkCanTrace(){const t={status:!0,issues:[]};let e=!1;const s=this._flags.some((t=>"starting-point"===t.type)),r=this._flags.filter((t=>null!==t.allTerminals));r.length>0&&(e=r.some((t=>t.selectedTerminals.length<=0)));let o=[];return s?(o=this._traces.filter((t=>t.selected)),o.length<=0?(t.status=!1,t.issues=["noTrace"],e&&(t.status=!1,t.issues=["noTrace","noTerminalSelected"])):e&&(t.status=!1,t.issues=["noTerminalSelected"])):(o=this._traces.filter((t=>!0===t.selected)),o.length>0?(t.status=!1,t.issues=["noStart"],e&&(t.status=!1,t.issues=["noStart","noTerminalSelected"])):(t.status=!1,t.issues=["noStart","noTrace"],e&&(t.status=!1,t.issues=["noStart","noTrace","noTerminalSelected"]))),t}checkSelectionExist(){let t=!1;return this._highlightHandler.some((e=>{e&&(t=!0)})),t}clearResult(t){let e=this._traceResults;if(e.length>0){const s=e.filter((e=>e.trace.globalId===t.globalId));s.length>0&&this.removeResultGraphicFromView(s[0]),e=e.filter((e=>e.trace.globalId!==t.globalId))}this._traceResults=e,0===e.length?(this.removeSelection(),this.emit("clear-selection",{resultSet:[]})):this.mergeSelection(!1,t)}executeTrace(t,e,s){const r=this._processFlags(s.traceLocations);return s.traceLocations=r,u(e,s).then((e=>({trace:t,results:e,selectionEnabled:!1,graphicEnabled:!1,graphicColor:this.defaultGraphicColor,status:"success"}))).catch((e=>({trace:t,results:null,selectionEnabled:!1,graphicEnabled:!1,graphicColor:this.defaultGraphicColor,status:e.message})))}getValidSources(){let t=[];const e=this._unObject.dataElement.domainNetworks;for(const s of e)t=t.concat(s.junctionSources),t=t.concat(s.edgeSources);return t}async loadUtilityNetwork(){await this.view.when();const t=this.view.map;if(t.utilityNetworks?.length){const e=t.utilityNetworks.getItemAt(0);await e.load(),this._unObject=e;try{await t.loadAll(),this._populateOutfields()}catch(t){this._populateOutfields()}return e}return null}manageFilterBarrier(t,e){const s=[...this._flags];s.forEach((s=>{s.globalId===e.globalId&&"barrier"===e.type&&s.id===e.id&&(s.isFilterBarrier=t)})),this._flags=s}mergeSelection(t,e){let s=[];const r=[...this._traceResults],o=e.globalId;r.forEach((e=>{o===e.trace.globalId&&(e.selectionEnabled=t),e.selectionEnabled&&null!==e.results.elements&&(s=s.concat(e.results.elements))})),this.selectResults([...new Set(s)])}async queryFeaturesById(t){const s=m(this._unObject,t),r=this._getUniqueMapLayerViews(this.view),o={layerUrl:s[0].layerUrl,objectIds:s[0].objectIds,outFields:["*"]},i=r.filter((t=>t.layer?.parsedUrl?.path===s[0].layerUrl));if(i.length>0){const t=(await Promise.all(i.map((async t=>{const s=new e,r=t.layer;s.add(r);const i={layers:s,layerInfos:[o],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return(await h(i))[0]})))).filter((t=>t.featureSet.features.length>0));return t.length>0?t:null}return null}queryFlagByHitTest(t,e,s){return this._lookupFlagByHit(t).then((t=>{if(t.length>0){const r=[...this._flags],o=s;return t.forEach((t=>{const s=t.graphic,i=s.attributes.hasOwnProperty("GLOBALID")?s.attributes.GLOBALID:s.attributes.globalid;if(r.filter((t=>t.globalId===i)).length<=0){const t=this._graphicHandler.getFlagGraphic(s.mapPoint,e,s,o);this.view.graphics.add(t),r.push({...s,type:e,globalId:s.attributes.globalid?s.attributes.globalid:s.attributes.GLOBALID,details:s,mapGraphic:t,id:r.length+1})}else if(null!==s.percentAlong){const t=this._graphicHandler.getFlagGraphic(s.mapPoint,e,s,o);this.view.graphics.add(t),r.push({...s,type:e,globalId:s.attributes.globalid?s.attributes.globalid:s.attributes.GLOBALID,details:s,mapGraphic:t,id:r.length+1})}})),this._flags=r,!0}return!1}))}removeResultGraphicFromView(t){const e=this.view.graphics;t.graphicEnabled=!1,e.filter((e=>e.attributes[e.attributes.hasOwnProperty("GLOBALID")?"GLOBALID":"globalid"]===t.trace.globalId)).forEach((t=>{this.view.graphics.remove(t)}))}removeFlag(t){const e=this._flags.filter((e=>{if(e.id!==t.id)return e}));this._removeGraphic(t),this._flags=e}removeSelection(){this._highlightHandler.forEach((t=>{t&&t.remove()})),this._highlightHandler=[]}removeTerminal(t,e){const s=[...this._flags];s.forEach((s=>{if(s.globalId===e.globalId&&e.selectedTerminals.includes(parseInt(t,10))){const r=e.selectedTerminals.indexOf(parseInt(t,10));s.selectedTerminals.splice(r,1)}})),this._flags=s}removeFlagsOnLoadWatcher(){this._watchHandler&&null!==this._watchHandler&&this._watchHandler.remove()}reset(){this._flags=[],this._traceResults=[];const t=[...this._traces];t.forEach((t=>{t.selected=!1})),this._traces=t,this.view&&(this.view.graphics.removeAll(),this.removeSelection(),this.emit("clear-selection",{resultSet:[]}))}selectFeaturesById(t){const e=m(this._unObject,t);this._getUniqueMapLayerViews(this.view).forEach((t=>{t.layer?.parsedUrl?.path===e[0].layerUrl&&this._highlightHandler.push(t.highlight(e[0].objectIds))}))}selectResults(t){if(t.length>0){this.removeSelection();const e=this._groupResultsByNetworkSource(t),s=[];for(const t in e)this.selectFeaturesById(e[t]),s.push(this.queryFeaturesById(e[t]));Promise.all(s).then((t=>{this.emit("select-features",{resultSet:t})}))}else this.removeSelection(),this.emit("clear-selection",{resultSet:[]})}selectTraces(t,e){const s=[...this._traces];s.forEach((s=>{e===s.globalId&&(s.selected=t)})),this._traces=s}selectTracesOnLoad(){this._unObject.hasOwnProperty("sharedNamedTraceConfigurations")&&(this._traces=[...this._unObject.sharedNamedTraceConfigurations],this._traces.forEach((t=>{t.selected=!1,this.selectedTraces.includes(t.globalId)&&(t.selected=!0)})))}zoomToAsset(t){this.view.goTo(t).catch((t=>{console.error(t)}))}_getUniqueMapLayerViews(t){const e=[];return t.layerViews.filter((t=>"feature"===t.layer.type||"group"===t.layer.type)).forEach((t=>{"group"===t.type?t.layerViews.forEach((t=>{e.push(t)})):e.some((e=>e.layer.layerId===t.layer.layerId))||e.push(t)})),e}_processFlags(t){const e=[];return t.forEach((t=>{if(null!==t.selectedTerminals&&t.selectedTerminals.length>0)t.selectedTerminals.forEach((s=>{const r=new d({globalId:t.globalId,percentAlong:t.percentAlong,terminalId:s,type:t.type,isFilterBarrier:t.isFilterBarrier});e.push(r)}));else{const s=new d({globalId:t.globalId,percentAlong:t.percentAlong,terminalId:null,type:t.type,isFilterBarrier:t.isFilterBarrier});e.push(s)}})),e}_getDisplayField(t){const e=t.layer;let s=e.displayField,r="";for(const o in t.attributes){const i=o.toLowerCase();if(i===s.toLowerCase())if(r=t.attributes[o],"assetgroup"===i||"assettype"===i){let o=t.attributes[e.typeIdField.toUpperCase()];o||(o=t.attributes[e.typeIdField.toLowerCase()]),s=e.typeIdField,r=this._checkSubtype(e,o)}else r=this._checkDomain(e.fields,o,r)}return{field:s,value:r}}_checkSubtype(t,e){let s=e;if(null!==t.types&&t.types.length>0){const r=t.types.filter((t=>t.id===e));r.length>0&&(s=r[0].name)}return s}_checkDomain(t,e,s){let r=s;const o=t.filter((t=>t.name.toLowerCase()===e.toLowerCase()));if(o.length>0&&null!==o[0].domain){const t=o[0].domain.codedValues.filter((t=>t.code===s));t.length>0&&(r=t[0].name)}return r}_groupBy(t,e){return t.reduce(((t,s)=>((t[s[e]]=t[s[e]]||[]).push(s),t)),{})}_groupResultsByNetworkSource(t){if(t.length>0){if(t[0].hasOwnProperty("results")){const e=t[0].results.elements;return this._groupBy(e,"networkSourceId")}return this._groupBy(t,"networkSourceId")}if(t.hasOwnProperty("results")){const e=t.results.elements;return this._groupBy(e,"networkSourceId")}return[]}_lookupFlagByHit(t){return this.view.hitTest(t.screenPoint).then((e=>{const s=[];if(e.results.length>0){const r=e.results.find((t=>null!==t.layer));if(r.graphic&&l(r.graphic.geometry))if("polyline"===r.graphic.geometry.type){const e=this._geometryHandler.getPercentageAlong(r.graphic.geometry,t.mapPoint,r.graphic.geometry.spatialReference),o=this._getDisplayField(r.graphic);r.graphic.terminalId=null,r.graphic.isFilterBarrier=!1,r.graphic.allTerminals=null,r.graphic.selectedTerminals=null,r.graphic.percentAlong=e,r.graphic.displayValue=o,r.graphic.mapPoint=r.mapPoint,s.push(r)}else if(("point"===r.graphic.geometry.type||"polygon"===r.graphic.geometry.type)&&null!==this._unObject){const t=this._unObject.getTerminalConfiguration(r.graphic),e=this._getDisplayField(r.graphic);r.graphic.terminalId=t?t.terminals[0].id?t.terminals[0].id:null:1,r.graphic.isFilterBarrier=!1,r.graphic.allTerminals=t||null,r.graphic.selectedTerminals=[t?t.terminals[0].id?t.terminals[0].id:null:1],r.graphic.percentAlong=null,r.graphic.displayValue=e,r.graphic.mapPoint=r.mapPoint,s.push(r)}}return s}))}async _populateOutfields(){const t=this.view.map,e=this.getValidSources();t.layers.forEach((t=>{"group"===t.type?t.layers.forEach((t=>{e.some((e=>e.layerId===t.layerId))&&t.fields.some((t=>"assetgroup"===t.name.toLowerCase()))&&(t.outFields=["assetgroup","assettype","globalid","objectid"])})):e.some((e=>e.layerId===t.layerId))&&t.fields.some((t=>"assetgroup"===t.name.toLowerCase()))&&(t.outFields=["assetgroup","assettype","globalid","objectid"])}))}_removeGraphic(t){this.view.graphics.remove(t.mapGraphic)}};t([n()],F.prototype,"_activeProgress",void 0),t([n()],F.prototype,"_flags",void 0),t([n()],F.prototype,"_traces",void 0),t([n()],F.prototype,"_traceResults",void 0),t([n()],F.prototype,"defaultGraphicColor",void 0),t([n()],F.prototype,"flags",void 0),t([n()],F.prototype,"gdbVersion",void 0),t([n()],F.prototype,"selectedTraces",void 0),t([n()],F.prototype,"selectOnComplete",void 0),t([n()],F.prototype,"showGraphicsOnComplete",void 0),t([n()],F.prototype,"showSelectionAttributes",void 0),t([n({readOnly:!0})],F.prototype,"state",null),t([n({value:null})],F.prototype,"view",null),F=t([p("esri.widgets.UtilityNetworkTrace.UtilityNetworkTraceViewModel")],F);const O=F;export{T as G,v as H,O as default};
