/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import{substitute as t}from"../intl.js";import{HandleOwnerMixin as s}from"../core/HandleOwner.js";import{L as r}from"../chunks/Logger.js";import{i}from"../chunks/maybe.js";import{watch as o,on as n,when as a,initial as l}from"../core/reactiveUtils.js";import{property as p}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import{cast as m}from"../core/accessorSupport/decorators/cast.js";import{subclass as c}from"../core/accessorSupport/decorators/subclass.js";import{getDisplayFieldName as d}from"../layers/support/fieldUtils.js";import u from"./Attachments.js";import h from"./FeatureForm.js";import j,{I as g}from"./FeatureTemplates.js";import{S as k}from"../chunks/Spinner.js";import y from"./Widget.js";import f,{w}from"./Editor/EditorViewModel.js";import{H as v,i as b}from"../chunks/Heading.js";import _ from"./support/SnappingControls.js";import{a as C}from"../chunks/accessibleHandler.js";import{m as F}from"../chunks/messageBundle.js";import{v as M}from"../chunks/vmEvent.js";import{t as S}from"../chunks/jsxFactory.js";import"../chunks/widgetUtils.js";import"../chunks/number.js";import"../chunks/jsonMap.js";import"../chunks/object.js";import"../chunks/locale.js";import"../chunks/string.js";import"../chunks/messages.js";import"../core/Error.js";import"../config.js";import"../core/promiseUtils.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../chunks/assets.js";import"../core/Accessor.js";import"../core/Handles.js";import"../chunks/get.js";import"../chunks/utils.js";import"../chunks/handleUtils.js";import"../chunks/metadata.js";import"../chunks/ArrayPool.js";import"../chunks/tracking.js";import"../chunks/watch.js";import"../core/scheduling.js";import"../chunks/nextTick.js";import"../chunks/ensureType.js";import"../chunks/WatchUpdatingTracking.js";import"../chunks/arcadeOnDemand.js";import"../geometry.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"../chunks/reader.js";import"../geometry/SpatialReference.js";import"../chunks/writer.js";import"../geometry/Point.js";import"../geometry/support/webMercatorUtils.js";import"../chunks/Ellipsoid.js";import"../geometry/Multipoint.js";import"../chunks/zmUtils.js";import"../geometry/Polygon.js";import"../chunks/extentUtils.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"../chunks/unitFormatUtils.js";import"../chunks/byteSizeEstimations.js";import"../chunks/Cyclical.js";import"../chunks/mathUtils.js";import"../chunks/vec3.js";import"../chunks/common.js";import"../chunks/unitUtils.js";import"../chunks/projectionEllipsoid.js";import"./Attachments/AttachmentsViewModel.js";import"../Graphic.js";import"../PopupTemplate.js";import"../core/Clonable.js";import"../core/Collection.js";import"../core/Evented.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../chunks/enumeration.js";import"../popup/support/FieldInfoFormat.js";import"../chunks/date.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../chunks/chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../Color.js";import"../chunks/colorUtils.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"../chunks/utils2.js";import"../symbols/edges/Edges3D.js";import"../chunks/screenUtils.js";import"../chunks/materialUtils.js";import"../chunks/opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../chunks/lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"../chunks/utils3.js";import"../chunks/colors.js";import"../chunks/symbolLayerUtils3D.js";import"../chunks/aaBoundingBox.js";import"../chunks/aaBoundingRect.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../chunks/persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"../chunks/collectionUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"../chunks/Thumbnail.js";import"../chunks/calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../chunks/urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../rest/query/support/AttachmentInfo.js";import"../rest/support/AttachmentQuery.js";import"../chunks/domUtils.js";import"../chunks/uuid.js";import"../chunks/projector.js";import"../chunks/jsxWidgetSupport.js";import"../chunks/compilerUtils.js";import"./FeatureForm/FeatureFormViewModel.js";import"../form/FormTemplate.js";import"../form/ExpressionInfo.js";import"../form/elements/GroupElement.js";import"../form/elements/Element.js";import"../form/support/elements.js";import"../form/elements/FieldElement.js";import"../form/elements/support/inputs.js";import"../form/elements/inputs/BarcodeScannerInput.js";import"../form/elements/inputs/TextInput.js";import"../form/elements/inputs/Input.js";import"../form/elements/inputs/ComboBoxInput.js";import"../form/elements/inputs/DateTimePickerInput.js";import"../form/elements/inputs/RadioButtonsInput.js";import"../form/elements/inputs/SwitchInput.js";import"../form/elements/inputs/TextAreaInput.js";import"../form/elements/inputs/TextBoxInput.js";import"../chunks/domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"../chunks/editableLayers.js";import"../chunks/arcgisLayerUrl.js";import"../chunks/Subtype.js";import"../arcade.js";import"../chunks/ImmutableArray.js";import"../layers/FeatureLayer.js";import"../renderers/ClassBreaksRenderer.js";import"../renderers/Renderer.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"../chunks/colorRamps.js";import"../rest/support/AlgorithmicColorRamp.js";import"../rest/support/ColorRamp.js";import"../rest/support/MultipartColorRamp.js";import"../renderers/mixins/VisualVariablesMixin.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/VisualVariable.js";import"../chunks/LegendOptions.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/visualVariables/SizeVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"../chunks/sizeVariableUtils.js";import"../chunks/visualVariableUtils.js";import"../chunks/lengthUtils.js";import"../renderers/support/ClassBreakInfo.js";import"../chunks/commonProperties2.js";import"../symbols/support/jsonUtils.js";import"../chunks/symbolConversion.js";import"../renderers/DictionaryRenderer.js";import"../chunks/DictionaryLoader.js";import"../chunks/LRUCache.js";import"../chunks/MemCache.js";import"../renderers/DotDensityRenderer.js";import"../renderers/support/AttributeColorInfo.js";import"../renderers/HeatmapRenderer.js";import"../renderers/support/HeatmapColorStop.js";import"../chunks/heatmapUtils.js";import"../chunks/vec4f64.js";import"../renderers/PieChartRenderer.js";import"../renderers/SimpleRenderer.js";import"../renderers/UniqueValueRenderer.js";import"../chunks/diffUtils.js";import"../renderers/support/UniqueValue.js";import"../renderers/support/UniqueValueClass.js";import"../renderers/support/UniqueValueGroup.js";import"../renderers/support/UniqueValueInfo.js";import"../chunks/styleUtils2.js";import"../renderers/support/jsonUtils.js";import"../chunks/MultiOriginJSONSupport.js";import"../core/sql.js";import"../layers/Layer.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"../chunks/Queue.js";import"../core/workers/RemoteClient.js";import"../chunks/editsZScale.js";import"../chunks/queryZScale.js";import"../chunks/zscale.js";import"../rest/support/FeatureSet.js";import"../layers/support/Field.js";import"../chunks/fieldType.js";import"../layers/mixins/APIKeyMixin.js";import"../chunks/ArcGISService.js";import"../layers/mixins/BlendLayer.js";import"../chunks/jsonUtils.js";import"../chunks/parser.js";import"../chunks/mat4f32.js";import"../chunks/mat4.js";import"../chunks/_commonjsHelpers.js";import"../layers/mixins/CustomParametersMixin.js";import"../chunks/EditBusLayer.js";import"../layers/mixins/FeatureEffectLayer.js";import"../layers/support/FeatureEffect.js";import"../layers/support/FeatureFilter.js";import"../TimeExtent.js";import"../chunks/timeUtils.js";import"../rest/support/Query.js";import"../chunks/DataLayerSource.js";import"../chunks/FullTextSearch.js";import"../rest/support/StatisticDefinition.js";import"../layers/mixins/FeatureLayerBase.js";import"../geometry/HeightModelInfo.js";import"../chunks/commonProperties.js";import"../support/timeUtils.js";import"../chunks/ElevationInfo.js";import"../chunks/unitConversionUtils.js";import"../rest/support/RelationshipQuery.js";import"../layers/support/GeometryFieldsInfo.js";import"../layers/support/LayerFloorInfo.js";import"../layers/support/Relationship.js";import"../layers/mixins/FeatureReductionLayer.js";import"../layers/support/AggregateField.js";import"../layers/support/ExpressionInfo.js";import"../chunks/FeatureReduction.js";import"../layers/support/FeatureReductionBinning.js";import"../layers/support/LabelClass.js";import"../chunks/labelUtils.js";import"../chunks/defaults.js";import"../chunks/defaultsJSON.js";import"../layers/support/FeatureReductionCluster.js";import"../layers/support/FeatureReductionSelection.js";import"../chunks/clusterUtils.js";import"../chunks/OperationalLayer.js";import"../layers/mixins/OrderedLayer.js";import"../layers/mixins/PortalLayer.js";import"../chunks/asyncUtils.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../layers/mixins/PublishableLayer.js";import"../layers/support/PublishingInfo.js";import"../layers/mixins/RefreshableLayer.js";import"../layers/mixins/ScaleRangeLayer.js";import"../layers/mixins/TemporalLayer.js";import"../TimeInterval.js";import"../layers/support/TimeInfo.js";import"../layers/support/TimeReference.js";import"../layers/support/FeatureTemplate.js";import"../layers/support/FeatureType.js";import"../chunks/fieldProperties.js";import"../layers/support/FieldsIndex.js";import"../chunks/labelingInfo.js";import"../chunks/versionUtils.js";import"../chunks/styleUtils.js";import"../rest/support/TopFeaturesQuery.js";import"../rest/support/TopFilter.js";import"../support/popupUtils.js";import"./FeatureForm/InputField.js";import"./FeatureForm/InputFieldGroup.js";import"../chunks/datetime.js";import"./FeatureTemplates/FeatureTemplatesViewModel.js";import"./FeatureTemplates/TemplateItem.js";import"../symbols/support/symbolUtils.js";import"../chunks/utils6.js";import"../chunks/ItemCache.js";import"../symbols/support/cimSymbolUtils.js";import"../chunks/utils7.js";import"../chunks/colorUtils2.js";import"../chunks/mat2df32.js";import"../chunks/mat2d.js";import"./FeatureTemplates/TemplateItemGroup.js";import"./Spinner/SpinnerViewModel.js";import"../chunks/AnchorElementViewModel.js";import"../layers/GraphicsLayer.js";import"../chunks/GraphicsCollection.js";import"./Editor/CreateFeaturesWorkflow.js";import"../views/interactive/snapping/FeatureSnappingLayerSource.js";import"./Editor/CreateFeaturesWorkflowData.js";import"./Editor/Workflow.js";import"../chunks/workflowUtils.js";import"../chunks/drapedUtils.js";import"../chunks/GraphicState.js";import"../chunks/hitTestSelectUtils.js";import"./Editor/CreateWorkflow.js";import"./Editor/CreateWorkflowData.js";import"./Editor/Edits.js";import"./Editor/UpdateWorkflow.js";import"../chunks/layerViewUtils.js";import"./Editor/UpdateWorkflowData.js";import"./Sketch/SketchViewModel.js";import"../geometry/projection.js";import"../chunks/pe.js";import"../chunks/geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"../chunks/elevationInfoUtils.js";import"../geometry/Circle.js";import"../geometry/support/geodesicUtils.js";import"../chunks/InputManager.js";import"../chunks/ObservableValue.js";import"../chunks/keybindings.js";import"../views/interactive/sketch/SketchLabelOptions.js";import"../views/interactive/sketch/SketchTooltipOptions.js";import"../chunks/SnappingManager.js";import"../chunks/RightAngleSnappingHint.js";import"../chunks/vec2.js";import"../chunks/QueryEngineResult.js";import"../chunks/quantizationUtils.js";import"../core/sql/WhereClause.js";import"../chunks/utils13.js";import"../chunks/generateRendererUtils.js";import"../chunks/projectionSupport.js";import"../chunks/json.js";import"../chunks/SnappingCandidate.js";import"../chunks/utils21.js";import"../geometry/support/normalizeUtils.js";import"../chunks/normalizeUtilsCommon.js";import"../chunks/simplify.js";import"../chunks/utils4.js";import"../chunks/utils5.js";import"../chunks/featureConversionUtils.js";import"../chunks/OptimizedFeature.js";import"../chunks/OptimizedFeatureSet.js";import"../chunks/vec2f64.js";import"../chunks/Settings2.js";import"../chunks/geometry2dUtils.js";import"../chunks/viewUtils.js";import"../views/interactive/snapping/SnappingOptions.js";import"../chunks/screenUtils2.js";import"./support/SnappingControls/SnappingControlsViewModel.js";import"../chunks/layerListUtils.js";import"./LayerList/LayerListViewModel.js";import"./LayerList/ListItem.js";import"../chunks/ActionSlider.js";import"./LayerList/ListItemPanel.js";import"./support/widget.js";import"../chunks/themeUtils.js";const A="esri-editor esri-widget esri-widget--panel",E="esri-editor__panel-content",L="esri-editor__panel-content__section",U={undoRedoButtons:!1,snappingControls:!0,snappingControlsElements:{header:!1,enabledToggle:!0,selfEnabledToggle:!0,featureEnabledToggle:!0,layerList:!0}};function T(e){e.focus()}const W=r.getLogger("esri.widgets.Editor");let I=class extends(s(y)){constructor(e,t){super(e,t),this._candidateCommitted=!1,this._featureForm=new h,this._stateStack=[],this._attachments=new u({visibleElements:{addSubmitButton:!1,cancelAddButton:!1,cancelUpdateButton:!1,deleteButton:!1,errorMessage:!1,progressBar:!1,updateButton:!1}}),this._featureTemplates=new j({enableListScroll:!1}),this._filterText="",this._prompt=null,this._spinner=new k,this._snappingButton=null,this._snappingPopover=null,this.useDeprecatedCreateWorkflow=!1,this.headingLevel=4,this.iconClass="esri-icon-edit",this.messages=null,this.messagesCommon=null,this.messagesTemplates=null,this.supportingWidgetDefaults=null,this.viewModel=new f,this.visibleElements={...U},this._setCandidateFeature=(e,t=!1)=>{if(this._candidateCommitted)return;const s=this._assertActiveUpdateWorkflow();s.data.edits.feature=e,t&&(s.next(),this._candidateCommitted=!0)},this._handleSave=this._handleSave.bind(this),this._handleBack=this._handleBack.bind(this),this._handleDone=this._handleDone.bind(this),this._handleDelete=this._handleDelete.bind(this),this._handleAdd=this._handleAdd.bind(this),this._handleEdit=this._handleEdit.bind(this),this._handleAttachmentAdd=this._handleAttachmentAdd.bind(this),this._handleAttachmentUpdate=this._handleAttachmentUpdate.bind(this),this._handleAttachmentDelete=this._handleAttachmentDelete.bind(this),this.EditorPanel=this.EditorPanel.bind(this)}initialize(){const{view:e,snappingOptions:s}=this;this._snappingControls=new _({snappingOptions:s,view:e,visibleElements:this.visibleElements.snappingControlsElements}),this.addHandles([o((()=>this.headingLevel),(e=>{this._featureForm.headingLevel=b(e),this._featureTemplates.headingLevel=b(e)}),l),this.viewModel.featureTemplatesViewModel.on("select",(({item:e})=>this.useDeprecatedCreateWorkflow?this.startCreateWorkflowAtFeatureCreation(e):this.startCreateFeaturesWorkflowAtFeatureCreation(e))),o((()=>this.viewModel.state),((e,t)=>{const s=this._stateStack.indexOf(e);-1===s?this._stateStack.push(t):this._stateStack.splice(s)})),o((()=>this.viewModel),(e=>{this._featureForm.viewModel=e?e.featureFormViewModel:null,this._attachments.viewModel=e?e.attachmentsViewModel:null,this._featureTemplates.viewModel=e?e.featureTemplatesViewModel:null,this._spinner.viewModel=e?e.spinnerViewModel:null}),l),o((()=>this.view),((e,t)=>{const s=`editor-${this.id}-spinner`;t&&t.ui.remove(this._spinner,s),e&&e.ui.add(this._spinner,{key:s,position:"manual"})}),l),n((()=>this.viewModel?.sketchViewModel),"create",(()=>{this.scheduleRender()})),n((()=>this.viewModel?.activeWorkflow),"cancel-request",(({controller:e})=>{const{messages:t,messagesCommon:s}=this;this._prompt={title:t.cancelRequestTitle,message:t.cancelRequestWarningMessage,context:"danger",actions:{primary:{label:s.form.yes,action:()=>{e.allow(),this._prompt=null}},secondary:{label:s.form.no,action:()=>(e.deny(),this._prompt=null)}}},this.scheduleRender()})),o((()=>this.supportingWidgetDefaults),(e=>{e&&(this._featureForm.set(e.featureForm),this._attachments.set(e.attachments),this._featureTemplates.set(e.featureTemplates),this.viewModel.sketchViewModel.set(e.sketch))}),l),o((()=>this._attachments?.error),(e=>{if(!e)return;const{messages:t,messagesCommon:s}=this;this._prompt={title:t.errorWarningTitle,message:e.message,context:"warning",actions:{primary:{label:s.form.ok,action:()=>{this._prompt=null}}}}})),o((()=>this.viewModel?.failures),(e=>{if(!e)return;const{messages:s}=this,[{error:r,retry:i,cancel:o}]=e;this._prompt={title:s.errorWarningTitle,message:t(s.errorWarningMessageTemplate,{errorMessage:r.message}),context:"warning",actions:{primary:{label:s.retry,action:()=>{i(),this._prompt=null}},secondary:{label:s.ignore,action:()=>(o(),this._prompt=null)}}}})),o((()=>this.viewModel?.state),(e=>{if("awaiting-feature-to-update"===e&&(this._filterText=""),"awaiting-update-feature-candidate"===e&&(this._candidateCommitted=!1),"editing-existing-feature"===e){const{activeWorkflow:e}=this.viewModel;this._featureForm.disabled="update"===e?.type&&!1===e?.data.editableItem.attributeUpdatesEnabled}})),o((()=>[this._attachments?.selectedFile,this._attachments?.submitting]),(()=>this.scheduleRender())),o((()=>this.viewModel?.activeWorkflow),(()=>this._featureForm.disabled=!1)),a((()=>!this.viewModel?.activeWorkflow),(()=>this._featureTemplates.filterText="")),n((()=>this.view),"key-down",(e=>{"Escape"===e.key&&this.viewModel?.activeWorkflow&&this._handleBack()}))])}destroy(){this._attachments.destroy(),this._featureForm.destroy(),this._featureTemplates.destroy(),this._snappingControls.destroy()}loadDependencies(){return Promise.all([import("../chunks/calcite-action.js"),import("../chunks/calcite-button.js"),import("../chunks/calcite-flow.js"),import("../chunks/calcite-icon.js"),import("../chunks/calcite-flow-item.js"),import("../chunks/calcite-popover.js"),import("../chunks/calcite-scrim.js")])}get activeWorkflow(){return this.viewModel.activeWorkflow}get allowedWorkflows(){return this.viewModel.allowedWorkflows}set allowedWorkflows(e){this.viewModel.allowedWorkflows=e}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get labelOptions(){return this.viewModel.labelOptions}set labelOptions(e){this.viewModel.labelOptions=e}get layerInfos(){return this.viewModel.layerInfos}set layerInfos(e){this.viewModel.layerInfos=e}get snappingOptions(){return this.viewModel.snappingOptions}set snappingOptions(e){this.viewModel.snappingOptions=e}get tooltipOptions(){return this.viewModel.tooltipOptions}set tooltipOptions(e){this.viewModel.tooltipOptions=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}castVisibleElements(e){const t={...U,...e,snappingControlsElements:{...U.snappingControlsElements,...e?.snappingControlsElements}};return i(this._snappingControls)&&(this._snappingControls.visibleElements=t.snappingControlsElements),t}startCreateWorkflowAtFeatureTypeSelection(){return w(W,"startCreateWorkflowAtFeatureTypeSelection","startCreateFeaturesWorkflowAtFeatureTypeSelection"),this.viewModel.startCreateWorkflowAtFeatureTypeSelection()}startCreateFeaturesWorkflowAtFeatureTypeSelection(){return this.viewModel.startCreateFeaturesWorkflowAtFeatureTypeSelection()}startCreateWorkflowAtFeatureCreation(e){return w(W,"startCreateWorkflowAtFeatureCreation","startCreateFeaturesWorkflowAtFeatureCreation"),this.viewModel.startCreateWorkflowAtFeatureCreation(e)}startCreateFeaturesWorkflowAtFeatureCreation(e){return this.viewModel.startCreateFeaturesWorkflowAtFeatureCreation(e)}startCreateWorkflowAtFeatureEdit(e){return w(W,"startCreateWorkflowAtFeatureEdit"),this.viewModel.startCreateWorkflowAtFeatureEdit(e)}startUpdateWorkflowAtFeatureSelection(){return this.viewModel.startUpdateWorkflowAtFeatureSelection()}startUpdateWorkflowAtMultipleFeatureSelection(e){return this.viewModel.startUpdateWorkflowAtMultipleFeatureSelection(e)}startUpdateWorkflowAtFeatureEdit(e){return this.viewModel.startUpdateWorkflowAtFeatureEdit(e)}deleteFeatureFromWorkflow(){return this.viewModel.deleteFeatureFromWorkflow()}cancelWorkflow(e){return this.viewModel.cancelWorkflow(e)}render(){const{_attachments:e,_prompt:t,viewModel:s}=this;if(!s)return S("div",{class:A});const{state:r}=s,o=i(t)?S("calcite-scrim",null,this.renderPrompt(t)):null;return S("div",{class:A},s.syncing||e.submitting?this.renderProgressBar():null,S("calcite-flow",null,this._stateStack.map((e=>this.renderState(e))),this.renderState(r)),o)}renderState(e){switch(e){case"disabled":break;case"ready":return this.renderLanding(e);case"awaiting-feature-creation-info":return this.renderTemplates(e);case"creating-features":case"editing-new-feature":case"editing-existing-feature":return this.renderAttributeEditing(e);case"awaiting-feature-to-update":return this.renderFeatureUpdating(e);case"awaiting-update-feature-candidate":return this.renderFeatureList(e);case"awaiting-feature-to-create":return this.renderFeatureCreation(e);case"adding-attachment":return this.renderAttachmentAdding(e);case"editing-attachment":return this.renderAttachmentEditing(e)}return S("div",null)}isPanelActive(e){return this.viewModel.state===e}renderTemplates(e){const{EditorPanel:t,headingLevel:s,messages:r,messagesCommon:i,_handleBack:o,_snappingControls:n,viewModel:{sketchViewModel:a}}=this;return S(t,{active:this.isPanelActive(e),key:"templates-panel",handleBack:o,heading:r.selectTemplate,headingLevel:s,messages:r,messagesCommon:i,sketchViewModel:a,snappingControls:n},S("div",{class:E},this._featureTemplates.render()))}renderAttributeEditing(e){const{activeWorkflow:s,EditorPanel:r,messages:i,messagesCommon:o,headingLevel:n,_handleBack:a,_snappingControls:l,viewModel:p}=this,{sketchViewModel:m}=p,c=p.featureFormViewModel;if("create-features"===s.type&&s.pendingFeatures.length<1)return this.renderFeatureCreation(e);const d="update"===s.type&&!s.data.edits.modified||p.syncing||c.updating,u="update"===s.type?i.editFeature:i.createFeatures,h="update"===s.type?o.update:o.create,j="create-features"===s.type&&"create-new"===s.createFeatureState,g="update"===s.type&&s.data.editableItem.supports.includes("delete"),k=this._shouldShowAttachmentsForWorkflow(s),y=[{label:"create-features"===s.type&&s.numPendingFeatures>1?t(i.createFeaturesTemplate,{numFeatures:s.numPendingFeatures}):h,type:"primary",disabled:d,clickHandler:this._handleSave,width:g?"half":"full"}];g&&y.push({label:o.delete,type:"tertiary",clickHandler:this._handleDelete,disabled:p.syncing,appearance:"outline",width:"half"});const f=c.inputFields.every((e=>!e.visible))&&!k?this.renderMessage(t(i.clickToFinishTemplate,{button:h})):S("div",{class:L},S("div",{class:"esri-editor__panel-content__section__group"},this._featureForm.render(),k?S("div",{key:"attachments"},S(v,{level:b(n)},i.attachments),this._attachments.render()):null));return S(r,{active:this.isPanelActive(e),key:"attribute-editing-panel",heading:u,headingLevel:n,handleBack:a,messages:i,messagesCommon:o,sketchViewModel:m,snappingControls:l},S("div",{class:E},f,j?S("calcite-scrim",null):null),this.renderFooterActions(y))}renderAttachmentAdding(e){const{_attachments:t,EditorPanel:s,_handleBack:r,headingLevel:i,messages:o,messagesCommon:n,_snappingControls:a,viewModel:{sketchViewModel:l}}=this,p=[{label:t.submitting?n.cancel:n.add,disabled:t.submitting||!t.selectedFile,type:"primary",clickHandler:this._handleAttachmentAdd,width:"full"}];return S(s,{active:this.isPanelActive(e),key:"attachment-adding-panel",heading:o.addAttachment,headingLevel:i,handleBack:r,messages:o,messagesCommon:n,sketchViewModel:l,snappingControls:a},S("div",{class:E},t.render()),this.renderFooterActions(p))}renderAttachmentEditing(e){const{_attachments:t,EditorPanel:s,_handleBack:r,headingLevel:i,messages:o,messagesCommon:n,_snappingControls:a,viewModel:{sketchViewModel:l}}=this,p=[{label:n.update,disabled:t.submitting||!t.selectedFile,type:"primary",clickHandler:this._handleAttachmentUpdate,width:"half"},{label:n.delete,disabled:t.submitting,type:"tertiary",clickHandler:this._handleAttachmentDelete,width:"half",appearance:"outline"}];return S(s,{active:this.isPanelActive(e),key:"attachment-editing-panel",heading:o.editAttachment,headingLevel:i,handleBack:r,messages:o,messagesCommon:n,sketchViewModel:l,snappingControls:a},S("div",{class:E},t.render()),this.renderFooterActions(p))}renderFeatureUpdating(e){const{EditorPanel:t,_handleBack:s,headingLevel:r,messages:i,messagesCommon:o,_snappingControls:n,viewModel:{sketchViewModel:a}}=this;return S(t,{active:this.isPanelActive(e),key:"feature-updating-panel",heading:i.selectFeature,headingLevel:r,handleBack:s,messages:i,messagesCommon:o,sketchViewModel:a,snappingControls:n},S("div",{class:E},this.renderMessage(i.selectFeatureToEdit)))}renderMessage(e){return S("div",{class:"esri-editor__panel-content__message"},e)}renderFeatureCreation(e){const{EditorPanel:t,_handleBack:s,headingLevel:r,messages:i,messagesCommon:o,_snappingControls:n,viewModel:a}=this,{sketchViewModel:l}=a,p=a.sketchViewModel,m=this._assertActiveCreateWorkflow().data.creationInfo.layer,c=p.canUndo()&&p.createGraphic?p.createGraphic:null,d=this._getSketchingTip(m.geometryType,c);return S(t,{active:this.isPanelActive(e),key:"feature-creation-panel",heading:i.placeFeature,headingLevel:r,handleBack:s,messages:i,messagesCommon:o,sketchViewModel:l,snappingControls:n},S("div",{class:E},this.renderMessage(d)))}renderFooterActions(e){return e.map((({type:e,disabled:t,class:s,...r},i)=>this.renderButton({class:this.classes("esri-editor__control-button","secondary"===e?"esri-button--secondary":"tertiary"===e?"esri-button--tertiary":null,t?"esri-button--disabled":null,s),disabled:t??!1,key:i,slot:"footer-actions",...r})))}renderPrompt({title:e,message:t,context:s,actions:r}){const i=!!r.secondary,o=S("calcite-button",{appearance:"solid",color:"danger"===s?"red":"blue",width:i?"half":"full",onclick:r.primary.action,key:"prompt-primary-button",afterCreate:T},r.primary.label),n=i?S("calcite-button",{appearance:"clear",color:"danger"===s?"red":"blue",width:"half",onclick:r.secondary.action,key:"prompt-secondary-button"},r.secondary.label):null;return S("div",{class:`esri-editor__prompt--${s}`},S("div",{class:"esri-editor__prompt__header"},S("calcite-icon",{icon:"exclamation-mark-triangle"}),S(v,{class:"esri-editor__prompt__header__heading",level:this.headingLevel},e)),S("div",{class:"esri-editor__prompt__message"},t),S("div",{class:"esri-editor__prompt__divider"}),S("div",{class:"esri-editor__prompt__actions"},n,o))}renderProgressBar(){return S("div",{class:this.classes("esri-editor__progress-bar"),key:"progress-bar"})}renderButton(e){const{disabled:t,class:s,key:r,clickHandler:i,label:o,...n}=e;return S("calcite-button",{class:s,disabled:t,key:r,onclick:i,type:"button",...n},o)}renderLanding(e){const{EditorPanel:t,headingLevel:s,messages:r,messagesCommon:i,_snappingControls:o,_featureTemplates:{viewModel:{numberOfFeatureTemplates:n}},viewModel:{canUpdate:a,sketchViewModel:l}}=this,p=!a&&0===n;return S(t,{active:this.isPanelActive(e),key:"landing-panel",heading:r.widgetLabel,headingLevel:s,showBackButton:!1,messages:r,messagesCommon:i,sketchViewModel:l,snappingControls:o},S("div",{class:E},a?S("div",{key:"edit-actions",class:L},this.renderUpdateActions()):void 0,n>0?S("div",{key:"create-actions",class:L},this.renderCreateActions()):void 0,p?S("div",{key:"no-content",class:L},r.noEditableLayers):void 0))}renderUpdateActions(){const{messages:e,messagesCommon:t}=this;return S("div",null,S(v,{level:b(this.headingLevel)},e.editFeatures),S("div",{class:"esri-editor__update-features-action-buttons"},S("calcite-action",{text:t.select,textEnabled:!0,icon:"cursor",alignment:"start",class:"esri-editor__update-features-action-buttons--button",onclick:this._handleEdit})))}renderCreateActions(){const{_featureTemplates:e,headingLevel:t,messages:s}=this;return S("div",null,S(v,{level:b(t)},s.createFeatures),S("div",{key:"templates",class:"esri-editor__feature-templates-container"},e.render()))}renderFeatureList(e){const{EditorPanel:s,_handleBack:r,headingLevel:i,messages:o,messagesCommon:n,messagesTemplates:a,_snappingControls:l,viewModel:{editableItems:p,sketchViewModel:m}}=this,c=this._assertActiveUpdateWorkflow().data.candidates,d=t(o.multipleFeaturesTemplate,{total:c.length}),u=new Map;let h=0;c.map((e=>({label:this._getLabel(e),id:e.attributes[e.layer.objectIdField],data:e}))).filter((e=>{const{label:t,data:s}=e,r=this._filterText.toLowerCase(),{title:i}=s.layer,o=this.viewModel.editableItems.find((e=>e.layer===s.layer));return o.supports.includes("update")&&(!r||t.toLowerCase().includes(r)||i.toLowerCase().includes(r))})).forEach((e=>{h++;const t=e.data.layer;u.has(t)?u.get(t).items.push(e):u.set(t,{id:`${t.id}`,label:t.title,items:[e]})}));const j=p.filter((({layer:e})=>u.has(e))).map((({layer:e})=>u.get(e))).toArray(),k=h>10||this._filterText.length>0;return S(s,{active:this.isPanelActive(e),key:"feature-list",heading:d,headingLevel:i,handleBack:r,messages:o,messagesCommon:n,sketchViewModel:m,snappingControls:l},S("div",{class:E},S("div",{class:L},g({id:this.id,enableListScroll:!1,filterEnabled:k,filterText:this._filterText,items:j,messages:{filterPlaceholder:a.filterPlaceholder,noItems:a.noItems,noMatches:a.noMatches},onItemMouseEnter:({data:e})=>this._setCandidateFeature(e),onItemMouseLeave:()=>this._setCandidateFeature(null),onItemSelect:({data:e})=>this._setCandidateFeature(e,!0),onFilterChange:e=>this._filterText=e}))))}EditorPanel(e,...t){const{active:s,handleBack:r,heading:i,headingLevel:o,key:n,messages:a,messagesCommon:l,showBackButton:p,sketchViewModel:m,snappingControls:c}=e,{snappingControls:d,undoRedoButtons:u}=this.visibleElements;return S("calcite-flow-item",{bind:this,key:n,heading:i,headingLevel:o,showBackButton:p??!0,"intl-back":l.back,closable:!1,onCalciteFlowItemScroll:this._closeSnappingPopover,onCalciteFlowItemBackClick:r??null},S("div",{class:"esri-editor__panel-toolbar"},d?[S("calcite-popover",{autoClose:s,afterCreate:this._setSnappingPopover,afterUpdate:this._setSnappingPopover,bind:this,label:a.snappingSettings,heading:a.snappingSettings,referenceElement:this._snappingButton||null,"overlay-positioning":"fixed",placement:"bottom"},S("div",{class:"esri-editor__snapping-controls-popover"},c.render())),S("calcite-button",{id:`${n}__snappingButton`,afterCreate:this._setSnappingButton,afterUpdate:this._setSnappingButton,bind:this,text:a.snapping,appearance:"transparent",color:"neutral",alignment:"icon-end-space-between","icon-start":"vertex-gps","icon-end":"caret-down",width:"full",class:"esri-editor__panel-toolbar__snapping-button",onkeydown:e=>{"Escape"===e.key&&this._closeSnappingPopover()}},a.snapping)]:null,u?[S("calcite-button",{key:"undo-button",text:l.undo,appearance:"transparent",color:"neutral",alignment:"center","icon-start":"undo",scale:"l",disabled:!m.canUndo(),onclick:m.undo.bind(m)}),S("calcite-button",{key:"redo-button",text:l.redo,appearance:"transparent",color:"neutral",alignment:"center","icon-start":"redo",scale:"l",disabled:!m.canRedo(),onclick:m.redo.bind(m)})]:null),t)}_closeSnappingPopover(){this._snappingPopover?.open&&this._snappingPopover.toggle()}_setSnappingPopover(e){this._snappingPopover=e}_setSnappingButton(e){this._snappingButton=e,this.scheduleRender()}_getSketchingTip(e,t){const{messages:s}=this;if("point"===e)return s.tips.clickToAddPoint;if("polygon"===e||"polyline"===e){if(!t)return s.tips.clickToStart;const r=t.geometry,i="polygon"===e?"rings":"paths",[o]=r[i];return"polygon"===e&&o<4?s.tips.clickToContinue:s.tips.clickToContinueThenDoubleClickToEnd}return s.tips.clickToAddFeature}_getLabel(e){const s=e.layer;if(!s)return null;const{objectIdField:r}=s,{attributes:i}=e,o=d(s);return o&&i[o]&&`${i[o]}`||t(this.messages.untitledFeatureTemplate,{id:i[r]})}_handleDelete(){const{messages:e,messagesCommon:t}=this;this._prompt={title:e.deleteWarningTitle,message:e.deleteWarningMessage,context:"danger",actions:{primary:{label:t.delete,action:()=>{this.viewModel.deleteFeatureFromWorkflow(),this._prompt=null}},secondary:{label:e.keepFeature,action:()=>this._prompt=null}}}}_handleSave(){const{featureFormViewModel:e}=this.viewModel;e.submit(),!e.submittable||e.validateContingencyConstraints(e.getValues(),{includeIncompleteViolations:!0}).length>0||this.viewModel.activeWorkflow.commit()}_handleAttachmentAdd(){const{_attachments:e}=this,{activeWorkflow:t}=this.viewModel;"create-features"===t.type?(e.addFile(),t.previous()):e.addAttachment().then((()=>t.previous()))}_handleAttachmentUpdate(){const{_attachments:e}=this,{activeWorkflow:t}=this.viewModel;"create-features"===t.type?(e.updateFile(),t.previous()):e.updateAttachment().then((()=>t.previous()))}_handleAttachmentDelete(){const{messages:e,messagesCommon:t}=this;this._prompt={title:e.deleteAttachmentWarningTitle,message:e.deleteAttachmentWarningMessage,context:"danger",actions:{primary:{label:t.delete,action:()=>{const{_attachments:e}=this,{activeWorkflow:t}=this.viewModel;"create-features"===t.type?(e.deleteFile(),t.previous(),this._prompt=null):e.deleteAttachment(e.viewModel.activeAttachmentInfo).then((()=>{t.previous(),this._prompt=null}))}},secondary:{label:e.keepAttachment,action:()=>this._prompt=null}}}}_handleAdd(){this.viewModel.canCreate}_handleEdit(){this.viewModel.canUpdate&&this.viewModel.startUpdateWorkflowAtFeatureSelection()}_handleDone(){this.viewModel.cancelWorkflow({force:!0})}async _handleBack(e){if(!this.activeWorkflow)return;const t=this.activeWorkflow;if(e?.stopPropagation(),this.viewModel.syncing)return;const s=()=>{t.hasPreviousStep?t.previous({cancelCurrentStep:!0}):this.viewModel.cancelWorkflow({force:!0})};if("create"===t.type||"create-features"===t.type&&t.numPendingFeatures>0||"editing-existing-feature"===t.stepId&&t.data.edits.modified){const{messages:e}=this,{type:r}=t,i="create"===r?e.cancelAddWarningMessage:e.cancelEditWarningMessage,o="create"===r?e.cancelAddTitle:e.cancelEditTitle,n="create"===r?e.continueAdding:e.continueEditing,a="create"===r?e.discardFeature:e.discardEdits;return this._prompt={title:o,message:i,context:"danger",actions:{primary:{label:a,action:()=>{this._prompt=null,s()}},secondary:{label:n,action:()=>this._prompt=null}}},void this.scheduleRender()}s()}_assertActiveCreateWorkflow(){const{type:e}=this.viewModel.activeWorkflow;if("create"===e||"create-features"===e)return this.viewModel.activeWorkflow;throw new Error("Expected activeWorkflow to be instance of CreateWorkflow or CreateFeaturesWorkflow")}_assertActiveUpdateWorkflow(){if("update"===this.viewModel.activeWorkflow.type)return this.viewModel.activeWorkflow;throw new Error("Expected activeWorkflow to be an UpdateWorkflow")}_shouldShowAttachmentsForWorkflow(e){const t="create-features"===e.type&&e.data.creationInfo;let s=!1;if(t){const{layerInfos:e}=this,{layer:r}=t,{data:i}=r.capabilities,o=e&&e.find((e=>e.layer===r));s="supportsAttachment"in i&&i.supportsAttachment&&(!o||!1!==o.allowAttachments)}return s||"update"===e.type&&e.data.editableItem.hasAttachments}};e([p()],I.prototype,"_attachments",void 0),e([p({readOnly:!0})],I.prototype,"activeWorkflow",null),e([p()],I.prototype,"allowedWorkflows",null),e([p()],I.prototype,"useDeprecatedCreateWorkflow",void 0),e([p()],I.prototype,"headingLevel",void 0),e([p()],I.prototype,"iconClass",void 0),e([p()],I.prototype,"label",null),e([p()],I.prototype,"labelOptions",null),e([p()],I.prototype,"layerInfos",null),e([p(),F("esri/widgets/Editor/t9n/Editor")],I.prototype,"messages",void 0),e([p(),F("esri/t9n/common")],I.prototype,"messagesCommon",void 0),e([p(),F("esri/widgets/FeatureTemplates/t9n/FeatureTemplates")],I.prototype,"messagesTemplates",void 0),e([p()],I.prototype,"snappingOptions",null),e([p()],I.prototype,"tooltipOptions",null),e([p()],I.prototype,"supportingWidgetDefaults",void 0),e([p()],I.prototype,"view",null),e([p(),M(["workflow-cancel","workflow-commit"])],I.prototype,"viewModel",void 0),e([p()],I.prototype,"visibleElements",void 0),e([m("visibleElements")],I.prototype,"castVisibleElements",null),e([C()],I.prototype,"_handleDelete",null),e([C()],I.prototype,"_handleAttachmentAdd",null),e([C()],I.prototype,"_handleAttachmentUpdate",null),e([C()],I.prototype,"_handleAttachmentDelete",null),e([C()],I.prototype,"_handleAdd",null),e([C()],I.prototype,"_handleEdit",null),e([C()],I.prototype,"_handleDone",null),I=e([c("esri.widgets.Editor")],I);const P=I;export{P as default};
