/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import{symbolTypes as e}from"../../symbols.js";import o from"../../core/Collection.js";import"../../chunks/object.js";import i from"../../core/Error.js";import s from"../../core/Evented.js";import r from"../../core/Handles.js";import{L as a}from"../../chunks/Logger.js";import{a as n,i as p,d as l,u as c,f as h,e as d,j as m}from"../../chunks/maybe.js";import{createAbortError as u,whenOrAbort as y}from"../../core/promiseUtils.js";import{on as g,watch as v,when as _,whenOnce as f,syncAndInitial as b}from"../../core/reactiveUtils.js";import{property as T}from"../../core/accessorSupport/decorators/property.js";import"../../core/lang.js";import"../../chunks/ensureType.js";import{subclass as E}from"../../core/accessorSupport/decorators/subclass.js";import{canProjectWithoutEngine as O,isLoaded as w,load as G,project as S}from"../../geometry/projection.js";import{g as j}from"../../chunks/projectionEllipsoid.js";import{b as k}from"../../geometry/Polygon.js";import{e as C}from"../../geometry/SpatialReference.js";import A from"../../layers/GraphicsLayer.js";import{i as R,j as U}from"../../chunks/elevationInfoUtils.js";import P from"../../geometry/Circle.js";import{V as I}from"../../chunks/InputManager.js";import{S as M}from"../../chunks/keybindings.js";import D from"../../views/interactive/sketch/SketchLabelOptions.js";import H from"../../views/interactive/sketch/SketchTooltipOptions.js";import{S as x}from"../../chunks/SnappingManager.js";import L from"../../views/interactive/snapping/SnappingOptions.js";import{f as F}from"../../chunks/hitTestSelectUtils.js";import{c as N}from"../../chunks/screenUtils2.js";import{n as V}from"../../chunks/compilerUtils.js";import Y from"../../symbols/SimpleMarkerSymbol.js";import W from"../../symbols/SimpleFillSymbol.js";import K from"../../symbols/SimpleLineSymbol.js";import"../../symbols/CIMSymbol.js";import"../../chunks/string.js";import"../../chunks/enumeration.js";import"../../chunks/jsonMap.js";import"../../chunks/reader.js";import"../../chunks/writer.js";import"../../layers/support/fieldUtils.js";import"../../chunks/arcadeOnDemand.js";import"../../geometry.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../core/JSONSupport.js";import"../../core/Accessor.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/metadata.js";import"../../chunks/ArrayPool.js";import"../../chunks/tracking.js";import"../../chunks/watch.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../config.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/Ellipsoid.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polyline.js";import"../../chunks/extentUtils.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../symbols/Symbol.js";import"../../Color.js";import"../../chunks/colorUtils.js";import"../../chunks/mathUtils.js";import"../../chunks/vec3.js";import"../../chunks/common.js";import"../../symbols/ExtrudeSymbol3DLayer.js";import"../../symbols/Symbol3DLayer.js";import"../../chunks/utils2.js";import"../../symbols/edges/Edges3D.js";import"../../chunks/screenUtils.js";import"../../chunks/materialUtils.js";import"../../chunks/opacityUtils.js";import"../../symbols/edges/SketchEdges3D.js";import"../../symbols/edges/SolidEdges3D.js";import"../../chunks/Symbol3DMaterial.js";import"../../symbols/FillSymbol.js";import"../../symbols/LineSymbol.js";import"../../symbols/LineSymbolMarker.js";import"../../chunks/lineMarkers.js";import"../../symbols/FillSymbol3DLayer.js";import"../../symbols/patterns/LineStylePattern3D.js";import"../../symbols/patterns/StylePattern3D.js";import"../../chunks/utils3.js";import"../../chunks/colors.js";import"../../chunks/symbolLayerUtils3D.js";import"../../chunks/aaBoundingBox.js";import"../../chunks/aaBoundingRect.js";import"../../symbols/Font.js";import"../../symbols/IconSymbol3DLayer.js";import"../../core/urlUtils.js";import"../../chunks/persistableUrlUtils.js";import"../../symbols/LabelSymbol3D.js";import"../../symbols/Symbol3D.js";import"../../chunks/collectionUtils.js";import"../../portal/Portal.js";import"../../kernel.js";import"../../request.js";import"../../core/Loadable.js";import"../../core/Promise.js";import"../../chunks/locale.js";import"../../portal/PortalQueryParams.js";import"../../portal/PortalQueryResult.js";import"../../portal/PortalUser.js";import"../../portal/PortalFolder.js";import"../../portal/PortalGroup.js";import"../../symbols/LineSymbol3DLayer.js";import"../../symbols/LineStyleMarker3D.js";import"../../core/Clonable.js";import"../../symbols/ObjectSymbol3DLayer.js";import"../../symbols/PathSymbol3DLayer.js";import"../../symbols/TextSymbol3DLayer.js";import"../../symbols/WaterSymbol3DLayer.js";import"../../symbols/support/StyleOrigin.js";import"../../chunks/Thumbnail.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../chunks/calloutUtils.js";import"../../symbols/callouts/Callout3D.js";import"../../symbols/callouts/LineCallout3D.js";import"../../symbols/support/Symbol3DVerticalOffset.js";import"../../symbols/LineSymbol3D.js";import"../../symbols/MarkerSymbol.js";import"../../symbols/MeshSymbol3D.js";import"../../symbols/PictureFillSymbol.js";import"../../chunks/urlUtils.js";import"../../symbols/PictureMarkerSymbol.js";import"../../symbols/PointSymbol3D.js";import"../../symbols/PolygonSymbol3D.js";import"../../symbols/TextSymbol.js";import"../../symbols/WebStyleSymbol.js";import"../../chunks/unitUtils.js";import"../../chunks/mat4.js";import"../../chunks/pe.js";import"../../chunks/assets.js";import"../../chunks/geodesicConstants.js";import"../../geometry/support/GeographicTransformation.js";import"../../geometry/support/GeographicTransformationStep.js";import"../../chunks/zscale.js";import"../../chunks/GraphicsCollection.js";import"../../Graphic.js";import"../../PopupTemplate.js";import"../../popup/content.js";import"../../popup/content/AttachmentsContent.js";import"../../popup/content/Content.js";import"../../popup/content/CustomContent.js";import"../../popup/content/ExpressionContent.js";import"../../popup/ElementExpressionInfo.js";import"../../popup/content/FieldsContent.js";import"../../popup/FieldInfo.js";import"../../popup/support/FieldInfoFormat.js";import"../../chunks/date.js";import"../../chunks/number.js";import"../../popup/content/MediaContent.js";import"../../popup/content/BarChartMediaInfo.js";import"../../popup/content/mixins/ChartMediaInfo.js";import"../../popup/content/mixins/MediaInfo.js";import"../../popup/content/support/ChartMediaInfoValue.js";import"../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../chunks/chartMediaInfoUtils.js";import"../../popup/content/ColumnChartMediaInfo.js";import"../../popup/content/ImageMediaInfo.js";import"../../popup/content/support/ImageMediaInfoValue.js";import"../../popup/content/LineChartMediaInfo.js";import"../../popup/content/PieChartMediaInfo.js";import"../../popup/content/RelationshipContent.js";import"../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../popup/content/TextContent.js";import"../../popup/ExpressionInfo.js";import"../../popup/LayerOptions.js";import"../../popup/RelatedRecordsInfo.js";import"../../support/actions/ActionBase.js";import"../../core/Identifiable.js";import"../../support/actions/ActionButton.js";import"../../support/actions/ActionToggle.js";import"../../core/HandleOwner.js";import"../../chunks/WatchUpdatingTracking.js";import"../../layers/Layer.js";import"../../layers/mixins/BlendLayer.js";import"../../chunks/jsonUtils.js";import"../../chunks/parser.js";import"../../chunks/mat4f32.js";import"../../chunks/_commonjsHelpers.js";import"../../layers/mixins/ScaleRangeLayer.js";import"../../chunks/ElevationInfo.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/lengthUtils.js";import"../../geometry/support/geodesicUtils.js";import"../../chunks/Queue.js";import"../../chunks/ObservableValue.js";import"../../chunks/RightAngleSnappingHint.js";import"../../chunks/vec2.js";import"../../chunks/QueryEngineResult.js";import"../../chunks/quantizationUtils.js";import"../../chunks/ItemCache.js";import"../../chunks/MemCache.js";import"../../core/sql/WhereClause.js";import"../../chunks/utils13.js";import"../../chunks/generateRendererUtils.js";import"../../chunks/colorRamps.js";import"../../rest/support/AlgorithmicColorRamp.js";import"../../rest/support/ColorRamp.js";import"../../rest/support/MultipartColorRamp.js";import"../../chunks/projectionSupport.js";import"../../chunks/json.js";import"../../chunks/SnappingCandidate.js";import"../../chunks/utils21.js";import"../../geometry/support/normalizeUtils.js";import"../../chunks/normalizeUtilsCommon.js";import"../../chunks/simplify.js";import"../../chunks/utils4.js";import"../../chunks/utils5.js";import"../../chunks/featureConversionUtils.js";import"../../chunks/OptimizedFeature.js";import"../../chunks/OptimizedFeatureSet.js";import"../../chunks/vec2f64.js";import"../../chunks/Settings2.js";import"../../chunks/geometry2dUtils.js";import"../../chunks/viewUtils.js";import"../../views/interactive/snapping/FeatureSnappingLayerSource.js";function q(t){switch(t){case z.SUPPORTED:break;case z.GRAPHICS_LAYER_MISSING:return"not owned by a graphics layer";case z.GEOMETRY_MISSING:return"no geometry";case z.GEOMETRY_TYPE_UNSUPPORTED:return"the geometry type is not supported";case z.ELEVATION_MODE_UNSUPPORTED:return"the elevation mode is not supported";case z.SYMBOL_TYPE_UNSUPPORTED:return"the symbol type is not supported"}return""}var z;function B(t){if("graphics"!==t.layer?.type)return z.GRAPHICS_LAYER_MISSING;if(n(t.geometry))return z.GEOMETRY_MISSING;switch(t.geometry.type){case"polygon":case"point":case"polyline":case"mesh":break;default:return z.GEOMETRY_TYPE_UNSUPPORTED}return"on-the-ground"!==R(t)&&U(t)?z.ELEVATION_MODE_UNSUPPORTED:z.SUPPORTED}function Z(t){return $(t).result}function Q(t){return $(t).geometry}function $(t){return"graphics"!==t.layer?.type?{result:z.GRAPHICS_LAYER_MISSING,geometry:null}:n(t.geometry)?{result:z.GEOMETRY_MISSING,geometry:null}:"on-the-ground"!==R(t)&&U(t)?{result:z.ELEVATION_MODE_UNSUPPORTED,geometry:null}:"point"!==t.geometry.type&&"polyline"!==t.geometry.type&&("polygon"!==t.geometry.type||t.geometry instanceof P)?{result:z.GEOMETRY_TYPE_UNSUPPORTED,geometry:null}:{result:z.SUPPORTED,geometry:t.geometry}}function J(t,e,o){if(!e||!t||!t.map)return;const{map:i}=t,s=i.layers.find((t=>t===e));s||i.add(e,o),null!=o&&i.layers.reorder(s,o)}function X(t,e){return t.allLayerViews.find((t=>{const o=t.layer;return o===e||"sublayers"in o&&p(o.sublayers)&&o.sublayers.includes(e)}))}!function(t){t[t.SUPPORTED=0]="SUPPORTED",t[t.GRAPHICS_LAYER_MISSING=1]="GRAPHICS_LAYER_MISSING",t[t.GEOMETRY_MISSING=2]="GEOMETRY_MISSING",t[t.GEOMETRY_TYPE_UNSUPPORTED=3]="GEOMETRY_TYPE_UNSUPPORTED",t[t.ELEVATION_MODE_UNSUPPORTED=4]="ELEVATION_MODE_UNSUPPORTED",t[t.SYMBOL_TYPE_UNSUPPORTED=5]="SYMBOL_TYPE_UNSUPPORTED"}(z||(z={}));let tt=class extends s.EventedAccessor{constructor(t){super(t),this.cancelled=!1,this.history={undo:[],redo:[]},this.type=null}get tool(){if(!this.activeComponent)return null;switch(this.activeComponent.type){case"graphic-mover":case"move-3d":return"move";case"box":case"transform-3d":return"transform";case"reshape":case"reshape-3d":return"reshape";case"draw-2d":case"draw-3d":return this.activeComponent.geometryType;default:V(this.activeComponent)}return null}addToHistory(t){this.history.redo=[],this.history.undo.push(t)}resetHistory(){this.history.redo=[],this.history.undo=[]}canUndo(){return this.history.undo.length>0}canRedo(){return this.history.redo.length>0}complete(){this._reset(),this.onEnd(),this.emit("complete")}cancel(){this.cancelled=!0,this.complete()}_reset(){this.activeComponent.reset()}refreshComponent(){const t=this.activeComponent;t&&("box"!==t.type&&"reshape"!==t.type&&"graphic-mover"!==t.type||t.refresh())}set undo(t){this._set("undo",(()=>{this.canUndo()&&t()}))}set redo(t){this._set("redo",(()=>{this.canRedo()&&t()}))}};t([T()],tt.prototype,"activeComponent",void 0),t([T()],tt.prototype,"cancelled",void 0),t([T()],tt.prototype,"history",void 0),t([T()],tt.prototype,"tool",null),t([T()],tt.prototype,"type",void 0),t([T()],tt.prototype,"canUndo",null),t([T()],tt.prototype,"canRedo",null),t([T()],tt.prototype,"onEnd",void 0),t([T()],tt.prototype,"undo",null),t([T()],tt.prototype,"redo",null),t([T()],tt.prototype,"toggleTool",void 0),t([T()],tt.prototype,"addToSelection",void 0),t([T()],tt.prototype,"removeFromSelection",void 0),tt=t([E("esri.widgets.Sketch.support.OperationHandle")],tt);let et=class extends tt{};t([T()],et.prototype,"activeComponent",void 0),et=t([E("esri.widgets.Sketch.support.CreateOperationHandle")],et);let ot=class extends tt{};t([T()],ot.prototype,"activeComponent",void 0),ot=t([E("esri.widgets.Sketch.support.UpdateOperationHandle")],ot);const it={defaultZ:0},st={reshapeOptions:{edgeOperation:"split",shapeOperation:"move",vertexOperation:"move"},enableMoveAllGraphics:!0,enableRotation:!0,enableScaling:!0,multipleSelectionEnabled:!0,preserveAspectRatio:!1,toggleToolOnClick:!0,enableZ:!0,tool:"transform"};let rt=class extends s.EventedAccessor{constructor(t){super(t),this._numUpdating=0,this._handles=new r,this._internalGraphicsLayer=new A({listMode:"hide",internal:!0,title:"SVM Internal"}),this._operationHandle=null,this._viewHandles=new r,this.activeFillSymbol=null,this.activeLineSymbol=null,this.activeVertexSymbol=null,this.allowDeleteKey=!0,this.labelOptions=new D,this.layer=null,this.pointSymbol=new Y({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this.polygonSymbol=new W({color:[150,150,150,.2],outline:{color:[50,50,50],width:2}}),this.polylineSymbol=new K({color:[130,130,130,1],width:2}),this._snappingManager=null,this.tooltipOptions=new H,this.updateGraphics=new o,this.updateOnGraphicClick=!0,this.updatePointSymbol=new Y({size:10,color:[0,200,255,.5],outline:{color:"black",width:1}}),this.updatePolygonSymbol=new W({color:[12,207,255,.2],outline:{join:"round",color:[12,207,255],width:2}}),this.updatePolylineSymbol=new K({color:[12,207,255],width:2}),this.vertexSymbol=new Y({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this._moduleLoaderAbortController=null,this._viewReadyAbortController=null,this._originalAutoOpenEnabled=null,this.defaultCreateOptions=it,this.defaultUpdateOptions=st,this.snappingOptions=new L}initialize(){this._handles.add([g((()=>this.view?.map?.layers),"change",(t=>{t.removed.includes(this.layer)&&this.cancel()})),g((()=>this.layer?.graphics),"change",(t=>{if(p(this._operationHandle))for(const e of t.removed)this.updateGraphics.includes(e)&&(this.updateGraphics.length>1?this._operationHandle.removeFromSelection(e):this._operationHandle.cancel())})),v((()=>this.layer?.elevationInfo??null),(t=>{t!==this._internalGraphicsLayer.elevationInfo&&(this.cancel(),this._internalGraphicsLayer.elevationInfo=t)}),b),v((()=>this.view),(t=>{l(this._snappingManager),t&&(this._snappingManager=new x({view:t,options:this.snappingOptions}),"2d"===t.type?import("../../chunks/editingTools.js"):"3d"===t.type&&(import("../../chunks/editingTools2.js"),import("../../chunks/GraphicsLayerView3D.js")))}),b),v((()=>this.view?.spatialReference),((t,e)=>{t&&e&&!t.equals(e)&&this.cancel()}))])}destroy(){this.cancel(),this._handles=l(this._handles),this._viewHandles=l(this._viewHandles),this._removeDefaultLayer(),this._snappingManager=l(this._snappingManager),this._set("view",null),this.emit("destroy")}get _defaultUpdateTool(){return"3d"===this.view.type?"move":"transform"}get updating(){return this._numUpdating>0}get activeTool(){return this._operationHandle&&this._operationHandle.tool?this._operationHandle.tool:null}get activeComponent(){return this._operationHandle?this._operationHandle.activeComponent:null}get createGraphic(){return!p(this.activeComponent)||"draw-3d"!==this.activeComponent.type&&"draw-2d"!==this.activeComponent.type?this._get("createGraphic"):c(this.activeComponent.graphic)}get defaultCreateOptions(){return this._get("defaultCreateOptions")}set defaultCreateOptions(t){this._set("defaultCreateOptions",{...it,...t})}get defaultUpdateOptions(){return this._get("defaultUpdateOptions")}set defaultUpdateOptions(t){this._set("defaultUpdateOptions",{...st,...t,reshapeOptions:{...st.reshapeOptions,...t?.reshapeOptions}})}set snappingOptions(t){p(this._snappingManager)&&(this._snappingManager.options=t),this._set("snappingOptions",t)}get state(){const t=!(!this.view?.ready||!this.layer),e=this._operationHandle;return t&&e?"active":t?"ready":"disabled"}get view(){return this._get("view")}set view(t){const e=this._get("view");if(e){const{container:t,map:o}=e;t&&(e.cursor=null),o&&o.remove(this._internalGraphicsLayer),this._viewHandles.removeAll(),this.cancel()}const o="view-ready";this._handles.remove(o),t&&this._handles.add(_((()=>t.ready),(e=>{this._viewHandles.removeAll(),e&&this._viewHandles.add(this._generateViewHandles(t))}),b),o),this._set("view",t)}cancel(){this._moduleLoaderAbortController=h(this._moduleLoaderAbortController),this._viewReadyAbortController=h(this._viewReadyAbortController),this._operationHandle&&this._operationHandle.cancel()}complete(){this._operationHandle&&this._operationHandle.complete()}delete(){const{state:t,updateGraphics:e}=this;if("active"===t&&e.length){const{activeTool:t,layer:o}=this,i=e.toArray();o.removeMany(i),this.cancel(),this._emitDeleteEvent({graphics:i,tool:t})}}async create(t,e){if(this.cancel(),await this._waitViewReady(),"disabled"===this.state)throw this.layer||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),this.view||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),u();if(p(this.view.activeTool)&&(this.view.activeTool=null),!t)return void this._logError("sketch:missing-parameter","Missing parameter 'tool'.");J(this.view,this._internalGraphicsLayer);const o=await this._setupCreateOperation(t,e);n(o)||this.destroyed?this.view.map.remove(this._internalGraphicsLayer):(o.on("complete",(()=>{if(o===this._operationHandle){const e=this.createGraphic,i=this._operationHandle.cancelled;this._operationHandle.destroy(),this._operationHandle=null,this._set("createGraphic",null),this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),o.cancelled||null==e||this.layer.add(e),this.emit("create",{graphic:e,state:i?"cancel":"complete",tool:t,toolEventInfo:null,type:"create"})}})),this._operationHandle=o,this.view.ready&&this.view.focus())}async update(t,e){this.cancel(),await this._waitViewReady();const{layer:o,view:i,state:s}=this;if("disabled"===s)throw i||this._logError("sketch:missing-property","Property 'view' is missing on SketchViewModel."),o||this._logError("sketch:missing-property","Property 'layer' is missing on SketchViewModel."),u();p(this.view.activeTool)&&(this.view.activeTool=null);const r=Array.isArray(t)?t:[t];if(null==t||!r||!r.length)return void this._logError("sketch:missing-parameter","Missing parameter 'graphics'.");if(r.some((t=>t.layer!==o?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics missing from the supplied GraphicsLayer."),!0):!!n(t.geometry)&&(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with an unsupported geometry."),!0))))return;const a=await this._setupUpdateOperation(r,e);this.destroyed||n(a)||ct(a)||(J(this.view,this._internalGraphicsLayer),this._setUpdateOperationHandle(a,e),this.emit("update",{graphics:r,state:"start",aborted:!1,tool:a.tool,toolEventInfo:null,type:"update"}))}async _updateSpatialReference(t){this._beginAsyncOperation(),t=Array.isArray(t)?t:[t];for(const e of t)p(e.geometry)&&"mesh"!==e.geometry.type&&!C(e.geometry.spatialReference,this.view.spatialReference)&&(O(e.geometry.spatialReference,this.view.spatialReference)||w()||await G(),e.geometry=S(e.geometry,this.view.spatialReference));this._endAsyncOperation()}undo(){this.canUndo()&&this._operationHandle.undo()}redo(){this.canRedo()&&this._operationHandle.redo()}canUndo(){return!(!this._operationHandle||!this._operationHandle.canUndo())}canRedo(){return!(!this._operationHandle||!this._operationHandle.canRedo())}toggleUpdateTool(){this._operationHandle&&this._operationHandle.toggleTool&&this._operationHandle.toggleTool()}async _getFirstHit(t){const e=this.view;if("2d"===e.type){const e=[];this.view.map.allLayers.forEach((t=>{"vector-tile"!==t.type&&"imagery"!==t.type||e.push(t)}));const o=await this.view.hitTest(t,{exclude:e});return F(o.results)}const o=[this.view.map.ground];e.map.allLayers.forEach((t=>{"integrated-mesh"===t.type&&o.push(t)}));const i=await e.hitTest(t,{exclude:o});if(i.results.length>0){const t=i.results[0];if(p(t)&&"graphic"===t.type&&t.graphic&&(!i.ground.mapPoint||e.map.ground.opacity<1||i.ground.distance-d(t.distance,0)>-Math.min(3*i.ground.distance,"global"===e.viewingMode?j(e.renderCoordsHelper.spatialReference).radius/e.renderCoordsHelper.unitInMeters:Number.POSITIVE_INFINITY)))return t}return null}_generateViewHandles(t){return[t.on("immediate-click",(async e=>{const o="active"===this.state&&"create"===this._operationHandle.type;if("disabled"===this.state||o||!this.updateOnGraphicClick)return;this._beginAsyncOperation();const i=await e.async((()=>this._getFirstHit(N(e))));let s=null;if(p(i)){const o=i.graphic;this.updateGraphics.includes(o)||o.layer===this.layer?(e.stopPropagation(),s=o):"2d"!==t.type||this._isComponentGraphic(o)||"active"!==this.state||this.cancel()}else"active"===this.state&&this.cancel();p(s)&&!this.updateGraphics.includes(s)&&await this.update([s],{...this.defaultUpdateOptions,reshapeOptions:{...this.defaultUpdateOptions.reshapeOptions}}),this._endAsyncOperation()}),I.WIDGET)]}async _setupCreateOperation(t,e){const o={hasZ:"3d"===this.view.type,...this.defaultCreateOptions,...e},i=await this._setupDrawGraphicTool(t,this.view,o);return n(i)?null:(this.view.tools.add(i),this.view.activeTool=i,this._setupCreateOperationHandle(i))}async _setupDrawGraphicTool(t,e,o){if("multipoint"===t&&"3d"===e.type)return this._logError("sketch:create","Multipoint geometries are not supported in SceneView."),null;const i="rectangle"!==t,s="rectangle"!==t;this.snappingOptions.enabledToggled=!1;const r={view:e,mode:"rectangle"===t||"circle"===t?"hybrid":"click",...o,snapToScene:!1,geometryType:t,graphicSymbol:this._getGraphicSymbolFromTool(t),snappingManager:this._snappingManager,forceUniformSize:s,centered:i};return"2d"===this.view.type?this._makeDrawGraphicTool2D(r):this._makeDrawGraphicTool3D(r)}async _makeDrawGraphicTool2D(t){const e=await this._requireModule(import("../../chunks/editingTools.js"));return ct(e)||this.destroyed?null:new e.module.DrawGraphicTool2D({...t,activeVertexSymbol:this.activeVertexSymbol,regularVerticesSymbol:this.vertexSymbol,activeLineSymbol:this.activeLineSymbol,activeFillSymbol:(o=t.geometryType,"polygon"===o||"rectangle"===o||"circle"===o?this.activeFillSymbol:null),tooltipOptions:this.tooltipOptions});var o}async _makeDrawGraphicTool3D(t){const e=await this._requireModule(import("../../chunks/editingTools2.js"));if(ct(e)||this.destroyed)return null;const{elevationInfo:o}=this.layer;return new e.module.DrawGraphicTool3D({...t,elevationInfo:o,snapToScene:!p(o)||"absolute-height"===o.mode,labelOptions:this.labelOptions,tooltipOptions:this.tooltipOptions})}_setupCreateOperationHandle(t){let e=null;const o=t.forceUniformSize,i=t.centered,s=[this.view.on("key-down",(e=>{if(e.key===M.pan)e.stopPropagation(),e.repeat||(t.enabled=!1);else if(e.key===M.complete)e.stopPropagation(),t.completeCreateOperation();else if(e.key!==M.vertexAdd||e.repeat)e.key===M.undo?(e.stopPropagation(),r.undo()):e.key===M.redo?(e.stopPropagation(),r.redo()):e.key!==M.snappingToggle||"rectangle"===t.geometryType||"circle"===t.geometryType||e.repeat?e.key!==M.constraint||"rectangle"!==t.geometryType&&"circle"!==t.geometryType||e.repeat?e.key===M.center&&(e.repeat||(t.centered=!i,e.stopPropagation())):(t.forceUniformSize=!o,e.stopPropagation()):(this.snappingOptions.enabledToggled=!0,e.stopPropagation());else{const o=t.drawOperation.geometryType;"polyline"!==o&&"polygon"!==o&&"multipoint"!==o||(e.stopPropagation(),t.drawOperation.commitStagedVertex())}}),I.WIDGET),this.view.on("key-up",(e=>{e.key===M.pan?t.enabled=!0:e.key===M.snappingToggle&&"rectangle"!==t.geometryType&&"circle"!==t.geometryType?(this.snappingOptions.enabledToggled=!1,e.stopPropagation()):e.key!==M.constraint||"rectangle"!==t.geometryType&&"circle"!==t.geometryType?e.key===M.center&&(t.centered=i,e.stopPropagation()):(t.forceUniformSize=o,e.stopPropagation())}),I.WIDGET),t.on("vertex-add",(o=>{switch(e=n(e)?"start":"active",o.operation){case"apply":this.emit("create",{graphic:c(t.graphic),state:e,tool:this.activeTool,toolEventInfo:o,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[c(t.graphic)],tool:t.geometryType});break;case"redo":this._emitRedoEvent({graphics:[c(t.graphic)],tool:t.geometryType})}})),t.on("cursor-update",(e=>{t.drawOperation.numCommittedVertices>0&&this.emit("create",{graphic:c(t.graphic),state:"active",tool:this.activeTool,toolEventInfo:{coordinates:e.vertices[0].coordinates,type:"cursor-update"},type:"create"})})),t.on("vertex-remove",(e=>{switch(e.operation){case"apply":this.emit("create",{graphic:c(t.graphic),state:"active",tool:this.activeTool,toolEventInfo:e,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[c(t.graphic)],tool:t.geometryType});break;case"redo":this._emitRedoEvent({graphics:[c(t.graphic)],tool:t.geometryType})}})),t.on("complete",(t=>{this._set("createGraphic",c(t.graphic)),e="complete",t.aborted?r&&r.cancel():r&&r.complete()})),v((()=>this._getGraphicSymbolFromTool(t.geometryType)),(e=>{t.graphicSymbol=e}))],r=new et({activeComponent:t,tool:t.geometryType,type:"create",onEnd:()=>{s.forEach((t=>t.remove())),s.length=0,this.view.tools?.remove(t)},undo:()=>{t.canUndo&&t.undo()},redo:()=>{t.canRedo&&t.redo()},canUndo:()=>t.canUndo,canRedo:()=>t.canRedo});return r}_getGraphicSymbolFromTool(t){switch(t){case"point":case"multipoint":return this.pointSymbol;case"polyline":return this.polylineSymbol;case"circle":case"rectangle":case"polygon":return this.polygonSymbol;default:return null}}async _setupUpdateOperation(t,e){const{layer:o,view:i}=this,s={tool:this._defaultUpdateTool,...this.defaultUpdateOptions,...e,reshapeOptions:{...this.defaultUpdateOptions.reshapeOptions,...e?.reshapeOptions}};let r=s.tool;for(const e of t)o.remove(e),o.add(e);if("3d"===i.type){if(0===t.length)return null;switch(r){case"move":return this._setupMove3DOperation(t,s,i,r);case"reshape":{if(t.length>1)return this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null;const e=Z(t[0]);return e===z.SUPPORTED?this._setupReshape3DOperation(t[0],s,i):(this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${q(e)}).`),null)}case"transform":return this._setupGraphicTransform3DOperation(t,s,i)}}switch(r){case"move":return this._setupMove2DOperation(t,s,i);case"reshape":{if(t.length>1)return this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null;const e=Z(t[0]);return e===z.SUPPORTED?this._setupTransformOrReshape2DOperation(t,r,s,i):(this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${q(e)}).`),null)}case"transform":if(1===t.length){const e=m(t[0].geometry,"type");"point"!==e&&"multipoint"!==e||(r="reshape")}return this._setupTransformOrReshape2DOperation(t,r,s,i)}}async _setupMove3DOperation(t,e,o,i,s=!1){for(const e of t){const t=B(e);if(t!==z.SUPPORTED)return this._logError("sketch:move",`Move operation not supported for provided graphic(s) (${q(t)}).`),null}const r=await this._requireModule(import("../../chunks/editingTools2.js"));if(ct(r))return r;const a=new r.module.GraphicMoveTool({view:o,enableZ:e.enableZ,snappingManager:this._snappingManager,tooltipOptions:this.tooltipOptions});this.view.tools.add(a),a.graphics.addMany(t),s||this.updateGraphics.addMany(t);const n=[],p=new ot({activeComponent:a,tool:i,type:"update",onEnd:()=>{n.forEach((t=>t.remove())),n.length=0,this.view.tools?.remove(a),a.destroyed||a.destroy()},undo:()=>{at(p,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:i})},redo:()=>{nt(p,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:i})},addToSelection:t=>{this.updateGraphics.push(t),a.graphics.push(t),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[t],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:t=>{const e=this.updateGraphics.indexOf(t);p.history.undo.forEach((t=>t.updates.splice(e,1))),p.history.redo.forEach((t=>t.updates.splice(e,1))),this.updateGraphics.remove(t),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[t],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?a.graphics.remove(t):p.complete()},toggleTool:async()=>{if(1!==this.updateGraphics.length||!1===e.toggleToolOnClick)return;if("transform"!==i)return;const t=this.updateGraphics.getItemAt(0);if(Z(t)!==z.SUPPORTED)return;const s=await this._setupReshape3DOperation(t,e,o,!0);ct(s)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(s,e))}});return n.push(...this._getHandlesForComponent(p,e),this.view.on("immediate-click",(t=>this._getCommonUpdateOperationClickHandlers(p,t,e)),I.WIDGET),o.on("key-down",(t=>{this._getCommonUpdateOperationKeyDownHandlers(p,t),t.key===M.snappingToggle&&(this.snappingOptions.enabledToggled=!0,t.stopPropagation())}),I.WIDGET),o.on("key-up",(t=>{t.key===M.snappingToggle&&(this.snappingOptions.enabledToggled=!1,t.stopPropagation())}),I.WIDGET)),p}_setupGraphicTransform3DOperation(t,e,o,i=!1){if(1===t.length&&function(t){if("graphics"!==t.layer?.type)return z.GRAPHICS_LAYER_MISSING;if(n(t.geometry))return z.GEOMETRY_MISSING;switch(t.geometry.type){case"point":break;case"polygon":case"polyline":case"multipoint":case"extent":case"mesh":return z.SUPPORTED;default:return z.GEOMETRY_TYPE_UNSUPPORTED}const e=p(t.symbol)&&"point-3d"===t.symbol.type&&t.symbol.symbolLayers;return e&&e.length>0&&e.some((t=>"object"===t.type))?"on-the-ground"!==R(t)&&U(t)?z.ELEVATION_MODE_UNSUPPORTED:z.SUPPORTED:z.SYMBOL_TYPE_UNSUPPORTED}(t[0])===z.SUPPORTED){const s=t[0],r=s.geometry;if(p(r)&&("point"===r.type||"mesh"===r.type))return this._setupPointTransform3DOperation(s,e,o);if(p(r)&&("polygon"===r.type||"polyline"===r.type))return this._setupPolyTransform3DOperation(s,e,o,i)}return this._setupMove3DOperation(t,e,o,"transform",i)}async _setupPointTransform3DOperation(t,e,o){const i="transform",{enableRotation:s,enableScaling:r,enableZ:a}=e,n=await this._requireModule(import("../../chunks/editingTools2.js"));if(ct(n))return n;const p=new n.module.GraphicTransformTool({graphic:t,view:o,enableRotation:s,enableScaling:r,enableZ:a,snappingManager:this._snappingManager,tooltipOptions:this.tooltipOptions});this.view.tools.add(p),this.updateGraphics.add(t);const l=[],c=new ot({activeComponent:p,tool:i,type:"update",onEnd:()=>{l.forEach((t=>t.remove())),l.length=0,this.view.tools?.remove(p),p.destroyed||p.destroy()},undo:()=>{at(c,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:i})},redo:()=>{nt(c,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:i})},addToSelection:async t=>{this.updateGraphics.add(t),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[t],removed:[],type:"selection-change"},type:"update"});const i=await this._setupMove3DOperation(this.updateGraphics.toArray(),e,o,"transform",!0);ct(i)||(c.onEnd(),c.destroy(),this._setUpdateOperationHandle(i,e))},removeFromSelection:t=>{this.updateGraphics.remove(t),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[t],type:"selection-change"},type:"update"}),c.complete()},toggleTool:()=>{}});return l.push(...this._getHandlesForComponent(c,e),this.view.on("immediate-click",(t=>this._getCommonUpdateOperationClickHandlers(c,t,e)),I.WIDGET),o.on("key-down",(t=>{this._getCommonUpdateOperationKeyDownHandlers(c,t),t.key===M.snappingToggle&&(this.snappingOptions.enabledToggled=!0,t.stopPropagation())}),I.WIDGET),o.on("key-up",(t=>{t.key===M.snappingToggle&&(this.snappingOptions.enabledToggled=!1,t.stopPropagation())}),I.WIDGET)),c}async _setupPolyTransform3DOperation(t,e,o,i=!1){const s="transform",{enableRotation:r,enableScaling:a,enableZ:n,preserveAspectRatio:p}=e,l=await this._requireModule(import("../../chunks/editingTools2.js"));if(ct(l))return l;const c=new l.module.ExtentTransformTool({graphic:t,view:o,enableRotation:r,enableScaling:a,enableZ:n,preserveAspectRatio:p,tooltipOptions:this.tooltipOptions});this.view.tools.add(c),i||this.updateGraphics.add(t);const h=[],d=new ot({activeComponent:c,tool:s,type:"update",onEnd:()=>{h.forEach((t=>t.remove())),h.length=0,this.view.tools?.remove(c),c.destroyed||c.destroy()},canUndo:()=>c.canUndo,undo:()=>{c.undo(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:s})},canRedo:()=>c.canRedo,redo:()=>{c.redo(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:s})},addToSelection:async t=>{this.updateGraphics.add(t),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[t],removed:[],type:"selection-change"},type:"update"});const i=await this._setupMove3DOperation(this.updateGraphics.toArray(),e,o,"transform",!0);ct(i)||(d.onEnd(),d.destroy(),this._setUpdateOperationHandle(i,e))},removeFromSelection:t=>{this.updateGraphics.remove(t),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[t],type:"selection-change"},type:"update"}),d.complete()},toggleTool:async()=>{if(1!==this.updateGraphics.length||!1===e.toggleToolOnClick)return;const t=this.updateGraphics.getItemAt(0);if(Z(t)!==z.SUPPORTED)return;const i=await this._setupReshape3DOperation(t,e,o,!0);ct(i)||(d.onEnd(),d.destroy(),this._setUpdateOperationHandle(i,e))}});return h.push(...this._getHandlesForComponent(d,e),this.view.on("immediate-click",(t=>this._getCommonUpdateOperationClickHandlers(d,t,e)),I.WIDGET),this.view.on("key-down",(t=>this._getCommonUpdateOperationKeyDownHandlers(d,t)),I.WIDGET),this.view.on("key-down",(t=>{t.key!==M.constraint||t.repeat||(c.preserveAspectRatio=!c.preserveAspectRatio,t.stopPropagation())}),I.WIDGET),this.view.on("key-up",(t=>{t.key===M.constraint&&(c.preserveAspectRatio=!c.preserveAspectRatio,t.stopPropagation())}),I.WIDGET)),d}async _setupMove2DOperation(t,e,o){const i="move";this.updateGraphics.addMany(t),await this._updateSpatialReference(t);const s=await this._getGraphicMover(t,e,o);if(ct(s))return s;const r=new ot({activeComponent:s,tool:i,type:"update",onEnd:()=>{this._displayDefaultCursor(),p.forEach((t=>t.remove())),n.forEach((t=>t.remove())),p=[],n=[],s.destroy(),this._internalGraphicsLayer?.removeMany([...this.updateGraphics.toArray()])},undo:()=>{const t=this.updateGraphics.toArray();at(r,t),r.refreshComponent(),this._emitUndoEvent({graphics:t,tool:i})},redo:()=>{const t=this.updateGraphics.toArray();nt(r,t),r.refreshComponent(),this._emitRedoEvent({graphics:t,tool:i})},addToSelection:async t=>{await this._updateSpatialReference(t),this.updateGraphics.push(t),s.graphics=this.updateGraphics.toArray(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[t],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:t=>{const e=this.updateGraphics.indexOf(t);r.history.undo.forEach((t=>t.updates.splice(e,1))),r.history.redo.forEach((t=>t.updates.splice(e,1))),this.updateGraphics.remove(t);const o=this.updateGraphics.toArray();this.emit("update",{graphics:o,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[t],type:"selection-change"},type:"update"}),0!==this.updateGraphics.length?s.graphics=o:r.complete()}});let a=!1,n=[o.on("immediate-click",(t=>this._getCommonUpdateOperationClickHandlers(r,t,e)),I.WIDGET),o.on("key-down",(t=>{this._getCommonUpdateOperationKeyDownHandlers(r,t),t.key!==M.constraint||t.repeat||(a=!0,s.enableMoveAllGraphics=!s.enableMoveAllGraphics)}),I.WIDGET),o.on("key-up",(t=>{t.key===M.constraint&&a&&(a=!1,s.enableMoveAllGraphics=!s.enableMoveAllGraphics)}),I.WIDGET)],p=this._getHandlesForComponent(r,e);return r}async _setupReshape3DOperation(t,e,o,i=!1){const s="reshape",r=await this._requireModule(import("../../chunks/editingTools2.js"));if(ct(r))return r;this.snappingOptions.enabledToggled=!1;const a=new r.module.GraphicReshapeTool({view:o,graphic:t,enableZVertex:e.enableZ&&"move"===e.reshapeOptions.vertexOperation,enableZShape:e.enableZ&&"move"===e.reshapeOptions.shapeOperation,enableMoveGraphic:"move"===e.reshapeOptions.shapeOperation||"move-xy"===e.reshapeOptions.shapeOperation,enableMidpoints:"split"===e.reshapeOptions.edgeOperation,enableEdgeOffset:"offset"===e.reshapeOptions.edgeOperation,snappingManager:this._snappingManager,labelOptions:this.labelOptions,tooltipOptions:this.tooltipOptions});o.tools.add(a),i||this.updateGraphics.add(t);const n=[],p=new ot({activeComponent:a,tool:s,type:"update",onEnd:()=>{n.forEach((t=>t.remove())),n.length=0,this.view.tools?.remove(a),a.destroyed||a.destroy()},canUndo:()=>a.canUndo,undo:()=>{a.undo(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:s})},canRedo:()=>a.canRedo,redo:()=>{a.redo(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:s})},addToSelection:async t=>{this.updateGraphics.add(t),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[t],removed:[],type:"selection-change"},type:"update"});const i=await this._setupMove3DOperation(this.updateGraphics.toArray(),e,o,"transform",!0);ct(i)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(i,e))},removeFromSelection:t=>{this.updateGraphics.remove(t),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[t],type:"selection-change"},type:"update"}),p.complete()},toggleTool:async()=>{if(!1===e.toggleToolOnClick)return;const t=await this._setupGraphicTransform3DOperation(this.updateGraphics.toArray(),e,o,!0);ct(t)||(p.onEnd(),p.destroy(),this._setUpdateOperationHandle(t,e))}});return n.push(...this._getHandlesForComponent(p,e),o.on("immediate-click",(t=>this._getCommonUpdateOperationClickHandlers(p,t,e)),I.WIDGET),o.on("key-down",(t=>{this._getCommonUpdateOperationKeyDownHandlers(p,t),t.key===M.snappingToggle&&(this.snappingOptions.enabledToggled=!0,t.stopPropagation())}),I.WIDGET),o.on("key-up",(t=>{t.key===M.snappingToggle&&(this.snappingOptions.enabledToggled=!1,t.stopPropagation())}),I.WIDGET)),p}async _setupTransformOrReshape2DOperation(t,e,o,i){this.updateGraphics.addMany(t),await this._updateSpatialReference(t);const s="transform"===e?await this._getBox(t,o,i):await this._getReshape(t,o,i);if(ct(s))return s;const r=new ot({activeComponent:s,type:"update",onEnd:()=>{n.forEach((t=>t.remove())),a.forEach((t=>t.remove())),n=[],a=[],r.activeComponent&&!r.activeComponent.destroyed&&r.activeComponent.destroy(),this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray())},undo:()=>{at(r,this.updateGraphics.toArray()),r.refreshComponent(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:r.tool})},redo:()=>{nt(r,this.updateGraphics.toArray()),r.refreshComponent(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:r.tool})},addToSelection:async t=>{let e=r.activeComponent;if("reshape"===e.type){const e=[...this.updateGraphics,t];this.updateGraphics.removeAll();const s=await this._setupMove2DOperation(e,o,i);if(ct(s))return;r.onEnd(),r.destroy(),this._setUpdateOperationHandle(s,o)}else this.updateGraphics.add(t),e.graphics=this.updateGraphics.toArray(),e.refresh(),r.resetHistory();this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[t],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:async t=>{const e=this.updateGraphics.indexOf(t);r.history.undo.forEach((t=>t.updates.splice(e,1))),r.history.redo.forEach((t=>t.updates.splice(e,1))),this.updateGraphics.remove(t);const o=this.updateGraphics.toArray();if(0===o.length)r.complete();else{const t=o[0].geometry;1!==o.length||!p(t)||"point"!==t.type&&"multipoint"!==t.type?r.activeComponent.graphics=o:r.toggleTool()}this.emit("update",{graphics:o,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[t],type:"selection-change"},type:"update"})},toggleTool:async()=>{if(this.updateGraphics.length>1)return;const t=this.updateGraphics.getItemAt(0),e=t.geometry;if(p(e)&&("reshape"===r.tool&&("point"===e.type||"multipoint"===e.type)||"transform"===r.tool&&"extent"===e.type))return;let s=null;"transform"===r.tool?s=await this._getReshape([t],o,i):"reshape"===r.tool&&(s=await this._getBox([t],o,i)),ct(s)||(r.activeComponent.destroy(),r.activeComponent=s,r.activeComponent&&(n.forEach((t=>t.remove())),n=this._getHandlesForComponent(r,o)))}});let a=[i.on("immediate-click",(t=>this._getCommonUpdateOperationClickHandlers(r,t,o)),I.WIDGET),i.on("key-down",(t=>{if(this._getCommonUpdateOperationKeyDownHandlers(r,t),t.key!==M.snappingToggle||t.repeat||(this.snappingOptions.enabledToggled=!0,t.stopPropagation()),t.key===M.constraint&&!t.repeat&&r){const t=r.activeComponent;t&&"box"===t.type&&(t.preserveAspectRatio=!t.preserveAspectRatio)}}),I.WIDGET),i.on("key-up",(t=>{if(t.key===M.snappingToggle&&"reshape"===r?.activeComponent?.type&&(this.snappingOptions.enabledToggled=!1,t.stopPropagation()),t.key===M.constraint&&r){const t=r.activeComponent;t&&"box"===t.type&&(t.preserveAspectRatio=!t.preserveAspectRatio)}}),I.WIDGET)],n=this._getHandlesForComponent(r,o);return r}async _getGraphicMover(t,e,o){const{enableMoveAllGraphics:i}=e,s=await this._requireModule(import("../../chunks/GraphicMover.js").then((t=>t.a)));return ct(s)?s:new s.module.default({enableMoveAllGraphics:i,highlightsEnabled:!0,indicatorsEnabled:!1,graphics:t,view:o,callbacks:{onGraphicMoveStart:({dx:t,dy:e,graphic:o})=>{this._displayGrabbingCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:t,dy:e,mover:o,type:"move-start"},type:"update"})},onGraphicMove:({dx:t,dy:e,graphic:o})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:t,dy:e,mover:o,type:"move"},type:"update"}),onGraphicMoveStop:({dx:t,dy:e,graphic:o})=>{this._displayPointerCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:t,dy:e,mover:o,type:"move-stop"},type:"update"})},onGraphicPointerOver:()=>this._displayPointerCursor(),onGraphicPointerOut:()=>this._displayDefaultCursor()}})}async _getBox(t,e,o){const{enableRotation:i,enableScaling:s,preserveAspectRatio:r}=e,a=await this._requireModule(import("../../chunks/Box.js"));return ct(a)?a:new a.module.default({graphics:t,enableRotation:i,enableScaling:s,preserveAspectRatio:r,layer:this._internalGraphicsLayer,view:o,tooltipOptions:this.tooltipOptions,callbacks:{onMoveStart:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onMove:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onMoveStop:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onScaleStart:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onScale:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onScaleStop:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onRotateStart:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onRotate:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onRotateStop:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"})}})}async _getReshape(t,e,o){const i="split"===e.reshapeOptions?.edgeOperation,s="move"===e.reshapeOptions?.shapeOperation,r=await this._requireModule(import("../../chunks/Reshape.js"));return ct(r)?r:new r.module.default({enableMidpoints:i,enableMovement:s,graphic:t[0],layer:this._internalGraphicsLayer,snappingManager:this._snappingManager,tooltipOptions:this.tooltipOptions,view:o,callbacks:{onReshapeStart:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onReshape:t=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...t},type:"update"}),onReshapeStop:({mover:t,type:e})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t,type:e},type:"update"}),onMoveStart:({dx:t,dy:e,mover:o,type:i})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:t,dy:e,mover:o,type:i},type:"update"}),onMove:({dx:t,dy:e,mover:o,type:i})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:t,dy:e,mover:o,type:i},type:"update"}),onMoveStop:({dx:t,dy:e,mover:o,type:i})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:t,dy:e,mover:o,type:i},type:"update"}),onVertexAdd:({added:t,type:e,vertices:o})=>{const i=t.map((t=>k(t.geometry)));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:i,vertices:o,type:e},type:"update"})},onVertexRemove:({removed:t,type:e,vertices:o})=>{const i=t.map((t=>k(t.geometry)));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{removed:i,vertices:o,type:e},type:"update"})}}})}_getHandlesForComponent(t,e){const o=t.activeComponent;switch(o.type){case"graphic-mover":return[o.on("graphic-click",(({graphic:e,viewEvent:o})=>{o.native?.shiftKey&&(o.stopPropagation(),t.removeFromSelection(e))})),o.on("graphic-move-start",(e=>t.addToHistory(lt(e.allGraphics))))];case"box":return[o.on("graphic-click",(o=>this._onTransformOrReshape2DGraphicClick(t,e,o))),o.on("move-start",(e=>t.addToHistory(lt(e.graphics)))),o.on("rotate-start",(e=>t.addToHistory(lt(e.graphics)))),o.on("scale-start",(e=>t.addToHistory(lt(e.graphics))))];case"reshape":return[o.on("graphic-click",(o=>this._onTransformOrReshape2DGraphicClick(t,e,o))),o.on("move-start",(e=>t.addToHistory(lt([e.mover])))),o.on("reshape-start",(e=>t.addToHistory(lt([e.graphic])))),o.on("vertex-add",(e=>t.addToHistory(lt([e.oldGraphic])))),o.on("vertex-remove",(e=>t.addToHistory(lt([e.oldGraphic]))))];case"move-3d":return[o.on("graphic-move-start",(e=>{t.addToHistory(lt(e.allGraphics)),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:e.allGraphics.length>0?e.allGraphics[0]:null,type:"move-start"},type:"update"})})),o.on("graphic-move",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:t.dx,dy:t.dy,mover:t.allGraphics.length>0?t.allGraphics[0]:null,type:"move"},type:"update"})})),o.on("graphic-move-stop",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:t.allGraphics.length>0?t.allGraphics[0]:null,type:"move-stop"},type:"update"})})),o.on("immediate-click",(o=>{o.shiftKey?this._toggleSelection([o.graphic],t,e):t.toggleTool()}))];case"transform-3d":return[o.on("record-undo",(({record:e})=>{t.addToHistory({updates:[e]})})),o.on("graphic-translate-start",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,dx:t.dxScreen,dy:t.dyScreen,type:"move-start"},type:"update"})})),o.on("graphic-translate-stop",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,dx:t.dxScreen,dy:t.dyScreen,type:"move-stop"},type:"update"})})),o.on("graphic-rotate-start",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,angle:t.angle,type:"rotate-start"},type:"update"})})),o.on("graphic-rotate-stop",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,angle:t.angle,type:"rotate-stop"},type:"update"})})),o.on("graphic-scale-start",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,xScale:t.xScale,yScale:t.yScale,type:"scale-start"},type:"update"})})),o.on("graphic-scale-stop",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,xScale:t.xScale,yScale:t.yScale,type:"scale-stop"},type:"update"})})),o.on("graphic-translate",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,dx:t.dxScreen,dy:t.dyScreen,type:"move"},type:"update"})})),o.on("graphic-rotate",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,angle:t.angle,type:"rotate"},type:"update"})})),o.on("graphic-scale",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:t.graphic,xScale:t.xScale,yScale:t.yScale,type:"scale"},type:"update"})})),o.on("immediate-click",(o=>{o.shiftKey?this._toggleSelection([o.graphic],t,e):t.toggleTool()}))];case"reshape-3d":return[o.on("reshape",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:t,type:"update"})})),o.on("move",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:t,type:"update"})})),o.on("vertex-add",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:t,type:"update"})})),o.on("vertex-remove",(t=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:t,type:"update"})})),o.on("immediate-click",(o=>{o.shiftKey?this._toggleSelection([o.graphic],t,e):t.toggleTool()}))];default:return}}_onTransformOrReshape2DGraphicClick(t,e,o){const{graphic:i,viewEvent:s}=o;return s.native?.shiftKey&&i.layer===this.layer?(s.stopPropagation(),t.removeFromSelection(i)):e.toggleToolOnClick?(s.stopPropagation(),t.toggleTool()):void 0}_setUpdateOperationHandle(t,e){this._operationHandle=t;const o=this.view.map;this._disablePopup(e),t.on("complete",(()=>{if(t===this._operationHandle){const i=this.updateGraphics.toArray(),s=this._operationHandle.tool;this._operationHandle.destroy(),this._operationHandle=null,this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray()),this.updateGraphics.removeAll(),o&&o.remove(this._internalGraphicsLayer),this._restorePopup(e),this.emit("update",{graphics:i,state:"complete",aborted:t.cancelled,tool:s,toolEventInfo:null,type:"update"})}}))}async _getCommonUpdateOperationClickHandlers(t,e,o){const i=N(e),s=await e.async((()=>this._getFirstHit(i)));n(s)?t.complete():e.native.shiftKey&&this._toggleSelection([s.graphic],t,o)||this.updateGraphics.includes(s.graphic)?e.stopPropagation():t.complete()}_toggleSelection(t,e,o){const i=!!o.multipleSelectionEnabled;return t.some((t=>!(null==t||!i||t.layer!==this.layer||(this.updateGraphics.includes(t)?e.removeFromSelection(t):e.addToSelection(t),0))))}_getCommonUpdateOperationKeyDownHandlers(t,e){if(!t)return;const o=e.key;o===M.undo&&t.canUndo()?(e.stopPropagation(),t.undo()):o===M.redo&&t.canRedo()?(e.stopPropagation(),t.redo()):o===M.cancel?(e.stopPropagation(),t.cancel()):this.allowDeleteKey&&M.delete.includes(o)&&this._onDeleteKey(e)}_onDeleteKey(t){if(!this._operationHandle||"update"!==this._operationHandle.type)return;const e=this.activeComponent,o=this.updateGraphics.toArray();n(e)||"reshape-3d"===e.type||("reshape"!==e.type||1===o.length&&"point"===m(o[0].geometry,"type"))&&(t.stopPropagation(),this.delete())}_removeDefaultLayer(){this._internalGraphicsLayer&&(this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),this._internalGraphicsLayer=l(this._internalGraphicsLayer))}_isComponentGraphic(t){const{activeComponent:e}=this;return!(!t||n(e))&&(t.attributes&&t.attributes.esriSketchTool||"draw-2d"===e.type&&e.graphic===t||("box"===e.type||"reshape"===e.type)&&e.isUIGraphic(t))}_displayPointerCursor(){this.view&&this.view.container&&"pointer"!==this.view.cursor&&(this.view.cursor="pointer")}_displayGrabbingCursor(){this.view&&this.view.container&&"grabbing"!==this.view.cursor&&(this.view.cursor="grabbing")}_displayDefaultCursor(){this.view&&this.view.container&&null!==this.view.cursor&&(this.view.cursor=null)}_logError(t,e,o){a.getLogger(this.declaredClass).error(new i(t,e,o))}async _requireModule(t){const e=new AbortController;this._moduleLoaderAbortController=e;const o=await t;return this._moduleLoaderAbortController!==e||e.signal.aborted?{requireError:"aborted"}:{module:o}}_emitUndoEvent(t){this.emit("undo",{...t,type:"undo"})}_emitRedoEvent(t){this.emit("redo",{...t,type:"redo"})}_emitDeleteEvent(t){this.emit("delete",{...t,type:"delete"})}get test(){return{operationHandle:this._operationHandle,defaultUpdateOptions:st}}wait(){return f((()=>!this.updating))}_beginAsyncOperation(){this._numUpdating+=1,this.notifyChange("updating")}_endAsyncOperation(){this._numUpdating-=1,this.notifyChange("updating")}_disablePopupEnabled(t){return"3d"!==this.view?.type||this.updateOnGraphicClick||p(t)&&t.toggleToolOnClick}_disablePopup(t){if(!this._disablePopupEnabled(t))return;const e=this.view.popup;e&&n(this._originalAutoOpenEnabled)&&(this._originalAutoOpenEnabled=e.autoOpenEnabled,e.autoOpenEnabled=!1)}_restorePopup(t){if(!this._disablePopupEnabled(t))return;const e=this.view.popup;e&&p(this._originalAutoOpenEnabled)&&(e.autoOpenEnabled=this._originalAutoOpenEnabled,this._originalAutoOpenEnabled=null)}async _waitViewReady(){const t=this.view;t&&(h(this._viewReadyAbortController),this._viewReadyAbortController=new AbortController,await y(f((()=>t?.ready)),this._viewReadyAbortController.signal))}};function at(t,e){pt("undo",t.history.undo,t.history.redo,e)}function nt(t,e){pt("redo",t.history.redo,t.history.undo,e)}function pt(t,e,o,i){const s=e.pop().updates,r=[];i.forEach(((e,o)=>{const i=s[o];null!=i&&("geometry"in i&&p(i.geometry)&&(r.push({geometry:e.geometry}),e.geometry=i.geometry),"symbol"in i&&p(i.symbol)&&(r.push({symbol:e.symbol}),e.symbol=i.symbol),"undo"in i&&(r.push(i),i[t](e)))})),o.push({updates:r})}function lt(t){return{updates:t.map((t=>({geometry:t.geometry})))}}function ct(t){return"requireError"in t&&"aborted"===t.requireError}t([T()],rt.prototype,"updating",null),t([T()],rt.prototype,"_operationHandle",void 0),t([T({readOnly:!0})],rt.prototype,"activeTool",null),t([T()],rt.prototype,"activeFillSymbol",void 0),t([T()],rt.prototype,"activeLineSymbol",void 0),t([T()],rt.prototype,"activeVertexSymbol",void 0),t([T()],rt.prototype,"allowDeleteKey",void 0),t([T({readOnly:!0})],rt.prototype,"createGraphic",null),t([T()],rt.prototype,"defaultCreateOptions",null),t([T()],rt.prototype,"defaultUpdateOptions",null),t([T({type:D,nonNullable:!0})],rt.prototype,"labelOptions",void 0),t([T()],rt.prototype,"layer",void 0),t([T({types:e})],rt.prototype,"pointSymbol",void 0),t([T({types:e})],rt.prototype,"polygonSymbol",void 0),t([T({types:e})],rt.prototype,"polylineSymbol",void 0),t([T({type:L,nonNullable:!0})],rt.prototype,"snappingOptions",null),t([T()],rt.prototype,"_snappingManager",void 0),t([T({readOnly:!0})],rt.prototype,"state",null),t([T({type:H,nonNullable:!0})],rt.prototype,"tooltipOptions",void 0),t([T({readOnly:!0})],rt.prototype,"updateGraphics",void 0),t([T()],rt.prototype,"updateOnGraphicClick",void 0),t([T({types:e})],rt.prototype,"updatePointSymbol",void 0),t([T({types:e})],rt.prototype,"updatePolygonSymbol",void 0),t([T({types:e})],rt.prototype,"updatePolylineSymbol",void 0),t([T({types:e})],rt.prototype,"vertexSymbol",void 0),t([T({value:null})],rt.prototype,"view",null),rt=t([E("esri.widgets.Sketch.SketchViewModel")],rt);const ht=rt;export{z as S,Z as a,J as b,ht as default,X as f,Q as g,B as i};
