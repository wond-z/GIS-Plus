/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{i as t}from"../../chunks/maybe.js";import{watch as i}from"../../core/reactiveUtils.js";import{property as n}from"../../core/accessorSupport/decorators/property.js";import"../../core/lang.js";import"../../chunks/ensureType.js";import{subclass as o}from"../../core/accessorSupport/decorators/subclass.js";import{f as r,b as s,a as l,c as a}from"../../chunks/number.js";import u from"../../layers/support/CodedValueDomain.js";import{isNumericField as p,isStringField as d}from"../../layers/support/fieldUtils.js";import m from"../FeatureForm/InputField.js";import c from"./Grid/EditorColumn.js";import h from"../support/DatePicker.js";import g from"../support/TimePicker.js";import{r as f}from"../../chunks/widgetUtils.js";import"../../core/promiseUtils.js";import"../../chunks/object.js";import"../../core/Error.js";import"../../chunks/Logger.js";import"../../config.js";import"../../chunks/string.js";import"../../chunks/handleUtils.js";import"../../chunks/watch.js";import"../../chunks/ArrayPool.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/tracking.js";import"../../chunks/metadata.js";import"../../chunks/jsonMap.js";import"../../chunks/locale.js";import"../../chunks/enumeration.js";import"../../core/JSONSupport.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../layers/support/Domain.js";import"../../chunks/arcadeOnDemand.js";import"../../geometry.js";import"../../geometry/Extent.js";import"../../geometry/Geometry.js";import"../../chunks/reader.js";import"../../geometry/SpatialReference.js";import"../../chunks/writer.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/Ellipsoid.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../intl.js";import"../../chunks/messages.js";import"../../request.js";import"../../kernel.js";import"../../core/urlUtils.js";import"../../chunks/assets.js";import"../../core/HandleOwner.js";import"../../chunks/WatchUpdatingTracking.js";import"../../layers/support/InheritedDomain.js";import"../../layers/support/RangeDomain.js";import"./Grid/Column.js";import"../../core/Evented.js";import"./Grid/support/ButtonMenu.js";import"../Widget.js";import"../../chunks/domUtils.js";import"../../core/Promise.js";import"../../chunks/uuid.js";import"../../chunks/projector.js";import"../../chunks/jsxWidgetSupport.js";import"./Grid/support/ButtonMenuViewModel.js";import"./Grid/support/ButtonMenuItem.js";import"../../chunks/Popover.js";import"../../chunks/jsxFactory.js";import"../../chunks/uriUtils.js";import"../support/DatePickerViewModel.js";import"../support/DateTimeElementViewModel.js";import"../../chunks/accessibleHandler.js";import"../../chunks/messageBundle.js";import"../../chunks/datetime.js";import"../support/TimePickerViewModel.js";const y=a("short-date-short-time"),j=a("short-date"),v={useGrouping:!0,maximumFractionDigits:20};let b=class extends c{constructor(e){super(e),this._inputField=null,this.cellValueFormatFunction=({rowData:e,value:t})=>{if(this.formatFunction){const{config:e,field:i}=this;return this.formatFunction({config:e,field:i,value:f.sanitize(t)})}if(null===t)return"&nbsp;";const{config:i,field:n}=this,{item:{feature:o}}=e,a=this._getDomainForFeature(o);if(a)return this._getComputedDomain(t,a);if("date"===n.type){const e=this._getDateFormatOptions(),i="feature"===this.layer?.type&&this.layer.datesInUnknownTimezone?{timeZone:"UTC"}:null;return t?r(t,{...e,...i}):null}if(p(n)){const e=i?.format?s(i.format):v;return l(parseFloat(t),e)}return f.sanitize(t)},this.cellValueValidatorFunction=({oldValue:e,value:i})=>!(this._inputField&&!this._inputField.valid||this.required&&(!t(i)||""===i)||e===i),this.config=null,this.editingEnabled=!1,this.expressionInfos=null,this.field=null,this.formatFunction=null,this.headerRenderFunction=e=>{const{root:t}=e,{editable:i,editingEnabled:n,headerMenuEnabled:o,sortable:r}=this;if(this.removeCellContent(t),t.classList.add("esri-field-column__header-content"),n&&!i&&t.appendChild(this.createLockedElement()),r)this.headerSorterRenderFunction(e);else{const{header:e,path:i}=this,n=document.createElement("div");n.classList.add("esri-field-column__header-label"),n.innerHTML=e||i,t.appendChild(n)}o&&this.headerMenuRenderFunction(e)},this.inputRenderFunction=({root:e,column:t,rowData:i})=>{if(this.activeEditInfo?.updating)return;if(!this.editable)return;const n=this.getCellValue(t,i),o=this.createInputElement({root:e,column:t,rowData:i,value:n});if(this._set("activeEditInfo",{column:t,input:o,root:e,rowData:i,updating:!0,oldValue:n}),"date"===this.field.type)return void this._renderDateEditors(n,e,o);const r=this.createInputContainer();r.appendChild(o),this.removeCellContent(e),e.appendChild(r),o.focus(),o instanceof HTMLInputElement&&o.select(),this.grid?.notifyResize()},this.layer=null,this.parseInputValueFunction=({input:e})=>{const t=this._inputField,i=e.value,{required:n,type:o}=t;return n||""!==i?"number"===o||"date"===o?parseFloat(i):"text"===o?i.trim():i:null},this.template=null,this.updateRowItemFunction=({rowData:e,column:t,value:i})=>{e.item.feature.attributes[t.path]=i}}get alias(){return this.field?.alias}get defaultValue(){return this.field?.defaultValue}get description(){return this.template?.description??this.config?.description??this.field?.description??null}get editable(){const{config:e,editingEnabled:t,field:i,template:n}=this;return t?!1!==n?.editable&&!1!==e?.editable&&i?.editable:n?n.editable:!!e&&!0===e.editable&&i?.editable}get header(){return this.template?.label||this.config?.label||this.alias||this.path||null}get hidden(){const{config:e}=this;return!1===e?.visible||this._get("hidden")||!1}set hidden(e){this._set("hidden",e)}get loadingMessage(){return this.messages?.loading||"..."}get maxLength(){const{field:e,config:t,template:i}=this,n=e?.length,o=i?.input&&"maxLength"in i.input?i.input.maxLength:t?.maxLength;return!isNaN(o)&&o>=-1&&(-1===n||o<=n)?o:n}get minLength(){const{config:e,template:t,maxLength:i}=this,n=t?.input&&"minLength"in t.input?t.input.minLength:e?.minLength||null;return i&&n<=i?n:null}get name(){return this.field?.name}get nullable(){return this.field?.nullable??!1}get path(){return this.field?.name}get required(){const{config:e,field:t,template:i}=this,n=t?.nullable,o=e?.required,r=i?.required;return this.editable&&(!n||!0===o||!0===r)}get sortable(){return this.template?!1!==this.template?.sortable:!1!==this.config?.sortable}createInputElement({rowData:e,value:t}){const{item:i}=e;if(!i||!i.feature)return null;this._inputField=this._setUpInputField(i.feature,t);const{field:n,maxLength:o,minLength:r,required:s}=this,{domain:l}=this._inputField;let a=null;"coded-value"===l?.type?(a=this._createSelectElement(t,l.codedValues.map((({code:e,name:t})=>({value:e,name:t}))),this._inputField),a.onchange=()=>{a.onblur=null,d()}):(a=document.createElement("input"),a.type=p(n)?"number":"text",o>-1&&(a.maxLength=o),r>0&&(a.minLength=r)),a.classList.add("esri-field-column__cell-input"),a.value=t,a.required=s;let u=!1;a.onkeydown=e=>{u="Escape"===e.key},a.onblur=()=>{a.onblur=null,d()};const d=()=>{u?this.cancel():this.submit(),this._inputField=null};return a}createInputContainer(){const e=document.createElement("div");return e.classList.add("esri-field-column__cell__input-container"),e}createLockedElement(){const e=document.createElement("div");return e.classList.add("esri-icon-locked"),e}getCellValue({path:e},{item:t}){return t?.feature?.attributes?.[e]??null}_renderDateEditors(e,t,n){const{config:o,messagesCommon:r,template:s}=this,l=e?new Date(e):new Date(Date.now()),a=new h({dateInputEnabled:!0,value:l}),u=new g({value:l});n.value=l.getTime().toString();let p=!e;const d=()=>{p=!0;const e=this._getCombinedDateTime(a.value,u.value);n.value=e.getTime().toString()},m=()=>{p?this.submit():this.cancel()},c=()=>{n.value=null,this.submit()};i((()=>[a.value,u.value]),(()=>d()));const f=document.createElement("div"),y=document.createElement("div");a.container=f,u.container=y;const j=document.createElement("button");j.classList.add("esri-field-column__button","esri-icon-save"),j.onclick=()=>m(),j.title=r?.save;const v=document.createElement("button");v.classList.add("esri-field-column__button","esri-icon-trash"),v.onclick=()=>c(),v.title=r?.clear;const b=document.createElement("div");b.classList.add("esri-field-column__cell__date-input-wrapper"),b.appendChild(f),(s&&s.input&&"datetime-picker"===s.input.type&&!1!==s.input.includeTime||o&&!1!==o.includeTime)&&b.appendChild(y);const k=document.createElement("div");k.classList.add("esri-field-column__cell__date-input-container"),k.appendChild(b),k.appendChild(j),k.appendChild(v),a.when((()=>this.grid?.notifyResize())),u.when((()=>this.grid?.notifyResize())),this.removeCellContent(t),t.appendChild(k),this.grid?.notifyResize()}_createSelectElement(e,t,i){let n=!1;const o=t.map((t=>{t.value===e&&(n=!0);const i=document.createElement("option");return i.text=t.name,i.value=t.value,i}));if(null!=e&&""!==e&&!n){const t=document.createElement("option");t.text=e,t.value=e,o.unshift(t)}if(!i.required&&null==i.value){const e=document.createElement("option");e.value="",o.unshift(e)}const r=document.createElement("select");return o.forEach((e=>r.add(e))),r.value=e,r}_setUpInputField(e,t){const{config:i,field:n,layer:o}=this,r=new m({config:i,feature:e,initialFeature:e.clone(),field:n,layer:o,group:null,messages:null});return r.set("value",t),r}_isDomainCompatible(e){const{field:t}=this;if(e&&"coded-value"===e.type){const i=typeof e.codedValues[0].code;if("string"===i&&d(t)||"number"===i&&p(t))return!0}return!(!e||"range"!==e.type||!p(t))}_getDomainForFeature(e){const{config:t,layer:i,name:n,template:o}=this;if("wfs"===i.type||"geojson"===i.type||"csv"===i.type)return null;if(o?.domain&&this._isDomainCompatible(o.domain))return o.domain;const{typeIdField:r}=i,s=r===n,l=this.field.domain;if(s&&!l)return new u({name:"__internal-type-based-coded-value-domain__",codedValues:i.types.map((({id:e,name:t})=>({code:e,name:t})))});const a=r&&i.getFieldDomain(n,{feature:e})||l,p=t?.domain;return this._isDomainCompatible(p)?p:a}_getComputedDomain(e,t){if(!t)return null;if("range"===t.type)return e;if("coded-value"===t.type){const i=t.codedValues.filter((t=>t.hasOwnProperty("code")&&t.code===e));return i&&i.length?i[0].name:e}return null}_getCombinedDateTime(e,t){return new Date(e.getFullYear(),e.getMonth(),e.getDate(),t.getHours(),t.getMinutes(),t.getSeconds())}_getDateFormatOptions(){const{config:e,template:t}=this,i=t?.format?.dateFormat||e?.format?.dateFormat;return i?a(i):t&&t.input&&"includeTime"in t.input==0||!1===e?.includeTime?j:y}};e([n({readOnly:!0})],b.prototype,"alias",null),e([n()],b.prototype,"cellValueFormatFunction",void 0),e([n()],b.prototype,"cellValueValidatorFunction",void 0),e([n()],b.prototype,"config",void 0),e([n({readOnly:!0})],b.prototype,"defaultValue",null),e([n({readOnly:!0})],b.prototype,"description",null),e([n({readOnly:!0})],b.prototype,"editable",null),e([n()],b.prototype,"editingEnabled",void 0),e([n()],b.prototype,"expressionInfos",void 0),e([n()],b.prototype,"field",void 0),e([n()],b.prototype,"formatFunction",void 0),e([n({readOnly:!0})],b.prototype,"header",null),e([n()],b.prototype,"hidden",null),e([n()],b.prototype,"headerRenderFunction",void 0),e([n()],b.prototype,"inputRenderFunction",void 0),e([n()],b.prototype,"layer",void 0),e([n({readOnly:!0})],b.prototype,"loadingMessage",null),e([n()],b.prototype,"maxLength",null),e([n()],b.prototype,"minLength",null),e([n({readOnly:!0})],b.prototype,"name",null),e([n({readOnly:!0})],b.prototype,"nullable",null),e([n()],b.prototype,"parseInputValueFunction",void 0),e([n({readOnly:!0})],b.prototype,"path",null),e([n({readOnly:!0})],b.prototype,"required",null),e([n()],b.prototype,"sortable",null),e([n()],b.prototype,"template",void 0),e([n()],b.prototype,"updateRowItemFunction",void 0),b=e([o("esri.widgets.FeatureTable.FieldColumn")],b);const k=b;export{k as default};
