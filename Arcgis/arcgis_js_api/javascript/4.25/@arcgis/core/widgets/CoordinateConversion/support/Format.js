/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../geometry.js";import t from"../../../core/Accessor.js";import r from"../../../core/Error.js";import{i as s}from"../../../chunks/maybe.js";import{property as o}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/lang.js";import"../../../chunks/ensureType.js";import{subclass as i}from"../../../core/accessorSupport/decorators/subclass.js";import{fromUsng as n,fromUtm as a,fromMgrs as c,fromLatitudeLongitude as p,toUtm as l,toUsng as m,toMgrs as u,toLatitudeLongitude as h}from"../../../geometry/coordinateFormatter.js";import{isLoaded as d,project as f}from"../../../geometry/projection.js";import g,{e as j}from"../../../geometry/SpatialReference.js";import{project as v}from"../../../geometry/support/webMercatorUtils.js";import y from"../../../geometry/Point.js";import"../../../geometry/Extent.js";import"../../../chunks/string.js";import"../../../chunks/object.js";import"../../../geometry/Geometry.js";import"../../../core/JSONSupport.js";import"../../../chunks/get.js";import"../../../chunks/utils.js";import"../../../chunks/handleUtils.js";import"../../../chunks/Logger.js";import"../../../config.js";import"../../../core/Handles.js";import"../../../chunks/metadata.js";import"../../../chunks/ArrayPool.js";import"../../../chunks/tracking.js";import"../../../chunks/watch.js";import"../../../core/scheduling.js";import"../../../chunks/nextTick.js";import"../../../core/promiseUtils.js";import"../../../chunks/reader.js";import"../../../chunks/writer.js";import"../../../core/accessorSupport/decorators/cast.js";import"../../../chunks/Ellipsoid.js";import"../../../geometry/Multipoint.js";import"../../../chunks/zmUtils.js";import"../../../geometry/Polygon.js";import"../../../chunks/extentUtils.js";import"../../../geometry/Polyline.js";import"../../../chunks/typeUtils.js";import"../../../chunks/jsonMap.js";import"../../../geometry/support/jsonUtils.js";import"../../../chunks/pe.js";import"../../../chunks/assets.js";import"../../../request.js";import"../../../kernel.js";import"../../../core/urlUtils.js";import"../../../chunks/mathUtils.js";import"../../../chunks/vec3.js";import"../../../chunks/common.js";import"../../../chunks/unitUtils.js";import"../../../chunks/projectionEllipsoid.js";import"../../../chunks/SimpleObservable.js";import"../../../chunks/mat4.js";import"../../../chunks/aaBoundingRect.js";import"../../../chunks/geodesicConstants.js";import"../../../geometry/support/GeographicTransformation.js";import"../../../geometry/support/GeographicTransformationStep.js";import"../../../chunks/zscale.js";function k(e){return e>=500?6:e<500&&e>=50?7:e<50&&e>=5?8:9}function P(e){return"number"==typeof e&&isFinite(e)}function S(e){return e&&P(e.x)&&P(e.y)}function b(e,t){if(e.spatialReference.isGeographic&&t){const[r,s]=function(e,t){const r=k(t);return[e[0].toFixed(r),e[1].toFixed(r)]}([e.x,e.y],t);return`${r}, ${s}`}return`${e.x.toFixed(3)}, ${e.y.toFixed(3)}`}function w(e){return"dd"===e||"dms"===e||"ddm"===e||"mgrs"===e||"usng"===e||"utm"===e}let R=class extends t{constructor(e){super(e),this.conversionInfo=null,this.coordinateSegments=null,this.defaultPattern=null,this.name=null,this.viewModel=null}get currentPattern(){return this._get("currentPattern")||this._get("defaultPattern")}set currentPattern(e){this._set("currentPattern",e)}get label(){return this.name??""}set label(e){this._overrideIfSome("label",e)}get hasDisplayProperties(){return!(!this.defaultPattern||!this.coordinateSegments)}get spatialReference(){return"basemap"===this.name?this._viewSpatialReference:this.conversionInfo?.spatialReference??g.WGS84}set spatialReference(e){this._overrideIfSome("spatialReference",e)}get _viewSpatialReference(){return this.get("viewModel.view.spatialReference")||g.WGS84}get _additionalCharactersPattern(){const e=this.get("coordinateSegments");if(!e)return null;const t=e.map((e=>e.alias)),r=this.currentPattern.replace(new RegExp(`["nsew${t.join()}]`,"gi"),"").replace(/\ /g,"");return new RegExp(`[${r}]`,"g")}get test(){return{additionalCharactersPattern:this._additionalCharactersPattern}}convert(e){if(!S(e))return Promise.reject(new r("format:invalid-point","Could not convert invalid point.",{point:e}));const t=this.get("conversionInfo.convert");return t?Promise.resolve().then((()=>t(e))):this._project(e,this.spatialReference).then((e=>this._getCoordinate(e).then((t=>({location:e,coordinate:t})))))}getConversionStrategy(){const e=this._viewSpatialReference;return this.get("conversionInfo.convert")||this.get("viewModel.formatterAvailable")||"xy"===this.name&&(e.isWebMercator||e.isWGS84)||"basemap"===this.name?"client":"server"}getDisplayCoordinate(e){if(!e)return null;if(!this.coordinateSegments||!this.currentPattern)return e;let t=this.currentPattern;const r=this._getSegmentMatches(e,!1);for(let e=this.coordinateSegments.length-1;e>=0;e--){const s=this.coordinateSegments[e];t=t.replace(s.alias,r[e])}return t}parseUserInput(e){let t=this.defaultPattern.replace(this._additionalCharactersPattern,"");e=e.replace(this._additionalCharactersPattern,"");const r=this._getSegmentMatches(e,!0);for(let e=this.coordinateSegments.length-1;e>=0;e--){const s=this.coordinateSegments[e];t=t.replace(s.alias,r[e])}return t}_getSegmentMatches(e,t){const r=[];for(let s=0;s<this.coordinateSegments.length;s++){const o=this.coordinateSegments[s],i=e.match(o.searchPattern);if(!i){r.push("");continue}let n=i[0];if(e=e.replace(n,"").trim(),o.substitution){const e=t?o.substitution.input(n):o.substitution.output(n);e&&(n=`${e}`)}r.push(n)}return r}reverseConvert(e){const t=this.parseUserInput(e),s=this.get("conversionInfo.reverseConvert");let o;if(s)o=s(t);else if("xy"===this.name||"basemap"===this.name)o=function(e,t){const r=e.includes(",")?",":" ",[s,o,i]=e.split(r).map((e=>{const t=e.trim();return t?Number(t):null}));if(!P(s)||!P(o))return null;const n=new y({x:s,y:o,spatialReference:t||g.WGS84});return i&&(n.z=i,n.hasZ=!0),n}(t,this.spatialReference);else if(this.viewModel.formatterAvailable)switch(this.name){case"dd":case"ddm":case"dms":o=p(t,this.spatialReference);break;case"mgrs":{const e="automatic";o=c(t,this.spatialReference,e);break}case"utm":{const e="latitude-band-indicators";o=a(t,this.spatialReference,e);break}case"usng":o=n(t,this.spatialReference);break;default:o=null}return o?this._project(o,this._viewSpatialReference):Promise.reject(new r("format:invalid-input","Could not parse input into point.",{userInput:e}))}_getCoordinate(e){const t=this.get("viewModel.view.scale");if(!S(e))return Promise.reject(new r("format:invalid-point","Could not transform invalid point into coordinate.",{point:e}));if(this.get("viewModel.formatterAvailable")||"basemap"===this.name||"xy"===this.name)switch(this.name){case"dd":case"ddm":case"dms":{const r=k(t);return Promise.resolve(h(e,this.name,r))}case"mgrs":{const t=!1,r=5,s="automatic";return Promise.resolve(u(e,s,r,t))}case"usng":{const t=!1,r=5;return Promise.resolve(m(e,r,t))}case"utm":{const t=!0,r="latitude-band-indicators";return Promise.resolve(l(e,r,t))}default:return Promise.resolve(b(e,t))}return Promise.resolve(b(e,t))}_project(e,t){if(j(e.spatialReference,t)||!t)return Promise.resolve(e);if(this.viewModel?.formatterAvailable&&d())return Promise.resolve(f(e,t));if(!this.viewModel?.formatterAvailable){const r=v(e,t);if(s(r))return Promise.resolve(r)}return null}};e([o()],R.prototype,"conversionInfo",void 0),e([o()],R.prototype,"coordinateSegments",void 0),e([o()],R.prototype,"currentPattern",null),e([o()],R.prototype,"label",null),e([o()],R.prototype,"defaultPattern",void 0),e([o({readOnly:!0})],R.prototype,"hasDisplayProperties",null),e([o()],R.prototype,"name",void 0),e([o({type:g})],R.prototype,"spatialReference",null),e([o()],R.prototype,"viewModel",void 0),e([o({readOnly:!0})],R.prototype,"_viewSpatialReference",null),e([o({readOnly:!0})],R.prototype,"_additionalCharactersPattern",null),R=e([i("esri.widgets.CoordinateConversion.support.Format")],R);const _=R;export{w as a,_ as default,S as i};
