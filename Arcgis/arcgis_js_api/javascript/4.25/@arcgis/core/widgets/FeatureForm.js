/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"../intl.js";import{n as t}from"../chunks/compilerUtils.js";import{i as s,a as i}from"../chunks/maybe.js";import{watch as r}from"../core/reactiveUtils.js";import{property as o}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import"../chunks/ensureType.js";import{subclass as a}from"../core/accessorSupport/decorators/subclass.js";import{g as n,getFieldRange as l}from"../layers/support/fieldUtils.js";import p from"./Widget.js";import u from"./FeatureForm/FeatureFormViewModel.js";import{H as m,i as d}from"../chunks/Heading.js";import"../chunks/widgetUtils.js";import{m as c}from"../chunks/messageBundle.js";import{v as h}from"../chunks/vmEvent.js";import{t as j}from"../chunks/jsxFactory.js";import{D as y}from"../chunks/datetime.js";import{g as f}from"../chunks/locale.js";import"../chunks/number.js";import"../chunks/jsonMap.js";import"../chunks/object.js";import"../chunks/Logger.js";import"../config.js";import"../chunks/string.js";import"../chunks/messages.js";import"../core/Error.js";import"../core/promiseUtils.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../chunks/assets.js";import"../chunks/handleUtils.js";import"../chunks/watch.js";import"../chunks/ArrayPool.js";import"../core/scheduling.js";import"../chunks/nextTick.js";import"../chunks/get.js";import"../chunks/utils.js";import"../chunks/tracking.js";import"../chunks/metadata.js";import"../chunks/arcadeOnDemand.js";import"../geometry.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"../chunks/reader.js";import"../geometry/SpatialReference.js";import"../chunks/writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"../chunks/Ellipsoid.js";import"../geometry/Multipoint.js";import"../chunks/zmUtils.js";import"../geometry/Polygon.js";import"../chunks/extentUtils.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"../chunks/domUtils.js";import"../core/Evented.js";import"../core/Promise.js";import"../chunks/uuid.js";import"../chunks/projector.js";import"../chunks/jsxWidgetSupport.js";import"../Graphic.js";import"../PopupTemplate.js";import"../core/Clonable.js";import"../core/Collection.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../chunks/enumeration.js";import"../popup/support/FieldInfoFormat.js";import"../chunks/date.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../chunks/chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../Color.js";import"../chunks/colorUtils.js";import"../chunks/mathUtils.js";import"../chunks/vec3.js";import"../chunks/common.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"../chunks/utils2.js";import"../symbols/edges/Edges3D.js";import"../chunks/screenUtils.js";import"../chunks/materialUtils.js";import"../chunks/opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../chunks/lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"../chunks/utils3.js";import"../chunks/colors.js";import"../chunks/symbolLayerUtils3D.js";import"../chunks/aaBoundingBox.js";import"../chunks/aaBoundingRect.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../chunks/persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"../chunks/collectionUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"../chunks/Thumbnail.js";import"../chunks/calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../chunks/urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../core/HandleOwner.js";import"../chunks/WatchUpdatingTracking.js";import"../form/FormTemplate.js";import"../form/ExpressionInfo.js";import"../form/elements/GroupElement.js";import"../form/elements/Element.js";import"../form/support/elements.js";import"../form/elements/FieldElement.js";import"../form/elements/support/inputs.js";import"../form/elements/inputs/BarcodeScannerInput.js";import"../form/elements/inputs/TextInput.js";import"../form/elements/inputs/Input.js";import"../form/elements/inputs/ComboBoxInput.js";import"../form/elements/inputs/DateTimePickerInput.js";import"../form/elements/inputs/RadioButtonsInput.js";import"../form/elements/inputs/SwitchInput.js";import"../form/elements/inputs/TextAreaInput.js";import"../form/elements/inputs/TextBoxInput.js";import"../chunks/domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"../chunks/editableLayers.js";import"../chunks/arcgisLayerUrl.js";import"../chunks/Subtype.js";import"../arcade.js";import"../chunks/ImmutableArray.js";import"../layers/FeatureLayer.js";import"../renderers/ClassBreaksRenderer.js";import"../renderers/Renderer.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"../chunks/colorRamps.js";import"../rest/support/AlgorithmicColorRamp.js";import"../rest/support/ColorRamp.js";import"../rest/support/MultipartColorRamp.js";import"../renderers/mixins/VisualVariablesMixin.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/VisualVariable.js";import"../chunks/LegendOptions.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/visualVariables/SizeVariable.js";import"../renderers/visualVariables/support/SizeStop.js";import"../chunks/sizeVariableUtils.js";import"../chunks/visualVariableUtils.js";import"../chunks/lengthUtils.js";import"../chunks/unitUtils.js";import"../chunks/projectionEllipsoid.js";import"../renderers/support/ClassBreakInfo.js";import"../chunks/commonProperties2.js";import"../symbols/support/jsonUtils.js";import"../chunks/symbolConversion.js";import"../renderers/DictionaryRenderer.js";import"../chunks/DictionaryLoader.js";import"../chunks/LRUCache.js";import"../chunks/MemCache.js";import"../renderers/DotDensityRenderer.js";import"../renderers/support/AttributeColorInfo.js";import"../renderers/HeatmapRenderer.js";import"../renderers/support/HeatmapColorStop.js";import"../chunks/heatmapUtils.js";import"../chunks/vec4f64.js";import"../renderers/PieChartRenderer.js";import"../renderers/SimpleRenderer.js";import"../renderers/UniqueValueRenderer.js";import"../chunks/diffUtils.js";import"../renderers/support/UniqueValue.js";import"../renderers/support/UniqueValueClass.js";import"../renderers/support/UniqueValueGroup.js";import"../renderers/support/UniqueValueInfo.js";import"../chunks/styleUtils2.js";import"../renderers/support/jsonUtils.js";import"../chunks/MultiOriginJSONSupport.js";import"../core/sql.js";import"../layers/Layer.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"../chunks/Queue.js";import"../core/workers/RemoteClient.js";import"../chunks/editsZScale.js";import"../chunks/queryZScale.js";import"../chunks/zscale.js";import"../rest/support/FeatureSet.js";import"../layers/support/Field.js";import"../chunks/fieldType.js";import"../layers/mixins/APIKeyMixin.js";import"../chunks/ArcGISService.js";import"../layers/mixins/BlendLayer.js";import"../chunks/jsonUtils.js";import"../chunks/parser.js";import"../chunks/mat4f32.js";import"../chunks/mat4.js";import"../chunks/_commonjsHelpers.js";import"../layers/mixins/CustomParametersMixin.js";import"../chunks/EditBusLayer.js";import"../layers/mixins/FeatureEffectLayer.js";import"../layers/support/FeatureEffect.js";import"../layers/support/FeatureFilter.js";import"../TimeExtent.js";import"../chunks/timeUtils.js";import"../rest/support/Query.js";import"../chunks/DataLayerSource.js";import"../chunks/FullTextSearch.js";import"../rest/support/StatisticDefinition.js";import"../layers/mixins/FeatureLayerBase.js";import"../geometry/HeightModelInfo.js";import"../chunks/commonProperties.js";import"../support/timeUtils.js";import"../chunks/ElevationInfo.js";import"../chunks/unitConversionUtils.js";import"../rest/support/AttachmentQuery.js";import"../rest/support/RelationshipQuery.js";import"../layers/support/GeometryFieldsInfo.js";import"../layers/support/LayerFloorInfo.js";import"../layers/support/Relationship.js";import"../layers/mixins/FeatureReductionLayer.js";import"../layers/support/AggregateField.js";import"../layers/support/ExpressionInfo.js";import"../chunks/FeatureReduction.js";import"../layers/support/FeatureReductionBinning.js";import"../layers/support/LabelClass.js";import"../chunks/labelUtils.js";import"../chunks/defaults.js";import"../chunks/defaultsJSON.js";import"../layers/support/FeatureReductionCluster.js";import"../layers/support/FeatureReductionSelection.js";import"../chunks/clusterUtils.js";import"../chunks/OperationalLayer.js";import"../layers/mixins/OrderedLayer.js";import"../layers/mixins/PortalLayer.js";import"../chunks/asyncUtils.js";import"../portal/PortalItem.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../layers/mixins/PublishableLayer.js";import"../layers/support/PublishingInfo.js";import"../layers/mixins/RefreshableLayer.js";import"../layers/mixins/ScaleRangeLayer.js";import"../layers/mixins/TemporalLayer.js";import"../TimeInterval.js";import"../layers/support/TimeInfo.js";import"../layers/support/TimeReference.js";import"../layers/support/FeatureTemplate.js";import"../layers/support/FeatureType.js";import"../chunks/fieldProperties.js";import"../layers/support/FieldsIndex.js";import"../chunks/labelingInfo.js";import"../chunks/versionUtils.js";import"../chunks/styleUtils.js";import"../rest/support/TopFeaturesQuery.js";import"../rest/support/TopFilter.js";import"../support/popupUtils.js";import"./FeatureForm/InputField.js";import"./FeatureForm/InputFieldGroup.js";const b="esri-feature-form__input--disabled",_="esri-feature-form__description-text",g={datePattern:"D",timePattern:"tt"};function v(e){return e&&e.inputFields}let I=class extends p{constructor(e,t){super(e,t),this._activeDateFieldEdit=null,this._activeInputName=null,this._activeNumberFieldEdit=null,this._fieldFocusNeeded=!1,this._fieldToInitialIncompatibleDomainValue=new Map,this._switchFieldsWithInitialIncompatibleValue=new Set,this._userUpdatedInputFieldNames=new Set,this.disabled=!1,this.groupDisplay="all",this.headingLevel=2,this.messages=null,this.messagesTemplates=null,this.viewModel=new u,this._handleRadioInputChange=e=>{this._commitInputValue(e.target)},this._handleInputInput=e=>{this._commitInputValue(e.currentTarget,!0)},this._handleFormKeyDown=this._handleFormKeyDown.bind(this),this._handleInputBlur=this._handleInputBlur.bind(this),this._handleInputFocus=this._handleInputFocus.bind(this),this._handleNumberInputMouseDown=this._handleNumberInputMouseDown.bind(this),this._handleInputKeyDown=this._handleInputKeyDown.bind(this),this._handleOptionChange=this._handleOptionChange.bind(this),this._handleGroupClick=this._handleGroupClick.bind(this),this._handleSubmit=this._handleSubmit.bind(this),this._afterInputCreateOrUpdate=this._afterInputCreateOrUpdate.bind(this)}initialize(){this.addHandles([r((()=>this.feature),(()=>{const e=this._getFocusableInput("forward");this._activeInputName=e&&e.name,this._userUpdatedInputFieldNames.clear(),this._fieldToInitialIncompatibleDomainValue.clear(),this._switchFieldsWithInitialIncompatibleValue.clear(),this._fieldFocusNeeded=!0})),this.on("submit",(e=>{if(e.invalid.length>0){const[t]=e.invalid;e.invalid.forEach((e=>this._userUpdatedInputFieldNames.add(e))),this._activeInputName=t,this._fieldFocusNeeded=!0,this.scheduleRender()}}))])}loadDependencies(){return Promise.all([import("../chunks/calcite-combobox.js"),import("../chunks/calcite-combobox-item.js"),import("../chunks/calcite-combobox-item-group.js"),import("../chunks/calcite-input-message.js"),import("../chunks/calcite-progress.js"),import("../chunks/calcite-switch.js")])}destroy(){this._userUpdatedInputFieldNames.clear(),this._userUpdatedInputFieldNames=null}get feature(){return this.viewModel.feature}set feature(e){this.viewModel.feature=e}get formTemplate(){return this.viewModel.formTemplate}set formTemplate(e){this.viewModel.formTemplate=e}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get layer(){return this.viewModel.layer}set layer(e){this.viewModel.layer=e}get spatialReference(){return this.viewModel.spatialReference}set spatialReference(e){this.viewModel.spatialReference=e}get strict(){return this.viewModel.strict}set strict(e){this.viewModel.strict=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}getValues(){return this.viewModel.getValues()}submit(){return this.viewModel.submit()}render(){const{state:e}=this.viewModel;return j("div",{class:this.classes("esri-feature-form","esri-widget","esri-widget--panel")},"ready"===e?this.renderForm():null)}renderForm(){const{formTemplate:e}=this,t=s(e)&&e.title&&j(m,{key:"title",level:this.headingLevel},e.title),i=s(e)&&e.description&&j("p",{class:_,key:"description"},e.description),r=t||i?j("div",{class:"esri-feature-form__form-header"},t,i):null;return j("form",{class:"esri-feature-form__form",novalidate:!0,onsubmit:this._handleSubmit,onkeydown:this._handleFormKeyDown},r,this.renderFields())}renderFields(){const{viewModel:{inputFields:e}}=this;return e.filter((e=>e.visible)).map(((e,t)=>v(e)?this.renderGroup(e,t):this.renderLabeledField(e)))}renderGroup(e,t){const{formTemplate:i,disabled:r}=this,{description:o,inputFields:a,label:n,state:l}=e,p=a.filter((e=>e.visible)),u=this.viewModel.findField(this._activeInputName),c=!(!u||u.group!==e),h=`${this.id}_group_${t}`,y=`${this.id}_group-label_${t}`,f=`${this.id}_group-description_${t}`,g=o?j("p",{class:this.classes("esri-feature-form__group-description",_),id:f},o):null,v="sequential"===this.groupDisplay,I=v?c:"expanded"===l,F=I?"esri-icon-up":"esri-icon-down";return j("fieldset",{"aria-expanded":I.toString(),"aria-labelledby":y,"aria-describedby":o?f:"",class:this.classes("esri-feature-form__group",v?"esri-feature-form__group--sequential":null,I?null:"esri-feature-form__group--collapsed",c?"esri-feature-form__group--active":null,r?b:null),disabled:r,"data-group":e,id:h,key:t,onclick:this._handleGroupClick},j("button",{role:v?"presentation":void 0,class:"esri-feature-form__group-header",type:"button",tabIndex:v?-1:0},j("div",{class:"esri-feature-form__group-title"},j(m,{class:"esri-feature-form__group-label",id:y,level:s(i)&&i.title?d(this.headingLevel):this.headingLevel},n),g),v?null:j("span",{class:this.classes(F,"esri-feature-form__group-toggle-icon")})),p.map((e=>this.renderLabeledField(e))))}_getFocusableInput(e,t){const s=this.viewModel.allInputFields,i="forward"===e?s:s.slice().reverse();let r;if(t)if(v(t))r=i.indexOf(t.inputFields[0]);else{let s;if(this._isInputFieldInGroup(t)&&"collapsed"===t.group.state){const{inputFields:i}=t.group;s="forward"===e?i[i.length-1]:i[0]}else s=t;r=i.indexOf(s)+1}else r=0;for(let e=r;e<i.length;e++){const t=i[e];if(t.visible)return t}return null}renderLabeledField(e){const{feature:t,label:s,layer:i,type:r}=e;return j("label",{key:`${i.id}-${t.uid}-${e.name}`,class:"esri-feature-form__label"},[s,"unsupported"!==r?this.renderInputField(e):this.renderUnsupportedField(e),this.renderAuxiliaryText(e)])}renderInputField(e){const{domain:t,name:i,type:r,updating:o,value:a}=e,n=this.getCommonInputProps(e);if("coded-value"===t?.type){if(this._inputFieldHasInputType(e,"switch")){const{fieldElement:t}=e;if(!(this._switchFieldsWithInitialIncompatibleValue.has(i)||null==a||t.input.onValue!==a&&t.input.offValue!==a))return this.renderSwitchInputField(e,n);this._switchFieldsWithInitialIncompatibleValue.add(i)}return"radio-buttons"===e.inputType?this.renderRadioButtonsInputField(e,t.codedValues.map((({code:e,name:t})=>({value:e,name:t}))),n):this.renderSelectInputField(e,this._getFieldValueOptions(i,t),n)}if("datetime-picker"===e.inputType||"date"===r)return this.renderDateInputField(e,n);const l="number"===r?j("input",{type:"number",...n,value:s(this._activeNumberFieldEdit)&&this._activeNumberFieldEdit.fieldName===e.name?this._activeNumberFieldEdit.value:`${n.value}`}):"text-area"===e.inputType?j("textarea",{...n}):j("input",{type:"text",...n});return o?j("div",{class:"esri-feature-form__input-wrapper"},l,j("div",{class:"esri-feature-form__input-loader"},j("calcite-progress",{type:"indeterminate"}))):l}_parseDateTime(e,t,s){if(s){let i=y.fromJSDate(this._parseDate(e,s));const r=y.fromMillis(t.value??Date.now());return i="date"===s?i.set({hour:r.hour,minute:r.minute,second:r.second}):i.set({day:r.day,month:r.month,year:r.year}),i.isValid?i.toMillis():null}const i=y.fromJSDate(this._parseDate(e));return i.isValid?i.toMillis():null}renderDateInputField(e,t){const{value:s,includeTime:i}=e,{date:r,time:o}=this._formatDate(0),a=`${this.id}-${t.key}`,n=`${a}-date`,l=`${a}-time`,{_activeDateFieldEdit:p}=this;let{date:u,time:m}=this._formatDate(s);return p?.fieldName===e.name&&(u=p.date.input?.value??u,m=p.time.input?.value??m),j("div",{key:`${t.key}-date`,class:"esri-feature-form__date-input-container"},j("div",{class:this.classes("esri-feature-form__date-input-part",i?null:"esri-feature-form__date-input-part--lone")},j("input",{"aria-label":e.label,"aria-describedby":n,type:"text",...t,"data-date-part":"date",class:this.classes(t.class,"esri-feature-form__input--date"),value:u}),j("div",{class:"esri-feature-form__date-format-hint",id:n},r)),i?j("div",{class:"esri-feature-form__date-input-part",key:"time-input"},j("input",{"aria-describedby":l,"aria-label":e.label,type:"text",...t,"data-date-part":"time",class:this.classes(t.class,"esri-feature-form__input--time"),value:m}),j("div",{class:"esri-feature-form__date-format-hint",id:l},o)):null)}renderUnsupportedField(e){const t=this.getCommonInputProps(e);return j("input",{afterCreate:t.afterCreate,afterUpdate:t.afterUpdate,disabled:t.disabled,class:this.classes("esri-input","esri-feature-form__input",b),onfocus:t.onfocus,readOnly:!0,tabIndex:t.tabIndex,type:"text",value:t.value,"data-field-name":t["data-field-name"]})}renderSelectInputField(e,t,s){const{value:r}=e,{messages:o,messagesTemplates:a}=this,n=t.map((e=>e.map((e=>j("calcite-combobox-item",{value:`${e.value}`,"text-label":e.name,key:`#${e.value}`,selected:r===e.value}))))),[l,p]=n;this._registerIncompatibleValue(r,t.flat(),e,(e=>{p.unshift(j("calcite-combobox-item",{value:`${e}`,"text-label":`${e}`,key:"incompatible-option",readOnly:!0}))}));const u=p.length>0?[j("calcite-combobox-item-group",{key:"recommended",label:o.recommended},l),j("calcite-combobox-item-group",{key:"other",label:a.other},p)]:l,m=i(e.fieldElement)||this._inputFieldHasInputType(e,"combo-box")&&e.fieldElement.input.showNoValueOption;if(!e.required&&m){const t="",s=this._inputFieldHasInputType(e,"combo-box")&&e.fieldElement.input.noValueOptionLabel||this.messages.empty;u.unshift(j("calcite-combobox-item",{value:t,"text-label":this.messages.empty,key:"empty-option"},s))}return j("calcite-combobox",{...s,"selection-mode":"single","overlay-positioning":"fixed",disabled:s.disabled||s.readOnly,allowCustomValues:!1,onCalciteComboboxChange:e=>this._handleOptionChange(e.target)},u)}_registerIncompatibleValue(e,t,s,i){const r=this._fieldToInitialIncompatibleDomainValue,o=r.has(s.name);(o||null!=e&&""!==e&&!t.some((t=>t.value===e))||o)&&(o||r.set(s.name,e),i?.(r.get(s.name)))}renderRadioButtonsInputField(e,t,s){const{value:r}=e,o=t.map((t=>this.renderRadioButton({key:t.name,label:t.name,name:e.name,value:t.value,selected:t.value===r,props:s})));this._registerIncompatibleValue(r,t,e);const a=i(e.fieldElement)||this._inputFieldHasInputType(e,"radio-buttons")&&e.fieldElement.input.showNoValueOption;if(!e.required&&a){const t="",i=this._inputFieldHasInputType(e,"radio-buttons")&&e.fieldElement.input.noValueOptionLabel||this.messages.empty,a=r===t||null===r;o.unshift(this.renderRadioButton({key:"empty-option",label:i,name:e.name,value:t,selected:a,props:s}))}return j("div",{key:`${s.key}-radio`,class:"esri-feature-form__input--radio-group"},o)}renderSwitchInputField(e,t){const{value:s}=e,i=!!this._inputFieldHasInputType(e,"switch")&&s===e.fieldElement.input.onValue;return j("calcite-switch",{...t,class:"esri-feature-form__input--switch",onCalciteSwitchChange:e=>{this._parseValue(e.currentTarget)},checked:i,disabled:t.disabled||t.readOnly})}renderRadioButton({key:e,name:t,value:s,selected:i,label:r,props:o}){return j("label",{key:e,class:"esri-feature-form__input--radio-label"},j("input",{...o,class:"esri-feature-form__input--radio",name:t,type:"radio",value:s,checked:i,onchange:this._handleRadioInputChange}),r)}renderAuxiliaryText(e){const t=this._userUpdatedInputFieldNames.has(e.name)&&!e.valid?e.errorMessage:s(this.viewModel.contingencyConstraintViolations.get(e.name))?this.messages.validationErrors.valuesIncompatible:s(e.valueExpressionExecutor)&&e.valueExpressionExecutor.stale?this.messages.valueExpressionError:null;return s(t)?j("calcite-input-message",{status:"invalid",icon:!0,active:!0},t):e.description?j("div",{key:"description",class:_},e.description):void 0}getCommonInputProps(e){const{disabled:t,groupDisplay:i}=this,{editable:r,group:o,hint:a,maxLength:n,minLength:l,name:p,required:u,type:m,valid:d,value:c}=e,h=this._userUpdatedInputFieldNames.has(p),j=!r,y="all"===i&&s(o)&&"collapsed"===o.state;return{afterCreate:this._afterInputCreateOrUpdate,afterUpdate:this._afterInputCreateOrUpdate,"aria-invalid":d?"false":"true",class:this.classes("esri-input","esri-feature-form__input",t||j?b:null,h&&!d?"esri-feature-form__input--invalid":null),key:p,label:p,minlength:l>-1?`${l}`:"",maxlength:n>-1?`${n}`:"",...this._getNumberFieldConstraints(e),disabled:t,readOnly:j,value:null==c?"":`${c}`,"data-field-name":p,onfocus:this._handleInputFocus,oninput:this._handleInputInput,onblur:this._handleInputBlur,onkeydown:this._handleInputKeyDown,onmousedown:"number"===m?this._handleNumberInputMouseDown:null,placeholder:"number"===m||"text"===m?a:"",required:u,tabIndex:y?-1:0}}_isInputFieldInGroup(e){return!v(e)&&s(e.group)}_handleNumberInputMouseDown({target:e}){e.focus(),this.scheduleRender()}_getFieldValueOptions(e,t){const s=t.codedValues.map((({code:e,name:t})=>({value:e,name:t}))),i=this.viewModel.fieldsWithContingentValues.has(e)?this._getContingentValueOptions(e):[];if(i.length>0){const e=new Set(i.map((e=>e.value)));return[i,s.filter((t=>!e.has(t.value)))]}return[s,[]]}_getContingentValueOptions(e){const t={};for(const s of this.viewModel.allInputFields){const{name:r,value:o}=s;!i(o)&&r!==e&&this.viewModel.fieldsWithContingentValues.has(r)&&(t[r]=o)}const s=this.viewModel.joinedContingentValues.slice(),r=new Map;for(const o of s){const s=o.values[e];if(i(s)||"code"!==s.objectType&&"null"!==s.objectType)continue;const{code:a,name:n}="null"===s.objectType?{code:"",name:this.messages.empty}:s.codedValue;r.has(a)||Object.entries(t).every((([e,t])=>!o.values.hasOwnProperty(e)||this._valueIsValidContingentValue(t,o.values[e])))&&r.set(a,{name:n,value:a})}return[...r.values()]}_getInputFieldFromInput(e){return this.viewModel.findField(e.getAttribute("data-field-name"))}_getNumberFieldConstraints(e){const t=n(e.domain)||l(e.field);return t&&t.max!==Number.MAX_VALUE&&t.min!==Number.MIN_VALUE?t:{min:null,max:null}}_afterInputCreateOrUpdate(e){const{viewModel:t}=this,s=this._getInputFieldFromInput(e),i=t.findField(this._activeInputName),r=this._fieldToInitialIncompatibleDomainValue.get(s.name)===s.value;this._fieldFocusNeeded&&i===s&&("radio-buttons"!==s.inputType||r||e.checked)&&(this._fieldFocusNeeded=!1,this._isInputFieldInGroup(s)&&(s.group.state="expanded"),e.focus())}_handleInputFocus(e){const t=e.target,s=this._getInputFieldFromInput(t);this._activeInputName=s.name,"date"===s.type?this._syncDateFieldEdits(t):this._isNumberInputField(s)&&this._setUpNumberFieldEdit(t)}_isNumberInputField({domain:e,inputType:t="text-box",type:s}){return"number"===s&&"text-box"===t&&(!e||"coded-value"!==e.type)}_handleInputBlur(e){const t=e.target,i=this._getInputFieldFromInput(t);if("date"===i.type){const s=e.relatedTarget,r=s&&this._getInputFieldFromInput(s);if(r&&"date"===i.type&&"date"===r.type&&i.field===r.field){if(""!==t.value&&""===s.value){const r=s.getAttribute("data-date-part");s.value=this._formatDate(i.value??Date.now())[r],this._parseDate(t.value,t.getAttribute("data-date-part"))&&this._commitInputValue(e.target,!0,!1)}return}}"number"===i.type&&s(this._activeNumberFieldEdit)&&(this._activeNumberFieldEdit.input.value=`${i.value}`,this._activeNumberFieldEdit=null),this._commitInputValue(t),this.scheduleRender()}_commitInputValue(e,t=!1,i=!0){const r=this._getInputFieldFromInput(e);if(this._activeDateFieldEdit){const{date:s,time:o}=this._activeDateFieldEdit,a=this._parseDateTime(e.value,r,s.active?"date":"time"),n=null!==this.viewModel.getValue(r.name),l=s.input&&(o.input||!r.includeTime),p=null===a;if(t){if(p)return;(l||!i||n)&&this._updateDateFieldValue(r,a)}else{if(""===s.input?.value||""===o.input?.value)this._updateDateFieldValue(r,null);else if(l){const e=`${s.input.value} ${o.input?.value??""}`,t=this._parseDateTime(e,r);null===t&&n||this._updateDateFieldValue(r,t)}this._activeDateFieldEdit=null}}else s(this._activeNumberFieldEdit)&&this._isNumberInputField(r)&&(this._activeNumberFieldEdit.value=e.value),this._updateFieldValue(e)}_handleInputKeyDown(e){const{key:t,altKey:s,ctrlKey:i,metaKey:r}=e,o=this._getInputFieldFromInput(e.target);if("Enter"===t)this._isInputFieldInGroup(o)&&"collapsed"===o.group.state&&(o.group.state="expanded");else{const{type:a}=o.field,n="single"===a||"double"===a,l=!s&&!i&&!r;if(("integer"===a||"small-integer"===a||n)&&l&&1===t.length){const s=Number(t),i=["-","+"],r=["e","."],o=n?[...i,...r]:i;isNaN(s)&&!o.includes(t)&&e.preventDefault()}}}_setUpNumberFieldEdit(e){const t=this._getInputFieldFromInput(e);this._activeNumberFieldEdit={fieldName:t.name,input:e,value:e.value}}_syncDateFieldEdits(e){const t=this._getInputFieldFromInput(e);if("date"!==t.type)return;const s=e.getAttribute("data-date-part"),i="date"===s?{value:e.value,input:e,active:!0}:{...this._activeDateFieldEdit?.date,active:!1},r="time"===s?{value:e.value,input:e,active:!0}:{...this._activeDateFieldEdit?.time,active:!1};this._activeDateFieldEdit={fieldName:t.name,date:i,time:r}}_updateFieldValue(e){const t=e.getAttribute("data-field-name");if(this.viewModel.setValue(t,this._parseValue(e)),this._userUpdatedInputFieldNames.add(t),this.viewModel.fieldsWithContingentValues.has(t)){const e=Object.fromEntries(Object.entries(this.getValues()).filter((([e,t])=>s(t))));this.viewModel.validateContingencyConstraints(e)}}_updateDateFieldValue(e,t){this.viewModel.setValue(e.name,t),this._userUpdatedInputFieldNames.add(e.name)}_parseValue(e){const t=this._getInputFieldFromInput(e),s=e.value;if(this._inputFieldHasInputType(t,"switch")&&"CALCITE-COMBOBOX"!==e.tagName)return e.checked?t.fieldElement.input.onValue:t.fieldElement.input.offValue;if("radio-buttons"===t.inputType&&"radio"===e.type&&!e.checked)return t.value;const{type:i}=t;if("number"===i)return s?parseFloat(s):null;if("date"===i){if(!s)return null;const i=Number(s);if(!isNaN(i))return i;const r=e.getAttribute("data-date-part"),o=this._parseDate(s,r);if(!o)return null;let a=y.fromJSDate(o);const n=t.domain,l=y.now();let p=l;if(n&&"range"===n.type){const e=y.fromMillis(n.maxValue);l<e&&(p=e)}const u=this.viewModel.getValue(t.name),m=null!=u?y.fromMillis(u):p;return a="date"===r?a.set({hour:m.hour,minute:m.minute,second:m.second}):a.set({day:m.day,month:m.month,year:m.year}),a.toMillis()}return s}_handleOptionChange(e){this._commitInputValue(e),this.scheduleRender()}_handleGroupClick(e){const t=e.currentTarget["data-group"],s="expanded"===t.state,i="sequential"===this.groupDisplay,r=".esri-feature-form__group-header";if(!s||e.target.closest(r)){if(this._activeInputName=this._getFocusableInput("forward",t)?.name,i){const i=e.target.closest(r);if(s&&!i)return;this.viewModel.inputFields.forEach((e=>{v(e)&&e!==t&&(e.state="collapsed")}))}t.state=s?"collapsed":"expanded",this._fieldFocusNeeded=i,this.scheduleRender()}}_handleSubmit(e){e.preventDefault()}_handleFormKeyDown(e){"Enter"===e.key&&this.viewModel.submit()}_formatDate(e){if(null==e)return{date:"",time:""};const t=y.fromMillis(e,{locale:f(),numberingSystem:"latn"});return{date:t.toLocaleString({year:"numeric",month:"2-digit",day:"2-digit"}),time:t.toFormat(g.timePattern)}}_parseDate(e,t){if(null==e||""===e)return null;const{timePattern:s,datePattern:i}=g,r=t?"date"===t?i:s:`${i} ${s}`,o=y.fromFormat(e,r,{locale:f(),numberingSystem:"latn"});return o.isValid?o.toJSDate():null}_inputFieldHasInputType(e,t){return s(e.fieldElement)&&e.fieldElement.input?.type===t}_valueIsValidContingentValue(e,s){switch(s.objectType){case"any":return!0;case"null":return null==e;case"code":return e===s.codedValue?.code;case"range":return e>=s.minValue&&e<=s.maxValue;default:return t(s.objectType),!1}}};e([o()],I.prototype,"disabled",void 0),e([o()],I.prototype,"feature",null),e([o()],I.prototype,"formTemplate",null),e([o()],I.prototype,"groupDisplay",void 0),e([o()],I.prototype,"headingLevel",void 0),e([o()],I.prototype,"label",null),e([o()],I.prototype,"layer",null),e([o(),c("esri/widgets/FeatureForm/t9n/FeatureForm")],I.prototype,"messages",void 0),e([o(),c("esri/widgets/FeatureTemplates/t9n/FeatureTemplates")],I.prototype,"messagesTemplates",void 0),e([o()],I.prototype,"spatialReference",null),e([o()],I.prototype,"strict",null),e([o()],I.prototype,"view",null),e([o(),h(["value-change","submit"])],I.prototype,"viewModel",void 0),I=e([a("esri.widgets.FeatureForm")],I);const F=I;export{F as default};
