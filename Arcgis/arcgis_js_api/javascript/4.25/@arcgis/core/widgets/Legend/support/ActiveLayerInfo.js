/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import t from"../../../Color.js";import{addTokenParameter as s}from"../../../kernel.js";import r from"../../../request.js";import{isSymbol3D as i}from"../../../symbols.js";import l,{O as n}from"../../../core/Accessor.js";import o from"../../../core/Collection.js";import a from"../../../core/Handles.js";import{J as u}from"../../../chunks/jsonMap.js";import{L as c}from"../../../chunks/Logger.js";import{u as p,i as m}from"../../../chunks/maybe.js";import{eachAlways as d,debounce as h}from"../../../core/promiseUtils.js";import{on as y,watch as f,whenOnce as b,initial as g}from"../../../core/reactiveUtils.js";import{p as S}from"../../../chunks/screenUtils.js";import{addQueryParameters as j}from"../../../core/urlUtils.js";import{property as L}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/lang.js";import"../../../chunks/ensureType.js";import{subclass as _}from"../../../core/accessorSupport/decorators/subclass.js";import{E as v}from"../../../chunks/EffectView.js";import{e as w}from"../../../chunks/jsonUtils.js";import{E as C}from"../../../chunks/ExportImageParameters.js";import{isDateField as E}from"../../../layers/support/fieldUtils.js";import{fromJSON as I}from"../../../renderers/support/jsonUtils.js";import{i as k}from"../../../chunks/rendererConversion.js";import V,{S as R}from"../../../renderers/visualVariables/SizeVariable.js";import{applyCIMSymbolColor as F}from"../../../symbols/support/cimSymbolUtils.js";import{renderColorRampPreviewHTML as T,renderDotDensityPreviewHTML as z,h as x,renderPieChartPreviewHTML as M,S as D,renderPreviewHTML as U}from"../../../symbols/support/symbolUtils.js";import{e as P,i as O,j as A,k as B}from"../../../chunks/utils6.js";import{e as H,f as q,S as N,h as $,i as W,j as G,k as J,l as Q,m as X,R as K,n as Y}from"../../../chunks/utils15.js";import{getSymbolLayerFill as Z}from"../../../chunks/previewSymbol3D.js";import{r as ee,n as te,p as se}from"../../../chunks/numberUtils.js";import"../../../chunks/widgetUtils.js";import{i as re}from"../../../chunks/themeUtils.js";import ie from"../../../symbols/SimpleMarkerSymbol.js";import le from"../../../symbols/SimpleLineSymbol.js";import{formatNumberLabel as ne}from"../../smartMapping/support/utils.js";import oe from"../../../symbols/SimpleFillSymbol.js";import"../../../chunks/colorUtils.js";import"../../../chunks/mathUtils.js";import"../../../chunks/vec3.js";import"../../../chunks/common.js";import"../../../chunks/object.js";import"../../../config.js";import"../../../chunks/string.js";import"../../../core/Error.js";import"../../../symbols/CIMSymbol.js";import"../../../chunks/enumeration.js";import"../../../chunks/reader.js";import"../../../chunks/writer.js";import"../../../symbols/Symbol.js";import"../../../core/JSONSupport.js";import"../../../chunks/get.js";import"../../../chunks/utils.js";import"../../../chunks/handleUtils.js";import"../../../chunks/metadata.js";import"../../../chunks/ArrayPool.js";import"../../../chunks/tracking.js";import"../../../chunks/watch.js";import"../../../core/scheduling.js";import"../../../chunks/nextTick.js";import"../../../chunks/arcadeOnDemand.js";import"../../../geometry.js";import"../../../geometry/Extent.js";import"../../../geometry/Geometry.js";import"../../../geometry/SpatialReference.js";import"../../../geometry/Point.js";import"../../../core/accessorSupport/decorators/cast.js";import"../../../geometry/support/webMercatorUtils.js";import"../../../chunks/Ellipsoid.js";import"../../../geometry/Multipoint.js";import"../../../chunks/zmUtils.js";import"../../../geometry/Polygon.js";import"../../../chunks/extentUtils.js";import"../../../geometry/Polyline.js";import"../../../chunks/typeUtils.js";import"../../../geometry/support/jsonUtils.js";import"../../../symbols/ExtrudeSymbol3DLayer.js";import"../../../symbols/Symbol3DLayer.js";import"../../../chunks/utils2.js";import"../../../symbols/edges/Edges3D.js";import"../../../chunks/materialUtils.js";import"../../../chunks/opacityUtils.js";import"../../../symbols/edges/SketchEdges3D.js";import"../../../symbols/edges/SolidEdges3D.js";import"../../../chunks/Symbol3DMaterial.js";import"../../../symbols/FillSymbol.js";import"../../../symbols/LineSymbol.js";import"../../../symbols/LineSymbolMarker.js";import"../../../chunks/lineMarkers.js";import"../../../symbols/FillSymbol3DLayer.js";import"../../../symbols/patterns/LineStylePattern3D.js";import"../../../symbols/patterns/StylePattern3D.js";import"../../../chunks/utils3.js";import"../../../chunks/colors.js";import"../../../chunks/symbolLayerUtils3D.js";import"../../../chunks/aaBoundingBox.js";import"../../../chunks/aaBoundingRect.js";import"../../../symbols/Font.js";import"../../../symbols/IconSymbol3DLayer.js";import"../../../chunks/persistableUrlUtils.js";import"../../../symbols/LabelSymbol3D.js";import"../../../symbols/Symbol3D.js";import"../../../chunks/collectionUtils.js";import"../../../portal/Portal.js";import"../../../core/Loadable.js";import"../../../core/Promise.js";import"../../../chunks/locale.js";import"../../../portal/PortalQueryParams.js";import"../../../portal/PortalQueryResult.js";import"../../../portal/PortalUser.js";import"../../../portal/PortalFolder.js";import"../../../portal/PortalGroup.js";import"../../../symbols/LineSymbol3DLayer.js";import"../../../symbols/LineStyleMarker3D.js";import"../../../core/Clonable.js";import"../../../symbols/ObjectSymbol3DLayer.js";import"../../../symbols/PathSymbol3DLayer.js";import"../../../symbols/TextSymbol3DLayer.js";import"../../../symbols/WaterSymbol3DLayer.js";import"../../../symbols/support/StyleOrigin.js";import"../../../chunks/Thumbnail.js";import"../../../core/Evented.js";import"../../../chunks/shared.js";import"../../../chunks/SimpleObservable.js";import"../../../chunks/calloutUtils.js";import"../../../symbols/callouts/Callout3D.js";import"../../../symbols/callouts/LineCallout3D.js";import"../../../symbols/support/Symbol3DVerticalOffset.js";import"../../../symbols/LineSymbol3D.js";import"../../../symbols/MarkerSymbol.js";import"../../../symbols/MeshSymbol3D.js";import"../../../symbols/PictureFillSymbol.js";import"../../../chunks/urlUtils.js";import"../../../symbols/PictureMarkerSymbol.js";import"../../../symbols/PointSymbol3D.js";import"../../../symbols/PolygonSymbol3D.js";import"../../../symbols/TextSymbol.js";import"../../../symbols/WebStyleSymbol.js";import"../../../chunks/parser.js";import"../../../chunks/mat4f32.js";import"../../../chunks/mat4.js";import"../../../chunks/_commonjsHelpers.js";import"../../../core/HandleOwner.js";import"../../../chunks/WatchUpdatingTracking.js";import"../../../core/sql.js";import"../../../chunks/commonProperties.js";import"../../../TimeExtent.js";import"../../../chunks/timeUtils.js";import"../../../support/timeUtils.js";import"../../../chunks/ElevationInfo.js";import"../../../chunks/unitConversionUtils.js";import"../../../chunks/lengthUtils.js";import"../../../chunks/unitUtils.js";import"../../../chunks/projectionEllipsoid.js";import"../../../chunks/floorFilterUtils.js";import"../../../chunks/sublayerUtils.js";import"../../../renderers/ClassBreaksRenderer.js";import"../../../renderers/Renderer.js";import"../../../renderers/support/AuthoringInfo.js";import"../../../renderers/support/AuthoringInfoVisualVariable.js";import"../../../chunks/colorRamps.js";import"../../../rest/support/AlgorithmicColorRamp.js";import"../../../rest/support/ColorRamp.js";import"../../../rest/support/MultipartColorRamp.js";import"../../../renderers/mixins/VisualVariablesMixin.js";import"../../../renderers/visualVariables/ColorVariable.js";import"../../../renderers/visualVariables/VisualVariable.js";import"../../../chunks/LegendOptions.js";import"../../../renderers/visualVariables/support/ColorStop.js";import"../../../renderers/visualVariables/OpacityVariable.js";import"../../../renderers/visualVariables/support/OpacityStop.js";import"../../../renderers/visualVariables/RotationVariable.js";import"../../../renderers/visualVariables/support/SizeStop.js";import"../../../chunks/sizeVariableUtils.js";import"../../../chunks/visualVariableUtils.js";import"../../../Graphic.js";import"../../../PopupTemplate.js";import"../../../popup/content.js";import"../../../popup/content/AttachmentsContent.js";import"../../../popup/content/Content.js";import"../../../popup/content/CustomContent.js";import"../../../popup/content/ExpressionContent.js";import"../../../popup/ElementExpressionInfo.js";import"../../../popup/content/FieldsContent.js";import"../../../popup/FieldInfo.js";import"../../../popup/support/FieldInfoFormat.js";import"../../../chunks/date.js";import"../../../chunks/number.js";import"../../../popup/content/MediaContent.js";import"../../../popup/content/BarChartMediaInfo.js";import"../../../popup/content/mixins/ChartMediaInfo.js";import"../../../popup/content/mixins/MediaInfo.js";import"../../../popup/content/support/ChartMediaInfoValue.js";import"../../../popup/content/support/ChartMediaInfoValueSeries.js";import"../../../chunks/chartMediaInfoUtils.js";import"../../../popup/content/ColumnChartMediaInfo.js";import"../../../popup/content/ImageMediaInfo.js";import"../../../popup/content/support/ImageMediaInfoValue.js";import"../../../popup/content/LineChartMediaInfo.js";import"../../../popup/content/PieChartMediaInfo.js";import"../../../popup/content/RelationshipContent.js";import"../../../popup/support/RelatedRecordsInfoFieldOrder.js";import"../../../popup/content/TextContent.js";import"../../../popup/ExpressionInfo.js";import"../../../popup/LayerOptions.js";import"../../../popup/RelatedRecordsInfo.js";import"../../../support/actions/ActionBase.js";import"../../../core/Identifiable.js";import"../../../support/actions/ActionButton.js";import"../../../support/actions/ActionToggle.js";import"../../../chunks/compilerUtils.js";import"../../../renderers/support/ClassBreakInfo.js";import"../../../chunks/commonProperties2.js";import"../../../symbols/support/jsonUtils.js";import"../../../chunks/symbolConversion.js";import"../../../renderers/DictionaryRenderer.js";import"../../../chunks/DictionaryLoader.js";import"../../../chunks/LRUCache.js";import"../../../chunks/MemCache.js";import"../../../renderers/DotDensityRenderer.js";import"../../../renderers/support/AttributeColorInfo.js";import"../../../renderers/HeatmapRenderer.js";import"../../../renderers/support/HeatmapColorStop.js";import"../../../chunks/heatmapUtils.js";import"../../../chunks/vec4f64.js";import"../../../renderers/PieChartRenderer.js";import"../../../renderers/SimpleRenderer.js";import"../../../renderers/UniqueValueRenderer.js";import"../../../chunks/diffUtils.js";import"../../../renderers/support/UniqueValue.js";import"../../../renderers/support/UniqueValueClass.js";import"../../../renderers/support/UniqueValueGroup.js";import"../../../renderers/support/UniqueValueInfo.js";import"../../../chunks/styleUtils2.js";import"../../../chunks/utils7.js";import"../../../chunks/colorUtils2.js";import"../../../chunks/projector.js";import"../../../chunks/mat2df32.js";import"../../../chunks/mat2d.js";import"../../../chunks/jsxFactory.js";import"../../../chunks/jsxWidgetSupport.js";import"../../../chunks/asyncUtils.js";import"../../../chunks/assets.js";import"../../../chunks/ItemCache.js";import"../../../chunks/webStyleSymbolUtils.js";import"../../../chunks/devEnvironmentUtils.js";import"../../../intl.js";import"../../../chunks/messages.js";const ae={HH:315,HL:45,LL:135,LH:225},ue={2:[["HL","HH"],["LL","LH"]],3:[["HL","HM","HH"],["ML","MM","MH"],["LL","LM","LH"]],4:[["HL","HM1","HM2","HH"],["M2L","M2M1","M2M2","M2H"],["M1L","M1M1","M1M2","M1H"],["LL","LM1","LM2","LH"]]};function ce(e){if(!e)return;const{type:t}=e;if(t.includes("3d"))return Z(e.symbolLayers.getItemAt(0));if("simple-line"===t){const t=P(e);return t&&t.color}if("simple-marker"===e.type&&("x"===e.style||"cross"===e.style)){const t=P(e);return t&&t.color}return O(e)}function pe(e){let t=ae[e];return e&&null==t&&(t=ae.HH),t||0}const me=[255,255,255],de=[200,200,200],he=[128,128,128];async function ye(e,t,s,r,l,n,o){const a=t.legendOptions,u=a&&a.customValues,c=o||await async function(e,t){if("flow"===e.type)return H(e,t);if("pie-chart"===e.type)return new ie({color:null,outline:e.outline?.width?e.outline:new le});let s=null,r=null;if("simple"===e.type)s=e.symbol;else if("class-breaks"===e.type){const t=e.classBreakInfos;s=t&&t[0]&&t[0].symbol,r=t.length>1}else if("unique-value"===e.type){const t=e.uniqueValueInfos;s=t&&t[0]&&t[0].symbol,r=t.length>1}return!s||function(e){return!!e&&(i(e)?!!e.symbolLayers&&e.symbolLayers.some((e=>e&&"fill"===e.type)):e.type.includes("fill"))}(s)?null:(s=s.clone(),(t||r)&&(s.type.includes("3d")?fe(s):be(s)),s)}(e,s),p=!!c,m=!!u,d=null!=t.minSize&&null!=t.maxSize,h=t.stops&&t.stops.length>1,y=!!t.target;if(!p||!m&&!(d||h&&!y))return;const f=A(c);let b=null,g=null,S=null;g=f&&!h?ee([t.minDataValue,t.maxDataValue]):u||await async function(e,t,s,r){const i=(await import("../../../chunks/visualVariableUtils.js")).getSizeRangeAtScale(e,s,r),l=i&&ge(i);if(!i&&!l)return;let n=l.map((t=>function(e,t,s){const r=s.minSize,i=s.maxSize,l=t.minDataValue,n=t.maxDataValue;let o=null;return o=e<=r?l:e>=i?n:(e-r)/(i-r)*(n-l)+l,o}(t,e,i)));n=ee(n);for(let i=1;i<n.length-1;i++){const o=await Se(e,t,n[i],n[i-1],s,r);o&&(n[i]=o[0],l[i]=o[1])}return n}(t,c,r,l);const j=e?.authoringInfo,L="univariate-color-size"===j?.type,_=L&&"above-and-below"===j?.univariateTheme;if(!g&&h&&(g=t.stops.map((e=>e.value)),b=t.stops.some((e=>!!e.label)),"flow"===e.type&&(g=ee(g)),b&&(S=t.stops.map((e=>e.label)))),f&&g?.length>2&&!_&&(g=[g[0],g[g.length-1]]),!g)return null;L&&5!==g?.length&&(g=ge({minSize:g[0],maxSize:g[g.length-1]}));const v=f?function(e,t){const s=e?.authoringInfo,r="univariate-color-size"===s?.type;let i=[12,30];if(r){const e=t[0],s=t[t.length-1],r=12,l=30;i=t.map((t=>r+(t-e)/(s-e)*(l-r)))}return r&&"below"===s?.univariateTheme&&i.reverse(),i}(e,g):null,w=B(c),C=b?null:function(e,t){const s=e.length-1;return e.map(((e,r)=>q(e,r,s,t)))}(g,n),E=await Promise.all(g.map((async(s,n)=>{const o=f?v[n]:await je(t,c,s,r,l),a=function(e,t){const s=e.clone();if(i(s))A(s)||s.symbolLayers.forEach((e=>{"fill"!==e.type&&(e.size=t)}));else if("esri.symbols.SimpleMarkerSymbol"===s.declaredClass)s.size=t;else if("esri.symbols.PictureMarkerSymbol"===s.declaredClass){const e=s.width,r=s.height;s.height=t,s.width=t*(e/r)}else"esri.symbols.SimpleLineSymbol"!==s.declaredClass?function(e){return"esri.symbols.TextSymbol"===e.declaredClass}(s)&&s.font&&(s.font.size=t):s.width=t;return s}(_&&"class-breaks"===e.type?function(e,t){const s=e.classBreakInfos,r=s.length,i=r<2||!(t>=2)?s[0].symbol.clone():s[r-1].symbol.clone();return e.visualVariables.some((e=>"color"===e.type))&&(i.type.includes("3d")?fe(i):be(i)),i}(e,n):c,o);return{value:s,symbol:a,label:b?S[n]:C[n],size:o,outlineSize:w}})));return E.reverse()}function fe(e){"line-3d"===e.type?e.symbolLayers.forEach((e=>{e.material={color:he}})):e.symbolLayers.forEach((e=>{"icon"!==e.type||e.resource&&e.resource.href?e.material={color:de}:(e.material={color:me},e.outline={color:he,size:1.5})}))}function be(e){const s=re();if("cim"===e.type)F(e,new t(de));else if(e.type.includes("line"))e.color=he;else if(e.color=s?he:me,"simple-marker"===e.type)if(e.outline){const t=e.outline?.color?.toHex();"#ffffff"===t&&(e.outline.color=he)}else e.outline={color:he,width:1.5}}function ge(e){const t=e.minSize,s=(e.maxSize-t)/4,r=[];for(let e=0;e<5;e++)r.push(t+s*e);return r}async function Se(e,t,s,r,i,l){const n=await je(e,t,s,i,l),o=await je(e,t,r,i,l),a=te(s),u=a.fractional;let c=a.integer,p=null,m=null;s>0&&s<1&&(p=10**u,c=te(s*=p).integer);for(let r=c-1;r>=0;r--){const a=10**r;let u=Math.floor(s/a)*a,c=Math.ceil(s/a)*a;null!=p&&(u/=p,c/=p);let d=(u+c)/2;[,d]=ee([u,d,c],{indexes:[1]});const h=await je(e,t,u,i,l),y=await je(e,t,c,i,l),f=await je(e,t,d,i,l),b=se(n,h,o,null),g=se(n,y,o,null),S=se(n,f,o,null);let j=b.previous<=20,L=g.previous<=20;if(j&&L&&(b.previous<=g.previous?(j=!0,L=!1):(L=!0,j=!1)),j?m=[u,h]:L?m=[c,y]:S.previous<=20&&(m=[d,f]),m)break}return m}async function je(e,t,s,r,i){const{getSize:l}=await import("../../../chunks/visualVariableUtils.js");return l(e,s,{scale:r,view:i,shape:"simple-marker"===t.type?t.style:null})}const Le=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,_e=new u({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),ve={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-34e38,34e38],f64:[-Number.MAX_VALUE,Number.MAX_VALUE]},we=new ie({size:6,outline:{color:[128,128,128,.5],width:.5}}),Ce=new oe({style:"solid"});function Ee(e){return"flow"===e.type}function Ie(e){return"vector-field"===e.type}function ke(e){return"raster-colormap"===e.type}function Ve(e){return"raster-stretch"===e.type}function Re(e){return"raster-shaded-relief"===e.type}function Fe(e){return"esri.renderers.SimpleRenderer"===e.declaredClass}function Te(e){return"esri.renderers.ClassBreaksRenderer"===e.declaredClass}function ze(e){return"esri.renderers.UniqueValueRenderer"===e.declaredClass}function xe(e){return"esri.renderers.HeatmapRenderer"===e.declaredClass}function Me(e){return"esri.renderers.PointCloudClassBreaksRenderer"===e.declaredClass}function De(e){return"esri.renderers.PointCloudStretchRenderer"===e.declaredClass}function Ue(e){return"esri.renderers.PointCloudUniqueValueRenderer"===e.declaredClass}function Pe(e){return"esri.renderers.DotDensityRenderer"===e.declaredClass}function Oe(e){return"esri.renderers.PieChartRenderer"===e.declaredClass}function Ae(e){return"esri.layers.SubtypeGroupLayer"===e.declaredClass}function Be(e){return"esri.layers.MapImageLayer"===e.declaredClass}function He(e){return"esri.layers.ImageryLayer"===e.declaredClass}function qe(e){return"esri.layers.ImageryTileLayer"===e.declaredClass}const Ne=new ie({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}});let $e={},We=class extends l{constructor(e){super(e),this._handles=new a,this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._webStyleSymbolCache=new Map,this._dotDensityUrlCache=new Map,this._scaleDrivenSizeVariable=null,this._hasClusterSizeVariable=!1,this.children=new o,this.layerView=null,this.layer=null,this.legendElements=[],this.parent=null,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerVisibility=!0,this.sublayerIds=[],this.title=null,this.view=null}initialize(){const e=()=>this.notifyChange("ready");this._handles.add([y((()=>this.children),"change",(t=>{const{added:s,removed:r}=t,i=this._handles;s.forEach((t=>{const s=`activeLayerInfo-ready-watcher-${t.layer.uid}`;i.add(f((()=>t.ready),e,g),s)})),r.forEach((e=>i.remove(e.layer.uid))),e()}))]),this.keepCacheOnDestroy||($e={})}destroy(){this._handles.destroy(),this._handles=null,this._webStyleSymbolCache=null,this._dotDensityUrlCache=null,this._scaleDrivenSizeVariable=null,this.keepCacheOnDestroy||($e=null)}get effectList(){const e=this.layer;let t=null;return"effect"in e&&e.effect&&(t=new v,t.effect=e.effect,t.endTransitions(),t.scale=this.scale),t}get opacity(){const e=this.layer.opacity,t=this.parent?.opacity,s=this.layer.parent,r=s&&"uid"in s?this._getParentLayerOpacity(s):null;return null!=t?t*e:null!=r?r*e:e}get ready(){return null===this.layer||(this.children.length>0?this._isGroupActive():this.legendElements.length>0)}get scale(){return this.view&&this.view.scale}get isScaleDriven(){const e=this.layer;if(null===e)return!1;if("effect"in e&&e.effect&&Array.isArray(e.effect))return!0;if("featureReduction"in e&&e.featureReduction){if("cluster"===e.featureReduction.type)return!0;if("binning"===e.featureReduction.type&&"renderer"in e.featureReduction&&e.featureReduction.renderer)return this._isRendererScaleDriven(e.featureReduction.renderer)}return"renderer"in e&&e.renderer?this._isRendererScaleDriven(e.renderer):this._isLayerScaleDriven(this.layer)}get version(){return this._get("version")+1}async buildLegendElementsForFeatureCollections(e){if(this.hideLayersNotInCurrentView&&!await this._isLayerInCurrentView())return this.legendElements=[],void this.notifyChange("ready");const t=Array.from(e,(e=>{if("esri.layers.FeatureLayer"===e.declaredClass)return this._getRendererLegendElements(e.renderer,{title:e.title});if(e.featureSet&&e.featureSet.features.length){const t=e.layerDefinition,s=t&&t.drawingInfo,r=s&&I(s.renderer),i=_e.read(t.geometryType);return r?this._getRendererLegendElements(r,{title:e.name,geometryType:i}):(c.getLogger(this.declaredClass).warn("drawingInfo not available!"),null)}return null}));try{const e=[];await d(t).then((t=>{t.forEach((({value:t})=>t&&e.push(...t)))})),this.legendElements=e,this.notifyChange("ready")}catch(e){c.getLogger(this.declaredClass).warn("error while building legend for layer!",e)}}async buildLegendElementsForRenderer(e){try{const t=!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView();this.legendElements=t?await this._getRendererLegendElements(e):[],this.notifyChange("ready")}catch(e){c.getLogger(this.declaredClass).warn("error while building legend for layer!",e)}}async buildLegendElementsForFeatureReduction(e){try{const t=!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView();this.legendElements=t?await this._getLegendElementsForFeatureReduction(e):[],this.notifyChange("ready")}catch(e){c.getLogger(this.declaredClass).warn("error while building legend for layer!",e)}}async buildLegendElementsForTools(){const e=this.layer;if(function(e){return"esri.layers.VoxelLayer"===e.declaredClass}(e))this._constructLegendElementsForVoxellayer();else if(function(e){return"esri.layers.WMTSLayer"===e.declaredClass}(e))this._constructLegendElementsForWMTSlayer();else if(function(e){return"esri.layers.WMSLayer"===e.declaredClass}(e))await this._constructLegendElementsForWMSSublayers();else if(function(e){return"esri.layers.BuildingSceneLayer"===e.declaredClass}(e))await this._constructLegendElementsForBuildingSceneLayer();else if(Be(e)||function(e){return"esri.layers.TileLayer"===e.declaredClass}(e)||Ae(e))await this._constructLegendElementsForSublayers();else{this._handles.remove("imageryLayers-watcher");let t="default";He(e)&&(t=(e?.renderingRule?.functionName||"default")+"_"+(e.bandIds?.length?e.bandIds.join(""):"###")),await this._getLegendLayers(`${e.uid}-${t}`).then((async t=>{this.legendElements=[],this.notifyChange("ready");const s=t.map((async t=>{if(He(e)||qe(e)){const t=f((()=>["renderingRule"in e&&e.renderingRule,e.bandIds]),(()=>h((async()=>{$e.default=null,e.renderer?await this.buildLegendElementsForRenderer(e.renderer):await this.buildLegendElementsForTools()}))()));this._handles.add(t,"imageryLayers-watcher")}const s=this._generateSymbolTableElementForLegendLayer(t);s&&s.infos.length&&(He(e)&&(s.title=e.title),this.legendElements.push(s)),this.notifyChange("ready")}));await d(s)})).catch((e=>{c.getLogger(this.declaredClass).warn("Request to server for legend has failed!",e)}))}}async _isLayerInCurrentView(){const e=this.layer,t=this.layerView,s=t&&"createQuery"in t&&"queryFeatureCount"in t;if(!(s||t&&"createQuery"in e&&"queryFeatureCount"in e))return!0;await b((()=>!t.updating));const r=s?"createQuery"in t&&t.createQuery():"createQuery"in e&&e.createQuery();return r.geometry=this.view.extent,0!==(s?"queryFeatureCount"in t&&await t.queryFeatureCount(r):"queryFeatureCount"in e&&await e.queryFeatureCount(r))}_getParentLayerOpacity(e){let t=1;const s=e.parent;return s&&"uid"in s&&(t=this._getParentLayerOpacity(s)),e.opacity*t}_isGroupActive(){const e=this.children;return!!e.length&&e.some((e=>e.ready))}_isRendererScaleDriven(e){if("dot-density"===e.type)return!0;const t="valueExpression"in e&&e.valueExpression;if(Le.test(t))return!0;const s="visualVariables"in e&&e.visualVariables;return!!s&&s.some((e=>this._isScaleDrivenSizeVariable(e)))}_isScaleDrivenSizeVariable(e){if(e&&"size"!==e.type)return!1;const t=e,s=t.minSize,r=t.maxSize;return"object"==typeof s&&s?this._isScaleDrivenSizeVariable(s):"object"==typeof r&&r?this._isScaleDrivenSizeVariable(r):!!t.expression||Le.test(t.valueExpression)}_isLayerScaleDriven(e){if("minScale"in e&&e.minScale>0||"maxScale"in e&&e.maxScale>0)return!0;if("sublayers"in e&&e.sublayers)return e.sublayers.some((e=>this._isLayerScaleDriven(e)));const t=e.parent;if(!1===e.loaded&&t&&Be(t)&&"source"in e&&e.source&&"map-layer"===e.source.type)for(const s of t.sourceJSON.layers)if(s.id===e.source.mapLayerId&&(s.minScale>0||s.maxScale>0))return!0;return!1}async _constructLegendElementsForVoxellayer(){this.legendElements=[],this._handles.remove("voxel-style-watcher"),this._handles.remove("voxel-current-variable");const e=this.layer;this._handles.add(f((()=>e.currentVariableId),(()=>this._constructLegendElementsForVoxellayer())),"voxel-current-variable"),this._handles.add(f((()=>e.getVariableStyles()),(()=>this._constructLegendElementsForVoxellayer())),"voxel-style-watcher");const t=p(e.getVariableStyle(null)),s=[];if(t)if(t.uniqueValues?.length){const e=[];t.uniqueValues.forEach((t=>{t.enabled&&e.push({label:t.label||`${t.value}`,value:t.value,symbol:new oe({color:t.color,outline:null})})})),e.length&&s.push({type:"symbol-table",title:t.label,infos:e})}else if(t.transferFunction){const{colorStops:e,stretchRange:r}=t.transferFunction,i=e.toArray().reverse(),l=r.map(((e,t)=>`${0===t?N:$} ${ne(e)}`)).reverse(),n=i.map((e=>({color:e.color,value:null,label:null})));n[0].label=l[0],n[n.length-1].label=l[1],s.push({type:"color-ramp",title:t.label,infos:n,preview:T(i.map((e=>e.color)))})}const r=e.opacity,i=s.reduce(((e,t)=>e.concat(this._getAllInfos(t))),[]).filter((e=>!!e?.symbol)).map((e=>this._getSymbolPreview(e,r)));await d(i),this.legendElements=s,this.notifyChange("ready")}_constructLegendElementsForWMTSlayer(){this.legendElements=[],this._handles.remove("wmts-activeLayer-watcher");const e=this.layer.activeLayer;if(this._handles.add(f((()=>{const{layer:e}=this;return e&&"activeLayer"in e&&e.activeLayer}),(()=>this._constructLegendElementsForWMTSlayer())),"wmts-activeLayer-watcher"),e.styleId&&e.styles){let t=null;e.styles.some((s=>e.styleId===s.id&&(t=s.legendUrl,!0))),t&&(this.legendElements=[{type:"symbol-table",title:e.title,infos:[{src:t,opacity:this.opacity}]}])}this.notifyChange("ready")}async _constructLegendElementsForWMSSublayers(){this.legendElements=[],this._handles.remove("wms-sublayers-watcher");const e=this.layer;let t=null;(e.customParameters||e.customLayerParameters)&&(t={...e.customParameters,...e.customLayerParameters}),this._handles.add(f((()=>{const{layer:e}=this;return e&&"sublayers"in e&&e.sublayers}),(()=>this._constructLegendElementsForWMSSublayers())),"wms-sublayers-watcher"),this.legendElements=await this._generateLegendElementsForWMSSublayers(e.sublayers,t),this.notifyChange("ready")}async _generateLegendElementsForWMSSublayers(e,t){const s=[];this._handles.add(e.on("change",(()=>this._constructLegendElementsForWMSSublayers())),"wms-sublayers-watcher");const r=e.toArray();for(const e of r){const r=f((()=>[e.title,e.visible,e.legendEnabled]),(()=>this._constructLegendElementsForWMSSublayers()));if(this._handles.add(r,"wms-sublayers-watcher"),!this.respectLayerVisibility||e.visible&&e.legendEnabled){const r=await this._generateSymbolTableElementForWMSSublayer(e,t);r&&r.infos.length&&s.unshift(r)}}return s}async _generateSymbolTableElementForWMSSublayer(e,t){if(!e.legendUrl&&e.sublayers){const s=(await this._generateLegendElementsForWMSSublayers(e.sublayers,t)).filter((e=>e));return{type:"symbol-table",title:e.title,infos:s}}return this._generateSymbolTableElementForLegendUrl(e,t)}async _generateSymbolTableElementForLegendUrl(e,t){let s=e.legendUrl;if(!s)return;const i={type:"symbol-table",title:e.title||e.name||e.id&&e.id+"",infos:[]};t&&(s=j(s,t));let l=null;const n=e.layer?.opacity;try{l=(await r(s,{responseType:"image"})).data,l&&(l.style.opacity=n)}catch{}return i.infos.push({src:s,preview:l,opacity:n}),i}_getLegendLayers(e,t){const s=$e&&$e[e];return s?Promise.resolve(s):this._legendRequest(t).then((t=>{const s=t.layers;return $e[e]=s,s}))}_legendRequest(e){const t=this.layer;let s={f:"json",dynamicLayers:e};if(He(t)){const e=t.exportImageServiceParameters.renderingRule;if(e&&(s.renderingRule=JSON.stringify(e.rasterFunctionDefinition||e.toJSON())),t.bandIds&&(s.bandIds=t.bandIds.join()),t.raster||t.viewId||t.customParameters){const{raster:e,viewId:r,customParameters:i}=t;s={raster:e,viewId:r,...s,...i}}}let i=t.url.replace(/(\/)+$/,"");if("version"in t&&t.version>=10.01){const e=i.indexOf("?");e>-1?i=i.substring(0,e)+"/legend"+i.substring(e):i+="/legend"}else{const e=i.toLowerCase().indexOf("/rest/"),t=i.substring(0,e)+i.substring(e+5,i.length);i="https://utility.arcgis.com/sharing/tools/legend?soapUrl="+encodeURI(t)+"&returnbytes=true"}return r(i,{query:s}).then((e=>e.data))}async _constructLegendElementsForBuildingSceneLayer(){this.legendElements=[],this._handles.remove("sublayers-watcher");const e=this.layer;this._handles.add(f((()=>e.sublayers),(()=>this._constructLegendElementsForBuildingSceneLayer())),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForBuildingSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(e){c.getLogger(this.declaredClass).warn("Request to server for legend has failed!",e)}}async _generateLegendElementsForBuildingSublayers(e,t){let s=[];this._handles.add(e.on("change",(()=>this._constructLegendElementsForBuildingSceneLayer())),"sublayers-watcher");const r=e.toArray();for(const e of r){const r=f((()=>["renderer"in e&&e.renderer,e.opacity,e.title,e.visible]),(()=>this._constructLegendElementsForBuildingSceneLayer()));if(this._handles.add(r,"sublayers-watcher"),!this.respectLayerVisibility||e.visible){const r=e&&null!=e.opacity?e.opacity:null,i=null!=r?r*t:t;if("building-group"===e.type){const t={type:"symbol-table",title:e.title,infos:[]},r=await this._generateLegendElementsForBuildingSublayers(e.sublayers,i);t.infos.push(...r),s=[t,...s]}else e.renderer&&(s=[...await this._getRendererLegendElements(e.renderer,{title:e.title,opacity:i,sublayer:e}),...s])}}return s.filter((e=>!!e&&(!("infos"in e)||e.infos.length>0)))}async _constructLegendElementsForSublayers(){this.legendElements=[],this._handles.remove("sublayers-watcher");const e=this.layer;this._handles.add(f((()=>e.sublayers),(()=>this._constructLegendElementsForSublayers)),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(e){c.getLogger(this.declaredClass).warn("Request to server for legend has failed!",e)}}async _generateLegendElementsForSublayers(e,t,s){const r=this.layer;let i=[];this._handles.add(e.on("change",(()=>this._constructLegendElementsForSublayers())),"sublayers-watcher");let l=e.toArray();!s&&this.sublayerIds&&this.sublayerIds.length&&(l=this.sublayerIds.map((e=>r.findSublayerById(e))).filter(Boolean));for(const e of l){const l=f((()=>[e.renderer,e.opacity,e.title,e.visible,e.legendEnabled]),(()=>this._constructLegendElementsForSublayers()));if(this._handles.add(l,"sublayers-watcher"),!this.respectLayerVisibility||e.visible&&e.legendEnabled&&this._isSublayerInScale(e)){const l=e&&null!=e.opacity?e.opacity:null,o=null!=l?l*t:t,a=!!Ae(r)||e.originIdOf("renderer")>n.SERVICE;if(e.renderer&&!e.sublayers&&a)await e.load(),i=[...await this._getRendererLegendElements(e.renderer,{title:e.title,opacity:o,sublayer:e}),...i];else{const t=await this._generateSymbolTableElementForSublayer(e,o,s);t&&i.unshift(t)}}}return i.filter((e=>!!e&&(!("infos"in e)||e.infos.length>0)))}async _generateSymbolTableElementForSublayer(e,t,s){if(!s){s=new Map;const t=this.layer,r=e.source;let i=null;if(r&&("map-layer"!==r.type||r.mapLayerId!==e.id||r.gdbVersion&&r.gdbVersion!==("gdbVersion"in t&&t.gdbVersion))||e.originIdOf("renderer")>n.SERVICE||e.originIdOf("labelingInfo")>n.SERVICE||e.originIdOf("labelsVisible")>n.SERVICE){const e=new C({layer:this.layer});i=e.hasDynamicLayers?e.dynamicLayers:null,e.destroy()}const l=i||`${t.uid}-default`;(await this._getLegendLayers(l,i)).forEach((e=>s.set(e.layerId,e)))}const r=s.get(e.id);if((!r||r?.subLayerIds&&r.defaultVisibility)&&e.sublayers){const r=await this._generateLegendElementsForSublayers(e.sublayers,t,s);return{type:"symbol-table",title:e.title,infos:r}}return this._generateSymbolTableElementForLegendLayer(r,e,t)}_generateSymbolTableElementForLegendLayer(e,t,s){if(!e||!e.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(e,t))return null;const r=t?.renderer;let i=t?.title||e.layerName;if(r&&(!t||t?.originIdOf("renderer")>n.SERVICE)){const e=t?.title||this._getRendererTitle(r,t);e&&(i&&"string"!=typeof e&&"title"in e&&(e.title=i),i=e)}const l={type:"symbol-table",title:i,legendType:e.legendType?e.legendType:null,infos:[]},o=t?this._sanitizeLegendForSublayer(e.legend.slice(),t):e.legend;return e.legendGroups?.length>0?e.legendGroups.forEach((t=>{const r={type:"symbol-table",title:t.heading,legendType:e.legendType?e.legendType:null,infos:this._generateSymbolTableElementInfosForLegendLayer(o.filter((e=>e.groupId===t.id)),e.layerId,s)};r.infos?.length>0&&l.infos.push(r)})):l.infos=this._generateSymbolTableElementInfosForLegendLayer(o,e.layerId,s),l.infos.length>0?l:null}_generateSymbolTableElementInfosForLegendLayer(e,t,r){return e.map((e=>{let i=e.url;if(e.imageData&&e.imageData.length>0)i=`data:image/png;base64,${e.imageData}`;else{if(0===i.indexOf("http"))return null;i=s(`${this.layer.url}/${t}/images/${i}`)}return{label:e.label,src:i,opacity:r??this.opacity,width:e.width,height:e.height}})).filter((e=>!!e))}_isSublayerInScale(e){const t=e.minScale||0,s=e.maxScale||0;return!(t>0&&t<this.scale||s>this.scale)}_isLegendLayerInScale(e,t){const s=t||this.layer;let r=null,i=null,l=!0;return!s.minScale&&0!==s.minScale||!s.maxScale&&0!==s.maxScale?(0===e.minScale&&s.tileInfo&&(r=s.tileInfo.lods[0].scale),0===e.maxScale&&s.tileInfo&&(i=s.tileInfo.lods[s.tileInfo.lods.length-1].scale)):(r=Math.min(s.minScale,e.minScale)||s.minScale||e.minScale,i=Math.max(s.maxScale,e.maxScale)),(r>0&&r<this.scale||i>this.scale)&&(l=!1),l}_sanitizeLegendForSublayer(e,t){if("version"in this.layer&&this.layer.version<10.1||0===e.length)return e;const s=t.renderer,r=e.some((e=>e.values));let i=null,l=null;return r&&e.some(((e,t)=>(e.values||(i=t,l=e,l.label||(l.label="others")),null!=l))),s?"unique-value"===s.type?l&&(e.splice(i,1),e.push(l)):"class-breaks"===s.type&&(l&&e.splice(i,1),e.reverse(),l&&e.push(l)):l&&(e.splice(i,1),e.push(l)),e}async _getRendererLegendElements(e,t={}){if(!function(e,t){return Fe(e)||Te(e)||ze(e)||xe(e)||Pe(e)||Oe(e)?"2d"===t.type||k(e):Ve(e)||ke(e)||Re(e)||Me(e)||De(e)||Ue(e)||Ie(e)||Ee(e)}(e,this.view))return c.getLogger(this.declaredClass).warn(`Renderer of type '${e.type}' not supported!`),[];if(function(e){return Me(e)||De(e)||Ue(e)||function(e){return"esri.renderers.PointCloudRGBRenderer"===e.declaredClass}(e)}(e))return this._constructPointCloudRendererLegendElements(e,t);if(Pe(e))return this._constructDotDensityRendererLegendElements(e);const s=await this._loadRenderer(e);return Oe(s)?this._constructPieChartRendererLegendElements(s):this._constructRendererLegendElements(s,t)}async _getLegendElementsForFeatureReduction(e){let t=null;return"binning"===e.type?t=e.renderer:"cluster"===e.type&&(t=this._getClusterRenderer(e)),t?this._getRendererLegendElements(t):[]}_getPointCloudRendererTitle(e){return e.legendOptions&&e.legendOptions.title||e.field}_constructPointCloudRendererLegendElements(e,t={}){const s=t.title,r=[];let i=null,l=null;if(Me(e))i={type:"symbol-table",title:s||this._getPointCloudRendererTitle(e),infos:[]},e.colorClassBreakInfos.forEach((e=>{i.infos.unshift({label:e.label||e.minValue+" - "+e.maxValue,value:[e.minValue,e.maxValue],symbol:this._getAppliedCloneSymbol(we,e.color)})}));else if(De(e)){const t=e.stops;let r=null;if(t.length&&(1===t.length&&(r=t[0].color),!r)){const e=t[0].value,s=t[t.length-1].value;null!=e&&null!=s&&(r=W(e+(s-e)/2,t))}i={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(we,r||we.color)}]};const n=G(e.stops);l={type:"color-ramp",title:s||this._getPointCloudRendererTitle(e),infos:n,preview:T(n.map((e=>e.color)))}}else Ue(e)&&(i={type:"symbol-table",title:s||this._getPointCloudRendererTitle(e),infos:[]},e.colorUniqueValueInfos.forEach((e=>{i.infos.push({label:e.label||e.values.join(", "),value:e.values.join(", "),symbol:this._getAppliedCloneSymbol(we,e.color)})})));i&&i.infos.length&&r.push(i),l&&l.infos.length&&r.push(l);const n=r.reduce(((e,t)=>e.concat(t.infos)),[]).filter((e=>!!e.symbol)).map((t=>this._getSymbolPreview(t,this.opacity,{symbolConfig:{applyColorModulation:!!e.colorModulation}})));return d(n).then((()=>r))}_getElementInfoForDotDensity(e,t){const{backgroundColor:s,outline:r,dotSize:i}=e,l=this.effectList?.effects.map((e=>e.toJSON())),n=w(l),o=i+"-"+t+"-"+s+"-"+(r&&JSON.stringify(r.toJSON()))+"-"+n,a=this._dotDensityUrlCache,u=a.has(o)?a.get(o):z(e,t);a.set(o,u);const c={shape:{type:"image",x:0,y:0,width:u.width,height:u.height,src:u.src},fill:null,stroke:null,offset:[0,0]},p=x([[c]],[u.width,u.height],{effectView:this.effectList});return{opacity:1,src:u.src,preview:p,width:u.width,height:u.height}}_constructDotDensityRendererLegendElements(e){const t=e.calculateDotValue(this.view.scale),s=e.legendOptions&&e.legendOptions.unit,r={type:"symbol-table",title:{value:t&&Math.round(t),unit:s||""},infos:[]};return e.attributes.forEach((t=>{const s=this._getElementInfoForDotDensity(e,t.color);s.label=t.label||t.valueExpressionTitle||t.field,r.infos.push(s)})),Promise.resolve([r])}async _constructPieChartRendererLegendElements(e){const t=this.layer.opacity,s=[],r="Others",i=e.outline;e.attributes.forEach((e=>{const t=new ie({color:e.color,outline:i}),r=e.label||e.valueExpressionTitle||e.field;s.push({label:r,symbol:t})}));const l=s.length?[...s]:[];if(e.othersCategory?.color&&0!==e.othersCategory?.threshold){const t=new ie({color:e.othersCategory.color,outline:i});s.push({label:e.othersCategory.label||r,symbol:t})}if(e.defaultColor?.a){const t=new ie({color:e.defaultColor,outline:i});s.push({label:e.defaultLabel,symbol:t})}const n=await this._getVisualVariableLegendElements(e,this.layer)||[];if(s.length){n.unshift({type:"symbol-table",title:null,infos:s});const t=l.filter((e=>e.label!==r)).map((e=>e.symbol.color)).filter(Boolean),o=M(t,{holePercentage:e.holePercentage,backgroundColor:e.backgroundFillSymbol?.color,effectList:this.effectList,outline:i});n.unshift({type:"pie-chart-ramp",title:this._getRendererTitle(e,this.layer),infos:s,preview:o})}const o=n.reduce(((e,t)=>e.concat(this._getAllInfos(t))),[]).filter((e=>!!e?.symbol&&!e?.preview)).map((e=>this._getSymbolPreview(e,t,{effectList:this.effectList})));return await d(o),n}async _constructRendererLegendElements(e,t={}){const{title:s,sublayer:r}=t,i=r||this.layer;this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._scaleDrivenSizeVariable=null;const l=await this._getVisualVariableLegendElements(e,i)||[],n={type:"symbol-table",title:s||this._getRendererTitle(e,i),infos:[]};let o=null,a=!1;const u=new Set;if(Ee(e)&&!this._hasSizeRamp){const t=await H(e);n.infos.push({label:null,symbol:t})}else if("univariate-color-size"===("authoringInfo"in(c=e)&&c?.authoringInfo)?.type){let t=s;const r=function(e){const t="authoringInfo"in e&&e?.authoringInfo;return"univariate-color-size"===t?.type&&"above-and-below"===t?.univariateTheme}(e)?"univariate-above-and-below-ramp":"univariate-color-size-ramp",i=l.findIndex((e=>"color-ramp"===e.type)),n=-1!==i?l.splice(i,1)[0]:null,o=l.findIndex((e=>"size-ramp"===e.type)),a=-1!==o?l.splice(o,1)[0]:null,u=[];n&&(t=n.title,u.push(n)),a&&(t=a.title,u.push(a)),u.length>0&&l.push({type:r,title:t,infos:u})}else if(xe(e)){const t=J(e);l.push({type:"heatmap-ramp",title:s||this._getRendererTitle(e,i),infos:t,preview:T(t.map((e=>e.color)),{effectList:this.effectList})})}else if(ze(e)){const t=e&&e.authoringInfo;if(t&&"relationship"===t.type){const{focus:s,numClasses:r,field1:o,field2:a}=t;if(r&&o&&a){const t=[o,a];let c=pe(s)||0;for(const e of t){const{field:t,normalizationField:s,label:r}=e,l=r||{field:this._getFieldAlias(t,i),normField:s&&this._getFieldAlias(s,i)},o=Ne.clone();o.angle=c,n.infos.push({label:l,symbol:o}),u.add(o),c+=90}const p=function(e){const{focus:t,infos:s,numClasses:r}=e,i=ue[r],l={};s.forEach((e=>{l[e.value]={label:e.label,fill:ce(e.symbol)}}));const n=[];for(let e=0;e<r;e++){const t=[];for(let s=0;s<r;s++){const r=l[i[e][s]];t.push(r.fill)}n.push(t)}const o=function(e,t){const s=t.HH.label,r=t.LL.label,i=t.HL.label,l=t.LH.label;switch(e){case"HH":default:return{top:s,bottom:r,left:i,right:l};case"HL":return{top:i,bottom:l,left:r,right:s};case"LL":return{top:r,bottom:s,left:l,right:i};case"LH":return{top:l,bottom:i,left:s,right:r}}}(t,l);return{type:"relationship-ramp",numClasses:r,focus:t,colors:n,labels:o,rotation:pe(t)}}({focus:s,numClasses:r,infos:e.uniqueValueInfos});l.unshift(p)}}else if(He(this.layer)||qe(this.layer))e.uniqueValueInfos.forEach((e=>{e.symbol&&n.infos.push({label:e.label||e.value,value:e.value,symbol:e.symbol})}));else{const{field:t,field2:s,field3:r,fieldDelimiter:l,valueExpression:o}=e,a=!(!t&&!o||!s&&!r),u=[];if(e.uniqueValueGroups.forEach((e=>{const n={type:"symbol-table",title:e.heading,infos:[]};e.classes.forEach((e=>{const{symbol:u,values:c}=e;if(u){const p=[],m=[];for(const e of c){const{value:n,value2:u,value3:c}=e,d=[],h=[];(t||o)&&(d.push(n),h.push(this._getDomainName(t,n,i))),s&&(d.push(u),h.push(this._getDomainName(s,u,i))),r&&(d.push(c),h.push(this._getDomainName(r,c,i))),p.push(a?d.join(l||""):d[0]),m.push(h.join(" - "))}const d=p.join(", ");let h=e.label;if(!h){const e=m.filter(Boolean);h=e.length?e.join(", "):d}n.infos.push({label:h,value:d,symbol:u})}})),n.infos.length&&u.push(n)})),u.length){const e=u[0];1===u.length&&"title"in e&&!e.title?n.infos.push(...e.infos):n.infos.push(...u)}}e.defaultSymbol&&(n.infos.push({label:e.defaultLabel||"others",symbol:e.defaultSymbol}),a=!0)}else if(Te(e))o=this._isUnclassedRenderer(e),(!o||!this._hasSizeRamp)&&(e.classBreakInfos.forEach((e=>{e.symbol&&n.infos.unshift({label:e.label||(o?null:e.minValue+" - "+e.maxValue),value:[e.minValue,e.maxValue],symbol:e.symbol})})),o&&(n.title=null),this._updateInfosforClassedSizeRenderer(e,n.infos)),e.defaultSymbol&&!o&&(n.infos.push({label:e.defaultLabel||"others",symbol:e.defaultSymbol}),a=!0);else if(Ve(e))if(qe(this.layer)||function(e){return"esri.layers.WCSLayer"===e.declaredClass}(this.layer)){const t=this._constructTileImageryStretchRendererElements(e);"stretch-ramp"===t.type?l.push(t):n.infos=t}else{const t=this.layer;let s,r;e.statistics&&e.statistics.length&&(s=null!=e.statistics[0].min?e.statistics[0].min:e.statistics[0][0],r=null!=e.statistics[0].max?e.statistics[0].max:e.statistics[0][1]);let i=[];const o=p(t.renderingRule?await t.generateRasterInfo(t.renderingRule):t.serviceRasterInfo),a=o.keyProperties.BandProperties,u=ve[t.rasterInfo.pixelType.toLowerCase()];1===o.bandCount||t.bandIds&&1===t.bandIds.length?(s=null!=s?s:o.statistics?o.statistics[t.bandIds[0]].min:u[0],r=null!=r?r:o.statistics?o.statistics[t.bandIds[0]].max:u[1],s||r?l.push(this._getStretchLegendElements(e,{min:s,max:r})):this._getServerSideLegend()):o.bandCount>=3?a&&a.length>=o.bandCount?t.bandIds&&3===t.bandIds.length?(i=t.bandIds.map((e=>a[e].BandName)),n.infos=this._createSymbolTableElementMultiBand(i)):"lerc"===t.format?(i=[0,1,2].map((e=>a[e].BandName)),n.infos=this._createSymbolTableElementMultiBand(i)):this._getServerSideLegend():"lerc"===t.format?(i=["band1","band2","band3"],n.infos=this._createSymbolTableElementMultiBand(i)):this._getServerSideLegend():this._getServerSideLegend()}else if(ke(e))e.colormapInfos.forEach((e=>{n.infos.push({label:e.label,value:e.value,symbol:this._getAppliedCloneSymbol(Ce,e.color)})}));else if(Fe(e)){let s=e.symbol;switch(t.geometryType){case"point":s="pointSymbol"in i&&i.pointSymbol;break;case"polyline":s="lineSymbol"in i&&i.lineSymbol;break;case"polygon":s="polygonSymbol"in i&&i.polygonSymbol}const r=this._hasClusterSizeVariable&&this._getClusterSymbol()||!this._hasSizeRamp;e.symbol&&r&&n.infos.push({label:e.label,symbol:s})}else if(Ie(e)){e.outputUnit&&(this.title="("+e.toJSON().outputUnit+")"),n.title=e.attributeField;const t=e.getClassBreakInfos();t?.length?t.forEach((e=>{n.infos.push({label:e.minValue+" - "+e.maxValue,symbol:e.symbol})})):n.infos.push({label:e.attributeField,symbol:e.getDefaultSymbol()})}else Re(e)&&l.push(this._getStretchLegendElements(e,{min:0,max:255}));var c;const m=e.defaultSymbol;!m||a||Fe(e)||o&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||l.push({type:"symbol-table",infos:[{label:e.defaultLabel||"others",symbol:m}]}),n.infos.length&&l.unshift(n);const h=null==t.opacity?this.opacity:t.opacity,y=this._isTallSymbol("visualVariables"in e&&e.visualVariables),f=He(this.layer)||qe(this.layer),b=l.reduce(((e,t)=>e.concat(this._getAllInfos(t))),[]).filter((e=>!!e?.symbol)).map((e=>this._getSymbolPreview(e,h,{isDefault:e.symbol===m,applyScaleDrivenSize:!u.has(e.symbol),symbolConfig:{isTall:y,isSquareFill:f},effectList:u.has(e.symbol)?null:this.effectList})));return e=null,await d(b),l}_getServerSideLegend(){setTimeout((()=>this.buildLegendElementsForTools()),0)}_getAllInfos(e){const t=e?.infos;return t?t.reduce(((e,t)=>e.concat(this._getAllInfos(t))),[]):[e]}_constructTileImageryStretchRendererElements(e){const t=this.layer,s=t.rasterInfo,r=s.bandCount||e.statistics.length;let i,l,n=[];const o=s.keyProperties&&s.keyProperties.BandProperties,a=e?.statistics?.length?e.statistics:s?.statistics;if(a)i=void 0!==a[0].min?a[0].min:a[0][0],l=a[0].max||a[0][1];else{const e=ve[t.rasterInfo.pixelType.toLowerCase()];i=e[0],l=e[1]}if(t.hasStandardTime()&&(i=t.getStandardTimeValue(i),l=t.getStandardTimeValue(l)),1===s.bandCount||1===t.bandIds?.length)return this._getStretchLegendElements(e,{min:i,max:l});function u(e){const r=(t?.bandIds?.length?t.bandIds:Array.from(Array(Math.min(s.bandCount,3)).keys())).map((t=>e&&e[t]&&e[t].BandName||"band"+(t+1)));return r.length<3?r.push(r[1]):r.length>3&&r.splice(3),r}return n=o&&o.length>=r?u(o):u(),this._createSymbolTableElementMultiBand(n)}_getStretchLegendElements(e,t){const s=e.colorRamp,r=Q(s,t);return{type:"stretch-ramp",title:"",infos:r,preview:T(r.map((e=>e.color)))}}_getClusterSymbol(){const e=this.layer,t="featureReduction"in e&&e.featureReduction,s=t&&"symbol"in t&&t.renderer;return s&&!0!==s?.authoringInfo?.isAutoGenerated?null:t&&"symbol"in t&&t.symbol}async _getSizeLegendElement(e,t,s,r){return{type:"size-ramp",title:this._hasClusterSizeVariable?this._getClusterTitle(t):e,infos:await ye(s,t,await X(s),this.scale,this.view.type,r,this._hasClusterSizeVariable?this._getClusterSymbol():null)}}_createSymbolTableElementMultiBand(e){const t=[],s=["red","green","blue"];return e.forEach(((e,r)=>{t.push({label:{colorName:s[r],bandName:e},src:K[r],opacity:this.opacity??1})})),t}_updateInfosforClassedSizeRenderer(e,t){const s=e.authoringInfo&&"class-breaks-size"===e.authoringInfo.type,r=e.classBreakInfos.some((e=>A(e.symbol)));if(s&&r){const s=30,r=12,i=e.classBreakInfos.length,l=(s-r)/(i>1?i-1:i);t.forEach(((e,t)=>{e.size=s-l*t}))}}_isTallSymbol(e){let t=!1,s=!1;if(e)for(let r=0;r<e.length&&(!t||!s);r++){const i=e[r];"size"===i.type&&("height"===i.axis&&(t=!0),"width-and-depth"===i.axis&&(s=!0))}return t&&s}async _getSymbolPreview(e,t,s){let r=!s?.isDefault&&null==e.size&&this._hasSizeRamp?S(D.size):e.size;if(this._scaleDrivenSizeVariable&&s?.applyScaleDrivenSize){const{getSize:t}=await import("../../../chunks/visualVariableUtils.js");r=t(this._scaleDrivenSizeVariable,null,{view:this.view.type,scale:this.scale,shape:"simple-marker"===e.symbol.type?e.symbol.style:null})}return U(e.symbol,{size:r,opacity:t,scale:!1,symbolConfig:s?.symbolConfig,effectView:s?.effectList}).then((t=>(e.preview=t,e))).catch((()=>(e.preview=null,e)))}_getClusterRenderer(e){this._hasClusterSizeVariable=!1;const t="renderer"in this.layer&&this.layer.renderer,s=e.renderer?.clone()||t?.clone(),r=p(function(e,t){if(!e||!("visualVariables"in e)||!e.visualVariables)return null;const s=e.visualVariables.find((e=>"size"===e.type)),r=((e,t)=>{const s=e.featuresTilingScheme.getClosestInfoForScale(e.scale).level;return t?.levels?t.levels[s]:null})(t,s);return r?new V({field:s.field,minSize:r[2].size,minDataValue:r[2].value,maxSize:r[3].size,maxDataValue:r[3].value}):null}(this.layerView._effectiveRenderer,this.view));if(r&&"visualVariables"in s){const t=s.visualVariables?.some((e=>"size"===e.type&&"outline"!==e.target&&!Le.test(e.valueExpression)));if(!t){if("clusterMinSize"in e&&"clusterMaxSize"in e){const{clusterMinSize:t,clusterMaxSize:s}=e;r.legendOptions=new R({showLegend:t!==s})}const t=s.visualVariables||[];s.visualVariables=t.concat([r]),this._hasClusterSizeVariable=!0}}return s}async _loadRenderer(e){const t=[],s=e.clone(),r=await X(s);if(Te(s)||ze(s)){const e=(s.classBreakInfos||s.uniqueValueInfos).map((e=>this._fetchSymbol(e.symbol,r).then((t=>{e.symbol=t})).catch((()=>{e.symbol=null}))));Array.prototype.push.apply(t,e)}return t.push(this._fetchSymbol(s.symbol||s.defaultSymbol,s.defaultSymbol?null:r).then((e=>{this._applySymbolToRenderer(s,e,Fe(s))})).catch((()=>{this._applySymbolToRenderer(s,null,Fe(s))}))),d(t).then((()=>s))}_applySymbolToRenderer(e,t,s){s?e.symbol=t:e.defaultSymbol=t}async _fetchSymbol(e,t){if(!e)throw new Error;if("web-style"===e.type){const s=this._webStyleSymbolCache;try{const r=await("2d"===this.view.type?e.fetchCIMSymbol({cache:s}):e.fetchSymbol({cache:s}));return this._getAppliedCloneSymbol(r,t)}catch{throw c.getLogger(this.declaredClass).warn("Fetching web-style failed!"),new Error}}return this._getAppliedCloneSymbol(e,t)}_getAppliedCloneSymbol(e,s){if(!e||!s)return e;const r=e.clone(),i=s&&s.toRgba();return r.type.includes("3d")?this._applyColorTo3dSymbol(r,i):"cim"===r.type?F(r,s):r.color&&(r.color=new t(i||r.color)),r}_applyColorTo3dSymbol(e,s){s&&e.symbolLayers.forEach((e=>{e&&(e.material||(e.material={}),e.material.color=new t(s))}))}async _getVisualVariableLegendElements(e,t){if(!("visualVariables"in e)||!e.visualVariables||"vector-field"===e.type)return null;const s=e.visualVariables,r=[],i=[],l=[];for(const e of s)"color"===e.type?r.push(e):"size"===e.type?i.push(e):"opacity"===e.type&&l.push(e);const n=[...r,...i,...l];let o,a;if(0===r.length&&Te(e)&&e.classBreakInfos&&1===e.classBreakInfos.length){const t=e.classBreakInfos[0];o=t&&t.symbol}if(0===r.length&&Fe(e)&&(o=e.symbol),o)if(o.type.includes("3d")){const e=o.symbolLayers.getItemAt(0);"water"===e.type?m(e.color)&&(a=e.color):m(e.material)&&m(e.material.color)&&(a=e.material.color)}else o.url||(a=o.color);const u=this.effectList;return(await Promise.all(n.map((async s=>{if(!s.legendOptions||!1!==s.legendOptions.showLegend){const r=Ee(e)?s.field:this._getRampTitle(s,t);let i=null;const l="getField"in t&&t.getField&&t.getField(s.field),n=l&&E(l);if("color"===s.type){const e=await Y(s,null,n);i={type:"color-ramp",title:r,infos:e,preview:T(e.map((e=>e.color)),{effectList:u})},this._hasColorRamp||(this._hasColorRamp=!(null==i.infos||!i.infos.length))}else if("size"===s.type&&"outline"!==s.target)Le.test(s.valueExpression)?this._hasClusterSizeVariable||(this._scaleDrivenSizeVariable=s):(i=await this._getSizeLegendElement(r,s,e,n),this._hasSizeRamp||(this._hasSizeRamp=!(null==i.infos||!i.infos.length)));else if("opacity"===s.type){const e=await Y(s,a,n);i={type:"opacity-ramp",title:r,infos:e,preview:T(e.map((e=>e.color)),{effectList:u})},this._hasOpacityRamp||(this._hasOpacityRamp=!(null==i.infos||!i.infos.length))}return i&&i.infos?i:null}})))).filter((e=>!!e))}_getDomainName(e,t,s){if(e&&"function"!=typeof e){const r="getField"in s&&s.getField&&s.getField(e),i=r&&"getFieldDomain"in s&&s.getFieldDomain?s.getFieldDomain(r.name):null;return i&&"coded-value"===i.type?i.getName(t):null}return null}_getClusterTitle(e){const t=this.layer,s=e.field;if("featureReduction"in t&&t.featureReduction&&"cluster"===t.featureReduction.type){const e=t.featureReduction,r="popupTemplate"in e&&e.popupTemplate,i=r&&r.fieldInfos;if(i)for(const e of i)if(e.fieldName===s)return"cluster_count"===s?e.label||{showCount:!0}:e.label}return{showCount:!0}}_getRampTitle(e,t){let s=e.field,r=e.normalizationField,i=!1,l=!1,n=!1,o=null;s="function"==typeof s?null:s,r="function"==typeof r?null:r;const a=e.legendOptions&&e.legendOptions.title;if(null!=a)o=a;else if(e.valueExpressionTitle)o=e.valueExpressionTitle;else{if("renderer"in t&&t.renderer&&"authoringInfo"in t.renderer&&t.renderer.authoringInfo&&t.renderer.authoringInfo.visualVariables){const e=t.renderer.authoringInfo.visualVariables;for(let t=0;t<e.length;t++){const s=e[t];if("color"===s.type){if("ratio"===s.style){i=!0;break}if("percent"===s.style){l=!0;break}if("percent-of-total"===s.style){n=!0;break}}}}o={field:s&&this._getFieldAlias(s,t),normField:r&&this._getFieldAlias(r,t),ratio:i,ratioPercent:l,ratioPercentTotal:n}}return o}_getRendererTitle(e,t){const s=e;if(s.legendOptions&&s.legendOptions.title)return s.legendOptions.title;if(s.valueExpressionTitle)return s.valueExpressionTitle;let r=s.field,i=null,l=null;if(Te(s)&&(i=s.normalizationField,l="percent-of-total"===s.normalizationType),r="function"==typeof r?null:r,i="function"==typeof i?null:i,ze(s)){const{field2:e,field3:i,fieldDelimiter:l}=s;let n=r&&this._getFieldAlias(r,t);return e&&(n=`<${n}>${l}<${this._getFieldAlias(e,t)}>`,i&&(n=`${n}${l}<${this._getFieldAlias(i,t)}>`)),n}let n=null;return(r||i)&&(n={field:r&&this._getFieldAlias(r,t),normField:i&&this._getFieldAlias(i,t),normByPct:l}),n}_getFieldAlias(e,t){const s="popupTemplate"in t&&t.popupTemplate,r=s&&s.fieldInfos;let i=null;r&&r.some((t=>e===t.fieldName&&(i=t,!0)));let l=null;"getField"in t&&t.getField?l=t.getField(e):"fieldsIndex"in t&&t.fieldsIndex&&(l=t.fieldsIndex.get(e));let n=null;const o="featureReduction"in t&&t.featureReduction;o&&(!i&&"popupTemplate"in o&&o.popupTemplate&&o.popupTemplate.fieldInfos&&o.popupTemplate.fieldInfos.some((t=>e?.toLowerCase()===t.fieldName?.toLowerCase()&&(i=t,!0))),"fields"in o&&o.fields&&(n=o.fields.find((t=>t.name?.toLowerCase()===e?.toLowerCase()))));const a=i||l||n;let u=null;return a&&(u=i?.label||l?.alias||n?.alias||"name"in a&&a.name||"fieldName"in a&&a.fieldName),u}_isUnclassedRenderer(e){const t=e.visualVariables;let s=!1;return Te(e)&&e.classBreakInfos&&1===e.classBreakInfos.length&&t&&(s=e.field?t.some((t=>!(!t||e.field!==t.field||(e.normalizationField||t.normalizationField)&&e.normalizationField!==t.normalizationField))):!!t.length),s}};e([L()],We.prototype,"children",void 0),e([L({readOnly:!0})],We.prototype,"effectList",null),e([L()],We.prototype,"layerView",void 0),e([L()],We.prototype,"layer",void 0),e([L()],We.prototype,"legendElements",void 0),e([L({readOnly:!0})],We.prototype,"opacity",null),e([L()],We.prototype,"parent",void 0),e([L({readOnly:!0,dependsOn:[]})],We.prototype,"ready",null),e([L()],We.prototype,"hideLayersNotInCurrentView",void 0),e([L()],We.prototype,"keepCacheOnDestroy",void 0),e([L()],We.prototype,"respectLayerVisibility",void 0),e([L({readOnly:!0})],We.prototype,"scale",null),e([L()],We.prototype,"sublayerIds",void 0),e([L({readOnly:!0})],We.prototype,"isScaleDriven",null),e([L()],We.prototype,"title",void 0),e([L({readOnly:!0,dependsOn:["ready"],value:0})],We.prototype,"version",null),e([L()],We.prototype,"view",void 0),We=e([_("esri.widgets.Legend.support.ActiveLayerInfo")],We);const Ge=We;export{Ge as default};
