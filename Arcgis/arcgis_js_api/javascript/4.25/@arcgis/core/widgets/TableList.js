/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import t from"../core/Collection.js";import{e as s}from"../core/promiseUtils.js";import i from"../core/Handles.js";import{watch as o,on as r,initial as n}from"../core/reactiveUtils.js";import{property as l}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import{cast as a}from"../core/accessorSupport/decorators/cast.js";import{subclass as c}from"../core/accessorSupport/decorators/subclass.js";import d from"./Widget.js";import{a as m}from"../chunks/accessibleHandler.js";import{m as h}from"../chunks/messageBundle.js";import{v as u}from"../chunks/vmEvent.js";import{t as p}from"../chunks/jsxFactory.js";import"../chunks/widgetUtils.js";import g from"./TableList/ListItem.js";import b from"./TableList/TableListViewModel.js";import{S as _}from"../chunks/sortable.esm.js";import"../chunks/ArrayPool.js";import"../core/Evented.js";import"../core/Accessor.js";import"../chunks/maybe.js";import"../chunks/get.js";import"../chunks/utils.js";import"../chunks/handleUtils.js";import"../chunks/metadata.js";import"../chunks/object.js";import"../chunks/Logger.js";import"../config.js";import"../chunks/string.js";import"../chunks/tracking.js";import"../chunks/watch.js";import"../core/scheduling.js";import"../chunks/nextTick.js";import"../core/Error.js";import"../chunks/ensureType.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../intl.js";import"../chunks/number.js";import"../chunks/jsonMap.js";import"../chunks/locale.js";import"../chunks/messages.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"../chunks/assets.js";import"../chunks/domUtils.js";import"../core/Promise.js";import"../chunks/uuid.js";import"../chunks/projector.js";import"../chunks/jsxWidgetSupport.js";import"../core/HandleOwner.js";import"../chunks/WatchUpdatingTracking.js";import"../core/Identifiable.js";import"../support/actions/ActionBase.js";import"../support/actions/ActionButton.js";import"../chunks/ActionSlider.js";import"../support/actions/ActionToggle.js";import"../chunks/layerListUtils.js";function y(e,t){const s=e.layer?.uid;return s&&t.find((e=>e.layer?.uid===s))}function f(e,t,s){e.splice(s,0,e.splice(t,1)[0])}const v=t.ofType(g),I={statusIndicators:!0,errors:!1};let j=class extends d{constructor(e,t){super(e,t),this._handles=new i,this._sortable=null,this._sortableNode=null,this._focusSortUid=null,this.visibleItems=null,this.iconClass="esri-icon-table",this.messages=null,this.messagesCommon=null,this.multipleSelectionEnabled=!1,this.selectionEnabled=!1,this.selectedItems=new v,this.viewModel=new b,this.visibleElements={...I}}initialize(){this._setVisibleItems(this.tableItems),this.addHandles([o((()=>this.visibleElements),(()=>this._itemsChanged())),r((()=>this.viewModel.tableItems),"change",(()=>this._itemsChanged())),o((()=>this.selectionEnabled),(()=>this._toggleSorting()),n)])}destroy(){this._destroySortable(),this._handles.destroy(),this._handles=null}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get listItemCreatedFunction(){return this.viewModel.listItemCreatedFunction}set listItemCreatedFunction(e){this.viewModel.listItemCreatedFunction=e}get map(){return this.viewModel.map}set map(e){this.viewModel.map=e}get tableItems(){return this.viewModel.tableItems}castVisibleElements(e){return{...I,...e}}triggerAction(e,t){return this.viewModel.triggerAction(e,t)}render(){const{visibleItems:e}=this,t=this.viewModel?.state,s={"esri-hidden":"loading"===t,"esri-disabled":"disabled"===t};return p("div",{class:this.classes("esri-table-list","esri-widget","esri-widget--panel",s)},e?.length?this.renderList():this.renderNoItems())}renderNoItems(){return p("div",{class:"esri-table-list__no-items"},this.messages.noItemsToDisplay)}renderList(){const{visibleItems:e,messages:t,selectionEnabled:s}=this;return p("ul",{"aria-label":t.widgetLabel,role:s?"listbox":void 0,afterCreate:this._sortNodeCreated,afterRemoved:this._destroySortable,"data-node-ref":"_sortableNode",bind:this,class:this.classes("esri-table-list__list","esri-table-list__list--root")},e.map((e=>this.renderItem(e))).toArray())}renderItem(e){const{id:t,selectionEnabled:s,selectedItems:i}=this,o=`${t}_${e.uid}__title`,r={"esri-table-list__item--has-message":!!this._hasMessage(e),"esri-table-list__item--selectable":s};if(s){const t={"data-layer-uid":e.layer?.uid};return p("li",{key:`item-with-selection-${e.uid}`,bind:this,afterCreate:this._focusListItem,afterUpdate:this._focusListItem,class:this.classes("esri-table-list__item",r),"aria-labelledby":o,onclick:this._toggleSelection,onkeydown:this._selectionKeydown,"data-item":e,tabIndex:0,"aria-selected":y(e,i)?"true":"false",role:"option",...t},this.renderItemContent(e,o))}return p("li",{key:`item-no-selection-${e.uid}`,bind:this,afterCreate:this._focusListItem,afterUpdate:this._focusListItem,class:this.classes("esri-table-list__item",r),"aria-labelledby":o},this.renderItemContent(e,o))}renderActionsMenuIcon(e,t){const{messagesCommon:s}=this,i={"esri-table-list__item-actions-menu-item--active":e.actionsOpen};return p("div",{key:"actions-menu-toggle","data-item":e,bind:this,onclick:this._toggleActionsOpen,onkeydown:this._toggleActionsOpen,class:this.classes("esri-table-list__item-actions-menu-item",i),tabindex:"0",role:"button","aria-controls":t,"aria-label":s.options,title:s.options},p("span",{"aria-hidden":"true",class:"esri-icon-handle-horizontal"}))}renderActionsMenu(e,t,s,i){const o=1===s&&this._getSingleActionButton(t),r=o?this.renderAction({item:e,action:o,singleAction:!0}):null,n=!o&&s?this.renderActionsMenuIcon(e,i):null;return n||o?p("div",{key:"actions-menu",class:"esri-table-list__item-actions-menu"},r,n):null}renderItemMessage(e){return e.error?p("div",{key:"esri-table-list__error",class:"esri-table-list__item-message",role:"alert"},p("span",{"aria-hidden":"true",class:"esri-icon-notice-triangle"}),this.messages.tableError):null}renderItemStatus(e){const{visibleElements:t}=this;if(!t.statusIndicators)return null;const{publishing:s}=e;return p("span",{class:this.classes({"esri-table-list__publishing":s}),key:"layer-item-status"})}renderItemContent(e,t){const{id:s}=this,i=`${s}_${e.uid}_actions`,o=this._filterActions(e.actionsSections),r=this._countActions(o);return[p("div",{key:"list-item-container",class:"esri-table-list__item-container"},this.renderTitle(e,t),this.renderItemStatus(e),this.renderActionsMenu(e,o,r,i)),this.renderItemMessage(e),r?this.renderActionsSections(e,o,i):null]}renderTitle(e,t){const{messages:s}=this,i=e.title||s.untitledTable;return p("span",{key:"layer-title-container",id:t,class:"esri-table-list__item-title"},i)}renderActionsSections(e,t,s){const i=t.toArray().map(((t,s)=>p("ul",{key:`${e}-action-section-${s}`,class:"esri-table-list__item-actions-list"},this.renderActionSection(e,t))));return p("div",{role:"group","aria-expanded":e.actionsOpen?"true":"false",key:"actions-section",id:s,class:"esri-table-list__item-actions",hidden:!e.actionsOpen||null},i)}renderActionSection(e,t){return(t&&t.toArray()).map((t=>this.renderAction({item:e,action:t})))}renderActionIcon(e){const{active:t,className:s}=e,i=this._getIconImageStyles(e),o="button"!==e.type||e.image||s?s:"esri-icon-default-action",r={"esri-table-list__item-action-image":!t&&!!i["background-image"],"esri-icon-loading-indicator":t,"esri-rotating":t};return o&&!t&&(r[o]=!0),p("span",{key:"action-icon","aria-hidden":"true",class:this.classes("esri-table-list__item-action-icon",r),styles:i})}renderActionTitle(e,t){return t?null:p("span",{key:"action-title",class:"esri-table-list__item-action-title"},e)}renderAction(e){const{item:t,action:s,singleAction:i}=e,{active:o,disabled:r,title:n}=s,l={"esri-table-list__item-actions-menu-item":i&&"button"===s.type,"esri-table-list__item-action":o||!i&&"toggle"!==s.type,"esri-table-list__action-toggle":!o&&"toggle"===s.type,"esri-table-list__action-toggle--on":!o&&"toggle"===s.type&&s.value,"esri-disabled-element":r},a=[this.renderActionIcon(s),this.renderActionTitle(n,i)];return i?p("div",{bind:this,"data-item":t,"data-action":s,role:"button",key:`single-action-${s.uid}`,onclick:this._triggerAction,onkeydown:this._triggerAction,classes:l,tabindex:"0",title:n,"aria-label":n},a):p("li",{bind:this,"data-item":t,"data-action":s,key:`action-${s.uid}`,onclick:this._triggerAction,onkeydown:this._triggerAction,classes:l,tabindex:"0",role:"button",title:n,"aria-label":n},a)}_hasMessage(e){return!!e.error}_filterActions(e){return e.map((e=>e.filter((e=>e.visible))))}_setVisibleItems(e){this.visibleItems=e?.filter((e=>!e.hidden&&(this.visibleElements.errors||!e.error)))}_destroySortable(){const{_sortable:e}=this;e&&e.destroy(),this._sortable=null}_toggleSorting(){const{_sortable:e,_sortableNode:t,selectionEnabled:s}=this;if(t)if(e)e.option("disabled",!s);else{const e=_.create(t,{dataIdAttr:"data-layer-uid",group:"root-tables",fallbackTolerance:4,disabled:!s,onSort:()=>this._sortTablesToItems(e.toArray()),chosenClass:"esri-table-list__item--chosen"});this._sortable=e}}_sortNodeCreated(e){this._sortableNode=e,this._toggleSorting()}_sortTablesToItems(e){const t=this.map?.tables;t&&t.sort(((t,s)=>{const i=e.indexOf(t.uid),o=e.indexOf(s.uid);return i>o?-1:i<o?1:0}))}_getSingleActionButton(e){return e.reduce((e=>e)).filter((e=>e&&"button"===e.type)).getItemAt(0)}_focusListItem(e){const{_focusSortUid:t}=this;e&&t&&e["data-item"].layer?.uid===t&&(e.focus(),this._focusSortUid=null)}_watchActionSectionChanges(e,t){const s="action-section"+t;this._handles.add(e.on("change",(()=>this.scheduleRender())),s),e.forEach((e=>this._renderOnActionChanges(e,t)))}_renderOnActionChanges(e,t){const s="actions"+t,i=()=>this.scheduleRender();"toggle"!==e.type?"slider"!==e.type?this._handles.add([o((()=>[e.className,e.image,e.id,e.title,e.visible]),i,n)],s):this._handles.add([o((()=>[e.className,e.id,e.title,e.visible,e.value,e.displayValueEnabled,e.max,e.min,e.step]),i,n)],s):this._handles.add([o((()=>[e.className,e.image,e.id,e.title,e.visible,e.value]),i,n)],s)}_renderOnItemChanges(e){const t=e.uid,s="items"+t,i=()=>this.scheduleRender();this._handles.add([o((()=>[e.actionsOpen,e.title,e.error,e.publishing]),i,n),o((()=>[e.hidden,e.error]),(()=>this._setVisibleItems(this.tableItems))),e.actionsSections.on("change",i)],s),e.actionsSections.forEach((e=>this._watchActionSectionChanges(e,t)))}_itemsChanged(){const{tableItems:e}=this.viewModel;this._setVisibleItems(e),this._handles.removeAll(),e.forEach((e=>this._renderOnItemChanges(e))),this.scheduleRender()}_countActions(e){return e.reduce(((e,t)=>e+t.length),0)}_getIconImageStyles(e){const t="esri.support.Action.ActionButton"===e.declaredClass||"esri.support.Action.ActionToggle"===e.declaredClass?e.image:null;return{"background-image":t?`url("${t}")`:null}}_selectionKeydown(e){const t=s(e);if(!["ArrowDown","ArrowUp"].includes(t))return void this._toggleSelection(e);e.stopPropagation();const i=e.currentTarget["data-item"],{_sortable:o,selectedItems:r}=this,n=y(i,r),l=o.toArray(),a=e.target,c=l.indexOf(a.dataset.layerUid);if(-1!==c){if("ArrowDown"===t){const e=c+1;if(e>=l.length)return;n?(f(l,c,e),o.sort(l),this._sortTablesToItems(o.toArray()),this._focusSortUid=i.layer?.uid):(this._focusSortUid=i.layer?.uid,this.scheduleRender())}if("ArrowUp"===t){const e=c-1;if(e<=-1)return;n?(f(l,c,e),o.sort(l),this._sortTablesToItems(o.toArray()),this._focusSortUid=i.layer?.uid):(this._focusSortUid=i.layer?.uid,this.scheduleRender())}}}_toggleActionsOpen(e){const t=e.currentTarget["data-item"],{actionsOpen:s}=t,i=!s;i&&this.tableItems.forEach((e=>function(e){const{actionsOpen:t}=e;t&&(e.actionsOpen=!1)}(e))),t.actionsOpen=i,e.stopPropagation()}_triggerAction(e){const t=e.currentTarget,s=t["data-action"],i=t["data-item"];"toggle"===s.type&&(s.value=!s.value),this.triggerAction(s,i),e.stopPropagation()}_toggleSelection(e){e.stopPropagation();const{multipleSelectionEnabled:t,selectedItems:s}=this,i=t&&(e.metaKey||e.ctrlKey),o=e.currentTarget["data-item"],r=y(o,s),{length:n}=s;if(!i)return!n||r&&1===n?void(r?s.remove(r):s.add(o)):(s.removeAll(),void s.add(o));r?s.remove(r):s.add(o)}};e([l()],j.prototype,"visibleItems",void 0),e([l()],j.prototype,"iconClass",void 0),e([l()],j.prototype,"label",null),e([l()],j.prototype,"listItemCreatedFunction",null),e([l()],j.prototype,"map",null),e([l(),h("esri/widgets/TableList/t9n/TableList")],j.prototype,"messages",void 0),e([l(),h("esri/t9n/common")],j.prototype,"messagesCommon",void 0),e([l()],j.prototype,"multipleSelectionEnabled",void 0),e([l()],j.prototype,"selectionEnabled",void 0),e([l()],j.prototype,"selectedItems",void 0),e([l({readOnly:!0})],j.prototype,"tableItems",null),e([u("trigger-action"),l({type:b})],j.prototype,"viewModel",void 0),e([l()],j.prototype,"visibleElements",void 0),e([a("visibleElements")],j.prototype,"castVisibleElements",null),e([m()],j.prototype,"_toggleActionsOpen",null),e([m()],j.prototype,"_triggerAction",null),e([m()],j.prototype,"_toggleSelection",null),j=e([c("esri.widgets.TableList")],j);const A=j;export{A as default};
