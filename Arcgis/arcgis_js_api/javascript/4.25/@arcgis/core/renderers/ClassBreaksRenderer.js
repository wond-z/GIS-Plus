/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as s}from"../chunks/tslib.es6.js";import{ensureType as o}from"../symbols.js";import{J as t}from"../chunks/jsonMap.js";import{clone as e}from"../core/lang.js";import{L as i}from"../chunks/Logger.js";import{a as r,e as l,u as a}from"../chunks/maybe.js";import{property as n}from"../core/accessorSupport/decorators/property.js";import{cast as p}from"../core/accessorSupport/decorators/cast.js";import{e as m}from"../chunks/enumeration.js";import{r as u}from"../chunks/reader.js";import{subclass as c}from"../core/accessorSupport/decorators/subclass.js";import{w as h}from"../chunks/writer.js";import{e as y,k as j,l as d}from"../chunks/ensureType.js";import{collectArcadeFieldNames as b,collectField as f}from"../layers/support/fieldUtils.js";import k from"./Renderer.js";import{VisualVariablesMixin as g}from"./mixins/VisualVariablesMixin.js";import S from"./support/ClassBreakInfo.js";import{r as I,a as x}from"../chunks/commonProperties2.js";import{L as v}from"../chunks/LegendOptions.js";import{l as B}from"../chunks/arcadeOnDemand.js";import"../symbols/CIMSymbol.js";import"../chunks/string.js";import"../chunks/object.js";import"../symbols/Symbol.js";import"../Color.js";import"../chunks/colorUtils.js";import"../chunks/mathUtils.js";import"../chunks/vec3.js";import"../chunks/common.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"../chunks/get.js";import"../chunks/utils.js";import"../chunks/handleUtils.js";import"../chunks/metadata.js";import"../chunks/ArrayPool.js";import"../chunks/tracking.js";import"../chunks/watch.js";import"../core/scheduling.js";import"../chunks/nextTick.js";import"../core/promiseUtils.js";import"../core/Error.js";import"../config.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"../chunks/utils2.js";import"../symbols/edges/Edges3D.js";import"../chunks/screenUtils.js";import"../chunks/materialUtils.js";import"../chunks/opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"../chunks/Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"../chunks/lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"../chunks/utils3.js";import"../chunks/colors.js";import"../chunks/symbolLayerUtils3D.js";import"../chunks/aaBoundingBox.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../geometry/SpatialReference.js";import"../geometry/Point.js";import"../geometry/support/webMercatorUtils.js";import"../chunks/Ellipsoid.js";import"../chunks/aaBoundingRect.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../core/urlUtils.js";import"../chunks/persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../core/Collection.js";import"../core/Evented.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../symbols/Symbol3D.js";import"../chunks/collectionUtils.js";import"../portal/Portal.js";import"../kernel.js";import"../request.js";import"../core/Loadable.js";import"../core/Promise.js";import"../chunks/locale.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../core/Clonable.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"../chunks/Thumbnail.js";import"../chunks/calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"../chunks/urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"../geometry.js";import"../geometry/Multipoint.js";import"../chunks/zmUtils.js";import"../geometry/Polygon.js";import"../chunks/extentUtils.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../geometry/support/jsonUtils.js";import"./support/AuthoringInfo.js";import"./support/AuthoringInfoVisualVariable.js";import"../chunks/colorRamps.js";import"../rest/support/AlgorithmicColorRamp.js";import"../rest/support/ColorRamp.js";import"../rest/support/MultipartColorRamp.js";import"./visualVariables/ColorVariable.js";import"./visualVariables/VisualVariable.js";import"./visualVariables/support/ColorStop.js";import"./visualVariables/OpacityVariable.js";import"./visualVariables/support/OpacityStop.js";import"./visualVariables/RotationVariable.js";import"./visualVariables/SizeVariable.js";import"./visualVariables/support/SizeStop.js";import"../chunks/sizeVariableUtils.js";import"../chunks/visualVariableUtils.js";import"../Graphic.js";import"../PopupTemplate.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"../chunks/date.js";import"../chunks/number.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"../chunks/chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../chunks/compilerUtils.js";import"../chunks/lengthUtils.js";import"../chunks/unitUtils.js";import"../chunks/projectionEllipsoid.js";import"../symbols/support/jsonUtils.js";import"../chunks/symbolConversion.js";var V;const C=new t({esriNormalizeByLog:"log",esriNormalizeByPercentOfTotal:"percent-of-total",esriNormalizeByField:"field"}),F=y(S);let E=V=class extends(g(k)){constructor(s){super(s),this._compiledValueExpression={valueExpression:null,compiledFunction:null},this.backgroundFillSymbol=null,this.classBreakInfos=null,this.defaultLabel=null,this.defaultSymbol=null,this.field=null,this.isMaxInclusive=!0,this.legendOptions=null,this.normalizationField=null,this.normalizationTotal=null,this.type="class-breaks",this.valueExpression=null,this.valueExpressionTitle=null,this._set("classBreakInfos",[])}readClassBreakInfos(s,o,t){if(!Array.isArray(s))return;let e=o.minValue;return s.map((s=>{const o=new S;return o.read(s,t),null==o.minValue&&(o.minValue=e),null==o.maxValue&&(o.maxValue=o.minValue),e=o.maxValue,o}))}writeClassBreakInfos(s,o,t,e){const i=s.map((s=>s.write({},e)));this._areClassBreaksConsecutive()&&i.forEach((s=>delete s.classMinValue)),o[t]=i}castField(s){return null==s?s:"function"==typeof s?(i.getLogger(this.declaredClass).error(".field: field must be a string value"),null):j(s)}get minValue(){return this.classBreakInfos&&this.classBreakInfos[0]&&this.classBreakInfos[0].minValue||0}get normalizationType(){let s=this._get("normalizationType");const o=!!this.normalizationField,t=null!=this.normalizationTotal;return o||t?(s=(o?"field":t&&"percent-of-total")||null,o&&t&&i.getLogger(this.declaredClass).warn("warning: both normalizationField and normalizationTotal are set!")):"field"!==s&&"percent-of-total"!==s||(s=null),s}set normalizationType(s){this._set("normalizationType",s)}addClassBreakInfo(s,t,i){let r=null;r="number"==typeof s?new S({minValue:s,maxValue:t,symbol:o(i)}):F(e(s)),this.classBreakInfos.push(r),1===this.classBreakInfos.length&&this.notifyChange("minValue")}removeClassBreakInfo(s,o){const t=this.classBreakInfos.length;for(let e=0;e<t;e++){const t=[this.classBreakInfos[e].minValue,this.classBreakInfos[e].maxValue];if(t[0]===s&&t[1]===o){this.classBreakInfos.splice(e,1);break}}}getBreakIndex(s,o){return this.valueExpression&&(r(o)||r(o.arcade))&&i.getLogger(this.declaredClass).warn(""),this.valueExpression?this._getBreakIndexForExpression(s,o):this._getBreakIndexForField(s)}async getClassBreakInfo(s,o){let t=o;this.valueExpression&&(r(o)||r(o.arcade))&&(t={...t,arcade:await B()});const e=this.getBreakIndex(s,t);return-1!==e?this.classBreakInfos[e]:null}getSymbol(s,o){if(this.valueExpression&&(r(o)||r(o.arcade)))return void i.getLogger(this.declaredClass).error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const t=this.getBreakIndex(s,o);return t>-1?this.classBreakInfos[t].symbol:this.defaultSymbol}async getSymbolAsync(s,o){let t=o;if(this.valueExpression&&(r(o)||r(o.arcade))){const s=await B(),{arcadeUtils:o}=s;o.hasGeometryOperations(this.valueExpression)&&await o.enableGeometryOperations(),t={...t,arcade:s}}const e=this.getBreakIndex(s,t);return e>-1?this.classBreakInfos[e].symbol:this.defaultSymbol}getSymbols(){const s=[];return this.classBreakInfos.forEach((o=>{o.symbol&&s.push(o.symbol)})),this.defaultSymbol&&s.push(this.defaultSymbol),s}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce(((s,o)=>s+o.getAttributeHash()),"")}getMeshHash(){const s=JSON.stringify(this.backgroundFillSymbol),o=JSON.stringify(this.defaultSymbol),t=`${this.normalizationField}.${this.normalizationType}.${this.normalizationTotal}`;return`${s}.${o}.${this.classBreakInfos.reduce(((s,o)=>s+o.getMeshHash()),"")}.${t}.${this.field}.${this.valueExpression}`}get arcadeRequired(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}clone(){return new V({field:this.field,backgroundFillSymbol:this.backgroundFillSymbol&&this.backgroundFillSymbol.clone(),defaultLabel:this.defaultLabel,defaultSymbol:this.defaultSymbol&&this.defaultSymbol.clone(),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,classBreakInfos:e(this.classBreakInfos),isMaxInclusive:this.isMaxInclusive,normalizationField:this.normalizationField,normalizationTotal:this.normalizationTotal,normalizationType:this.normalizationType,visualVariables:e(this.visualVariables),legendOptions:e(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})}async collectRequiredFields(s,o){const t=[this.collectVVRequiredFields(s,o),this.collectSymbolFields(s,o)];await Promise.all(t)}async collectSymbolFields(s,o){const t=[...this.getSymbols().map((t=>t.collectRequiredFields(s,o))),b(s,o,this.valueExpression)];f(s,o,this.field),f(s,o,this.normalizationField),await Promise.all(t)}_getBreakIndexForExpression(s,o){const{viewingMode:t,scale:e,spatialReference:i,arcade:r}=l(o,{}),{valueExpression:n}=this;let p=this._compiledValueExpression.valueExpression===n?this._compiledValueExpression.compiledFunction:null;const m=a(r).arcadeUtils;if(!p){const s=m.createSyntaxTree(n);p=m.createFunction(s),this._compiledValueExpression.compiledFunction=p}this._compiledValueExpression.valueExpression=n;const u=m.executeFunction(p,m.createExecContext(s,m.getViewInfo({viewingMode:t,scale:e,spatialReference:i})));return this._getBreakIndexfromInfos(u)}_getBreakIndexForField(s){const o=this.field,t=s.attributes,e=this.normalizationType;let i=parseFloat(t[o]);if(e){const s=this.normalizationTotal,o=parseFloat(this.normalizationField?t[this.normalizationField]:void 0);if("log"===e)i=Math.log(i)*Math.LOG10E;else if("percent-of-total"!==e||null==s||isNaN(s)){if("field"===e&&!isNaN(o)){if(isNaN(i)||isNaN(o))return-1;i/=o}}else i=i/s*100}return this._getBreakIndexfromInfos(i)}_getBreakIndexfromInfos(s){const o=this.isMaxInclusive;if(null!=s&&"number"==typeof s&&!isNaN(s))for(let t=0;t<this.classBreakInfos.length;t++){const e=[this.classBreakInfos[t].minValue,this.classBreakInfos[t].maxValue];if(e[0]<=s&&(o?s<=e[1]:s<e[1]))return t}return-1}_areClassBreaksConsecutive(){const s=this.classBreakInfos,o=s.length;for(let t=1;t<o;t++)if(s[t-1].maxValue!==s[t].minValue)return!1;return!0}};s([n(I)],E.prototype,"backgroundFillSymbol",void 0),s([n({type:[S]})],E.prototype,"classBreakInfos",void 0),s([u("classBreakInfos")],E.prototype,"readClassBreakInfos",null),s([h("classBreakInfos")],E.prototype,"writeClassBreakInfos",null),s([n({type:String,json:{write:!0}})],E.prototype,"defaultLabel",void 0),s([n(x)],E.prototype,"defaultSymbol",void 0),s([n({type:String,json:{write:!0}})],E.prototype,"field",void 0),s([p("field")],E.prototype,"castField",null),s([n({type:Boolean})],E.prototype,"isMaxInclusive",void 0),s([n({type:v,json:{write:!0}})],E.prototype,"legendOptions",void 0),s([n({type:Number,readOnly:!0,value:null,json:{read:!1,write:{overridePolicy(){return 0!==this.classBreakInfos.length&&this._areClassBreaksConsecutive()?{enabled:!0}:{enabled:!1}}}}})],E.prototype,"minValue",null),s([n({type:String,json:{write:!0}})],E.prototype,"normalizationField",void 0),s([n({type:Number,cast:s=>d(s),json:{write:!0}})],E.prototype,"normalizationTotal",void 0),s([n({type:C.apiValues,value:null,json:{type:C.jsonValues,read:C.read,write:C.write}})],E.prototype,"normalizationType",null),s([m({classBreaks:"class-breaks"})],E.prototype,"type",void 0),s([n({type:String,json:{write:!0}})],E.prototype,"valueExpression",void 0),s([n({type:String,json:{write:!0}})],E.prototype,"valueExpressionTitle",void 0),E=V=s([c("esri.renderers.ClassBreaksRenderer")],E);const M=E;export{M as default};
