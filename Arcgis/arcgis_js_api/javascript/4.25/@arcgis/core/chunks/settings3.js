/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import e from"../Color.js";import{t,c as s}from"./colorUtils2.js";import{a as i}from"./vec4f64.js";import"./object.js";import r from"../core/Handles.js";import{i as l,u as n,a as o,e as a}from"./maybe.js";import{watch as h}from"../core/reactiveUtils.js";import{d,f as c,c as p,b as u,j as _,D as f}from"./vec3.js";import{e as m,b as g}from"./mathUtils.js";import{f as w,c as C}from"./vec4f32.js";import{c as y,f as O,a as x,g as b,b as A}from"./frustum.js";import{c as R,f as E,p as P}from"./lineSegment.js";import{c as W,i as D}from"./ray.js";import{L as j}from"./LaserlineVisualElement.js";import{O as S}from"./Object3DVisualElement.js";import{c as v}from"./GeometryUtil.js";import{R as G}from"./Material.js";import{V as T}from"./VertexAttribute.js";import{R as M}from"./DefaultBufferWriter.js";import{c as F}from"./lineStippleUtils.js";class U extends S{constructor(e){super(e),this._ray=W(),this._externalResources=null,this._handles=new r,this._isWorldDown=!1,this._start=d(),this._end=c(1,0,0),this._width=1,this._color=w(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=w(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._stipplePreferContinuous=!0,this._falloff=0,this._extensionType=Y.LINE,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=G.OccludeAndTransparent,this._fadedExtensions=B,this.applyProps(e)}createExternalResources(){const e=new M(this.materialParameters);this._handles.add(h((()=>this.view.state.camera),(()=>{this._updateGeometry()})));const t=new j({view:this.view,attached:this._laserlineEnabled});this._externalResources={material:e,laserline:t}}destroyExternalResources(){l(this._externalResources)&&this._externalResources.laserline.destroy(),this._externalResources=null,this._handles.removeAll()}forEachExternalMaterial(e){l(this._externalResources)&&e(this._externalResources.material)}createGeometries(e){const t=[d(),d()],s=this.extensionType===Y.FADED;s&&t.push(d(),d());const i=s?new Float32Array([1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]):null,r=v(t,null,i);e.addGeometry(r,n(this._externalResources).material),this._updateVertices(e)}updateVisibility(e){super.updateVisibility(e),l(this._externalResources)&&(this._externalResources.laserline.visible=e)}setStartEndFromWorldDownAtLocation(e){this._isWorldDown=!0,p(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),u(this._end,e,this._end),D(this._start,this._end,this._ray),this._updateGeometry()}get start(){return this._start}set start(e){this._isWorldDown=!1,_(this._start,e)||(p(this._start,e),D(this._start,this._end,this._ray),this._updateGeometry())}get end(){return this._end}set end(e){this._isWorldDown=!1,_(this._end,e)||(p(this._end,e),D(this._start,this._end,this._ray),this._updateGeometry())}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){m(e,this._color)||(g(this._color,e),this._updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this._updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){m(e,this._innerColor)||(g(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const t=l(e)!==l(this._stipplePattern);this._stipplePattern=e,t?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){(o(e)||o(this._stippleOffColor)||!m(e,this._stippleOffColor))&&(this._stippleOffColor=l(e)?C(e):null,this._updateMaterial())}get stipplePreferContinuous(){return this._stipplePreferContinuous}set stipplePreferContinuous(e){e!==this._stipplePreferContinuous&&(this._stipplePreferContinuous=e,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get extensionType(){return this._extensionType}set extensionType(e){e!==this._extensionType&&(this._extensionType=e,this._updateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&l(this._laserlineStyle)}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,l(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached,l(e)&&(this._externalResources.laserline.style=e))}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,l(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached))}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(e){this._fadedExtensions=a(e,B),this.recreateGeometry()}_updateMaterial(){o(this._externalResources)||this._externalResources.material.setParameters(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:this._stipplePreferContinuous,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,hasPolygonOffset:this._polygonOffset,renderOccluded:this._renderOccluded,writeDepth:this._writeDepthEnabled}}_updateGeometry(){l(this.object)&&this._updateVertices(this.object)}_updateVertices(e){const t=this._extensionType===Y.FADED?this._updateLineSegmentFinite(N):this._updateLineSegmentInfinite(this._extensionType,N);this._updateVertexAttributes(e,t),l(this._externalResources)&&(this._externalResources.laserline.intersectsLine=t)}_updateLineSegmentFinite(e){return E(this._start,this._end,e)}_updateLineSegmentInfinite(e,t){const s=this.view.state.camera;switch(O(this._ray,L),e){case Y.LINE:L.c0=-Number.MAX_VALUE;break;case Y.RAY:case Y.GROUND_RAY:{const e=this._ray.origin,t=a(this.view.elevationProvider.getElevation(e[0],e[1],e[2],this.view.renderCoordsHelper.spatialReference,"ground"),0),s=this.view.renderCoordsHelper.getAltitude(e);this._isWorldDown&&s<t&&f(L.ray.direction,L.ray.direction),this._extensionType===Y.GROUND_RAY&&null!=t&&(L.c1=Math.abs(s-t));break}}if(!x(s.frustum,L))return E(this._start,this._end,t);const i=b(L,V),r=A(L,z);return E(i,r,t)}_updateVertexAttributes(e,t){const s=e.geometries[0].getMutableAttribute(T.POSITION).data;if(this.extensionType===Y.FADED){const e=P(t,-this.fadedExtensions.start,V);s[0]=e[0],s[1]=e[1],s[2]=e[2];const i=P(t,0,V);s[3]=i[0],s[4]=i[1],s[5]=i[2];const r=P(t,1,V);s[6]=r[0],s[7]=r[1],s[8]=r[2];const l=P(t,1+this.fadedExtensions.end,V);s[9]=l[0],s[10]=l[1],s[11]=l[2]}else{const e=P(t,0,V);s[0]=e[0],s[1]=e[1],s[2]=e[2];const i=P(t,1,V);s[3]=i[0],s[4]=i[1],s[5]=i[2]}e.geometryVertexAttrsUpdated(e.geometryRecords[0])}}const L=y(),V=d(),z=d(),N=R();var Y;!function(e){e[e.LINE=0]="LINE",e[e.RAY=1]="RAY",e[e.GROUND_RAY=2]="GROUND_RAY",e[e.FADED=3]="FADED"}(Y||(Y={}));const B={start:.3333333333333333,end:.3333333333333333},I={main:new e([255,127,0]),selected:new e([255,255,255]),staged:new e([12,207,255]),outline:new e([0,0,0,.5]),selectedOutline:new e([255,255,255])};function H(e,t){const s=e.clone();return s.a*=t,s}function q(e,i){const r=e.clone(),l=t(r);l.s*=i;const n=s(l);return r.r=n.r,r.g=n.g,r.b=n.b,r}function k(e,t){if(t)for(const s in t)e[s]=t[s]}class X{constructor(e){this.color=I.main,this.height=90,this.coneHeight=40,this.coneWidth=23,this.width=3,this.renderOccluded=G.Opaque,k(this,e)}}class J{constructor(e){this.size=11,this.outlineSize=1,this.collisionPadding=9,this.color=I.main,this.outlineColor=I.outline,this.renderOccluded=G.Opaque,this.hoverOutlineColor=I.selectedOutline,k(this,e)}apply(e,t){const s=this[e];t.setParameters({color:le(s),transparent:"color"!==e||s.a<1,renderOccluded:this.renderOccluded})}}class K{constructor(e){this.size=40,this.height=.2,this.offset=.25,this.collisionPadding=2,this.color=H(I.main,.5),this.hoverColor=I.main,this.renderOccluded=G.Transparent,this.minSquaredEdgeLength=900,k(this,e)}apply(e,t){const s=this[e];t.setParameters({color:le(s),transparent:s.a<1,renderOccluded:this.renderOccluded})}}class Q{constructor(e){this.vertex=new J({color:I.main,outlineColor:I.outline}),this.edge=new J({color:q(H(I.main,2/3),.5),outlineColor:H(I.outline,.5),size:8,collisionPadding:8}),this.selected=new J({color:I.selected,outlineColor:I.outline}),this.edgeOffset=new K,k(this,e)}}class Z{constructor(e){this.color=I.selected,this.width=1.5,this.stipplePattern=F(5),this.stippleOffColor=I.outline,this.falloff=0,this.innerWidth=1.5,this.innerColor=I.selected,this.renderOccluded=G.OccludeAndTransparent,k(this,e)}apply(e){e.color=le(this.color),e.width=this.width,e.stipplePattern=this.stipplePattern,e.stippleOffColor=le(this.stippleOffColor),e.falloff=this.falloff,e.innerWidth=this.innerWidth,e.innerColor=le(this.innerColor),e.renderOccluded=this.renderOccluded}}class ${constructor(e){this.color=I.selected,this.size=4,this.outlineSize=1,this.outlineColor=I.outline,this.shape="square",k(this,e)}apply(e){e.color=le(this.color),e.size=this.size,e.outlineSize=this.outlineSize,e.outlineColor=le(this.outlineColor),e.primitive=this.shape}}class ee{constructor(e){this.innerColor=I.selected,this.innerWidth=1,this.glowColor=I.main,this.glowWidth=8,this.glowFalloff=8,this.globalAlpha=.3,this.globalAlphaContrastBoost=1.5,this.radius=3,this.heightFillColor=I.main,k(this,e)}apply(t,s=1){const i={glowColor:e.toUnitRGB(this.glowColor),glowFalloff:this.glowFalloff,glowWidth:this.glowWidth,innerColor:e.toUnitRGB(this.innerColor),innerWidth:this.innerWidth,globalAlpha:this.globalAlpha*s,globalAlphaContrastBoost:this.globalAlphaContrastBoost,intersectsLineRadius:this.radius};"style"in t?t.style=i:t.laserlineStyle=i}}class te{constructor(e){this.outline=new Z({color:I.outline,renderOccluded:G.OccludeAndTransparentStencil,stippleOffColor:I.selected,stipplePattern:F(5),width:1.5,innerWidth:0}),this.staged=new Z({color:I.selected,renderOccluded:G.OccludeAndTransparentStencil,innerColor:I.staged,stippleOffColor:I.outline,stipplePattern:F(5),width:1.5}),this.shadowStyle=new ee({globalAlpha:.3,glowColor:I.main,glowFalloff:8,glowWidth:8,innerColor:I.selected,innerWidth:1}),k(this,e)}}class se{constructor(e){this.outline=new $({color:I.selected,outlineColor:I.outline,outlineSize:1,shape:"circle",size:4}),this.shadowStyle=new ee({globalAlpha:.3,glowColor:I.main,glowFalloff:1.5,glowWidth:6,innerColor:I.selected,innerWidth:1,radius:2}),k(this,e)}}class ie extends Z{constructor(e){super(),this.extensionType=Y.GROUND_RAY,k(this,e)}}class re{constructor(e){this.lineGraphics=new te,this.pointGraphics=new se,this.heightPlane=new ee({globalAlpha:.3,glowColor:I.main,glowFalloff:8,glowWidth:8,innerColor:I.selected,innerWidth:1}),this.heightBox=new ee({globalAlpha:.3,glowColor:I.main,glowFalloff:8,glowWidth:8,innerColor:I.selected,innerWidth:0,heightFillColor:I.main}),this.zVerticalLine=new ie({color:H(I.main,.5),falloff:2,innerColor:H(I.selected,0),renderOccluded:G.OccludeAndTransparent,stipplePattern:null,width:5,extensionType:Y.GROUND_RAY}),this.laserlineAlphaMultiplier=1.5,this.heightPlaneAngleCutoff=20,k(this,e)}}function le(t){return i(e.toUnitRGBA(t))}const ne=new class{constructor(e){this.visualElements=new re,this.reshapeManipulators=new Q,this.zManipulator=new X,k(this,e)}colorToVec4(e){return le(e)}};export{U as E,Y as a,I as c,ne as s};
