/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{O as e,A as t}from"./ArrayPool.js";import{equals as s,equalsShallow as n}from"../core/lang.js";import{n as r,i as o}from"./maybe.js";import{schedule as i}from"../core/scheduling.js";import{v as l}from"./get.js";import{r as u}from"./tracking.js";import{p as c,o as a}from"./utils.js";class d extends e{constructor(){super(...arguments),this._set=new Set}destroy(){super.destroy(),this._set=r(this._set)}acquire(...e){const t=super.acquire(...e);return this._set.delete(t),t}release(e){e&&!this._set.has(e)&&(super.release(e),this._set.add(e))}_dispose(e){this._set.delete(e),super._dispose(e)}}function h(e,t){for(const s of e.entries())if(t(s[0]))return!0;return!1}function f(e,t){const s=new Set;return o(e)&&e.forEach((e=>s.add(e))),o(t)&&t.forEach((e=>s.add(e))),s}let m=0;const _=0;function v(){return++m}class p{constructor(e){this._notify=e,this._accessed=[],this._handles=[],this._invalidCount=0}destroy(){this._accessed.length=0,this.clear()}onInvalidated(){this._invalidCount++}onCommitted(){const e=this._invalidCount;if(1===e)return this._invalidCount=0,void this._notify();this._invalidCount=e>0?e-1:0}onObservableAccessed(e){this._accessed.includes(e)||this._accessed.push(e)}onTrackingEnd(){const e=this._handles,t=this._accessed;for(let s=0;s<t.length;++s)e.push(t[s].observe(this));t.length=0}clear(){const e=this._handles;for(let t=0;t<e.length;++t)e[t].remove();e.length=0}}let g=!1;const k=[];function y(e,t){let s=new p((function o(){if(!s||r)return;if(g)return void w(o);const i=n;s.clear(),g=!0,r=!0,n=u(s,e),r=!1,g=!1,t(n,i),V()})),n=null,r=!1;return r=!0,n=u(s,e),r=!1,{remove:function(){s&&(s.destroy(),s=null,n=null)}}}function q(e,t){let s=new p((function(){t(n,r)})),n=null;function r(){return s?(s.clear(),n=u(s,e),n):null}return r(),{remove:function(){s&&(s.destroy(),s=null),n=null}}}function b(e){let t=new p((function n(){t&&!s&&(g?w(n):(t.clear(),g=!0,s=!0,u(t,e),s=!1,g=!1,V()))})),s=!1;return s=!0,u(t,e),s=!1,{remove:function(){t&&(t.destroy(),t=null)}}}function w(e){k.includes(e)||k.unshift(e)}function V(){for(;k.length;)k.pop()()}var j;!function(e){e[e.Untracked=0]="Untracked",e[e.Tracked=1]="Tracked"}(j||(j={}));class C{constructor(){this.uid=v(),this.removed=!1,this.type=null,this.oldValue=null,this.callback=null,this.getValue=null,this.target=null,this.path=null,this.equals=null}static acquireUntracked(e,t,n,r,o){return this.pool.acquire(j.Untracked,e,t,n,r,o,s)}static acquireTracked(e,t,s,n){return this.pool.acquire(j.Tracked,e,t,s,null,null,n)}notify(e,t){this.type===j.Untracked?this.callback.call(this.target,e,t,this.path,this.target):this.callback.call(null,e,t)}acquire(e,t,s,n,r,o,i){this.uid=v(),this.removed=!1,this.type=e,this.oldValue=t,this.callback=s,this.getValue=n,this.target=r,this.path=o,this.equals=i}release(){this.target=this.path=this.oldValue=this.callback=this.getValue=null,this.uid=v(),this.removed=!0}}C.pool=new d(C);const T=new t,U=new Set;let S;function E(e){U.delete(e),U.add(e),S||(S=i(O))}function A(e){if(e.removed)return;const t=e.oldValue,s=e.getValue();e.equals(t,s)||(e.oldValue=s,e.notify(s,t))}function x(e){for(const t of U.values())t.target===e&&(t.removed=!0)}function O(){let e=10;for(;S&&e--;){S=null;const e=z(),t=T.acquire();for(const s of e){const e=s.uid;A(s),e===s.uid&&s.removed&&t.push(s)}for(const e of U)e.removed&&(t.push(e),U.delete(e));for(const e of t)C.pool.release(e);T.release(t),T.release(e),I.forEach((e=>e()))}}function z(){const e=T.acquire();e.length=U.size;let t=0;for(const s of U)e[t]=s,++t;return U.clear(),e}const I=new Set;function N(e){return I.add(e),{remove(){I.delete(e)}}}function P(e,t,n,r=!1){return!e.__accessor__||e.__accessor__.destroyed?{remove(){}}:r?function(e,t,n){const r=c(e,t,n,((e,t,n)=>{let o=!1;return y((()=>l(e,t)),((i,l)=>{e.__accessor__.destroyed?r.remove():o||(o=!0,s(l,i)||n.call(e,i,l,t,e),o=!1)}))}));return r}(e,t,n):function(e,t,s){let n=c(e,t,s,((e,t,s)=>{let r,o,i=q((()=>l(e,t)),((i,l)=>{e.__accessor__.destroyed||r&&r.uid!==o?n.remove():(r||(r=C.acquireUntracked(i,s,l,e,t),o=r.uid),E(r))}));return{remove:a((()=>{i.remove(),r&&(r.uid!==o||r.removed||(r.removed=!0,E(r)),r=null),n=i=null}))}}));return n}(e,t,n)}function R(e,t,s=!1,r=n){return s?function(e,t,s){let n=!1;return y(e,((e,r)=>{n||(n=!0,s(r,e)||t(e,r),n=!1)}))}(e,t,r):function(e,t,s){let n,r,o=q(e,((e,i)=>{n&&n.uid!==r?o.remove():(n||(n=C.acquireTracked(e,t,i,s),r=n.uid),E(n))}));return{remove:a((()=>{o.remove(),n&&(n.uid!==r||n.removed||(n.removed=!0,E(n)),n=null),o=null}))}}(e,t,r)}function B(e){return h(U,(t=>t.oldValue===e))}export{_ as N,d as R,p as S,b as a,R as b,N as c,v as g,B as i,x as r,h as s,f as u,P as w};
