/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import e from"../Color.js";import t from"../Graphic.js";import{n as o}from"./compilerUtils.js";import{L as r}from"./Logger.js";import{a as s,i}from"./maybe.js";import{m as a}from"./lengthUtils.js";import{i as n,b as l,T as p,I as c}from"./sizeVariableUtils.js";import"./colorUtils.js";import"./mathUtils.js";import"./vec3.js";import"./common.js";import"./ensureType.js";import"./object.js";import"../core/lang.js";import"../config.js";import"./string.js";import"./tslib.es6.js";import"../geometry.js";import"../geometry/Extent.js";import"../core/accessorSupport/decorators/property.js";import"./get.js";import"./utils.js";import"./handleUtils.js";import"./metadata.js";import"../core/Error.js";import"../core/accessorSupport/decorators/subclass.js";import"./tracking.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"./ArrayPool.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"../core/promiseUtils.js";import"./reader.js";import"../geometry/SpatialReference.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./Ellipsoid.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"./jsonMap.js";import"../geometry/support/jsonUtils.js";import"../PopupTemplate.js";import"../core/Clonable.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../layers/support/fieldUtils.js";import"./arcadeOnDemand.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"./enumeration.js";import"../popup/support/FieldInfoFormat.js";import"./date.js";import"./number.js";import"./locale.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"./chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils2.js";import"../symbols/edges/Edges3D.js";import"./screenUtils.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils3.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"./aaBoundingBox.js";import"./aaBoundingRect.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../core/urlUtils.js";import"./persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../kernel.js";import"../request.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./unitUtils.js";import"./projectionEllipsoid.js";const m=r.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),u=new t,j=Math.PI,b=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i;function d(t,o,r){const a="visualVariables"in t&&t.visualVariables?t.visualVariables.find((e=>"color"===e.type)):t;if(!a)return;if("esri.renderers.visualVariables.ColorVariable"!==a.declaredClass)return void m.warn("The visualVariable should be an instance of esri.renderers.visualVariables.ColorVariable");const n="number"==typeof o,l=n?null:o,p=l&&l.attributes;let c=n?o:null;const u=a.field,{ipData:j,hasExpression:b}=a.cache;let d=a.cache.compiledFunc;if(!u&&!b){const e=a.stops;return e&&e[0]&&e[0].color}if("number"!=typeof c)if(b){if(s(r)||s(r.arcade))return void m.error("Use of arcade expressions requires an arcade context");const e={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},t=r.arcade.arcadeUtils,o=t.getViewInfo(e),i=t.createExecContext(l,o);if(!d){const e=t.createSyntaxTree(a.valueExpression);d=t.createFunction(e),a.cache.compiledFunc=d}c=t.executeFunction(d,i)}else p&&(c=p[u]);const y=a.normalizationField,f=null!=p&&null!=y?parseFloat(p[y]):void 0;if(null!=c&&(!y||n||!isNaN(f)&&0!==f)){isNaN(f)||n||(c/=f);const t=D(c,j);if(t){const o=t[0],s=t[1],n=o===s?a.stops[o].color:e.blendColors(a.stops[o].color,a.stops[s].color,t[2],i(r)?r.color:void 0);return new e(n)}}}function y(e,t,o){const r="visualVariables"in e&&e.visualVariables?e.visualVariables.find((e=>"opacity"===e.type)):e;if(!r)return;if("esri.renderers.visualVariables.OpacityVariable"!==r.declaredClass)return void m.warn("The visualVariable should be an instance of esri.renderers.visualVariables.OpacityVariable");const i="number"==typeof t,a=i?null:t,n=a&&a.attributes;let l=i?t:null;const p=r.field,{ipData:c,hasExpression:u}=r.cache;let j=r.cache.compiledFunc;if(!p&&!u){const e=r.stops;return e&&e[0]&&e[0].opacity}if("number"!=typeof l)if(u){if(s(o)||s(o.arcade))return void m.error("Use of arcade expressions requires an arcade context");const e={viewingMode:o.viewingMode,scale:o.scale,spatialReference:o.spatialReference},t=o.arcade.arcadeUtils,i=t.getViewInfo(e),n=t.createExecContext(a,i);if(!j){const e=t.createSyntaxTree(r.valueExpression);j=t.createFunction(e),r.cache.compiledFunc=j}l=t.executeFunction(j,n)}else n&&(l=n[p]);const b=r.normalizationField,d=null!=n&&null!=b?parseFloat(n[b]):void 0;if(null!=l&&(!b||i||!isNaN(d)&&0!==d)){isNaN(d)||i||(l/=d);const e=D(l,c);if(e){const t=e[0],o=e[1];if(t===o)return r.stops[t].opacity;{const s=r.stops[t].opacity;return s+(r.stops[o].opacity-s)*e[2]}}}}function f(e,t,o){const r="visualVariables"in e&&e.visualVariables?e.visualVariables.find((e=>"rotation"===e.type)):e;if(!r)return;if("esri.renderers.visualVariables.RotationVariable"!==r.declaredClass)return void m.warn("The visualVariable should be an instance of esri.renderers.visualVariables.RotationVariable");const i=r.axis||"heading",a="heading"===i&&"arithmetic"===r.rotationType?90:0,n="heading"===i&&"arithmetic"===r.rotationType?-1:1,l="number"==typeof t?null:t,p=l&&l.attributes,c=r.field,{hasExpression:u}=r.cache;let j=r.cache.compiledFunc,b=0;if(!c&&!u)return b;if(u){if(s(o)||s(o.arcade))return void m.error("Use of arcade expressions requires an arcade context");const e={viewingMode:o.viewingMode,scale:o.scale,spatialReference:o.spatialReference},t=o.arcade.arcadeUtils,i=t.getViewInfo(e),a=t.createExecContext(l,i);if(!j){const e=t.createSyntaxTree(r.valueExpression);j=t.createFunction(e),r.cache.compiledFunc=j}b=t.executeFunction(j,a)}else p&&(b=p[c]||0);return b="number"!=typeof b||isNaN(b)?null:a+n*b,b}function h(e,t,o){const r="visualVariables"in e&&e.visualVariables?e.visualVariables.find((e=>"size"===e.type)):e;if(!r)return;if("esri.renderers.visualVariables.SizeVariable"!==r.declaredClass)return void m.warn("The visualVariable should be an instance of esri.renderers.visualVariables.SizeVariable");const a=function(e,t,o){const r="number"==typeof t,a=r?null:t,n=a&&a.attributes;let p=r?t:null;const{isScaleDriven:u}=e.cache;let j=e.cache.compiledFunc;if(u){const t=i(o)?o.scale:void 0,r=i(o)?o.view:void 0;p=null==t||"3d"===r?function(e){let t=null,o=null;const r=e.stops;return r?(t=r[0].value,o=r[r.length-1].value):(t=e.minDataValue||0,o=e.maxDataValue||0),(t+o)/2}(e):t}else if(!r)switch(e.inputValueType){case c.Expression:{if(s(o)||s(o.arcade))return void m.error("Use of arcade expressions requires an arcade context");const t={viewingMode:o.viewingMode,scale:o.scale,spatialReference:o.spatialReference},r=o.arcade.arcadeUtils,i=r.getViewInfo(t),n=r.createExecContext(a,i);if(!j){const t=r.createSyntaxTree(e.valueExpression);j=r.createFunction(t),e.cache.compiledFunc=j}p=r.executeFunction(j,n);break}case c.Field:n&&(p=n[e.field]);break;case c.Unknown:p=null}if(!l(p))return null;if(r||!e.normalizationField)return p;const b=n?parseFloat(n[e.normalizationField]):null;return l(b)&&0!==b?p/b:null}(r,t,o),n=g(a,r,t,o,r.cache.ipData);return null==n||isNaN(n)?0:n}function v(e,t,o){return null==e?null:n(e)?h(e,t,o):l(e)?e:null}function S(e,t,o){return l(o)&&e>o?o:l(t)&&e<t?t:e}function g(e,t,o,r,s){switch(t.transformationType){case p.Additive:return function(e,t,o,r){return e+((v(t.minSize,o,r)||t.minDataValue)??0)}(e,t,o,r);case p.Constant:return function(e,t,o){const r=e.stops;let s=r&&r.length&&r[0].size;return null==s&&(s=e.minSize),v(s,t,o)}(t,o,r);case p.ClampedLinear:return function(e,t,o,r){const s=(e-t.minDataValue)/(t.maxDataValue-t.minDataValue),a=v(t.minSize,o,r),n=v(t.maxSize,o,r),l=i(r)?r.shape:void 0;if(e<=t.minDataValue)return a;if(e>=t.maxDataValue)return n;if(null==a||null==n)return null;if("area"===t.scaleBy&&l){const e="circle"===l,t=e?j*(a/2)**2:a*a,o=t+s*((e?j*(n/2)**2:n*n)-t);return e?2*Math.sqrt(o/j):Math.sqrt(o)}return a+s*(n-a)}(e,t,o,r);case p.Proportional:return function(e,t,o,r){const s=i(r)?r.shape:void 0,a=e/t.minDataValue,n=v(t.minSize,o,r),l=v(t.maxSize,o,r);let p=null;return p="circle"===s?2*Math.sqrt(a*(n/2)**2):"square"===s||"diamond"===s||"image"===s?Math.sqrt(a*n**2):a*n,S(p,n,l)}(e,t,o,r);case p.Stops:return function(e,t,o,r,s){const[i,a,n]=D(e,s);if(i===a)return v(t.stops?.[i].size,o,r);{const e=v(t.stops?.[i].size,o,r);return e+(v(t.stops?.[a].size,o,r)-e)*n}}(e,t,o,r,s);case p.RealWorldSize:return function(e,t,o,r){const s=(i(r)&&r.resolution?r.resolution:1)*a[t.valueUnit],n=v(t.minSize,o,r),l=v(t.maxSize,o,r),{valueRepresentation:p}=t;let c=null;return c="area"===p?2*Math.sqrt(e/j)/s:"radius"===p||"distance"===p?2*e/s:e/s,S(c,n,l)}(e,t,o,r);case p.Identity:return e;case p.Unknown:return null}}function x(e,t,o){const{isScaleDriven:r}=e.cache;if(!(r&&"3d"===o||t))return null;const s={scale:t,view:o};let i=v(e.minSize,u,s),a=v(e.maxSize,u,s);if(null!=i||null!=a){if(i>a){const e=a;a=i,i=e}return{minSize:i,maxSize:a}}}function V(e,t,o){if(!e.visualVariables)return;const r=[],s=[],i=[],a=[],n=[];for(const t of e.visualVariables)switch(t.type){case"color":s.push(t);break;case"opacity":i.push(t);break;case"rotation":n.push(t);break;case"size":a.push(t)}return s.forEach((e=>{const s=d(e,t,o);r.push({variable:e,value:s})})),i.forEach((e=>{const s=y(e,t,o);r.push({variable:e,value:s})})),n.forEach((e=>{const s=f(e,t,o);r.push({variable:e,value:s})})),a.forEach((e=>{const s=h(e,t,o);r.push({variable:e,value:s})})),r.filter((e=>null!=e.value))}function D(e,t){if(!t)return;let o=0,r=t.length-1;return t.some(((t,s)=>e<t?(r=s,!0):(o=s,!1))),[o,r,(e-t[o])/(t[r]-t[o])]}function M(e,t,r){const s=["proportional","proportional","proportional"];for(const i of e){const e=i.useSymbolValue?"symbol-value":h(i,t,r);switch(i.axis){case"width":s[0]=e;break;case"depth":s[1]=e;break;case"height":s[2]=e;break;case"width-and-depth":s[0]=e,s[1]=e;break;case"all":case void 0:case null:s[0]=e,s[1]=e,s[2]=e;break;default:o(i.axis)}}return s}export{M as getAllSizes,d as getColor,y as getOpacity,f as getRotationAngle,h as getSize,g as getSizeForValue,v as getSizeFromNumberOrVariable,x as getSizeRangeAtScale,V as getVisualVariableValues,b as viewScaleRE};
