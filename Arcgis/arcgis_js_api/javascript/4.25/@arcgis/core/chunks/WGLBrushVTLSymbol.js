/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{j as e}from"./mathUtils.js";import{i as t,a}from"./maybe.js";import{c as i}from"./mat3f32.js";import{f as r}from"./vec4f32.js";import{V as n,l as s,m as o}from"./definitions.js";import{W as l}from"./enums4.js";import{u as f}from"./number2.js";import{B as c,V as u}from"./FramebufferObject.js";import{c as d,d as p,e as m,U as y,D as g}from"./enums3.js";import{T as _,R as M,b as U}from"./StyleDefinition.js";import{c as E,f as h}from"./vec2f32.js";import{F as v}from"./config.js";import{d as P}from"./GeometryUtils2.js";class T{constructor(){this.name=this.constructor.name||"UnnamedBrush",this.brushEffect=null}prepareState(e,t){}draw(e,t,a){}drawMany(e,t,a){for(const i of t)i.visible&&this.draw(e,i,a)}}class x extends T{constructor(){super(...arguments),this._color=r(1,0,0,1),this._patternMatrix=i(),this._programOptions={id:!1,pattern:!1}}dispose(){this._vao&&(this._vao.dispose(),this._vao=null)}drawMany(a,i){const{context:r,painter:o,styleLayerUID:c,requestRender:u,allowDelayedRender:y}=a;this._loadWGLResources(a);const g=a.displayLevel,_=a.styleLayer,M=_.backgroundMaterial,U=o.vectorTilesMaterialManager,E=_.getPaintValue("background-color",g),h=_.getPaintValue("background-opacity",g),v=_.getPaintValue("background-pattern",g),P=void 0!==v,T=E[3]*h,x=1|window.devicePixelRatio,I=a.spriteMosaic;let R,D;const S=x>s?2:1,V=a.drawPhase===l.HITTEST,w=this._programOptions;w.id=V,w.pattern=P;const L=U.getMaterialProgram(r,M,w);if(y&&t(u)&&!L.isCompiled)u();else{if(r.bindVAO(this._vao),r.useProgram(L),P){const e=I.getMosaicItemPosition(v,!0);if(t(e)){const{tl:a,br:i,page:s}=e;R=i[0]-a[0],D=i[1]-a[1];const o=I.getPageSize(s);t(o)&&(I.bind(r,d.LINEAR,s,n),L.setUniform4f("u_tlbr",a[0],a[1],i[0],i[1]),L.setUniform2fv("u_mosaicSize",o),L.setUniform1i("u_texture",n))}L.setUniform1f("u_opacity",h)}else this._color[0]=T*E[0],this._color[1]=T*E[1],this._color[2]=T*E[2],this._color[3]=T,L.setUniform4fv("u_color",this._color);if(L.setUniform1f("u_depth",_.z||0),V){const e=f(c+1);L.setUniform4fv("u_id",e)}for(const t of i){if(L.setUniform1f("u_coord_range",t.rangeX),L.setUniformMatrix3fv("u_dvsMat3",t.transforms.dvs),P){const a=Math.max(2**(Math.round(g)-t.key.level),1),i=S*t.width*a,r=i/e(R),n=i/e(D);this._patternMatrix[0]=r,this._patternMatrix[4]=n,L.setUniformMatrix3fv("u_pattern_matrix",this._patternMatrix)}r.setStencilFunction(p.EQUAL,0,255),r.drawArrays(m.TRIANGLE_STRIP,0,4)}}}_loadWGLResources(e){if(this._vao)return;const{context:t,styleLayer:a}=e,i=a.backgroundMaterial,r=new Int8Array([0,0,1,0,0,1,1,1]),n=c.createVertex(t,y.STATIC_DRAW,r),s=new u(t,i.getAttributeLocations(),i.getLayoutInfo(),{geometry:n});this._vao=s}}class I extends T{constructor(){super(...arguments),this._programOptions={id:!1}}dispose(){}drawMany(e,i){const{context:r,displayLevel:n,requiredLevel:s,state:o,drawPhase:c,painter:u,spriteMosaic:d,styleLayerUID:y,requestRender:M,allowDelayedRender:U}=e;if(!i.some((e=>e.layerData.get(y)?.circleIndexCount??!1)))return;const E=e.styleLayer,h=E.circleMaterial,v=u.vectorTilesMaterialManager,P=E.getPaintValue("circle-translate",n),T=E.getPaintValue("circle-translate-anchor",n),x=c===l.HITTEST,I=this._programOptions;I.id=x;const R=v.getMaterialProgram(r,h,I);if(U&&t(M)&&!R.isCompiled)return void M();r.useProgram(R),R.setUniformMatrix3fv("u_displayMat3",T===_.VIEWPORT?o.displayMat3:o.displayViewMat3),R.setUniform2fv("u_circleTranslation",P),R.setUniform1f("u_depth",E.z),R.setUniform1f("u_antialiasingWidth",1.2);let D=-1;if(x){const e=f(y+1);R.setUniform4fv("u_id",e)}for(const e of i){if(!e.layerData.has(y))continue;e.key.level!==D&&(D=e.key.level,h.setDataUniforms(R,n,E,D,d));const t=e.layerData.get(y);if(!t.circleIndexCount)continue;t.prepareForRendering(r);const i=t.circleVertexArrayObject;a(i)||(r.bindVAO(i),R.setUniformMatrix3fv("u_dvsMat3",e.transforms.dvs),s!==e.key.level?r.setStencilFunction(p.EQUAL,e.stencilRef,255):r.setStencilFunction(p.GREATER,255,255),r.drawElements(m.TRIANGLES,t.circleIndexCount,g.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t.circleIndexStart),e.triangleCount+=t.circleIndexCount/3)}}}class R extends T{constructor(){super(...arguments),this._fillProgramOptions={id:!1,pattern:!1},this._outlineProgramOptions={id:!1}}dispose(){}drawMany(e,t){const{displayLevel:a,drawPhase:i,renderPass:r,spriteMosaic:n,styleLayerUID:s}=e;let o=!1;for(const e of t)if(e.layerData.has(s)){const t=e.layerData.get(s);if(t.fillIndexCount>0||t.outlineIndexCount>0){o=!0;break}}if(!o)return;const c=e.styleLayer,u=c.getPaintProperty("fill-pattern"),d=void 0!==u,p=d&&u.isDataDriven;let m;if(d&&!p){const e=u.getValue(a);m=n.getMosaicItemPosition(e,!0)}const y=!d&&c.getPaintValue("fill-antialias",a);let g,_=!0,M=1;if(!d){const e=c.getPaintProperty("fill-color"),t=c.getPaintProperty("fill-opacity");if(!e?.isDataDriven&&!t?.isDataDriven){const e=c.getPaintValue("fill-color",a);M=c.getPaintValue("fill-opacity",a)*e[3],M>=1&&(_=!1)}}if(_&&"opaque"===r)return;i===l.HITTEST&&(g=f(s+1));const U=c.getPaintValue("fill-translate",a),E=c.getPaintValue("fill-translate-anchor",a);(_||"translucent"!==r)&&this._drawFill(e,s,c,t,U,E,d,m,p,g);const h=!c.hasDataDrivenOutlineColor&&c.outlineUsesFillColor&&M<1;y&&"opaque"!==r&&!h&&this._drawOutline(e,s,c,t,U,E,g)}_drawFill(e,i,r,o,f,c,u,y,M,U){if(u&&!M&&a(y))return;const{context:E,displayLevel:h,state:v,drawPhase:P,painter:T,pixelRatio:x,spriteMosaic:I,requestRender:R,allowDelayedRender:D}=e,S=r.fillMaterial,V=T.vectorTilesMaterialManager,w=x>s?2:1,L=P===l.HITTEST,A=this._fillProgramOptions;A.id=L,A.pattern=u;const N=V.getMaterialProgram(E,S,A);if(D&&t(R)&&!N.isCompiled)return void R();if(E.useProgram(N),t(y)){const{page:e}=y,a=I.getPageSize(e);t(a)&&(I.bind(E,d.LINEAR,e,n),N.setUniform2fv("u_mosaicSize",a),N.setUniform1i("u_texture",n))}N.setUniformMatrix3fv("u_displayMat3",c===_.VIEWPORT?v.displayMat3:v.displayViewMat3),N.setUniform2fv("u_fillTranslation",f),N.setUniform1f("u_depth",r.z+152587890625e-16),L&&N.setUniform4fv("u_id",U);let O=-1;for(const e of o){if(!e.layerData.has(i))continue;e.key.level!==O&&(O=e.key.level,S.setDataUniforms(N,h,r,O,I));const s=e.layerData.get(i);if(!s.fillIndexCount)continue;s.prepareForRendering(E);const o=s.fillVertexArrayObject;if(!a(o)){if(E.bindVAO(o),N.setUniformMatrix3fv("u_dvsMat3",e.transforms.dvs),E.setStencilFunction(p.EQUAL,e.stencilRef,255),u){const t=Math.max(2**(Math.round(h)-e.key.level),1),a=e.rangeX/(w*e.width*t);N.setUniform1f("u_patternFactor",a)}if(M){const e=s.patternMap;if(!e)continue;for(const[a,i]of e){const e=I.getPageSize(a);t(e)&&(I.bind(E,d.LINEAR,a,n),N.setUniform2fv("u_mosaicSize",e),N.setUniform1i("u_texture",n),E.drawElements(m.TRIANGLES,i[1],g.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*i[0]))}}else E.drawElements(m.TRIANGLES,s.fillIndexCount,g.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*s.fillIndexStart);e.triangleCount+=s.fillIndexCount/3}}}_drawOutline(e,i,r,n,s,o,f){const{context:c,displayLevel:u,state:d,drawPhase:y,painter:M,pixelRatio:U,spriteMosaic:E,requestRender:h,allowDelayedRender:v}=e,P=r.outlineMaterial,T=M.vectorTilesMaterialManager,x=.75/U,I=y===l.HITTEST,R=this._outlineProgramOptions;R.id=I;const D=T.getMaterialProgram(c,P,R);if(v&&t(h)&&!D.isCompiled)return void h();c.useProgram(D),D.setUniformMatrix3fv("u_displayMat3",o===_.VIEWPORT?d.displayMat3:d.displayViewMat3),D.setUniform2fv("u_fillTranslation",s),D.setUniform1f("u_depth",r.z+152587890625e-16),D.setUniform1f("u_outline_width",x),I&&D.setUniform4fv("u_id",f);let S=-1;for(const e of n){if(!e.layerData.has(i))continue;e.key.level!==S&&(S=e.key.level,P.setDataUniforms(D,u,r,S,E));const t=e.layerData.get(i);if(t.prepareForRendering(c),!t.outlineIndexCount)continue;const n=t.outlineVertexArrayObject;a(n)||(c.bindVAO(n),D.setUniformMatrix3fv("u_dvsMat3",e.transforms.dvs),c.setStencilFunction(p.EQUAL,e.stencilRef,255),c.drawElements(m.TRIANGLES,t.outlineIndexCount,g.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t.outlineIndexStart),e.triangleCount+=t.outlineIndexCount/3)}}}class D extends T{constructor(){super(...arguments),this._programOptions={id:!1,pattern:!1,sdf:!1}}dispose(){}drawMany(e,i){const{context:r,displayLevel:s,state:o,drawPhase:c,painter:u,pixelRatio:y,spriteMosaic:M,styleLayerUID:U,requestRender:E,allowDelayedRender:h}=e;if(!i.some((e=>e.layerData.get(U)?.lineIndexCount??!1)))return;const v=e.styleLayer,P=v.lineMaterial,T=u.vectorTilesMaterialManager,x=v.getPaintValue("line-translate",s),I=v.getPaintValue("line-translate-anchor",s),R=v.getPaintProperty("line-pattern"),D=void 0!==R,S=D&&R.isDataDriven;let V,w;if(D&&!S){const e=R.getValue(s);V=M.getMosaicItemPosition(e)}let L=!1;if(!D){const e=v.getPaintProperty("line-dasharray");if(w=void 0!==e,L=w&&e.isDataDriven,w&&!L){const t=e.getValue(s),a=v.getDashKey(t,v.getLayoutValue("line-cap",s));V=M.getMosaicItemPosition(a)}}const A=1/y,N=c===l.HITTEST,O=this._programOptions;O.id=N,O.pattern=D,O.sdf=w;const b=T.getMaterialProgram(r,P,O);if(h&&t(E)&&!b.isCompiled)return void E();if(r.useProgram(b),b.setUniformMatrix3fv("u_displayViewMat3",o.displayViewMat3),b.setUniformMatrix3fv("u_displayMat3",I===_.VIEWPORT?o.displayMat3:o.displayViewMat3),b.setUniform2fv("u_lineTranslation",x),b.setUniform1f("u_depth",v.z),b.setUniform1f("u_antialiasing",A),N){const e=f(U+1);b.setUniform4fv("u_id",e)}if(V&&t(V)){const{page:e}=V,a=M.getPageSize(e);t(a)&&(M.bind(r,d.LINEAR,e,n),b.setUniform2fv("u_mosaicSize",a),b.setUniform1i("u_texture",n))}let C=-1;for(const e of i){if(!e.layerData.has(U))continue;e.key.level!==C&&(C=e.key.level,P.setDataUniforms(b,s,v,C,M));const i=2**(s-C)/y;b.setUniform1f("u_zoomFactor",i);const o=e.layerData.get(U);if(!o.lineIndexCount)continue;o.prepareForRendering(r);const l=o.lineVertexArrayObject;if(!a(l)){if(r.bindVAO(l),b.setUniformMatrix3fv("u_dvsMat3",e.transforms.dvs),r.setStencilFunction(p.EQUAL,e.stencilRef,255),S||L){const e=o.patternMap;if(!e)continue;for(const[a,i]of e){const e=M.getPageSize(a);t(e)&&(M.bind(r,d.LINEAR,a,n),b.setUniform2fv("u_mosaicSize",e),b.setUniform1i("u_texture",n),r.drawElements(m.TRIANGLES,i[1],g.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*i[0]))}}else r.drawElements(m.TRIANGLES,o.lineIndexCount,g.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*o.lineIndexStart);e.triangleCount+=o.lineIndexCount/3}}}}class S extends T{constructor(){super(...arguments),this._iconProgramOptions={id:!1,sdf:!1},this._sdfProgramOptions={id:!1},this._spritesTextureSize=E()}dispose(){}drawMany(e,t){const{drawPhase:a,styleLayerUID:i}=e,r=e.styleLayer;let n;a===l.HITTEST&&(n=f(i+1)),this._drawIcons(e,r,t,n),this._drawText(e,r,t,n)}_drawIcons(e,i,r,s){const{context:o,displayLevel:f,drawPhase:c,painter:u,spriteMosaic:d,state:p,styleLayerUID:m,requestRender:y,allowDelayedRender:g}=e,E=i.iconMaterial,h=u.vectorTilesMaterialManager;let T,x=!1;for(const e of r)if(e.layerData.has(m)&&(T=e.layerData.get(m),T.iconPerPageElementsMap.size>0)){x=!0;break}if(!x)return;const I=i.getPaintValue("icon-translate",f),R=i.getPaintValue("icon-translate-anchor",f);let D=i.getLayoutValue("icon-rotation-alignment",f);D===M.AUTO&&(D=i.getLayoutValue("symbol-placement",f)===U.POINT?M.VIEWPORT:M.MAP);const S=D===M.MAP,V=i.getLayoutValue("icon-keep-upright",f)&&S,w=T.isIconSDF,L=c===l.HITTEST,A=this._iconProgramOptions;A.id=L,A.sdf=w;const N=h.getMaterialProgram(o,E,A);if(g&&t(y)&&!N.isCompiled)return void y();o.useProgram(N),N.setUniformMatrix3fv("u_displayViewMat3",D===M.MAP?p.displayViewMat3:p.displayMat3),N.setUniformMatrix3fv("u_displayMat3",R===_.VIEWPORT?p.displayMat3:p.displayViewMat3),N.setUniform2fv("u_iconTranslation",I),N.setUniform1f("u_depth",i.z),N.setUniform1f("u_mapRotation",P(p.rotation)),N.setUniform1f("u_keepUpright",V?1:0),N.setUniform1f("u_level",10*f),N.setUniform1i("u_texture",n),N.setUniform1f("u_fadeDuration",v/1e3),L&&N.setUniform4fv("u_id",s);let O=-1;for(const t of r){if(!t.layerData.has(m))continue;if(t.key.level!==O&&(O=t.key.level,E.setDataUniforms(N,f,i,O,d)),T=t.layerData.get(m),0===T.iconPerPageElementsMap.size)continue;T.prepareForRendering(o),T.updateOpacityInfo();const r=T.iconVertexArrayObject;if(!a(r)){o.bindVAO(r),N.setUniformMatrix3fv("u_dvsMat3",t.transforms.dvs),N.setUniform1f("u_time",(performance.now()-T.lastOpacityUpdate)/1e3);for(const[a,i]of T.iconPerPageElementsMap)this._renderIconRange(e,N,i,a,t)}}}_renderIconRange(e,t,a,i,r){const{context:s,spriteMosaic:o}=e;this._spritesTextureSize[0]=o.getWidth(i)/4,this._spritesTextureSize[1]=o.getHeight(i)/4,t.setUniform2fv("u_mosaicSize",this._spritesTextureSize),o.bind(s,d.LINEAR,i,n),s.setStencilTestEnabled(!0),s.setStencilFunction(p.GREATER,255,255),s.setStencilWriteMask(0),s.drawElements(m.TRIANGLES,a[1],g.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*a[0]),r.triangleCount+=a[1]/3}_drawText(e,i,r,n){const{context:s,displayLevel:f,drawPhase:c,glyphMosaic:u,painter:d,pixelRatio:m,spriteMosaic:y,state:g,styleLayerUID:E,requestRender:T,allowDelayedRender:x}=e,I=i.textMaterial,R=d.vectorTilesMaterialManager;let D,S=!1;for(const e of r)if(e.layerData.has(E)&&(D=e.layerData.get(E),D.glyphPerPageElementsMap.size>0)){S=!0;break}if(!S)return;const V=i.getPaintProperty("text-opacity");if(V&&!V.isDataDriven&&0===V.getValue(f))return;const w=i.getPaintProperty("text-color"),L=!w||w.isDataDriven||w.getValue(f)[3]>0,A=i.getPaintProperty("text-halo-width"),N=i.getPaintProperty("text-halo-color"),O=(!A||A.isDataDriven||A.getValue(f)>0)&&(!N||N.isDataDriven||N.getValue(f)[3]>0);if(!L&&!O)return;let b=i.getLayoutValue("text-rotation-alignment",f);b===M.AUTO&&(b=i.getLayoutValue("symbol-placement",f)===U.POINT?M.VIEWPORT:M.MAP);const C=b===M.MAP,z=i.getLayoutValue("text-keep-upright",f)&&C,k=c===l.HITTEST,G=.8*3/m;this._glyphTextureSize||(this._glyphTextureSize=h(u.width/4,u.height/4));const F=i.getPaintValue("text-translate",f),j=i.getPaintValue("text-translate-anchor",f),W=this._sdfProgramOptions;W.id=k;const B=R.getMaterialProgram(s,I,W);if(x&&t(T)&&!B.isCompiled)return void T();s.useProgram(B),B.setUniformMatrix3fv("u_displayViewMat3",b===M.MAP?g.displayViewMat3:g.displayMat3),B.setUniformMatrix3fv("u_displayMat3",j===_.VIEWPORT?g.displayMat3:g.displayViewMat3),B.setUniform2fv("u_textTranslation",F),B.setUniform1f("u_depth",i.z+152587890625e-16),B.setUniform2fv("u_mosaicSize",this._glyphTextureSize),B.setUniform1f("u_mapRotation",P(g.rotation)),B.setUniform1f("u_keepUpright",z?1:0),B.setUniform1f("u_level",10*f),B.setUniform1i("u_texture",o),B.setUniform1f("u_antialiasingWidth",G),B.setUniform1f("u_fadeDuration",v/1e3),k&&B.setUniform4fv("u_id",n);let q=-1;for(const e of r){if(!e.layerData.has(E))continue;if(e.key.level!==q&&(q=e.key.level,I.setDataUniforms(B,f,i,q,y)),D=e.layerData.get(E),0===D.glyphPerPageElementsMap.size)continue;D.prepareForRendering(s),D.updateOpacityInfo();const t=D.textVertexArrayObject;if(a(t))continue;s.bindVAO(t),B.setUniformMatrix3fv("u_dvsMat3",e.transforms.dvs),s.setStencilTestEnabled(!0),s.setStencilFunction(p.GREATER,255,255),s.setStencilWriteMask(0);const r=(performance.now()-D.lastOpacityUpdate)/1e3;B.setUniform1f("u_time",r),D.glyphPerPageElementsMap.forEach(((t,a)=>{this._renderGlyphRange(s,t,a,u,B,O,L,e)}))}}_renderGlyphRange(e,t,a,i,r,n,s,l){i.bind(e,d.LINEAR,a,o),n&&(r.setUniform1f("u_halo",1),e.drawElements(m.TRIANGLES,t[1],g.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),l.triangleCount+=t[1]/3),s&&(r.setUniform1f("u_halo",0),e.drawElements(m.TRIANGLES,t[1],g.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),l.triangleCount+=t[1]/3)}}export{T as W,x as a,R as b,D as c,I as d,S as e};
