/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import"../geometry.js";import{a as e,i as t}from"./maybe.js";import{throwIfAborted as s}from"../core/promiseUtils.js";import{m as a}from"./dehydratedFeatures.js";import{k as o}from"./elevationInfoUtils.js";import{E as n,i as r,j as i,a as c,S as p}from"./MultipassGeometryTest.glsl.js";import d from"../geometry/SpatialReference.js";import{l as f}from"./arcadeOnDemand.js";async function l(t,a,n,p,d){const{elevationProvider:f,renderCoordsHelper:l,spatialReference:h}=t,{elevationInfo:y}=a,j=r(y,!0),I=await i(j,h,d);s(d);const b=[],S=new Set,w=new Set;for(const{objectId:s,points:r}of p){const i=n(s);if(e(i)){for(const e of r)b.push(e[2]);S.add(s);continue}i.isDraped&&w.add(s);const p=i.graphic.geometry;m.setFromElevationInfo(o(p,y)),m.updateFeatureExpressionInfoContext(I,i.graphic,a),u.spatialReference=t.spatialReference;for(const{x:e,y:t,z:s}of r)u.x=e,u.y=t,u.z=s??0,c(u,f,m,l,g),b.push(g.z)}return{elevations:b,drapedObjectIds:w,failedObjectIds:S}}const m=new n,u=a(0,0,0,d.WGS84),g=new p;async function h(a,o,n){if(e(a)||0===o.candidates.length)return y;const r=a.graphics3DGraphicsByObjectID??a.graphics3DGraphics,i=[],c=[],{renderer:p}=a,d=t(p)&&"arcadeRequired"in p&&p.arcadeRequired?f():null,l=async(t,{graphic:s,graphics3DSymbol:o})=>{const r=await d,i=await a.getRenderingInfoAsync(s,p,r,{signal:n});return e(i)?[]:o.queryForSnapping(t,u,i,n)},{candidates:m,spatialReference:u}=o;for(let t=0;t<m.length;++t){const s=m[t],{objectId:a}=s,o="number"==typeof a?r.get(a):void 0;if(e(o))continue;const{graphics3DSymbol:n}=o;n.symbologySnappingSupported&&(i.push(l(s,o)),c.push(t))}if(0===i.length)return y;const g=await Promise.all(i);s(n);const h=[],j=[];for(let e=0;e<g.length;++e){const t=g[e],s=c[e];for(const e of t)h.push(e),j.push(s)}return{candidates:h,sourceCandidateIndices:j}}const y={candidates:[],sourceCandidateIndices:[]};export{l as e,h as q};
