/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{g as s}from"./assets.js";import{t,c as e}from"./colorUtils2.js";import"./object.js";import o from"../core/Error.js";import{L as r}from"./Logger.js";import{a as l,c as i,i as a}from"./maybe.js";import{eachAlways as m}from"../core/promiseUtils.js";import{a as p}from"./screenUtils.js";import{l as n,m as c,j as u,n as y,h}from"./utils6.js";import{d as j}from"../symbols/IconSymbol3DLayer.js";import{d as b}from"../symbols/ObjectSymbol3DLayer.js";import{S as f,i as d,t as g,h as S,j as k,k as v,l as M,m as L,n as x,o as w,p as U,q as D,s as P,u as z}from"../symbols/support/symbolUtils.js";import{resolveWebStyleSymbol as C}from"./webStyleSymbolUtils.js";import"../config.js";import"../core/lang.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./string.js";import"../Color.js";import"./colorUtils.js";import"./mathUtils.js";import"./vec3.js";import"./common.js";import"./ensureType.js";import"../symbols.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./tracking.js";import"../symbols/CIMSymbol.js";import"./tslib.es6.js";import"../core/accessorSupport/decorators/property.js";import"./get.js";import"./enumeration.js";import"./jsonMap.js";import"./reader.js";import"./writer.js";import"../layers/support/fieldUtils.js";import"./arcadeOnDemand.js";import"../geometry.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"./ArrayPool.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"../geometry/SpatialReference.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./Ellipsoid.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils2.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils3.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"./aaBoundingBox.js";import"./aaBoundingRect.js";import"../symbols/Font.js";import"../symbols/LabelSymbol3D.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"./locale.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"./persistableUrlUtils.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../core/Clonable.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./asyncUtils.js";import"./jsonUtils.js";import"./parser.js";import"./mat4f32.js";import"./mat4.js";import"./_commonjsHelpers.js";import"./ItemCache.js";import"./MemCache.js";import"../symbols/support/cimSymbolUtils.js";import"./utils7.js";import"./projector.js";import"./widgetUtils.js";import"./mat2df32.js";import"./mat2d.js";import"./jsxFactory.js";import"./jsxWidgetSupport.js";import"./devEnvironmentUtils.js";import"../symbols/support/jsonUtils.js";import"./symbolConversion.js";import"./styleUtils2.js";const E=f.size,O=f.maxSize,F=f.maxOutlineSize,I=f.lineWidth,T=f.tallSymbolWidth;function R(s){const t=s.outline,e=a(s.material)?s.material.color:null,o=a(e)?e.toHex():null;if(l(t)||"pattern"in t&&a(t.pattern)&&"style"===t.pattern.type&&"none"===t.pattern.style)return"fill"===s.type&&"#ffffff"===o?{color:"#bdc3c7",width:.75}:null;const r=p(t.size)||0;return{color:"rgba("+(a(t.color)?t.color.toRgba():"255,255,255,1")+")",width:Math.min(r,F),style:"pattern"in t&&a(t.pattern)&&"style"===t.pattern.type?y(t.pattern.style):null,join:"butt",cap:"patternCap"in t?t.patternCap:"butt"}}function W(s,o=1){const r=s.a,l=t(s),i=l.h,a=l.s/o,m=100-(100-l.v)/o,{r:p,g:n,b:c}=e({h:i,s:a,v:m});return[p,n,c,r]}function q(s){return"water"===s.type?l(s.color)?null:s.color:l(s.material)||l(s.material.color)?null:s.material.color}function A(s,t=0){const e=q(s);if(!e){if("fill"===s.type)return null;const e=n.r,o=d(e,t);return[o,o,o,100]}const o=e.toRgba();for(let s=0;s<3;s++)o[s]=d(o[s],t);return o}async function H(t,e){const o=t.style;return"none"===o?null:{type:"pattern",x:0,y:0,src:await c(s(`esri/symbols/patterns/${o}.png`),e.toCss(!0)),width:5,height:5}}function B(s){return s.outline?R(s):{color:"rgba(0, 0, 0, 1)",width:1.5}}function N(s,t){const e=q(s);if(!e)return null;let o="rgba(";return o+=d(e.r,t)+",",o+=d(e.g,t)+",",o+=d(e.b,t)+",",o+e.a+");"}function Z(s,t){const e=N(s,t);return e?"pattern"in s&&a(s.pattern)&&"style"===s.pattern.type&&"none"===s.pattern.style?null:{color:e,width:Math.min(s.size?p(s.size):.75,F),style:"pattern"in s&&a(s.pattern)&&"style"===s.pattern.type?y(s.pattern.style):null,cap:"cap"in s?s.cap:null,join:"join"in s?"miter"===s.join?p(2):s.join:null}:{}}function G(s,t,e){const o=null!=e?.75*e:0;return{type:"linear",x1:o?.25*o:0,y1:o?.5*o:0,x2:o||4,y2:o?.5*o:4,colors:[{color:s,offset:0},{color:t,offset:1}]}}function Q(s){const t="number"==typeof s?.size?s?.size:null;return t?p(t):null}function J(t,e){if(0===t.symbolLayers.length)return Promise.reject(new o("symbolPreview: renderPreviewHTML3D","No symbolLayers in the symbol."));switch(t.type){case"point-3d":return function(t,e){const o=Q(e),l=e?.maxSize?p(e.maxSize):null,i=e?.disableUpsampling??!1,a=t.symbolLayers,n=[];let c=0,u=0;const y=a.getItemAt(a.length-1);let f;return y&&"icon"===y.type&&(f=y.size&&p(y.size)),a.forEach((r=>{if("icon"!==r.type&&"object"!==r.type)return;const a="icon"===r.type?r.size&&p(r.size):0,m=o||a?Math.ceil(Math.min(o||a,l||O)):E;if(r&&r.resource&&r.resource.href){const e=function(t,e){const o=e&&e.resource,r=o&&o.href;if(t.thumbnail&&t.thumbnail.url)return Promise.resolve(t.thumbnail.url);if(r&&"object"!==e.type)return Promise.resolve(h(t,e));const l=s("esri/images/Legend/legend3dsymboldefault.png");return t.styleOrigin&&(t.styleOrigin.styleName||t.styleOrigin.styleUrl)?C(t.styleOrigin,{portal:t.styleOrigin.portal},"webRef").catch((s=>s)).then((s=>s?.thumbnail?.url||l)):Promise.resolve(l)}(t,r).then((s=>{const t=r.get("material.color"),e=function(s){return"icon"===s.type?"multiply":"tint"}(r);return g(s,m,t,e,i)})).then((s=>{const t=s.width,e=s.height;return c=Math.max(c,t),u=Math.max(u,e),[{shape:{type:"image",x:0,y:0,width:t,height:e,src:s.url},fill:null,stroke:null}]}));n.push(e)}else{let s=m;"icon"===r.type&&f&&o&&(s=m*(a/f));const t="tall"===e?.symbolConfig||e?.symbolConfig?.isTall||"object"===r.type&&function(s){const t=s.depth,e=s.height,o=s.width;return 0!==o&&0!==t&&0!==e&&o===t&&null!=o&&null!=e&&o<e}(r);c=Math.max(c,t?T:s),u=Math.max(u,s),n.push(Promise.resolve(function(s,t,e){const o=[];if(!s)return o;switch(s.type){case"icon":{const e=0,r=0,l=t,i=t;switch(s.resource&&s.resource.primitive||j){case"circle":o.push({shape:{type:"circle",cx:0,cy:0,r:.5*t},fill:A(s,0),stroke:R(s)});break;case"square":o.push({shape:{type:"path",path:[{command:"M",values:[e,i]},{command:"L",values:[e,r]},{command:"L",values:[l,r]},{command:"L",values:[l,i]},{command:"Z",values:[]}]},fill:A(s,0),stroke:R(s)});break;case"triangle":o.push({shape:{type:"path",path:[{command:"M",values:[e,i]},{command:"L",values:[.5*l,r]},{command:"L",values:[l,i]},{command:"Z",values:[]}]},fill:A(s,0),stroke:R(s)});break;case"cross":o.push({shape:{type:"path",path:[{command:"M",values:[.5*l,r]},{command:"L",values:[.5*l,i]},{command:"M",values:[e,.5*i]},{command:"L",values:[l,.5*i]}]},stroke:B(s)});break;case"x":o.push({shape:{type:"path",path:[{command:"M",values:[e,r]},{command:"L",values:[l,i]},{command:"M",values:[l,r]},{command:"L",values:[e,i]}]},stroke:B(s)});break;case"kite":o.push({shape:{type:"path",path:[{command:"M",values:[e,.5*i]},{command:"L",values:[.5*l,r]},{command:"L",values:[l,.5*i]},{command:"L",values:[.5*l,i]},{command:"Z",values:[]}]},fill:A(s,0),stroke:R(s)})}break}case"object":switch(s.resource&&s.resource.primitive||b){case"cone":{const r=G(A(s,0),A(s,-.6),e?T:t),l=D(t,e);o.push({shape:l[0],fill:r}),o.push({shape:l[1],fill:r});break}case"inverted-cone":{const e=A(s,0),r=G(e,A(s,-.6),t),l=U(t);o.push({shape:l[0],fill:r}),o.push({shape:l[1],fill:e});break}case"cube":{const r=w(t,e);o.push({shape:r[0],fill:A(s,0)}),o.push({shape:r[1],fill:A(s,-.3)}),o.push({shape:r[2],fill:A(s,-.5)});break}case"cylinder":{const r=G(A(s,0),A(s,-.6),e?T:t),l=x(t,e);o.push({shape:l[0],fill:r}),o.push({shape:l[1],fill:r}),o.push({shape:l[2],fill:A(s,0)});break}case"diamond":{const e=L(t);o.push({shape:e[0],fill:A(s,-.3)}),o.push({shape:e[1],fill:A(s,0)}),o.push({shape:e[2],fill:A(s,-.3)}),o.push({shape:e[3],fill:A(s,-.7)});break}case"sphere":{const e=G(A(s,0),A(s,-.6));e.x1=0,e.y1=0,e.x2=.25*t,e.y2=.25*t,o.push({shape:{type:"circle",cx:0,cy:0,r:.5*t},fill:e});break}case"tetrahedron":{const e=M(t);o.push({shape:e[0],fill:A(s,-.3)}),o.push({shape:e[1],fill:A(s,0)}),o.push({shape:e[2],fill:A(s,-.6)});break}}}return o}(r,s,t)))}})),m(n).then((s=>{const t=[];return s.forEach((s=>{s.value?t.push(s.value):s.error&&r.getLogger("esri.symbols.support.previewSymbol3D").warn("error while building swatchInfo!",s.error)})),S(t,[c,u],{node:e&&e.node,scale:!1,opacity:e&&e.opacity})}))}(t,e);case"line-3d":return function(s,t){const e=s.symbolLayers,o=[],r=u(s),i=Q(t),a=(t&&t.maxSize?p(t.maxSize):null)||F;let m,n=0,c=0;return e.forEach(((s,t)=>{if(!s)return;if("line"!==s.type&&"path"!==s.type)return;const e=[];switch(s.type){case"line":{const o=Z(s,0);if(l(o))break;const r=o&&o.width||0;0===t&&(m=r);const p=Math.min(i||r,a),u=0===t?p:i?p*(r/m):p,y=u>I/2?2*u:I;c=Math.max(c,u),n=Math.max(n,y),o.width=u,e.push({shape:{type:"path",path:[{command:"M",values:[0,.5*c]},{command:"L",values:[n,.5*c]}]},stroke:o});break}case"path":{const t=Math.min(i||E,a),o=A(s,0),r=A(s,-.2),l=N(s,-.4),m=l?{color:l,width:1}:{};if("quad"===s.profile){const t=s.width,l=s.height,i=k(t&&l?t/l:1,0===l,0===t),a={...m,join:"bevel"};e.push({shape:i[0],fill:r,stroke:a}),e.push({shape:i[1],fill:r,stroke:a}),e.push({shape:i[2],fill:o,stroke:a})}else e.push({shape:P.pathSymbol3DLayer[0],fill:r,stroke:m}),e.push({shape:P.pathSymbol3DLayer[1],fill:o,stroke:m});c=Math.max(c,t),n=c}}o.push(e)})),Promise.resolve(S(o,[n,c],{node:t&&t.node,scale:r,opacity:t&&t.opacity}))}(t,e);case"polygon-3d":case"mesh-3d":return async function(s,t){const e="mesh-3d"===s.type,o=s.symbolLayers,r=Q(t),m=t&&t.maxSize?p(t.maxSize):null,n=r||E,c=[];let u=0,y=0,h=!1;for(let s=0;s<o.length;s++){const t=o.getItemAt(s),r=[];if(e&&"fill"!==t.type)continue;const p=P.fill[0];switch(t.type){case"fill":{const s=R(t),o=Math.min(n,m||O);u=Math.max(u,o),y=Math.max(y,o),h=!0;let l=A(t,0);const i="pattern"in t?t.pattern:null,c=q(t);!e&&a(i)&&"style"===i.type&&"solid"!==i.style&&c&&(l=await H(i,c)),r.push({shape:p,fill:l,stroke:s});break}case"line":{const s=Z(t,0);if(l(s))break;const e={stroke:s,shape:p};u=Math.max(u,E),y=Math.max(y,E),r.push(e);break}case"extrude":{const s={join:"round",width:1,...Z(t,-.4)},e=A(t,0),o=A(t,-.2),l=Math.min(n,m||O),i=v(l);s.width=1,r.push({shape:i[0],fill:o,stroke:s}),r.push({shape:i[1],fill:o,stroke:s}),r.push({shape:i[2],fill:e,stroke:s});const a=E,p=.7*E+.5*l;u=Math.max(u,a),y=Math.max(y,p);break}case"water":{const s=i(q(t)),e=W(s),o=W(s,2),l=W(s,3),a=z();h=!0,r.push({shape:a[0],fill:e}),r.push({shape:a[1],fill:o}),r.push({shape:a[2],fill:l});const p=Math.min(n,m||O);u=Math.max(u,p),y=Math.max(y,p);break}}c.push(r)}return S(c,[u,y],{node:t&&t.node,scale:h,opacity:t&&t.opacity})}(t,e)}return Promise.reject(new o("symbolPreview: swatchInfo3D","symbol not supported."))}export{H as getPatternDescriptor,Q as getSizeFromOptions,A as getSymbolLayerFill,J as previewSymbol3D};
