/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{i as t}from"./multiOriginJSONSupportUtils.js";import{getPathExtension as r,isAbsolute as e,isBlobProtocol as o,join as s}from"../core/urlUtils.js";import{g as n}from"./uuid.js";import{g as i}from"./metadata.js";import{n as a}from"../core/Accessor.js";import{propertyJSONMeta as p}from"../core/accessorSupport/decorators/property.js";import{r as c,t as u,M as l,i as m,p as f,a as g}from"./persistableUrlUtils.js";function d(t){return y[function(t){return t instanceof Blob?t.type:function(t){const e=r(t);return j[e]||v}(t.url)}(t)]||h}const y={},v="text/plain",h=y[v],j={png:"image/png",jpeg:"image/jpeg",jpg:"image/jpg",bmp:"image/bmp",gif:"image/gif",json:"application/json",txt:"text/plain",xml:"application/xml",svg:"image/svg+xml",zip:"application/zip",pbf:"application/vnd.mapbox-vector-tile",gz:"application/gzip","bin.gz":"application/octet-stream"};for(const t in j)y[j[t]]=t;function U(s){const n=s?.origins??[void 0];return(f,y)=>{const v=function(s,n,p){if("resource"===s?.type)return function(s,n,p){const f=i(n,p);return{type:String,read:(t,r,e)=>{const o=c(t,r,e);return f.type===String?o:"function"==typeof f.type?new f.type({url:o}):void 0},write:{writer(n,i,c,g){if(!g||!g.resources)return"string"==typeof n?void(i[c]=u(n,g)):void(i[c]=n.write({},g));const y=null==(U=n)?null:"string"==typeof U?U:U.url,v=u(y,{...g,verifyItemRelativeUrls:g&&g.verifyItemRelativeUrls?{writtenUrls:g.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},l.NO),h=f.type!==String&&(!t(this)||g&&g.origin&&this.originIdOf(p)>a(g.origin)),j={object:this,propertyName:p,value:n,targetUrl:v,dest:i,targetPropertyName:c,context:g,params:s};var U;g&&g.portalItem&&v&&!e(v)?h?function(t){const{context:e,targetUrl:o,params:s,value:n,dest:i,targetPropertyName:a}=t;if(!e.portalItem)return;const p=e.portalItem.resourceFromPath(o),c=b(n,o,e),u=d(c),l=r(p.path),m=s?.compress??!1;u===l?(e.resources&&w({...t,resource:p,content:c,compress:m,updates:e.resources.toUpdate}),i[a]=o):x(t)}(j):function({context:t,targetUrl:r,dest:e,targetPropertyName:o}){t.portalItem&&t.resources&&(t.resources.toKeep.push({resource:t.portalItem.resourceFromPath(r),compress:!1}),e[o]=r)}(j):g&&g.portalItem&&(null==v||null!=m(v)||o(v)||h)?x(j):i[c]=v}}}}(s,n,p);switch(s?.type??"other"){case"other":return{read:!0,write:!0};case"url":{const{read:t,write:r}=g;return{read:t,write:r}}}}(s,f,y);for(const t of n){const r=p(f,t,y);for(const t in v)r[t]=v[t]}}}function x(t){const{targetUrl:r,params:e,value:i,context:a,dest:p,targetPropertyName:c}=t;if(!a.portalItem)return;const u=f(r),l=u?.filename??n(),m=e?.prefix??u?.prefix,g=b(i,r,a),y=s(m,l),v=`${y}.${d(g)}`,h=a.portalItem.resourceFromPath(v);o(r)&&a.resources&&a.resources.pendingOperations.push(async function(t){const r=(await import("../request.js").then((t=>t.r))).default,{data:e}=await r(t,{responseType:"blob"});return e}(r).then((t=>{h.path=`${y}.${d(t)}`,p[c]=h.itemRelativeUrl})).catch((()=>{})));const j=e?.compress??!1;a.resources&&w({...t,resource:h,content:g,compress:j,updates:a.resources.toAdd}),p[c]=h.itemRelativeUrl}function w({object:t,propertyName:r,updates:e,resource:o,content:s,compress:n}){e.push({resource:o,content:s,compress:n,finish:e=>{!function(t,r,e){"string"==typeof t[r]?t[r]=e.url:t[r].url=e.url}(t,r,e)}})}function b(t,r,e){return"string"==typeof t?{url:r}:new Blob([JSON.stringify(t.toJSON(e))],{type:"application/json"})}export{U as p};
