/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{a as t,b as a}from"./enums4.js";import{M as r}from"./MaterialKey.js";import{i as o}from"./maybe.js";import{w as n}from"./Utils18.js";import{D as i,C as s}from"./definitions.js";import{D as c}from"./enums3.js";import{a as l}from"./screenUtils.js";import{a as d}from"./heatmapUtils.js";import u from"../Color.js";class m{static getStorageSpec(e){return null}static createOrUpdateRendererSchema(e,t){return o(e)&&"default"===e.type?e:{type:"default"}}static getVariation(e){return{}}static getVariationHash(e){return 0}}m.type="default",m.programSpec=null;class p extends m{static getStorageSpec({attributes:e}){return{visualVariables:!1,attributes:e??null}}static _createRendererSchema(){return{type:"dot-density",colors:new Float32Array(32),dotValue:-1,dotSize:-1,dotScale:-1,dotBlending:!1,backgroundColor:new Float32Array(4),activeDots:new Float32Array(8),seed:-1}}static createOrUpdateRendererSchema(e,t){const{attributes:a,dotValue:r,referenceScale:s,dotSize:c,dotBlendingEnabled:l,seed:d,backgroundColor:u}=t,m=o(e)&&"dot-density"===e.type?e:this._createRendererSchema();m.dotValue=r,m.dotSize=c,m.dotScale=s,m.dotBlending=l,m.seed=d;const{colors:p,activeDots:y,backgroundColor:h}=m;for(let e=0;e<i;e++){const t=e>=a.length?null:a[e].color;n(p,t,4*e)}for(let e=0;e<8;e++)y[e]=e<t.attributes.length?1:0;return n(h,u),m}static getVariation(e){return{ddDotBlending:e.dotBlending}}static getVariationHash(e){return e.dotBlending?1:0}}p.type="dot-density",p.programSpec={shader:"materials/fill",vertexLayout:{geometry:[{location:0,name:"a_pos",count:2,type:c.SHORT},{location:1,name:"a_id",count:3,type:c.UNSIGNED_BYTE},{location:2,name:"a_bitset",count:1,type:c.UNSIGNED_BYTE},{location:3,name:"a_inverseArea",count:1,type:c.FLOAT}]}};class y extends m{static getStorageSpec({field:e,valueExpression:t}){return{visualVariables:!1,attributes:e||t?[{field:e,valueExpression:t}]:null}}static _createRendererSchema(){return{type:"heatmap",radius:-1,referenceScale:-1,isFieldActive:0,minDensity:-1,densityRange:-1,kernel:null,gradient:null,gradientHash:"invalid"}}static createOrUpdateRendererSchema(e,t){const{radius:a,minDensity:r,maxDensity:n,referenceScale:i,field:s,valueExpression:c,colorStops:u}=t,m=n-r,p=s||c?1:0,y=u.map((({color:e,ratio:t})=>`${t}:${e.toString()}`)).join();let h,S=!0;return o(e)&&"heatmap"===e.type?(h=e,S=y!==e.gradientHash):h=this._createRendererSchema(),h.radius=l(a),h.minDensity=r,h.densityRange=m,h.referenceScale=i,h.isFieldActive=p,S&&(h.gradient=d(u),h.gradientHash=y),h}}y.type="heatmap",y.programSpec={shader:"materials/icon/heatmapAccumulate",vertexLayout:{geometry:[{location:0,name:"a_pos",count:2,type:c.SHORT},{location:1,name:"a_vertexOffset",count:2,type:c.SHORT},{location:4,name:"a_id",count:4,type:c.UNSIGNED_BYTE}]}};class h extends m{static getStorageSpec({attributes:e}){return{visualVariables:!0,attributes:e??null}}static _createRendererSchema(){return{type:"pie-chart",colors:new Float32Array(4*s),defaultColor:new Float32Array(4),othersColor:new Float32Array(4),outlineColor:new Float32Array(4),holePercentage:0,sectorThreshold:0,outlineWidth:1,numberOfFields:10}}static createOrUpdateRendererSchema(e,t){const{attributes:a,defaultColor:r,holePercentage:i,othersCategory:c,outline:d}=t,m=o(e)&&"pie-chart"===e.type?e:this._createRendererSchema();for(let e=0;e<s;e++){const t=e>=a.length?new u([0,0,0,0]):a[e].color;n(m.colors,t,4*e)}return n(m.defaultColor,r),n(m.othersColor,c?.color),n(m.outlineColor,d?.color),m.outlineWidth=l(d?.width||0),m.holePercentage=i,m.sectorThreshold=c?.threshold||0,m.numberOfFields=a.length,m}static getVariation(e){return{numberOfFields:e.numberOfFields}}static getVariationHash(e){return e.numberOfFields}}function S(t,a){if(t.type!==a)throw new e("material-view-model:unexpected-renderer-schema",`expected to find renderer schema of type "${a}" but found type "${t.type}"`)}function g(e){switch(e?.type){case"dot-density":return p;case"heatmap":return y;case"pie-chart":return h;default:return m}}function f(e){const{geometryType:o,symbologyType:n}=r.load(e);switch(o){case t.FILL:if(n===a.DOT_DENSITY)return p;break;case t.MARKER:switch(n){case a.HEATMAP:return y;case a.PIE_CHART:return h}}return m}h.type="pie-chart",h.programSpec={shader:"materials/pie",vertexLayout:{geometry:[{location:0,name:"a_pos",count:2,type:c.SHORT},{location:1,name:"a_vertexOffset",count:2,type:c.SHORT},{location:2,name:"a_texCoords",count:2,type:c.UNSIGNED_SHORT},{location:3,name:"a_bitSetAndDistRatio",count:2,type:c.UNSIGNED_SHORT},{location:4,name:"a_id",count:4,type:c.UNSIGNED_BYTE},{location:5,name:"a_color",count:4,type:c.UNSIGNED_BYTE,normalized:!0},{location:6,name:"a_outlineColor",count:4,type:c.UNSIGNED_BYTE,normalized:!0},{location:7,name:"a_sizeAndOutlineWidth",count:4,type:c.UNSIGNED_BYTE},{location:8,name:"a_zoomRange",count:2,type:c.UNSIGNED_SHORT}]},hittestAttributes:["a_vertexOffset","a_texCoords"]};export{m as T,S as a,g as b,f as g};
