/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as t}from"./tslib.es6.js";import e from"../core/Accessor.js";import i from"../core/Collection.js";import{L as s}from"./Logger.js";import{a as n,i as o,e as r,d as a,g as l,r as p,u as m,f as d}from"./maybe.js";import{watch as c,syncAndInitial as u,initial as h,sync as f,when as g,on as y}from"../core/reactiveUtils.js";import{property as _}from"../core/accessorSupport/decorators/property.js";import{equals as v}from"../core/lang.js";import"./ensureType.js";import{subclass as j}from"../core/accessorSupport/decorators/subclass.js";import{A as S}from"./AnalysisView3D.js";import M,{L as b,l as w}from"../analysis/LengthDimension.js";import P from"../core/Handles.js";import{x as C,w as D,n as T,c as O}from"./unitUtils.js";import{d as x,r as R}from"./mathUtils.js";import{t as A}from"./quantityUtils.js";import{a as z,i as H,g as L,f as U}from"./mat4.js";import{c as E}from"./mat4f64.js";import{d as V,c as I,e as k,v as F,h as G,m as B,E as q,Z as W,n as N,w as Q,K,H as $,g as Z,b as J,j as Y,l as X,s as tt,f as et}from"./vec3.js";import{A as it}from"./vector.js";import{s as st}from"./ray.js";import{m as nt}from"./dehydratedFeatures.js";import{c as ot}from"./hydratedFeatures.js";import{E as rt,L as at}from"./Segment.js";import{e as lt,a as pt}from"./euclideanLengthMeasurementUtils.js";import{ignoreAbortErrors as mt,c as dt}from"../core/promiseUtils.js";import{m as ct,d as ut}from"./handleUtils.js";import ht from"../Color.js";import"../geometry.js";import{c as ft}from"./Cyclical.js";import{a as gt}from"./screenUtils.js";import{f as yt,c as _t,s as vt,n as jt}from"./plane.js";import{e as St,M as Mt,w as bt,d as wt,u as Pt,a as Ct,b as Dt}from"./manipulatorUtils.js";import{a as Tt,s as Ot,h as xt}from"./dragEventPipeline3D.js";import{r as Rt,R as At,p as zt,k as Ht}from"./DefaultBufferWriter.js";import{c as Lt}from"./GeometryUtil.js";import{c as Ut,r as Et,E as Vt}from"./dragEventPipeline.js";import{M as It,a as kt}from"./interfaces3.js";import Ft from"../geometry/Point.js";import{HandleOwner as Gt}from"../core/HandleOwner.js";import"./object.js";import{g as Bt}from"./Factory.js";import{V as qt,S as Wt}from"./VerticesVisualElement.js";import{L as Nt,a as Qt,l as Kt}from"./LineVisualElement.js";import{R as $t}from"./Material.js";import{I as Zt}from"./ImageMaterial.js";import{c as Jt}from"./lineStippleUtils.js";import{E as Yt,a as Xt,c as te}from"./EditGeometryOperations.js";import{n as ee}from"./nextTick.js";import ie from"../views/interactive/snapping/FeatureSnappingLayerSource.js";import{d as se}from"./Settings2.js";import ne from"../views/interactive/snapping/SnappingOptions.js";import{S as oe,F as re}from"./SnappingManager.js";import{S as ae}from"./SnappingContext.js";import{S as le}from"./SnappingDragPipelineStep.js";import{S as pe}from"./SnappingOperation.js";import{n as me,S as de}from"./Intersector.js";import{A as ce}from"./AnalysisToolBase.js";import{S as ue}from"./keybindings.js";import{d as he}from"./screenUtils2.js";import"../intl.js";import{Z as fe}from"./vec4f64.js";import{f as ge}from"./quantityFormatUtils.js";import{f as ye,c as _e}from"./vec4f32.js";import{O as ve}from"./Object3DVisualElement.js";import{l as je,c as Se}from"./line.js";import{n as Me}from"./ElevationQuery.js";import{R as be}from"./RenderTexture.js";import{o as we}from"./locale.js";import{f as Pe}from"./messages.js";import Ce from"../views/analysis/LengthDimensionResult.js";import{c as De,r as Te,a as Oe}from"./analysisViewUtils.js";import xe from"../views/analysis/DimensionAnalysisView.js";import"./get.js";import"./utils.js";import"./metadata.js";import"./ArrayPool.js";import"./tracking.js";import"./watch.js";import"../core/scheduling.js";import"../core/Error.js";import"../config.js";import"./string.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../core/Promise.js";import"../core/Clonable.js";import"../core/JSONSupport.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"./reader.js";import"../geometry/SpatialReference.js";import"./writer.js";import"../geometry/support/webMercatorUtils.js";import"./Ellipsoid.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"./jsonMap.js";import"../geometry/support/jsonUtils.js";import"./common.js";import"./projectionEllipsoid.js";import"./byteSizeEstimations.js";import"./mat3f64.js";import"./quatf64.js";import"./vec2f64.js";import"./aaBoundingBox.js";import"./aaBoundingRect.js";import"./quantizationUtils.js";import"../layers/support/Field.js";import"./enumeration.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"../Graphic.js";import"../PopupTemplate.js";import"../layers/support/fieldUtils.js";import"./arcadeOnDemand.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"../popup/support/FieldInfoFormat.js";import"./date.js";import"./number.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"./chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"./colorUtils.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils2.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils3.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../core/urlUtils.js";import"./persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../kernel.js";import"../request.js";import"../core/Loadable.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./vec2.js";import"./VisualElement.js";import"./viewUtils.js";import"./elevationInfoUtils.js";import"./unitConversionUtils.js";import"./lengthUtils.js";import"./projector.js";import"./widgetUtils.js";import"./TextOverlayItem.js";import"../geometry/projection.js";import"./pe.js";import"./assets.js";import"./geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./mathUtils2.js";import"./measurementUtils2.js";import"./compilerUtils.js";import"./mat3.js";import"./lineSegment.js";import"./ElevationProvider.js";import"./ray2.js";import"./basicInterfaces.js";import"./Camera.js";import"./frustum.js";import"./ViewingMode.js";import"./Util2.js";import"./graphicUtils.js";import"./VertexAttribute.js";import"./bufferWriterUtils.js";import"./triangle.js";import"./Indices.js";import"./ShaderTechniqueConfiguration.js";import"./RenderSlot.js";import"./vec3f32.js";import"./mat4f32.js";import"./requestImageUtils.js";import"./enums3.js";import"./Texture.js";import"./context-util.js";import"./FramebufferObject.js";import"./VertexElementDescriptor.js";import"./BufferView.js";import"./ColorMaterial.js";import"./OrderIndependentTransparency.js";import"./OutputHighlight.glsl.js";import"./VertexColor.glsl.js";import"./NativeLineMaterial.js";import"./utils20.js";import"./doublePrecisionUtils.js";import"./InterleavedLayout.js";import"./types.js";import"./verticalOffsetUtils.js";import"./quat.js";import"./sphere.js";import"./Octree.js";import"./floatRGBA.js";import"./drawUtils.js";import"./WatchUpdatingTracking.js";import"./settings3.js";import"./colorUtils2.js";import"./LaserlineVisualElement.js";import"./glUtil.js";import"./CameraSpace.glsl.js";import"./PointVisualElement.js";import"./VisualElementResources.js";import"./MultipassGeometryTest.glsl.js";import"./HUDMaterial.js";import"./VisualVariables.glsl.js";import"./GLTextureMaterial.js";import"./RightAngleQuadVisualElement.js";import"./RightAngleSnappingHint.js";import"./geometry2dUtils.js";import"./QueryEngineResult.js";import"./ItemCache.js";import"./MemCache.js";import"../core/sql/WhereClause.js";import"./_commonjsHelpers.js";import"./utils13.js";import"./generateRendererUtils.js";import"./colorRamps.js";import"../rest/support/AlgorithmicColorRamp.js";import"../rest/support/ColorRamp.js";import"../rest/support/MultipartColorRamp.js";import"./projectionSupport.js";import"./json.js";import"./SnappingCandidate.js";import"./utils21.js";import"../geometry/support/normalizeUtils.js";import"./normalizeUtilsCommon.js";import"./simplify.js";import"./utils4.js";import"./utils5.js";import"./featureConversionUtils.js";import"./OptimizedFeature.js";import"./OptimizedFeatureSet.js";import"./PointSnappingHint.js";import"./dehydratedFeatureComparison.js";import"./Scheduler.js";import"./ObservableValue.js";import"./debugFlags2.js";import"./boundedPlane.js";import"./unitFormatUtils.js";import"./vec2f32.js";import"./asyncUtils.js";import"./edgeUtils.js";import"./earcut.js";import"./vec32.js";import"./visualVariableUtils.js";import"./sizeVariableUtils.js";import"./debugFlags.js";import"./triangulationUtils.js";import"./deduplicate.js";import"./line2.js";import"./interfaces4.js";import"./NestedMap.js";import"./SSAOHelper.js";import"./objectResourceUtils.js";import"./devEnvironmentUtils.js";import"./DefaultMaterial_COLOR_GAMMA.js";import"./Version.js";import"./mat3f32.js";import"./symbolColorUtils.js";import"./utils6.js";import"./jsonUtils.js";import"./parser.js";import"../symbols/support/cimSymbolUtils.js";import"./utils7.js";import"./callExpressionWithFeature.js";import"../geometry/support/MeshComponent.js";import"../geometry/support/MeshMaterial.js";import"../geometry/support/MeshTexture.js";import"./imageUtils.js";import"../geometry/support/MeshMaterialMetallicRoughness.js";import"./projection.js";function Re(t){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i,dimension:{offset:s,measureType:n,orientation:o}}=t;return{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i,offset:s,measureType:n,orientation:o}}function Ae({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e,offset:i,measureType:s,orientation:r},a,l=null){if(n(t)||n(e))return null;const p=Ue(o(l)?l.directSegment:new rt,{elevationAlignedStartPoint:t,elevationAlignedEndPoint:e},a),m=o(l)?l.primaryOffsetAxis:V();Ie(m,{measureType:s,elevationAlignedStartPoint:t,elevationAlignedEndPoint:e,directSegment:p,orientation:r,renderCoordsHelper:a});const d=o(l)?l.dimensionSegment:new rt;return Fe({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e})&&s===b.Vertical?(I(d.startRenderSpace,p.startRenderSpace),I(d.endRenderSpace,p.endRenderSpace)):Ge(d,{offsetAxis:m,offset:i,relativeToSegment:p,renderCoordsHelper:a}),{directSegment:p,dimensionSegment:d,primaryOffsetAxis:m,spatialReference:a.spatialReference}}function ze(t,e,i,s){return e===He.Start?(I(t.startRenderSpace,i.startRenderSpace),I(t.endRenderSpace,s.startRenderSpace)):(I(t.startRenderSpace,i.endRenderSpace),I(t.endRenderSpace,s.endRenderSpace)),t}var He;function Le(t,e,i,s){switch(e){case b.Direct:return Ue(t,i,s);case b.Horizontal:case b.Vertical:{const{elevationAlignedStartPoint:n,elevationAlignedEndPoint:o,dimension:r,geometry:a}=i;let l;if(r.measureType===b.Direct){const t=function(t,e){const i=t.directSegment.eval(.5,st.get()),s=e.worldUpAtPosition(i,st.get()),n=t.dimensionSegment.eval(.5,st.get()),o=F(st.get(),n,i);return!q(o,W)&&B(o,s)>0}(a,s);l=t===n.z>o.z,e===b.Horizontal&&(l=!l)}else l=!function(t){const{startRenderSpace:e,endRenderSpace:i}=t.dimensionSegment,{startRenderSpace:s,endRenderSpace:n}=t.directSegment;return K(s,e)<K(n,i)}(a);const[p,m]=l?[n,o]:[o,n],d=ot(m,Ee);return e===b.Horizontal?d.z=p.z:(d.x=p.x,d.y=p.y),s.toRenderCoords(p,t.startRenderSpace),s.toRenderCoords(d,t.endRenderSpace),t}}}function Ue(t,e,i){return i.toRenderCoords(e.elevationAlignedStartPoint,t.startRenderSpace),i.toRenderCoords(e.elevationAlignedEndPoint,t.endRenderSpace),t}!function(t){t[t.Start=0]="Start",t[t.End=1]="End"}(He||(He={}));const Ee=nt(0,0,0,null),Ve=new rt;function Ie(t,e){const{measureType:i,elevationAlignedStartPoint:s,elevationAlignedEndPoint:n,directSegment:{startRenderSpace:o,endRenderSpace:a},directSegment:l,renderCoordsHelper:p}=e,m=l.eval(.5,st.get()),d=p.worldUpAtPosition(m,st.get()),c=p.worldBasisAtPosition(m,it.Y,st.get());switch(i){case b.Horizontal:I(t,d);break;case b.Vertical:B(o,d)<B(a,d)?F(t,a,o):F(t,o,a),G(t,t,d),G(t,t,d);break;case b.Direct:{const i=r(e.orientation,0);if(Fe({elevationAlignedStartPoint:s,elevationAlignedEndPoint:n}))z(ke,-x(i),d),k(t,c,ke);else{const e=F(st.get(),a,o),s=G(st.get(),e,d);G(s,s,e),z(ke,x(i),e),k(t,s,ke)}break}}return q(t,W)?I(t,c):N(t,t)}const ke=E();function Fe({elevationAlignedStartPoint:t,elevationAlignedEndPoint:e}){return o(t)&&o(e)&&t.x===e.x&&t.y===e.y}function Ge(t,e){const{offsetAxis:i,offset:s,relativeToSegment:{startRenderSpace:n,endRenderSpace:o},relativeToSegment:r,renderCoordsHelper:a}=e,l=s/a.unitInMeters,[p,m]=function(t,e,i,s=0){const n=B(e,i),o=B(t,i),r=Math.abs(n-o)+s;return n>o?[r,s]:[s,r]}(n,o,i,l);return Q(t.startRenderSpace,r.startRenderSpace,i,p),Q(t.endRenderSpace,r.endRenderSpace,i,m),t}function Be(t,e,i){const s=e.directSegment.eval(.5,st.get());return i.worldUpAtPosition(s,t)}function qe(t,e){const{startRenderSpace:i,endRenderSpace:s}=e.directSegment;return F(t,s,i)}function We(t,e,i={invert:!1}){const{startRenderSpace:s,endRenderSpace:n}=e.dimensionSegment;return i.invert?F(t,s,n):F(t,n,s)}function Ne(t,e){const i=t.directSegment.eval(.5,st.get());return e.headingAtPosition(i,t.primaryOffsetAxis)}const Qe=V();function Ke(t){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:i}=t;if(n(e)||n(i))return!1;const s=pt(e,i);return o(s)&&A(s,"meters").value>$e}const $e=1e5;function Ze(t){return o(t.geometry)}let Je=class extends e{constructor(t){super(t),this._handles=new P}initialize(){const{computations:t}=this.analysisViewData;for(const e of t)this._addComputation(e);this.addHandles(t.on("change",(({added:t,removed:e})=>{for(const t of e)this._removeComputation(t);for(const e of t)this._addComputation(e)})))}destroy(){this._handles=a(this._handles)}get analysis(){return this.analysisViewData.analysis}get _defaultUnit(){return T(this.view)}_addComputation(t){this._handles.has(t)||this._handles.add(c((()=>Re(t)),(e=>{const{measureType:i}=e;if(Ke(e)&&i!==b.Direct){const e=Math.round(O($e,"meters","kilometers"));return s.getLogger(this.declaredClass).warnOnce(`A ${i} dimension in the analysis (id: '${this.analysis.id}') will not display, because only direct dimensions can measure lengths greater than ${e} km. Update the measureType of the affected dimension to "direct" to display it.`),void(t.geometry=null)}const o=Ae(e,this.view.renderCoordsHelper,t.geometry);t.geometry=o,t.result.length=function(t,e,i){if(n(t))return null;const s=t.dimensionSegment.startRenderSpace,o=t.dimensionSegment.endRenderSpace,r=lt(s,o,t.spatialReference);if(n(r))return null;const a=e===b.Vertical?C(r.value,r.unit,i):D(r.value,r.unit,i);return A(r,a)}(o,i,this._defaultUnit)}),u),t)}_removeComputation(t){this._handles.remove(t)}};t([_({constructOnly:!0})],Je.prototype,"analysisViewData",void 0),t([_({constructOnly:!0})],Je.prototype,"view",void 0),t([_()],Je.prototype,"analysis",null),t([_()],Je.prototype,"_defaultUnit",null),Je=t([j("esri.views.3d.analysis.Dimension.support.DimensionController")],Je);const Ye={main:new ht([255,127,0])};class Xe{constructor(){this.color=Ye.main,this.opacity=.5,this.radius=5}}class ti{constructor(){this.color=new ht([127,127,127]),this.opacity=.5,this.radius=5}}class ei{constructor(){this.lineSizeFraction=.8}}class ii{constructor(){this.color=Ye.main,this.opacity=.5,this.linePaddingPx=4,this.focusedLinePaddingPx=6,this.lengthFraction=.5,this.minLengthMeters=.1}}class si{constructor(){this.calloutOffsetPx=18,this.calloutOpacity=.5,this.calloutWidth=2,this.discScale=.3,this.focusMultiplier=2}}class ni{constructor(){this.lineSizeFraction=.25}}class oi{constructor(){this.marginPx=20,this.minScreenLengthFontSizeFactor=5}}class ri{constructor(){this.color=new ht([255,127,0,.5])}}const ai=new class{constructor(){this.pointManipulators=new Xe,this.offsetManipulator=new ii,this.orientationManipulator=new si,this.markers=new ei,this.labels=new oi,this.offsetLine=new ni,this.constraint=new ri,this.constraintThresholdPx=10,this.initialOffsetPx=50,this.orientationSnapThresholdDegrees=5,this.disabledPointIndicator=new ti,this.smallScreenLengthLineSizeFactor=2,this.pointerMoveTimeoutMs=2500}};class li{constructor(t){this.start=t.start,this.end=t.end,this.offset=t.offset,this.heading=t.heading,this.rotation=t.rotation,this.direct=t.direct,this.horizontal=t.horizontal,this.vertical=t.vertical}manipulatorName(t){return Object.keys(this).find((e=>this.hasOwnProperty(e)&&t===this[e]))}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(t){for(const e of w)t(this.manipulatorForMeasureType(e),e)}manipulatorForMeasureType(t){switch(t){case b.Direct:return this.direct;case b.Horizontal:return this.horizontal;case b.Vertical:return this.vertical}}}function pi(t,{lineSizePt:e,material:i}){const{calloutOffsetPx:s,calloutOpacity:n,calloutWidth:o,discScale:r,focusMultiplier:a}=ai.orientationManipulator;return{calloutLength:.25*Rt*ai.markers.lineSizeFraction*gt(e)+s,calloutOpacity:n,calloutWidth:o,customStateMask:bi,discScale:r,focusMultiplier:a,material:i,metadata:t}}function mi(t,e){return wt(t,pi(e.metadata,e))}function di(t,e){Pt(t,pi(t.metadata,e))}function ci(t){const{cancel:e,computation:i,settingHeading:s,steps:n,view:o}=t;if(!Ze(i))return;const{renderCoordsHelper:a}=o,{dimension:l,geometry:p}=i,m=V(),d=_i(V(),p,p.directSegment,a),c=vi(st.get(),{forHeading:s,geometry:p,renderCoordsHelper:a}),u=yt(d,c,_t()),h=r(l.orientation,s?()=>Ne(p,o.renderCoordsHelper):0);n.next(Ot(o,u)).next((t=>{"start"===t.action&&I(m,t.renderStart);const e=jt(u),i=Ct(m,t.renderEnd,d,e);let n=h-R(i);s||(n=function(t){const e=ft.normalize(t)%90;return e<ai.orientationSnapThresholdDegrees?t-e:90-e<ai.orientationSnapThresholdDegrees?t+(90-e):t}(n)),l.orientation=n})),e.next(Et(l,["orientation"]))}function ui(t,e,i,s){const n=J(st.get(),i.endRenderSpace,i.startRenderSpace);G(n,n,s);const o=yt(i.startRenderSpace,n,_t()),r=yt(i.startRenderSpace,s,_t()),a=e.offset;let l,p=0;const m=new Vt;return m.next(Ot(t,o)).next((i=>{"start"===i.action&&(p=vt(r,i.renderStart));const s=(vt(r,i.renderEnd)-p)*t.renderCoordsHelper.unitInMeters;e.offset=a+s,l=i})),t=>(m.execute(t),l)}function hi(t,e){const{directSegment:i}=t,{renderCoordsHelper:s}=e,n=Be(st.get(),t,s),o=qe(st.get(),t),r=G(st.get(),o,n),{viewForward:a}=e.state.camera;B(r,a)>0&&Z(r,r,-1);const l=i.eval(.5,st.get());return s.headingAtPosition(l,r)}function fi(t,e,i,{forHeading:s}){const{dimension:n,geometry:o}=e,{primaryOffsetAxis:r}=o,a=Z(gi,r,n.offset>=0?1:-1),l=vi(yi,{forHeading:s,geometry:o,renderCoordsHelper:i});G(l,l,a);const p=Dt(a,l,W,Ci);t.modelTransform=p,t.renderLocation=_i(wi,o,o.dimensionSegment,i)}const gi=V(),yi=V();function _i(t,e,i,s){const{startRenderSpace:n,endRenderSpace:o}=i,r=function(t,e){const i=qe(ji,t),s=Be(Si,t,e);return B(i,s)>0}(e,s)?n:o;return I(t,r)}function vi(t,{forHeading:e,geometry:i,renderCoordsHelper:s}){return e?Be(t,i,s):We(t,i,{invert:!0})}const ji=V(),Si=V();function Mi(t){return gt(t)+ai.offsetManipulator.focusedLinePaddingPx}const bi=It.Custom1,wi=V(),Pi=V(),Ci=E(),Di=new rt;var Ti;function Oi(t,e){if(Ke(t))return Ti.Direct;const{geometry:i}=t;if(n(i)||Y(i.directSegment.startRenderSpace,i.directSegment.endRenderSpace))return null;const{constraintThresholdPx:s}=ai,{camera:o}=e.state,r=Be(st.get(),i,e.renderCoordsHelper),a=qe(st.get(),i),l=Z(st.get(),r,B(a,r)),p=J(st.get(),a,l),m=$(p),d=$(l),{startRenderSpace:c,endRenderSpace:u}=i.directSegment,h=Math.max(o.computeRenderPixelSizeAt(c)*s,o.computeRenderPixelSizeAt(u)*s)**2;return m<h?Ti.Vertical:d<h?Ti.Horizontal:null}!function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical",t[t.Direct=2]="Direct"}(Ti||(Ti={}));const xi=new Map;let Ri=class extends Gt{constructor(t){super(t),this._stagedDimension=null,this._computationManipulators=new Map,this._computationHandles=new P,this._snappingPipeline=new le,this._snappingManagerResult=function(t){if(!xi.has(t)){const e=function(t,e){const s=new ne({enabled:!0,selfEnabled:!1,featureEnabled:!0,distance:e?.distance??se.distance,touchSensitivityMultiplier:e?.touchSensitivityMultiplier??se.touchSensitivityMultiplier});return{...c((()=>t.map?.allLayers?.toArray()??[]),(t=>{s.featureSources=new i(t.map((t=>new ie({layer:t,enabled:!0}))))}),h),options:s}}(t,{distance:10}),s=function(t,e){return new oe({view:t,options:e,snappingEnginesFactory:(e,i)=>[new re({view:t,spatialReference:t.spatialReference,options:i})]})}(t,e.options);xi.set(t,{referenceCount:0,snappingManager:s,remove:()=>{e.remove(),s.destroy()}})}const e=xi.get(t);e.referenceCount++;const s=ct((()=>function(t,e){e.referenceCount--,e.referenceCount>0||ee((()=>{0===e.referenceCount&&(e.remove(),xi.delete(t))}))}(t,e)));return{snappingManager:e.snappingManager,...s}}(t.view),this.addHandles(this._snappingManagerResult),this._unfocusedOffsetManipulatorMaterial=Ai(),this._focusedOffsetManipulatorMaterial=Ai(),this._thinOffsetManipulatorMaterial=Ai(),this._thinOffsetManipulatorMaterial.setParameters({stipplePattern:Jt(2)}),this._constraintSnappingIndicator=new Nt({view:t.view,attached:!0,width:1,color:ht.toUnitRGBA(ai.constraint.color),renderOccluded:$t.OccludeAndTransparent,stipplePattern:Jt(5)});const e=ht.toUnitRGBA(ai.disabledPointIndicator.color);e[3]*=ai.disabledPointIndicator.opacity,this._stagedStartIndicator=new qt({view:t.view,attached:!1,color:e,size:2*ai.disabledPointIndicator.radius,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:t.view.renderCoordsHelper.spatialReference,outlineSize:0,renderOccluded:$t.OccludeAndTransparent})}initialize(){this._snappingOperation=new pe({view:this.view}),this._orientationManipulatorTexture=Bt(this.view.toolViewManager.textures),this._orientationManipulatorMaterial=new Zt({transparent:!0,writeDepth:!1,textureId:this._orientationManipulatorTexture.texture.id,renderOccluded:$t.Opaque});const{computations:t}=this.analysisViewData;for(const e of t)this._addComputation(e);this.addHandles([t.on("after-add",(t=>this._addComputation(t.item))),t.on("after-remove",(t=>this._removeComputation(t.item)))]),this.addHandles([c((()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation})),(({stagedPoint:t,stagedComputation:e})=>{if(n(e)||n(t))return;const i=ot(t,new Ft);this._applyPointUpdate(e,{endPoint:i})}),f),c((()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator})),((t,e)=>{const{stagedDimension:i,selectedComputation:s,firstGrabbedManipulator:n}=t;if(i===e.stagedDimension&&n===e.firstGrabbedManipulator){for(const i of[s,e.selectedComputation])if(o(i)){const e=this._computationManipulators.get(i);this._updateManipulators(i,e,t)}}else for(const[e,i]of this._computationManipulators)this._updateManipulators(e,i,t)}),u),c((()=>this.analysis.style.lineSize),(t=>{this._updateManipulatorStyle(t)}),h),c((()=>this.view.state.camera),(()=>{o(this._stagedComputation)&&this._updateStagedDimensionOffset(this._stagedComputation)})),c((()=>l(this._stagedComputation,(t=>{const e=t.elevationAlignedStartPoint,i=V();return o(e)&&this.view.renderCoordsHelper.toRenderCoords(e,i)?i:null}))),(t=>{o(t)?(this._stagedStartIndicator.vertices=[t],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1}))]),this.addHandles(this._constraintHandles),this.addHandles(this._snappingIndicatorHandles)}destroy(){this._snappingOperation=a(this._snappingOperation),this._computationHandles.destroy(),this._constraintSnappingIndicator.destroy(),this._stagedStartIndicator.destroy(),this._orientationManipulatorMaterial.dispose(),this._orientationManipulatorTexture.release()}get updating(){return this.updatingHandles.updating||this._snappingManager.updating}get firstGrabbedManipulator(){return this.parentTool.firstGrabbedManipulator}get hasGrabbedManipulators(){return this.parentTool.hasGrabbedManipulators}get _snappingManager(){return this._snappingManagerResult.snappingManager}get _activeComputation(){if(o(this._stagedComputation))return this._stagedComputation;const{selectedComputation:t}=this.analysisViewData;return this.hasGrabbedManipulators&&o(t)?t:null}get _stagedComputation(){const t=this._stagedDimension,e=this.analysisViewData.computations.at(-1);return n(t)||n(e)||e.dimension!==t?null:e}get _constraintHandles(){return[g((()=>this.analysisViewData.selectedComputation),(t=>{t.previousConstraint=Oi(t,this.view)}),{...u,equals:v}),c((()=>{const t=this._activeComputation;if(n(t))return null;const{measureType:e,orientation:i}=t.dimension;return{measureType:e,orientation:i,computation:t}}),((t,e)=>{if(o(t)&&n(e)){const{measureType:e,orientation:i,computation:s}=t;switch(s.previousConstraint){case Ti.Horizontal:s.preConstraintProperties={measureType:b.Horizontal,orientation:0};break;case Ti.Vertical:s.preConstraintProperties={measureType:b.Vertical,orientation:0};break;case Ti.Direct:s.preConstraintProperties={measureType:b.Direct,orientation:i};break;default:s.preConstraintProperties={measureType:e,orientation:i}}}n(t)&&o(e)&&(e.computation.preConstraintProperties=null)}),f)]}get _snappingIndicatorHandles(){const t="snapping-indicator-event-handles";return[c((()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation})),(({stagedComputation:e,activeComputation:i})=>{const s=this._constraintSnappingIndicator;if(this.removeHandles(t),n(i))s.attached=!1;else if(i===e)s.attached=!0;else{const{start:e,end:n}=this._computationManipulators.get(i),o=()=>{s.attached=e.grabbing||n.grabbing};o(),this.addHandles([e.events.on("grab-changed",o),n.events.on("grab-changed",o)],t)}})),c((()=>{const t=this._activeComputation;return o(t)?{geometry:t.geometry,constraint:t.previousConstraint}:{}}),(({geometry:t,constraint:e})=>{const i=this._constraintSnappingIndicator;o(t)&&o(e)&&e!==Ti.Direct?(i.visible=!0,i.setGeometryFromSegment(t.directSegment)):i.visible=!1}))]}removeStaged(){return!!o(this._stagedDimension)&&(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0)}onDeactivate(){this.removeStaged(),this._resetSnappingState()}onClick(t){const{_stagedDimension:e}=this;if(n(e)){const e=this._onUnstagedClick(t);return this.analysis.dimensions.add(e),null}return this._onStagedClick(t),e}onPointerMove({mapPoint:t,pointerType:e}){if("touch"===e)return;const i=this._snappingContext(e);this.updatingHandles.addPromise(mt(this._snappingOperation.snap({point:t},this._snappingManager,i)))}onManipulatorSelectionChanged(){o(this.analysisViewData.selectedComputation)&&(this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null))}_onUnstagedClick({mapPoint:t,pointerType:e}){let i=t;if("mouse"===e){const s=this._snappingContext(e);i=this._snappingManager.update({point:t,context:s})}const s=new M({startPoint:ot(i,new Ft),endPoint:null,measureType:b.Horizontal});return this._stagedDimension=s,this._resetSnappingState(),s}_onStagedClick({mapPoint:t,pointerType:e}){const i=this._stagedComputation;if(n(i))return;let s=t;if("mouse"===e){const i=this._snappingContext(e);s=this._snappingManager.update({point:t,context:i})}const o=ot(s,new Ft);this._applyPointUpdate(i,{endPoint:o}),this._stagedDimension=null,this._resetSnappingState()}_resetSnappingState(){this._snappingManager.doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}_addComputation(t){if(this._computationManipulators.has(t))return;const e=this._setupPointManipulator(t,{isStart:!0}),i=this._setupPointManipulator(t,{isStart:!1}),s=this._setupOffsetManipulator(t),n=this._setupHeadingManipulator(t),o=this._setupRotationManipulator(t),r=this._setupMeasureTypeManipulator(t,b.Direct),a=this._setupMeasureTypeManipulator(t,b.Horizontal),l=this._setupMeasureTypeManipulator(t,b.Vertical),p=new li({start:e,end:i,offset:s,heading:n,rotation:o,direct:r,horizontal:a,vertical:l});this._setupComputationToManipulatorsSync(t,p),this._computationManipulators.set(t,p),this.manipulators.addMany(p.values())}_removeComputation(t){const e=this._computationManipulators.get(t);if(!n(e)){this._computationHandles.remove(t),this._computationManipulators.delete(t);for(const t of e.values())this.manipulators.remove(t)}}_setupComputationToManipulatorsSync(t,e){this._computationHandles.add([c((()=>t.geometry),(()=>this._updateManipulators(t,e)),{...u,equals:v})],t)}_setupPointManipulator(t,e){const{view:i}=this,{dimension:s}=t,n=function(t,e){const i=St(t,ht.toUnitRGB(ai.pointManipulators.color),ai.pointManipulators.opacity,bi);return i.available=!1,i.grabCursor="crosshair",i.radius=ai.pointManipulators.radius,i.metadata=e.metadata,i.collisionPriority=1,i}(i,{metadata:s}),o=function(t,{isStart:e,createSnappingPipelineStep:i,dimension:s,onUpdate:n,snappingPipeline:o,view:r}){const a=e?"startPoint":"endPoint",l=Ut(t,((t,e,l,p)=>{const m=xt(t);l=l.next(m).next(Et(s,[a,"measureType","orientation"])),e.next(m).next(Tt(r)).next(i(l,p),o.next).next((t=>{const e=ot(t.mapEnd,new Ft);n("startPoint"===a?{startPoint:e}:{endPoint:e})}))}));return[l]}(n,{isStart:e.isStart,createSnappingPipelineStep:(t,e)=>this._snappingPipeline.createSnapDragEventPipelineStep({snappingContext:this._snappingContext(e),snappingManager:this._snappingManager,updatingHandles:this.updatingHandles,cancel:t}),dimension:s,onUpdate:e=>{this._applyPointUpdate(t,e)},snappingPipeline:this._snappingPipeline,view:i});return this._computationHandles.add(o,t),n}_setupOffsetManipulator(t){const{view:e}=this,i=function(t,e){const i=[et(-.5,0,0),et(.5,0,0)],{lengthFraction:s}=ai.offsetManipulator,n=Lt(i.map((t=>Z(V(),t,s))));return new Mt({view:t,renderObjects:[{geometry:n,material:e.unfocusedMaterial,stateMask:kt.Unfocused|kt.Selected|bi},{geometry:n,material:e.focusedMaterial,stateMask:kt.Focused|bi}],collisionType:{type:"line",paths:[i]},radius:Mi(e.lineSizePt)/2,metadata:e.metadata,available:!1,...bt})}(e,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:t.dimension}),s=function(t,{computation:e,view:i}){return[Ut(t,((t,s,n)=>{if(!Ze(e)||!t.selected)return;const{geometry:o,dimension:r}=e,a=xt(t);s.next(a).next(ui(i,r,o.dimensionSegment,o.primaryOffsetAxis)),n.next(a).next(Et(r,["offset"]))}))]}(i,{computation:t,view:e});return this._computationHandles.add(s,t),i}_setupHeadingManipulator(t){const{view:e}=this,i=mi(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),s=function(t,{computation:e,view:i}){return[Ut(t,((t,s,n)=>{ci({cancel:n,computation:e,settingHeading:!0,steps:s,view:i})}))]}(i,{computation:t,view:e});return this._computationHandles.add(s,t),i}_setupRotationManipulator(t){const{view:e}=this,i=mi(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),s=function(t,{computation:e,view:i}){return[Ut(t,((t,s,n)=>{ci({cancel:n,computation:e,settingHeading:!1,steps:s,view:i})})),t.events.on("immediate-click",(t=>{!function(t,e,i){const{dimension:s,geometry:o}=e;if(90===s.orientation||270===s.orientation)return s.orientation=0,void t.stopPropagation();if(n(o))return;const{renderCoordsHelper:r}=i,a=Ae({...Re(e),orientation:90},r),l=Ae({...Re(e),orientation:270},r);if(n(a)||n(l))return;const p=Ne(a,r),m=Ne(l,r),d=hi(o,i),c=ft.shortestSignedDiff(d,p),u=ft.shortestSignedDiff(d,m);s.orientation=Math.abs(c)<Math.abs(u)?90:270,t.stopPropagation()}(t,e,i)}))]}(i,{computation:t,view:e});return this._computationHandles.add(s,t),i}_setupMeasureTypeManipulator(t,e){const{view:i}=this,s=function(t,e){const i=[et(-.5,0,0),et(.5,0,0)],{lengthFraction:s}=ai.offsetManipulator,n=Lt(i),o=Lt(i.map((t=>Z(V(),t,s))));return new Mt({view:t,renderObjects:[{geometry:o,material:e.unfocusedMaterial,stateMask:kt.Unfocused|bi},{geometry:o,material:e.focusedMaterial,stateMask:kt.Focused|bi},{geometry:n,material:e.thinOffsetManipulatorMaterial,stateMask:bi}],collisionType:{type:"line",paths:[i]},radius:Mi(e.lineSizePt)/2,available:!1,metadata:e.metadata,...bt})}(i,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:t.dimension}),n=function(t,{computation:e,manipulatorMeasureType:i,view:s}){let n=b.Direct,o=0,r=0;return[t.events.on("grab-changed",(a=>{if("start"!==a.action||!Ze(e))return;const{dimension:l,geometry:p}=e;n=l.measureType,o=l.offset,r=l.orientation;const m=I(st.get(),t.renderLocation);l.measureType=i,l.offset=function(t,e,i,s){const{directSegment:n}=i,o=Ie(st.get(),{measureType:e,directSegment:n,renderCoordsHelper:s}),r=Ge(Ve,{offsetAxis:o,offset:0,relativeToSegment:n,renderCoordsHelper:s}).eval(.5,st.get()),a=F(st.get(),t,r);return B(a,o)*s.unitInMeters}(m,i,p,s.renderCoordsHelper),l.orientation=0})),Ut(t,((t,a,l)=>{if(!Ze(e))return;const{geometry:p,dimension:m}=e,{renderCoordsHelper:d}=s,c=Le(Di,i,e,d),u=Ie(st.get(),{measureType:i,directSegment:p.directSegment,renderCoordsHelper:d}),h=xt(t);a.next(h).next(ui(s,m,c,u)),l.next(h).next((t=>(m.measureType=n,m.offset=o,m.orientation=r,t)))}))]}(s,{computation:t,manipulatorMeasureType:e,view:i});return this._computationHandles.add(n,t),s}_updateManipulators(t,e,i={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const{stagedDimension:s,selectedComputation:r,firstGrabbedManipulator:a}=i,{start:l,end:p,offset:m,heading:d,rotation:c}=e,u=r===t,h=Ze(t),{dimension:f}=t;for(const t of e.values()){const e=h&&n(s)&&(n(a)||t===a);t===m?(t.available=e,t.selected=u):t.available=e&&u}if(!h)return;o(Oi(t,this.view))?e.forEachMeasureTypeManipulator((t=>t.available=!1)):e.manipulatorForMeasureType(f.measureType).available=!1;for(const t of[d,c])f.measureType===b.Direct&&0!==f.offset||(t.available=!1);Fe(t)?c.available=!1:d.available=!1;const{geometry:g}=t;l.renderLocation=g.directSegment.startRenderSpace,p.renderLocation=g.directSegment.endRenderSpace;const{renderCoordsHelper:y}=this.view;!function(t,e,i){const{dimensionSegment:s,primaryOffsetAxis:n}=e,o=We(wi,e),r=Y(o,W)?H(Ci):Dt(o,n,W,Ci),a=Math.max(X(o),ai.offsetManipulator.minLengthMeters/i.unitInMeters);L(r,r,tt(wi,a,a,a)),t.modelTransform=r,t.renderLocation=s.eval(.5,wi)}(m,g,y),d.available&&function(t,e,i){fi(t,e,i,{forHeading:!0})}(d,t,y),c.available&&function(t,e,i){fi(t,e,i,{forHeading:!1})}(c,t,y),e.forEachMeasureTypeManipulator(((e,i)=>{e.available&&function(t,e,i,s){const{geometry:n}=e,o=Le(Di,i,e,s),r=Ie(wi,{measureType:i,directSegment:n.directSegment,renderCoordsHelper:s}),a=F(Pi,o.endRenderSpace,o.startRenderSpace),l=Dt(a,r,W,Ci),p=X(a);L(l,l,tt(Pi,p,p,p)),t.modelTransform=l,t.renderLocation=o.eval(.5,Pi)}(e,t,i,y)}))}_updateManipulatorStyle(t){const e=function(t){return gt(t)+ai.offsetManipulator.linePaddingPx}(t),i=Mi(t),s={lineSizePt:t,material:this._orientationManipulatorMaterial};for(const{offset:t,heading:e,rotation:n}of this._computationManipulators.values())t.radius=i/2,di(e,s),di(n,s);this._unfocusedOffsetManipulatorMaterial.setParameters({width:e}),this._focusedOffsetManipulatorMaterial.setParameters({width:i})}_snappingContext(t){return new ae({elevationInfo:{mode:"absolute-height",offset:0},pointer:t,editGeometryOperations:new Yt(new Xt("point",te(!0,!1,this.view.spatialReference))),visualizer:new Wt})}_applyPointUpdate(t,e){const{view:i}=this,s=Re(t);"startPoint"in e&&(s.elevationAlignedStartPoint=e.startPoint),"endPoint"in e&&(s.elevationAlignedEndPoint=e.endPoint);const r=Ae(s,i.renderCoordsHelper);if(n(r))return;const a=Oi({...s,geometry:r},i);!function(t,e,i){const{constraint:s,elevationAlignedStartPoint:r,elevationAlignedEndPoint:a,unconstrainedGeometry:l,view:p}=i,{dimension:m,previousConstraint:d,preConstraintProperties:c}=t;if(n(r)||n(a))return;const u=()=>{"startPoint"in e?m.startPoint=e.startPoint:"endPoint"in e&&(m.endPoint=e.endPoint)};if(n(s))u(),o(d)&&o(c)&&(m.measureType=c.measureType,m.orientation=c.orientation);else switch(m.measureType=b.Direct,s){case Ti.Horizontal:if(s!==d&&(m.orientation=0),"startPoint"in e){const t=e.startPoint;o(t)&&(t.z=a.z),m.startPoint=t}else if("endPoint"in e){const t=e.endPoint;o(t)&&(t.z=r.z),m.endPoint=t}break;case Ti.Vertical:if(s!==d&&(m.orientation=hi(l,p)),"startPoint"in e){const t=e.startPoint;o(t)&&(t.x=a.x,t.y=a.y),m.startPoint=t}else if("endPoint"in e){const t=e.endPoint;o(t)&&(t.x=r.x,t.y=r.y),m.endPoint=t}break;case Ti.Direct:s!==d&&o(c)&&(m.orientation=c.orientation),u()}t.previousConstraint=s}(t,e,{...s,constraint:a,unconstrainedGeometry:r,view:i}),t===this._stagedComputation&&this._updateStagedDimensionOffset(t)}_updateStagedDimensionOffset(t){if(n(t.geometry))return;t.geometry.directSegment.eval(.5,zi);const e=this.view.state.camera.computeRenderPixelSizeAt(zi);t.dimension.offset=ai.initialOffsetPx*e}get testInfo(){const t=t=>this.analysisViewData.computations.find((e=>e.dimension===t));return{getManipulatorsForDimension:e=>this._computationManipulators.get(t(e)),getComputationForDimension:e=>t(e),getConstraintForDimension:e=>{const i=t(e);return o(i)?Oi(i,this.view):null},stagedDimension:this._stagedDimension,stagedStartIndicator:this._stagedStartIndicator,constraintSnappingIndicator:this._constraintSnappingIndicator,snappingManager:this._snappingManager}}};function Ai(){const{color:t,opacity:e}=ai.offsetManipulator;return new At({color:[...ht.toUnitRGB(t),e],width:1,renderOccluded:$t.OccludeAndTransparent,writeDepth:!1,hasPolygonOffset:!0})}t([_({constructOnly:!0})],Ri.prototype,"analysis",void 0),t([_({constructOnly:!0})],Ri.prototype,"analysisViewData",void 0),t([_({constructOnly:!0})],Ri.prototype,"manipulators",void 0),t([_({constructOnly:!0})],Ri.prototype,"parentTool",void 0),t([_({constructOnly:!0,nonNullable:!0})],Ri.prototype,"view",void 0),t([_({readOnly:!0})],Ri.prototype,"updating",null),t([_()],Ri.prototype,"firstGrabbedManipulator",null),t([_()],Ri.prototype,"hasGrabbedManipulators",null),t([_()],Ri.prototype,"_stagedDimension",void 0),t([_()],Ri.prototype,"_activeComputation",null),t([_()],Ri.prototype,"_stagedComputation",null),Ri=t([j("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],Ri);const zi=V();var Hi;!function(t){t.Ready="ready",t.Creating="creating",t.Created="created"}(Hi||(Hi={}));let Li=class extends ce{constructor(t){super(t),this.automaticManipulatorSelection=!1,this.removeIncompleteOnCancel=!1,this._pointerMoveTimerMs=ai.pointerMoveTimeoutMs,this._prevPointerMoveTimeout=null}initialize(){this._intersector=me(this.view.state.viewingMode),this._intersector.options.store=de.MIN,this._lengthDimensionSubTool=new Ri({analysis:this.analysis,analysisViewData:this.analysisViewData,manipulators:this.manipulators,parentTool:this,view:this.view}),this.addHandles([ut(this._lengthDimensionSubTool),ct((()=>this._clearPointerMoveTimeout())),c((()=>this.state),(t=>{t===Hi.Created&&this.finishToolCreation()}),u),g((()=>this.firstGrabbedManipulator),(t=>{this.selectedDimension=t.metadata}),u),c((()=>this.selectedDimension),(()=>this._resetPointerMoveTimeout()),u)])}get state(){return this.analysis.dimensions.some((t=>"length"===t.type))?o(this._activeSubTool)?Hi.Creating:Hi.Created:Hi.Ready}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}get selectedDimension(){return this.analysisViewData.selectedDimension}set selectedDimension(t){this.analysisViewData.selectedDimension=t}onInputEvent(t){switch(t.type){case"immediate-click":this._clickHandler(t);break;case"immediate-double-click":this._doubleClickHandler(t);break;case"pointer-move":this._pointerMoveHandler(t);break;case"key-down":if(ue.cancel===t.key){if(o(this._activeSubTool)&&this._activeSubTool.removeStaged())return void t.stopPropagation();this.active||(this.selectedDimension=null)}else ue.delete.includes(t.key)&&this._deleteKeyHandler()}}onActivate(){this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){o(this._activeSubTool)&&(this._activeSubTool.onDeactivate(),this._activeSubTool=null)}onShow(){this._resetPointerMoveTimeout()}onManipulatorSelectionChanged(){this._lengthDimensionSubTool.onManipulatorSelectionChanged()}onHide(){this.selectedDimension=null}_clickHandler(t){if(this.hasFocusedManipulators)return void t.stopPropagation();if(n(this._activeSubTool))return;const e=this._intersectScreen(t);n(e)||(this.selectedDimension=this._activeSubTool.onClick({mapPoint:e,pointerType:t.pointerType}),t.stopPropagation())}_doubleClickHandler(t){this.active&&(this.view.activeTool=null,t.stopPropagation())}_pointerMoveHandler(t){if(this._resetPointerMoveTimeout(),n(this._activeSubTool))return;if(this.hasFocusedManipulators)return;const e=this._intersectScreen(t);n(e)||this._activeSubTool.onPointerMove({mapPoint:e,pointerType:t.pointerType})}_deleteKeyHandler(){o(this._activeSubTool)&&this._activeSubTool.removeStaged(),this._removeSelected()}_intersectScreen(t){const e=he(t);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector);const i=this._intersector.results.min,s=st.get();return i.getIntersectionPoint(s)?this.view.renderCoordsHelper.fromRenderCoords(s,this.view.spatialReference):null}_removeSelected(){o(this.selectedDimension)&&(this.analysis.dimensions.remove(this.selectedDimension),this.selectedDimension=null)}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=p(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.manipulators.forEach((t=>{t.manipulator.state|=bi})),this._prevPointerMoveTimeout=dt.setTimeout((()=>{this.manipulators.forEach((t=>{t.manipulator.state&=~bi}))}),this._pointerMoveTimerMs)}get testInfo(){return{...this._lengthDimensionSubTool.testInfo,setManipulatorAutoHideDelay:t=>{this._pointerMoveTimerMs=t,this._resetPointerMoveTimeout()}}}};t([_({constructOnly:!0})],Li.prototype,"view",void 0),t([_({constructOnly:!0})],Li.prototype,"analysis",void 0),t([_({readOnly:!0})],Li.prototype,"state",null),t([_({readOnly:!0})],Li.prototype,"updating",null),t([_({readOnly:!0})],Li.prototype,"cursor",null),t([_({constructOnly:!0})],Li.prototype,"analysisViewData",void 0),t([_()],Li.prototype,"selectedDimension",null),t([_()],Li.prototype,"automaticManipulatorSelection",void 0),t([_()],Li.prototype,"_activeSubTool",void 0),t([_()],Li.prototype,"_lengthDimensionSubTool",void 0),Li=t([j("esri.views.3d.analysis.Dimension.DimensionTool")],Li);class Ui extends ve{constructor(t,e){super(t),this._hasExternalMaterial=!1,this._renderOccluded=$t.OccludeAndTransparent,this._width=1,this._color=ye(1,0,1,1),this._placement="end",this._textureId=null,this._material=e,this._hasExternalMaterial=o(e),this.applyProps(t)}setGeometryFromSegment(t,e){const i=t.endRenderSpace;this.transform=U(Ei,i),this._normal=e;const{points:s}=t.createRenderGeometry(i,this.view.renderCoordsHelper);this.geometry=[s]}get renderOccluded(){return o(this._material)?this._material.parameters.renderOccluded:this._renderOccluded}set renderOccluded(t){this._renderOccluded=t,o(this._material)&&this._material.setParameters({renderOccluded:t})}get geometry(){return this._geometry}set geometry(t){this._geometry=t,this.recreateGeometry()}get normal(){return this._normal}set normal(t){this._normal=t,this.recreateGeometry()}get width(){return o(this._material)?this._material.parameters.width:this._width}set width(t){this._width=t,o(this._material)&&this._material.setParameters({width:t})}get color(){return o(this._material)?this._material.parameters.color:this._color}set color(t){this._color=_e(t),o(this._material)&&this._material.setParameters({color:this._color})}get placement(){return o(this._material)?this._material.parameters.placement:this._placement}set placement(t){this._placement=t,o(this._material)&&this._material.setParameters({placement:this._placement})}get textureId(){return o(this._material)?this._material.parameters.textureId:this._textureId}set textureId(t){this._textureId=t,o(this._material)&&this._material.setParameters({textureId:t})}createExternalResources(){this._hasExternalMaterial||(this._material=new Me({width:this._width,color:this._color,placement:this._placement,renderOccluded:this._renderOccluded,textureId:this._textureId}))}destroyExternalResources(){this._hasExternalMaterial||(this._material=null)}createGeometries(t){for(const e of je(this.geometry,this.normal)){const i=Se(e);t.addGeometry(i,m(this._material))}}forEachExternalMaterial(t){this._hasExternalMaterial||t(m(this._material))}}const Ei=E();class Vi{constructor(t){this.destroyed=!1,this._handles=new P,this._messages=null,this._labelSegment=new rt;const{analysis:e,computation:i,view:s,messages:n}=t;this.analysis=e,this.computation=i,this.view=s,this._messages=n;const r=t.visible,a={view:s,attached:r},{fontSize:l,textColor:p,textBackgroundColor:m}=e.style;this._visualElements=new Gi({marker:new Ui(a,t.markerMaterial),dimension:new Nt(a,t.dimensionLineMaterial),startOffset:new Nt(a,t.offsetLineMaterial),endOffset:new Nt(a,t.offsetLineMaterial),dimensionSmall:new Nt(a,t.smallDimensionLineMaterial),startOffsetSmall:new Nt(a,t.smallOffsetLineMaterial),endOffsetSmall:new Nt(a,t.smallOffsetLineMaterial),label:new at({view:s,attached:r,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:gt(l),textColor:p.clone(),backgroundColor:m.clone()})}),this._handles.add([c((()=>i.geometry),(t=>{this.updateCameraDependentElements(s.state.camera,t,e.style),o(i.geometry)&&this._updateLines(i.geometry)}),{...h,equals:v}),c((()=>i.length),(t=>this._updateLabelContent(t)),h)])}set visible(t){for(const e of this._visualElements.values())e.attached=t}destroy(){this.destroyed=!0,this._handles=a(this._handles);for(const t of this._visualElements.values())t.destroy()}get testInfo(){return{dimensionVisualElement:this._visualElements.dimension,label:this._visualElements.label}}_updateLines(t){const e=ze(Ii,He.Start,t.directSegment,t.dimensionSegment),i=ze(ki,He.End,t.directSegment,t.dimensionSegment),s=this._visualElements;s.marker.setGeometryFromSegment(t.dimensionSegment,t.primaryOffsetAxis),s.dimension.setGeometryFromSegment(t.dimensionSegment),s.startOffset.setGeometryFromSegment(e),s.endOffset.setGeometryFromSegment(i),s.dimensionSmall.setGeometryFromSegment(t.dimensionSegment),s.startOffsetSmall.setGeometryFromSegment(e),s.endOffsetSmall.setGeometryFromSegment(i)}updateCameraDependentElements(t,e,i){const s=this._visualElements;if(n(e)){for(const t of s.values())t.visible=!1;return}const o=t.computeScreenPixelSizeAt(e.dimensionSegment.eval(.5,Fi)),r=function(t,e){return $(We(Qe,t))/e**2}(e,o),a=r<(gt(i.lineSize)*ai.smallScreenLengthLineSizeFactor)**2,l=!a;s.marker.visible=l,s.dimension.visible=l,s.startOffset.visible=l,s.endOffset.visible=l,s.dimensionSmall.visible=a,s.startOffsetSmall.visible=a,s.endOffsetSmall.visible=a;const p=gt(i.fontSize)*ai.labels.minScreenLengthFontSizeFactor,{label:m}=s;if(r<p**2)return void(m.visible=!1);m.visible=!0;const{dimensionSegment:d,primaryOffsetAxis:c}=e,{offset:u}=this.computation.dimension,h=(Math.sign(u)>=0?1:-1)*function(t){return 1.5*gt(t.fontSize)+ai.labels.marginPx+gt(t.lineSize/2)}(i)*o;!function(t,e,i,s){Q(t.startRenderSpace,e.startRenderSpace,i,s),Q(t.endRenderSpace,e.endRenderSpace,i,s)}(this._labelSegment,d,c,h),m.updateLabelPosition()}updateLabelStyle(t){const{label:e}=this._visualElements;e.fontSize=gt(t.fontSize),e.textColor=t.textColor,e.backgroundColor=t.textBackgroundColor}updateUnitsMessages(t){this._messages=t;const{length:e}=this.computation;this._updateLabelContent(e)}_updateLabelContent(t){const{label:e}=this._visualElements;n(t)||n(this._messages)?e.text="":e.text=ge(this._messages,t,t.unit)}}const Ii=new rt,ki=new rt,Fi=V();class Gi{constructor(t){this.marker=t.marker,this.dimension=t.dimension,this.startOffset=t.startOffset,this.endOffset=t.endOffset,this.dimensionSmall=t.dimensionSmall,this.startOffsetSmall=t.startOffsetSmall,this.endOffsetSmall=t.endOffsetSmall,this.label=t.label}values(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]}}class Bi{constructor(t,e){this._textures=t,this._textureRepository=e,this._texturesByPrimitive=new Map}acquire(t){if(!this._texturesByPrimitive.has(t)){const e=zt(this._textures,t),i=new be(this._textureRepository,e.texture.id);return this._texturesByPrimitive.set(t,{result:e,reference:i}),e.texture}return this._texturesByPrimitive.get(t).result.texture}destroy(){this._texturesByPrimitive.forEach((({result:t,reference:e})=>{e.dispose(),t.release()})),this._texturesByPrimitive.clear()}}let qi=class extends e{constructor(t){super(t),this.loadingMessages=!1,this._messages=null,this._dimensionVisualizations=new Map,this._markerMaterial=new Me({width:1,anchor:Ht.Tip,color:fe,placement:"begin-end",worldSpace:!0,hideOnShortSegments:!0,hasTip:!0,renderOccluded:$t.OccludeAndTransparent}),this._dimensionLineMaterial=new At({width:1,color:fe,renderOccluded:$t.OccludeAndTransparent,markerParameters:this._markerMaterial.parameters}),this._offsetLineMaterial=new At({width:1,color:fe,renderOccluded:$t.OccludeAndTransparent,stipplePattern:Jt(5),stippleScaleWithLineWidth:!0}),this._smallDimensionLineMaterial=new At({width:1,color:fe,renderOccluded:$t.OccludeAndTransparent}),this._smallOffsetLineMaterial=new At({width:1,color:fe,renderOccluded:$t.OccludeAndTransparent,stipplePattern:Jt(5),stippleScaleWithLineWidth:!0})}get analysis(){return this.analysisViewData.analysis}get visible(){return this.analysisViewData.visible}initialize(){const{textures:t}=this.view.sharedSymbolResources;if(o(t)){const{textureRepository:e}=this.view._stage.renderView,i=new Bi(t,e),s=i.acquire("triangle");this.addHandles(ct((()=>i.destroy()))),this._markerMaterial.setParameters({textureId:s.id})}for(const t of this._lineMaterials())this.view._stage.add(t),this.addHandles(ct((()=>{this.view._stage.remove(t),t.dispose()})));const{computations:e}=this.analysisViewData;for(const t of e)this._addComputation(t);this.addHandles([e.on("change",(({added:t,removed:e})=>{for(const t of e)this._removeComputation(t);for(const e of t)this._addComputation(e)})),c((()=>ht.toUnitRGBA(this.analysis.style.color)),(t=>{for(const e of this._lineMaterials())e.setParameters({color:t})}),u),c((()=>this.analysis.style.lineSize),(t=>{const e=gt(t);this._markerMaterial.setParameters({width:e*ai.markers.lineSizeFraction}),this._dimensionLineMaterial.setParameters({width:e,markerParameters:this._markerMaterial.parameters});const i=Math.max(e*ai.offsetLine.lineSizeFraction,1);this._offsetLineMaterial.setParameters({width:i})}),u),c((()=>({camera:this.view.state.camera,style:Wi(this.analysis)})),(({camera:t,style:e})=>{for(const[i,s]of this._dimensionVisualizations)s.updateCameraDependentElements(t,i.geometry,e),s.updateLabelStyle(e)})),c((()=>this.visible),(t=>{for(const e of this._dimensionVisualizations.values())e.visible=t}))]),this.addHandles([we((()=>this._updateMessageBundle())),g((()=>!this.loadingMessages),(()=>{for(const t of this._dimensionVisualizations.values())t.updateUnitsMessages(this._messages)}),f)]),this._updateMessageBundle()}destroy(){this._dimensionVisualizations.forEach((t=>{t.destroy()})),this._dimensionVisualizations.clear()}get testInfo(){return{visualizations:Array.from(this._dimensionVisualizations.values()),disablePartialOcclusion:()=>{for(const t of this._lineMaterials())t.setParameters({renderOccluded:$t.Occlude})}}}_addComputation(t){this._dimensionVisualizations.has(t)||this._dimensionVisualizations.set(t,new Vi({analysis:this.analysis,computation:t,view:this.view,visible:this.visible,markerMaterial:this._markerMaterial,dimensionLineMaterial:this._dimensionLineMaterial,offsetLineMaterial:this._offsetLineMaterial,smallDimensionLineMaterial:this._smallDimensionLineMaterial,smallOffsetLineMaterial:this._smallOffsetLineMaterial,messages:this._messages}))}_removeComputation(t){const e=this._dimensionVisualizations.get(t);n(e)||(e.destroy(),this._dimensionVisualizations.delete(t))}_lineMaterials(){return[this._markerMaterial,this._dimensionLineMaterial,this._offsetLineMaterial,this._smallDimensionLineMaterial,this._smallOffsetLineMaterial]}async _updateMessageBundle(){this.loadingMessages=!0;try{this._messages=await Pe("esri/core/t9n/Units")}finally{this.loadingMessages=!1}}};function Wi(t){const{fontSize:e,lineSize:i,textColor:s,textBackgroundColor:n}=t.style;return{fontSize:e,lineSize:i,textBackgroundColor:n.clone(),textColor:s.clone()}}t([_({constructOnly:!0})],qi.prototype,"analysisViewData",void 0),t([_({constructOnly:!0,nonNullable:!0})],qi.prototype,"view",void 0),t([_()],qi.prototype,"analysis",null),t([_()],qi.prototype,"visible",null),t([_()],qi.prototype,"loadingMessages",void 0),qi=t([j("esri.views.3d.analysis.Dimension.DimensionVisualization")],qi);let Ni=class extends e{constructor(t){super(t),this.geometry=null,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null}normalizeCtorArgs(t){const{dimension:e,...i}=t;return{result:new Ce({dimension:e}),...i}}initialize(){this.addHandles([c((()=>this.dimension.startPoint),(t=>this.elevationAlignedStartPoint=this.projectAndAlignPoint(t)),u),c((()=>this.dimension.endPoint),(t=>this.elevationAlignedEndPoint=this.projectAndAlignPoint(t)),u)])}get dimension(){return this.result.dimension}get length(){return this.result.length}};t([_({constructOnly:!0,nonNullable:!0})],Ni.prototype,"result",void 0),t([_({constructOnly:!0,nonNullable:!0})],Ni.prototype,"projectAndAlignPoint",void 0),t([_()],Ni.prototype,"dimension",null),t([_()],Ni.prototype,"length",null),t([_()],Ni.prototype,"geometry",void 0),t([_()],Ni.prototype,"elevationAlignedStartPoint",void 0),t([_()],Ni.prototype,"elevationAlignedEndPoint",void 0),t([_()],Ni.prototype,"preConstraintProperties",void 0),t([_()],Ni.prototype,"previousConstraint",void 0),Ni=t([j("esri.views.3d.analysis.LengthDimensionComputation")],Ni);let Qi=class extends(xe(S(e))){constructor(t){super(t),this.type="dimension-view-3d",this.tool=null,this.computations=new i,this.selectedDimension=null,this._dimensionsToComputations=new Map,this._placementTask=null,this._projectAndAlignPoint=null}initialize(){this._projectAndAlignPoint=t=>{if(n(t))return null;const{spatialReference:e,elevationProvider:i}=this.view,o=Qt(t,e,i);return n(o)&&Kt(this.analysis,t.spatialReference,s.getLogger(this.declaredClass)),o},this.addHandles([De(this,Li),y((()=>this.analysis.dimensions),"after-add",(t=>this._onDimensionAdd(t.item)),{onListenerAdd:t=>{for(const e of t)this._onDimensionAdd(e)},onListenerRemove:()=>{this._onDimensionsClear()}}),y((()=>this.analysis.dimensions),"after-remove",(t=>this._onDimensionRemove(t.item)))]),this._analysisVisualization=new qi({analysisViewData:this,view:this.view}),this._analysisController=new Je({analysisViewData:this,view:this.view})}destroy(){this._placementTask=d(this._placementTask),this._analysisVisualization=a(this._analysisVisualization),Te(this)}get updating(){return this._analysisVisualization?.loadingMessages??!1}get results(){return this.analysis.dimensions.map((t=>this._dimensionsToComputations.get(t).result))}get selectedComputation(){const{selectedDimension:t}=this;return n(t)?null:this._dimensionsToComputations.get(t)}get testInfo(){return{visualization:this._analysisVisualization,controller:this._analysisController}}async createLengthDimensions(t){return this.selectedDimension=null,this._placementTask=d(this._placementTask),this._placementTask=Oe(this,t),this._placementTask.promise}_onDimensionAdd(t){const{computations:e,_dimensionsToComputations:i}=this;if(i.has(t))return;const s=new Ni({dimension:t,projectAndAlignPoint:this._projectAndAlignPoint});e.add(s),i.set(t,s)}_onDimensionRemove(t){const{computations:e,_dimensionsToComputations:i}=this,s=e.findIndex((e=>e.dimension===t)),n=e.getItemAt(s);n.dimension===this.selectedDimension&&(this.selectedDimension=null),e.removeAt(s),i.delete(t),a(n)}_onDimensionsClear(){this.computations.drain((t=>t.destroy())),this._dimensionsToComputations.clear()}};t([_({readOnly:!0})],Qi.prototype,"type",void 0),t([_()],Qi.prototype,"tool",void 0),t([_()],Qi.prototype,"updating",null),t([_({readOnly:!0})],Qi.prototype,"results",null),t([_({readOnly:!0})],Qi.prototype,"computations",void 0),t([_()],Qi.prototype,"selectedDimension",void 0),t([_()],Qi.prototype,"selectedComputation",null),t([_()],Qi.prototype,"_analysisVisualization",void 0),t([_()],Qi.prototype,"_analysisController",void 0),t([_()],Qi.prototype,"_dimensionsToComputations",void 0),t([_()],Qi.prototype,"_placementTask",void 0),Qi=t([j("esri.views.3d.analysis.DimensionAnalysisView3D")],Qi);const Ki=Qi;export{Ki as default};
