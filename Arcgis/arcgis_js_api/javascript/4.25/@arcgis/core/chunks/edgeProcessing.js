/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{d as t}from"./deduplicate.js";import{n as e}from"./InterleavedLayout.js";import{V as n}from"./VertexAttribute.js";import{g as o}from"./glUtil.js";import{R as s,z as r,A as i}from"../core/lang.js";import{a as c,n as a,d as l,s as f,c as g,m as u,F as m,h as N,b as d,C as I}from"./vec3.js";import{d as p,g as h}from"./mathUtils.js";const A=e().vec3f(n.POSITION).u16(n.COMPONENTINDEX).u16(n.U16PADDING),O=e().vec2u8(n.SIDENESS),S=o(O),w=e().vec3f(n.POSITION0).vec3f(n.POSITION1).u16(n.COMPONENTINDEX).u8(n.VARIANTOFFSET,{glNormalized:!0}).u8(n.VARIANTSTROKE).u8(n.VARIANTEXTENSION,{glNormalized:!0}).u8(n.U8PADDING,{glPadding:!0}).u16(n.U16PADDING,{glPadding:!0}),v=w.clone().vec3f(n.NORMAL),E=w.clone().vec3f(n.NORMALA).vec3f(n.NORMALB),T=new Map([[n.POSITION0,0],[n.POSITION1,1],[n.COMPONENTINDEX,2],[n.VARIANTOFFSET,3],[n.VARIANTSTROKE,4],[n.VARIANTEXTENSION,5],[n.NORMAL,6],[n.NORMALA,6],[n.NORMALB,7],[n.SIDENESS,8]]);function P(t,e,n){const o=e/3,s=new Uint32Array(n+1),r=new Uint32Array(n+1),i=(t,e)=>{t<e?s[t+1]++:r[e+1]++};for(let e=0;e<o;e++){const n=t[3*e],o=t[3*e+1],s=t[3*e+2];i(n,o),i(o,s),i(s,n)}let c=0,a=0;for(let t=0;t<n;t++){const e=s[t+1],n=r[t+1];s[t+1]=c,r[t+1]=a,c+=e,a+=n}const l=new Uint32Array(6*o),f=s[n],g=(t,e,n)=>{if(t<e){const o=s[t+1]++;l[2*o]=e,l[2*o+1]=n}else{const o=r[e+1]++;l[2*f+2*o]=t,l[2*f+2*o+1]=n}};for(let e=0;e<o;e++){const n=t[3*e],o=t[3*e+1],s=t[3*e+2];g(n,o,e),g(o,s,e),g(s,n,e)}const u=(t,e)=>{const n=2*t,o=e-t;for(let t=1;t<o;t++){const e=l[n+2*t],o=l[n+2*t+1];let s=t-1;for(;s>=0&&l[n+2*s]>e;s--)l[n+2*s+2]=l[n+2*s],l[n+2*s+3]=l[n+2*s+1];l[n+2*s+2]=e,l[n+2*s+3]=o}};for(let t=0;t<n;t++)u(s[t],s[t+1]),u(f+r[t],f+r[t+1]);const m=new Int32Array(3*o),N=(e,n)=>e===t[3*n]?0:e===t[3*n+1]?1:e===t[3*n+2]?2:-1,d=(t,e)=>{const n=N(t,e);m[3*e+n]=-1},I=(t,e,n,o)=>{const s=N(t,e);m[3*e+s]=o;const r=N(n,o);m[3*o+r]=e};for(let t=0;t<n;t++){let e=s[t];const n=s[t+1];let o=r[t];const i=r[t+1];for(;e<n&&o<i;){const n=l[2*e],s=l[2*f+2*o];n===s?(I(t,l[2*e+1],s,l[2*f+2*o+1]),e++,o++):n<s?(d(t,l[2*e+1]),e++):(d(s,l[2*f+2*o+1]),o++)}for(;e<n;)d(t,l[2*e+1]),e++;for(;o<i;)d(l[2*f+2*o],l[2*f+2*o+1]),o++}return m}class V{updateSettings(t){this.settings=t,this._edgeHashFunction=t.reducedPrecision?M:R}write(t,e,n){const o=this._edgeHashFunction(n);_.seed=o;const s=_.getIntRange(0,255),r=_.getIntRange(0,this.settings.variants-1),i=_.getFloat(),c=255*(.5*function(t,e){const n=t<0?-1:1;return Math.abs(t)**1.2*n}(-(1-Math.min(i/.7,1))+Math.max(0,i-.7)/(1-.7))+.5);t.position0.setVec(e,n.position0),t.position1.setVec(e,n.position1),t.componentIndex.set(e,n.componentIndex),t.variantOffset.set(e,s),t.variantStroke.set(e,r),t.variantExtension.set(e,c)}trim(t,e){return t.slice(0,e)}}const y=new Float32Array(6),D=new Uint32Array(y.buffer),L=new Uint32Array(1);function R(t){const e=y;e[0]=t.position0[0],e[1]=t.position0[1],e[2]=t.position0[2],e[3]=t.position1[0],e[4]=t.position1[1],e[5]=t.position1[2],L[0]=5381;for(let t=0;t<D.length;t++)L[0]=31*L[0]+D[t];return L[0]}function M(t){const e=y;e[0]=F(t.position0[0]),e[1]=F(t.position0[1]),e[2]=F(t.position0[2]),e[3]=F(t.position1[0]),e[4]=F(t.position1[1]),e[5]=F(t.position1[2]),L[0]=5381;for(let t=0;t<D.length;t++)L[0]=31*L[0]+D[t];return L[0]}function F(t){return Math.round(1e4*t)/1e4}class U{constructor(){this._commonWriter=new V}updateSettings(t){this._commonWriter.updateSettings(t)}allocate(t){return v.createBuffer(t)}write(t,e,n){this._commonWriter.write(t,e,n),c(x,n.faceNormal0,n.faceNormal1),a(x,x),t.normal.setVec(e,x)}trim(t,e){return this._commonWriter.trim(t,e)}}U.Layout=v,U.glLayout=o(v,1);class b{constructor(){this._commonWriter=new V}updateSettings(t){this._commonWriter.updateSettings(t)}allocate(t){return E.createBuffer(t)}write(t,e,n){this._commonWriter.write(t,e,n),t.normalA.setVec(e,n.faceNormal0),t.normalB.setVec(e,n.faceNormal1)}trim(t,e){return this._commonWriter.trim(t,e)}}b.Layout=E,b.glLayout=o(E,1);const x=l(),_=new s;var C;function W(t,e,n,o=K){const s=t.vertices.position,c=t.vertices.componentIndex,l=p(o.anglePlanar),m=p(o.angleSignificantEdge),h=Math.cos(m),A=Math.cos(l),O=G.edge,S=O.position0,w=O.position1,v=O.faceNormal0,E=O.faceNormal1,T=function(t){const e=t.faces.length/3,n=t.vertices.position,o=t.faces,s=H.v0,r=H.v1,i=H.v2,c=new Float32Array(3*e);for(let t=0;t<e;t++){const e=o[3*t+0],l=o[3*t+1],f=o[3*t+2];n.getVec(e,s),n.getVec(l,r),n.getVec(f,i),d(r,r,s),d(i,i,s),N(s,r,i),a(s,s),c[3*t+0]=s[0],c[3*t+1]=s[1],c[3*t+2]=s[2]}return c}(t),P=function(t){const e=t.faces.length/3,n=t.faces,o=t.neighbors;let s=0;for(let t=0;t<e;t++){const e=o[3*t+0],r=o[3*t+1],i=o[3*t+2],c=n[3*t+0],a=n[3*t+1],l=n[3*t+2];s+=-1===e||c<a?1:0,s+=-1===r||a<l?1:0,s+=-1===i||l<c?1:0}const r=new Int32Array(4*s);let i=0;for(let t=0;t<e;t++){const e=o[3*t+0],s=o[3*t+1],c=o[3*t+2],a=n[3*t+0],l=n[3*t+1],f=n[3*t+2];(-1===e||a<l)&&(r[i++]=a,r[i++]=l,r[i++]=t,r[i++]=e),(-1===s||l<f)&&(r[i++]=l,r[i++]=f,r[i++]=t,r[i++]=s),(-1===c||f<a)&&(r[i++]=f,r[i++]=a,r[i++]=t,r[i++]=c)}return r}(t),V=P.length/4,y=e.allocate(V);let D=0;const L=V,R=n.allocate(L);let M=0,F=0,U=0;const b=r(0,V),x=new Float32Array(V);i(x,((t,e,n)=>{s.getVec(P[4*e+0],S),s.getVec(P[4*e+1],w),n[e]=I(S,w)})),b.sort(((t,e)=>x[e]-x[t]));const _=new Array,C=new Array;for(let t=0;t<V;t++){const o=b[t],r=x[o],i=P[4*o+0],a=P[4*o+1],m=P[4*o+2],N=P[4*o+3],d=-1===N;if(s.getVec(i,S),s.getVec(a,w),d)f(v,T[3*m+0],T[3*m+1],T[3*m+2]),g(E,v),O.componentIndex=c.get(i),O.cosAngle=u(v,E);else{if(f(v,T[3*m+0],T[3*m+1],T[3*m+2]),f(E,T[3*N+0],T[3*N+1],T[3*N+2]),O.componentIndex=c.get(i),O.cosAngle=u(v,E),X(O,A))continue;O.cosAngle<-.9999&&g(E,v)}F+=r,U++,d||j(O,h)?(e.write(y,D++,O),_.push(r)):B(O,l)&&(n.write(R,M++,O),C.push(r))}const W=new Float32Array(_.reverse()),z=new Float32Array(C.reverse());return{regular:{instancesData:e.trim(y,D),lodInfo:{lengths:W}},silhouette:{instancesData:n.trim(R,M),lodInfo:{lengths:z}},averageEdgeLength:F/U}}function j(t,e){return t.cosAngle<e}function X(t,e){return t.cosAngle>e}function B(t,e){const n=h(t.cosAngle),o=G.fwd,s=G.ortho;return m(o,t.position1,t.position0),n*(u(N(s,t.faceNormal0,t.faceNormal1),o)>0?-1:1)>e}!function(t){t[t.SOLID=0]="SOLID",t[t.SKETCH=1]="SKETCH"}(C||(C={}));const G={edge:{position0:l(),position1:l(),faceNormal0:l(),faceNormal1:l(),componentIndex:0,cosAngle:0},ortho:l(),fwd:l()},H={v0:l(),v1:l(),v2:l()},K={anglePlanar:4,angleSignificantEdge:35};function z(t){const e=k(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return J.updateSettings(t.writerSettings),Q.updateSettings(t.writerSettings),W(e,J,Q)}function k(e,n,o,s){if(n){const t=P(o,s,e.count);return new q(o,s,t,e)}const r=t(e.buffer,e.stride/4,{originalIndices:o,originalIndicesLength:s}),i=P(r.indices,s,r.uniqueCount);return{faces:r.indices,facesLength:r.indices.length,neighbors:i,vertices:A.createView(r.buffer)}}class q{constructor(t,e,n,o){this.faces=t,this.facesLength=e,this.neighbors=n,this.vertices=o}}const J=new U,Q=new b,Y=e().vec3f(n.POSITION0).vec3f(n.POSITION1),Z=e().vec3f(n.POSITION0).vec3f(n.POSITION1).u16(n.COMPONENTINDEX).u16(n.U16PADDING,{glPadding:!0});export{A as E,U as R,b as S,O as V,T as a,C as b,z as c,k as d,Z as e,W as f,S as g,Y as h};
