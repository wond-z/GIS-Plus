/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{O as t,a as n}from"./OptimizedFeature.js";import{normalizeFieldName as o,isNumericField as r}from"../layers/support/fieldUtils.js";const i={LineString:"esriGeometryPolyline",MultiLineString:"esriGeometryPolyline",MultiPoint:"esriGeometryMultipoint",Point:"esriGeometryPoint",Polygon:"esriGeometryPolygon",MultiPolygon:"esriGeometryPolygon"};function s(e){return i[e]}function*c(e){switch(e.type){case"Feature":yield e;break;case"FeatureCollection":for(const t of e.features)t&&(yield t)}}function*l(e){if(!e)return null;switch(e.type){case"Point":yield e.coordinates;break;case"LineString":case"MultiPoint":yield*e.coordinates;break;case"MultiLineString":case"Polygon":for(const t of e.coordinates)yield*t;break;case"MultiPolygon":for(const t of e.coordinates)for(const e of t)yield*e}}function u(e){for(const t of e)if(t.length>2)return!0;return!1}function f(e){let t=0;for(let n=0;n<e.length;n++){const o=e[n],r=e[(n+1)%e.length];t+=o[0]*r[1]-r[0]*o[1]}return t<=0}function a(e){const t=e[0],n=e[e.length-1];return t[0]===n[0]&&t[1]===n[1]&&t[2]===n[2]||e.push(t),e}function y(e,t,n){switch(t.type){case"LineString":case"MultiPoint":return function(e,t,n){return g(e,t.coordinates,n),e}(e,t,n);case"MultiLineString":return function(e,t,n){for(const o of t.coordinates)g(e,o,n);return e}(e,t,n);case"MultiPolygon":return function(e,t,n){for(const o of t.coordinates){p(e,o[0],n);for(let t=1;t<o.length;t++)d(e,o[t],n)}return e}(e,t,n);case"Point":return function(e,t,n){return h(e,t.coordinates,n),e}(e,t,n);case"Polygon":return function(e,t,n){const o=t.coordinates;p(e,o[0],n);for(let t=1;t<o.length;t++)d(e,o[t],n);return e}(e,t,n)}}function p(e,t,n){const o=a(t);f(o)?g(e,o,n):m(e,o,n)}function d(e,t,n){const o=a(t);f(o)?m(e,o,n):g(e,o,n)}function g(e,t,n){for(const o of t)h(e,o,n);e.lengths.push(t.length)}function m(e,t,n){for(let o=t.length-1;o>=0;o--)h(e,t[o],n);e.lengths.push(t.length)}function h(e,t,n){const[o,r,i]=t;e.coords.push(o,r),n.hasZ&&e.coords.push(i||0)}function w(e){switch(typeof e){case"string":return"esriFieldTypeString";case"number":return"esriFieldTypeDouble";default:return"unknown"}}function P(t){if(!t)throw new e("geojson-layer:empty","GeoJSON data is empty");if("Feature"!==t.type&&"FeatureCollection"!==t.type)throw new e("geojson-layer:unsupported-geojson-object","missing or not supported GeoJSON object type",{data:t});const{crs:n}=t;if(!n)return;const o="string"==typeof n?n:"name"===n.type?n.properties.name:"EPSG"===n.type?n.properties.code:null,r=new RegExp(".*(CRS84H?|4326)$","i");if(!o||!r.test(o))throw new e("geojson-layer:unsupported-crs","unsupported GeoJSON 'crs' member",{crs:n})}function b(e,t={}){const n=[],i=new Set,f=new Set;let a,y=!1,p=null,d=!1,{geometryType:g=null}=t,m=!1;for(const t of c(e)){const{geometry:e,properties:r,id:c}=t;if((!e||(g||(g=s(e.type)),s(e.type)===g))&&(y||(y=u(l(e))),d||(d=null!=c,d&&(a=typeof c,p=Object.keys(r).filter((e=>r[e]===c)))),d&&null!=c&&(p.length>1?p=p.filter((e=>r[e]===c)):1===p.length&&(p=r[p[0]]===c?p:[])),!m&&r)){let e=!0;for(const t in r){if(i.has(t))continue;const s=r[t];if(null==s){e=!1,f.add(t);continue}const c=w(s);"unknown"!==c?(f.delete(t),i.add(t),n.push({name:o(t),alias:t,type:c})):f.add(t)}m=e}}const h=o(1===p?.length&&p[0]||null);if(h)for(const e of n)if(e.name===h&&r(e)){e.type="esriFieldTypeOID";break}return{fields:n,geometryType:g,hasZ:y,objectIdFieldName:h,objectIdFieldType:a,unknownFields:Array.from(f)}}function S(e,o){return Array.from(function*(e,o={}){const{geometryType:r,objectIdField:i}=o;for(const c of e){const{geometry:e,properties:l,id:u}=c;if(e&&s(e.type)!==r)continue;const f=l||{};let a=f[i]??null;i&&null!=u&&!f[i]&&(f[i]=a=u);const p=new t(e?y(new n,e,o):null,f,null,a);yield p}}(c(e),o))}export{S as c,s as g,b as i,P as v};
