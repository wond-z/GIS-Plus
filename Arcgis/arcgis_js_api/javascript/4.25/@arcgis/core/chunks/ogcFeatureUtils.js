/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import"../geometry.js";import e from"../request.js";import t from"../core/Error.js";import{L as n}from"./Logger.js";import{a as i,e as a,i as r}from"./maybe.js";import s,{W as o}from"../geometry/SpatialReference.js";import{project as l}from"../geometry/support/webMercatorUtils.js";import{c,a as d,b as u}from"./featureConversionUtils.js";import{O as m}from"./OptimizedFeatureSet.js";import{v as f,i as p,c as g}from"./geojson.js";import{a as y}from"./clientSideDefaults.js";import w from"../layers/support/FieldsIndex.js";import{k as b}from"./fieldType.js";const h=n.getLogger("esri.layers.graphics.sources.ogcfeature"),j="http://www.opengis.net/def/crs/",F=`${j}OGC/1.3/CRS84`;async function I(n,a,r={},o=5){const{links:l}=n,c=M(l,"items","application/geo+json")||M(l,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(i(c))throw new t("ogc-feature-layer:missing-items-page","Missing items url");const{data:d}=await e(c.href,{signal:r.signal,query:{limit:o,...r.customParameters,token:r.apiKey},headers:{accept:"application/geo+json"}});await f(d);const u=p(d,{geometryType:a.geometryType}),m=a.fields||u.fields||[],g=null!=a.hasZ?a.hasZ:u.hasZ,j=u.geometryType,F=a.objectIdField||u.objectIdFieldName||"OBJECTID";let I=a.timeInfo;const T=m.find((({name:e})=>e===F));if(T)T.editable=!1,T.nullable=!1;else{if(!u.objectIdFieldType)throw new t("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");m.unshift({name:F,alias:F,type:"number"===u.objectIdFieldType?"esriFieldTypeOID":"esriFieldTypeString",editable:!1,nullable:!1})}if(F!==u.objectIdFieldName){const e=m.find((({name:e})=>e===u.objectIdFieldName));e&&(e.type="esriFieldTypeInteger")}m===u.fields&&u.unknownFields.length>0&&h.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",details:{unknownFields:u.unknownFields}});for(const e of m){if(null==e.name&&(e.name=e.alias),null==e.alias&&(e.alias=e.name),"esriFieldTypeOID"!==e.type&&"esriFieldTypeGlobalID"!==e.type&&(e.editable=null==e.editable||!!e.editable,e.nullable=null==e.nullable||!!e.nullable),!e.name)throw new t("ogc-feature-layer:invalid-field-name","field name is missing",{field:e});if(!b.jsonValues.includes(e.type))throw new t("ogc-feature-layer:invalid-field-type",`invalid type for field "${e.name}"`,{field:e})}if(I){const e=new w(m);if(I.startTimeField){const t=e.get(I.startTimeField);t?(I.startTimeField=t.name,t.type="esriFieldTypeDate"):I.startTimeField=null}if(I.endTimeField){const t=e.get(I.endTimeField);t?(I.endTimeField=t.name,t.type="esriFieldTypeDate"):I.endTimeField=null}if(I.trackIdField){const t=e.get(I.trackIdField);t?I.trackIdField=t.name:(I.trackIdField=null,h.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:I}}))}I.startTimeField||I.endTimeField||(h.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:I}}),I=null)}const k=j?y(j):null,x=function(e){const t=e.extent?.spatial;if(!t)return null;const n=t.bbox[0],i=4===n.length,a=n[0],r=n[1],o=i?void 0:n[2];return{xmin:a,ymin:r,xmax:i?n[2]:n[3],ymax:i?n[3]:n[4],zmin:o,zmax:i?void 0:n[5],spatialReference:s.WGS84.toJSON()}}(n);return{drawingInfo:k,extent:x,geometryType:j,fields:m,hasZ:!!g,objectIdField:F,timeInfo:I}}async function T(n,a={}){const{links:r}=n,s=M(r,"data","application/json")||M(r,"http://www.opengis.net/def/rel/ogc/1.0/data","application/json");if(i(s))throw new t("ogc-feature-layer:missing-collections-page","Missing collections url");const{apiKey:o,customParameters:l,signal:c}=a,{data:d}=await e(s.href,{signal:c,headers:{accept:"application/json"},query:{...l,token:o}});return d}async function k(n,a={}){const{links:r}=n,s=M(r,"conformance","application/json")||M(r,"http://www.opengis.net/def/rel/ogc/1.0/conformance","application/json");if(i(s))throw new t("ogc-feature-layer:missing-conformance-page","Missing conformance url");const{apiKey:o,customParameters:l,signal:c}=a,{data:d}=await e(s.href,{signal:c,headers:{accept:"application/json"},query:{...l,token:o}});return d}async function x(t,n={}){const{apiKey:i,customParameters:a,signal:r}=n,{data:s}=await e(t,{signal:r,headers:{accept:"application/json"},query:{...a,token:i}});return s}async function S(t,n={}){const a="application/vnd.oai.openapi+json;version=3.0",r=M(t.links,"service-desc",a);if(i(r))return h.warn("ogc-feature-layer:missing-openapi-page","The OGC API-Features server does not have an OpenAPI page."),null;const{apiKey:s,customParameters:o,signal:l}=n,{data:c}=await e(r.href,{signal:l,headers:{accept:a},query:{...o,token:s}});return c}function v(e){const t=/^http:\/\/www\.opengis.net\/def\/crs\/(?<authority>.*)\/(?<version>.*)\/(?<code>.*)$/i.exec(e)?.groups;if(!t)return null;const{authority:n,code:i}=t;switch(n.toLowerCase()){case"ogc":switch(i.toLowerCase()){case"crs27":return s.GCS_NAD_1927.wkid;case"crs83":return 4269;case"crs84":case"crs84h":return s.WGS84.wkid;default:return null}case"esri":case"epsg":{const e=Number.parseInt(i,10);return Number.isNaN(e)?null:e}default:return null}}async function N(e,t,n){const i=await q(e,t,n);return c(i)}async function q(n,c,f){const{collection:p,layerDefinition:y,maxRecordCount:w,queryParameters:{apiKey:b,customParameters:h},spatialReference:j,supportedCrs:F}=n,{links:I}=p,T=M(I,"items","application/geo+json")||M(I,"http://www.opengis.net/def/rel/ogc/1.0/items","application/geo+json");if(i(T))throw new t("ogc-feature-layer:missing-items-page","Missing items url");const{geometry:k,num:x,start:S,timeExtent:v,where:N}=c;if(c.objectIds)throw new t("ogc-feature-layer:query-by-objectids-not-supported","Queries with objectids are not supported");const q=s.fromJSON(j),R=a(c.outSpatialReference,q),W=R.isWGS84?null:O(R,F),$=function(e,t){if(!function(e){return r(e)&&"extent"===e.type}(e))return null;const{spatialReference:n}=e;if(!n||n.isWGS84)return{bbox:C(e)};const i=O(n,t);return r(i)?{bbox:C(e),"bbox-crs":i}:n.isWebMercator?{bbox:C(l(e,s.WGS84))}:null}(k,F),G=function(e){if(i(e))return null;const{start:t,end:n}=e;return`${r(t)?t.toISOString():".."}/${r(n)?n.toISOString():".."}`}(v),D=function(e){return i(e)||!e||"1=1"===e?null:e}(N),P=x??(null!=S&&void 0!==S?10:w),{data:Z}=await e(T.href,{...f,query:{...h,...$,crs:W,datetime:G,query:D,limit:P,startindex:S,token:b},headers:{accept:"application/geo+json"}});let K=!1;if(Z.links){const e=Z.links.find((e=>"next"===e.rel));K=!!e}!K&&Number.isInteger(Z.numberMatched)&&Number.isInteger(Z.numberReturned)&&(K=Z.numberReturned<Z.numberMatched);const{fields:L,geometryType:J,hasZ:z,objectIdField:A}=y,E=g(Z,{geometryType:J,hasZ:z,objectIdField:A});if(!W&&R.isWebMercator)for(const e of E)if(r(e.geometry)){const t=d(e.geometry,J,z,!1);t.spatialReference=s.WGS84,e.geometry=u(l(t,R))}for(const e of E)e.objectId=e.attributes[A];const U=W||!W&&R.isWebMercator?R.toJSON():o,_=new m;return _.exceededTransferLimit=K,_.features=E,_.fields=L,_.geometryType=J,_.hasZ=z,_.objectIdFieldName=A,_.spatialReference=U,_}function O(e,t){const{isWebMercator:n,wkid:i}=e;if(!i)return null;const a=n?t[3857]??t[102100]??t[102113]??t[900913]:t[e.wkid];return a?`${j}${a}`:null}function C(e){if(i(e))return"";const{xmin:t,ymin:n,xmax:a,ymax:r}=e;return`${t},${n},${a},${r}`}function M(e,t,n){return e.find((e=>e.rel===t&&e.type===n))||e.find((e=>e.rel===t&&!e.type))}export{x as a,k as b,F as c,T as d,S as e,I as f,v as g,j as h,q as i,N as q};
