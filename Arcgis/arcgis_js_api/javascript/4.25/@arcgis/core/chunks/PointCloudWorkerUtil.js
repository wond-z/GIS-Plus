/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{a as e,i as o}from"./maybe.js";import r from"../renderers/PointCloudClassBreaksRenderer.js";import t from"../renderers/PointCloudStretchRenderer.js";import l from"../renderers/PointCloudUniqueValueRenderer.js";import{d as n,e as s,f as i,r as a}from"./I3SBinaryReader.js";function u(e,o,n,s){const{rendererJSON:i,isRGBRenderer:a}=e;let u=null,f=null;if(o&&a)u=o;else if(o&&"pointCloudUniqueValueRenderer"===i.type){f=l.fromJSON(i);const e=f.colorUniqueValueInfos;u=new Uint8Array(3*s);const r=m(f.fieldTransformType);for(let t=0;t<s;t++){const l=(r?r(o[t]):o[t])+"";for(let o=0;o<e.length;o++)if(e[o].values.includes(l)){u[3*t]=e[o].color.r,u[3*t+1]=e[o].color.g,u[3*t+2]=e[o].color.b;break}}}else if(o&&"pointCloudStretchRenderer"===i.type){f=t.fromJSON(i);const e=f.stops;u=new Uint8Array(3*s);const r=m(f.fieldTransformType);for(let t=0;t<s;t++){const l=r?r(o[t]):o[t],n=e.length-1;if(l<e[0].value)u[3*t]=e[0].color.r,u[3*t+1]=e[0].color.g,u[3*t+2]=e[0].color.b;else if(l>=e[n].value)u[3*t]=e[n].color.r,u[3*t+1]=e[n].color.g,u[3*t+2]=e[n].color.b;else for(let o=1;o<e.length;o++)if(l<e[o].value){const r=(l-e[o-1].value)/(e[o].value-e[o-1].value);u[3*t]=e[o].color.r*r+e[o-1].color.r*(1-r),u[3*t+1]=e[o].color.g*r+e[o-1].color.g*(1-r),u[3*t+2]=e[o].color.b*r+e[o-1].color.b*(1-r);break}}}else if(o&&"pointCloudClassBreaksRenderer"===i.type){f=r.fromJSON(i);const e=f.colorClassBreakInfos;u=new Uint8Array(3*s);const t=m(f.fieldTransformType);for(let r=0;r<s;r++){const l=t?t(o[r]):o[r];for(let o=0;o<e.length;o++)if(l>=e[o].minValue&&l<=e[o].maxValue){u[3*r]=e[o].color.r,u[3*r+1]=e[o].color.g,u[3*r+2]=e[o].color.b;break}}}else{u=new Uint8Array(3*s);for(let e=0;e<u.length;e++)u[e]=255}if(n&&f&&f.colorModulation){const e=f.colorModulation.minValue,o=f.colorModulation.maxValue,r=.3;for(let t=0;t<s;t++){const l=n[t],s=l>=o?1:l<=e?r:r+(1-r)*(l-e)/(o-e);u[3*t]=s*u[3*t],u[3*t+1]=s*u[3*t+1],u[3*t+2]=s*u[3*t+2]}}return u}function f(o,r){if(null==o.encoding||""===o.encoding){const t=n(r,o);if(e(t.vertexAttributes.position))return;const l=s(r,t.vertexAttributes.position),i=t.header.fields,a=[i.offsetX,i.offsetY,i.offsetZ],u=[i.scaleX,i.scaleY,i.scaleZ],f=l.length/3,c=new Float64Array(3*f);for(let e=0;e<f;e++)c[3*e]=l[3*e]*u[0]+a[0],c[3*e+1]=l[3*e+1]*u[1]+a[1],c[3*e+2]=l[3*e+2]*u[2]+a[2];return c}if("lepcc-xyz"===o.encoding)return i(r).result}function c(e,r,t){return o(e)&&e.attributeInfo.useElevation?d(r,t):o(e)?a(e.attributeInfo.storageInfo,e.buffer,t):null}function d(e,o){const r=new Float64Array(o);for(let t=0;t<o;t++)r[t]=e[3*t+2];return r}function b(e,o,r,t,l){const n=e.length/3;let s=0;for(let i=0;i<n;i++){let n=!0;for(let e=0;e<t.length&&n;e++){const{filterJSON:o}=t[e],r=l[e].values[i];switch(o.type){case"pointCloudValueFilter":{const e="exclude"===o.mode;o.values.includes(r)===e&&(n=!1);break}case"pointCloudBitfieldFilter":{const e=p(o.requiredSetBits),t=p(o.requiredClearBits);(r&e)===e&&0==(r&t)||(n=!1);break}case"pointCloudReturnFilter":{const e=15&r,t=r>>>4&15,l=t>1,s=1===e,i=e===t;let a=!1;for(const e of o.includedReturns)if("last"===e&&i||"firstOfMany"===e&&s&&l||"lastOfMany"===e&&i&&l||"single"===e&&!l){a=!0;break}a||(n=!1);break}}}n&&(r[s]=i,e[3*s]=e[3*i],e[3*s+1]=e[3*i+1],e[3*s+2]=e[3*i+2],o[3*s]=o[3*i],o[3*s+1]=o[3*i+1],o[3*s+2]=o[3*i+2],s++)}return s}function m(e){return null==e||"none"===e?null:"low-four-bit"===e?e=>15&e:"high-four-bit"===e?e=>(240&e)>>4:"absolute-value"===e?e=>Math.abs(e):"modulo-ten"===e?e=>e%10:null}function p(e){let o=0;for(const r of e||[])o|=1<<r;return o}export{d as a,u as e,b as f,c as g,f as r};
