/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{p as t}from"./utils4.js";import{addTokenParameter as e}from"../kernel.js";import r from"../request.js";import{addProxy as o,urlToObject as n,join as s}from"../core/urlUtils.js";import{m as a,c as u}from"./query.js";import i from"../rest/query/support/AttachmentInfo.js";import c from"../rest/support/AttachmentQuery.js";import"../geometry.js";import d from"../rest/support/Query.js";import l from"../geometry/Extent.js";import y from"../rest/support/FeatureSet.js";import m from"../rest/support/RelationshipQuery.js";import f from"../rest/support/TopFeaturesQuery.js";import{i as p}from"./maybe.js";import{getJsonType as j}from"../geometry/support/jsonUtils.js";import{normalizeCentralMeridian as F}from"../geometry/support/normalizeUtils.js";import{a as h}from"./queryZScale.js";function S(t){const e=t.toJSON();return e.attachmentTypes&&(e.attachmentTypes=e.attachmentTypes.join(",")),e.keywords&&(e.keywords=e.keywords.join(",")),e.globalIds&&(e.globalIds=e.globalIds.join(",")),e.objectIds&&(e.objectIds=e.objectIds.join(",")),e.size&&(e.size=e.size.join(",")),e}function O(t,r){const n={};for(const s of t){const{parentObjectId:t,parentGlobalId:a,attachmentInfos:u}=s;for(const s of u){const{id:u}=s,c=o(e(`${r}/${t}/attachments/${u}`)),d=i.fromJSON(s);d.set({url:c,parentObjectId:t,parentGlobalId:a}),n[t]?n[t].push(d):n[t]=[d]}}return n}async function b(e,o,n){const s=t(e);return function(t,e,o){let n={query:a({...t.query,f:"json",...S(e)})};return o&&(n={...o,...n,query:{...o.query,...n.query}}),r(t.path+"/queryAttachments",n)}(s,c.from(o),{...n}).then((t=>O(t.data.attachmentGroups,s.path)))}async function I(e,r,o){const n=t(e);return u(n,d.from(r),{...o}).then((t=>({count:t.data.count,extent:l.fromJSON(t.data.extent)})))}function g(t,e){const r=t.toJSON();return r.objectIds&&(r.objectIds=r.objectIds.join(",")),r.orderByFields&&(r.orderByFields=r.orderByFields.join(",")),r.outFields&&!e?.returnCountOnly?r.outFields.includes("*")?r.outFields="*":r.outFields=r.outFields.join(","):delete r.outFields,r.outSpatialReference&&(r.outSR=r.outSR.wkid||JSON.stringify(r.outSR.toJSON()),delete r.outSpatialReference),r.dynamicDataSource&&(r.layer=JSON.stringify({source:r.dynamicDataSource}),delete r.dynamicDataSource),r}async function R(t,e,o={},n){const s=a({...t.query,f:"json",...n,...g(e,n)});return r(t.path+"/queryRelatedRecords",{...o,query:{...o.query,...s}})}async function x(e,r,o){return r=m.from(r),async function(t,e,r){const o=await R(t,e,r),n=o.data,s=n.geometryType,a=n.spatialReference,u={};for(const t of n.relatedRecordGroups){const e={fields:void 0,objectIdFieldName:void 0,geometryType:s,spatialReference:a,hasZ:!!n.hasZ,hasM:!!n.hasM,features:t.relatedRecords};if(null!=t.objectId)u[t.objectId]=e;else for(const r in t)t.hasOwnProperty(r)&&"relatedRecords"!==r&&(u[t[r]]=e)}return{...o,data:u}}(t(e),r,o).then((t=>{const e=t.data,r={};return Object.keys(e).forEach((t=>r[t]=y.fromJSON(e[t]))),r}))}async function w(e,r,o){return r=m.from(r),async function(t,e,r){const o=await R(t,e,r,{returnCountOnly:!0}),n=o.data,s={};for(const t of n.relatedRecordGroups)null!=t.objectId&&(s[t.objectId]=t.count);return{...o,data:s}}(t(e),r,{...o}).then((t=>t.data))}function q(t,e){const r=t.geometry,o=t.toJSON(),n=o;if(p(r)&&(n.geometry=JSON.stringify(r),n.geometryType=j(r),n.inSR=r.spatialReference.wkid||JSON.stringify(r.spatialReference)),o.topFilter?.groupByFields&&(n.topFilter.groupByFields=o.topFilter.groupByFields.join(",")),o.topFilter?.orderByFields&&(n.topFilter.orderByFields=o.topFilter.orderByFields.join(",")),o.topFilter&&(n.topFilter=JSON.stringify(n.topFilter)),o.objectIds&&(n.objectIds=o.objectIds.join(",")),o.orderByFields&&(n.orderByFields=o.orderByFields.join(",")),o.outFields&&!(e?.returnCountOnly||e?.returnExtentOnly||e?.returnIdsOnly)?o.outFields.includes("*")?n.outFields="*":n.outFields=o.outFields.join(","):delete n.outFields,o.outSR?n.outSR=o.outSR.wkid||JSON.stringify(o.outSR):r&&o.returnGeometry&&(n.outSR=n.inSR),o.returnGeometry&&delete o.returnGeometry,o.timeExtent){const t=o.timeExtent,{start:e,end:r}=t;null==e&&null==r||(n.time=e===r?e:`${e??"null"},${r??"null"}`),delete o.timeExtent}return n}function E(t,e,o,u={},i={}){const c="string"==typeof t?n(t):t,d=e.geometry?[e.geometry]:[];return u.responseType="pbf"===o?"array-buffer":"json",F(d,null,u).then((t=>{const n=t&&t[0];p(n)&&((e=e.clone()).geometry=n);const d=a({...c.query,f:o,...i,...q(e,i)});return r(s(c.path,"queryTopFeatures"),{...u,query:{...d,...u.query}})}))}async function N(e,r,o,n){const s=t(e),a={...n},{data:u}=await async function(t,e,r,o){const n=await E(t,e,"json",o);return h(e,r,n.data),n}(s,f.from(r),o,a);return y.fromJSON(u)}async function J(e,r,o){const n=t(e),s=await async function(t,e,r){return p(e.timeExtent)&&e.timeExtent.isEmpty?{data:{objectIds:[]}}:E(t,e,"json",r,{returnIdsOnly:!0})}(n,f.from(r),{...o});return s.data.objectIds}async function B(e,r,o){const n=t(e),s=await async function(t,e,r){return p(e.timeExtent)&&e.timeExtent.isEmpty?{data:{count:0,extent:null}}:E(t,e,"json",r,{returnExtentOnly:!0,returnCountOnly:!0}).then((t=>{const e=t.data;if(e.hasOwnProperty("extent"))return t;if(e.features)throw new Error("Layer does not support extent calculation.");if(e.hasOwnProperty("count"))throw new Error("Layer does not support extent calculation.");return t}))}(n,f.from(r),{...o});return{count:s.data.count,extent:l.fromJSON(s.data.extent)}}async function T(e,r,o){const n=t(e),s=await function(t,e,r){return p(e.timeExtent)&&e.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):E(t,e,"json",r,{returnIdsOnly:!0,returnCountOnly:!0})}(n,f.from(r),{...o});return s.data.count}export{I as a,x as b,w as c,N as d,b as e,J as f,B as g,T as h,O as p};
