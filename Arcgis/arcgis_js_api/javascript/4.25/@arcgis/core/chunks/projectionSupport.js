/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{i as s}from"./maybe.js";import{initializeProjection as n,projectMany as t}from"../geometry/projection.js";import{j as e}from"./json.js";import{j as r,e as i,i as o}from"../geometry/SpatialReference.js";import{lngLatToXY as a,xyToLngLat as m,canProject as u}from"../geometry/support/webMercatorUtils.js";const l=[0,0];function h(s,n){if(!n)return null;if("x"in n){const t={x:0,y:0};return[t.x,t.y]=s(n.x,n.y,l),null!=n.z&&(t.z=n.z),null!=n.m&&(t.m=n.m),t}if("xmin"in n){const t={xmin:0,ymin:0,xmax:0,ymax:0};return[t.xmin,t.ymin]=s(n.xmin,n.ymin,l),[t.xmax,t.ymax]=s(n.xmax,n.ymax,l),n.hasZ&&(t.zmin=n.zmin,t.zmax=n.zmax,t.hasZ=!0),n.hasM&&(t.mmin=n.mmin,t.mmax=n.mmax,t.hasM=!0),t}return"rings"in n?{rings:c(n.rings,s),hasM:n.hasM,hasZ:n.hasZ}:"paths"in n?{paths:c(n.paths,s),hasM:n.hasM,hasZ:n.hasZ}:"points"in n?{points:p(n.points,s),hasM:n.hasM,hasZ:n.hasZ}:null}function c(s,n){const t=[];for(const e of s)t.push(p(e,n));return t}function p(s,n){const t=[];for(const e of s){const s=n(e[0],e[1],[0,0]);t.push(s),e.length>2&&s.push(e[2]),e.length>3&&s.push(e[3])}return t}async function f(t,e){if(!t||!e)return;const r=Array.isArray(t)?t.map((n=>s(n.geometry)?n.geometry.spatialReference:null)).filter(s):[t];await n(r.map((s=>({source:s,dest:e}))))}const x=h.bind(null,a),y=h.bind(null,m);function g(s,n,a,m){if(!s)return s;if(a||(a=n,n=s.spatialReference),!r(n)||!r(a)||i(n,a))return s;if(u(n,a)){const n=o(a)?x(s):y(s);return n.spatialReference=a,n}return t(e,[s],n,a,null,m)[0]}const j=new class{constructor(){this._jobs=[],this._timer=null,this._process=this._process.bind(this)}async push(s,n,t){if(!s||!s.length||!n||!t||i(n,t))return s;const e={geometries:s,inSpatialReference:n,outSpatialReference:t,resolve:null};return this._jobs.push(e),new Promise((s=>{e.resolve=s,null===this._timer&&(this._timer=setTimeout(this._process,10))}))}_process(){this._timer=null;const s=this._jobs.shift();if(!s)return;const{geometries:n,inSpatialReference:r,outSpatialReference:i,resolve:a}=s;u(r,i)?o(i)?a(n.map(x)):a(n.map(y)):a(t(e,n,r,i,null,null)),this._jobs.length>0&&(this._timer=setTimeout(this._process,10))}};function _(s,n,t){return j.push(s,n,t)}export{_ as a,f as c,g as p};
