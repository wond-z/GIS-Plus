/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{c as t,g as r,b as n,d as i}from"../geometry/Extent.js";import{isPolygon as s,isExtent as o,getJsonType as l}from"../geometry/support/jsonUtils.js";import{j as u}from"../geometry/SpatialReference.js";import{e as a}from"./featureConversionUtils.js";import{a as p}from"./OptimizedFeature.js";import{c}from"./projectionSupport.js";import{g as f}from"./utils21.js";function m(e,t){return e?t?4:3:t?3:2}function y(e,t,r,n,i){if(!e)return!1;const s=m(t,r),{coords:o,lengths:l}=e;let u=!1,a=0;for(const e of l)u=R(u,o,s,a,e,n,i),a+=e*s;return u}function R(e,t,r,n,i,s,o){let l=e,u=n;for(let e=n,a=n+i*r;e<a;e+=r){u=e+r,u===a&&(u=n);const i=t[e],p=t[e+1],c=t[u],f=t[u+1];(p<o&&f>=o||f<o&&p>=o)&&i+(o-p)/(f-p)*(c-i)<s&&(l=!l)}return l}const S={esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"intersects",esriSpatialRelIndexIntersects:null,esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:null},g={esriSpatialRelIntersects:!0,esriSpatialRelContains:!0,esriSpatialRelWithin:!0,esriSpatialRelCrosses:!0,esriSpatialRelDisjoint:!0,esriSpatialRelTouches:!0,esriSpatialRelOverlaps:!0,esriSpatialRelEnvelopeIntersects:!0,esriSpatialRelIndexIntersects:!1,esriSpatialRelRelation:!1},d={esriGeometryPoint:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!0},h={esriGeometryPoint:!0,esriGeometryMultipoint:!0,esriGeometryPolyline:!0,esriGeometryPolygon:!0,esriGeometryEnvelope:!1};function I(e,l,u,c,R){if(s(l)&&"esriGeometryPoint"===u&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e)){const e=a(new p,l,!1,!1);return Promise.resolve((t=>function(e,t,r,n){return y(e,!1,!1,n.coords[0],n.coords[1])}(e,0,0,t)))}if(s(l)&&"esriGeometryMultipoint"===u){const t=a(new p,l,!1,!1);if("esriSpatialRelContains"===e)return Promise.resolve((e=>function(e,t,r,n,i,s){const o=m(i,s),{coords:l,lengths:u}=n;if(!u)return!1;for(let t=0,r=0;t<u.length;t++,r+=o)if(!y(e,!1,!1,l[r],l[r+1]))return!1;return!0}(t,0,0,e,c,R)))}if(o(l)&&"esriGeometryPoint"===u&&("esriSpatialRelIntersects"===e||"esriSpatialRelContains"===e))return Promise.resolve((e=>n(l,f(u,c,R,e))));if(o(l)&&"esriGeometryMultipoint"===u&&"esriSpatialRelContains"===e)return Promise.resolve((e=>i(l,f(u,c,R,e))));if(o(l)&&"esriSpatialRelIntersects"===e){const e=function(e){return"mesh"===e?t:r(e)}(u);return Promise.resolve((t=>e(l,f(u,c,R,t))))}return import("./geometryEngineJSON.js").then((e=>e.g)).then((t=>{const r=t[S[e]].bind(null,l.spatialReference,l);return e=>r(f(u,c,R,e))}))}async function v(t,r,n){const{spatialRel:i,geometry:s}=t;if(s){if(null==(o=i)||!0!==g[o])throw new e("feature-store:unsupported-query","Unsupported query spatial relationship",{query:t});var o;if(u(s.spatialReference)&&u(n)){if(!function(e){return null!=e&&!0===d[l(e)]}(s))throw new e("feature-store:unsupported-query","Unsupported query geometry type",{query:t});if(!function(e){return null!=e&&!0===h[e]}(r))throw new e("feature-store:unsupported-query","Unsupported layer geometry type",{query:t});if(t.outSR)return c(t.geometry&&t.geometry.spatialReference,t.outSR)}}}function b(e){if(o(e))return!0;if(s(e)){for(const t of e.rings){if(5!==t.length)return!1;if(t[0][0]!==t[1][0]||t[0][0]!==t[4][0]||t[2][0]!==t[3][0]||t[0][1]!==t[3][1]||t[0][1]!==t[4][1]||t[1][1]!==t[2][1])return!1}return!0}return!1}function j(e,t){if(!e)return null;const r=t.featureAdapter,{startTimeField:n,endTimeField:i}=e;let s=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;if(n&&i)t.forEach((e=>{const t=r.getAttribute(e,n),l=r.getAttribute(e,i);null==t||isNaN(t)||(s=Math.min(s,t)),null==l||isNaN(l)||(o=Math.max(o,l))}));else{const e=n||i;t.forEach((t=>{const n=r.getAttribute(t,e);null==n||isNaN(n)||(s=Math.min(s,n),o=Math.max(o,n))}))}return{start:s,end:o}}function G(e,t,r){if(!t||!e)return null;const{startTimeField:n,endTimeField:i}=e;if(!n&&!i)return null;const{start:s,end:o}=t;return null===s&&null===o?null:void 0===s&&void 0===o?()=>!1:n&&i?function(e,t,r,n,i){return null!=n&&null!=i?s=>{const o=e.getAttribute(s,t),l=e.getAttribute(s,r);return(null==o||o<=i)&&(null==l||l>=n)}:null!=n?t=>{const i=e.getAttribute(t,r);return null==i||i>=n}:null!=i?r=>{const n=e.getAttribute(r,t);return null==n||n<=i}:void 0}(r,n,i,s,o):function(e,t,r,n){return null!=r&&null!=n&&r===n?n=>e.getAttribute(n,t)===r:null!=r&&null!=n?i=>{const s=e.getAttribute(i,t);return s>=r&&s<=n}:null!=r?n=>e.getAttribute(n,t)>=r:null!=n?r=>e.getAttribute(r,t)<=n:void 0}(r,n||i,s,o)}export{I as a,G as b,b as c,v as d,j as g};
