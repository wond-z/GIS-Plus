/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import e from"../Color.js";import{isSymbol3D as t,isSymbol2D as r}from"../symbols.js";import{f as o}from"./asyncUtils.js";import{h as n}from"./object.js";import{a as s,u as l,i,j as a,c}from"./maybe.js";import{a as u,p as f}from"./screenUtils.js";import{O as m}from"./vec3.js";import{e as p}from"./jsonUtils.js";import{g as y}from"./assets.js";import h from"../request.js";import{I as b}from"./ItemCache.js";import{getCIMSymbolColor as d}from"../symbols/support/cimSymbolUtils.js";import{S as w}from"./Symbol3DMaterial.js";const g=new b(1e3);function j(e){const t=e.style;let r=null;if(e)switch(e.type){case"simple-marker":"cross"!==t&&"x"!==t&&(r=e.color);break;case"simple-fill":"solid"===t?r=e.color:"none"!==t&&(r={type:"pattern",x:0,y:0,src:y(`esri/symbols/patterns/${t}.png`),width:5,height:5});break;case"picture-fill":r={type:"pattern",src:e.url,width:u(e.width)*e.xscale,height:u(e.height)*e.yscale,x:u(e.xoffset),y:u(e.yoffset)};break;case"text":r=e.color;break;case"cim":r=d(e)}return r}function k(e,t){const r=e+"-"+t;return void 0!==g.get(r)?Promise.resolve(g.get(r)):h(e,{responseType:"image"}).then((e=>{const o=e.data,n=o.naturalWidth,s=o.naturalHeight,l=document.createElement("canvas");l.width=n,l.height=s;const i=l.getContext("2d");i.fillStyle=t,i.fillRect(0,0,n,s),i.globalCompositeOperation="destination-in",i.drawImage(o,0,0);const a=l.toDataURL();return g.put(r,a),a}))}function L(e){if(!e)return null;let t=null;switch(e.type){case"simple-fill":case"picture-fill":case"simple-marker":t=L(e.outline);break;case"simple-line":{const r=u(e.width);null!=e.style&&"none"!==e.style&&0!==r&&(t={color:e.color,style:x(e.style),width:r,cap:e.cap,join:"miter"===e.join?u(e.miterLimit):e.join});break}default:t=null}return t}const x=(()=>{const e={};return t=>{if(e[t])return e[t];const r=t.replace(/-/g,"");return e[t]=r,r}})(),v=new e([128,128,128]),z=/\/resource\/(.*?)\.svg$/,S=new e("white");function U(e){if(!e)return 0;if(t(e)){const t=function(e){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const r=e.symbolLayers.getItemAt(t-1);return"outline"in r?a(r,"outline","size"):void 0}(e);return i(t)?t:0}return f(L(e)?.width)}function O(e){if(s(e)||!("symbolLayers"in e)||s(e.symbolLayers))return!1;switch(e.type){case"point-3d":return e.symbolLayers.some((e=>"object"===e.type));case"line-3d":return e.symbolLayers.some((e=>"path"===e.type));case"polygon-3d":return e.symbolLayers.some((e=>"object"===e.type||"extrude"===e.type));default:return!1}}function C(e,t){const r=c(t.resource).href;return!n("esri-canvas-svg-support")&&e.styleOrigin&&z.test(r)?r.replace(z,"/resource/png/$1.png"):r}function E(o,n){if(!o)return null;let s=null;return t(o)?s=function(t){const r=t.symbolLayers;if(!r)return null;let o=null;return r.forEach((e=>{"object"===e.type&&null!=e.resource?.href||(o="water"===e.type?l(e.color):i(e.material)?l(e.material.color):null)})),o?new e(o):null}(o):r(o)&&(s=o.color?new e(o.color):null),s?I(s,n):null}function I(t,r){if(null==r||null==t)return t;const o=t.toRgba();return o[3]=o[3]*r,new e(o)}function R(o,n,l){o&&(n||null!=l)&&(n&&(n=new e(n)),t(o)?function(e,t,r){const o=e.symbolLayers;if(!o)return;const n=e=>{const o=i(e)?e:null;return I(t=t??o??(null!=r?S:null),r)};o.forEach((e=>{if("object"!==e.type||null==e.resource?.href||t)if("water"===e.type)e.color=n(e.color);else{const t=i(e.material)?e.material.color:null,o=n(t);s(e.material)?e.material=new w({color:o}):e.material.color=o,null!=r&&"outline"in e&&i(e.outline)&&i(e.outline.color)&&(e.outline.color=I(e.outline.color,r))}}))}(o,n,l):r(o)&&function(e,t,r){(t=t??e.color)&&(e.color=I(t,r)),null!=r&&"outline"in e&&e.outline&&e.outline.color&&(e.outline.color=I(e.outline.color,r))}(o,n,l))}function $(e){for(const t of e)if("number"==typeof t)return t;return null}function D(e,t,r){for(let o=0;o<3;o++){const n=e[o];switch(n){case"symbol-value":{const e=r[o];return null!=e?e/t[o]:1}case"proportional":break;default:if(n&&t[o])return n/t[o]}}return 1}function q(e,t,r,o){switch(e){case"proportional":return r*o;case"symbol-value":return null!=t?t:r;default:return e}}async function A(e,n){if(e&&n)return t(e)?async function(e,t){const r=e.symbolLayers;r&&await o(r,(async e=>async function(e,t){switch(e.type){case"extrude":!function(e,t){e.size="number"==typeof t[2]?t[2]:0}(e,t);break;case"icon":case"line":case"text":!function(e,t){const r=$(t);i(r)&&(e.size=r)}(e,t);break;case"path":!function(e,t){const r=D(t,m,[e.width,void 0,e.height]);e.width=q(t[0],e.width,1,r),e.height=q(t[2],e.height,1,r)}(e,t);break;case"object":await async function(e,t){const{resourceSize:r,symbolSize:o}=await async function(e){const t=await import("./symbolLayerUtils.js"),r=await t.computeObjectLayerResourceSize(e,10),{width:o,height:n,depth:s}=e,l=[o,s,n];let i=1;for(let e=0;e<3;e++){const t=l[e];if(null!=t){i=t/r[e];break}}for(let e=0;e<3;e++)null==l[e]&&(l[e]=r[e]*i);return{resourceSize:r,symbolSize:l}}(e),n=D(t,r,o);e.width=q(t[0],o[0],r[0],n),e.depth=q(t[1],o[1],r[1],n),e.height=q(t[2],o[2],r[2],n)}(e,t)}}(e,t)))}(e,n):void(r(e)&&function(e,t){const r=$(t);if(!s(r))switch(e.type){case"simple-marker":e.size=r;break;case"picture-marker":{const t=e.width/e.height;t>1?(e.width=r,e.height=r*t):(e.width=r*t,e.height=r);break}case"simple-line":e.width=r;break;case"text":e.font.size=r}}(e,n))}function H(e,o,n){if(e&&null!=o)if(t(e)){const t=e.symbolLayers;t&&t.forEach((e=>{if(e&&"object"===e.type)switch(n){case"tilt":e.tilt=o;break;case"roll":e.roll=o;break;default:e.heading=o}}))}else r(e)&&("simple-marker"!==e.type&&"picture-marker"!==e.type&&"text"!==e.type||(e.angle=o))}function J(e){if(!e)return null;const t=e.effects.filter((e=>"bloom"!==e.type)).map((e=>e.toJSON()));return p(t)}function M(e){return i(e)&&"polygon-3d"===e.type&&e.symbolLayers.some((e=>"extrude"===e.type))}export{A as a,H as b,R as c,J as d,L as e,I as f,E as g,C as h,j as i,O as j,U as k,v as l,k as m,x as n,M as s};
