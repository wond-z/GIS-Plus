/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as e}from"./tslib.es6.js";import"../geometry.js";import t from"../core/Collection.js";import{L as s}from"./Logger.js";import{o as r}from"./ensureType.js";import{i,a as o}from"./maybe.js";import{o as a,isAbortError as m}from"../core/promiseUtils.js";import{watch as n,initial as p,when as l,on as c}from"../core/reactiveUtils.js";import{property as h}from"../core/accessorSupport/decorators/property.js";import"../core/lang.js";import{subclass as d}from"../core/accessorSupport/decorators/subclass.js";import{c as u}from"./aaBoundingRect.js";import j,{r as f}from"../geometry/Extent.js";import{M as y}from"./mediaUtils.js";import{T as g,a as v}from"./TileStrategy.js";import"./TileInfoView.js";import"./TileKey2.js";import _ from"../core/Error.js";import{i as w}from"./mathUtils.js";import{g as T}from"./perspectiveUtils.js";import{c as M}from"./mat3f64.js";import{s as R}from"./vec2.js";import{a as U}from"./vec2f64.js";import{D as x}from"./DisplayObject.js";import{B as C,V as S}from"./FramebufferObject.js";import{P as b,a as E,c as V,b as P,U as A}from"./enums3.js";import{T as q,i as D}from"./Texture.js";import{c as L}from"./screenUtils.js";import{d as O,m as I,e as W,j as z,r as G}from"./mat3.js";import{c as k}from"./mat3f32.js";import{f as B}from"./vec2f32.js";import{f as H}from"./vec3f32.js";import{normalizeMapX as Q}from"../geometry/support/normalizeUtils.js";import{g as F}from"../geometry/SpatialReference.js";import{m as N}from"../views/2d/ViewState.js";import{W as K,b as Y}from"./WGLContainer.js";import{W as J}from"./enums4.js";import{L as X}from"./LayerView2D.js";import Z from"../views/layers/LayerView.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"./get.js";import"./utils.js";import"./handleUtils.js";import"./metadata.js";import"./object.js";import"./ArrayPool.js";import"./tracking.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"../config.js";import"./string.js";import"./reader.js";import"./writer.js";import"../geometry/Multipoint.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./Ellipsoid.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"./jsonMap.js";import"../geometry/support/jsonUtils.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../geometry/projection.js";import"./unitUtils.js";import"./projectionEllipsoid.js";import"./mat4.js";import"./common.js";import"./vec3.js";import"./pe.js";import"./assets.js";import"../request.js";import"../kernel.js";import"../core/urlUtils.js";import"./geodesicConstants.js";import"../geometry/support/GeographicTransformation.js";import"../geometry/support/GeographicTransformationStep.js";import"./zscale.js";import"./normalizeUtilsSync.js";import"./normalizeUtilsCommon.js";import"./QueueProcessor.js";import"./Queue.js";import"./context-util.js";import"./simplify.js";import"./utils4.js";import"./utils5.js";import"../Viewpoint.js";import"../Camera.js";import"../core/Clonable.js";import"./Cyclical.js";import"./mat2d.js";import"./mat2df32.js";import"./mat2df64.js";import"./WGLBrushVTLSymbol.js";import"./vec4f32.js";import"./definitions.js";import"./number2.js";import"./StyleDefinition.js";import"./enums.js";import"./config.js";import"./GeometryUtils2.js";import"./pixelUtils.js";import"../layers/support/PixelBlock.js";import"./DefaultVertexAttributeLayouts.js";import"./VertexElementDescriptor.js";import"./Utils18.js";import"./ShaderCompiler.js";import"./ProgramTemplate.js";import"./Program.js";import"./MaterialKey.js";import"./alignmentUtils.js";import"./utils19.js";import"./heatmapUtils.js";import"./vec4f64.js";import"../Color.js";import"./colorUtils.js";import"./heatmapTextureUtils.js";import"./Container.js";import"./EffectView.js";import"./parser.js";import"./mat4f32.js";import"./_commonjsHelpers.js";import"./earcut.js";import"./featureConversionUtils.js";import"./OptimizedFeature.js";import"./OptimizedFeatureSet.js";import"./collectionUtils.js";import"./ClipRect.js";import"../core/HandleOwner.js";import"./WatchUpdatingTracking.js";import"../core/Identifiable.js";import"../core/Promise.js";const $=M();class ee extends x{constructor(e){super(),this.elementView=e,this.isWrapAround=!1,this.perspectiveTransform=U(),this._vertices=new Float32Array(20),this._handles=[],this._handles.push(n((()=>this.elementView.element.opacity),(e=>this.opacity=e),p),n((()=>[this.elementView.coords]),(()=>{this.requestRender()}),p),l((()=>this.elementView.element.loaded),(()=>{const e=this.elementView.element;this.ready(),"video"===e.type&&i(e.content)&&this._handles.push(a(e.content,"play",(()=>this.requestRender())))}),p)),e.element.load().catch((t=>{s.getLogger("esri.views.2d.layers.MediaLayerView2D").error(new _("element-load-error","Element cannot be displayed",{element:e,error:t}))}))}destroy(){this._handles.forEach((e=>e.remove())),this.texture?.dispose(),this.texture=null}get dvsMat3(){return this.parent.dvsMat3}beforeRender(e){const{context:t}=e,s=this.elementView.element.content;if(i(s)){const e=s instanceof HTMLImageElement,r=s instanceof HTMLVideoElement,i=e?s.naturalWidth:r?s.videoWidth:s.width,o=e?s.naturalHeight:r?s.videoHeight:s.height;this._updatePerspectiveTransform(i,o),this.texture?r&&!s.paused&&(this.texture.setData(s),this.requestRender(),(D(t.gl)||w(i)&&w(o))&&this.texture.generateMipmap()):(this.texture=new q(t,{pixelFormat:b.RGBA,dataType:E.UNSIGNED_BYTE,samplingMode:V.LINEAR,wrapMode:P.CLAMP_TO_EDGE,width:i,height:o,preMultiplyAlpha:!0},s),(D(t.gl)||w(i)&&w(o))&&this.texture.generateMipmap(),r&&!s.paused&&this.requestRender())}super.beforeRender(e)}_createTransforms(){return null}updateDrawCoords(e,t){const s=this.elementView.coords;if(o(s))return;const[r,i,a,m]=s.rings[0],n=this._vertices,{x:p,y:l}=e,c=0!==t;c?n.set([i[0]-p,i[1]-l,r[0]-p,r[1]-l,a[0]-p,a[1]-l,m[0]-p,m[1]-l,m[0]-p,m[1]-l,i[0]+t-p,i[1]-l,i[0]+t-p,i[1]-l,r[0]+t-p,r[1]-l,a[0]+t-p,a[1]-l,m[0]+t-p,m[1]-l]):n.set([i[0]-p,i[1]-l,r[0]-p,r[1]-l,a[0]-p,a[1]-l,m[0]-p,m[1]-l]),this.isWrapAround=c}getVAO(e,t,s){if(o(this.elementView.coords))return null;const r=this._vertices;if(this._vao)this._geometryVbo.setData(r);else{this._geometryVbo=C.createVertex(e,A.DYNAMIC_DRAW,r);const i=C.createVertex(e,A.STATIC_DRAW,new Uint16Array([0,0,0,1,1,0,1,1,1,1,0,0,0,0,0,1,1,0,1,1]));this._vao=new S(e,s,t,{geometry:this._geometryVbo,tex:i})}return this._vao}_updatePerspectiveTransform(e,t){const s=this._vertices;T($,[0,0,e,0,0,t,e,t],[s[0],s[1],s[4],s[5],s[2],s[3],s[6],s[7]]),R(this.perspectiveTransform,$[6]/$[8]*e,$[7]/$[8]*t)}}class te extends K{constructor(){super(...arguments),this._localOrigin=L(0,0),this._viewStateId=-1,this._dvsMat3=k(),this.requiresDedicatedFBO=!1}get dvsMat3(){return this._dvsMat3}beforeRender(e){this._updateMatrices(e),this._updateOverlays(e,this.children);for(const t of this.children)t.beforeRender(e)}prepareRenderPasses(e){const t=e.registerRenderPass({name:"overlay",brushes:[Y.overlay],target:()=>this.children,drawPhase:J.MAP});return[...super.prepareRenderPasses(e),t]}_updateMatrices(e){const{state:t}=e,{id:s,size:r,pixelRatio:i,resolution:o,rotation:a,viewpoint:m,displayMat3:n}=t;if(this._viewStateId===s)return;const p=Math.PI/180*a,l=i*r[0],c=i*r[1],{x:h,y:d}=m.targetGeometry,u=Q(h,t.spatialReference);this._localOrigin.x=u,this._localOrigin.y=d;const j=o*l,f=o*c,y=O(this._dvsMat3);I(y,y,n),W(y,y,B(l/2,c/2)),z(y,y,H(l/j,-c/f,1)),G(y,y,-p),this._viewStateId=s}_updateOverlays(e,t){const{state:s}=e,{rotation:r,spatialReference:i,worldScreenWidth:a,size:m,viewpoint:n}=s,p=this._localOrigin;let l=0;if(i.isWrappable){const e=m[0],c=m[1],h=180/Math.PI*r,d=Math.abs(Math.cos(h)),u=Math.abs(Math.sin(h)),j=Math.round(e*d+c*u),[f,y]=F(i).valid,g=N(i),{x:v,y:_}=n.targetGeometry,w=[v,_],T=[0,0];s.toScreen(T,w);const M=[0,0];let R;R=j>a?.5*a:.5*j;const U=Math.floor((v+.5*g)/g),x=f+U*g,C=y+U*g,S=[T[0]+R,0];s.toMap(M,S),M[0]>C&&(l=g),S[0]=T[0]-R,s.toMap(M,S),M[0]<x&&(l=-g);for(const e of t){const t=e.elementView.bounds;if(o(t))continue;const[s,,r]=t;s<f&&r>f?e.updateDrawCoords(p,g):r>y&&s<y?e.updateDrawCoords(p,-g):e.updateDrawCoords(p,l)}}else for(const e of t)e.updateDrawCoords(p,l)}}let se=class extends(X(Z)){constructor(){super(...arguments),this._overlayContainer=null,this._fetchQueue=null,this._tileStrategy=null,this._elementReferences=new Map,this.layer=null,this.elements=new t}attach(){this.handles.add(c((()=>this.layer.source),"refresh",(()=>{for(const e of this._tileStrategy.tiles)this._updateTile(e);this.requestUpdate()}))),this._overlayContainer=new te,this.container.addChild(this._overlayContainer),this._fetchQueue=new g({tileInfoView:this.view.featuresTilingScheme,concurrency:10,process:(e,t)=>this._queryElements(e,t)}),this._tileStrategy=new v({cachePolicy:"purge",resampling:!0,acquireTile:e=>this._acquireTile(e),releaseTile:e=>this._releaseTile(e),tileInfoView:this.view.featuresTilingScheme}),this.requestUpdate()}detach(){this.handles.removeAll(),this.elements.removeAll(),this._tileStrategy.destroy(),this._fetchQueue.destroy(),this._overlayContainer.removeAllChildren(),this.container.removeAllChildren(),this._elementReferences.clear()}supportsSpatialReference(e){return!0}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}update(e){this._tileStrategy.update(e)}async hitTest(e,t){const s=[],r=e.normalize(),o=[r.x,r.y];for(const{projectedElement:{normalizedCoords:t,element:r}}of this._elementReferences.values())i(t)&&f(t.rings,o)&&s.push({type:"media",element:r,layer:this.layer,mapPoint:e});return s.reverse()}canResume(){return null!=this.layer.source&&super.canResume()}async doRefresh(){}_acquireTile(e){const t=new ie(e.clone());return this._updateTile(t),t}_updateTile(e){this.updatingHandles.addPromise(this._fetchQueue.push(e.key).then((t=>{const[s,r]=e.setElements(t);this._acquireElements(e,s),this._releaseElements(e,r),this.requestUpdate()}),(e=>{m(e)||s.getLogger(this.declaredClass).error(e)})))}_releaseTile(e){this._fetchQueue.abort(e.key.id),e.elements&&this._releaseElements(e,e.elements),this.requestUpdate()}async _queryElements(e,t){const s=this.layer.source;if(o(s))return[];this.view.featuresTilingScheme.getTileBounds(re,e,!0);const r=new j({xmin:re[0],ymin:re[1],xmax:re[2],ymax:re[3],spatialReference:this.view.spatialReference});return s.queryElements(r,t)}_acquireElements(e,t){const s=this.layer.source,i=this.view.spatialReference;if(!o(s))for(const s of t)r(this._elementReferences,s.uid,(()=>{const e=new y({element:s,spatialReference:i}),t=new ee(e);return this._overlayContainer.addChild(t),this.elements.add(s),{tiles:new Set,projectedElement:e,overlay:t}})).tiles.add(e)}_releaseElements(e,t){for(const s of t){const t=this._elementReferences.get(s.uid);t.tiles.delete(e),t.tiles.size||(this._overlayContainer.removeChild(t.overlay),t.overlay.destroy(),t.projectedElement.destroy(),this._elementReferences.delete(s.uid),this.elements.remove(s))}}};e([h()],se.prototype,"_fetchQueue",void 0),e([h()],se.prototype,"layer",void 0),e([h({readOnly:!0})],se.prototype,"elements",void 0),se=e([d("esri.views.2d.layers.MediaLayerView2D")],se);const re=u();class ie{constructor(e){this.key=e,this.elements=null,this.isReady=!1,this.visible=!0}setElements(e){const t=[],s=new Set(this.elements);this.elements=e;for(const r of e)s.has(r)?s.delete(r):t.push(r);return this.isReady=!0,[t,Array.from(s)]}}const oe=se;export{oe as default};
