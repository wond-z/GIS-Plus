/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{L as t}from"./Logger.js";import{b as i,e,q as r,t as s,h}from"./mathUtils.js";import{i as n,a as o}from"./maybe.js";import{e as a,b as _}from"./screenUtils.js";import{j as p,m as v,o as u,c,t as w,p as d}from"./mat4.js";import{c as l}from"./mat4f64.js";import{k as y,v as g}from"./vec2.js";import{f}from"./vec2f64.js";import{d as m,c as x,k as D,f as j,b as M,C as T,j as P,v as R,m as F,J as O,K as V,g as I,l as S,s as E,h as b,n as L,F as H}from"./vec3.js";import{f as B,c as G}from"./vec4f64.js";import{d as U,e as C,h as A}from"./frustum.js";import{c as k}from"./ray.js";import{p as z}from"./vector.js";import{V as W}from"./ViewingMode.js";import{f as X,b as Y,c as q,d as J}from"./Util2.js";class K{constructor(t=null,i=null,e=null){this._viewUp=m(),this._viewForward=m(),this._viewRight=m(),this._ray=k(),this._viewport=B(0,0,1,1),this._padding=B(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=f(1,1e3),this._viewDirty=!0,this._viewMatrix=l(),this._projectionDirty=!0,this._projectionMatrix=l(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=l(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=l(),this._inverseProjectionDirty=!0,this._inverseProjectionMatrix=null,this._frustumDirty=!0,this._frustum=U(),this._fullViewport=G(),this._pixelRatio=1,this.relativeElevation=0,n(t)&&x(this._ray.origin,t),this._center=n(i)?D(i):m(),this._up=n(e)?D(e):j(0,0,1)}get pixelRatio(){return this._pixelRatio}set pixelRatio(t){this._pixelRatio=t>0?t:1}get eye(){return this._ray.origin}set eye(t){this._compareAndSetView(t,this._ray.origin)}get center(){return this._center}set center(t){this._compareAndSetView(t,this._center)}get ray(){return M(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(t){this._compareAndSetView(t,this._up)}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(t){p(this._viewMatrix,t),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),this._viewForward}get viewUp(){return this._ensureViewClean(),this._viewUp}get viewRight(){return this._ensureViewClean(),this._viewRight}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(t){this._nearFar[0]!==t&&(this._nearFar[0]=t,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get far(){return this._nearFar[1]}set far(t){this._nearFar[1]!==t&&(this._nearFar[1]=t,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewport(){return this._viewport}set viewport(t){this.x=t[0],this.y=t[1],this.width=t[2],this.height=t[3]}get x(){return this._viewport[0]}set x(t){t+=this._padding[it.LEFT],this._viewport[0]!==t&&(this._viewport[0]=t,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get y(){return this._viewport[1]}set y(t){t+=this._padding[it.BOTTOM],this._viewport[1]!==t&&(this._viewport[1]=t,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get width(){return this._viewport[2]}set width(t){this._viewport[2]!==t&&(this._viewport[2]=t,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get height(){return this._viewport[3]}set height(t){this._viewport[3]!==t&&(this._viewport[3]=t,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get fullWidth(){return this._viewport[2]+this._padding[it.RIGHT]+this._padding[it.LEFT]}set fullWidth(t){this.width=t-(this._padding[it.RIGHT]+this._padding[it.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[it.TOP]+this._padding[it.BOTTOM]}set fullHeight(t){this.height=t-(this._padding[it.TOP]+this._padding[it.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[it.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[it.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get aspect(){return this.width/this.height}get padding(){return this._padding}set padding(t){this._padding[it.TOP]===t[it.TOP]&&this._padding[it.RIGHT]===t[it.RIGHT]&&this._padding[it.BOTTOM]===t[it.BOTTOM]&&this._padding[it.LEFT]===t[it.LEFT]||(this._viewport[0]+=t[it.LEFT]-this._padding[it.LEFT],this._viewport[1]+=t[it.BOTTOM]-this._padding[it.BOTTOM],this._viewport[2]-=t[it.RIGHT]+t[it.LEFT]-(this._padding[it.RIGHT]+this._padding[it.LEFT]),this._viewport[3]-=t[it.TOP]+t[it.BOTTOM]-(this._padding[it.TOP]+this._padding[it.BOTTOM]),i(this._padding,t),this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewProjectionMatrix(){return this._viewProjectionDirty&&(v(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){if(this._projectionDirty){const t=this.width,i=this.height,e=this.near*Math.tan(this.fovY/2),r=e*this.aspect;u(this._projectionMatrix,-r*(1+2*this._padding[it.LEFT]/t),r*(1+2*this._padding[it.RIGHT]/t),-e*(1+2*this._padding[it.BOTTOM]/i),e*(1+2*this._padding[it.TOP]/i),this.near,this.far),this._projectionDirty=!1}return this._projectionMatrix}get inverseProjectionMatrix(){return o(this._inverseProjectionMatrix)&&(this._inverseProjectionMatrix=l()),this._inverseProjectionDirty&&c(this._inverseProjectionMatrix,this.projectionMatrix),this._inverseProjectionMatrix}set projectionMatrix(t){p(this._projectionMatrix,t),this._projectionDirty=!1,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fov(){return this._fov}set fov(t){this._fov=t,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return X(this._fov,this.width,this.height)}set fovX(t){this._fov=Y(t,this.width,this.height),this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return q(this._fov,this.width,this.height)}set fovY(t){this._fov=J(t,this.width,this.height),this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return T(this._center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(c(this._viewInverseTransposeMatrix,this.viewMatrix),w(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(t){const i=2*t-1;return 2*this.near*this.far/(this.far+this.near-i*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this._pixelRatio}get aboveGround(){return null!=this.relativeElevation&&this.relativeElevation>=0}copyFrom(t){x(this._ray.origin,t.eye),x(this._center,t.center),x(this._up,t.up),i(this._viewport,t.viewport),i(this._padding,t.padding),y(this._nearFar,t.nearFar),this._fov=t.fov,this.relativeElevation=t.relativeElevation;const e=t;return this._viewDirty=e._viewDirty,this._viewDirty||(p(this._viewMatrix,t.viewMatrix),x(this._viewRight,t.viewRight),x(this._viewUp,t.viewUp),x(this._viewForward,t.viewForward)),e._projectionDirty?this._projectionDirty=!0:(p(this._projectionMatrix,t.projectionMatrix),this._projectionDirty=!1),this._viewProjectionDirty=!0,this._inverseProjectionDirty=!0,this._frustumDirty=e._frustumDirty,this._frustumDirty||(C(this._frustum,t.frustum),this._frustumDirty=!1),e._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(p(this._viewInverseTransposeMatrix,t.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),i(this._fullViewport,t.fullViewport),this._pixelRatio=t.pixelRatio,this}copyViewFrom(t){this.eye=t.eye,this.center=t.center,this.up=t.up}clone(){return(new K).copyFrom(this)}equals(t){return P(this.eye,t.eye)&&P(this._center,t.center)&&P(this._up,t.up)&&e(this._viewport,t.viewport)&&e(this._padding,t.padding)&&g(this._nearFar,t.nearFar)&&this._fov===t.fov&&this._pixelRatio===t.pixelRatio&&this.relativeElevation===t.relativeElevation}almostEquals(t){if(this._pixelRatio!==t.pixelRatio||Math.abs(t.fov-this._fov)>=.001)return!1;const i=5e-4;R(Z,t.eye,t.center),R($,this.eye,this._center);const e=F(Z,$),s=O(Z),h=O($);return e*e>=(1-1e-10)*s*h&&V(t.eye,this.eye)<Math.max(s,h)*i*i&&r(t.padding,this._padding)<.5&&r(t.viewport,this._viewport)<.5}computeRenderPixelSizeAt(t){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(t))}computeRenderPixelSizeAtDist(t){return t*this.perRenderPixelRatio}computeScreenPixelSizeAt(t){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(t))}_viewDirectionDistance(t){return Math.abs(z(this.viewForward,M(Z,t,this.eye)))}computeScreenPixelSizeAtDist(t){return t*this.perScreenPixelRatio}computeDistanceFromRadius(t,i){return t/Math.tan(Math.min(this.fovX,this.fovY)/(2*(i||1)))}getScreenCenter(t=a()){return t[0]=(this.padding[it.LEFT]+this.width/2)/this._pixelRatio,t[1]=(this.padding[it.TOP]+this.height/2)/this._pixelRatio,t}getRenderCenter(t,i=.5,e=.5){return t[0]=this.padding[it.LEFT]+this.width*i,t[1]=this.padding[it.BOTTOM]+this.height*e,t[2]=.5,t}setGLViewport(t){const i=this.viewport,e=this.padding;t.setViewport(i[0]-e[3],i[1]-e[2],i[2]+e[1]+e[3],i[3]+e[0]+e[2])}applyProjection(t,i){t!==N&&x(N,t),N[3]=1,s(N,N,this.projectionMatrix);const e=Math.abs(N[3]);I(N,N,1/e);const r=this.fullViewport;i[0]=h(0,r[0]+r[2],.5+.5*N[0]),i[1]=h(0,r[1]+r[3],.5+.5*N[1]),i[2]=.5*(N[2]+1),i[3]=e}unapplyProjection(t,i){const e=this.fullViewport;N[0]=(t[0]/(e[0]+e[2])*2-1)*t[3],N[1]=(t[1]/(e[1]+e[3])*2-1)*t[3],N[2]=(2*t[2]-1)*t[3],N[3]=t[3],s(N,N,this.inverseProjectionMatrix),i[0]=N[0],i[1]=N[1],i[2]=N[2]}projectToScreen(t,i){return this.projectToRenderScreen(t,tt),this.renderToScreen(tt,i),i}projectToRenderScreen(t,i){if(N[0]=t[0],N[1]=t[1],N[2]=t[2],N[3]=1,s(N,N,this.viewProjectionMatrix),0===N[3])return null;I(N,N,1/Math.abs(N[3]));const e=this.fullViewport;return"x"in i?(i.x=h(0,e[0]+e[2],.5+.5*N[0]),i.y=h(0,e[1]+e[3],.5+.5*N[1])):(i[0]=h(0,e[0]+e[2],.5+.5*N[0]),i[1]=h(0,e[1]+e[3],.5+.5*N[1]),i.length>2&&(i[2]=.5*(N[2]+1))),i}unprojectFromScreen(t,i){return this.unprojectFromRenderScreen(this.screenToRender(t,tt),i)}unprojectFromRenderScreen(t,i){if(v(Q,this.projectionMatrix,this.viewMatrix),!c(Q,Q))return null;const e=this.fullViewport;return N[0]=2*(t[0]-e[0])/e[2]-1,N[1]=2*(t[1]-e[1])/e[3]-1,N[2]=2*t[2]-1,N[3]=1,s(N,N,Q),0===N[3]?null:(i[0]=N[0]/N[3],i[1]=N[1]/N[3],i[2]=N[2]/N[3],i)}constrainWindowSize(t,i,e,r=e){const s=t*this._pixelRatio,h=i*this._pixelRatio,n=Math.max(s-e/2,0),o=Math.max(this.fullHeight-h-r/2,0),a=-Math.min(s-e/2,0),_=-Math.min(this.fullHeight-h-r/2,0);return[n,o,e-a- -Math.min(this.fullWidth-s-e/2,0),r-_- -Math.min(h-r/2,0)]}computeUp(t){t===W.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(t,i){const e=t[0]*this._pixelRatio,r=this.fullHeight-t[1]*this._pixelRatio;return i[0]=e,i[1]=r,i}renderToScreen(t,i){const e=t[0]/this._pixelRatio,r=(this.fullHeight-t[1])/this._pixelRatio;i[0]=e,i[1]=r}_computeUpGlobal(){M(Z,this.center,this.eye);const t=S(this.center);t<1?(E(this._up,0,0,1),this._markViewDirty()):Math.abs(F(Z,this.center))>.9999*S(Z)*t||(b(this._up,Z,this.center),b(this._up,this._up,Z),L(this._up,this._up),this._markViewDirty())}_computeUpLocal(){H(Z,this.eye,this.center),Math.abs(Z[2])<=.9999&&(I(Z,Z,Z[2]),E(this._up,-Z[0],-Z[1],1-Z[2]),L(this._up,this._up),this._markViewDirty())}_compareAndSetView(i,e){"number"==typeof i[0]&&isFinite(i[0])&&"number"==typeof i[1]&&isFinite(i[1])&&"number"==typeof i[2]&&isFinite(i[2])?P(i,e)||(x(e,i),this._markViewDirty()):t.getLogger("esri.views.3d.webgl-engine.lib.Camera").warn("Camera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&(A(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&(d(this._viewMatrix,this.eye,this._center,this._up),E(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),E(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),E(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}}const N=G(),Q=l(),Z=m(),$=m(),tt=_();var it;!function(t){t[t.TOP=0]="TOP",t[t.RIGHT=1]="RIGHT",t[t.BOTTOM=2]="BOTTOM",t[t.LEFT=3]="LEFT"}(it||(it={}));export{K as C,it as P};
