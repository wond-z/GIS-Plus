/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{J as t}from"./jsonMap.js";import{a as e,u as n,i as r}from"./maybe.js";import o from"../layers/support/PixelBlock.js";import{i as s}from"./pixelUtils.js";const a=new Map;a.set("meter-per-second",1),a.set("kilometer-per-hour",.277778),a.set("knots",.514444),a.set("feet-per-second",.3048),a.set("mile-per-hour",.44704);const i=180/Math.PI,h=new t({esriMetersPerSecond:"meter-per-second",esriKilometersPerHour:"kilometer-per-hour",esriKnots:"knots",esriFeetPerSecond:"feet-per-second",esriMilesPerHour:"mile-per-hour"});function l(t,e){return a.get(t)/a.get(e)||1}function c(t){return(450-t)%360}function u(t,e="geographic"){const[n,r]=t,o=Math.sqrt(n*n+r*r);let s=Math.atan2(r,n)*i;return s=(360+s)%360,"geographic"===e&&(s=c(s)),[o,s]}function f(t,e="geographic"){let n=t[1];"geographic"===e&&(n=c(n)),n%=360;const r=t[0];return[r*Math.cos(n/i),r*Math.sin(n/i)]}function p(t,r,o,a="geographic"){if(!s(t)||e(o))return t;const i="vector-magdir"===r?t.clone():n(m(t,r)),h=i.pixels[1];for(let t=0;t<h.length;t++)h[t]="geographic"===a?(h[t]+o[t]+270)%360:(h[t]+360-o[t])%360;return"vector-magdir"===r?i:m(i,"vector-magdir")}function m(t,e,n="geographic",r=1){if(!s(t))return t;const{pixels:a,width:i,height:h}=t,l=i*h,c=a[0],p=a[1],m=t.pixelType.startsWith("f")?t.pixelType:"f32",d=o.createEmptyBand(m,l),g=o.createEmptyBand(m,l);let x=0;for(let t=0;t<h;t++)for(let t=0;t<i;t++)"vector-uv"===e?([d[x],g[x]]=u([c[x],p[x]],n),d[x]*=r):([d[x],g[x]]=f([c[x],p[x]],n),d[x]*=r,g[x]*=r),x++;const M=new o({pixelType:m,width:t.width,height:t.height,mask:t.mask,validPixelCount:t.validPixelCount,maskIsAlpha:t.maskIsAlpha,pixels:[d,g]});return M.updateStatistics(),M}function d(t,e,n=1){if(1===n||!s(t))return t;const r=t.clone(),{pixels:o,width:a,height:i}=r,h=o[0],l=o[1];let c=0;for(let t=0;t<i;t++)for(let t=0;t<a;t++)"vector-uv"===e?(h[c]*=n,l[c]*=n):h[c]*=n,c++;return r.updateStatistics(),r}function g(t,n,r,o,s){if(e(s)||!s.spatialReference.equals(t.spatialReference))return{extent:t,width:Math.round(n/o),height:Math.round(r/o),resolution:t.width/n};const a=s.xmin,i=s.ymax,h=(t.xmax-t.xmin)/n*o,l=(t.ymax-t.ymin)/r*o,c=(h+l)/2;return t.xmin=a+Math.floor((t.xmin-a)/h)*h,t.xmax=a+Math.ceil((t.xmax-a)/h)*h,t.ymin=i+Math.floor((t.ymin-i)/l)*l,t.ymax=i+Math.ceil((t.ymax-i)/l)*l,{extent:t,width:Math.round(t.width/h),height:Math.round(t.height/l),resolution:c}}const x=M(0,0,0);function M(t=0,e=0,n=Math.PI,r=!0){r&&(n=(2*Math.PI-n)%(2*Math.PI));const o=r?-1:1,s=13*o,a=-7*o,i=-2*o,h=-16*o,l=21.75,[c,u]=w(0,e+s,n,l),[f,p]=w(t-5.5,e+a,n,l),[m,d]=w(t+5.5,e+a,n,l),[g,x]=w(t-1.5,e+i,n,l),[M,k]=w(t+1.5,e+i,n,l),[y,b]=w(t-1.5,e+h,n,l),[P,v]=w(t+1.5,e+h,n,l);return[c,u,f,p,g,x,M,k,m,d,y,b,P,v]}function k(t=0,e=Math.PI,n=!0){n&&(e=(2*Math.PI-e)%(2*Math.PI));const r=n?-1:1,o=5*r,s=20*r,a=25*r,i=45,h=2*r,l=n?1:-1,c=5*l;let[u,f]=[0+c,0-s],[p,m]=[u+2*l,f],[d,g]=[p-0*l,m+h],[x,M]=[0-c,0-a],[k,y]=[x+0*l,M-h],b=Math.ceil(t/5),P=Math.floor(b/10);b-=8*P;const v=[],I=[];for(let t=0;t<b/2;t++,P--){P<=0&&b%2==1&&t===(b-1)/2&&(x=0,k=x+0*l,M=(M+f)/2,y=M-h);const[n,r]=w(x,M,e,i);if(P>0){const[t,o]=w(p,M,e,i),[s,a]=w(u,f,e,i);v.push(t),v.push(o),v.push(n),v.push(r),v.push(s),v.push(a)}else{const[t,o]=w(p,m,e,i),[s,a]=w(d,g,e,i),[h,l]=w(k,y,e,i);I.push(n),I.push(r),I.push(h),I.push(l),I.push(s),I.push(a),I.push(t),I.push(o)}M+=o,f+=o,m+=o,g+=o,y+=o}const[A,_]=w(0+c,0+s,e,i),U=7*l,[S,D]=w(0+U,0+s,e,i),[F,j]=w(0+c,0-a,e,i),[J,N]=w(0+U,0-a,e,i);return{pennants:v,barbs:I,shaft:[A,_,S,D,F,j,J,N]}}function w(t,e,n,r=1){const o=Math.sqrt(t*t+e*e)/r,s=(2*Math.PI+Math.atan2(e,t))%(2*Math.PI);return[o,(2*Math.PI+s-n)%(2*Math.PI)]}const y=[0,1,3,6,10,16,21,27,33,40,47,55,63],b=[0,.5,1,1.5,2],P=[0,.25,.5,1,1.5,2,2.5,3,3.5,4];function v(t,e,n,r){const o=l(r||"knots",n);let s;for(s=1;s<e.length;s++)if(s===e.length-1){if(t<e[s]*o)break}else if(t<=e[s]*o)break;return Math.min(s-1,e.length-2)}function I(t,e,n,r,o){let s=0;switch(e){case"beaufort_kn":s=v(t,y,"knots",n);break;case"beaufort_km":s=v(t,y,"kilometer-per-hour",n);break;case"beaufort_ft":s=v(t,y,"feet-per-second",n);break;case"beaufort_m":s=v(t,y,"meter-per-second",n);break;case"classified_arrow":s=v(t,o??[],r,n);break;case"ocean_current_m":s=v(t,b,"meter-per-second",n);break;case"ocean_current_kn":s=v(t,P,"knots",n)}return s}const A=[];function _(t,e){let n=0,r=0;const{width:o,height:s,mask:a}=t,i=t.pixels[0],c=[],u=[],f=l(h.fromJSON(e.inputUnit),"knots"),p="wind_speed"===e.style?5:Number.MAX_VALUE;for(let t=0;t<s;t++)for(let e=0;e<o;e++){const h=i[t*o+e]*f;if((!a||a[t*o+e])&&h<p){for(let r=0;r<4;r++)c[n++]=(e+.5)/o,c[n++]=(t+.5)/s,c[n++]=r<2?-.5:.5,c[n++]=r%2==0?-.5:.5,c[n++]=0,c[n++]=h;const a=4*(n/24-1);u[r++]=a,u[r++]=a+1,u[r++]=a+2,u[r++]=a+1,u[r++]=a+2,u[r++]=a+3}}return{vertexData:new Float32Array(c),indexData:new Uint32Array(u)}}function U(t,e){return"simple_scalar"===e.style?_(t,e):"wind_speed"===e.style?function(t,e){if(0===A.length)for(let t=0;t<30;t++)A.push(k(5*t,0,!e.invertDirection));const n=l(h.fromJSON(e.inputUnit),"knots"),{width:r,height:o,mask:s}=t,a=t.pixels[0],i=t.pixels[1],c=[],u=[];let f=0,p=0;for(let t=0;t<o;t++)for(let e=0;e<r;e++){const h=t*r+e,l=a[h]*n;if((!s||s[t*r+e])&&l>=5){const n=(i[h]+360)%360/180*Math.PI,{pennants:s,barbs:a,shaft:m}=A[Math.min(Math.floor(l/5),29)];if(s.length+a.length===0)continue;let d=c.length/6;const g=(e+.5)/r,x=(t+.5)/o;for(let t=0;t<s.length;t+=2)c[f++]=g,c[f++]=x,c[f++]=s[t],c[f++]=s[t+1]+n,c[f++]=0,c[f++]=l;for(let t=0;t<a.length;t+=2)c[f++]=g,c[f++]=x,c[f++]=a[t],c[f++]=a[t+1]+n,c[f++]=0,c[f++]=l;for(let t=0;t<m.length;t+=2)c[f++]=g,c[f++]=x,c[f++]=m[t],c[f++]=m[t+1]+n,c[f++]=0,c[f++]=l;for(let t=0;t<s.length/6;t++)u[p++]=d,u[p++]=d+1,u[p++]=d+2,d+=3;for(let t=0;t<a.length/8;t++)u[p++]=d,u[p++]=d+1,u[p++]=d+2,u[p++]=d+1,u[p++]=d+2,u[p++]=d+3,d+=4;u[p++]=d+0,u[p++]=d+1,u[p++]=d+2,u[p++]=d+1,u[p++]=d+3,u[p++]=d+2,d+=4}}return{vertexData:new Float32Array(c),indexData:new Uint32Array(u)}}(t,e):function(t,e){const{style:n,inputUnit:o,outputUnit:s,breakValues:a}=e,i=h.fromJSON(o),l=h.fromJSON(s);let c=0,u=0;const{width:f,height:p,mask:m}=t,d=t.pixels[0],g=t.pixels[1],k=r(m)?m.filter((t=>t>0)).length:f*p,w=new Float32Array(42*k),y=new Uint32Array(15*k),b=e.invertDirection?M(0,0,0,!1):x;for(let t=0;t<p;t++)for(let e=0;e<f;e++){const r=t*f+e;if(!m||m[t*f+e]){const o=(g[r]+360)%360/180*Math.PI,s=I(d[r],n,i,l,a);for(let n=0;n<b.length;n+=2)w[c++]=(e+.5)/f,w[c++]=(t+.5)/p,w[c++]=b[n],w[c++]=b[n+1]+o,w[c++]=s,w[c++]=d[r];const h=7*(c/42-1);y[u++]=h,y[u++]=h+1,y[u++]=h+2,y[u++]=h+0,y[u++]=h+4,y[u++]=h+3,y[u++]=h+0,y[u++]=h+2,y[u++]=h+3,y[u++]=h+2,y[u++]=h+5,y[u++]=h+3,y[u++]=h+5,y[u++]=h+6,y[u++]=h+3}}return{vertexData:w,indexData:y}}(t,e)}function S(t,e,n,r=[0,0],s=.5){const{width:a,height:i,mask:h}=t,[l,c]=t.pixels,[p,m]=r,d=Math.round((a-p)/n),g=Math.round((i-m)/n),x=d*g,M=new Float32Array(x),k=new Float32Array(x),w=new Uint8Array(x),y="vector-uv"===e;for(let t=0;t<g;t++)for(let e=0;e<d;e++){let r=0;const o=t*d+e,g=Math.max(0,t*n+m),x=Math.max(0,e*n+p),b=Math.min(i,g+n),P=Math.min(a,x+n);for(let t=g;t<b;t++)for(let e=x;e<P;e++){const n=t*a+e;if(!h||h[n]){r++;const t=y?[l[n],c[n]]:[l[n],(360+c[n])%360],[e,s]=y?t:f(t);M[o]+=e,k[o]+=s}}if(r>=(b-g)*(P-x)*(1-s)){w[o]=1;const[t,e]=u([M[o]/r,k[o]/r]);M[o]=t,k[o]=e}else w[o]=0,M[o]=0,k[o]=0}const b=new o({width:d,height:g,pixels:[M,k],mask:w});return b.updateStatistics(),b}export{h as a,d as b,m as c,p as d,U as e,_ as f,l as g,S as h,g as s,u};
