/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{r}from"./asyncUtils.js";import e from"../core/Error.js";import{i as o}from"./maybe.js";import{eachAlways as s,throwIfAborted as t}from"../core/promiseUtils.js";import{g as c}from"./uuid.js";import{getSiblingOfSameTypeI as a}from"./resourceUtils.js";async function p(r,o,p){if(!o||!o.resources)return;const h=o.portalItem===r.portalItem?new Set(r.paths):new Set;r.paths.length=0,r.portalItem=o.portalItem;const i=new Set(o.resources.toKeep.map((r=>r.resource.path))),m=new Set,f=[];i.forEach((e=>{h.delete(e),r.paths.push(e)}));for(const e of o.resources.toUpdate)if(h.delete(e.resource.path),i.has(e.resource.path)||m.has(e.resource.path)){const{resource:o,content:s,finish:t,error:u}=e,h=a(o,c());r.paths.push(h.path),f.push(n({resource:h,content:s,compress:e.compress,finish:t,error:u},p))}else r.paths.push(e.resource.path),f.push(u(e,p)),m.add(e.resource.path);for(const e of o.resources.toAdd)f.push(n(e,p)),r.paths.push(e.resource.path);if(h.forEach((r=>{const e=o.portalItem.resourceFromPath(r);f.push(e.portalItem.removeResource(e).catch((()=>{})))})),0===f.length)return;const l=await s(f);t(p);const d=l.filter((r=>"error"in r)).map((r=>r.error));if(d.length>0)throw new e("save:resources","Failed to save one or more resources",{errors:d})}async function n(e,s){const t={...o(s)?s:{},compress:e.compress},c=await r(e.resource.portalItem.addResource(e.resource,e.content,t));if(!0!==c.ok)throw e.error&&e.error(c.error),c.error;e.finish&&e.finish(e.resource)}async function u(e,o){const s=await r(e.resource.update(e.content,o));if(!0!==s.ok)throw e.error(s.error),s.error;e.finish(e.resource)}export{p as s};
