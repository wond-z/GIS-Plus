/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{h as t}from"./object.js";import{Z as e}from"./vec4f64.js";import{S as r,R as s}from"./RenderSlot.js";import{C as o}from"./basicInterfaces.js";import{S as a,a as i,o as n,O as l,J as p,p as u,r as c,m as h,C as d,b as f,s as g,c as m,P as y,u as v,w as C,x as _,R as O,D as T,G as A}from"./bufferWriterUtils.js";import{g as P,D as b,M as j,i as D,a as S}from"./Material.js";import{T as w,m as x,e as I,o as E,f as L,a as N,d as F,c as R,g as M,h as V}from"./OrderIndependentTransparency.js";import{D as $,a as W,b as G}from"./DefaultBufferWriter.js";import{T as H,O as z}from"./OutputHighlight.glsl.js";import{V as U}from"./VertexColor.glsl.js";import{V as B}from"./VertexAttribute.js";import{C as q}from"./context-util.js";import{_ as Q}from"./tslib.es6.js";import{p as J}from"./ShaderTechniqueConfiguration.js";const Z=Object.freeze(Object.defineProperty({__proto__:null,build:function(t){const e=new a,{vertex:s,fragment:o}=e,m=t.output===r.Depth,y=t.hasMultipassTerrain&&(t.output===r.Color||t.output===r.Alpha);return i(s,t),e.include(H,t),e.include(U,t),e.include(n,t),e.attributes.add(B.POSITION,"vec3"),e.varyings.add("vpos","vec3"),y&&e.varyings.add("depth","float"),m&&(e.include(l,t),p(e),u(e)),s.code.add(P`
    void main(void) {
      vpos = position;
      forwardNormalizedVertexColor();
      forwardObjectAndLayerIdColor();
      ${y?"depth = (view * vec4(vpos, 1.0)).z;":""}
      gl_Position = ${m?P`transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);`:P`transformPosition(proj, view, vpos);`}
    }
  `),e.include(c,t),y&&e.include(h,t),o.include(d),o.uniforms.add(new f("eColor",(t=>t.color))),t.output===r.Highlight&&e.include(z,t),o.code.add(P`
  void main() {
    discardBySlice(vpos);
    ${y?"terrainDepthTest(gl_FragCoord, depth);":""}
    vec4 fColor = ${t.hasVertexColors?"vColor * eColor;":"eColor;"}

    if (fColor.a < ${P.float(g)}) {
      discard;
    }

    ${t.output===r.Alpha?P`gl_FragColor = vec4(fColor.a);`:""}

    ${t.output===r.Color?P`gl_FragColor = highlightSlice(fColor, vpos); ${t.transparencyPassType===w.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
    ${t.output===r.Highlight?P`outputHighlight();`:""};
    ${t.output===r.Depth?P`outputDepth(linearDepth);`:""};
    ${t.output===r.ObjectAndLayerIdColor?P`outputObjectAndLayerIdColor();`:""}
  }
  `),e}},Symbol.toStringTag,{value:"Module"}));class k extends m{initializeConfiguration(t,e){e.hasWebGL2Context=t.rctx.type===q.WEBGL2}initializeProgram(t){return new y(t.rctx,k.shader.get().build(this.configuration),b)}_createPipeline(t,e){const s=this.configuration,o=t===w.NONE,a=t===w.FrontFace;return x({blending:s.output!==r.Color&&s.output!==r.Alpha||!s.transparent?null:o?I:E(t),culling:L(s.cullFace),depthTest:{func:N(t)},depthWrite:o||a?s.writeDepth&&F:null,colorWrite:R,stencilWrite:s.hasOccludees?v:null,stencilTest:s.hasOccludees?e?C:_:null,polygonOffset:o||a?s.polygonOffset&&K:M(s.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._createPipeline(this.configuration.transparencyPassType,!0),this._createPipeline(this.configuration.transparencyPassType,!1)}getPipelineState(t,e){return e?this._occludeePipelineState:super.getPipelineState(t,e)}}k.shader=new O(Z,(()=>Promise.resolve().then((()=>Z))));const K={factor:1,units:1};class X extends T{constructor(){super(...arguments),this.output=r.Color,this.cullFace=o.None,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.transparencyPassType=w.NONE,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.objectAndLayerIdColorInstanced=!1}}Q([J({count:r.COUNT})],X.prototype,"output",void 0),Q([J({count:o.COUNT})],X.prototype,"cullFace",void 0),Q([J()],X.prototype,"hasSlicePlane",void 0),Q([J()],X.prototype,"hasVertexColors",void 0),Q([J()],X.prototype,"transparent",void 0),Q([J()],X.prototype,"polygonOffset",void 0),Q([J()],X.prototype,"enableOffset",void 0),Q([J()],X.prototype,"writeDepth",void 0),Q([J()],X.prototype,"hasOccludees",void 0),Q([J({count:w.COUNT})],X.prototype,"transparencyPassType",void 0),Q([J()],X.prototype,"hasMultipassTerrain",void 0),Q([J()],X.prototype,"cullAboveGround",void 0),Q([J()],X.prototype,"objectAndLayerIdColorInstanced",void 0);class Y extends j{constructor(t){super(t,new et),this.supportsEdges=!0,this._configuration=new X}getConfiguration(t,e){return this._configuration.output=t,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.transparencyPassType=e.transparencyPassType,this._configuration.enableOffset=e.camera.relativeElevation<V,this._configuration.hasMultipassTerrain=e.multipassTerrain.enabled,this._configuration.cullAboveGround=e.multipassTerrain.cullAboveGround,this._configuration}intersect(t,e,r,s,o,a,i){D(t,e,s,o,a,void 0,i)}requiresSlot(t,e){return!!(e===r.Color||e===r.Alpha||e===r.Highlight||e===r.Depth&&this.parameters.writeLinearDepth||e===r.ObjectAndLayerIdColor)&&(t===s.DRAPED_MATERIAL||(e===r.Highlight?t===s.OPAQUE_MATERIAL:t===(this.parameters.transparent?this.parameters.writeDepth?s.TRANSPARENT_MATERIAL:s.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:s.OPAQUE_MATERIAL)))}createGLMaterial(t){return new tt(t)}createBufferWriter(){return new $(t("enable-feature:objectAndLayerId-rendering")?W:G)}}class tt extends A{_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:t.hasOccludees})}beginSlot(t){return this._output!==r.Color&&this._output!==r.Alpha||this._updateOccludeeState(t),this.ensureTechnique(k,t)}}class et extends S{constructor(){super(...arguments),this.color=e,this.transparent=!1,this.writeDepth=!0,this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=o.None,this.hasOccludees=!1}}export{Y as C};
