/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{u as e}from"../core/lang.js";import{L as l}from"./Logger.js";import{o}from"./ensureType.js";import{i as t}from"./maybe.js";import{f as a,c as n}from"./number.js";import{f as i,r}from"./numberUtils.js";import s from"../renderers/visualVariables/support/ColorStop.js";import{g as u}from"./utils6.js";import f from"../Color.js";import"../symbols.js";import c from"../symbols/SimpleLineSymbol.js";import p from"../renderers/support/HeatmapColorStop.js";const m="<",A=">",d=n("short-date");function g(e,l,o,t){let n="";0===l?n="< ":l===o&&(n="> ");let r=null;return r=t?a(e,d):i(e),n+r}const h=["data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAAAAAAAAAHqZRakAAAANUlEQVQ4jWPMy8v7z0BFwMLAwMAwcdIkqhiWn5fHwEQVk5DAqIGjBo4aOGrgqIEQwEjtKgAATl0Hu6JrzFUAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAAAAAAAAAHqZRakAAAANUlEQVQ4jWPMy8v7z0BFwMLAwMAwaeIkqhiWl5/HwEQVk5DAqIGjBo4aOGrgqIEQwEjtKgAATl0Hu6sKxboAAAAASUVORK5CYII=","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAAAAAAAAAHqZRakAAAANUlEQVQ4jWPMy8v7z0BFwMLAwMAwadJEqhiWl5fPwEQVk5DAqIGjBo4aOGrgqIEQwEjtKgAATl0Hu75+IUcAAAAASUVORK5CYII="];async function y(e){if(!("visualVariables"in e)||!e.visualVariables)return null;const l=e.visualVariables.find((e=>"color"===e.type));if(!l)return null;let o=null,t=null;if(l.stops){if(1===l.stops.length)return l.stops[0].color;o=l.stops[0].value,t=l.stops[l.stops.length-1].value}const a=o+(t-o)/2,{getColor:n}=await import("./visualVariableUtils.js");return n(l,a)}async function b(e,l){const o=e.trailCap,t=e.trailWidth||1,a=l||await y(e)||e.color;return new c({cap:o,color:a,width:t})}const w=new f([64,64,64]);function v(e,l){const o=[],t=e.length-1;return 5===e.length?o.push(0,2,4):o.push(0,t),e.map(((e,a)=>o.includes(a)?g(e,a,t,l):null))}async function V(e,l,o){let t=!1,a=[],n=[];if(e.stops){const l=e.stops;a=l.map((e=>e.value)),t=l.some((e=>!!e.label)),t&&(n=l.map((e=>e.label)))}const i=a[0],r=a[a.length-1];if(null==i&&null==r)return null;const s=t?null:v(a,o),u=await Promise.all(a.map((async(o,a)=>{const i="opacity"===e.type?await async function(e,l,o=w){const t=new f(o),a=(await import("./visualVariableUtils.js")).getOpacity(l,e);return null!=a&&(t.a=a),t}(o,e,l):(await import("./visualVariableUtils.js")).getColor(e,o);return{value:o,color:i,label:t?n[a]:s[a]}})));return u.reverse()}function E(e){let l=!1,o=[],t=[];o=e.map((e=>e.value)),l=e.some((e=>!!e.label)),l&&(t=e.map((e=>e.label)));const a=o[0],n=o[o.length-1];if(null==a&&null==n)return null;const i=l?null:v(o,!1);return o.map(((o,a)=>({value:o,color:I(o,e),label:l?t[a]:i[a]}))).reverse()}function I(e,l){const{startIndex:o,endIndex:t,weight:a}=function(e,l){let o=0,t=l.length-1;return l.some(((l,a)=>e<l.value?(t=a,!0):(o=a,!1))),{startIndex:o,endIndex:t,weight:(e-l[o].value)/(l[t].value-l[o].value)}}(e,l);if(o===t)return l[o].color;const n=f.blendColors(l[o].color,l[t].color,a);return new f(n)}function x(e,l){let o=[];if(e&&"multipart"===e.type)e.colorRamps.reverse().forEach(((t,a)=>{0===a?o.push({value:l.max,color:new f(t.toColor),label:"high"}):o.push({value:null,color:new f(t.toColor),label:""}),a===e.colorRamps.length-1?o.push({value:l.min,color:new f(t.fromColor),label:"low"}):o.push({value:null,color:new f(t.fromColor),label:""})}));else{let t,a;e&&"algorithmic"===e.type?(t=e.fromColor,a=e.toColor):(t=[0,0,0,1],a=[255,255,255,1]),o=[{value:l.max,color:new f(a),label:"high"},{value:l.min,color:new f(t),label:"low"}]}return o}function C(e){if(!e.colorStops)return[];const l=[...e.colorStops].filter((e=>e.color?.a>0));let o=l.length-1;if(l&&l[0]){const e=l[o];e&&1!==e.ratio&&(l.push(new p({ratio:1,color:e.color})),o++)}return l.map(((l,t)=>{let a="";return 0===t?a=e.legendOptions?.minLabel||"low":t===o&&(a=e.legendOptions?.maxLabel||"high"),{color:l.color,label:a,ratio:l.ratio}})).reverse()}const j=l.getLogger("esri.renderers.support.utils"),F={millisecond:0,second:1,minute:2,hour:3,day:4,month:5,year:6},S={millisecond:"long-month-day-year-long-time",second:"long-month-day-year-long-time",minute:"long-month-day-year-short-time",hour:"long-month-day-year-short-time",day:"long-month-day-year",month:"long-month-day-year",year:"year"},B=n("short-date");async function z(e,l,t){o(e,l,(()=>[])).push(...t)}async function U(l){const o=new Map;if(!l)return o;if("visualVariables"in l&&l.visualVariables){const e=l.visualVariables.filter((e=>"color"===e.type));for(const l of e){const e=(await V(l)).map((e=>e.color));await z(o,l.field||l.valueExpression,e)}}if("heatmap"===l.type){const e=C(l).map((e=>e.color));await z(o,l.field||l.valueExpression,e)}else if("pie-chart"===l.type){for(const e of l.attributes)await z(o,e.field||e.valueExpression,[e.color]);await z(o,"default",[l?.othersCategory?.color,u(l.backgroundFillSymbol,null)])}else if("dot-density"===l.type){for(const e of l.attributes)await z(o,e.field||e.valueExpression,[e.color]);await z(o,"default",[l.backgroundColor])}else if("unique-value"===l.type)if("predominance"===l.authoringInfo?.type)for(const e of l.uniqueValueInfos??[])await z(o,e.value.toString(),[u(e.symbol,null)]);else{const e=(l.uniqueValueInfos??[]).map((e=>u(e.symbol,null))),{field:t,field2:a,field3:n,valueExpression:i}=l;(t||i)&&await z(o,t||i,e),a&&await z(o,a,e),n&&await z(o,n,e)}else if("class-breaks"===l.type){const e=l.classBreakInfos.map((e=>u(e.symbol,null))),{field:t,valueExpression:a}=l;await z(o,t??a,e)}else"simple"===l.type&&await z(o,"default",[u(l.symbol,null)]);return"defaultSymbol"in l&&l.defaultSymbol&&await z(o,"default",[u(l.defaultSymbol,null)]),o.forEach(((l,t)=>{const a=e(l.filter(Boolean),((e,l)=>JSON.stringify(e)===JSON.stringify(l)));o.set(t,a)})),o}function k(e){const{values:l,colors:o,labelIndexes:t,isDate:n,dateFormatOptions:r}=e;return l.map(((e,u)=>{let f=null;if(!t||t.includes(u)){let o;o=n?a(e,r):i(e),o&&(f=function(e,l,o){let t="";return 0===l?t="< ":l===o&&(t="> "),t+e}(o,u,l.length-1))}return new s({value:e,color:o[u],label:f})}))}function q(e){let l=e.minValue,o=e.maxValue;const t=e.isFirstBreak?"":"> ",a="percent-of-total"===e.normalizationType?"%":"";return l=null==l?"":i(l),o=null==o?"":i(o),t+l+a+" â€“ "+o+a}function M(e){const l=e.classBreakInfos,o=e.normalizationType;let t=[];if(l&&l.length)if("standard-deviation"!==e.classificationMethod)if(e.round){t.push(l[0].minValue);for(const e of l)t.push(e.maxValue);t=r(t),l.forEach(((e,l)=>{e.label=q({minValue:0===l?t[0]:t[l],maxValue:t[l+1],isFirstBreak:0===l,normalizationType:o})}))}else l.forEach(((e,l)=>{e.label=q({minValue:e.minValue,maxValue:e.maxValue,isFirstBreak:0===l,normalizationType:o})}));else j.warn("setLabelsForClassBreaks","cannot set labels for class breaks generated using 'standard-deviation' method.")}function N(e){const l=e.map((e=>new Date(e))),o=l.length;let t=1/0,a=null;for(let e=0;e<o-1;e++){const n=l[e];let i=1/0,r=null;for(let t=e+1;t<o;t++){const e=l[t],o=(n.getFullYear()!==e.getFullYear()?"year":n.getMonth()!==e.getMonth()&&"month")||n.getDate()!==e.getDate()&&"day"||n.getHours()!==e.getHours()&&"hour"||n.getMinutes()!==e.getMinutes()&&"minute"||n.getSeconds()!==e.getSeconds()&&"second"||"millisecond",a=F[o];a<i&&(i=a,r=o)}i<t&&(t=i,a=r)}return a}function O(e){const{value:l,domain:o,fieldInfo:t,dateFormatInterval:r}=e;let s=String(l);const u=o&&"codedValues"in o&&o.codedValues?o.getName(l):null;return u?s=u:"number"==typeof l&&(s=t&&"date"===t.type?a(l,r&&n(S[r])):i(l)),s}function Q(e,l){return"normalizationField"in e&&e.normalizationField?{type:"normalized-field",field:e.field,normalizationField:e.normalizationField}:"field"in e&&e.field?R(e.field):"valueExpression"in e&&e.valueExpression?{type:"expression",expression:e.valueExpression,title:e.valueExpressionTitle,returnType:l}:null}function R(e){return{type:"field",field:e}}function H(l,o){const a=[];if("class-breaks"===l.type||"heatmap"===l.type)a.push(Q(l,"number"));else if("unique-value"===l.type){const e=l.authoringInfo;if(e&&"relationship"===e.type){if(e.field1&&e.field2){const l=e.field1.field,o=e.field2.field,t=e.field1.normalizationField,n=e.field2.normalizationField;a.push(Q({field:l,normalizationField:t})),a.push(Q({field:o,normalizationField:n}))}}else{const e=l.uniqueValueInfos?.[0];let o=null;if(e&&e.value){const e=typeof l.uniqueValueInfos[0].value;"string"!==e&&"number"!==e||(o=e)}a.push(Q(l,o)),[l.field2,l.field3].forEach((e=>e&&a.push(R(e))))}}else"attributes"in l&&l.attributes?.forEach((e=>a.push(Q(e,"number"))));const n=o?o(l):"visualVariables"in l?l.visualVariables:null;return n&&n.forEach((e=>a.push(Q(e,"number")))),e(a.filter(t),((e,l)=>"field"===e.type&&"field"===l.type?e.field===l.field:"normalized-field"===e.type&&"normalized-field"===l.type?e.field===l.field&&e.normalizationField===l.normalizationField:"expression"===e.type&&"expression"===l.type&&e.expression===l.expression))}export{h as R,m as S,O as a,N as b,k as c,U as d,b as e,g as f,H as g,A as h,I as i,E as j,C as k,x as l,y as m,V as n,M as s,B as t};
