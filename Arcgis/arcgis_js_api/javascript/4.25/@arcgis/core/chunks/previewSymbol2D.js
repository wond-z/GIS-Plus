/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import t from"../Color.js";import s from"../core/Error.js";import{l as o}from"./fontUtils.js";import{a as e,p as r}from"./screenUtils.js";import{i,e as l,m}from"./utils6.js";import{S as a,s as p,v as n,h as c}from"../symbols/support/symbolUtils.js";import{getColorLuminance as y}from"../views/support/colorUtils.js";import"./colorUtils.js";import"./mathUtils.js";import"./vec3.js";import"./common.js";import"./maybe.js";import"./ensureType.js";import"./object.js";import"../core/lang.js";import"./Logger.js";import"../config.js";import"./string.js";import"../symbols.js";import"../core/accessorSupport/decorators/subclass.js";import"./metadata.js";import"./utils.js";import"./handleUtils.js";import"./tracking.js";import"../symbols/CIMSymbol.js";import"./tslib.es6.js";import"../core/accessorSupport/decorators/property.js";import"./get.js";import"./enumeration.js";import"./jsonMap.js";import"./reader.js";import"./writer.js";import"../layers/support/fieldUtils.js";import"./arcadeOnDemand.js";import"../geometry.js";import"../geometry/Extent.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"./ArrayPool.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"../core/promiseUtils.js";import"../geometry/SpatialReference.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./Ellipsoid.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"../geometry/support/jsonUtils.js";import"../symbols/Symbol.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils2.js";import"../symbols/edges/Edges3D.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils3.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"./aaBoundingBox.js";import"./aaBoundingRect.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"../core/urlUtils.js";import"./persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../portal/Portal.js";import"../kernel.js";import"../request.js";import"../core/Loadable.js";import"../core/Promise.js";import"./locale.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../core/Clonable.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./asyncUtils.js";import"./jsonUtils.js";import"./parser.js";import"./mat4f32.js";import"./mat4.js";import"./_commonjsHelpers.js";import"./assets.js";import"./ItemCache.js";import"./MemCache.js";import"../symbols/support/cimSymbolUtils.js";import"./utils7.js";import"./colorUtils2.js";import"./projector.js";import"./widgetUtils.js";import"./mat2df32.js";import"./mat2d.js";import"./jsxFactory.js";import"./jsxWidgetSupport.js";const j=a.size,u=a.maxSize,h=a.maxOutlineSize,b=a.lineWidth,d=document.createElement("canvas");function f(t,s){const o=d.getContext("2d"),e=[];return s&&(s.weight&&e.push(s.weight),s.size&&e.push(s.size+"px"),s.family&&e.push(s.family)),o.font=e.join(" "),o.measureText(t).width}function g(t){const s=t?.size;return{width:null!=s&&"object"==typeof s&&"width"in s?e(s.width):null,height:null!=s&&"object"==typeof s&&"height"in s?e(s.height):null}}function S(t,s){return t>s?"dark":"light"}function w(t,s){const o="number"==typeof s?.size?s?.size:null,m=null!=o?e(o):null,a=null!=s?.maxSize?e(s.maxSize):null,n=null!=s?.rotation?s.rotation:"angle"in t?t.angle:null,c=i(t);let y=l(t);"dark"!==L(t,245)||s?.ignoreWhiteSymbols||(y={width:.75,...y,color:"#bdc3c7"});const d={shape:null,fill:c,stroke:y,offset:[0,0]};y?.width&&(y.width=Math.min(y.width,h));const S=y?.width||0;let w=null!=s?.size&&(null==s?.scale||s?.scale),v=0,M=0,k=!1;switch(t.type){case"simple-marker":{const o=t.style,{width:r,height:i}=g(s),l=r===i&&null!=r?r:null!=m?m:Math.min(e(t.size),a||u);switch(v=l,M=l,o){case"circle":d.shape={type:"circle",cx:0,cy:0,r:.5*l},w||(v+=S,M+=S);break;case"cross":d.shape={type:"path",path:[{command:"M",values:[0,.5*M]},{command:"L",values:[v,.5*M]},{command:"M",values:[.5*v,0]},{command:"L",values:[.5*v,M]}]};break;case"diamond":d.shape={type:"path",path:[{command:"M",values:[0,.5*M]},{command:"L",values:[.5*v,0]},{command:"L",values:[v,.5*M]},{command:"L",values:[.5*v,M]},{command:"Z",values:[]}]},w||(v+=S,M+=S);break;case"square":d.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[v,0]},{command:"L",values:[v,M]},{command:"L",values:[0,M]},{command:"Z",values:[]}]},w||(v+=S,M+=S),n&&(k=!0);break;case"triangle":d.shape={type:"path",path:[{command:"M",values:[.5*v,0]},{command:"L",values:[v,M]},{command:"L",values:[0,M]},{command:"Z",values:[]}]},w||(v+=S,M+=S),n&&(k=!0);break;case"x":d.shape={type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[v,M]},{command:"M",values:[v,0]},{command:"L",values:[0,M]}]},n&&(k=!0);break;case"path":d.shape={type:"path",path:t.path||""},w||(v+=S,M+=S),n&&(k=!0),w=!0}break}case"simple-line":{const{width:t,height:o}=g(s),e=null!=o?o:null!=m?m:S,r=null!=t?t:b;y&&(y.width=e),v=r,M=e;const i=d?.stroke?.cap||"butt",l="round"===i;w=!0,d.stroke&&(d.stroke.cap="butt"===i?"square":i),d.shape={type:"path",path:[{command:"M",values:[l?e/2:0,M/2]},{command:"L",values:[l?v-e/2:v,M/2]}]};break}case"picture-fill":case"simple-fill":{const t="object"==typeof s?.symbolConfig&&s?.symbolConfig.isSquareFill,{width:o,height:e}=g(s);v=!t&&o!==e||null==o?null!=m?m:j:o,M=!t&&o!==e||null==e?v:e,w||(v+=S,M+=S),w=!0,d.shape=t?{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[v,0]},{command:"L",values:[v,M]},{command:"L",values:[0,M]},{command:"L",values:[0,0]},{command:"Z",values:[]}]}:p.fill[0];break}case"picture-marker":{const o=Math.min(e(t.width),a||u),r=Math.min(e(t.height),a||u),{width:i,height:l}=g(s),p=i===l&&null!=i?i:null!=m?m:Math.max(o,r),c=o/r;v=c<=1?Math.ceil(p*c):p,M=c<=1?p:Math.ceil(p/c),d.shape={type:"image",x:-Math.round(v/2),y:-Math.round(M/2),width:v,height:M,src:t.url||""},n&&(k=!0);break}case"text":{const o=t,i=s?.overrideText||o.text||"Aa",l=o.font,{width:p,height:n}=g(s),c=null!=n?n:null!=m?m:Math.min(e(l.size),a||u),y=f(i,{weight:l.weight,size:c,family:l.family}),j=/[\uE600-\uE6FF]/.test(i);v=p??(j?c:y),M=c;let h=.25*function(t){if(0===t.length)return 0;if(t.length>2){const s=r(1),o=parseFloat(t);switch(t.slice(-2)){case"px":return o;case"pt":return o*s;case"in":return 72*o*s;case"pc":return 12*o*s;case"mm":return 2.8346456692913384*o*s;case"cm":return 28.346456692913385*o*s}}return parseFloat(t)}((l?c:0).toString());j&&(h+=5),d.shape={type:"text",text:i,x:o.xoffset||0,y:o.yoffset||h,align:"middle",alignBaseline:o.verticalAlignment,decoration:l&&l.decoration,rotated:o.rotated,kerning:o.kerning},d.font=l&&{size:c,style:l.style,decoration:l.decoration,weight:l.weight,family:l.family};break}}return{shapeDescriptor:d,size:[v,M],renderOptions:{node:s?.node,scale:w,opacity:s?.opacity,rotation:n,useRotationSize:k,effectView:s?.effectView}}}async function v(t,e){const{shapeDescriptor:r,size:i,renderOptions:l}=w(t,e);if(!r.shape)throw new s("symbolPreview: renderPreviewHTML2D","symbol not supported.");await async function(t,s){const o=s.fill,e=t.color;if("pattern"===o?.type&&e&&"picture-fill"!==t.type){const t=await m(o.src,e.toCss(!0));o.src=t,s.fill=o}}(t,r),await async function(t,s,e,r){if(!("font"in t)||!t.font||"text"!==s.shape.type)return;try{await o(t.font)}catch{}const{width:i}=g(r),l=/[\uE600-\uE6FF]/.test(s.shape.text);null!=i||l||(e[0]=f(s.shape.text,{weight:s.font.weight,size:s.font.size,family:s.font.family}))}(t,r,i,e);const a=[[r]];if("object"==typeof e?.symbolConfig&&e?.symbolConfig.applyColorModulation){const t=.6*i[0];a.unshift([{...r,offset:[-t,0],fill:n(r.fill,-.3)}]),a.push([{...r,offset:[t,0],fill:n(r.fill,.3)}]),i[0]+=2*t,l.scale=!1}return c(a,i,l)}function L(s,o=225){const e=i(s),r=l(s),m=!e||"type"in e?null:new t(e),a=r?.color?new t(r?.color):null,p=m?S(y(m),o):null,n=a?S(y(a),o):null;return n?p?p===n?p:o>=225?"light":"dark":n:p}export{L as getContrastingBackgroundTheme,w as getRenderSymbolParameters,v as previewSymbol2D};
