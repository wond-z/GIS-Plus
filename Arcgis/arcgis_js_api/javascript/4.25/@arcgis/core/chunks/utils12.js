/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{throwIfAborted as e}from"../core/promiseUtils.js";import"./object.js";import n from"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import t from"../layers/support/Field.js";import{noDominantCategoryField as o}from"../smartMapping/statistics/support/predominanceUtils.js";import{i as a,a as i,c as l}from"./utils11.js";import{g as r,b as s}from"./utils13.js";const u=/_value$/i,c=Math.LOG10E;function f(e){return e.map((e=>e.toJSON()))}function m(e,n){const t=[],o="featureReduction"in e.layer&&e.layer.featureReduction;if("binning"!==o?.type||!n)return t;const a="fields"in o?o.fields?.map((e=>e.name?.toLowerCase())).filter(Boolean):null;for(const e of n)a.includes(e.toLowerCase())||t.push(e);return t}function d(e,n,t){const o=[];if(n)for(const a of n){const n=e.getField(a);"availableFields"in t&&!t.availableFields.includes(n.name)&&o.push(n.name)}return o}function p(e,n){const t=e&&e.features,o=t&&t[0]&&t[0].attributes,a={};for(const e in o)a[e.replace(u,"").toLowerCase()]=o[e];return null!=a.totalcount&&a.totalcount>=a.count&&(a.nullcount=a.totalcount-a.count),delete a.totalcount,a.min===a.max&&null!=a.min&&null==a.stddev&&(a.stddev=a.variance=0),n&&(["min","max","avg","stddev","sum","variance"].forEach((e=>{null!=a[e]&&(a[e]=Math.ceil(a[e]))})),a.min===a.max&&null!=a.min&&(a.avg=a.min,a.stddev=a.variance=0)),a}function g(e){const n=[],t=e.classBreaks,o=t[0].minValue,a=t[t.length-1].maxValue;t.forEach((e=>{n.push([e.minValue,e.maxValue])}));const i={field:e.field,normalizationType:e.normalizationType,normalizationField:e.normalizationField,normalizationTotal:e.normalizationTotal,layer:e.layer};return{min:o,max:a,intervals:n,sqlExpr:y(i),excludeZerosExpr:e.where,normTotal:e.normalizationTotal}}function y(e){const{field:n,normalizationType:t,normalizationField:o,normalizationTotal:i,layer:r}=e,s=a(r,n);let u=n;return"percent-of-total"===t?u=`((${s?l(n):n} / ${i}) * 100)`:"log"===t?u=`(log(${n}) * ${c})`:"field"===t?u=`(${s?l(n):n} / ${o})`:"natural-log"===t?u=`(log(${s?l(n):n}))`:"square-root"===t&&(u=`(power(${s?l(n):n}, 0.5))`),u}function v(e,n){let t;if(n=n.toLowerCase(),e)for(const o in e)if(o.toLowerCase()!==n){t=e[o];break}return t}function h(e,n){let t;if(n=n.toLowerCase(),e)for(const o in e)if(o.toLowerCase()===n){t=e[o];break}return t}function w(e,n,t,o,a){const i={},l="countOFExpr";e&&e.features&&e.features.forEach((e=>{const n=e.attributes,t=v(n,l),o=h(n,l);0!==t&&(i[t]=o)}));const s=[];return r(n,t,o).forEach(((e,n)=>{const t=(n+1).toString();s.push({minValue:e[0],maxValue:e[1],count:i.hasOwnProperty(t)?i[t]:0})})),{bins:s,minValue:n,maxValue:t,normalizationTotal:a}}function x(n,t){const o=n&&n.features,{field:a,field2:i,field3:l,fieldDelimiter:r,layer:u,view:c,signal:f,labels:m}=t,d=`countOF${a&&i?"Expr":a||"Expr"}`,p={};let g=!1;if(o.forEach((e=>{const n=e.attributes,t=h(n,d);let o=a?h(n,a):v(n,d),u=i?h(n,i):null,c=l?h(n,l):null;null===o&&0===t&&(g=!0),(null==o||"string"==typeof o&&""===o.trim())&&(o=null),i&&(null==u||"string"==typeof u&&""===u.trim())&&(u=null),l&&(null==c||"string"==typeof c&&""===c.trim())&&(c=null);let f=o;i&&(f=`${s(f)}${r}${s(u)}`,l&&(f=`${f}${r}${s(c)}`)),null==p[f]?p[f]={count:t,data:f}:p[f].count=p[f].count+t})),a&&g){const n=a+" is NULL";return u.queryFeatureCount({whereClause:n,view:c,signal:f}).then((e=>(e=e||0,p.null.count=p.null.count+e,F(p,m)))).catch((()=>(e(f),F(p,m))))}return Promise.resolve(F(p,m))}function F(e,n){if(n)for(const t in e)e[t].label=n[t];return{count:e}}async function b(e,t,o){const a=e?o.getField(e):null,i=a?o.getFieldDomain(a.name):null;if(i)return i;const{uniqueValueInfos:l}=await o.uniqueValues({field:e,sqlWhere:t.sqlWhere,features:t.features,useFeaturesInView:t.useFeaturesInView,view:t.view,signal:t.signal}),r=l.map((e=>({code:e.value})));return new n({codedValues:r})}async function E(e,n){if(!e.returnAllCodedValues)return[];const{field:t,field2:o,field3:a}=e;if(t&&!o){const e=t?n.getField(t):null,o=e?n.getFieldDomain(e.name):null;return o?[o]:[]}const i=[];return t&&(i.push(b(t,e,n)),o&&(i.push(b(o,e,n)),a&&i.push(b(a,e,n)))),Promise.all(i)}function $(e,n){return i(e,new Date(0),n,"milliseconds").sqlExpression}function V(e){return{viewingMode:"2d"===e.type?"map":e.viewingMode,scale:e.scale,spatialReference:e.spatialReference?.toJSON()}}function j(e,n){const t=e.map((e=>e.value)),a=n.filter((e=>!t.includes(e)));for(const n of a)e.push({value:n,count:0});e.sort(((e,t)=>n.indexOf(e.value)-n.indexOf(t.value)));for(const n of e)n.value===o&&(n.value=null);return{predominantCategoryInfos:e}}function C(e){const n="featureReduction"in e&&e.featureReduction;return("fields"in n&&n.fields||[]).map((n=>{const o=function(e,n){switch(e.statisticType){case"avg":case"avg_angle":return"double";case"count":return"integer";case"min":case"max":case"sum":return e.onStatisticField?n.get(e.onStatisticField)?.type??null:e.onStatisticExpression?"string"===e.onStatisticExpression.returnType?null:"double":null;case"mode":return e.onStatisticField?n.get(e.onStatisticField)?.type??null:e.onStatisticExpression?"string"===e.onStatisticExpression.returnType?"string":"double":null;default:return null}}(n,e.fieldsIndex);return o?new t({type:o,name:n.name,alias:n.alias}):null})).filter(Boolean)}export{p as a,V as b,d as c,x as d,f as e,w as f,y as g,g as h,E as i,j,m as k,C as l,$ as m};
