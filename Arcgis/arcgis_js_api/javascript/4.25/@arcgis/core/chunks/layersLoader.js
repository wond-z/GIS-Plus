/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import t from"../layers/Layer.js";import{b as r}from"./arcgisLayerUrl.js";import a from"../portal/Portal.js";import n from"../portal/PortalItem.js";import{c as o}from"./jsonContext.js";import{h as l}from"./portalItemUtils.js";import{l as s}from"./styleUtils.js";import i from"../request.js";async function p(e){const{data:t}=await i(e,{responseType:"json",query:{f:"json"}});return t}function u(a,o,l){let s=l.layers||[];const i=l.tables||[];if("Feature Collection"===a.portalItem.type&&(s.forEach((e=>{"Table"===e?.layerDefinition?.type&&i.push(e)})),s=s.filter((e=>"Table"!==e?.layerDefinition?.type))),"coverage"in l){const o=function(a){const{coverage:o}=a;if(!o)return null;const l=new URL(o);if(o.toLowerCase().includes("item.html")){const e=l.searchParams.get("id"),r=l.origin;return t.fromPortalItem({portalItem:new n({id:e,url:r})})}if(r(o))return t.fromArcGISServerUrl({url:o});throw new e("portal:oriented-imagery-layer-coverage","the provided coverage url couldn't be loaded as a layer")}(l);a.add(o)}s.reverse().forEach((e=>{const t=y(a,o(e),l,e);a.add(t)})),i.reverse().forEach((e=>{const t=y(a,o(e),l,e);a.tables.add(t)}))}function y(e,t,r,n){const o=new t({portalItem:e.portalItem.clone(),layerId:n.id});if("subtype-group"!==o.type&&(o.sublayerTitleMode="service-name"),"Feature Collection"===e.portalItem.type){const t={origin:"portal-item",portal:e.portalItem.portal||a.getDefault()};o.read(n,t);const l=r.showLegend;null!=l&&o.read({showLegend:l},t)}return o}function c(e,t){if(!1===e.supportsData)return Promise.resolve(void 0);const r=e.instance;return r.portalItem.fetchData("json",t).catch((()=>null)).then((e=>{if(function(e){return"stream"!==e.type&&"oriented-imagery"!==e.type&&"layerId"in e}(r)){let t,a=!0;if(e&&f(e)>0){if(null==r.layerId){const t=b(e);r.layerId="subtype-group"===r.type?t?.[0]:m(e)}t=function(e,t){const{layerId:r}=t,a=e.layers?.find((e=>e.id===r))||e.tables?.find((e=>e.id===r));return a&&function(e,t){return!("feature"===t.type&&"layerType"in e&&"SubtypeGroupLayer"===e.layerType||"subtype-group"===t.type&&!("layerType"in e))}(a,t)?a:null}(e,r),t&&(1===f(e)&&(a=!1),null!=e.showLegend&&(t.showLegend=e.showLegend))}return a&&"service-name"!==r.sublayerTitleMode&&(r.sublayerTitleMode="item-title-and-service-name"),t}return e}))}async function d(e,t){if(null==e?.layers||null==e?.tables){const r=await p(t);(e=e||{}).layers=e.layers||r?.layers,e.tables=e.tables||r?.tables}return e}function m(e){const t=e.layers;if(t&&t.length)return t[0].id;const r=e.tables;return r&&r.length?r[0].id:null}function f(e){return(e?.layers?.length??0)+(e?.tables?.length??0)}function b(e){const t=[];return e?.layers?.forEach((e=>{"SubtypeGroupLayer"===e.layerType&&t.push(e.id)})),t}const g=Object.freeze(Object.defineProperty({__proto__:null,load:async function(t,r){const a=t.instance.portalItem;if(a&&a.id)return await a.load(r),function(t){const r=t.instance.portalItem;if(!t.supportedTypes.includes(r.type))throw new e("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:r.type,expectedType:t.supportedTypes.join(", ")})}(t),async function(t,r){const a=t.instance,n=a.portalItem,{url:i,title:y}=n,m=o(n);if("group"===a.type)return a.read({title:y},m),function(t,r){let a;const n=t.portalItem.type,o=r.layerModuleTypeMap,s=l(t.portalItem,"Oriented Imagery Layer")??!1;switch(n){case"Feature Service":a=s?o.OrientedImageryLayer:o.FeatureLayer;break;case"Stream Service":a=o.StreamLayer;break;case"Scene Service":a=o.SceneLayer;break;case"Feature Collection":a=o.FeatureLayer;break;default:throw new e("portal:unsupported-item-type-as-group",`The item type '${n}' is not supported as a 'IGroupLayer'`)}let i;return a().then((e=>(i=e,c(r)))).then((async e=>{let r=()=>i;if("Feature Service"===n){if(b(e=await d(e,t.portalItem.url)).length){const e=o.SubtypeGroupLayer,t=await e();r=e=>"SubtypeGroupLayer"===e.layerType?t:i}return u(t,r,e)}return f(e)>0?u(t,r,e):function(e,t){return e.portalItem.url?p(e.portalItem.url).then((r=>{function a(e){return{id:e.id,name:e.name}}r&&u(e,t,{layers:r.layers?.map(a),tables:r.tables?.map(a)})})):Promise.resolve()}(t,r)}))}(a,t);i&&a.read({url:i},m);const g=await c(t,r);return g&&a.read(g,m),a.resourceReferences={portalItem:n,paths:m.readResourcePaths},"subtype-group"!==a.type&&a.read({title:y},m),s(a,m)}(t,r)},preprocessFSItemData:d,getFirstLayerOrTableId:m,getNumLayersAndTables:f,getSubtypeGroupLayerIds:b},Symbol.toStringTag,{value:"Module"}));export{b as a,m as b,f as g,g as l,d as p,p as r};
