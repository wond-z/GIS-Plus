/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{p as e,P as t,y as r,ah as s,F as i,t as o,A as n,E as a,W as l,o as p,s as m,n as u,q as c,l as f,w as d,D as y,ai as j,aj as g,a1 as b,ak as h}from"./arcadeUtils.js";import{g as I,l as w,F,c as S,a as D,b as E,d as x,O as L,e as A,T as v,f as C,h as P,i as T,j as N,S as R,k as U,m as M,A as O,n as $}from"./featureSetUtils.js";import{I as k}from"./ImmutableArray.js";import{E as V,i as B}from"./SpatialFilter.js";import{isPromiseLike as z}from"../core/promiseUtils.js";import{WhereClause as H}from"../core/sql/WhereClause.js";import G from"../layers/FeatureLayer.js";import q from"../layers/support/Field.js";import"../geometry.js";import"./ensureType.js";import"./object.js";import"../core/lang.js";import"./maybe.js";import"./Logger.js";import"../config.js";import"./string.js";import"../geometry/Extent.js";import"./tslib.es6.js";import"../core/accessorSupport/decorators/property.js";import"./get.js";import"./utils.js";import"./handleUtils.js";import"./metadata.js";import"../core/Error.js";import"../core/accessorSupport/decorators/subclass.js";import"./tracking.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"./ArrayPool.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"./reader.js";import"../geometry/SpatialReference.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./Ellipsoid.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"./jsonMap.js";import"../geometry/support/jsonUtils.js";import"./datetime.js";import"./number3.js";import"./locale.js";import"./featureConversionUtils.js";import"./OptimizedFeature.js";import"./OptimizedFeatureSet.js";import"../kernel.js";import"../core/urlUtils.js";import"./unitUtils.js";import"./projectionEllipsoid.js";import"./hash.js";import"../request.js";import"../portal/Portal.js";import"../core/Loadable.js";import"../core/Promise.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"./sizeVariableUtils.js";import"../Graphic.js";import"../PopupTemplate.js";import"../core/Clonable.js";import"../core/Collection.js";import"../core/Evented.js";import"./shared.js";import"./SimpleObservable.js";import"../layers/support/fieldUtils.js";import"./arcadeOnDemand.js";import"../popup/content.js";import"../popup/content/AttachmentsContent.js";import"../popup/content/Content.js";import"../popup/content/CustomContent.js";import"../popup/content/ExpressionContent.js";import"../popup/ElementExpressionInfo.js";import"../popup/content/FieldsContent.js";import"../popup/FieldInfo.js";import"./enumeration.js";import"../popup/support/FieldInfoFormat.js";import"./date.js";import"./number.js";import"../popup/content/MediaContent.js";import"../popup/content/BarChartMediaInfo.js";import"../popup/content/mixins/ChartMediaInfo.js";import"../popup/content/mixins/MediaInfo.js";import"../popup/content/support/ChartMediaInfoValue.js";import"../popup/content/support/ChartMediaInfoValueSeries.js";import"./chartMediaInfoUtils.js";import"../popup/content/ColumnChartMediaInfo.js";import"../popup/content/ImageMediaInfo.js";import"../popup/content/support/ImageMediaInfoValue.js";import"../popup/content/LineChartMediaInfo.js";import"../popup/content/PieChartMediaInfo.js";import"../popup/content/RelationshipContent.js";import"../popup/support/RelatedRecordsInfoFieldOrder.js";import"../popup/content/TextContent.js";import"../popup/ExpressionInfo.js";import"../popup/LayerOptions.js";import"../popup/RelatedRecordsInfo.js";import"../support/actions/ActionBase.js";import"../core/Identifiable.js";import"../support/actions/ActionButton.js";import"../support/actions/ActionToggle.js";import"../symbols.js";import"../symbols/CIMSymbol.js";import"../symbols/Symbol.js";import"../Color.js";import"./colorUtils.js";import"./mathUtils.js";import"./vec3.js";import"./common.js";import"../symbols/ExtrudeSymbol3DLayer.js";import"../symbols/Symbol3DLayer.js";import"./utils2.js";import"../symbols/edges/Edges3D.js";import"./screenUtils.js";import"./materialUtils.js";import"./opacityUtils.js";import"../symbols/edges/SketchEdges3D.js";import"../symbols/edges/SolidEdges3D.js";import"./Symbol3DMaterial.js";import"../symbols/FillSymbol.js";import"../symbols/SimpleLineSymbol.js";import"../symbols/LineSymbol.js";import"../symbols/LineSymbolMarker.js";import"./lineMarkers.js";import"../symbols/FillSymbol3DLayer.js";import"../symbols/patterns/LineStylePattern3D.js";import"../symbols/patterns/StylePattern3D.js";import"./utils3.js";import"./colors.js";import"./symbolLayerUtils3D.js";import"./aaBoundingBox.js";import"./aaBoundingRect.js";import"../symbols/Font.js";import"../symbols/IconSymbol3DLayer.js";import"./persistableUrlUtils.js";import"../symbols/LabelSymbol3D.js";import"../symbols/Symbol3D.js";import"./collectionUtils.js";import"../symbols/LineSymbol3DLayer.js";import"../symbols/LineStyleMarker3D.js";import"../symbols/ObjectSymbol3DLayer.js";import"../symbols/PathSymbol3DLayer.js";import"../symbols/TextSymbol3DLayer.js";import"../symbols/WaterSymbol3DLayer.js";import"../symbols/support/StyleOrigin.js";import"./Thumbnail.js";import"./calloutUtils.js";import"../symbols/callouts/Callout3D.js";import"../symbols/callouts/LineCallout3D.js";import"../symbols/support/Symbol3DVerticalOffset.js";import"../symbols/LineSymbol3D.js";import"../symbols/MarkerSymbol.js";import"../symbols/MeshSymbol3D.js";import"../symbols/PictureFillSymbol.js";import"./urlUtils.js";import"../symbols/PictureMarkerSymbol.js";import"../symbols/PointSymbol3D.js";import"../symbols/PolygonSymbol3D.js";import"../symbols/SimpleFillSymbol.js";import"../symbols/SimpleMarkerSymbol.js";import"../symbols/TextSymbol.js";import"../symbols/WebStyleSymbol.js";import"./clusterUtils.js";import"../layers/support/AggregateField.js";import"../layers/support/ExpressionInfo.js";import"../renderers/support/AuthoringInfo.js";import"../renderers/support/AuthoringInfoVisualVariable.js";import"./colorRamps.js";import"../rest/support/AlgorithmicColorRamp.js";import"../rest/support/ColorRamp.js";import"../rest/support/MultipartColorRamp.js";import"../renderers/visualVariables/SizeVariable.js";import"../renderers/visualVariables/VisualVariable.js";import"./LegendOptions.js";import"../renderers/visualVariables/support/SizeStop.js";import"./visualVariableUtils.js";import"./compilerUtils.js";import"./lengthUtils.js";import"../layers/support/FieldsIndex.js";import"./DataLayerSource.js";import"./executeQueryJSON.js";import"./utils4.js";import"./query.js";import"../geometry/support/normalizeUtils.js";import"./normalizeUtilsCommon.js";import"./simplify.js";import"./utils5.js";import"./pbfQueryUtils.js";import"./pbf.js";import"./queryZScale.js";import"./zscale.js";import"../rest/support/FeatureSet.js";import"./domains.js";import"../layers/support/CodedValueDomain.js";import"../layers/support/Domain.js";import"../layers/support/InheritedDomain.js";import"../layers/support/RangeDomain.js";import"./fieldType.js";import"../rest/support/Query.js";import"../TimeExtent.js";import"./timeUtils.js";import"./FullTextSearch.js";import"../rest/support/StatisticDefinition.js";import"../rest/query/support/AttachmentInfo.js";import"../rest/support/AttachmentQuery.js";import"./executeForIds.js";import"../rest/support/RelationshipQuery.js";import"../rest/support/TopFeaturesQuery.js";import"../rest/support/TopFilter.js";import"../layers/support/FeatureType.js";import"../layers/support/FeatureTemplate.js";import"../portal/PortalItem.js";import"./assets.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../geometry/geometryEngineAsync.js";import"../core/workers/workers.js";import"../core/workers/Connection.js";import"./Queue.js";import"../core/workers/RemoteClient.js";import"../intl.js";import"./messages.js";import"./_commonjsHelpers.js";import"../renderers/ClassBreaksRenderer.js";import"../renderers/Renderer.js";import"../renderers/mixins/VisualVariablesMixin.js";import"../renderers/visualVariables/ColorVariable.js";import"../renderers/visualVariables/support/ColorStop.js";import"../renderers/visualVariables/OpacityVariable.js";import"../renderers/visualVariables/support/OpacityStop.js";import"../renderers/visualVariables/RotationVariable.js";import"../renderers/support/ClassBreakInfo.js";import"./commonProperties2.js";import"../symbols/support/jsonUtils.js";import"./symbolConversion.js";import"../renderers/DictionaryRenderer.js";import"./DictionaryLoader.js";import"./LRUCache.js";import"./MemCache.js";import"../renderers/DotDensityRenderer.js";import"../renderers/support/AttributeColorInfo.js";import"../renderers/HeatmapRenderer.js";import"../renderers/support/HeatmapColorStop.js";import"./heatmapUtils.js";import"./vec4f64.js";import"../renderers/PieChartRenderer.js";import"../renderers/SimpleRenderer.js";import"../renderers/UniqueValueRenderer.js";import"../core/reactiveUtils.js";import"./diffUtils.js";import"../renderers/support/UniqueValue.js";import"../renderers/support/UniqueValueClass.js";import"../renderers/support/UniqueValueGroup.js";import"../renderers/support/UniqueValueInfo.js";import"./styleUtils2.js";import"../renderers/support/jsonUtils.js";import"./MultiOriginJSONSupport.js";import"../core/sql.js";import"../form/FormTemplate.js";import"../form/ExpressionInfo.js";import"../form/elements/GroupElement.js";import"../form/elements/Element.js";import"../form/support/elements.js";import"../form/elements/FieldElement.js";import"../form/elements/support/inputs.js";import"../form/elements/inputs/BarcodeScannerInput.js";import"../form/elements/inputs/TextInput.js";import"../form/elements/inputs/Input.js";import"../form/elements/inputs/ComboBoxInput.js";import"../form/elements/inputs/DateTimePickerInput.js";import"../form/elements/inputs/RadioButtonsInput.js";import"../form/elements/inputs/SwitchInput.js";import"../form/elements/inputs/TextAreaInput.js";import"../form/elements/inputs/TextBoxInput.js";import"../layers/Layer.js";import"../core/HandleOwner.js";import"./WatchUpdatingTracking.js";import"./editsZScale.js";import"../layers/mixins/APIKeyMixin.js";import"./ArcGISService.js";import"./arcgisLayerUrl.js";import"../layers/mixins/BlendLayer.js";import"./jsonUtils.js";import"./parser.js";import"./mat4f32.js";import"./mat4.js";import"../layers/mixins/CustomParametersMixin.js";import"./EditBusLayer.js";import"../layers/mixins/FeatureEffectLayer.js";import"../layers/support/FeatureEffect.js";import"../layers/support/FeatureFilter.js";import"../layers/mixins/FeatureLayerBase.js";import"../geometry/HeightModelInfo.js";import"./commonProperties.js";import"../support/timeUtils.js";import"./ElevationInfo.js";import"./unitConversionUtils.js";import"../layers/support/GeometryFieldsInfo.js";import"../layers/support/LayerFloorInfo.js";import"../layers/support/Relationship.js";import"../layers/mixins/FeatureReductionLayer.js";import"./FeatureReduction.js";import"../layers/support/FeatureReductionBinning.js";import"../layers/support/LabelClass.js";import"./labelUtils.js";import"./defaults.js";import"./defaultsJSON.js";import"../layers/support/FeatureReductionCluster.js";import"../layers/support/FeatureReductionSelection.js";import"./OperationalLayer.js";import"../layers/mixins/OrderedLayer.js";import"../layers/mixins/PortalLayer.js";import"./asyncUtils.js";import"../layers/mixins/PublishableLayer.js";import"../layers/support/PublishingInfo.js";import"../layers/mixins/RefreshableLayer.js";import"../layers/mixins/ScaleRangeLayer.js";import"../layers/mixins/TemporalLayer.js";import"../TimeInterval.js";import"../layers/support/TimeInfo.js";import"../layers/support/TimeReference.js";import"./fieldProperties.js";import"./labelingInfo.js";import"./versionUtils.js";import"./styleUtils.js";import"../support/popupUtils.js";async function W(e,t,r){const s=e.getVariables();if(s.length>0){const i=[];for(let e=0;e<s.length;e++){const o={name:s[e]};i.push(await t.evaluateIdentifier(r,o))}const o={};for(let e=0;e<s.length;e++)o[s[e]]=i[e];return e.parameters=o,e}return e}function J(e,t,r=null){for(const r in e)if(r.toLowerCase()===t.toLowerCase())return e[r];return r}function _(e){if(null===e)return null;const t={type:J(e,"type",""),name:J(e,"name","")};if("range"===t.type)t.range=J(e,"range",[]);else{t.codedValues=[];for(const r of J(e,"codedValues",[]))t.codedValues.push({name:J(r,"name",""),code:J(r,"code",null)})}return t}function Q(e){if(null===e)return null;const t={},r=J(e,"wkt",null);null!==r&&(t.wkt=r);const s=J(e,"wkid",null);return null!==s&&(t.wkid=s),t}function K(e){if(null===e)return null;const t={hasZ:J(e,"hasz",!1),hasM:J(e,"hasm",!1)},r=J(e,"spatialreference",null);r&&(t.spatialReference=Q(r));const s=J(e,"x",null);if(null!==s)return t.x=s,t.y=J(e,"y",null),t;const i=J(e,"rings",null);if(null!==i)return t.rings=i,t;const o=J(e,"paths",null);if(null!==o)return t.paths=o,t;const n=J(e,"points",null);if(null!==n)return t.points=n,t;for(const r of["xmin","xmax","ymin","ymax","zmin","zmax","mmin","mmax"]){const s=J(e,r,null);null!==s&&(t[r]=s)}return t}function Z(Z){"async"===Z.mode&&(Z.functions.getuser=function(l,p){return Z.standardFunctionAsync(l,p,(async(m,u,c)=>{e(c,0,2,l,p);let f=t(c[1],""),d=!0===f;if(f=!0===f||!1===f?"":r(f),0===c.length||c[0]instanceof s){let e=null;l.services&&l.services.portal&&(e=l.services.portal),c.length>0&&(e=I(c[0],e));const t=await w(e,f,d);if(t){const e=JSON.parse(JSON.stringify(t));for(const t of["lastLogin","created","modified"])void 0!==e[t]&&null!==e[t]&&(e[t]=new Date(e[t]));return i.convertObjectToArcadeDictionary(e)}return null}let y=null;if(o(c[0])&&(y=c[0]),y){if(d=!1,f)return null;await y.load();const e=await y.getOwningSystemUrl();if(!e){if(!f){const e=await y.getIdentityUser();return e?i.convertObjectToArcadeDictionary({username:e}):null}return null}let t=null;l.services&&l.services.portal&&(t=l.services.portal),t=I(new s(e),t);const r=await w(t,f,d);if(r){const e=JSON.parse(JSON.stringify(r));for(const t of["lastLogin","created","modified"])void 0!==e[t]&&null!==e[t]&&(e[t]=new Date(e[t]));return i.convertObjectToArcadeDictionary(e)}return null}throw new n(l,a.InvalidParameter,p)}))},Z.signatures.push({name:"getuser",min:1,max:2}),Z.functions.featuresetbyid=function(s,i){return Z.standardFunctionAsync(s,i,((o,m,u)=>{if(e(u,2,4,s,i),u[0]instanceof F){const e=r(u[1]);let o=t(u[2],null);const m=l(t(u[3],!0));if(null===o&&(o=["*"]),!1===p(o))throw new n(s,a.InvalidParameter,i);return u[0].featureSetById(e,m,o)}throw new n(s,a.InvalidParameter,i)}))},Z.signatures.push({name:"featuresetbyid",min:2,max:4}),Z.functions.getfeatureset=function(s,i){return Z.standardFunctionAsync(s,i,((o,l,p)=>{if(e(p,1,2,s,i),m(p[0])){let e=t(p[1],"datasource");return null===e&&(e="datasource"),e=r(e).toLowerCase(),S(p[0].fullSchema(),e,s.lrucache,s.interceptor,s.spatialReference)}throw new n(s,a.InvalidParameter,i)}))},Z.signatures.push({name:"getfeatureset",min:1,max:2}),Z.functions.featuresetbyportalitem=function(i,o){return Z.standardFunctionAsync(i,o,((m,c,f)=>{if(e(f,2,5,i,o),null===f[0])throw new n(i,a.PortalRequired,o);if(f[0]instanceof s){const e=r(f[1]),s=r(f[2]);let m=t(f[3],null);const u=l(t(f[4],!0));if(null===m&&(m=["*"]),!1===p(m))throw new n(i,a.InvalidParameter,o);let c=null;return i.services&&i.services.portal&&(c=i.services.portal),c=I(f[0],c),D(e,s,i.spatialReference,m,u,c,i.lrucache,i.interceptor)}if(!1===u(f[0]))throw new n(i,a.PortalRequired,o);const d=r(f[0]),y=r(f[1]);let j=t(f[2],null);const g=l(t(f[3],!0));if(null===j&&(j=["*"]),!1===p(j))throw new n(i,a.InvalidParameter,o);if(i.services&&i.services.portal)return D(d,y,i.spatialReference,j,g,i.services.portal,i.lrucache,i.interceptor);throw new n(i,a.PortalRequired,o)}))},Z.signatures.push({name:"featuresetbyportalitem",min:2,max:5}),Z.functions.featuresetbyname=function(s,i){return Z.standardFunctionAsync(s,i,((o,m,u)=>{if(e(u,2,4,s,i),u[0]instanceof F){const e=r(u[1]);let o=t(u[2],null);const m=l(t(u[3],!0));if(null===o&&(o=["*"]),!1===p(o))throw new n(s,a.InvalidParameter,i);return u[0].featureSetByName(e,m,o)}throw new n(s,a.InvalidParameter,i)}))},Z.signatures.push({name:"featuresetbyname",min:2,max:4}),Z.functions.featureset=function(t,r){return Z.standardFunction(t,r,((s,o,l)=>{e(l,1,1,t,r);let m=l[0];const c={layerDefinition:{geometryType:"",objectIdField:"",globalIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(u(m))m=JSON.parse(m),void 0!==m.layerDefinition?(c.layerDefinition=m.layerDefinition,c.featureSet=m.featureSet,m.layerDefinition.spatialReference&&(c.layerDefinition.spatialReference=m.layerDefinition.spatialReference)):(c.featureSet.features=m.features,c.featureSet.geometryType=m.geometryType,c.layerDefinition.geometryType=c.featureSet.geometryType,c.layerDefinition.objectIdField=m.objectIdFieldName,c.layerDefinition.typeIdField=m.typeIdFieldName,c.layerDefinition.globalIdField=m.globalIdFieldName,c.layerDefinition.fields=m.fields,m.spatialReference&&(c.layerDefinition.spatialReference=m.spatialReference));else{if(!(l[0]instanceof i))throw new n(t,a.InvalidParameter,r);{m=JSON.parse(l[0].castToText(!0));const e=J(m,"layerdefinition");if(null!==e){c.layerDefinition.geometryType=J(e,"geometrytype",""),c.featureSet.geometryType=c.layerDefinition.geometryType,c.layerDefinition.globalIdField=J(e,"globalidfield",""),c.layerDefinition.objectIdField=J(e,"objectidfield",""),c.layerDefinition.typeIdField=J(e,"typeidfield","");const t=J(e,"spatialreference",null);t&&(c.layerDefinition.spatialReference=Q(t));for(const t of J(e,"fields",[])){const e={name:J(t,"name",""),alias:J(t,"alias",""),type:J(t,"type",""),nullable:J(t,"nullable",!0),editable:J(t,"editable",!0),length:J(t,"length",null),domain:_(J(t,"domain"))};c.layerDefinition.fields.push(e)}const r=J(m,"featureset",null);if(r){const e={};for(const t of c.layerDefinition.fields)e[t.name.toLowerCase()]=t.name;for(const t of J(r,"features",[])){const r={},s=J(t,"attributes",{});for(const t in s)r[e[t.toLowerCase()]]=s[t];c.featureSet.features.push({attributes:r,geometry:K(J(t,"geometry",null))})}}}else{c.layerDefinition.geometryType=J(m,"geometrytype",""),c.featureSet.geometryType=c.layerDefinition.geometryType,c.layerDefinition.objectIdField=J(m,"objectidfieldname",""),c.layerDefinition.typeIdField=J(m,"typeidfieldname","");const e=J(m,"spatialreference",null);e&&(c.layerDefinition.spatialReference=Q(e));for(const e of J(m,"fields",[])){const t={name:J(e,"name",""),alias:J(e,"alias",""),type:J(e,"type",""),nullable:J(e,"nullable",!0),editable:J(e,"editable",!0),length:J(e,"length",null),domain:_(J(e,"domain"))};c.layerDefinition.fields.push(t)}const t={};for(const e of c.layerDefinition.fields)t[e.name.toLowerCase()]=e.name;for(const e of J(m,"features",[])){const r={},s=J(e,"attributes",{});for(const e in s)r[t[e.toLowerCase()]]=s[e];c.featureSet.features.push({attributes:r,geometry:K(J(e,"geometry",null))})}}}}if(0==(!!(f=c).layerDefinition&&!!f.featureSet&&!1!==function(e,t){for(const t of["","esriGeometryPoint","esriGeometryPolyline","esriGeometryPolygon","esriGeometryMultipoint","esriGeometryEnvelope"])if(t===e)return!0;return!1}(f.layerDefinition.geometryType)&&null!==f.layerDefinition.objectIdField&&""!==f.layerDefinition.objectIdField&&!1!==p(f.layerDefinition.fields)&&!1!==p(f.featureSet.features)))throw new n(t,a.InvalidParameter,r);var f;return E.create(c,t.spatialReference)}))},Z.signatures.push({name:"featureset",min:1,max:1}),Z.functions.filter=function(t,r){return Z.standardFunctionAsync(t,r,(async(s,i,l)=>{if(e(l,2,2,t,r),p(l[0])||c(l[0])){const e=[];let s=l[0];s instanceof k&&(s=s.toArray());let i=null;if(!f(l[1]))throw new n(t,a.InvalidParameter,r);i=l[1].createFunction(t);for(const t of s){const r=i(t);z(r)?!0===await r&&e.push(t):!0===r&&e.push(t)}return e}if(o(l[0])){const e=await l[0].load(),r=H.create(l[1],e.getFieldsIndex()),s=r.getVariables();if(s.length>0){const e=[];for(let r=0;r<s.length;r++){const i={name:s[r]};e.push(await Z.evaluateIdentifier(t,i))}const i={};for(let t=0;t<s.length;t++)i[s[t]]=e[t];return r.parameters=i,new x({parentfeatureset:l[0],whereclause:r})}return new x({parentfeatureset:l[0],whereclause:r})}throw new n(t,a.InvalidParameter,r)}))},Z.signatures.push({name:"filter",min:2,max:2}),Z.functions.orderby=function(t,r){return Z.standardFunctionAsync(t,r,(async(s,i,l)=>{if(e(l,2,2,t,r),o(l[0])){const e=new L(l[1]);return new A({parentfeatureset:l[0],orderbyclause:e})}throw new n(t,a.InvalidParameter,r)}))},Z.signatures.push({name:"orderby",min:2,max:2}),Z.functions.top=function(t,r){return Z.standardFunctionAsync(t,r,(async(s,i,l)=>{if(e(l,2,2,t,r),o(l[0]))return new v({parentfeatureset:l[0],topnum:l[1]});if(p(l[0]))return d(l[1])>=l[0].length?l[0].slice(0):l[0].slice(0,d(l[1]));if(c(l[0]))return d(l[1])>=l[0].length()?l[0].slice(0):l[0].slice(0,d(l[1]));throw new n(t,a.InvalidParameter,r)}))},Z.signatures.push({name:"top",min:2,max:2}),Z.functions.first=function(t,r){return Z.standardFunctionAsync(t,r,(async(s,i,n)=>{if(e(n,1,1,t,r),o(n[0])){const e=await n[0].first(s.abortSignal);if(null!==e){const t=y.createFromGraphicLikeObject(e.geometry,e.attributes,n[0]);return t._underlyingGraphic=e,t}return e}return p(n[0])?0===n[0].length?null:n[0][0]:c(n[0])?0===n[0].length()?null:n[0].get(0):null}))},Z.signatures.push({name:"first",min:1,max:1}),Z.functions.attachments=function(t,r){return Z.standardFunctionAsync(t,r,(async(s,p,u)=>{e(u,1,2,t,r);const c={minsize:-1,maxsize:-1,types:null,returnMetadata:!1};if(u.length>1)if(u[1]instanceof i){if(u[1].hasField("minsize")&&(c.minsize=d(u[1].field("minsize"))),u[1].hasField("metadata")&&(c.returnMetadata=l(u[1].field("metadata"))),u[1].hasField("maxsize")&&(c.maxsize=d(u[1].field("maxsize"))),u[1].hasField("types")){const e=j(u[1].field("types"),!1);e.length>0&&(c.types=e)}}else if(null!==u[1])throw new n(t,a.InvalidParameter,r);if(m(u[0])){let e=u[0]._layer;return e instanceof G&&(e=C(e,t.spatialReference,["*"],!0,t.lrucache,t.interceptor)),null===e||!1===o(e)?[]:(await e.load(),e.queryAttachments(u[0].field(e.objectIdField),c.minsize,c.maxsize,c.types,c.returnMetadata))}if(null===u[0])return[];throw new n(t,a.InvalidParameter,r)}))},Z.signatures.push({name:"attachments",min:1,max:2}),Z.functions.featuresetbyrelationshipname=function(s,i){return Z.standardFunctionAsync(s,i,(async(u,c,f)=>{e(f,2,4,s,i);const d=f[0],y=r(f[1]);let j=t(f[2],null);const g=l(t(f[3],!0));if(null===j&&(j=["*"]),!1===p(j))throw new n(s,a.InvalidParameter,i);if(null===f[0])return null;if(!m(f[0]))throw new n(s,a.InvalidParameter,i);let b=d._layer;if(b instanceof G&&(b=C(b,s.spatialReference,["*"],!0,s.lrucache,s.interceptor)),null===b)return null;if(!1===o(b))return null;b=await b.load();const h=b.relationshipMetaData().filter((e=>e.name===y));if(0===h.length)return null;if(void 0!==h[0].relationshipTableId&&null!==h[0].relationshipTableId&&h[0].relationshipTableId>-1)return P(b,h[0],d.field(b.objectIdField),b.spatialReference,j,g,s.lrucache,s.interceptor);let I=b.serviceUrl();if(!I)return null;I="/"===I.charAt(I.length-1)?I+h[0].relatedTableId.toString():I+"/"+h[0].relatedTableId.toString();const w=await T(I,b.spatialReference,j,g,s.lrucache,s.interceptor);await w.load();let F=w.relationshipMetaData();if(F=F.filter((e=>e.id===h[0].id)),!1===d.hasField(h[0].keyField)||null===d.field(h[0].keyField)){const e=await b.getFeatureByObjectId(d.field(b.objectIdField),[h[0].keyField]);if(e){const t=H.create(F[0].keyField+"= @id",w.getFieldsIndex());return t.parameters={id:e.attributes[h[0].keyField]},w.filter(t)}return new V({parentfeatureset:w})}const S=H.create(F[0].keyField+"= @id",w.getFieldsIndex());return S.parameters={id:d.field(h[0].keyField)},w.filter(S)}))},Z.signatures.push({name:"featuresetbyrelationshipname",min:2,max:4}),Z.functions.featuresetbyassociation=function(s,i){return Z.standardFunctionAsync(s,i,(async(l,p,c)=>{e(c,2,3,s,i);const f=c[0],d=r(t(c[1],"")).toLowerCase(),y=u(c[2])?r(c[2]):null;if(null===c[0])return null;if(!m(c[0]))throw new n(s,a.InvalidParameter,i);let j=f._layer;if(j instanceof G&&(j=C(j,s.spatialReference,["*"],!0,s.lrucache,s.interceptor)),null===j)return null;if(!1===o(j))return null;await j.load();const h=j.serviceUrl(),I=await N(h,s.spatialReference);let w=null,F=null,S=!1;if(null!==y&&""!==y&&void 0!==y){for(const e of I.terminals)e.terminalName===y&&(F=e.terminalId);null===F&&(S=!0)}const D=I.associations.getFieldsIndex(),E=D.get("TOGLOBALID").name,x=D.get("FROMGLOBALID").name,L=D.get("TOTERMINALID").name,A=D.get("FROMTERMINALID").name,v=D.get("FROMNETWORKSOURCEID").name,P=D.get("TONETWORKSOURCEID").name,T=D.get("ASSOCIATIONTYPE").name,k=D.get("ISCONTENTVISIBLE").name,V=D.get("OBJECTID").name;for(const e of j.fields)if("global-id"===e.type){w=f.field(e.name);break}let B=null,z=new R(new q({name:"percentalong",alias:"percentalong",type:"double"}),H.create("0",I.associations.getFieldsIndex())),W=new R(new q({name:"side",alias:"side",type:"string"}),H.create("''",I.associations.getFieldsIndex()));const J="globalid",_="globalId",Q={};for(const e in I.lkp)Q[e]=I.lkp[e].sourceId;const K=new U(new q({name:"classname",alias:"classname",type:"string"}),null,Q);let Z="";switch(d){case"midspan":{Z=`((${E}='${w}') OR ( ${x}='${w}')) AND (${T} IN (5))`,K.codefield=H.create(`CASE WHEN (${E}='${w}') THEN ${v} ELSE ${P} END`,I.associations.getFieldsIndex());const e=b(O.findField(I.associations.fields,x));e.name=J,e.alias=J,B=new R(e,H.create(`CASE WHEN (${x}='${w}') THEN ${E} ELSE ${x} END`,I.associations.getFieldsIndex())),z=I.unVersion>=4?new $(O.findField(I.associations.fields,D.get("PERCENTALONG").name)):new R(new q({name:"percentalong",alias:"percentalong",type:"double"}),H.create("0",I.associations.getFieldsIndex()));break}case"junctionedge":{Z=`((${E}='${w}') OR ( ${x}='${w}')) AND (${T} IN (4,6))`,K.codefield=H.create(`CASE WHEN (${E}='${w}') THEN ${v} ELSE ${P} END`,I.associations.getFieldsIndex());const e=b(O.findField(I.associations.fields,x));e.name=J,e.alias=J,B=new R(e,H.create(`CASE WHEN (${x}='${w}') THEN ${E} ELSE ${x} END`,I.associations.getFieldsIndex())),W=new R(new q({name:"side",alias:"side",type:"string"}),H.create(`CASE WHEN (${T}=4) THEN 'from' ELSE 'to' END`,I.associations.getFieldsIndex()));break}case"connected":{let e=`${E}='@T'`,t=`${x}='@T'`;null!==F&&(e+=` AND ${L}=@A`,t+=` AND ${A}=@A`),Z="(("+e+") OR ("+t+"))",Z=g(Z,"@T",w??""),e=g(e,"@T",w??""),null!==F&&(e=g(e,"@A",F.toString()),Z=g(Z,"@A",F.toString())),K.codefield=H.create("CASE WHEN "+e+` THEN ${v} ELSE ${P} END`,I.associations.getFieldsIndex());const r=b(O.findField(I.associations.fields,x));r.name=J,r.alias=J,B=new R(r,H.create("CASE WHEN "+e+` THEN ${x} ELSE ${E} END`,I.associations.getFieldsIndex()));break}case"container":Z=`${E}='${w}' AND ${T} = 2`,null!==F&&(Z+=` AND ${L} = `+F.toString()),K.codefield=v,Z="( "+Z+" )",B=new M(O.findField(I.associations.fields,x),J,J);case"content":Z=`(${x}='${w}' AND ${T} = 2)`,null!==F&&(Z+=` AND ${A} = `+F.toString()),K.codefield=P,Z="( "+Z+" )",B=new M(O.findField(I.associations.fields,E),J,J);break;case"structure":Z=`(${E}='${w}' AND ${T} = 3)`,null!==F&&(Z+=` AND ${L} = `+F.toString()),K.codefield=v,Z="( "+Z+" )",B=new M(O.findField(I.associations.fields,x),J,_);break;case"attached":Z=`(${x}='${w}' AND ${T} = 3)`,null!==F&&(Z+=` AND ${A} = `+F.toString()),K.codefield=P,Z="( "+Z+" )",B=new M(O.findField(I.associations.fields,E),J,_);break;default:throw new n(s,a.InvalidParameter,i)}return S&&(Z="1 <> 1"),new O({parentfeatureset:I.associations,adaptedFields:[new $(O.findField(I.associations.fields,V)),new $(O.findField(I.associations.fields,k)),B,W,K,z],extraFilter:Z?H.create(Z,I.associations.getFieldsIndex()):null})}))},Z.signatures.push({name:"featuresetbyassociation",min:2,max:6}),Z.functions.groupby=function(t,s){return Z.standardFunctionAsync(t,s,(async(l,m,f)=>{if(e(f,3,3,t,s),!o(f[0]))throw new n(t,a.InvalidParameter,s);const d=await f[0].load(),y=[],j=[];let g=!1,b=[];if(u(f[1]))b.push(f[1]);else if(f[1]instanceof i)b.push(f[1]);else if(p(f[1]))b=f[1];else{if(!c(f[1]))throw new n(t,a.InvalidParameter,s);b=f[1].toArray()}for(const e of b)if(u(e)){const t=H.create(r(e),d.getFieldsIndex()),s=!0===B(t)?r(e):"%%%%FIELDNAME";y.push({name:s,expression:t}),"%%%%FIELDNAME"===s&&(g=!0)}else{if(!(e instanceof i))throw new n(t,a.InvalidParameter,s);{const r=e.hasField("name")?e.field("name"):"%%%%FIELDNAME",i=e.hasField("expression")?e.field("expression"):"";if("%%%%FIELDNAME"===r&&(g=!0),!r)throw new n(t,a.InvalidParameter,s);y.push({name:r,expression:H.create(i||r,d.getFieldsIndex())})}}if(b=[],u(f[2]))b.push(f[2]);else if(p(f[2]))b=f[2];else if(c(f[2]))b=f[2].toArray();else{if(!(f[2]instanceof i))throw new n(t,a.InvalidParameter,s);b.push(f[2])}for(const e of b){if(!(e instanceof i))throw new n(t,a.InvalidParameter,s);{const r=e.hasField("name")?e.field("name"):"",i=e.hasField("statistic")?e.field("statistic"):"",o=e.hasField("expression")?e.field("expression"):"";if(!r||!i||!o)throw new n(t,a.InvalidParameter,s);j.push({name:r,statistic:i.toLowerCase(),expression:H.create(o,d.getFieldsIndex())})}}if(g){const e={};for(const t of d.fields)e[t.name.toLowerCase()]=1;for(const t of y)"%%%%FIELDNAME"!==t.name&&(e[t.name.toLowerCase()]=1);for(const t of j)"%%%%FIELDNAME"!==t.name&&(e[t.name.toLowerCase()]=1);let t=0;for(const r of y)if("%%%%FIELDNAME"===r.name){for(;1===e["field_"+t.toString()];)t++;e["field_"+t.toString()]=1,r.name="FIELD_"+t.toString()}}for(const e of y)await W(e.expression,Z,t);for(const e of j)await W(e.expression,Z,t);return f[0].groupby(y,j)}))},Z.signatures.push({name:"groupby",min:3,max:3}),Z.functions.distinct=function(t,s){return Z.standardFunctionAsync(t,s,(async(l,m,f)=>{if(o(f[0])){e(f,2,2,t,s);const o=await f[0].load(),l=[];let m=[];if(u(f[1]))m.push(f[1]);else if(f[1]instanceof i)m.push(f[1]);else if(p(f[1]))m=f[1];else{if(!c(f[1]))throw new n(t,a.InvalidParameter,s);m=f[1].toArray()}let d=!1;for(const e of m)if(u(e)){const t=H.create(r(e),o.getFieldsIndex()),s=!0===B(t)?r(e):"%%%%FIELDNAME";l.push({name:s,expression:t}),"%%%%FIELDNAME"===s&&(d=!0)}else{if(!(e instanceof i))throw new n(t,a.InvalidParameter,s);{const r=e.hasField("name")?e.field("name"):"%%%%FIELDNAME",i=e.hasField("expression")?e.field("expression"):"";if("%%%%FIELDNAME"===r&&(d=!0),!r)throw new n(t,a.InvalidParameter,s);l.push({name:r,expression:H.create(i||r,o.getFieldsIndex())})}}if(d){const e={};for(const t of o.fields)e[t.name.toLowerCase()]=1;for(const t of l)"%%%%FIELDNAME"!==t.name&&(e[t.name.toLowerCase()]=1);let t=0;for(const r of l)if("%%%%FIELDNAME"===r.name){for(;1===e["field_"+t.toString()];)t++;e["field_"+t.toString()]=1,r.name="FIELD_"+t.toString()}}for(const e of l)await W(e.expression,Z,t);return f[0].groupby(l,[])}return function(e,t,r,s){if(1===s.length){if(p(s[0]))return h(e,s[0],-1);if(c(s[0]))return h(e,s[0].toArray(),-1)}return h(e,s,-1)}("distinct",0,0,f)}))})}export{Z as registerFunctions};
