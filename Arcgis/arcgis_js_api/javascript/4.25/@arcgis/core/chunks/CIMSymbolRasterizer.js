/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import t from"../Color.js";import e from"../request.js";import{c as i}from"./maybe.js";import{throwIfAborted as r}from"../core/promiseUtils.js";import{a as s}from"./screenUtils.js";import{T as a,O as o,C as n,a as c,b as m,c as l,d as h}from"./cimAnalyzer.js";import{C as p,R as g}from"./Rasterizer.js";import{m as u,y as f,z as d,A as y}from"./utils7.js";import{scaleCIMMarker as j}from"../symbols/support/cimSymbolUtils.js";import{S as w}from"../symbols/IconSymbol3DLayer.js";import"./colorUtils.js";import"./mathUtils.js";import"./vec3.js";import"./common.js";import"./ensureType.js";import"./object.js";import"../core/lang.js";import"./Logger.js";import"../config.js";import"./string.js";import"../kernel.js";import"../core/urlUtils.js";import"../core/Error.js";import"./fontUtils.js";import"./arcadeOnDemand.js";import"../geometry.js";import"../geometry/Extent.js";import"./tslib.es6.js";import"../core/accessorSupport/decorators/property.js";import"./get.js";import"./utils.js";import"./handleUtils.js";import"./metadata.js";import"../core/accessorSupport/decorators/subclass.js";import"./tracking.js";import"../geometry/Geometry.js";import"../core/JSONSupport.js";import"../core/Accessor.js";import"../core/Handles.js";import"./ArrayPool.js";import"./watch.js";import"../core/scheduling.js";import"./nextTick.js";import"./reader.js";import"../geometry/SpatialReference.js";import"./writer.js";import"../geometry/Point.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry/support/webMercatorUtils.js";import"./Ellipsoid.js";import"../geometry/Multipoint.js";import"./zmUtils.js";import"../geometry/Polygon.js";import"./extentUtils.js";import"../geometry/Polyline.js";import"./typeUtils.js";import"./jsonMap.js";import"../geometry/support/jsonUtils.js";import"./shapingUtils.js";import"./BidiEngine.js";import"./mat2d.js";import"./mat2df32.js";import"./vec2.js";import"./vec2f32.js";import"./alignmentUtils.js";import"./number2.js";import"./Rect.js";import"./aaBoundingRect.js";import"./enums.js";import"./definitions.js";import"./callExpressionWithFeature.js";import"./quantizationUtils.js";import"./GeometryUtils.js";import"./floatRGBA.js";import"./_commonjsHelpers.js";import"./imageutils2.js";import"./rasterizingUtils.js";import"./enumeration.js";import"../symbols/Symbol3DLayer.js";import"./colors.js";import"./persistableUrlUtils.js";import"./materialUtils.js";import"./opacityUtils.js";import"./Symbol3DMaterial.js";var C;!function(t){t.Legend="legend",t.Preview="preview"}(C||(C={}));const _=t=>t&&t.scaleFactor?t.scaleFactor:1;class M{constructor(t,e){this._spatialReference=t,this._avoidSDF=e,this._resourceCache=new Map,this._imageDataCanvas=null,this._pictureMarkerCache=new Map,this._textRasterizer=new a,this._cimResourceManager=new p,this._rasterizer=new g(this._cimResourceManager)}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(t,e,i,r,s,a,m,l){if(!t)return null;const{data:p}=t;if(!p||"CIMSymbolReference"!==p.type||!p.symbol)return null;const{symbol:g}=p;a||(a=u(g));const f=await o.resolveSymbolOverrides(p,e,this._spatialReference,s,a,m,l);this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const d=this._imageDataCanvas,y=this._cimResourceManager,j=[];n.fetchResources(f,y,j),j.length>0&&await Promise.all(j);const{width:w,height:C}=i,_=function(t,e,i,r){const s=-e/2+1,a=e/2-1,o=i/2-1,n=-i/2+1;switch(t){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[s,0],[0,0],[a,0]]]};default:return"legend"===r?{rings:[[[s,o],[a,0],[a,n],[s,n],[s,o]]]}:{rings:[[[s,o],[a,o],[a,n],[s,n],[s,o]]]}}}(a,w,C,r),M=n.getEnvelope(f,_,y);if(!M)return null;const b=1.3333333333333333*(window.devicePixelRatio||1);let v=1,z=0,x=0;switch(g.type){case"CIMPointSymbol":case"CIMTextSymbol":{let t=1;M.width>w&&(t=w/M.width);let e=1;M.height>C&&(e=C/M.height),"preview"===r&&(M.width<w&&(t=w/M.width),M.height<C&&(e=C/M.height)),v=Math.min(t,e),z=M.x+M.width/2,x=M.y+M.height/2}break;case"CIMLineSymbol":{let t=1;M.height>C&&(t=C/M.height),v=t,x=M.y+M.height/2;const e=M.x*v+w/2,i=(M.x+M.width)*v+w/2;if(e<0){const{paths:t}=_;t[0][0][0]-=e}if(i>w){const{paths:t}=_;t[0][2][0]-=i-w}}break;case"CIMPolygonSymbol":{z=M.x+M.width/2,x=M.y+M.height/2;const t=M.x*v+w/2,e=(M.x+M.width)*v+w/2,i=M.y*v+C/2,r=(M.y+M.height)*v+C/2,{rings:s}=_;t<0&&(s[0][0][0]-=t,s[0][3][0]-=t,s[0][4][0]-=t),i<0&&(s[0][0][1]+=i,s[0][1][1]+=i,s[0][4][1]+=i),e>w&&(s[0][1][0]-=e-w,s[0][2][0]-=e-w),r>C&&(s[0][2][1]+=r-C,s[0][3][1]+=r-C)}}d.width=w*b,d.height=C*b,d.width+=2,d.height+=2;const R=d.getContext("2d"),I=h.createIdentity();return I.translate(-z,-x),I.scale(v*b,-v*b),I.translate(w*b/2+1,C*b/2+1),R.clearRect(0,0,d.width,d.height),new c(R,y,I,!0).drawSymbol(f,_),R.getImageData(0,0,d.width,d.height)}async analyzeCIMSymbol(t,e,i,s,a){const o=[],n=e?{geometryType:s,spatialReference:this._spatialReference,fields:e}:null;let c;await m(t.data,n,this._cimResourceManager,o,this._avoidSDF),r(a);for(const t of o)"CIMPictureMarker"!==t.cim.type&&"CIMPictureFill"!==t.cim.type&&"CIMPictureStroke"!==t.cim.type||(c||(c=[]),c.push(this._fetchPictureMarkerResource(t,a))),i&&"text"===t.type&&"string"==typeof t.text&&t.text.includes("[")&&(t.text=f(i,t.text,t.cim.textCase));return c&&await Promise.all(c),o}rasterizeCIMSymbol3D(t,e,i,r,s,a){const o=[];for(const n of t){r&&"function"==typeof r.scaleFactor&&(r.scaleFactor=r.scaleFactor(e,s,a));const t=this._getRasterizedResource(n,e,i,r,s,a);if(!t)continue;let c=0,m=t.anchorX||0,l=t.anchorY||0,h=!1,p=0,g=0;if("esriGeometryPoint"===i){const t=_(r);if(p=d(n.offsetX,e,s,a)*t||0,g=d(n.offsetY,e,s,a)*t||0,"marker"===n.type)c=d(n.rotation,e,s,a)||0,h=!!n.rotateClockwise&&n.rotateClockwise;else if("text"===n.type){if(c=d(n.angle,e,s,a)||0,void 0!==n.horizontalAlignment)switch(n.horizontalAlignment){case"left":m=-.5;break;case"right":m=.5;break;default:m=0}if(void 0!==n.verticalAlignment)switch(n.verticalAlignment){case"top":l=.5;break;case"bottom":l=-.5;break;case"baseline":l=-.25;break;default:l=0}}}null!=t&&o.push({angle:c,rotateClockWise:h,anchorX:m,anchorY:l,offsetX:p,offsetY:g,rasterizedResource:t})}return this.getSymbolImage(o)}getSymbolImage(t){const e=document.createElement("canvas"),r=i(e.getContext("2d"));let a=0,o=0,n=0,c=0;const m=[];for(let e=0;e<t.length;e++){const i=t[e],l=i.rasterizedResource;if(!l)continue;const h=l.size,p=i.offsetX,g=i.offsetY,u=i.anchorX,f=i.anchorY,d=i.rotateClockWise||!1;let y=i.angle,j=s(p)-h[0]*(.5+u),w=s(g)-h[1]*(.5+f),C=j+h[0],_=w+h[1];if(y){d&&(y=-y);const t=Math.sin(y*Math.PI/180),e=Math.cos(y*Math.PI/180),i=j*e-w*t,r=j*t+w*e,s=j*e-_*t,a=j*t+_*e,o=C*e-_*t,n=C*t+_*e,c=C*e-w*t,m=C*t+w*e;j=Math.min(i,s,o,c),w=Math.min(r,a,n,m),C=Math.max(i,s,o,c),_=Math.max(r,a,n,m)}a=j<a?j:a,o=w<o?w:o,n=C>n?C:n,c=_>c?_:c;const M=r.createImageData(l.size[0],l.size[1]);M.data.set(new Uint8ClampedArray(l.image.buffer));const b={offsetX:p,offsetY:g,rotateClockwise:d,angle:y,rasterizedImage:M,anchorX:u,anchorY:f};m.push(b)}e.width=n-a,e.height=c-o;const l=-a,h=c;for(let t=0;t<m.length;t++){const e=m[t],i=this._imageDataToCanvas(e.rasterizedImage),a=e.rasterizedImage.width,o=e.rasterizedImage.height,n=l-a*(.5+e.anchorX),c=h-o*(.5-e.anchorY);if(e.angle){const t=(360-e.angle)*Math.PI/180;r.save(),r.translate(s(e.offsetX),-s(e.offsetY)),r.translate(l,h),r.rotate(t),r.translate(-l,-h),r.drawImage(i,n,c),r.restore()}else r.drawImage(i,n+s(e.offsetX),c-s(e.offsetY))}const p=new w({x:l/e.width-.5,y:h/e.height-.5});return{imageData:0!==e.width&&0!==e.height?r.getImageData(0,0,e.width,e.height):r.createImageData(1,1),anchorPosition:p}}async _fetchPictureMarkerResource(t,i){const r=t.materialHash;if(!this._pictureMarkerCache.get(r)){const s=(await e(t.cim.url,{responseType:"image",signal:i&&i.signal})).data;this._pictureMarkerCache.set(r,s)}}_imageDataToCanvas(t){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const e=this._imageDataCanvas,r=i(e.getContext("2d"));return e.width=t.width,e.height=t.height,r.putImageData(t,0,0),e}_imageTo32Array(e,r,s,a){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const o=this._imageDataCanvas,n=i(o.getContext("2d"));if(o.width=r,o.height=s,n.drawImage(e,0,0,r,s),a){n.save();const i=new t(a);n.fillStyle=i.toHex(),n.globalCompositeOperation="multiply",n.fillRect(0,0,r,s),n.globalCompositeOperation="destination-atop",n.drawImage(e,0,0,r,s),n.restore()}return new Uint32Array(n.getImageData(0,0,r,s).data.buffer)}_getRasterizedResource(t,e,r,s,a,o){let n,c,m;if("text"===t.type)return this._rasterizeTextResource(t,e,s,a,o);({analyzedCIM:n,hash:c}=function(t,e,i,r){let s,a;return"function"==typeof t.materialHash?(s=(0,t.materialHash)(e,i,r),a=l(t.cim,t.materialOverrides)):(s=t.materialHash,a=t.cim),{analyzedCIM:a,hash:s}}(t,e,a,o));const h=_(s);if("CIMPictureMarker"===t.cim.type){const r=d(t.size,e,a,o)*h,{image:s,width:n,height:c}=i(this._getPictureResource(t,r,d(t.color,e,a,o)));return m={image:s,size:[n,c],sdf:!1,simplePattern:!1,anchorX:t.anchorPoint?t.anchorPoint.x:0,anchorY:t.anchorPoint?t.anchorPoint.y:0},m}j(n,h,{preserveOutlineWidth:!1});const p=n;c+=r,s&&(c+=JSON.stringify(s));const g=this._resourceCache;return g.has(c)?g.get(c):(m=this._rasterizer.rasterizeJSONResource({cim:p,type:t.type,url:t.url,mosaicHash:c,size:null,path:null},window.devicePixelRatio||1,this._avoidSDF),g.set(c,m),m)}_rasterizeTextResource(t,e,i,r,s){const a=_(i),o=d(t.text,e,r,s);if(!o||0===o.length)return null;const n=d(t.fontName,e,r,s),c=d(t.style,e,r,s),m=d(t.weight,e,r,s),l=d(t.decoration,e,r,s),h=d(t.size,e,r,s)*a,p=d(t.horizontalAlignment,e,r,s),g=d(t.verticalAlignment,e,r,s),u=y(d(t.color,e,r,s)),f=y(d(t.outlineColor,e,r,s)),j={color:u,size:h,horizontalAlignment:p,verticalAlignment:g,font:{family:n,style:c,weight:m,decoration:l},halo:{size:d(t.outlineSize,e,r,s)||0,color:f,style:c},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(o,j)}_getPictureResource(t,e,i){const r=this._pictureMarkerCache.get(t.materialHash);if(!r)return null;const a=r.height/r.width,o=e?a>1?s(e):s(e)/a:r.width,n=e?a>1?s(e)*a:s(e):r.height;return{image:this._imageTo32Array(r,o,n,i),width:o,height:n}}}export{M as CIMSymbolRasterizer,C as GeometryStyle};
