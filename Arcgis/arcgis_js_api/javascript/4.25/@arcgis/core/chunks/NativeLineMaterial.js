/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{L as e}from"./Logger.js";import{i as t,a as s}from"./maybe.js";import{b as i}from"./screenUtils.js";import{k as r}from"./vec2.js";import{s as o,b as a,m as n,g as l,a as p,c,l as u,C as d,e as h,d as f}from"./vec3.js";import{O as m}from"./vec4f64.js";import{P as g}from"./frustum.js";import{c as S,d as v,f as P,a as _}from"./lineSegment.js";import{c as x,d as C,s as O,n as T}from"./plane.js";import{a as A,d as y}from"./BufferView.js";import{S as b,R}from"./RenderSlot.js";import{S as w,a as E,b as j,e as L,r as N,s as I,c as V,P as D,R as U,E as B,u as W,w as M,x as z,D as H,H as G,G as q,I as X}from"./bufferWriterUtils.js";import{g as F,D as $,M as k,f as Q,a as J}from"./Material.js";import{i as K}from"./Util2.js";import{V as Y}from"./VertexAttribute.js";import{L as Z,f as ee,b as te,g as se,D as ie}from"./DefaultBufferWriter.js";import{i as re}from"./utils20.js";import{T as oe,O as ae}from"./OutputHighlight.glsl.js";import{V as ne}from"./VertexColor.glsl.js";import{C as le}from"./context-util.js";import{B as pe,e as ce}from"./enums3.js";import{s as ue,m as de,c as he,d as fe}from"./OrderIndependentTransparency.js";import{_ as me}from"./tslib.es6.js";import{p as ge}from"./ShaderTechniqueConfiguration.js";const Se=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new w,{vertex:s,fragment:i}=t;return t.include(oe,e),t.include(ne,e),t.include(Z,e),E(s,e),e.stippleEnabled&&(t.attributes.add(Y.UV0,"vec2"),t.attributes.add(Y.AUXPOS1,"vec3"),s.uniforms.add(new j("viewport",((e,t)=>t.camera.fullViewport)))),t.attributes.add(Y.POSITION,"vec3"),t.varyings.add("vpos","vec3"),s.code.add(F`void main(void) {
vpos = position;
forwardNormalizedVertexColor();
gl_Position = transformPosition(proj, view, vpos);`),e.stippleEnabled&&(s.code.add(F`vec4 vpos2 = transformPosition(proj, view, auxpos1);
vec2 ndcToPixel = viewport.zw * 0.5;
float lineSegmentPixelSize = length((vpos2.xy / vpos2.w - gl_Position.xy / gl_Position.w) * ndcToPixel);`),e.draped?s.uniforms.add(new L("worldToScreenRatio",((e,t)=>1/t.screenToPCSRatio))):s.code.add(F`vec3 segmentCenter = (position + auxpos1) * 0.5;
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),s.code.add(F`float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);`),e.draped?s.code.add(F`float startPseudoScreen = uv0.y * discreteWorldToScreenRatio - mix(0.0, lineSegmentPixelSize, uv0.x);
float segmentLengthPseudoScreen = lineSegmentPixelSize;`):s.code.add(F`float segmentLengthRender = length(position - auxpos1);
float startPseudoScreen = mix(uv0.y, uv0.y - segmentLengthRender, uv0.x) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),s.uniforms.add(new L("stipplePatternPixelSize",(e=>ee(e)))),s.code.add(F`vec2 stippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, lineSegmentPixelSize, stipplePatternPixelSize);
vStippleDistance = mix(stippleDistanceLimits.x, stippleDistanceLimits.y, uv0.x);
vStippleDistance *= gl_Position.w;`)),s.code.add(F`}`),e.output===b.Highlight&&t.include(ae,e),t.include(N,e),i.uniforms.add(new L("alphaCoverage",((e,t)=>Math.min(1,e.width*t.camera.pixelRatio)))),e.hasVertexColors||i.uniforms.add(new j("constantColor",(e=>e.color))),i.code.add(F`
  void main() {
    discardBySlice(vpos);

    vec4 color = ${e.hasVertexColors?"vColor":"constantColor"};

    float stippleAlpha = getStippleAlpha();
    discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);

    vec4 finalColor = blendStipple(vec4(color.rgb, color.a * alphaCoverage), stippleAlpha);

    if (finalColor.a < ${F.float(I)}) {
      discard;
    }

    ${e.output===b.Color?F`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${e.output===b.Highlight?F`outputHighlight();`:""}
  }
  `),t}},Symbol.toStringTag,{value:"Module"}));class ve extends V{get _stippleEnabled(){return this.configuration.stippleEnabled&&this.configuration.output!==b.Highlight}initializeConfiguration(e,t){t.hasWebGL2Context=e.rctx.type===le.WEBGL2}initializeProgram(e){return new D(e.rctx,ve.shader.get().build(this.configuration),$)}initializePipeline(){const e=this.configuration,t=ue(pe.SRC_ALPHA,pe.ONE,pe.ONE_MINUS_SRC_ALPHA,pe.ONE_MINUS_SRC_ALPHA),s=(t,s=null,i=null)=>de({blending:s,depthTest:B,depthWrite:i,colorWrite:he,stencilWrite:e.hasOccludees?W:null,stencilTest:e.hasOccludees?t?M:z:null});return e.output===b.Color?(this._occludeePipelineState=s(!0,e.transparent||this._stippleEnabled?t:null,fe),s(!1,e.transparent||this._stippleEnabled?t:null,fe)):s(!1)}get primitiveType(){return ce.LINES}getPipelineState(e,t){return t?this._occludeePipelineState:super.getPipelineState(e,t)}}ve.shader=new U(Se,(()=>Promise.resolve().then((()=>Se))));class Pe extends H{constructor(){super(...arguments),this.output=b.Color,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.hasOccludees=!1}}var _e;me([ge({count:b.COUNT})],Pe.prototype,"output",void 0),me([ge()],Pe.prototype,"hasSlicePlane",void 0),me([ge()],Pe.prototype,"hasVertexColors",void 0),me([ge()],Pe.prototype,"transparent",void 0),me([ge()],Pe.prototype,"draped",void 0),me([ge()],Pe.prototype,"stippleEnabled",void 0),me([ge()],Pe.prototype,"stippleOffColorEnabled",void 0),me([ge()],Pe.prototype,"stipplePreferContinuous",void 0),me([ge()],Pe.prototype,"hasOccludees",void 0),me([ge({constValue:!1})],Pe.prototype,"stippleRequiresClamp",void 0),me([ge({constValue:!1})],Pe.prototype,"stippleScaleWithLineWidth",void 0),me([ge({constValue:!1})],Pe.prototype,"stippleRequiresStretchMeasure",void 0),function(e){e[e.START=0]="START",e[e.END=1]="END"}(_e||(_e={}));class xe extends k{constructor(e){super(e,new Te),this._configuration=new Pe}getConfiguration(e,s){this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._configuration.draped=s.slot===R.DRAPED_MATERIAL;const i=t(this.parameters.stipplePattern);return this._configuration.stippleEnabled=i,this._configuration.stippleOffColorEnabled=i&&t(this.parameters.stippleOffColor),this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.stipplePreferContinuous=this.parameters.stipplePreferContinuous,this._configuration}intersect(e,s,i,r,o,a,n,l,p){t(p)?Q(e,r,p,a,1,n):this._intersectLineGeometry(e,s,i,r,n)}_intersectLineGeometry(t,s,i,h,f){if(!h.options.selectionMode||re(s))return;if(!K(i))return void e.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial").error("intersection assumes a translation-only matrix");const m=t.vertexAttributes.get(Y.POSITION).data,S=h.camera,x=Ve;r(x,h.point),o(De[0],x[0]-2,x[1]+2,0),o(De[1],x[0]+2,x[1]+2,0),o(De[2],x[0]+2,x[1]-2,0),o(De[3],x[0]-2,x[1]-2,0);for(let e=0;e<4;e++)if(!S.unprojectFromRenderScreen(De[e],Ue[e]))return;C(S.eye,Ue[0],Ue[1],Be),C(S.eye,Ue[1],Ue[2],We),C(S.eye,Ue[2],Ue[3],Me),C(S.eye,Ue[3],Ue[0],ze);let A=Number.MAX_VALUE,y=0;for(let e=0;e<m.length-5;e+=3){if(Ae[0]=m[e]+i[12],Ae[1]=m[e+1]+i[13],Ae[2]=m[e+2]+i[14],ye[0]=m[e+3]+i[12],ye[1]=m[e+4]+i[13],ye[2]=m[e+5]+i[14],O(Be,Ae)<0&&O(Be,ye)<0||O(We,Ae)<0&&O(We,ye)<0||O(Me,Ae)<0&&O(Me,ye)<0||O(ze,Ae)<0&&O(ze,ye)<0)continue;if(S.projectToRenderScreen(Ae,we),S.projectToRenderScreen(ye,Ee),we[2]<0&&Ee[2]>0){a(be,Ae,ye);const e=S.frustum,t=-O(e[g.NEAR],Ae)/n(be,T(e[g.NEAR]));l(be,be,t),p(Ae,Ae,be),S.projectToRenderScreen(Ae,we)}else if(we[2]>0&&Ee[2]<0){a(be,ye,Ae);const e=S.frustum,t=-O(e[g.NEAR],ye)/n(be,T(e[g.NEAR]));l(be,be,t),p(ye,ye,be),S.projectToRenderScreen(ye,Ee)}else if(we[2]<0&&Ee[2]<0)continue;we[2]=0,Ee[2]=0;const t=v(P(we,Ee,Ne),x);t<A&&(A=t,c(je,Ae),c(Le,ye),y=e/3)}const b=h.rayBegin,R=h.rayEnd;if(A<4){let e=Number.MAX_VALUE;if(_(P(je,Le,Ne),P(b,R,Ie),Re)){a(Re,Re,b);const t=u(Re);l(Re,Re,1/t),e=t/d(b,R)}f(e,Re,y,!1)}}computeAttachmentOrigin(e,t){const s=e.vertexAttributes;if(!s)return!1;const i=s.get(Y.POSITION);return G(i,null,!1,t)}requiresSlot(e,t){return!(t!==b.Color&&t!==b.Highlight&&t!==b.ObjectAndLayerIdColor||e!==R.OPAQUE_MATERIAL&&e!==R.DRAPED_MATERIAL)}createGLMaterial(e){return new Ce(e)}createBufferWriter(){const e=this.parameters.hasVertexColors?te:se;return s(this.parameters.stipplePattern)?new ie(e):new Oe(e.clone().vec3f(Y.AUXPOS1).vec2f(Y.UV0))}}class Ce extends q{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextureRepository.release(this._stipplePattern),this._stipplePattern=null}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output===b.Color&&this._updateOccludeeState(e);const t=this._material.parameters.stipplePattern;return this._stipplePattern!==t&&(this._material.setParameters(this._stippleTextureRepository.swap(this._stipplePattern,t)),this._stipplePattern=t),this.ensureTechnique(ve,e)}}class Oe{constructor(e){this.vertexBufferLayout=e}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){return e.indices.get(Y.POSITION).length}write(e,t,s,i,r){X(s,this.vertexBufferLayout,e,t,i,r),this._writeAuxpos1(e,s,i,r),this._writeUV0(e,s,i,r)}_writeAuxpos1(e,t,s,i){const r=s.getField(Y.AUXPOS1,A),o=t.indices.get(Y.POSITION),a=t.vertexAttributes.get(Y.POSITION).data,n=e,l=r.typedBufferStride,p=r.typedBuffer;i*=l;for(let e=0;e<o.length-1;e+=2)for(const t of[1,0]){const s=3*o[e+t],r=a[s],c=a[s+1],u=a[s+2],d=n[0]*r+n[4]*c+n[8]*u+n[12],h=n[1]*r+n[5]*c+n[9]*u+n[13],f=n[2]*r+n[6]*c+n[10]*u+n[14];p[i]=d,p[i+1]=h,p[i+2]=f,i+=l}}_writeUV0(e,t,s,i){const r=s.getField(Y.UV0,y),a=t.indices.get(Y.POSITION),n=t.vertexAttributes.get(Y.POSITION).data,l=t.vertexAttributes.get(Y.DISTANCETOSTART)?.data,p=r.typedBufferStride,u=r.typedBuffer;let f=0;u[i*=p]=_e.START,u[i+1]=f,i+=p;const m=3*a[0],g=o(Ae,n[m],n[m+1],n[m+2]);e&&h(g,g,e);const S=ye,v=a.length-1;let P=1;const _=l?(e,t,s)=>f=l[s]:(e,t,s)=>f+=d(e,t);for(let t=1;t<v;t+=2){const s=3*a[t];o(S,n[s],n[s+1],n[s+2]),e&&h(S,S,e),_(g,S,P++);for(let e=0;e<2;++e)u[i]=1-e,u[i+1]=f,i+=p;c(g,S)}const x=3*a[v];o(S,n[x],n[x+1],n[x+2]),e&&h(S,S,e),_(g,S,P),u[i]=_e.END,u[i+1]=f}}class Te extends J{constructor(){super(...arguments),this.color=m,this.hasVertexColors=!1,this.hasSlicePlane=!1,this.width=1,this.stipplePreferContinuous=!0,this.hasOccludees=!1,this.stippleTexture=null}}const Ae=f(),ye=f(),be=f(),Re=f(),we=i(),Ee=i(),je=f(),Le=f(),Ne=S(),Ie=S(),Ve=f(),De=[i(),i(),i(),i()],Ue=[f(),f(),f(),f()],Be=x(),We=x(),Me=x(),ze=x();export{xe as N};
