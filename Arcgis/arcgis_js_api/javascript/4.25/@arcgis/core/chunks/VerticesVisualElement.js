/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import e from"../Color.js";import"./object.js";import{d as t}from"./handleUtils.js";import{u as i,i as r,a as s,e as n}from"./maybe.js";import{d as o,f as a,j as l,c,n as h,b as d,a as u,z as _,s as p}from"./vec3.js";import m from"../geometry/Point.js";import{E as f,a as g,s as v}from"./settings3.js";import x from"../core/Handles.js";import{watch as S}from"../core/reactiveUtils.js";import{e as O}from"./screenUtils.js";import{n as E,b as w,h as R,s as M,j as P}from"./vec2.js";import{e as j,b as y}from"./mathUtils.js";import{f as z}from"./vec4f32.js";import{O as G}from"./Object3DVisualElement.js";import{c as A,a as H}from"./GeometryUtil.js";import{R as I}from"./Material.js";import{V as b}from"./VertexAttribute.js";import{R as V}from"./DefaultBufferWriter.js";import{P as C}from"./PointVisualElement.js";import{R as F}from"./RightAngleQuadVisualElement.js";import{d as T}from"./Settings2.js";import{b as U,a as L}from"./RightAngleSnappingHint.js";import{a as B}from"./SnappingContext.js";import{b as D,c as N}from"./viewUtils.js";import{g as W,E as Z}from"./MultipassGeometryTest.glsl.js";import{C as k}from"./basicInterfaces.js";import{S as q}from"./manipulatorUtils.js";class Q extends G{constructor(e){super(e),this._handles=new x,this._location=o(),this._direction=a(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=z(1,0,1,1),this._renderOccluded=I.OccludeAndTransparent,this.applyProps(e)}get location(){return this._location}set location(e){l(this._location,e)||(c(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){l(this._direction,e)||(c(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,t){h(this._direction,d(this._direction,t,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){j(e,this._color)||(y(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}createExternalResources(){const e=new V(this.materialParameters);this._handles.add(S((()=>this.view.state.camera),(()=>{this._updateGeometry()}))),this._externalResources={material:e}}destroyExternalResources(){this._handles.removeAll(),this._externalResources=null}createGeometries(e){const t=A([o(),o()]),r=A([o(),o()]),s=i(this._externalResources).material;e.addGeometry(t,s),e.addGeometry(r,s),this._updateVertices(e)}forEachExternalMaterial(e){r(this._externalResources)&&e(this._externalResources.material)}_updateMaterial(){s(this._externalResources)||this._externalResources.material.setParameters(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded}}_updateGeometry(){const e=this.object;s(e)||this._updateVertices(e)}_updateVertices(e){const t=this.view.state.camera;t.projectToScreen(this.location,J),u(X,this.location,this.direction),t.projectToScreen(X,K),E(K,w(K,K,J)),this._updateVertexAttributes(t,e,0,J,K,1),this._updateVertexAttributes(t,e,1,J,K,-1)}_updateVertexAttributes(e,t,i,r,s,n){const o=t.geometryRecords[i],a=o.geometry.getMutableAttribute(b.POSITION).data,l=R(Y,M(Y,s[1]*n,s[0]*-n),this.offset+this.width/2),c=P($,P($,P($,r,R($,s,this.length/2)),l),l),h=P(ee,c,R(ee,s,-this.length));e.unprojectFromScreen(c,X),a[0]=X[0],a[1]=X[1],a[2]=X[2],e.unprojectFromScreen(h,X),a[3]=X[0],a[4]=X[1],a[5]=X[2],t.geometryVertexAttrsUpdated(o)}}const X=o(),J=O(),K=O(),Y=O(),$=O(),ee=O();class te extends B{visualizeIntersectionPoint(i,r){const{coordinateHelper:s,view:o}=r;return t(new C({view:o,primitive:"circle",geometry:s.vectorToPoint(i.intersectionPoint),elevationInfo:n(i.elevationInfo,r.elevationInfo),size:20,outlineSize:2,color:[0,0,0,0],outlineColor:e.toUnitRGBA(T.orange),pixelSnappingEnabled:!1}))}visualizePoint(i,r){const{view:s,coordinateHelper:n}=r,o=this._alignPoint(i.point,i.domain,r);return t(new C({view:s,primitive:"circle",geometry:n.vectorToPoint(o),elevationInfo:this._hintElevationInfo(i,r),size:20,outlineSize:2,color:[0,0,0,0],outlineColor:e.toUnitRGBA(T.orange),pixelSnappingEnabled:!1}))}visualizeLine(e,i){const{view:r,coordinateHelper:s}=i,n=this._alignPoint(e.lineStart,e.domain,i),o=this._alignPoint(e.lineEnd,e.domain,i);return t(this._createLineSegmentHintFromMap(e.type,n,o,s,this._hintElevationInfo(e,i),r,e.fadeLeft,e.fadeRight))}visualizeParallelSign(i,r){const{view:s,coordinateHelper:n}=r,o=this._hintElevationInfo(i,r),a=this._alignPoint(i.lineStart,i.domain,r),l=this._alignPoint(i.lineEnd,i.domain,r),c=D(a,n,o,s),h=D(l,n,o,s),d=_(h,c,h,.5),u=new Q({view:s,attached:!1,offset:T.parallelLineHintOffset,length:T.parallelLineHintLength,width:T.parallelLineHintWidth,color:e.toUnitRGBA(T.orange),location:d,renderOccluded:I.Opaque});return u.setDirectionFromPoints(c,d),u.attached=!0,t(u)}visualizeRightAngleQuad(i,r){const{view:s,coordinateHelper:n}=r,o=this._hintElevationInfo(i,r),a=this._alignPoint(i.previousVertex,i.domain,r),l=this._alignPoint(i.centerVertex,i.domain,r),c=this._alignPoint(i.nextVertex,i.domain,r);return t(new F({view:s,attached:!0,color:e.toUnitRGBA(T.orange),renderOccluded:I.Transparent,outlineRenderOccluded:I.Opaque,outlineColor:e.toUnitRGBA(T.orange),outlineSize:T.rightAngleHintOutlineSize,size:T.rightAngleHintSize,geometry:{previous:D(a,n,o,s),center:D(l,n,o,s),next:D(c,n,o,s)}}))}_createLineSegmentHintFromMap(e,t,i,r,s,n,a=!0,l=!0){const c=o(),h=o();return N(t,i,r,s,n,c,h),this._createLineSegmentHint(e,n,c,h,a,l)}_createLineSegmentHint(t,i,r,s,n=!0,o=!0){const a=new f({view:i,extensionType:g.FADED,start:r,end:s,color:e.toUnitRGBA(T.orange),renderOccluded:I.Opaque});switch(t){case U.TARGET:a.width=T.lineHintWidthTarget,a.fadedExtensions={start:0,end:T.lineHintFadedExtensions};break;case U.REFERENCE_EXTENSION:a.width=T.lineHintWidthReference,a.fadedExtensions={start:0,end:0};break;case U.REFERENCE:a.width=T.lineHintWidthReference,a.fadedExtensions={start:n?T.lineHintFadedExtensions:0,end:o?T.lineHintFadedExtensions:0}}return a.attached=!0,a}_alignPoint(e,t,i){const r=this._getSelfSnappingZ(t,i);if(s(r))return e;const n=i.coordinateHelper,o=n.vectorToPoint(e,ie);return o.z=r,n.pointToVector(o)}_hintElevationInfo(e,t){return r(this._getSelfSnappingZ(e.domain,t))?i(t.selfSnappingZ).elevationInfo:n(e.elevationInfo,t.elevationInfo)}_getSelfSnappingZ(e,{selfSnappingZ:t}){return e===L.SELF&&r(t)?t.value:null}}const ie=new m;class re extends G{constructor(e){super(e),this.view=null,this._renderOccluded=I.OccludeAndTransparent,this._vertices=null,this._spatialReference=null,this._color=v.colorToVec4(v.reshapeManipulators.vertex.color),this._size=v.reshapeManipulators.vertex.size,this._outlineColor=v.colorToVec4(v.reshapeManipulators.vertex.outlineColor),this._outlineSize=v.reshapeManipulators.vertex.outlineSize,this._elevationInfo=null,this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial(),this._updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(e){this._vertices=e,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.recreateGeometry()}get color(){return this._color}set color(e){j(e,this._color)||(y(this._color,e),this._updateMaterial())}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){j(e,this._outlineColor)||(y(this._outlineColor,e),this._updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get _vertexMaterialParameters(){return{color:this._color,transparent:this._color[3]<1,screenSizeScale:this.size,renderOccluded:this._renderOccluded}}get _vertexOutlineMaterialParameters(){return{color:this._outlineColor,transparent:this._outlineColor[3]<1,screenSizeScale:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded}}_updateMaterial(){this.attached&&this._vertexMaterial.setParameters(this._vertexMaterialParameters)}_updateOutlineMaterial(){this.attached&&this._vertexOutlineMaterial.setParameters(this._vertexOutlineMaterialParameters)}_createRenderGeometries(){const e=this.vertices;if(s(e)||0===e.length)return[];const t=function(e,t,i,r,s){const n=new Float64Array(3*e.length),o=new Float64Array(n.length);e.forEach(((e,t)=>{n[3*t+0]=e[0],n[3*t+1]=e[1],n[3*t+2]=e.length>2?e[2]:0}));const a=W(n,t,0,o,0,n,0,n.length/3,i,r,s),l=null!=a;return{numVertices:e.length,position:n,mapPosition:o,projectionSuccess:l,sampledElevation:a}}(e,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,Z.fromElevationInfo(this.elevationInfo)),i=[],r=t.numVertices,n=t.position;for(let e=0;e<r;++e){const t=p(se,n[3*e+0],n[3*e+1],n[3*e+2]),r=ne(.5,t),s=ne(.5,t);i.push({vertexGeometry:r,vertexOutlineGeometry:s})}return i}createGeometries(e){const t=this._createRenderGeometries();for(const{vertexGeometry:i,vertexOutlineGeometry:r}of t)e.addGeometry(i,this._vertexMaterial),e.addGeometry(r,this._vertexOutlineMaterial)}createExternalResources(){this._vertexMaterial=new q({...this._vertexMaterialParameters,writeDepth:!0,cullFace:k.Back,screenSizeEnabled:!0}),this._vertexOutlineMaterial=new q({...this._vertexOutlineMaterialParameters,transparent:!0,writeDepth:!0,cullFace:k.Front,screenSizeEnabled:!0,shadingEnabled:!1})}destroyExternalResources(){this._vertexMaterial=null,this._vertexOutlineMaterial=null}forEachExternalMaterial(e){e(this._vertexMaterial),e(this._vertexOutlineMaterial)}}const se=o();function ne(e,t){return H(e,16,16,{offset:t})}export{te as S,re as V};
