/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import e from"../core/Error.js";import{L as t}from"./Logger.js";import{a as o,l as r,i as n}from"./maybe.js";import{isPoint as s,isPolygon as u,isPolyline as c,isMultipoint as i}from"../geometry/support/jsonUtils.js";import{O as l,a}from"./OptimizedFeature.js";import{O as f}from"./OptimizedFeatureSet.js";function d(e,t){return e?t?4:3:t?3:2}const h=t.getLogger("esri.layers.graphics.featureConversionUtils"),m={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0},g=(e,t,o,r,n,s)=>{e[o]=n,e[o+1]=s},y=(e,t,o,r,n,s)=>{e[o]=n,e[o+1]=s,e[o+2]=t[r+2]},p=(e,t,o,r,n,s)=>{e[o]=n,e[o+1]=s,e[o+2]=t[r+3]},b=(e,t,o,r,n,s)=>{e[o]=n,e[o+1]=s,e[o+2]=t[r+2],e[o+3]=t[r+3]};function w(e,t,o,r){if(e){if(o)return t&&r?b:y;if(t&&r)return p}else if(t&&r)return y;return g}function I({scale:e,translate:t},o){return Math.round((o-t[0])/e[0])}function M({scale:e,translate:t},o){return Math.round((t[1]-o)/e[1])}function G({scale:e,translate:t},o,r){return o*e[r]+t[r]}function T(e,t,o){return e?t?o?x(e):F(e):o?j(e):N(e):null}function N(e){const t=e.coords;return{x:t[0],y:t[1]}}function P(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e}function F(e){const t=e.coords;return{x:t[0],y:t[1],z:t[2]}}function Z(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.z,e}function j(e){const t=e.coords;return{x:t[0],y:t[1],m:t[2]}}function k(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.m,e}function x(e){const t=e.coords;return{x:t[0],y:t[1],z:t[2],m:t[3]}}function v(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.z,e.coords[3]=t.m,e}function z(e,t){return e&&t?v:e?Z:t?k:P}function L(e,t,o,r,s){const u=z(o,r);for(const{geometry:o,attributes:r}of t){const t=n(o)?u(new a,o):null;e.push(new l(t,r,null,s?r[s]:void 0))}return e}function E(e,t,o=z(null!=t.z,null!=t.m)){return o(e,t)}function U(e,t,r){if(o(e))return null;const n=d(t,r),s=[];for(let t=0;t<e.coords.length;t+=n){const o=[];for(let r=0;r<n;r++)o.push(e.coords[t+r]);s.push(o)}return t?r?{points:s,hasZ:t,hasM:r}:{points:s,hasZ:t}:r?{points:s,hasM:r}:{points:s}}function q(e,t,o,r,s){const u=d(o,r);for(const{geometry:o,attributes:r}of t){const t=n(o)?O(new a,o,u):null;e.push(new l(t,r,null,s?r[s]:void 0))}return e}function O(e,t,o=d(t.hasZ,t.hasM)){e.lengths[0]=t.points.length;const r=e.coords;let n=0;for(const e of t.points)for(let t=0;t<o;t++)r[n++]=e[t];return e}function S(e,t,o){if(!e)return null;const r=d(t,o),{coords:n,lengths:s}=e,u=[];let c=0;for(const e of s){const t=[];for(let o=0;o<e;o++){const e=[];for(let t=0;t<r;t++)e.push(n[c++]);t.push(e)}u.push(t)}return t?o?{paths:u,hasZ:t,hasM:o}:{paths:u,hasZ:t}:o?{paths:u,hasM:o}:{paths:u}}function A(e,t,o,r,s){const u=d(o,r);for(const{geometry:o,attributes:r}of t){const t=n(o)?$(new a,o,u):null;e.push(new l(t,r,null,s?r[s]:void 0))}return e}function $(e,t,o=d(t.hasZ,t.hasM)){const{lengths:r,coords:n}=e;let s=0;for(const e of t.paths){for(const t of e)for(let e=0;e<o;e++)n[s++]=t[e];r.push(e.length)}return e}function R(e,t,o){if(!e)return null;const r=d(t,o),{coords:n,lengths:s}=e,u=[];let c=0;for(const e of s){const t=[];for(let o=0;o<e;o++){const e=[];for(let t=0;t<r;t++)e.push(n[c++]);t.push(e)}u.push(t)}return t?o?{rings:u,hasZ:t,hasM:o}:{rings:u,hasZ:t}:o?{rings:u,hasM:o}:{rings:u}}function V(e,t,o,r,s){for(const{geometry:u,centroid:c,attributes:i}of t){const t=n(u)?Y(new a,u,o,r):null,f=s?i[s]:void 0;n(c)?e.push(new l(t,i,P(new a,c),f)):e.push(new l(t,i,null,f))}return e}function Y(e,t,o=t.hasZ,r=t.hasM){return _(e,t.rings,o,r),e}function _(e,t,o,r){const n=d(o,r),{lengths:s,coords:u}=e;let c=0;me(e);for(const e of t){for(const t of e)for(let e=0;e<n;e++)u[c++]=t[e];s.push(e.length)}return e}const C=[],B=[];function D(e,t,o,r,n){C[0]=e;const[s]=H(B,C,t,o,r,n);return ge(C),ge(B),s}function H(t,o,r,n,s,u){if(ge(t),!r){for(const e of o){const o=u?e.attributes[u]:void 0;t.push(new l(null,e.attributes,null,o))}return t}switch(r){case"esriGeometryPoint":return L(t,o,n,s,u);case"esriGeometryMultipoint":return q(t,o,n,s,u);case"esriGeometryPolyline":return A(t,o,n,s,u);case"esriGeometryPolygon":return V(t,o,n,s,u);default:h.error("convertToFeatureSet:unknown-geometry",new e(`Unable to parse unknown geometry type '${r}'`)),ge(t)}return t}function J(t,o,r,n,s,u){const c=t.length;switch(r){case"esriGeometryPoint":L(t,o,n,s,u);break;case"esriGeometryMultipoint":q(t,o,n,s,u);break;case"esriGeometryPolyline":A(t,o,n,s,u);break;case"esriGeometryPolygon":V(t,o,n,s,u);break;default:h.error("convertToFeatureSet:unknown-geometry",new e(`Unable to parse unknown geometry type '${r}'`))}for(let e=0;e<o.length;e++)t[e+c].geometryType=r,t[e+c].insertAfter=o[e].insertAfter,t[e+c].groupId=o[e].groupId;return t}function K(e,t,o,r){B[0]=e,X(C,B,t,o,r);const n=C[0];return ge(C),ge(B),n}function Q(t,r,n){if(o(t))return null;const l=new a;return"hasZ"in t&&null==r&&(r=t.hasZ),"hasM"in t&&null==n&&(n=t.hasM),s(t)?z(null!=r?r:null!=t.z,null!=n?n:null!=t.m)(l,t):u(t)?Y(l,t,r,n):c(t)?$(l,t,d(r,n)):i(t)?O(l,t,d(r,n)):void h.error("convertFromGeometry:unknown-geometry",new e(`Unable to parse unknown geometry type '${t}'`))}function W(t,r,n,s){const u=t&&("coords"in t?t:t.geometry);if(o(u))return null;switch(r){case"esriGeometryPoint":{let e=N;return n&&s?e=x:n?e=F:s&&(e=j),e(u)}case"esriGeometryMultipoint":return U(u,n,s);case"esriGeometryPolyline":return S(u,n,s);case"esriGeometryPolygon":return R(u,n,s);default:return h.error("convertToGeometry:unknown-geometry",new e(`Unable to parse unknown geometry type '${r}'`)),null}}function X(t,r,s,u,c){if(ge(t),o(s))return function(e,t){for(const o of t)e.push({attributes:o.attributes});return e}(t,r);switch(s){case"esriGeometryPoint":return function(e,t,o,r){let s=N;o&&r?s=x:o?s=F:r&&(s=j);for(const o of t){const{geometry:t,attributes:r}=o,u=n(t)?s(t):null;e.push({attributes:r,geometry:u})}return e}(t,r,u,c);case"esriGeometryMultipoint":return function(e,t,o,r){for(const{geometry:s,attributes:u}of t)e.push({attributes:u,geometry:n(s)?U(s,o,r):null});return e}(t,r,u,c);case"esriGeometryPolyline":return function(e,t,o,r){for(const{geometry:s,attributes:u}of t)e.push({attributes:u,geometry:n(s)?S(s,o,r):null});return e}(t,r,u,c);case"esriGeometryPolygon":return function(e,t,o,r){for(const{geometry:s,attributes:u,centroid:c}of t){const t=n(s)?R(s,o,r):null;if(n(c)){const o=N(c);e.push({attributes:u,centroid:o,geometry:t})}else e.push({attributes:u,geometry:t})}return e}(t,r,u,c);default:h.error("convertToFeatureSet:unknown-geometry",new e(`Unable to parse unknown geometry type '${s}'`))}return t}function ee(e){const{objectIdFieldName:t,spatialReference:o,transform:r,fields:n,hasM:s,hasZ:u,features:c,geometryType:i,exceededTransferLimit:l,uniqueIdField:a,queryGeometry:f,queryGeometryType:d}=e,h={features:X([],c,i,u,s),fields:n,geometryType:i,objectIdFieldName:t,spatialReference:o,uniqueIdField:a,queryGeometry:W(f,d,!1,!1)};return r&&(h.transform=r),l&&(h.exceededTransferLimit=l),s&&(h.hasM=s),u&&(h.hasZ=u),h}function te(t,o){const r=new f,{hasM:n,hasZ:s,features:u,objectIdFieldName:c,spatialReference:i,geometryType:l,exceededTransferLimit:a,transform:d,fields:m}=t;return m&&(r.fields=m),r.geometryType=l??null,r.objectIdFieldName=c??o??null,r.spatialReference=i??null,r.objectIdFieldName?(u&&H(r.features,u,l,s,n,r.objectIdFieldName),a&&(r.exceededTransferLimit=a),n&&(r.hasM=n),s&&(r.hasZ=s),d&&(r.transform=d),r):(h.error(new e("optimized-features:invalid-objectIdFieldName","objectIdFieldName is missing")),r)}function oe(e){const{transform:t,features:o,hasM:r,hasZ:s}=e;if(!t)return e;for(const e of o)n(e.geometry)&&le(e.geometry,e.geometry,r,s,t),n(e.centroid)&&le(e.centroid,e.centroid,r,s,t);return e.transform=null,e}function re(e,t){const{geometryType:o,features:r,hasM:n,hasZ:s}=t;if(!e)return t;for(let t=0;t<r.length;t++){const u=r[t],c=u.weakClone();c.geometry=new a,ne(c.geometry,u.geometry,n,s,o,e),u.centroid&&(c.centroid=new a,ne(c.centroid,u.centroid,n,s,"esriGeometryPoint",e)),r[t]=c}return t.transform=e,t}function ne(e,t,r,n,s,u,c=r,i=n){if(me(e),o(t)||!t.coords.length)return null;const l=m[s],{coords:a,lengths:f}=t,h=d(r,n),g=d(r&&c,n&&i),y=w(r,n,c,i);if(!f.length)return y(e.coords,a,0,0,I(u,a[0]),M(u,a[1])),me(e,h,0),e;let p,b,G,T,N=0,P=0,F=P;for(const t of f){if(t<l)continue;let o=0;P=F,G=p=I(u,a[N]),T=b=M(u,a[N+1]),y(e.coords,a,P,N,G,T),o++,N+=h,P+=g;for(let r=1;r<t;r++,N+=h)G=I(u,a[N]),T=M(u,a[N+1]),G===p&&T===b||(y(e.coords,a,P,N,G-p,T-b),P+=g,o++,p=G,b=T);o>=l&&(e.lengths.push(o),F=P)}return ge(e.coords,F),e.coords.length?e:null}function se(e,t,o,r,n,s,u=o,c=r){if(me(e),!t||!t.coords.length)return null;const i=m[n],{coords:l,lengths:a}=t,f=d(o,r),h=d(o&&u,r&&c),g=w(o,r,u,c);if(!a.length)return g(e.coords,l,0,0,l[0],l[1]),me(e,f,0),e;let y=0;const p=s*s;for(const t of a){if(t<i){y+=t*f;continue}const o=e.coords.length/h,r=y,n=y+(t-1)*f;g(e.coords,l,e.coords.length,r,l[r],l[r+1]),ce(e.coords,l,f,p,g,r,n),g(e.coords,l,e.coords.length,n,l[n],l[n+1]);const s=e.coords.length/h-o;s>=i?e.lengths.push(s):ge(e.coords,o*h),y+=t*f}return e.coords.length?e:null}function ue(e,t,o,r){const n=e[t],s=e[t+1],u=e[o],c=e[o+1],i=e[r],l=e[r+1];let a=u,f=c,d=i-a,h=l-f;if(0!==d||0!==h){const e=((n-a)*d+(s-f)*h)/(d*d+h*h);e>1?(a=i,f=l):e>0&&(a+=d*e,f+=h*e)}return d=n-a,h=s-f,d*d+h*h}function ce(e,t,o,r,n,s,u){let c,i=r,l=0;for(let e=s+o;e<u;e+=o)c=ue(t,e,s,u),c>i&&(l=e,i=c);i>r&&(l-s>o&&ce(e,t,o,r,n,s,l),n(e,t,e.length,l,t[l],t[l+1]),u-l>o&&ce(e,t,o,r,n,l,u))}function ie(e,t,r,n){if(o(t)||!t.coords||!t.coords.length)return null;const s=d(r,n);let u=Number.POSITIVE_INFINITY,c=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,l=Number.NEGATIVE_INFINITY;if(t&&t.coords){const e=t.coords;for(let t=0;t<e.length;t+=s){const o=e[t],r=e[t+1];u=Math.min(u,o),i=Math.max(i,o),c=Math.min(c,r),l=Math.max(l,r)}}return e[0]=u,e[1]=c,e[2]=i,e[3]=l,e}function le(e,t,o,n,s){const{coords:u,lengths:c}=t,i=d(o,n);if(!u.length)return e!==t&&me(e),e;r(s);const{originPosition:l,scale:a,translate:f}=s,h=ye;h.originPosition=l;const m=h.scale;m[0]=a[0]??1,m[1]=-(a[1]??1),m[2]=a[2]??1,m[3]=a[3]??1;const g=h.translate;if(g[0]=f[0]??0,g[1]=f[1]??0,g[2]=f[2]??0,g[3]=f[3]??0,!c.length){for(let t=0;t<i;++t)e.coords[t]=G(h,u[t],t);return e!==t&&me(e,i,0),e}let y=0;for(let t=0;t<c.length;t++){const o=c[t];e.lengths[t]=o;for(let t=0;t<i;++t)e.coords[y+t]=G(h,u[y+t],t);let r=e.coords[y],n=e.coords[y+1];y+=i;for(let t=1;t<o;t++,y+=i){r+=u[y]*m[0],n+=u[y+1]*m[1],e.coords[y]=r,e.coords[y+1]=n;for(let t=2;t<i;++t)e.coords[y+t]=G(h,u[y+t],t)}}return e!==t&&me(e,u.length,c.length),e}function ae(e,t,o,r,n,s){if(me(e),e.lengths.push(...t.lengths),o===n&&r===s)for(let o=0;o<t.coords.length;o++)e.coords.push(t.coords[o]);else{const u=d(o,r),c=w(o,r,n,s),i=t.coords;for(let t=0;t<i.length;t+=u)c(e.coords,i,e.coords.length,t,i[t],i[t+1])}return e}function fe(e,t,o,r){let n=0,s=e[r*t],u=e[r*(t+1)];for(let c=1;c<o;c++){const o=s+e[r*(t+c)],i=u+e[r*(t+c)+1],l=(o-s)*(i+u);s=o,u=i,n+=l}return.5*n}function de(e,t){const{coords:o,lengths:r}=e;let n=0,s=0;for(let e=0;e<r.length;e++){const u=r[e];s+=fe(o,n,u,t),n+=u}return Math.abs(s)}function he(e,t){if(o(e))return null;const r=e.clone(),n=e.coords,s=e.lengths;let u=0;for(let e=0;e<s.length;e++){const o=s[e];let c=n[t*u],i=n[t*u+1];for(let e=1;e<o;e++){const o=c+n[t*(u+e)],s=i+n[t*(u+e)+1];r.coords[t*(u+e)]=o,r.coords[t*(u+e)+1]=s,c=o,i=s}u+=o}return r}function me(e,t=0,o=0){ge(e.lengths,o),ge(e.coords,t)}function ge(e,t=0){e.length!==t&&(e.length=t)}const ye={originPosition:"lowerLeft",scale:[1,1,1,1],translate:[0,0,0,0]};export{he as A,W as a,Q as b,ee as c,_ as d,Y as e,T as f,se as g,S as h,R as i,U as j,ie as k,oe as l,te as m,H as n,K as o,D as p,ne as q,ae as r,re as s,I as t,le as u,M as v,E as w,de as x,J as y,$ as z};
