/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import"../geometry.js";import e from"../analysis/SlicePlane.js";import{h as t}from"./object.js";import{L as r}from"./Logger.js";import{d as s,b as i,r as a}from"./mathUtils.js";import{u as o,i as n,a as c}from"./maybe.js";import{f as d}from"./screenUtils.js";import{w as l,g as u,m as g,q as p,r as m,i as f,k as h,x as b}from"./mat4.js";import{c as _}from"./mat4f64.js";import{r as T}from"./quat.js";import{f as O,c as E,l as I,s as C,a as R,g as A,b as w,d as j,n as v,m as M,h as L,k as S,H as P}from"./vec3.js";import{tryProjectWithZConversion as y}from"../geometry/projection.js";import{b as N,A as k}from"./vector.js";import{f as V,i as U,c as W,r as x,n as H,u as F}from"./boundedPlane.js";import{f as D,j as G}from"./plane.js";import{c as q,s as B,d as X,k as Y}from"./ray.js";import{a as Z,f as z}from"./vec4f64.js";import{L as $,a as J}from"./LineVisualElement.js";import{b as K,M as Q,w as ee,d as te}from"./manipulatorUtils.js";import{O as re}from"./Object3DVisualElement.js";import{d as se,c as ie,e as ae,f as oe,g as ne}from"./GeometryUtil.js";import{g as ce,D as de,N as le,M as ue,i as ge,R as pe}from"./Material.js";import{S as me,R as fe}from"./RenderSlot.js";import{S as he}from"./ShaderTechniqueConfiguration.js";import{S as be,a as _e,b as Te,e as Oe,R as Ee,c as Ie,P as Ce,G as Re}from"./bufferWriterUtils.js";import{D as Ae,P as we,R as je}from"./DefaultBufferWriter.js";import{V as ve}from"./VertexAttribute.js";import{B as Me,d as Le}from"./enums3.js";import{m as Se,s as Pe,c as ye}from"./OrderIndependentTransparency.js";import{R as Ne}from"./RenderCoordsHelper.js";import{a as ke}from"./ray2.js";import{C as Ve}from"./basicInterfaces.js";import{C as Ue}from"./ColorMaterial.js";import{N as We}from"./NativeLineMaterial.js";import{M as xe,a as He}from"./interfaces3.js";const Fe=t("mac")?"Meta":"Control",De="Shift",Ge=2500,qe=.02,Be=Math.cos(s(45)),Xe=Math.cos(s(5)),Ye=.95,Ze=.3,ze=O(1,.5,0),$e=2,Je=1,Ke=Z([...ze,.7]),Qe=[0,0,0,.04],et=Z([...ze,.5]),tt=z(1,1,1,1),rt=z(1,.8,.6,1),st=z(1,.93,.86,1),it=Z([...ze,1]),at=Z([...ze,1]),ot=Z([...ze,1]),nt=Object.freeze(Object.defineProperty({__proto__:null,build:function(e){const t=new be;t.extensions.add("GL_OES_standard_derivatives");const{vertex:r,fragment:s,attributes:i,varyings:a}=t;return _e(r,e),i.add(ve.POSITION,"vec3"),i.add(ve.UV0,"vec2"),a.add("vUV","vec2"),r.code.add(ce`void main(void) {
vUV = uv0;
gl_Position = proj * view * vec4(position, 1.0);
}`),s.uniforms.add([new Te("backgroundColor",(e=>e.backgroundColor)),new Te("gridColor",(e=>e.gridColor)),new Oe("gridWidth",(e=>e.gridWidth))]),s.code.add(ce`void main() {
const float LINE_WIDTH = 1.0;
vec2 uvScaled = vUV * gridWidth;
vec2 gridUV = (fract(uvScaled + 0.5) - 0.5) / (LINE_WIDTH * fwidth(uvScaled));
vec2 grid = (1.0 - step(0.5, gridUV)) * step(-0.5, gridUV);
grid.x *= step(0.5, uvScaled.x) * step(uvScaled.x, gridWidth - 0.5);
grid.y *= step(0.5, uvScaled.y) * step(uvScaled.y, gridWidth - 0.5);
float gridFade = max(grid.x, grid.y);
float gridAlpha = gridColor.a * gridFade;
gl_FragColor =
vec4(backgroundColor.rgb * backgroundColor.a, backgroundColor.a) * (1.0 - gridAlpha) +
vec4(gridColor.rgb, 1.0) * gridAlpha;
}`),t}},Symbol.toStringTag,{value:"Module"}));class ct extends le{constructor(){super(...arguments),this.backgroundColor=z(1,0,0,.5),this.gridColor=z(0,1,0,.5),this.gridWidth=4}}class dt extends Ie{initializeProgram(e){return new Ce(e.rctx,dt.shader.get().build(this.configuration),de)}initializePipeline(){return Se({blending:Pe(Me.ONE,Me.ONE,Me.ONE_MINUS_SRC_ALPHA,Me.ONE_MINUS_SRC_ALPHA),depthTest:{func:Le.LESS},colorWrite:ye})}}dt.shader=new Ee(nt,(()=>Promise.resolve().then((()=>nt))));class lt extends ue{constructor(e){super(e,new gt),this._configuration=new he}intersect(e,t,r,s,i,a,o){return ge(e,t,s,i,a,void 0,o)}createBufferWriter(){return new Ae(we)}requiresSlot(e,t){return t===me.Color&&e===fe.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL}createGLMaterial(e){return new ut(e)}getConfiguration(){return this._configuration}}class ut extends Re{constructor(e){super(e),this.ensureTechnique(dt,null)}beginSlot(){return o(this.technique)}}class gt extends ct{constructor(){super(...arguments),this.renderOccluded=pe.Occlude}}class pt extends re{constructor(e){super(e),this._material=null,this._renderOccluded=pe.OccludeAndTransparent,this._gridWidth=1,this._gridColor=z(1,0,0,1),this._backgroundColor=z(1,0,0,1),this.applyProps(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get gridWidth(){return this._gridWidth}set gridWidth(e){this._gridWidth!==e&&(this._gridWidth=e,this._updateMaterial())}get gridColor(){return this._gridColor}set gridColor(e){i(this._gridColor,e),this._updateMaterial()}get backgroundColor(){return this._backgroundColor}set backgroundColor(e){i(this._backgroundColor,e),this._updateMaterial()}createExternalResources(){this._material=new lt(this._materialParameters)}destroyExternalResources(){this._material=null}forEachExternalMaterial(e){n(this._material)&&e(this._material)}createGeometries(e){if(n(this._material)){const t=se();e.addGeometry(t,this._material)}}get _materialParameters(){return{backgroundColor:this._backgroundColor,gridWidth:this._gridWidth,gridColor:this._gridColor,renderOccluded:this._renderOccluded}}_updateMaterial(){n(this._material)&&this._material.setParameters(this._materialParameters)}}function mt(e,t,r,s,i,a,o,n){return function(e,t,r,s,i,a){const o=M(e,t),n=B.get(),c=B.get();switch(s===Ft.HORIZONTAL_OR_VERTICAL?Math.abs(o)>Be?Ft.HORIZONTAL:Ft.VERTICAL:s){case Ft.VERTICAL:{const s=Math.abs(o)<=Xe?e:r.viewUp;L(n,s,t),E(c,t);break}case Ft.HORIZONTAL:L(n,r.viewUp,t),L(c,t,n);break;case Ft.TILTED:{const s=Math.abs(o)<=Xe?t:r.viewUp;L(n,s,e),L(c,e,n);break}}const d=L(B.get(),n,c);M(d,r.viewForward)>0&&A(c,c,-1),v(i,n),v(a,c)}(t,o.worldUpAtPosition(e,B.get()),i,a,n.basis1,n.basis2),A(n.basis1,n.basis1,r),A(n.basis2,n.basis2,s),E(n.origin,e),G(n.basis2,n.basis1,n.origin,n.plane),n}function ft(e,t,r,s,i,a){const o=E(B.get(),i.origin);R(o,o,A(B.get(),i.basis1,e.direction[0]<0?1:-1)),R(o,o,A(B.get(),i.basis2,e.direction[1]<0?1:-1));const n=I(i.basis1),c=I(i.basis2),d=w(B.get(),r,o),l=w(B.get(),t,o);let u=0,g=0;if(Mt(e)){const t=vt(i),r=vt(a);u=n-.5*e.direction[0]*M(i.basis1,l)/n,g=c-.5*e.direction[1]*M(i.basis2,l)/c;const s=r/t;u*=s,g*=s}const p=u+.5*e.direction[0]*M(i.basis1,d)/n,m=g+.5*e.direction[1]*M(i.basis2,d)/c,f=A(B.get(),i.basis1,p/n),h=A(B.get(),i.basis2,m/c);(p<=0||wt(a.origin,f,s)<=1600)&&E(f,a.basis1),(m<=0||wt(a.origin,h,s)<=1600)&&E(h,a.basis2);const b=E(B.get(),o);return R(b,b,A(B.get(),f,e.direction[0]<0?-1:1)),R(b,b,A(B.get(),h,e.direction[1]<0?-1:1)),V(b,f,h,a)}function ht(e,t){return.4*Math.min(t.width,t.height)*t.computeRenderPixelSizeAt(e)}function bt(e,t,r,s){const i=L(B.get(),t,r);return L(i,i,t),D(e,i,s)}function _t(e,t){return K(e.basis1,e.basis2,e.origin,t)}function Tt(e,t,r,s){const i=t.worldUpAtPosition(e.origin,B.get()),a=B.get();switch(r){case Ht.HEADING:E(a,i);break;case Ht.TILT:E(a,e.basis1)}return D(e.origin,a,s)}function Ot(e,t,r,s){const i=At(r,Rt.NEGATIVE_X),a=X.get();m(a,t,i.edge*Math.PI/2);const o=v(B.get(),i.basis);let n=A(B.get(),o,i.direction*s.computeScreenPixelSizeAt(i.position)*40);R(n,n,i.position);const c=s.projectToRenderScreen(n,d(B.get())),l=function(e,t){const[r,s,i,a]=e.viewport,o=Math.min(i,a)/16;let n=!0;return t[0]<r+o?(t[0]=r+o,n=!1):t[0]>r+i-o&&(t[0]=r+i-o,n=!1),t[1]<s+o?(t[1]=s+o,n=!1):t[1]>s+a-o&&(t[1]=s+a-o,n=!1),n}(s,c);ke(s,c,Gt),v(Gt.direction,Gt.direction);const u=B.get();!l&&U(r,Gt,u)&&(n=u),a[12]=0,a[13]=0,a[14]=0,e.modelTransform=a,e.renderLocation=S(n),l?e.state|=Dt:e.state&=~Dt}function Et(e,t,r,s){const i=I(s.basis1),a=I(s.basis2),o=jt(s),n=vt(s),c=C(B.get(),0,0,0);R(c,A(B.get(),s.basis1,t.direction[0]),A(B.get(),s.basis2,t.direction[1])),R(c,s.origin,c);let d=0,p=1;if(Mt(t))1===t.direction[0]&&-1===t.direction[1]?d=qt:1===t.direction[0]&&1===t.direction[1]?d=Math.PI:-1===t.direction[0]&&1===t.direction[1]&&(d=3*Math.PI/2),p=n;else{const e=0!==t.direction[0]?1:2;d=1===e?qt:0,p=(1===e?a:i)-o}const m=l(X.get(),d);u(m,m,C(B.get(),p,p,p)),g(m,r,m),m[12]=0,m[13]=0,m[14]=0,e.modelTransform=m,e.renderLocation=c}function It(e,t,r,s){const i=s.worldUpAtPosition(r.origin,B.get()),a=At(r,Rt.POSITIVE_X),o=l(X.get(),a.edge*Math.PI/2);p(o,o,-Vt(r,i)),g(o,t,o),o[12]=0,o[13]=0,o[14]=0,e.modelTransform=o,e.renderLocation=a.position}function Ct(e,t,r){const s=At(r,Rt.POSITIVE_Y),i=l(X.get(),s.edge*Math.PI/2);p(i,i,qt),g(i,t,i),i[12]=0,i[13]=0,i[14]=0,e.modelTransform=i,e.renderLocation=s.position}var Rt;function At(e,t){switch(t){case Rt.POSITIVE_X:return{basis:e.basis1,direction:1,position:R(B.get(),e.origin,e.basis1),edge:t};case Rt.POSITIVE_Y:return{basis:e.basis2,direction:1,position:R(B.get(),e.origin,e.basis2),edge:t};case Rt.NEGATIVE_X:return{basis:e.basis1,direction:-1,position:w(B.get(),e.origin,e.basis1),edge:t};case Rt.NEGATIVE_Y:return{basis:e.basis2,direction:-1,position:w(B.get(),e.origin,e.basis2),edge:t}}}function wt(e,t,r){const s=r.projectToRenderScreen(R(B.get(),e,t),d(B.get())),i=r.projectToRenderScreen(w(B.get(),e,t),d(B.get()));return P(w(s,s,i))}function jt(e){const t=I(e.basis1),r=I(e.basis2);return.3*Math.min(t,r)}function vt(e){return jt(e)}function Mt(e){return 0!==e.direction[0]&&0!==e.direction[1]}function Lt(e,t=Yt.CENTER_ON_ARROW){const r=t===Yt.CENTER_ON_CALLOUT?40:0,s=[O(r,0,-24),O(r,0,24)],i=function(e,t){const r=w(j(),e[e.length-1],e[e.length-2]);v(r,r),A(r,r,22.5),R(r,r,e[e.length-1]);{const t=w(j(),e[0],e[1]);return v(t,t),A(t,t,22.5),R(t,t,e[0]),[t,...e,r]}}(s),a=(e,t)=>function(e,t,r){const s=s=>{const i=(s?t:e).slice(0),a=w(B.get(),i[0],i[1]);v(a,a);const o=w(B.get(),i[i.length-1],i[i.length-2]);if(v(o,o),r.padding>0){const e=A(j(),o,-r.padding);if(i[i.length-1]=R(e,e,i[i.length-1]),r.bothEnds){const e=A(j(),a,-r.padding);i[0]=R(e,e,i[0])}}const c=s?r.tipFocusMultiplier:1,d=r.tipLength*(r.focusTipLength?c:1),l=r.tipRadius*c,p=f(X.get());if(r.padding>0){const e=d/4,t=C(B.get(),0,e,0),s=1+r.padding/e;h(p,p,t),u(p,p,C(B.get(),s,s,s)),h(p,p,A(t,t,-1/s))}const m=f(_()),E=O(0,1,0),I=b(_(),T(Y.get(),E,o));I[12]=i[i.length-1][0],I[13]=i[i.length-1][1],I[14]=i[i.length-1][2],g(I,I,p);const M=function(e,t,r){const s=[];if(n(t))s.push([e,t.thickness/2],[-e,t.thickness/2],[-e,-t.thickness/2],[e,-t.thickness/2]);else{const t=12;for(let r=0;r<t;r++){const i=r/t*2*Math.PI;s.push([Math.cos(i)*e,Math.sin(i)*e])}}return ne(s,r,[],[],!1)}(r.tubeRadius*(s?r.tubeFocusMultiplier:1)+r.padding,r.flat,i),L=[{part:"tube",geometry:M,transform:m}];let S,P;if(n(r.flat)?S=ae(d,l,l,r.flat.thickness):(S=oe(d,l,24,!1,!1,!0),P=oe(d,l,24,!1,!0,!1)),L.push({part:"tip",geometry:S,transform:I}),P&&L.push({part:"cap",geometry:P,transform:I}),r.bothEnds){const e=b(_(),T(Y.get(),E,a));e[12]=i[0][0],e[13]=i[0][1],e[14]=i[0][2],g(e,e,p),L.push({part:"tip",geometry:S,transform:e}),P&&L.push({part:"cap",geometry:P,transform:e})}return L};return{normal:s(!1),focused:s(!0)}}(s,s,{tubeRadius:3,tipRadius:11,tipLength:22.5,tubeFocusMultiplier:1.15,tipFocusMultiplier:1.15,padding:e,bothEnds:!0,flat:null,focusTipLength:!0,addCap:t}),o=a(0,!1),c=a(2.25,!0),d=new Ue({color:tt,cullFace:Ve.Back,renderOccluded:pe.Opaque}),l=new Ue({color:rt,cullFace:Ve.Back,renderOccluded:pe.Opaque}),p=new Ue({color:st,cullFace:Ve.Back,renderOccluded:pe.Opaque}),m=new Ue({color:at,transparent:!0,writeDepth:!1,cullFace:Ve.Front,renderOccluded:pe.Transparent}),E=ie([[r,0,0],[r-40,0,0]]),I=ie([[r,0,0],[r-40,0,0]]),M=new We({color:it,renderOccluded:pe.OccludeAndTransparent});return new Q({view:e,renderObjects:[...o.normal.map((({part:e,geometry:t,transform:r})=>({geometry:t,material:"tip"===e?d:"cap"===e?l:p,transform:r,stateMask:He.Unfocused|xt}))),...c.normal.map((({geometry:e,transform:t})=>({geometry:e,material:m,transform:t,stateMask:He.Unfocused|xt}))),{geometry:E,material:M,stateMask:He.Unfocused|xt|Dt},...o.focused.map((({part:e,geometry:t,transform:r})=>({geometry:t,material:"tip"===e?d:"cap"===e?l:p,transform:r,stateMask:He.Focused|xt}))),...c.focused.map((({geometry:e,transform:t})=>({geometry:e,material:m,transform:t,stateMask:He.Focused|xt}))),{geometry:I,material:M,stateMask:He.Focused|xt|Dt}],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[i]},collisionPriority:1,radius:11,state:xt})}function St(e,t){const r=te(e,{customStateMask:xt,texture:t});return r.state=xt,r}function Pt(e){return new $({view:e,attached:!1,color:Ke,width:1,writeDepthEnabled:!1,renderOccluded:pe.OccludeAndTransparent,geometry:[[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]]]})}function yt(e){return new pt({view:e,attached:!1,backgroundColor:[...Qe],gridColor:et,gridWidth:4,renderOccluded:pe.OccludeAndTransparent})}function Nt(e,t){const r=Mt(t),s=r?[O(1,0,0),O(0,0,0),O(0,1,0)]:[O(1,0,0),O(-1,0,0)],i=ie(s),a=ot,o=r?4:1,n=2*o,c=e=>e>1?(e=>new je({color:a,width:e,renderOccluded:pe.OccludeAndTransparent}))(e):new We({color:a,renderOccluded:pe.OccludeAndTransparent}),d=[{geometry:i,material:c(o),stateMask:He.Unfocused|Bt},{geometry:i,material:c(n),stateMask:He.Focused|Bt},{geometry:i,material:c(1),stateMask:Xt}],l=new Q({view:e,renderObjects:d,collisionType:{type:"line",paths:[s]},radius:r?6:4,...ee});return l.state=Bt,l}function kt(t,r,s,i=new e){if(c(t))return null;const{renderCoordsHelper:o}=r,n=o.fromRenderCoords(t.origin,r.spatialReference);if(c(n))return null;const d=y(n,s);if(c(d))return null;i.position=d;const l=2*I(t.basis1),u=2*I(t.basis2),g=Ne.renderUnitScaleFactor(r.spatialReference,s);i.width=l*g,i.height=u*g;const p=o.worldUpAtPosition(t.origin,B.get());return i.tilt=a(Vt(t,p)),i.heading=o.headingAtPosition(t.origin,t.basis1)-90,i}function Vt(e,t){return N(t,e.basis2,e.basis1)+qt}function Ut(e,t){if(c(e)||c(e.position))return null;const r=J(e.position,t.spatialReference,t.elevationProvider);if(c(r))return null;const s=Ne.renderUnitScaleFactor(e.position.spatialReference,t.spatialReference),i=e.width*s,a=e.height*s;return{position:r,heading:e.heading,tilt:e.tilt,renderWidth:i,renderHeight:a}}function Wt(e,t,i,a=W()){if(c(e))return null;const o=function(e,t,i,a,o,n,c=W()){return n.toRenderCoords(e,c.origin)?(n.worldBasisAtPosition(c.origin,k.X,c.basis1),n.worldBasisAtPosition(c.origin,k.Y,c.basis2),G(c.basis2,c.basis1,c.origin,c.plane),x(c,-s(t),H(c),c),x(c,s(i),c.basis1,c),A(c.basis1,c.basis1,a/2),A(c.basis2,c.basis2,o/2),F(c),c):(r.getLogger("esri.views.3d.analysis.Slice.sliceToolUtils").error(`Failed to project slice plane position, projection from ${e.spatialReference.wkid} is not supported`),null)}(e.position,e.heading,e.tilt,e.renderWidth,e.renderHeight,t.renderCoordsHelper,a);return!i.tiltEnabled&&n(o)&&function(e,t,r){const s=t.worldUpAtPosition(e.origin,B.get()),i=e.basis1,a=Vt(e,s),o=Math.round(a/qt)*qt;x(e,o-a,i,r)}(o,t.renderCoordsHelper,o),o}!function(e){e[e.POSITIVE_X=0]="POSITIVE_X",e[e.POSITIVE_Y=1]="POSITIVE_Y",e[e.NEGATIVE_X=2]="NEGATIVE_X",e[e.NEGATIVE_Y=3]="NEGATIVE_Y"}(Rt||(Rt={}));const xt=xe.Custom1;var Ht,Ft;!function(e){e[e.HEADING=1]="HEADING",e[e.TILT=2]="TILT"}(Ht||(Ht={})),function(e){e[e.HORIZONTAL_OR_VERTICAL=0]="HORIZONTAL_OR_VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL",e[e.VERTICAL=2]="VERTICAL",e[e.TILTED=3]="TILTED"}(Ft||(Ft={}));const Dt=xe.Custom2,Gt=q(),qt=Math.PI/2,Bt=xe.Custom1,Xt=xe.Custom2;var Yt;function Zt(e){const t="building-scene-3d"===e.type?e:null;return n(t)}!function(e){e[e.CENTER_ON_CALLOUT=0]="CENTER_ON_CALLOUT",e[e.CENTER_ON_ARROW=1]="CENTER_ON_ARROW"}(Yt||(Yt={}));export{Je as A,Mt as B,Dt as C,xt as D,Bt as E,Xt as F,et as G,vt as H,qe as I,Yt as O,Ge as P,Ht as R,Ft as S,Wt as a,kt as b,Lt as c,St as d,Nt as e,yt as f,Pt as g,$e as h,Zt as i,De as j,Fe as k,Tt as l,ht as m,mt as n,_t as o,Ut as p,It as q,ft as r,Ct as s,Et as t,Ot as u,Ke as v,Qe as w,bt as x,Ye as y,Ze as z};
