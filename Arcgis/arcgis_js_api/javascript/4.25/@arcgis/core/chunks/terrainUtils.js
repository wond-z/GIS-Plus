/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import e from"../core/Collection.js";import{r as t,f as s,d as r,i as n,a as i}from"./maybe.js";import{f as o,h as a,m as l,b as u}from"../geometry/SpatialReference.js";import{g as c}from"./layerUtils.js";import{V as h}from"./ViewingMode.js";import{_ as f}from"./tslib.es6.js";import m from"../request.js";import p from"../core/Accessor.js";import{b as d,clone as _}from"../core/lang.js";import g from"../core/Error.js";import{createResolver as T,onAbort as k,createAbortError as S,throwIfAborted as y,isAbortError as E}from"../core/promiseUtils.js";import{property as b}from"../core/accessorSupport/decorators/property.js";import"./ensureType.js";import{subclass as O}from"../core/accessorSupport/decorators/subclass.js";import{a as w}from"./Util2.js";import{T as W}from"./Scheduler.js";import{N as L}from"./interfaces4.js";import{d as N,c as A,b as R,m as I,a as x,g as D}from"./vec3.js";import{canProjectToWGS84ComparableLonLat as C}from"../geometry/projection.js";import{n as j,o as H,g as Q,c as U}from"./aaBoundingRect.js";import{g as v,T as M,M as q}from"./TerrainConst.js";class z{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}}class F{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new G}}class G{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}}class V{constructor(e,t,s,r){this._workerFunc=e,this._callbackFunc=t,this._maxTotalNumWorkers=s,this._totalNumWorkers=0,this._clients=r.map((e=>new F(e)))}destroy(){this._clients.length=0}hasQuota(e){const t=this._clients[e];return!!t&&(this._totalNumWorkers<this._maxTotalNumWorkers||t.numWorkers+t.tasks.length<t.typeWorkerQuota)}push(e){const t=this._clients[e.client];t&&(this._totalNumWorkers<this._maxTotalNumWorkers?(t.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,((e,t)=>this._taskCallback(e,t)))):t.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}_taskFinished(e){const t=this._clients[e.client];this._totalNumWorkers--,t.numWorkers--,t.statistics.requests++,t.statistics.size+=e.size||0,t.statistics.duration+=e.duration||0,t.statistics.speed=t.statistics.duration>0?t.statistics.size/t.statistics.duration:0,w(t.numWorkers>=0),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),((e,t)=>this._taskCallback(e,t))))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,t){e._cancelled||(this._callbackFunc(e,t),this._taskFinished(e))}getStatsForType(e){const t=this._clients[e];return t?{quota:t.typeWorkerQuota,workers:t.numWorkers,queueSize:t.tasks.length,requestStats:t.statistics}:null}get test(){const e=this;return{set workerFunc(t){e._workerFunc=t}}}}let B=class extends p{constructor(){super(...arguments),this._tasks=new Map,this._onLoadQueue=new Array,this._doneQueue=new Array,this.updating=!1}setup(e,t,s){this._loadQueue=new V(((e,t)=>this._startLoading(e,t)),((e,t)=>this._doneLoadingCB(e,t)),e,t),s&&(this._frameTask=s.registerTask(W.STREAM_DATA_LOADER,this))}destroy(){this._frameTask=t(this._frameTask),this._tasks.forEach((e=>s(e.abortController))),this._loadQueue=r(this._loadQueue),this._onLoadQueue=null,this._doneQueue=null,this._tasks=null}hasDownloadSlots(e){return this._loadQueue.hasQuota(e)}request(e,t,s,r={}){const i=T();i.__signal=n(r)?r.signal:null;const o=this._createOrUpdateTask(e,t,s,r,i);return k(r,(()=>this._cancelRequest(o,i))),i.promise}_createTask(e,t,s,r,n,i){const o=new $(e,t,s,r,n);return this._updateTask(o,i),this._tasks.set(n,o),1===this._tasks.size&&this._set("updating",!0),this._loadQueue.push(o),o}_cancelRequest(e,t){d(e.resolvers,t),t.reject(S()),0===e.resolvers.length&&(e.status===J.DOWNLOADING&&(e.status=J.CANCELLED,this._loadQueue.cancel(e),e.abortController?.abort(),e.request=null,e.abortController=null),e.status=J.CANCELLED,this._tasks.delete(e.key),0===this._tasks.size&&this._set("updating",!1))}_updateTask(e,t){e.resolvers.push(t)}_createOrUpdateTask(e,t,s,r,i){const o=function(e,t,s){return`${e}:${t}:${s}`}(n(r)&&r.uid||e,t,s),a=this._tasks.get(o);return a?(this._updateTask(a,i),a):this._createTask(e,r,t,s,o,i)}_doneLoadingCB(e,t){this._loadQueue&&(w(e.status===J.DOWNLOADING),e.status=J.DOWNLOADED,this._frameTask?this._doneQueue.push({task:e,err:t}):this._doneLoading(e,t))}get running(){return this._doneQueue.length>0||this._onLoadQueue.length>0}runTask(e){for(;!e.done&&this._onLoadQueue.length>0;){const t=this._onLoadQueue.shift();y(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){const t=this._doneQueue.shift();t.task.status!==J.DOWNLOADED&&(t.err=t.err||S()),this._doneLoading(t.task,t.err),e.madeProgress()}}_doneLoading(e,t){if(t&&!E(t)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);let s=e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const r of e.resolvers)if(t)E(t)?r.reject(t):r.reject(new g("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--s;const t=s<=0?e.result:_(e.result);r.resolve(t)}this._tasks.delete(e.key),0===this._tasks.size&&this._set("updating",!1)}_startLoading(e,t){if(e.status===J.CANCELLED)return!1;let s,r;switch(e.startTime=performance.now(),e.status=J.DOWNLOADING,e.docType){case"binary":r="array-buffer",s=0;break;case"image":r="image";break;case"image+type":r="array-buffer";break;default:r="json"}e.abortController=new AbortController;const n=e.abortController.signal;e.request=m(e.url,{...e.options,responseType:r,timeout:s,signal:n});let i=()=>{};const o=s=>{e.duration=performance.now()-e.startTime,e.size=s instanceof ArrayBuffer?s.byteLength:e.size||0,e.result=s,this._frameTask?this._onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},a=s=>{e.status===J.DOWNLOADING&&t(e,s),i()};return"image+type"!==e.docType?(e.request.then((e=>o(e.data)),a),!0):(e.request.then((t=>{const l=t.data,u=function(e){if(e.byteLength<2)return"unknown";const t=new Uint8Array(e,0,e.byteLength);return 137===t[0]&&80===t[1]?"image/png":71===t[0]&&73===t[1]?"image/gif":66===t[0]&&77===t[1]?"image/bmp":255===t[0]&&216===t[1]?"image/jpeg":"unknown"}(l);if(r="image",e.size=l.byteLength,"unknown"===u)return e.request=m(e.url,{responseType:r,timeout:s,signal:n}),void e.request.then((e=>o(e.data)),a);const c=new Blob([l],{type:u}),h=window.URL.createObjectURL(c);i=()=>window.URL.revokeObjectURL(h),e.request=m(h,{responseType:r,timeout:s,signal:n}),e.request.then((e=>o(new P(e.data,u,i))),a)}),a),!0)}get test(){return{loadQueue:this._loadQueue}}};f([b({readOnly:!0})],B.prototype,"updating",void 0),B=f([O("esri.views.3d.support.StreamDataLoader")],B);class P{constructor(e,t,s){this.image=e,this.type=t,this.release=s}get isOpaque(){return"image/jpeg"===this.type}}class $ extends z{constructor(e,t,s,r,n){super(r),this.url=e,this.options=t,this.docType=s,this.key=n,this.result=null,this.status=J.QUEUED,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0,this.numRetries=0}}var J;!function(e){e[e.QUEUED=1]="QUEUED",e[e.DOWNLOADING=2]="DOWNLOADING",e[e.DOWNLOADED=3]="DOWNLOADED",e[e.CANCELLED=4]="CANCELLED"}(J||(J={}));const K=N(),X=N(),Y=N(),Z=N();function ee(e,t,s,r){A(K,s),K[r]=t[r];const n=R(K,K,t),i=R(X,e,t),o=I(i,n),a=I(n,n);let l;l=o<=0?t:a<=o?s:x(K,t,D(n,n,o/a));const u=R(K,e,l);return Math.PI/2-Math.atan(u[2]/Math.sqrt(u[0]*u[0]+u[1]*u[1]))}const te=Object.freeze(Object.defineProperty({__proto__:null,isInsideExtent:function(e,t,s=0){const r=e.extent;if(i(r))return!1;if(0===s)return j(r,t);const n=Math.min(r[2]-r[0],r[3]-r[1]);return H(r,t,s*n)},tiltToExtentEdge:function(e,t,s){const r=e.extent;if(i(r))return 0;Y[0]=r[0],Y[1]=r[1],Y[2]=s,Z[0]=r[2],Z[1]=r[3],Z[2]=s;let n=1/0,o=1/0;return t[0]<Y[0]?n=ee(t,Y,Z,0):t[0]>Z[0]&&(n=ee(t,Z,Y,0)),t[1]<Y[1]?o=ee(t,Y,Z,1):t[1]>Z[1]&&(o=ee(t,Z,Y,1)),Math.min(n,o)},checkIfTileInfoSupportedForViewSR:function(e,t,s){if(i(e))return v();if(e.spatialReference.isGeographic&&!C(e.spatialReference))return new g("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");const r=M.checkUnsupported(e);if(n(r))return r;if(i(s))return new g("tilingscheme:extent-not-exist","The layer does not provide a layer extent.");const o=function(e,t){const s=e.lods,r=s[0].resolution*2**s[0].level,n=[r*e.size[0],r*e.size[1]],i=[e.origin.x,e.origin.y],o=Q(t),a=U();M.computeRowColExtent(o,n,i,a);const l=(a[2]-a[0])*(a[3]-a[1]);if(l>q){const t=s[0].scale*2**s[0].level;let n=Math.max((o[3]-o[1])/e.size[1],(o[2]-o[0])/e.size[0])*t/r;const i=Math.floor(Math.log(n)/Math.log(10));return n=Math.ceil(n/10**i)*10**i,new g("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(t).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+n.toLocaleString()+".",{level0Scale:t,suggestedLevel0Scale:n,requiredNumRootTiles:l,allowedNumRootTiles:q})}return null}(e,s);if(o)return o;const a=e.spatialReference;return n(t)&&!(a.equals(t)||t.isWGS84&&a.isWebMercator)?new g("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"):null}},Symbol.toStringTag,{value:"Module"})),se=Object.freeze(Object.defineProperty({__proto__:null,isInsideExtent:function(){return!0},tiltToExtentEdge:function(){return 0},checkIfTileInfoSupportedForViewSR:function(e,t){if(i(e))return v();const s=e.lods.length-1,r=e.spatialReference,l=C(r)||o(r)||a(r);if(r.isWebMercator){if(!M.makeWebMercatorAuxiliarySphere(s).compatibleWith(e))return new g("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!l)return new g("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!M.makeGCSWithTileSize(e.spatialReference,e.size[0],s).compatibleWith(e))return e.spatialReference.isWGS84?new g("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new g("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}return n(t)&&!e.spatialReference.equals(t)?new g("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene"):void 0}},Symbol.toStringTag,{value:"Module"})),re={[h.Global]:se,[h.Local]:te};function ne(e,t){e||console.warn("Terrain: "+t)}let ie=!1,oe=!1;function ae(e){oe=e,ie=ie||e}function le(e){ie=e}function ue(e,t){if(ie&&!e){const e=(new Error).stack.slice(5);throw console.warn("Terrain internal: "+(t||"")+" at "+e),new Error("Assertion failed"+(t?": "+t:""))}}function ce(e){return fe(e)?{fullExtent:e.fullExtent,minScale:e.layer.minScale,maxScale:e.layer.maxScale,tilemapCache:null}:e.layer}function he(e){return"imagery-tile"===e?.type||"wcs"===e?.type}function fe(e){return"imagery-tile-3d"===e?.type}function me(e){return"tile-3d"===e?.type}function pe(e){return"vector-tile-3d"===e?.type}function de(e){return"wmts-3d"===e?.type}function _e(e){return"elevation-3d"===e?.type}function ge(e){return"group"===e?.type}function Te(e){return"group"===e?.type}function ke(e){return e&&(me(e)||de(e)||fe(e)||pe(e))}function Se(e){return e&&(me(e)||fe(e)||pe(e)||de(e))}function ye(e){return Se(e)||_e(e)}function Ee(e){const t=e?.sourceLayerInfo?.data;return n(t)&&"type"in t&&"raster-tile"===t.type}function be(e){const t=e?.sourceLayerInfo?.data;return n(t)&&"type"in t&&"vector-tile"===t.type}function Oe(e){const t=e?.sourceLayerInfo?.data;return n(t)&&"type"in t&&"tile-texture"===t.type}function we(e){const t=e?.sourceLayerInfo?.data;return t instanceof HTMLImageElement||t instanceof P||t instanceof HTMLCanvasElement||t instanceof ImageData}function We(e){return n(e)&&"release"in e&&e.release(),null}function Le(e){return e.fetchTile&&!1!==e.hasOverriddenFetchTile}function Ne(e,t,s,r){return re[r].checkIfTileInfoSupportedForViewSR(e,s,t)}function Ae(e,t,s){let r=null,i=null;if("wmts"===e?.type){const n=Re(e,t,s);r=n.tileInfo,i=n.fullExtent}else{i=he(e)?e.getCompatibleFullExtent(t):e.fullExtent;const n=s===h.Local;if(he(e))r=e.getCompatibleTileInfo(t,i,n);else if("vector-tile"===e?.type){const s=n&&!Ie(t)||xe.force512VTL,i=e.tileInfo.spatialReference.isGeographic;r=s?e.tileInfo:e.tileInfo.getOrCreateCompatible(256,i?1:2)}else r=e.tileInfo}return n(r)&&n(i)&&null==Ne(r,i,t,s)?{tileInfo:r,fullExtent:i}:null}function Re(t,s,r){const i=c(t);if(n(i)){if(!e.isCollection(i))return{tileInfo:i.tileInfo,fullExtent:i.fullExtent};{const e=i.find((e=>null==Ne(e.tileInfo,e.fullExtent,s,r)));if(e)return{tileInfo:e.tileInfo,fullExtent:e.fullExtent}}}return{tileInfo:null,fullExtent:null}}function Ie(e){return e.isWGS84||e.isWebMercator||l(e)||!u(e)}const xe={force512VTL:!1};function De(e){return"["+e[0]+","+e[1]+","+e[2]+"]"}function Ce(e){return"("+e[0]+","+e[1]+","+e[2]+")"}function je(e,t,s=Be){return Math.abs(e-t)<s}function He(e){return e===L.NORTH_EAST?L.SOUTH_WEST:e===L.NORTH_WEST?L.SOUTH_EAST:e===L.SOUTH_WEST?L.NORTH_EAST:L.NORTH_WEST}function Qe(e){return e===L.NORTH?L.SOUTH:e===L.EAST?L.WEST:e===L.SOUTH?L.NORTH:L.EAST}function Ue(e){return e===L.NORTH_WEST||e===L.SOUTH_WEST}function ve(e){return e===L.NORTH_WEST||e===L.NORTH_EAST}function Me(e){return e===L.NORTH_WEST||e===L.WEST||e===L.SOUTH_WEST}function qe(e){return e===L.NORTH_EAST||e===L.EAST||e===L.SOUTH_EAST}function ze(e){return e===L.SOUTH_EAST||e===L.SOUTH||e===L.SOUTH_WEST}function Fe(e){return e===L.NORTH_EAST||e===L.NORTH||e===L.NORTH_WEST}const Ge=[L.NORTH,L.EAST,L.SOUTH,L.WEST],Ve=[L.NORTH_EAST,L.SOUTH_EAST,L.SOUTH_WEST,L.NORTH_WEST],Be=1e-5;export{we as A,Oe as B,ge as C,Se as D,ie as E,_e as F,Le as G,fe as H,P as I,me as J,le as K,ae as L,Ne as M,Re as N,Ie as O,xe as P,B as S,he as a,ue as b,ce as c,Te as d,ke as e,Ge as f,Ae as g,Qe as h,ye as i,Fe as j,ze as k,Me as l,qe as m,Ve as n,He as o,oe as p,Ue as q,We as r,ve as s,De as t,je as u,Ce as v,ne as w,pe as x,be as y,Ee as z};
