/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import e from"../Graphic.js";import"./object.js";import{h as t}from"./handleUtils.js";import{i as a,a as i,r}from"./maybe.js";import{whenOrAbort as n,eachAlways as s}from"../core/promiseUtils.js";import{watch as l,initial as o,whenOnce as c}from"../core/reactiveUtils.js";import{p as u}from"./screenUtils.js";import{d as p}from"./diffUtils.js";import{c as y,a as f}from"./drapedUtils.js";import{m as d}from"./lengthUtils.js";import{a as m,T as h}from"./sizeVariableUtils.js";import{getRotationAngle as g,getSize as b}from"./visualVariableUtils.js";import{t as w}from"./symbolConversion.js";import{getDisplayedSymbol as v}from"../symbols/support/symbolUtils.js";import{G as S}from"./GraphicState.js";import{h as j,a as I}from"./hitTestSelectUtils.js";function V(e){const t=e.sourceLayer;if("feature"!==t.type||!function(e){switch(e.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":case"pie-chart":return!0;default:return!1}}(t.renderer))return{rotation:null,size:null};let r=null,n=null;const s=t.renderer.getVisualVariablesForType("rotation").filter((t=>(!t.axis||"heading"===t.axis)&&t.field&&!t.valueExpression&&a(g(t,e))));1===s.length&&(r=function(e,t){const a="heading"===(e.axis||"heading")&&"arithmetic"===e.rotationType?-1:1,i=e.field,r=t.fields&&t.fields.filter((e=>e.name===i)),n=r&&1===r.length?r[0].type:"double",s={initial:0,current:0};return{field:i,fieldType:n,getDefault:()=>Promise.resolve(0),getValue:e=>(s.current=s.initial-a*e,U((s.current+360)%360,n)),initValue:e=>{s.initial=null!=e?e:s.current,s.current=0},isUpdatingInteractively:!1,rotationType:e.rotationType??"geographic"}}(s[0],t));const l=t.renderer.getVisualVariablesForType("size").filter((t=>t.field&&!t.useSymbolValue&&!t.valueExpression&&m(t)===h.RealWorldSize&&a(b(t,e))));return 1===l.length&&(n=function(e,t){const a=e.field,r=e.axis,n=t.fields&&t.fields.filter((e=>e.name===a)),s=n&&1===n.length?n[0].type:"double",l={updating:!1,initial:0,current:0},o=d[e.valueUnit]??1;let c;return c="area"===e.valueRepresentation?e=>(e*o/2)**2*Math.PI:"radius"===e.valueRepresentation||"distance"===e.valueRepresentation?e=>e*o/2:e=>e*o,{field:a,fieldType:s,getDefault:async(e,t)=>U(c(await async function(e,t,a){if(i(t))return 0;const{symbol:r}=w(t);if(i(r)||"web-style"===r.type||"cim"===r.type)return 0;const n=r.symbolLayers.getItemAt(0);if(!n)return 0;switch(n.type){case"icon":{const{computeIconLayerResourceSize:e}=await import("./symbolLayerUtils.js");return n.size||Math.min(A.icon,(await e(n,A.icon))[0])||A.icon}case"text":return n.size||A.text;case"line":return n.size||A.line;case"object":{const{computeObjectLayerResourceSize:t}=await import("./symbolLayerUtils.js");return function(e,t){switch(t){case"width":return e[0];case"depth":return e[1];case"height":return e[2];default:return e[2]||e[1]||e[0]}}(await t(n,e.scale/A.viewScaleSizeFactor),a)}case"path":return(null!=n.width?n.width:n.height)||e.scale/A.viewScaleSizeFactor;case"extrude":return n.size||e.scale/A.viewScaleSizeFactor;default:return 0}}(t,e,r)),s),getValue:(e,t)=>(l.initial||(l.initial=t.pixelSizeAt(t.center)),l.current=l.initial*e,U(l.current,s)),initValue:e=>{l.initial=null!=e?e:l.current,l.current=0},isUpdatingInteractively:!1,displayUnit:C(e.valueUnit),axis:e.axis}}(l[0],t)),{rotation:r,size:n}}function U(e,t){switch(t){case"small-integer":case"integer":case"long":return Math.round(e);case"double":case"single":return e;default:return 0}}async function F(e,t){const i=await v(e,{useSourceLayer:!0,ignoreGraphicSymbol:!0,webStyleCache:t}),r=p(e.symbol,i);a(r)&&(e.symbol=i)}async function z(e,t,a,i){await x(e,t,i);const r=e.on("create",(async r=>{if("cancel"===r.state)return x(e,t,i);if("complete"===r.state){const e=r.graphic;e.sourceLayer||(e.sourceLayer=t.layer),e.attributes||(e.attributes={...t.template.prototype.attributes}),await F(e,i),a(e)}}));return{remove:()=>{r.remove(),e.cancel()}}}async function x(t,a,r){const n=a.layer,s={...a.template.prototype.attributes};await async function(t,a,r,n){const s=new e({sourceLayer:a,attributes:r}),{rotation:l,size:o}=V(s);let c=await v(s,{useSourceLayer:!0,webStyleCache:n}),u=!1;for(const e of[o,l])i(e)||null==r[e.field]&&(r[e.field]=await e.getDefault(c,t.view),u=!0);switch(u&&(c=await v(s,{useSourceLayer:!0,webStyleCache:n})),c?.type){case"simple-fill":case"polygon-3d":t.polygonSymbol=c;break;case"simple-line":case"line-3d":t.polylineSymbol=c;break;case"simple-marker":case"picture-marker":case"point-3d":case"cim":t.pointSymbol=c}T(t.tooltipOptions,o,l)}(t,n,s,r);const l={graphicProperties:{attributes:s,sourceLayer:n},hasZ:n.capabilities.data.supportsZ};return t.layer.elevationInfo=n.elevationInfo,t.create(function(e){if("mesh"===e||"multipatch"===e)throw new Error("Mesh and Multipatch not supported");return e}(n.geometryType),l)}function T(e,t,i){a(t)||a(i)?e.visualVariables={size:a(t)?{unit:t.displayUnit,axis:t.axis,valueType:t.fieldType}:null,rotation:a(i)?{valueType:i.fieldType,rotationType:i.rotationType??"geographic"}:null}:e.visualVariables=null}function L(e,t){return e&&e.find((e=>e.layer===t))}async function M(e,t,a,i){switch(t.type){case"3d":return async function(e,t,a,i){if(0===e.length)return[];const{updatable:r,graphicsByLayer:l}=await a.async((async()=>{const{results:r}=await n(j(t,a),i),s=new Map;I(r).forEach((({graphic:e})=>(({layer:e})=>{const t=s.get(e);if(!t){const t=new Array;return s.set(e,t),t}return t})(e).push(e)));const l=e.filter((({supports:e,layer:t})=>e.includes("update")&&s.has(t)));return 0!==l.length&&a.stopPropagation(),{updatable:l,graphicsByLayer:s}}));return n(s(r.map((async({layer:e})=>{const{objectIdField:t}=e,a="displayField"in e?e.displayField:null,r=[t];e.fieldsIndex.has(a)&&r.push(a);const n=l.get(e);if(n.some((e=>r.some((t=>!(t in e.attributes)))))){const t=e.createQuery();return t.outFields=r,t.returnGeometry=!1,t.objectIds=n.map((e=>e.getObjectId())),e.queryFeatures(t,{signal:i}).then((({features:e})=>e))}return n}))),i)}(e,t,a,i);case"2d":return async function(e,t,a,i){if(0===e.length)return[];let r=null;const l=await a.async((async()=>{const{results:s}=await n(t.hitTest(a),i);if(0===s.length)return[];const l=new Set;r=I(s),r.forEach((({graphic:e})=>e&&l.add(e.layer)));const o=e.items.filter((({layer:e,supports:t})=>t.includes("update")&&l.has(e)));return o.length>0&&a.stopPropagation(),o}));return n(s(l.map((({layer:e})=>{const{objectIdField:n}=e,s="displayField"in e?e.displayField:null,l=[n];e.fieldsIndex.has(s)&&l.push(s);const o=e.createQuery();o.outFields=l,o.returnGeometry=!1;const c="renderer"in e?y({renderer:e.renderer,event:a}):0;return o.geometry=f(a.mapPoint,c,t),o.outSpatialReference=t.spatialReference,e.queryFeatures(o,{signal:i}).then((({features:t})=>(r.forEach((({graphic:a})=>{a.layer===e&&(t.find((t=>t.attributes[n]===a.attributes[e.objectIdField]))||t.push(a))})),t)))}))),i)}(e,t,a,i)}}async function R(e,t,a){const i=e.layer,r=i.createQuery();return r.objectIds=[e.getAttribute(i.objectIdField)],r.outFields=["*"],r.outSpatialReference=t.spatialReference,r.returnM=i.capabilities.data.supportsM,r.returnZ=i.capabilities.data.supportsZ,(await i.queryFeatures(r,{signal:a})).features[0]}async function E(e,t,r,n,s){let l=!1;const{rotation:o,size:c}=n;[o,c].forEach((async r=>{if(i(r))return;const n=t.attributes[r.field];if(a(n))r.initValue(n);else{const a=await r.getDefault(t.symbol,e.view);r.initValue(a),t.setAttribute(r.field,a),l=!0}})),l&&await F(t,s);const u={multipleSelectionEnabled:!1};return"point"===r.geometryType&&(u.enableRotation=a(o),u.enableScaling=a(c)),T(e.tooltipOptions,c,o),e.layer.elevationInfo=r.elevationInfo,e.update(t,u)}async function k(e,t,i,r,n){if(!a(t.geometry)||"point"!==t.geometry?.type)return;const s=r.rotation,l=(o=i.toolEventInfo,!a(o)||"rotate-start"!==o.type&&"rotate"!==o.type&&"rotate-stop"!==o.type?null:o);var o;if(a(s)&&a(l))if("rotate-stop"===l.type)s.isUpdatingInteractively=!1,s.initValue();else{s.isUpdatingInteractively=!0;const{field:a,getValue:i}=s;t.attributes[a]=i(l.angle,e)}const c=r.size,u=function(e){return!a(e)||"scale-start"!==e.type&&"scale"!==e.type&&"scale-stop"!==e.type?null:e}(i.toolEventInfo);if(a(c)&&a(u))if("scale-stop"===u.type)c.isUpdatingInteractively=!1,c.initValue();else{c.isUpdatingInteractively=!0;const{field:a,getValue:i}=c;t.attributes[a]=i(u.xScale,e)}await F(t,n)}async function G(e,n,s,u,p,y){const f=e.clone();await F(f,y),u.map.add(s.layer),s.layer.add(f);const d=e.sourceLayer,m=u.whenLayerView(d),h=()=>{const t=e.layer,a=e.attributes[t.objectIdField];return m.then((e=>e.setVisibility(a,!1)),(()=>{})),{remove(){m.then((e=>e.setVisibility(a,!0)),(()=>{}))}}};let g=null,b=null;if("3d"===u.type){const e=new S({graphic:f});g=t([u.trackGraphicState(e),l((()=>e.displaying),(e=>{b=e?h():r(b)}),o)])}else b=h();await E(s,f,d,n,y);let w=null;m.then((e=>w=e),(()=>{}));const v=n.size,j=n.rotation,I=l((()=>e.attributes),(async e=>{let t=!1;for(const r in e){const n=e[r];n!==f.attributes[r]&&(f.setAttribute(r,n),a(v)&&!v.isUpdatingInteractively&&v.field===r&&v.initValue(n),a(j)&&!j.isUpdatingInteractively&&j.field===r&&j.initValue(n),(i(w)||w.requiredFields.includes(r))&&(t=!0))}t&&await F(f,y)})),V=s.on("update",(async e=>{const t=e.graphics[0];if("complete"===e.state)return E(s,t,d,n,y);await k(u,t,e,n,y),p(t.clone(),e)})),U=s.on(["undo","redo"],(async e=>{p(e.graphics[0].clone(),e)})),z=()=>{};return{interactive:{remove(){U.remove(),V.remove(),s.cancel(),I&&I.remove(),this.remove=z}},visual:{remove(){r(b),u.whenLayerView(d).then((e=>c((()=>!e.updating)))).then((()=>{r(g),s.layer.remove(f),this.remove=z}))}}}}const A={icon:u(24),text:u(12),line:u(1),viewScaleSizeFactor:100};function P(e,t,a){let i=!1;return e.filter((e=>!!i||(i=e===t,i))).map((e=>a[e]()))}function q(e,t){if(e.viewModel.refreshCreationTemplates(),"awaiting-feature-creation-info"===t[0].id){const i=function(e){if(1!==e.length)return null;const t=e[0];if("items"in t){const e=t;return 1===e.items.length?e.items[0]:null}return t}(e.viewModel.featureTemplatesViewModel.items);a(i)&&(e.creationInfo={layer:i.layer,template:i.template},t.shift())}return t}function C(e){switch(e){case"unknown":case"decimal-degrees":return null;default:return e}}const D=e=>/-stop/.test(e)||/vertex-/.test(e);export{E as a,q as b,P as c,z as d,M as e,L as f,V as g,R as h,D as i,G as j,x as s,F as u,k as v};
