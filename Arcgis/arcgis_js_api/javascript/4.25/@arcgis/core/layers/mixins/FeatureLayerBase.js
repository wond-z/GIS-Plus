/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import e from"../../core/Collection.js";import{clone as r}from"../../core/lang.js";import{L as o}from"../../chunks/Logger.js";import{property as s}from"../../core/accessorSupport/decorators/property.js";import"../../chunks/ensureType.js";import{r as i}from"../../chunks/reader.js";import{subclass as n}from"../../core/accessorSupport/decorators/subclass.js";import{w as p}from"../../chunks/writer.js";import a from"../../geometry/Extent.js";import u from"../../geometry/HeightModelInfo.js";import l from"../../geometry/SpatialReference.js";import{p as c,i as d,a as y,w as m}from"../../chunks/arcgisLayerUrl.js";import{e as h,m as f,c as g,u as j}from"../../chunks/commonProperties.js";import{ClonableMixin as v}from"../../core/Clonable.js";import{JSONSupport as w}from"../../core/JSONSupport.js";import S from"../../core/Error.js";import{h as b}from"../../chunks/object.js";import{J as F}from"../../chunks/jsonMap.js";import{i as I}from"../../chunks/maybe.js";import{parseWhereClause as x}from"../../core/sql.js";import C from"../../rest/support/AttachmentQuery.js";import A from"../../rest/support/Query.js";import O from"../../rest/support/RelationshipQuery.js";import R from"../support/GeometryFieldsInfo.js";import k from"../support/LayerFloorInfo.js";import E from"../support/Relationship.js";import"../../chunks/ArrayPool.js";import"../../core/Evented.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/metadata.js";import"../../chunks/tracking.js";import"../../chunks/watch.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../core/promiseUtils.js";import"../../config.js";import"../../chunks/string.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";import"../../geometry/Geometry.js";import"../../geometry/Point.js";import"../../core/accessorSupport/decorators/cast.js";import"../../geometry/support/webMercatorUtils.js";import"../../chunks/Ellipsoid.js";import"../../chunks/unitUtils.js";import"../../chunks/projectionEllipsoid.js";import"../../core/urlUtils.js";import"../../chunks/persistableUrlUtils.js";import"../../TimeExtent.js";import"../../chunks/timeUtils.js";import"../../support/timeUtils.js";import"../../chunks/ElevationInfo.js";import"../support/fieldUtils.js";import"../../chunks/arcadeOnDemand.js";import"../../geometry.js";import"../../geometry/Multipoint.js";import"../../chunks/zmUtils.js";import"../../geometry/Polygon.js";import"../../chunks/extentUtils.js";import"../../geometry/Polyline.js";import"../../chunks/typeUtils.js";import"../../geometry/support/jsonUtils.js";import"../../chunks/unitConversionUtils.js";import"../../chunks/lengthUtils.js";import"../../chunks/opacityUtils.js";import"../../chunks/enumeration.js";import"../../chunks/DataLayerSource.js";import"../support/Field.js";import"../../chunks/domains.js";import"../support/CodedValueDomain.js";import"../support/Domain.js";import"../support/InheritedDomain.js";import"../support/RangeDomain.js";import"../../chunks/fieldType.js";import"../../chunks/FullTextSearch.js";import"../../rest/support/StatisticDefinition.js";let Q=class extends(v(w)){constructor(t){super(t)}};t([s({constructOnly:!0,json:{write:!0}})],Q.prototype,"name",void 0),t([s({constructOnly:!0,json:{write:!0}})],Q.prototype,"fields",void 0),t([s({constructOnly:!0,json:{write:!0}})],Q.prototype,"isAscending",void 0),t([s({constructOnly:!0,json:{write:!0}})],Q.prototype,"indexType",void 0),t([s({constructOnly:!0,json:{write:!0}})],Q.prototype,"isUnique",void 0),t([s({constructOnly:!0,json:{write:!0}})],Q.prototype,"description",void 0),Q=t([n("esri.layers.support.FeatureIndex")],Q);const T=new F({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),M={name:"supportsName",size:"supportsSize",contentType:"supportsContentType",keywords:"supportsKeywords",exifInfo:"supportsExifInfo"};function P(t,e,r){return!!(t&&t.hasOwnProperty(e)?t[e]:r)}function U(t,e,r){return t&&t.hasOwnProperty(e)?t[e]:r}function q(t){const e=t?.supportedSpatialAggregationStatistics?.map((t=>t.toLowerCase()));return{envelope:!!e?.includes("envelopeaggregate"),centroid:!!e?.includes("centroidaggregate"),convexHull:!!e?.includes("convexhullaggregate")}}function D(t,e){const r=t?.supportedOperationsWithCacheHint?.map((t=>t.toLowerCase()));return!!r?.includes(e.toLowerCase())}function G(t,e,r){return{analytics:L(e),attachment:z(e),data:B(e),metadata:V(e),operations:H(e.capabilities||t,e,r),query:W(e,r),queryRelated:Z(e),queryTopFeatures:N(e),editing:J(e)}}function L(t){return{supportsCacheHint:D(t.advancedQueryCapabilities,"queryAnalytics")}}function z(t){const e=t.attachmentProperties,r={supportsName:!1,supportsSize:!1,supportsContentType:!1,supportsKeywords:!1,supportsExifInfo:!1,supportsCacheHint:D(t.advancedQueryCapabilities,"queryAttachments"),supportsResize:P(t,"supportsAttachmentsResizing",!1)};return e&&Array.isArray(e)&&e.forEach((t=>{const e=M[t.name];e&&(r[e]=!!t.isEnabled)})),r}function B(t){return{isVersioned:P(t,"isDataVersioned",!1),supportsAttachment:P(t,"hasAttachments",!1),supportsM:P(t,"hasM",!1),supportsZ:P(t,"hasZ",!1)}}function V(t){return{supportsAdvancedFieldProperties:P(t,"supportsFieldDescriptionProperty",!1)}}function H(t,e,r){const o=t?t.toLowerCase().split(",").map((t=>t.trim())):[],s=r?c(r):null,i=o.includes(I(s)&&"MapServer"===s.serverType?"data":"query"),n=o.includes("editing")&&!e.datesInUnknownTimezone;let p=n&&o.includes("create"),a=n&&o.includes("delete"),u=n&&o.includes("update");const l=o.includes("changetracking"),d=e.advancedQueryCapabilities;return n&&!(p||a||u)&&(p=a=u=!0),{supportsCalculate:P(e,"supportsCalculate",!1),supportsTruncate:P(e,"supportsTruncate",!1),supportsValidateSql:P(e,"supportsValidateSql",!1),supportsAdd:p,supportsDelete:a,supportsEditing:n,supportsChangeTracking:l,supportsQuery:i,supportsQueryAnalytics:P(d,"supportsQueryAnalytic",!1),supportsQueryAttachments:P(d,"supportsQueryAttachments",!1),supportsQueryTopFeatures:P(d,"supportsTopFeaturesQuery",!1),supportsResizeAttachments:P(e,"supportsAttachmentsResizing",!1),supportsSync:o.includes("sync"),supportsUpdate:u,supportsExceedsLimitStatistics:P(e,"supportsExceedsLimitStatistics",!1)}}function W(t,e){const r=t.advancedQueryCapabilities,o=t.ownershipBasedAccessControlForFeatures,s=t.archivingInfo,i=ct(t),n=e?.includes("MapServer"),p=!b("mapserver-pbf-enabled")&&n&&(i??0)<10.81,a=d(e),u=(t.supportedQueryFormats||"").split(",").reduce(((t,e)=>{const r=e.toLowerCase().trim();return r&&t.add(r),t}),new Set);return{supportsStatistics:P(r,"supportsStatistics",t.supportsStatistics),supportsPercentileStatistics:P(r,"supportsPercentileStatistics",!1),supportsSpatialAggregationStatistics:P(r,"supportsSpatialAggregationStatistics",!1),supportedSpatialAggregationStatistics:q(r),supportsCentroid:P(r,"supportsReturningGeometryCentroid",!1),supportsDistance:P(r,"supportsQueryWithDistance",!1),supportsDistinct:P(r,"supportsDistinct",t.supportsAdvancedQueries),supportsExtent:P(r,"supportsReturningQueryExtent",!1),supportsGeometryProperties:P(r,"supportsReturningGeometryProperties",!1),supportsHavingClause:P(r,"supportsHavingClause",!1),supportsOrderBy:P(r,"supportsOrderBy",t.supportsAdvancedQueries),supportsPagination:P(r,"supportsPagination",!1),supportsQuantization:P(t,"supportsCoordinatesQuantization",!1),supportsQuantizationEditMode:P(t,"supportsQuantizationEditMode",!1),supportsQueryGeometry:P(t,"supportsReturningQueryGeometry",!1),supportsResultType:P(r,"supportsQueryWithResultType",!1),supportsMaxRecordCountFactor:P(r,"supportsMaxRecordCountFactor",!1),supportsSqlExpression:P(r,"supportsSqlExpression",!1),supportsStandardizedQueriesOnly:P(t,"useStandardizedQueries",!1),supportsTopFeaturesQuery:P(r,"supportsTopFeaturesQuery",!1),supportsQueryByOthers:P(o,"allowOthersToQuery",!0),supportsHistoricMoment:P(s,"supportsQueryWithHistoricMoment",!1),supportsFormatPBF:!p&&u.has("pbf"),supportsDisjointSpatialRelationship:P(r,"supportsDisjointSpatialRel",!1),supportsCacheHint:P(r,"supportsQueryWithCacheHint",!1)||D(r,"query"),supportsDefaultSpatialReference:P(r,"supportsDefaultSR",!1),supportsCompactGeometry:a,supportsFullTextSearch:P(r,"supportsFullTextSearch",!1),maxRecordCountFactor:U(t,"maxRecordCountFactor",void 0),maxRecordCount:U(t,"maxRecordCount",void 0),standardMaxRecordCount:U(t,"standardMaxRecordCount",void 0),tileMaxRecordCount:U(t,"tileMaxRecordCount",void 0)}}function Z(t){const e=t.advancedQueryCapabilities,r=P(e,"supportsAdvancedQueryRelated",!1);return{supportsPagination:P(e,"supportsQueryRelatedPagination",!1),supportsCount:r,supportsOrderBy:r,supportsCacheHint:D(e,"queryRelated")}}function N(t){return{supportsCacheHint:D(t.advancedQueryCapabilities,"queryTopFilter")}}function J(t){const e=t.ownershipBasedAccessControlForFeatures;return{supportsGeometryUpdate:P(t,"allowGeometryUpdates",!0),supportsGlobalId:P(t,"supportsApplyEditsWithGlobalIds",!1),supportsReturnServiceEditsInSourceSpatialReference:P(t,"supportsReturnServiceEditsInSourceSR",!1),supportsRollbackOnFailure:P(t,"supportsRollbackOnFailureParameter",!1),supportsUpdateWithoutM:P(t,"allowUpdateWithoutMValues",!1),supportsUploadWithItemId:P(t,"supportsAttachmentsByUploadId",!1),supportsDeleteByAnonymous:P(e,"allowAnonymousToDelete",!0),supportsDeleteByOthers:P(e,"allowOthersToDelete",!0),supportsUpdateByAnonymous:P(e,"allowAnonymousToUpdate",!0),supportsUpdateByOthers:P(e,"allowOthersToUpdate",!0)}}async function _(t,e,r,o){const{source:s}=await t.load();if(await K(t,e,o),!s.addAttachment)throw new S(o,"Layer source does not support addAttachment capability");return s.addAttachment(e,r)}function K(t,e,r){const{attributes:o}=e,{objectIdField:s}=t;return t.get("capabilities.data.supportsAttachment")?e?o?s&&o[s]?Promise.resolve():Promise.reject(new S(r,`feature is missing the identifying attribute ${s}`)):Promise.reject(new S(r,"'attributes' are required on a feature to query attachments")):Promise.reject(new S(r,"A feature is required to add/delete/update attachments")):Promise.reject(new S(r,"this layer doesn't support attachments"))}async function $(t,e,r,o,s){const{source:i}=await t.load();if(await K(t,e,s),!i.updateAttachment)throw new S(s,"Layer source does not support updateAttachment capability");return i.updateAttachment(e,r,o)}async function X(t,e,r){const o=await import("../../chunks/editingSupport.js"),s=await t.load();return o.applyEdits(s,s.source,e,r)}async function Y(t,e,r,o){const{source:s}=await t.load();if(await K(t,e,o),!s.deleteAttachments)throw new S(o,"Layer source does not support deleteAttachments capability");return s.deleteAttachments(e,r)}async function tt(t,e,r){const{source:o}=await t.load({signal:e?.signal});if(!o.fetchRecomputedExtents)throw new S(r,"Layer source does not support fetchUpdates capability");return o.fetchRecomputedExtents(e)}async function et(t,e,r,o){e=C.from(e);const{source:s,capabilities:i}=await t.load();if(!i?.data?.supportsAttachment)throw new S(o,"this layer doesn't support attachments");const{attachmentTypes:n,objectIds:p,globalIds:a,num:u,size:l,start:c,where:d}=e;if(!i?.operations?.supportsQueryAttachments){const t=p&&p.length>1,r=n&&n.length,s=a&&a.length,i=l&&l.length;if(t||r||s||i||u||c||d)throw new S(o,"when 'supportsQueryAttachments' is false, only objectIds of length 1 are supported",e)}if(!p?.length&&!d)throw new S(o,"'objectIds' or 'where' are required to perform attachment query",e);if(!s.queryAttachments)throw new S(o,"Layer source does not support queryAttachments capability",e);return s.queryAttachments(e)}async function rt(t,e,r,o){const{source:s}=await t.load();if(!s.queryObjectIds)throw new S(o,"Layer source does not support queryObjectIds capability");return s.queryObjectIds(A.from(e)??t.createQuery(),r)}async function ot(t,e,r,o){const{source:s}=await t.load();if(!s.queryFeatureCount)throw new S(o,"Layer source does not support queryFeatureCount capability");return s.queryFeatureCount(A.from(e)??t.createQuery(),r)}async function st(t,e,r,o){const{source:s}=await t.load();if(!s.queryExtent)throw new S(o,"Layer source does not support queryExtent capability");return s.queryExtent(A.from(e)??t.createQuery(),r)}async function it(t,e,r,o){const{source:s}=await t.load();if(!s.queryRelatedFeatures)throw new S(o,"Layer source does not support queryRelatedFeatures capability");return s.queryRelatedFeatures(O.from(e),r)}async function nt(t,e,r,o){const{source:s}=await t.load();if(!s.queryRelatedFeaturesCount)throw new S(o,"Layer source does not support queryRelatedFeaturesCount capability");return s.queryRelatedFeaturesCount(O.from(e),r)}async function pt(t){const e=t.source;if(e?.refresh)try{const{dataChanged:r,updates:o}=await e.refresh();if(I(o)&&(t.sourceJSON={...t.sourceJSON,...o},t.read(o,{origin:"service",url:t.parsedUrl})),r)return!0}catch{}if(t.definitionExpression)try{return(await x(t.definitionExpression,t.fieldsIndex)).hasDateFunctions}catch{}return!1}function at(t){const e=new A,r=t.get("capabilities.data"),o=t.get("capabilities.query");e.historicMoment=t.historicMoment,e.gdbVersion=t.gdbVersion,e.returnGeometry=!0,o&&(e.compactGeometryEnabled=o.supportsCompactGeometry,e.defaultSpatialReferenceEnabled=o.supportsDefaultSpatialReference),r&&(r.supportsZ&&null!=t.returnZ&&(e.returnZ=t.returnZ),r.supportsM&&null!=t.returnM&&(e.returnM=t.returnM)),e.outFields=["*"];const{timeOffset:s,timeExtent:i}=t;return e.timeExtent=null!=s&&null!=i?i.offset(-s.value,s.unit):i||null,e.multipatchOption="multipatch"===t.geometryType?"xyFootprint":null,e}function ut(t){const{globalIdField:e,fields:r}=t;if(e)return e;if(r)for(const t of r)if("esriFieldTypeGlobalID"===t.type)return t.name}function lt(t){const{objectIdField:e,fields:r}=t;if(e)return e;if(r)for(const t of r)if("esriFieldTypeOID"===t.type)return t.name}function ct(t){return t.currentVersion?t.currentVersion:t.hasOwnProperty("capabilities")||t.hasOwnProperty("drawingInfo")||t.hasOwnProperty("hasAttachments")||t.hasOwnProperty("htmlPopupType")||t.hasOwnProperty("relationships")||t.hasOwnProperty("timeInfo")||t.hasOwnProperty("typeIdField")||t.hasOwnProperty("types")?10:9.3}const dt=c=>{let d=class extends c{constructor(){super(...arguments),this.capabilities=null,this.copyright=null,this.datesInUnknownTimezone=!1,this.displayField=null,this.definitionExpression=null,this.editFieldsInfo=null,this.editingInfo=null,this.elevationInfo=null,this.floorInfo=null,this.fullExtent=null,this.gdbVersion=null,this.geometryFieldsInfo=null,this.geometryType=null,this.hasM=void 0,this.hasZ=void 0,this.heightModelInfo=null,this.historicMoment=null,this.isTable=!1,this.layerId=void 0,this.minScale=0,this.maxScale=0,this.globalIdField=null,this.objectIdField=null,this.relationships=null,this.sourceJSON=null,this.returnM=void 0,this.returnZ=void 0,this.serviceDefinitionExpression=null,this.spatialReference=l.WGS84,this.subtypeField=null,this.trackIdField=null,this.indexes=new(e.ofType(Q)),this.userIsAdmin=!1,this.version=void 0}readCapabilitiesFromService(t,e){return G(t,e,this.url)}readEditingInfo(t,e){const{editingInfo:r}=e;return r?{lastEditDate:null!=r.lastEditDate?new Date(r.lastEditDate):null}:null}readIsTableFromService(t,e){return"Table"===e.type}readMinScale(t,e){return e.effectiveMinScale||t||0}readMaxScale(t,e){return e.effectiveMaxScale||t||0}readGlobalIdFieldFromService(t,e){return ut(e)}readObjectIdFieldFromService(t,e){return lt(e)}readServiceDefinitionExpression(t,e){return e.definitionQuery||e.definitionExpression}set url(t){const e=y({layer:this,url:t,nonStandardUrlAllowed:!0,logger:o.getLogger(this.declaredClass)});this._set("url",e.url),null!=e.layerId&&this._set("layerId",e.layerId)}writeUrl(t,e,r,o){m(this,t,null,e,o)}readVersion(t,e){return ct(e)}};return t([s({readOnly:!0,json:{read:!1,origins:{service:{read:{source:["advancedQueryCapabilities","allowGeometryUpdates","allowUpdateWithoutMValues","archivingInfo","capabilities","datesInUnknownTimezone","hasAttachments","hasM","hasZ","maxRecordCount","maxRecordCountFactor","ownershipBasedAccessControlForFeatures","standardMaxRecordCount","supportedQueryFormats","supportsAdvancedQueries","supportsApplyEditsWithGlobalIds","supportsAttachmentsByUploadId","supportsAttachmentsResizing","supportsCalculate","supportsCoordinatesQuantization","supportsExceedsLimitStatistics","supportsFieldDescriptionProperty","supportsQuantizationEditMode","supportsRollbackOnFailureParameter","supportsStatistics","supportsTruncate","supportsValidateSql","tileMaxRecordCount","useStandardizedQueries"]}}}}})],d.prototype,"capabilities",void 0),t([i("service","capabilities")],d.prototype,"readCapabilitiesFromService",null),t([s({type:String,json:{origins:{service:{read:{source:"copyrightText"}}}}})],d.prototype,"copyright",void 0),t([s({type:Boolean})],d.prototype,"datesInUnknownTimezone",void 0),t([s({type:String,json:{origins:{service:{read:{source:"displayField"}}}}})],d.prototype,"displayField",void 0),t([s({type:String,json:{origins:{service:{read:!1,write:!1}},name:"layerDefinition.definitionExpression",write:{enabled:!0,allowNull:!0}}})],d.prototype,"definitionExpression",void 0),t([s({readOnly:!0})],d.prototype,"editFieldsInfo",void 0),t([s({readOnly:!0})],d.prototype,"editingInfo",void 0),t([i("editingInfo")],d.prototype,"readEditingInfo",null),t([s((()=>{const t=r(h),e=t.json.origins;return e["web-map"]={read:!1,write:!1},e["portal-item"]={read:!1,write:!1},t})())],d.prototype,"elevationInfo",void 0),t([s({type:k,json:{read:{source:"layerDefinition.floorInfo"},write:{target:"layerDefinition.floorInfo"}}})],d.prototype,"floorInfo",void 0),t([s({type:a,json:{origins:{service:{read:{source:"extent"}}}}})],d.prototype,"fullExtent",void 0),t([s()],d.prototype,"gdbVersion",void 0),t([s({readOnly:!0,type:R,json:{read:{source:"geometryProperties"}}})],d.prototype,"geometryFieldsInfo",void 0),t([s({type:["point","polygon","polyline","multipoint","multipatch","mesh"],json:{origins:{service:{read:T.read}}}})],d.prototype,"geometryType",void 0),t([s({type:Boolean,json:{origins:{service:{read:!0}}}})],d.prototype,"hasM",void 0),t([s({type:Boolean,json:{origins:{service:{read:!0}}}})],d.prototype,"hasZ",void 0),t([s({readOnly:!0,type:u})],d.prototype,"heightModelInfo",void 0),t([s({type:Date})],d.prototype,"historicMoment",void 0),t([s({readOnly:!0})],d.prototype,"isTable",void 0),t([i("service","isTable",["type"])],d.prototype,"readIsTableFromService",null),t([s({type:Number,json:{origins:{service:{read:{source:"id"}},"portal-item":{read:!1,write:{target:"id"}}},read:!1}})],d.prototype,"layerId",void 0),t([s(f)],d.prototype,"minScale",void 0),t([i("service","minScale",["minScale","effectiveMinScale"])],d.prototype,"readMinScale",null),t([s(g)],d.prototype,"maxScale",void 0),t([i("service","maxScale",["maxScale","effectiveMaxScale"])],d.prototype,"readMaxScale",null),t([s({type:String})],d.prototype,"globalIdField",void 0),t([i("service","globalIdField",["globalIdField","fields"])],d.prototype,"readGlobalIdFieldFromService",null),t([s({type:String})],d.prototype,"objectIdField",void 0),t([i("service","objectIdField",["objectIdField","fields"])],d.prototype,"readObjectIdFieldFromService",null),t([s({type:[E],readOnly:!0})],d.prototype,"relationships",void 0),t([s()],d.prototype,"sourceJSON",void 0),t([s({type:Boolean})],d.prototype,"returnM",void 0),t([s({type:Boolean})],d.prototype,"returnZ",void 0),t([s({readOnly:!0})],d.prototype,"serviceDefinitionExpression",void 0),t([i("service","serviceDefinitionExpression",["definitionQuery","definitionExpression"])],d.prototype,"readServiceDefinitionExpression",null),t([s({type:l,json:{origins:{service:{read:{source:"extent.spatialReference"}}}}})],d.prototype,"spatialReference",void 0),t([s({type:String,readOnly:!0,json:{origins:{service:{read:!0}}}})],d.prototype,"subtypeField",void 0),t([s({type:String,json:{read:{source:"timeInfo.trackIdField"}}})],d.prototype,"trackIdField",void 0),t([s({readOnly:!0,json:{write:!1}})],d.prototype,"serverGens",void 0),t([s({type:e.ofType(Q),readOnly:!0})],d.prototype,"indexes",void 0),t([s(j)],d.prototype,"url",null),t([p("url")],d.prototype,"writeUrl",null),t([s({readOnly:!0})],d.prototype,"userIsAdmin",void 0),t([s({json:{origins:{service:{read:!0}},read:!1}})],d.prototype,"version",void 0),t([i("service","version",["currentVersion","capabilities","drawingInfo","hasAttachments","htmlPopupType","relationships","timeInfo","typeIdField","types"])],d.prototype,"readVersion",null),d=t([n("esri.layers.mixins.FeatureLayerBase")],d),d};export{dt as FeatureLayerBase,lt as a,_ as b,X as c,at as d,Y as e,tt as f,G as g,rt as h,ot as i,st as j,it as k,nt as l,pt as m,T as n,et as q,ut as r,$ as u};
