/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{L as r}from"../../chunks/Logger.js";import{debounce as s,ignoreAbortErrors as t}from"../../core/promiseUtils.js";import{property as o}from"../../core/accessorSupport/decorators/property.js";import"../../core/lang.js";import"../../chunks/ensureType.js";import{subclass as n}from"../../core/accessorSupport/decorators/subclass.js";import i from"../../core/Collection.js";import"../../chunks/object.js";import"../../core/Error.js";import{a}from"../../chunks/watch.js";import"../../config.js";import"../../chunks/maybe.js";import"../../chunks/string.js";import"../../chunks/get.js";import"../../chunks/utils.js";import"../../chunks/handleUtils.js";import"../../chunks/metadata.js";import"../../chunks/tracking.js";import"../../chunks/ArrayPool.js";import"../../core/Evented.js";import"../../core/Accessor.js";import"../../core/Handles.js";import"../../core/scheduling.js";import"../../chunks/nextTick.js";import"../../chunks/shared.js";import"../../chunks/SimpleObservable.js";const h=new i,c=new WeakMap;function m(e){return null!=e&&"object"==typeof e&&"refreshInterval"in e&&"refresh"in e}function p(e,r){return Number.isFinite(e)&&Number.isFinite(r)?r<=0?e:p(r,e%r):0}let u=0,l=0;function f(){const e=Date.now();for(const r of h)r.refreshInterval&&e-(c.get(r)??0)+5>=6e4*r.refreshInterval&&(c.set(r,e),r.refresh(e))}function j(e){return null!=e&&"object"==typeof e&&"refreshTimestamp"in e&&"refresh"in e}a((()=>{const e=Date.now();let r=0;for(const s of h)r=p(Math.round(6e4*s.refreshInterval),r),s.refreshInterval?c.get(s)||c.set(s,e):c.delete(s);if(r!==l){if(l=r,clearInterval(u),0===l)return void(u=0);u=setInterval(f,l)}}));const d=i=>{let a=class extends i{constructor(...e){super(...e),this.refreshInterval=0,this.refreshTimestamp=0,this._debounceHasDataChanged=s((()=>this.hasDataChanged())),this.when().then((()=>{m(this)&&h.push(this)}),(()=>{}))}destroy(){m(this)&&h.includes(this)&&h.remove(this)}get refreshParameters(){return{_ts:this.refreshTimestamp||null}}refresh(e=Date.now()){t(this._debounceHasDataChanged()).then((r=>{r&&this._set("refreshTimestamp",e),this.emit("refresh",{dataChanged:r})}),(e=>{r.getLogger(this.declaredClass).error(e),this.emit("refresh",{dataChanged:!1,error:e})}))}async hasDataChanged(){return!0}};return e([o({type:Number,cast:e=>e>=.1?e:e<=0?0:.1,json:{write:!0}})],a.prototype,"refreshInterval",void 0),e([o({readOnly:!0})],a.prototype,"refreshTimestamp",void 0),e([o()],a.prototype,"refreshParameters",null),a=e([n("esri.layers.mixins.RefreshableLayer")],a),a};export{d as RefreshableLayer,j as isRefreshableLayer};
