/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import t from"../request.js";import r from"../core/Collection.js";import i from"../core/Error.js";import{clone as s}from"../core/lang.js";import{i as o}from"../chunks/maybe.js";import{M as a}from"../chunks/MultiOriginJSONSupport.js";import{g as n}from"../chunks/object.js";import{waitTick as l,throwIfAbortError as c}from"../core/promiseUtils.js";import{watch as p,on as m,sync as u}from"../core/reactiveUtils.js";import{urlToObject as d,objectToQuery as h}from"../core/urlUtils.js";import{property as f}from"../core/accessorSupport/decorators/property.js";import"../chunks/ensureType.js";import{r as y}from"../chunks/reader.js";import{subclass as g}from"../core/accessorSupport/decorators/subclass.js";import{w as v}from"../chunks/writer.js";import w from"../geometry/Extent.js";import j from"./Layer.js";import x,{W as S}from"./WebTileLayer.js";import{BlendLayer as M}from"./mixins/BlendLayer.js";import{O as L}from"../chunks/OperationalLayer.js";import{PortalLayer as I}from"./mixins/PortalLayer.js";import{RefreshableLayer as T}from"./mixins/RefreshableLayer.js";import{ScaleRangeLayer as b}from"./mixins/ScaleRangeLayer.js";import P from"./support/TileInfo.js";import C from"./support/WMTSSublayer.js";import k from"../geometry/Point.js";import{d as R}from"../chunks/projectionEllipsoid.js";import{o as E}from"../geometry/SpatialReference.js";import{i as U}from"../chunks/crsUtils.js";import{v as O}from"../chunks/xmlUtils.js";import"../config.js";import"../kernel.js";import"../chunks/Logger.js";import"../chunks/string.js";import"../chunks/ArrayPool.js";import"../core/Evented.js";import"../core/Accessor.js";import"../core/Handles.js";import"../chunks/get.js";import"../chunks/utils.js";import"../chunks/handleUtils.js";import"../chunks/metadata.js";import"../chunks/tracking.js";import"../chunks/watch.js";import"../core/scheduling.js";import"../chunks/nextTick.js";import"../chunks/shared.js";import"../chunks/SimpleObservable.js";import"../core/JSONSupport.js";import"../geometry/Geometry.js";import"../geometry/support/webMercatorUtils.js";import"../chunks/Ellipsoid.js";import"../core/accessorSupport/decorators/cast.js";import"../geometry.js";import"../geometry/Multipoint.js";import"../chunks/zmUtils.js";import"../geometry/Polygon.js";import"../chunks/extentUtils.js";import"../geometry/Polyline.js";import"../chunks/typeUtils.js";import"../chunks/jsonMap.js";import"../geometry/support/jsonUtils.js";import"../core/Identifiable.js";import"../core/Loadable.js";import"../core/Promise.js";import"./support/LOD.js";import"../chunks/jsonUtils.js";import"../chunks/parser.js";import"../chunks/colorUtils.js";import"../chunks/screenUtils.js";import"../chunks/mat4f32.js";import"../chunks/mat4.js";import"../chunks/common.js";import"../chunks/_commonjsHelpers.js";import"../chunks/commonProperties.js";import"../TimeExtent.js";import"../chunks/timeUtils.js";import"../chunks/persistableUrlUtils.js";import"../support/timeUtils.js";import"../chunks/ElevationInfo.js";import"./support/fieldUtils.js";import"../chunks/arcadeOnDemand.js";import"../chunks/unitConversionUtils.js";import"../chunks/lengthUtils.js";import"../chunks/unitUtils.js";import"../chunks/opacityUtils.js";import"../chunks/asyncUtils.js";import"../portal/Portal.js";import"../chunks/locale.js";import"../portal/PortalQueryParams.js";import"../portal/PortalQueryResult.js";import"../portal/PortalUser.js";import"../portal/PortalFolder.js";import"../portal/PortalGroup.js";import"../portal/PortalItem.js";import"../chunks/assets.js";import"../portal/PortalItemResource.js";import"../portal/PortalRating.js";import"../chunks/aaBoundingRect.js";import"../chunks/mathUtils.js";import"../chunks/vec3.js";import"../chunks/TileKey.js";import"./support/TileMatrixSet.js";import"./support/WMTSStyle.js";class A{constructor(e,t=0,r=e.lods.length-1){this.tileInfo=e,this.minLOD=t,this.maxLOD=r}getAvailability(e,t,r){const i=this.tileInfo?.lodAt(e);return!i||e<this.minLOD||e>this.maxLOD?"unavailable":i.cols&&i.rows?r>=i.cols[0]&&r<=i.cols[1]&&t>=i.rows[0]&&t<=i.rows[1]?"available":"unavailable":"available"}async fetchAvailability(e,t,r,i){return await l(i),this.getAvailability(e,t,r)}async fetchAvailabilityUpsample(e,t,r,i,s){await l(s),i.level=e,i.row=t,i.col=r;const o=this.tileInfo;for(o.updateTileInfo(i);;){const e=this.getAvailability(i.level,i.row,i.col);if("unavailable"!==e)return e;if(!o.upsampleTile(i))return"unavailable"}}}function V(e){const t=e.replace(/ows:/gi,"");if(!F("Contents",(new DOMParser).parseFromString(t,"text/xml").documentElement))throw new i("wmtslayer:wmts-capabilities-xml-is-not-valid","the wmts get capabilities response is not compliant",{text:e})}function _(e){return e.nodeType===Node.ELEMENT_NODE}function F(e,t){for(let r=0;r<t.childNodes.length;r++){const i=t.childNodes[r];if(_(i)&&i.nodeName===e)return i}return null}function N(e,t){const r=[];for(let i=0;i<t.childNodes.length;i++){const s=t.childNodes[i];_(s)&&s.nodeName===e&&r.push(s)}return r}function W(e,t){const r=[];for(let i=0;i<t.childNodes.length;i++){const s=t.childNodes[i];_(s)&&s.nodeName===e&&r.push(s)}return r.map((e=>e.textContent)).filter(o)}function D(e,t){return e.split(">").forEach((e=>{t&&(t=F(e,t))})),t&&t.textContent}function B(e,t,r,i){let s;return Array.prototype.slice.call(i.childNodes).some((i=>{if(i.nodeName.includes(e)){const e=F(t,i),o=e&&e.textContent;if(o===r||r.split(":")&&r.split(":")[1]===o)return s=i,!0}return!1})),s}function K(e,t){const r=[],i=e.layerMap?.get(t);if(!i)return null;const s=N("ResourceURL",i),o=N("Dimension",i);let a,n,l,c;return o.length&&(a=D("Identifier",o[0]),n=W("Default",o[0])||W("Value",o[0])),o.length>1&&(l=D("Identifier",o[1]),c=W("Default",o[1])||W("Value",o[1])),e.dimensionMap.set(t,{dimensions:n,dimensions2:c}),s.forEach((e=>{let t=e.getAttribute("template");if("tile"===e.getAttribute("resourceType")){if(a&&n.length)if(t.includes("{"+a+"}"))t=t.replace("{"+a+"}","{dimensionValue}");else{const e=t.toLowerCase().indexOf("{"+a.toLowerCase()+"}");e>-1&&(t=t.substring(0,e)+"{dimensionValue}"+t.substring(e+a.length+2))}if(l&&c.length)if(t.includes("{"+l+"}"))t=t.replace("{"+l+"}","{dimensionValue2}");else{const e=t.toLowerCase().indexOf("{"+l.toLowerCase()+"}");e>-1&&(t=t.substring(0,e)+"{dimensionValue2}"+t.substring(e+l.length+2))}r.push({template:t,format:e.getAttribute("format"),resourceType:"tile"})}})),r}function $(e){e=e.toLowerCase();let t=parseInt(e.split(":").pop(),10);900913!==t&&3857!==t||(t=102100);const r=function(e){return e.includes("crs84")||e.includes("crs:84")?q.CRS84:e.includes("crs83")||e.includes("crs:83")?q.CRS83:e.includes("crs27")||e.includes("crs:27")?q.CRS27:null}(e);return o(r)&&(t=r),{wkid:t}}function G(e,t){const r=$(t),[i,s]=D("TopLeftCorner",e).split(" ").map((e=>parseFloat(e))),o=t.includes("epsg")&&U(r.wkid);return new k(o?{x:s,y:i,spatialReference:r}:{x:i,y:s,spatialReference:r})}var q;function H(e,t,r,i,s){const o=$(t),a=D("Identifier",e);let n=parseFloat(D("ScaleDenominator",e));const l=J(o.wkid,n,i);n*=1.058267716535433;const c=+D("MatrixWidth",e),p=+D("MatrixHeight",e),{maxCol:m=c-1,maxRow:u=p-1,minCol:d=0,minRow:h=0}=s.get(a)??{},{x:f,y}=G(e,t);return{cols:[d,m],level:r,levelValue:a,origin:[f,y],scale:n,resolution:l,rows:[h,u]}}function J(e,t,r){let i;return i=E.hasOwnProperty(""+e)?E.values[E[e]]:"default028mm"===r?6370997*Math.PI/180:R(e).metersPerDegree,7*t/25e3/i}!function(e){e[e.CRS84=4326]="CRS84",e[e.CRS83=4269]="CRS83",e[e.CRS27=4267]="CRS27"}(q||(q={}));const z={"image/png":".png","image/png8":".png","image/png24":".png","image/png32":".png","image/jpg":".jpg","image/jpeg":".jpeg","image/gif":".gif","image/bmp":".bmp","image/tiff":".tif","image/jpgpng":"","image/jpegpng":"","image/unknown":""},Q=new Set(["version","service","request","layer","style","format","tilematrixset","tilematrix","tilerow","tilecol"]);let X=class extends(M(T(b(L(I(a(j))))))){constructor(...e){super(...e),this.copyright="",this.customParameters=null,this.customLayerParameters=null,this.fullExtent=null,this.operationalLayerType="WebTiledLayer",this.resourceInfo=null,this.serviceMode="RESTful",this.sublayers=null,this.type="wmts",this.version="1.0.0",this.addHandles([p((()=>this.activeLayer),((e,t)=>{t&&(t.layer=null),e&&(e.layer=this)}),u),m((()=>this.sublayers),"after-add",(({item:e})=>{e.layer=this}),u),m((()=>this.sublayers),"after-remove",(({item:e})=>{e.layer=null}),u),p((()=>this.sublayers),((e,t)=>{if(t)for(const e of t)e.layer=null;if(e)for(const t of e)t.layer=this}),u)])}normalizeCtorArgs(e,t){return"string"==typeof e?{url:e,...t}:e}load(e){if("KVP"===this.serviceMode||"RESTful"===this.serviceMode)return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["WMTS"]},e).catch(c).then((()=>this._fetchService(e))).catch((e=>{throw c(e),new i("wmtslayer:unsupported-service-data","Invalid response from the WMTS service.",{error:e})}))),Promise.resolve(this);console.error("WMTS mode could only be 'KVP' or 'RESTful'")}get activeLayer(){return this._get("activeLayer")}set activeLayer(e){this._set("activeLayer",e)}readActiveLayerFromService(e,t,r){this.activeLayer||(this.activeLayer=new C);let i=t.layers.find((e=>e.id===this.activeLayer.id));return i||(i=t.layers[0]),this.activeLayer.read(i,r),this.activeLayer}readActiveLayerFromItemOrWebDoc(e,t){const{templateUrl:r,wmtsInfo:i}=t,s=r?this._getLowerCasedUrlParams(r):null,o=i?.layerIdentifier;let a=null;const n=i?.tileMatrixSet;n&&(Array.isArray(n)?n.length&&(a=n[0]):a=n);const l=s?.format,c=s?.style;return new C({id:o,imageFormat:l,styleId:c,tileMatrixSetId:a})}writeActiveLayer(e,t,r,i){const s=this.activeLayer;t.templateUrl=this.getUrlTemplate(s.id,s.tileMatrixSetId,s.imageFormat,s.styleId);const o=n("tileMatrixSet.tileInfo",s);t.tileInfo=o?o.toJSON(i):null,t.wmtsInfo={...t.wmtsInfo,layerIdentifier:s.id,tileMatrixSet:s.tileMatrixSetId}}readCustomParameters(e,t){const r=t.wmtsInfo;return r?this._mergeParams(r.customParameters,r.url):null}get fullExtents(){return this.activeLayer.fullExtents}readServiceMode(e,t){return t.templateUrl.includes("?")?"KVP":"RESTful"}readSublayersFromService(e,t,r){const i=function(e,t){return e.map((e=>{const r=new C;return r.read(e,t),r}))}(t.layers,r);return i}get supportedSpatialReferences(){return this.activeLayer.tileMatrixSets?.map((e=>e.tileInfo?.spatialReference)).toArray().filter(o)??[]}get tilemapCache(){const e=this.activeLayer?.tileMatrixSet?.tileInfo;return e?new A(e):void 0}get title(){return this.activeLayer?.title??"Layer"}set title(e){this._overrideIfSome("title",e)}get url(){return this._get("url")}set url(e){e&&"/"===e.substr(-1)?this._set("url",e.slice(0,-1)):this._set("url",e)}createWebTileLayer(e){const t=this.getUrlTemplate(this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId),r=this._getTileMatrixSetById(e.tileMatrixSetId)?.tileInfo,i=e.fullExtent,s=new S({layerIdentifier:e.id,tileMatrixSet:e.tileMatrixSetId,url:this.url});return this.customLayerParameters&&(s.customLayerParameters=this.customLayerParameters),this.customParameters&&(s.customParameters=this.customParameters),new x({fullExtent:i,urlTemplate:t,tileInfo:r,wmtsInfo:s})}fetchTile(e,r,i){const s=this.getTileUrl(e,r,i);return t(s,{responseType:"image"}).then((e=>e.data))}async fetchImageBitmapTile(e,r,i){const s=this.getTileUrl(e,r,i),{data:o}=await t(s,{responseType:"blob"});return createImageBitmap(o)}findSublayerById(e){return this.sublayers?.find((t=>t.id===e))}getTileUrl(e,t,r){const i=this._getTileMatrixSetById(this.activeLayer.tileMatrixSetId)?.tileInfo?.lods[e],s=i?i.levelValue?i.levelValue:`${i.level}`:`${e}`;let o=this.resourceInfo?"":function(e,t,r,i,s,o,a,n){const l=function(e,t,r){const i=K(e,t),s=i?.filter((e=>e.format===r));return(s?.length?s:i)??[]}(e,t,i);if(!(l?.length>0))return"";const{dimensionMap:c}=e,p=c.get(t).dimensions?.[0],m=c.get(t).dimensions2?.[0];return l[a%l.length].template.replace(/\{Style\}/gi,s??"").replace(/\{TileMatrixSet\}/gi,r??"").replace(/\{TileMatrix\}/gi,o).replace(/\{TileRow\}/gi,""+a).replace(/\{TileCol\}/gi,""+n).replace(/\{dimensionValue\}/gi,p).replace(/\{dimensionValue2\}/gi,m)}({dimensionMap:this.dimensionMap,layerMap:this.layerMap},this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId,s,t,r);return o||(o=this.getUrlTemplate(this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId).replace(/\{level\}/gi,s).replace(/\{row\}/gi,`${t}`).replace(/\{col\}/gi,`${r}`)),o=this._appendCustomLayerParameters(o),o}getUrlTemplate(e,t,r,i){if(!this.resourceInfo){const r=function(e,t,r,i){const{dimensionMap:s}=e,o=K(e,t);let a="";if(o&&o.length>0){const e=s.get(t).dimensions&&s.get(t).dimensions[0],n=s.get(t).dimensions2&&s.get(t).dimensions2[0];a=o[0].template,a.indexOf(".xxx")===a.length-4&&(a=a.slice(0,a.length-4)),a=a.replace(/\{Style\}/gi,i),a=a.replace(/\{TileMatrixSet\}/gi,r),a=a.replace(/\{TileMatrix\}/gi,"{level}"),a=a.replace(/\{TileRow\}/gi,"{row}"),a=a.replace(/\{TileCol\}/gi,"{col}"),a=a.replace(/\{dimensionValue\}/gi,e),a=a.replace(/\{dimensionValue2\}/gi,n)}return a}({dimensionMap:this.dimensionMap,layerMap:this.layerMap},e,t,i);if(r)return r}if("KVP"===this.serviceMode)return this.url+"?SERVICE=WMTS&VERSION="+this.version+"&REQUEST=GetTile&LAYER="+e+"&STYLE="+i+"&FORMAT="+r+"&TILEMATRIXSET="+t+"&TILEMATRIX={level}&TILEROW={row}&TILECOL={col}";if("RESTful"===this.serviceMode){let s="";return z[r.toLowerCase()]&&(s=z[r.toLowerCase()]),this.url+e+"/"+i+"/"+t+"/{level}/{row}/{col}"+s}return""}async _fetchService(e){let t;if(this.resourceInfo)"KVP"===this.resourceInfo.serviceMode&&(this.url+=this.url.includes("?")?"":"?"),t={ssl:!1,data:this.resourceInfo};else try{t=await this._getCapabilities(this.serviceMode,e),V(t.data)}catch{const r="KVP"===this.serviceMode?"RESTful":"KVP";try{t=await this._getCapabilities(r,e),V(t.data),this.serviceMode=r}catch(e){throw new i("wmtslayer:unsupported-service-data","Services does not support RESTful or KVP service modes.",{error:e})}}var r;this.resourceInfo?t.data=((r=t.data).layers.forEach((e=>{e.tileMatrixSets?.forEach((e=>{const t=e.tileInfo;t&&96!==t.dpi&&(t.lods?.forEach((r=>{r.scale=96*r.scale/t.dpi,r.resolution=J(t.spatialReference?.wkid,90.71428571428571*r.scale/96,e.id)})),t.dpi=96)}))})),r):t.data=function(e,t){e=e.replace(/ows:/gi,"");const r=(new DOMParser).parseFromString(e,"text/xml").documentElement,s=new Map,o=new Map,a=F("Contents",r);if(!a)throw new i("wmtslayer:wmts-capabilities-xml-is-not-valid");const n=F("OperationsMetadata",r)?.querySelector("[name='GetTile']"),l=n?.getElementsByTagName("Get"),c=l&&Array.prototype.slice.call(l),p=t.url?.indexOf("https"),m=void 0!==p&&p>-1;let u,d,h=t.serviceMode,f=t?.url;if(c&&c.length&&c.some((e=>{const t=F("Constraint",e);return!t||B("AllowedValues","Value",h,t)?(f=e.attributes[0].nodeValue,!0):(!t||B("AllowedValues","Value","RESTful",t)||B("AllowedValues","Value","REST",t)?d=e.attributes[0].nodeValue:t&&!B("AllowedValues","Value","KVP",t)||(u=e.attributes[0].nodeValue),!1)})),!f)if(d)f=d,h="RESTful";else if(u)f=u,h="KVP";else{const e=F("ServiceMetadataURL",r);f=e?.getAttribute("xlink:href")}const y=f.indexOf("1.0.0/");-1===y&&"RESTful"===h?f+="/":y>-1&&(f=f.substring(0,y)),"KVP"===h&&(f+=y>-1?"":"?"),m&&(f=f.replace(/^http:/i,"https:"));const g=D("ServiceIdentification>ServiceTypeVersion",r),v=D("ServiceIdentification>AccessConstraints",r),j=v&&/^none$/i.test(v)?null:v,x=N("Layer",a),S=N("TileMatrixSet",a),M=x.map((e=>{const t=D("Identifier",e);return s.set(t,e),function(e,t,r,i,s){const o=D("Abstract",t),a=W("Format",t),n=function(e){const t=F("WGS84BoundingBox",e),r=t?D("LowerCorner",t).split(" "):["-180","-90"],i=t?D("UpperCorner",t).split(" "):["180","90"];return{xmin:parseFloat(r[0]),ymin:parseFloat(r[1]),xmax:parseFloat(i[0]),ymax:parseFloat(i[1]),spatialReference:{wkid:4326}}}(t),l=function(e){const t=[];return O(e,{BoundingBox:e=>{if(!e.getAttribute("crs"))return;const r=e.getAttribute("crs").toLowerCase(),i=$(r),s=r.includes("epsg")&&U(i.wkid);let o,a,n,l;O(e,{LowerCorner:e=>{[o,a]=e.textContent.split(" ").map((e=>Number.parseFloat(e))),s&&([o,a]=[a,o])},UpperCorner:e=>{[n,l]=e.textContent.split(" ").map((e=>Number.parseFloat(e))),s&&([n,l]=[l,n])}}),t.push({xmin:o,ymin:a,xmax:n,ymax:l,spatialReference:i})}}),t}(t),c=function(e,t){return N("Style",e).map((e=>{const r=F("LegendURL",e),i=F("Keywords",e),s=i?W("Keyword",i):[];let o=r&&r.getAttribute("xlink:href");return t&&(o=o&&o.replace(/^http:/i,"https:")),{abstract:D("Abstract",e),id:D("Identifier",e),isDefault:"true"===e.getAttribute("isDefault"),keywords:s,legendUrl:o,title:D("Title",e)}}))}(t,i),p=D("Title",t),m=function(e,t,r){return N("TileMatrixSetLink",t).map((t=>function(e,t,r){const i=F("TileMatrixSet",t).textContent,s=W("TileMatrix",t),o=r.find((e=>{const t=F("Identifier",e),r=t&&t.textContent;return!!(r===i||i.split(":")&&i.split(":")[1]===r)})),a=F("TileMatrixSetLimits",t),n=a&&N("TileMatrixLimits",a),l=new Map;if(n?.length)for(const e of n){const t=F("TileMatrix",e).textContent,r=+F("MinTileRow",e).textContent,i=+F("MaxTileRow",e).textContent,s=+F("MinTileCol",e).textContent,o=+F("MaxTileCol",e).textContent;l.set(t,{minCol:s,maxCol:o,minRow:r,maxRow:i})}const c=D("SupportedCRS",o).toLowerCase(),p=function(e,t){return G(F("TileMatrix",e),t)}(o,c),m=p.spatialReference,u=F("TileMatrix",o),d=[parseInt(D("TileWidth",u),10),parseInt(D("TileHeight",u),10)],h=[];s.length?s.forEach(((e,t)=>{const r=B("TileMatrix","Identifier",e,o);h.push(H(r,c,t,i,l))})):N("TileMatrix",o).forEach(((e,t)=>{h.push(H(e,c,t,i,l))}));const f=function(e,t,r,i,s){const o=F("BoundingBox",t);let a,n,l,c,p,m;if(o&&(a=D("LowerCorner",o).split(" "),n=D("UpperCorner",o).split(" ")),a&&a.length>1&&n&&n.length>1)l=parseFloat(a[0]),p=parseFloat(a[1]),c=parseFloat(n[0]),m=parseFloat(n[1]);else{const e=F("TileMatrix",t),o=parseInt(D("MatrixWidth",e),10),a=parseInt(D("MatrixHeight",e),10);l=r.x,m=r.y,c=l+o*i[0]*s.resolution,p=m-a*i[1]*s.resolution}return function(e,t,r){return"1.0.0"===e&&U(t.wkid)&&!(r.spatialReference.isGeographic&&r.x<-90&&r.y>=-90)}(e,r.spatialReference,r)?new w(p,l,m,c,r.spatialReference):new w(l,p,c,m,r.spatialReference)}(e,o,p,d,h[0]).toJSON(),y=new P({dpi:96,spatialReference:m,size:d,origin:p,lods:h}).toJSON();return{id:i,fullExtent:f,tileInfo:y}}(e,t,r)))}(s,t,r);return{id:e,fullExtent:n,fullExtents:l,description:o,formats:a,styles:c,title:p,tileMatrixSets:m}}(t,e,S,m,g)}));return{copyright:j,dimensionMap:o,layerMap:s,layers:M,serviceMode:h,tileUrl:f}}(t.data,{serviceMode:this.serviceMode,url:this.url}),t.data&&this.read(t.data,{origin:"service"})}async _getCapabilities(e,r){const i=this._getCapabilitiesUrl(e);return await t(i,{...r,responseType:"text"})}_getTileMatrixSetById(e){const t=this.findSublayerById(this.activeLayer.id)?.tileMatrixSets?.find((t=>t.id===e));return t}_appendCustomParameters(e){return this._appendParameters(e,this.customParameters)}_appendCustomLayerParameters(e){return this._appendParameters(e,{...s(this.customParameters),...this.customLayerParameters})}_appendParameters(e,t){const r=d(e),i={...r.query,...t},s=h(i);return""===s?r.path:`${r.path}?${s}`}_getCapabilitiesUrl(e){this.url=this.url.split("?")[0];const t="KVP"===e?`${this.url}?request=GetCapabilities&service=WMTS&version=${this.version}`:`${this.url}/${this.version}/WMTSCapabilities.xml`;return this._appendCustomParameters(t)}_getLowerCasedUrlParams(e){if(!e)return null;const t=d(e).query;if(!t)return null;const r={};return Object.keys(t).forEach((e=>{r[e.toLowerCase()]=t[e]})),r}_mergeParams(e,t){const r=this._getLowerCasedUrlParams(t);if(r){const t=Object.keys(r);t.length&&(e=e?s(e):{},t.forEach((t=>{e.hasOwnProperty(t)||Q.has(t)||(e[t]=r[t])})))}return e}};e([f()],X.prototype,"dimensionMap",void 0),e([f()],X.prototype,"layerMap",void 0),e([f({type:C,json:{origins:{"web-document":{write:{ignoreOrigin:!0}}}}})],X.prototype,"activeLayer",null),e([y("service","activeLayer",["layers"])],X.prototype,"readActiveLayerFromService",null),e([y(["web-document","portal-item"],"activeLayer",["wmtsInfo"])],X.prototype,"readActiveLayerFromItemOrWebDoc",null),e([v(["web-document","portal-item"],"activeLayer",{templateUrl:{type:String},tileInfo:{type:P},"wmtsInfo.layerIdentifier":{type:String},"wmtsInfo.tileMatrixSet":{type:String}})],X.prototype,"writeActiveLayer",null),e([f({type:String,value:"",json:{write:!0}})],X.prototype,"copyright",void 0),e([f({type:["show","hide"]})],X.prototype,"listMode",void 0),e([f({json:{read:!0,write:!0}})],X.prototype,"blendMode",void 0),e([f({json:{origins:{"web-document":{read:{source:["wmtsInfo.customParameters","wmtsInfo.url"]},write:{target:"wmtsInfo.customParameters"}},"portal-item":{read:{source:["wmtsInfo.customParameters","wmtsInfo.url"]},write:{target:"wmtsInfo.customParameters"}}}}})],X.prototype,"customParameters",void 0),e([y(["portal-item","web-document"],"customParameters")],X.prototype,"readCustomParameters",null),e([f({json:{origins:{"web-document":{read:{source:"wmtsInfo.customLayerParameters"},write:{target:"wmtsInfo.customLayerParameters"}},"portal-item":{read:{source:"wmtsInfo.customLayerParameters"},write:{target:"wmtsInfo.customLayerParameters"}}}}})],X.prototype,"customLayerParameters",void 0),e([f({type:w,json:{write:{ignoreOrigin:!0},origins:{"web-document":{read:{source:"fullExtent"}},"portal-item":{read:{source:"fullExtent"}}}}})],X.prototype,"fullExtent",void 0),e([f({readOnly:!0})],X.prototype,"fullExtents",null),e([f({type:["WebTiledLayer"]})],X.prototype,"operationalLayerType",void 0),e([f()],X.prototype,"resourceInfo",void 0),e([f()],X.prototype,"serviceMode",void 0),e([y(["portal-item","web-document"],"serviceMode",["templateUrl"])],X.prototype,"readServiceMode",null),e([f({type:r.ofType(C)})],X.prototype,"sublayers",void 0),e([y("service","sublayers",["layers"])],X.prototype,"readSublayersFromService",null),e([f({readOnly:!0})],X.prototype,"supportedSpatialReferences",null),e([f({readOnly:!0})],X.prototype,"tilemapCache",null),e([f({json:{read:{source:"title"}}})],X.prototype,"title",null),e([f({json:{read:!1},readOnly:!0,value:"wmts"})],X.prototype,"type",void 0),e([f({json:{origins:{service:{read:{source:"tileUrl"}},"web-document":{read:{source:"wmtsInfo.url"},write:{target:"wmtsInfo.url"}},"portal-item":{read:{source:"wmtsInfo.url"},write:{target:"wmtsInfo.url"}}}}})],X.prototype,"url",null),e([f()],X.prototype,"version",void 0),X=e([g("esri.layers.WMTSLayer")],X);const Y=X;export{Y as default};
