/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.25/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import r,{O as t,n as s,i}from"./Accessor.js";import{b as n}from"../chunks/maybe.js";import{clone as o,e as a}from"./lang.js";import{v as u,e as l}from"../chunks/get.js";import{g as c,m as f}from"../chunks/utils.js";import{o as g,a as p,b as d,subclass as m}from"./accessorSupport/decorators/subclass.js";import h from"./Error.js";import{L as O}from"../chunks/Logger.js";import"./Handles.js";import"../chunks/metadata.js";import"../chunks/object.js";import"../chunks/ArrayPool.js";import"../chunks/tracking.js";import"./accessorSupport/decorators/property.js";import"../chunks/ensureType.js";import"../chunks/watch.js";import"./scheduling.js";import"../chunks/nextTick.js";import"./promiseUtils.js";import"../config.js";import"../chunks/string.js";import"../chunks/handleUtils.js";class w{constructor(){this._values=new Map,this.multipleOriginsSupported=!1}clone(e){const r=new w;return this._values.forEach(((t,s)=>{e&&e.has(s)||r.set(s,o(t.value),t.origin)})),r}get(e,r){r=this._normalizeOrigin(r);const t=this._values.get(e);return null==r||t?.origin===r?t?.value:void 0}originOf(e){return this._values.get(e)?.origin??t.USER}keys(e){e=this._normalizeOrigin(e);const r=[...this._values.keys()];return null==e?r:r.filter((r=>this._values.get(r)?.origin===e))}set(e,r,s){if((s=this._normalizeOrigin(s))===t.DEFAULTS){const r=this._values.get(e);if(r&&null!=r.origin&&r.origin>s)return}this._values.set(e,new j(r,s))}delete(e,r){null!=(r=this._normalizeOrigin(r))&&this._values.get(e)?.origin!==r||this._values.delete(e)}has(e,r){return null!=(r=this._normalizeOrigin(r))?this._values.get(e)?.origin===r:this._values.has(e)}forEach(e){this._values.forEach((({value:r},t)=>e(r,t)))}_normalizeOrigin(e){if(null!=e)return e===t.DEFAULTS?e:t.USER}}class j{constructor(e,r){this.value=e,this.origin=r}}function y(e,r,s){r.keys().forEach((e=>{s.set(e,r.get(e),t.DEFAULTS)}));const i=e.metadatas;Object.keys(i).forEach((r=>{e.internalGet(r)&&s.set(r,e.internalGet(r),t.DEFAULTS)}))}function v(e,r,t){if(!e||!e.read||!1===e.read.enabled||!e.read.source)return!1;const s=e.read.source;if("string"==typeof s){if(s===r)return!0;if(s.includes(".")&&0===s.indexOf(r)&&l(s,t))return!0}else for(const e of s){if(e===r)return!0;if(e.includes(".")&&0===e.indexOf(r)&&l(e,t))return!0}return!1}function S(e,r,t,s,i){let n=g(r[t],i);(function(e){return e&&(!e.read||!1!==e.read.enabled&&!e.read.source)})(n)&&(e[t]=!0);for(const o of Object.getOwnPropertyNames(r))n=g(r[o],i),v(n,t,s)&&(e[o]=!0)}function N(e,r,t,s){const i=t.metadatas,n=p(i[r],"any",s),o=n&&n.default;if(void 0===o)return;const a="function"==typeof o?o.call(e,r,s):o;void 0!==a&&t.set(r,a)}const k={origin:"service"};function _(e,r,t=k){if(!r||"object"!=typeof r)return;const s=c(e),i=s.metadatas,n={};for(const e of Object.getOwnPropertyNames(r))S(n,i,e,r,t);s.setDefaultOrigin(t.origin);for(const o of Object.getOwnPropertyNames(n)){const n=g(i[o],t).read,a=n&&n.source;let l;l=a&&"string"==typeof a?u(r,a):r[o],n&&n.reader&&(l=n.reader.call(e,l,r,t)),void 0!==l&&s.set(o,l)}if(!t||!t.ignoreDefaults){s.setDefaultOrigin("defaults");for(const r of Object.getOwnPropertyNames(i))n[r]||N(e,r,s,t)}s.setDefaultOrigin("user")}function b(e,r,t,s=k){const i={...s,messages:[]};t(i),i.messages?.forEach((r=>{"warning"!==r.type||e.loaded?s&&s.messages&&s.messages.push(r):e.loadWarnings.push(r)}))}function E(e,r,t,s,i){const n={};return r.write?.writer?.call(e,s,n,t,i),n}function J(e,r,i,n,o,u){if(!n||!n.write)return!1;const l=e.get(i);if(!o&&n.write.overridePolicy){const r=n.write.overridePolicy.call(e,l,i,u);void 0!==r&&(o=r)}if(o||(o=n.write),!o||!1===o.enabled)return!1;if((null===l&&!o.allowNull&&!o.writerEnsuresNonNull||void 0===l)&&o.isRequired){const r=new h("web-document-write:property-required",`Missing value for required property '${i}' on '${e.declaredClass}'`,{propertyName:i,target:e});return r&&u&&u.messages?u.messages.push(r):r&&!u&&O.getLogger("esri.core.accessorSupport.write").error(r.name,r.message),!1}return!(void 0===l||null===l&&!o.allowNull&&!o.writerEnsuresNonNull||(!r.store.multipleOriginsSupported||r.store.originOf(i)===t.DEFAULTS)&&function(e,r,t,s,i){const n=s.default;if(void 0===n)return!1;if(null!=s.defaultEquals)return s.defaultEquals(i);if("function"==typeof n){if(Array.isArray(i)){const s=n.call(e,r,t);return a(s,i)}return!1}return n===i}(e,i,u,n,l)||!o.ignoreOrigin&&u&&u.origin&&r.store.multipleOriginsSupported&&r.store.originOf(i)<s(u.origin))}function D(e,r,t,s){const i=c(e),n=i.metadatas,o=d(n[r],s);return!!o&&J(e,i,r,o,t,s)}function P(e,r,t){if(e&&"function"==typeof e.toJSON&&(!e.toJSON.isDefaultToJSON||!e.write))return f(r,e.toJSON(t));const s=c(e),n=s.metadatas;for(const o in n){const a=d(n[o],t);if(!J(e,s,o,a,void 0,t))continue;const u=e.get(o),l=E(e,a,a.write&&"string"==typeof a.write.target?a.write.target:o,u,t);Object.keys(l).length>0&&(r=f(r,l),t?.resources?.pendingOperations?.length&&Promise.all(t.resources.pendingOperations).then((()=>f(r,l))),t&&t.writtenProperties&&t.writtenProperties.push({target:e,propName:o,oldOrigin:i(s.store.originOf(o)),newOrigin:t.origin}))}return r}const A=r=>{let t=class extends r{constructor(...e){super(...e);const r=n(c(this)),t=r.store,s=new w;r.store=s,y(r,t,s)}read(e,r){_(this,e,r)}write(e={},r){return P(this,e,r)}toJSON(e){return this.write({},e)}static fromJSON(e,r){return T.call(this,e,r)}};return t=e([m("esri.core.JSONSupport")],t),t.prototype.toJSON.isDefaultToJSON=!0,t};function T(e,r){if(!e)return null;if(e.declaredClass)throw new Error("JSON object is already hydrated");const t=new this;return t.read(e,r),t}function U(e){return e&&"read"in e&&"write"in e&&"toJSON"in e}let L=class extends(A(r)){};L=e([m("esri.core.JSONSupport")],L);export{L as JSONSupport,A as JSONSupportMixin,D as a,b,U as isJSONSupport,_ as r,y as s,P as w};
