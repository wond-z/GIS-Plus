// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../request ../../../core/maybe ../../../core/urlUtils ../../../geometry/support/jsonUtils ../../../geometry/support/normalizeUtils ../../operations/urlUtils ./pbfQueryUtils ./queryZScale".split(" "),function(g,r,x,e,t,y,z,A,B,C){function u(b,c){if(c&&"extent"===b.type)return`${b.xmin},${b.ymin},${b.xmax},${b.ymax}`;if(c&&"point"===b.type)return`${b.x},${b.y}`;b=b.toJSON();delete b.spatialReference;return JSON.stringify(b)}function v(b,
c){const d=b.geometry,a=b.toJSON();delete a.compactGeometryEnabled;delete a.defaultSpatialReferenceEnabled;let f,k,h;e.isSome(d)&&(k=d.spatialReference,h=d.spatialReference.wkid||JSON.stringify(d.spatialReference),a.geometryType=y.getJsonType(d),a.geometry=u(d,b.compactGeometryEnabled),a.inSR=h);a.groupByFieldsForStatistics&&(a.groupByFieldsForStatistics=a.groupByFieldsForStatistics.join(","));a.objectIds&&(a.objectIds=a.objectIds.join(","));a.orderByFields&&(a.orderByFields=a.orderByFields.join(","));
!a.outFields||!a.returnDistinctValues&&(c?.returnCountOnly||c?.returnExtentOnly||c?.returnIdsOnly)?delete a.outFields:a.outFields.includes("*")?a.outFields="*":a.outFields=a.outFields.join(",");a.outSR?(a.outSR=a.outSR.wkid||JSON.stringify(a.outSR),f=b.outSpatialReference):d&&(a.returnGeometry||a.returnCentroid)&&(a.outSR=a.inSR,f=k);a.returnGeometry&&delete a.returnGeometry;a.outStatistics&&(a.outStatistics=JSON.stringify(a.outStatistics));a.fullText&&(a.fullText=JSON.stringify(a.fullText));a.pixelSize&&
(a.pixelSize=JSON.stringify(a.pixelSize));a.quantizationParameters&&(b.defaultSpatialReferenceEnabled&&e.isSome(k)&&e.isSome(b.quantizationParameters)&&e.isSome(b.quantizationParameters.extent)&&k.equals(b.quantizationParameters.extent.spatialReference)&&delete a.quantizationParameters.extent.spatialReference,a.quantizationParameters=JSON.stringify(a.quantizationParameters));a.parameterValues&&(a.parameterValues=JSON.stringify(a.parameterValues));a.rangeValues&&(a.rangeValues=JSON.stringify(a.rangeValues));
a.dynamicDataSource&&(a.layer=JSON.stringify({source:a.dynamicDataSource}),delete a.dynamicDataSource);if(a.timeExtent){const {start:m,end:n}=a.timeExtent;if(null!=m||null!=n)a.time=m===n?m:`${null==m?"null":m},${null==n?"null":n}`;delete a.timeExtent}b.defaultSpatialReferenceEnabled&&e.isSome(k)&&e.isSome(f)&&k.equals(f)&&(a.defaultSR=a.inSR,delete a.inSR,delete a.outSR);return a}function p(){p=r._asyncToGenerator(function*(b,c,d,a){b=e.isSome(c.timeExtent)&&c.timeExtent.isEmpty?{data:{features:[]}}:
yield l(b,c,"json",a);C.applyFeatureSetZUnitScaling(c,d,b.data);return b});return p.apply(this,arguments)}function q(){q=r._asyncToGenerator(function*(b,c,d,a){if(e.isSome(c.timeExtent)&&c.timeExtent.isEmpty)return{data:d.createFeatureResult()};b=yield w(b,c,a);b.data=B.parsePBFFeatureQuery(b.data,d);return b});return q.apply(this,arguments)}function w(b,c,d){return l(b,c,"pbf",d)}function l(b,c,d,a={},f={}){const k="string"===typeof b?t.urlToObject(b):b;b=c.geometry?[c.geometry]:[];a.responseType=
"pbf"===d?"array-buffer":"json";return z.normalizeCentralMeridian(b,null,a).then(h=>{h=h&&h[0];e.isSome(h)&&(c=c.clone(),c.geometry=h);h=A.mapParameters({...k.query,f:d,...f,...v(c,f)});return x(t.join(k.path,"query"),{...a,query:{...h,...a.query}})})}g.encodeGeometry=u;g.executeQuery=function(b,c,d,a){return p.apply(this,arguments)};g.executeQueryForCount=function(b,c,d){return e.isSome(c.timeExtent)&&c.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):l(b,c,"json",d,{returnIdsOnly:!0,returnCountOnly:!0})};
g.executeQueryForExtent=function(b,c,d){return e.isSome(c.timeExtent)&&c.timeExtent.isEmpty?Promise.resolve({data:{count:0,extent:null}}):l(b,c,"json",d,{returnExtentOnly:!0,returnCountOnly:!0}).then(a=>{const f=a.data;if(f.hasOwnProperty("extent"))return a;if(f.features)throw Error("Layer does not support extent calculation.");if(f.hasOwnProperty("count"))throw Error("Layer does not support extent calculation.");return a})};g.executeQueryForIds=function(b,c,d){return e.isSome(c.timeExtent)&&c.timeExtent.isEmpty?
Promise.resolve({data:{objectIds:[]}}):l(b,c,"json",d,{returnIdsOnly:!0})};g.executeQueryPBF=function(b,c,d,a){return q.apply(this,arguments)};g.executeQueryPBFBuffer=w;g.queryToQueryStringParameters=v;g.runQuery=l;Object.defineProperties(g,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});