// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../chunks/_rollupPluginBabelHelpers ../geometry ../kernel ../request ../core/Error ../core/Logger ./knowledgeGraph/GraphQueryResult ./knowledgeGraph/GraphQueryStreamingResult ./knowledgeGraph/KnowledgeGraph ./knowledgeGraph/wasmInterface/knowledgeWasmAccess ./knowledgeGraph/wasmInterface/queryToWasmEncodedFactories ./knowledgeGraph/wasmInterface/updateToWasmEncodedFactories ./knowledgeGraph/wasmInterface/wasmToDataModelFactories ./knowledgeGraph/wasmInterface/wasmToQueryResponseObjFactories ./knowledgeGraph/wasmInterface/wasmToUpdateResponseFactories ../geometry/Geometry".split(" "),
function(n,k,ea,T,w,g,U,P,Q,V,p,q,t,W,X,Y,Z){function x(){x=k._asyncToGenerator(function*(a,b,c){const e=`${a.url}/graph/applyEdits`;yield y(a);c=yield z(e,c);c.data.body=yield aa(b,a);a=yield fetch(c.data.url,c.data);return ba(a)});return x.apply(this,arguments)}function A(){A=k._asyncToGenerator(function*(a,b,c){c=yield w(`${a.url}/graph/query`,{responseType:"array-buffer",query:{f:"pbf",openCypherQuery:b.openCypherQuery,...c?.query},signal:c?.signal,timeout:c?.timeout});const e=c.getHeader?.("content-type");
b=c.data;if(e?.includes("application/x-protobuf")){c=new ((yield p.getWasmInterface()).GraphQueryDecoder);c.deleteLater();if(a.dataModel)return new P({resultRows:B(c,b,a.dataModel)});throw new g("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model");}throw new g("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:e,data:c.data});});return A.apply(this,arguments)}function C(){C=k._asyncToGenerator(function*(a,
b,c){const e=`${a.url}/graph/query`;yield y(a);c=yield z(e,c);c.data.body=yield ca(b,a);b=yield fetch(c.data.url,c.data);if(a.dataModel)return new Q({resultRowsStream:yield R(b,a.dataModel)});throw new g("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model");});return C.apply(this,arguments)}function D(){D=k._asyncToGenerator(function*(a,b,c){var e=b.typeCategoryFilter;"entity"===b.typeCategoryFilter?e="entities":"relationship"===b.typeCategoryFilter&&(e="relationships");
c=yield w(`${a.url}/graph/search`,{responseType:"array-buffer",query:{f:"pbf",searchQuery:`"${b.searchQuery}"`,typeCategoryFilter:e,...c?.query},signal:c?.signal,timeout:c?.timeout});e=c.getHeader?.("content-type");b=c.data;if(e?.includes("application/x-protobuf")){c=new ((yield p.getWasmInterface()).GraphQueryDecoder);c.deleteLater();if(a.dataModel)return new P({resultRows:B(c,b,a.dataModel)});throw new g("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model");
}throw new g("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:e,data:c.data});});return D.apply(this,arguments)}function E(){E=k._asyncToGenerator(function*(a,b,c){const e=`${a.url}/graph/search`;yield y(a);c=yield z(e,c);c.data.body=yield da(b);b=yield fetch(c.data.url,c.data);if(a.dataModel)return new Q({resultRowsStream:yield R(b,a.dataModel)});throw new g("knowledge-graph:undefined-data-model","The KnowledgeGraph supplied did not have a data model");
});return E.apply(this,arguments)}function F(){F=k._asyncToGenerator(function*(a){a=new V({url:a});yield u(a);return a});return F.apply(this,arguments)}function u(a){return G.apply(this,arguments)}function G(){G=k._asyncToGenerator(function*(a){a.dataModel=yield S(a)});return G.apply(this,arguments)}function y(a){return H.apply(this,arguments)}function H(){H=k._asyncToGenerator(function*(a){T.id?.findCredential(a.url)||(a.dataModel?yield S(a):yield u(a))});return H.apply(this,arguments)}function v(a,
b,c){if(0!==a.error_code)throw new g(b,c,{errorCode:a.error_code,errorMessage:a.error_message});}function aa(a,b){return I.apply(this,arguments)}function I(){I=k._asyncToGenerator(function*(a,b){b.dataModel||(yield u(b));if(!b.dataModel)throw new g("knowledge-graph:data-model-undefined","Encoding could not proceed because a data model was not provided and it could not be determined from the service");const c=yield p.getWasmInterface(),e=a.options?.cascadeDelete?!0:!1,h=new c.GraphApplyEditsEncoder(!0,
b.dataModel.objectIdField,b.dataModel.globalIdField,c.SpatialReferenceUtil.WGS84(),a.options?.inputQuantizationParameters?t.inputQuantizationParemetersToWasmFormat(a.options?.inputQuantizationParameters):c.InputQuantizationUtil.WGS84_lossless());h.deleteLater();h.cascade_delete=e;try{let f;a.entityAdds?.forEach(d=>{f=h.add_entity(t.namedObjectToWasm(d,c));v(f,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - an entity failed to be added to the encoder")});a.relationshipAdds?.forEach(d=>
{if(!d.originId||!d.destinationId)throw new g("knowledge-graph:relationship-origin-destination-missing","When adding a new relationship, you must provide both an origin and destination globalid on the appropriate class property");b.dataModel?.originEntityGlobalIdField&&d.properties&&(d.properties[b.dataModel.originEntityGlobalIdField]=d.originId);b.dataModel?.destEntityGlobalIdField&&d.properties&&(d.properties[b.dataModel.destEntityGlobalIdField]=d.destinationId);f=h.add_relationship(t.namedObjectToWasm(d,
c));v(f,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - an relationship failed to be added to the encoder")});a.entityUpdates?.forEach(d=>{if(!d.id)throw new g("knowledge-graph:entity-id-missing","When updating an entity or relationship, you must specify the id on the class level property");b.dataModel?.globalIdField&&d.properties&&(d.properties[b.dataModel.globalIdField]=d.id);f=h.update_entity(t.namedObjectToWasm(d,c));v(f,"knowledge-graph:applyEdits-encoding-failed",
"Attempting to encode the applyEdits - an entity failed to be added to the encoder")});a.relationshipUpdates?.forEach(d=>{if(!d.id)throw new g("knowledge-graph:relationship-id-missing","When updating an entity or relationship, you must specify the id on the class level property");b.dataModel?.globalIdField&&d.properties&&(d.properties[b.dataModel.globalIdField]=d.id);b.dataModel?.originEntityGlobalIdField&&d.properties&&d.originId&&(d.properties[b.dataModel.originEntityGlobalIdField]=d.originId);
b.dataModel?.destEntityGlobalIdField&&d.properties&&d.destinationId&&(d.properties[b.dataModel.destEntityGlobalIdField]=d.destinationId);f=h.update_relationship(t.namedObjectToWasm(d,c));v(f,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits - a relationship failed to be added to the encoder")});a.entityDeletes?.forEach(d=>{if(!d.typeName)throw new g("knowledge-graph:no-type-name","You must indicate the entity/relationship named object type to apply edits - delete");
const l=h.make_delete_helper(d.typeName,!0);l.deleteLater();d.ids?.forEach(m=>{if("string"!==typeof m)throw new g("knowledge-graph:id-type-mismatch","All delete Ids must be globalIds for Enterprise 11.0 ArcGIS Knowledge Services");l.delete_by_globalid(m)})});a.relationshipDeletes?.forEach(d=>{if(!d.typeName)throw new g("knowledge-graph:no-type-name","You must indicate the entity/relationship named object type to apply edits - delete");const l=h.make_delete_helper(d.typeName,!1);d.ids?.forEach(m=>
{if("string"!==typeof m)throw new g("knowledge-graph:id-type-mismatch","All delete Ids must be globalIds for Enterprise 11.0 ArcGIS Knowledge Services");l.delete_by_globalid(m)})});h.encode()}catch(f){throw new g("knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits failed",{error:f});}a=h.get_encoding_result();v(a.error,"knowledge-graph:applyEdits-encoding-failed","Attempting to encode the applyEdits failed");return a.get_byte_buffer()});return I.apply(this,arguments)}
function ca(a,b){return J.apply(this,arguments)}function J(){J=k._asyncToGenerator(function*(a,b){const c=yield p.getWasmInterface(),e=new c.GraphQueryRequestEncoder;e.deleteLater();e.output_spatial_reference=c.SpatialReferenceUtil.WGS84();e.open_cypher_query=a.openCypherQuery;if(a.bindParameters)for(const [m,r]of Object.entries(a.bindParameters)){var h=m,f=r,d=e,l=c;null===f||void 0===f?d.set_param_key_value(h,""):"object"!==typeof f?d.set_param_key_value(h,f):f instanceof Date?d.set_param_key_value(h,
f):f instanceof Z?d.set_param_key_value(h,q.geometryToWasm(f,l)):f instanceof Array?d.set_param_key_value(h,q.bindParamArrayToWasm(f,l)):d.set_param_key_value(h,q.bindParamObjectToWasm(f,l))}if(a.bindGeometryQuantizationParameters)q.setInputQuantizationParametersOnEncoder(a.bindGeometryQuantizationParameters,e);else if(b.dataModel||(yield u(b)),4326===b.dataModel?.spatialReference?.wkid)e.input_quantization_parameters=c.InputQuantizationUtil.WGS84_lossless();else throw new g("knowledge-graph:SR-quantization-mismatch",
"If the DataModel indicates a coordinate system other than WGS84, inputQuantizationParameters must be provided to the query encoder");a.outputQuantizationParameters&&q.setOutputQuantizationParametersOnEncoder(a.outputQuantizationParameters,e,c);try{e.encode()}catch(m){throw new g("knowledge-graph:query-encoding-failed","Attempting to encode the query failed",{error:m});}a=e.get_encoding_result();if(0!==a.error.error_code)throw new g("knowledge-graph:query-encoding-failed","Attempting to encode the query failed",
{errorCode:a.error.error_code,errorMessage:a.error.error_message});return a.get_byte_buffer()});return J.apply(this,arguments)}function da(a){return K.apply(this,arguments)}function K(){K=k._asyncToGenerator(function*(a){const b=yield p.getWasmInterface(),c=new b.GraphSearchRequestEncoder;c.deleteLater();c.search_query=a.searchQuery;c.type_category_filter=b.esriNamedTypeCategory[a.typeCategoryFilter.toString()];!0===a.returnSearchContext&&(c.return_search_context=a.returnSearchContext);void 0!==a.start&&
0<a.start&&(c.start_index=a.start);void 0!==a.num&&(c.max_num_results=a.num);if(void 0!==a.globalIdsFilter&&Array.isArray(a.globalIdsFilter)&&0<a.globalIdsFilter.length)try{c.set_globalids_filter(q.bindParamArrayToWasm(a.globalIdsFilter,b))}catch(e){throw new g("knowledge-graph:globalIds-format-error","Attempting to set globalids filter failed.  This is usually caused by an incorrectly formatted UUID string",{error:e});}a.namedTypesFilter?.forEach(e=>{c.add_named_type_filter(e)});try{c.encode()}catch(e){throw new g("knowledge-graph:search-encoding-failed",
"Attempting to encode the search failed",{error:e});}a=c.get_encoding_result();if(0!==a.error.error_code)throw new g("knowledge-graph:search-encoding-failed","Attempting to encode the search failed",{errorCode:a.error.error_code,errorMessage:a.error.error_message});return a.get_byte_buffer()});return K.apply(this,arguments)}function z(a,b){return L.apply(this,arguments)}function L(){L=k._asyncToGenerator(function*(a,b){return w(a,{responseType:"native-request-init",method:"post",query:{f:"pbf",...b?.query},
body:"x",headers:{"Content-Type":"application/octet-stream"},signal:b?.signal,timeout:b?.timeout})});return L.apply(this,arguments)}function ba(a){return M.apply(this,arguments)}function M(){M=k._asyncToGenerator(function*(a){var b=a.headers.get("content-type");if(b?.includes("application/x-protobuf"))return a=yield a.arrayBuffer(),b=new ((yield p.getWasmInterface()).GraphApplyEditsDecoder),b.deleteLater(),b.decode(new Uint8Array(a)),Y.decoderToApplyEditsResponse(b);throw new g("knowledge-graph:unexpected-server-response",
"server returned an unexpected response",{responseType:b,data:a.text()});});return M.apply(this,arguments)}function B(a,b,c){a.push_buffer(new Uint8Array(b));b=[];let e=0;for(;a.next_row();){e||(e=a.get_header_keys().size());const h=Array(e);for(let f=0;f<e;f++){const d=a.get_value(f);h[f]=X.decodedWasmObjToQueryResponseObj(d,c)}b.push(h)}if(a.has_error())throw new g("knowledge-graph:stream-decoding-error","One or more result rows were not successfully decoded",{errorCode:a.error.error_code,errorMessage:a.error.error_message});
return b}function R(a,b){return N.apply(this,arguments)}function N(){N=k._asyncToGenerator(function*(a,b){const c=a.headers.get("content-type");a.headers.get("content-length")&&U.getLogger("esri.rest.knowledgeGraph.knowledgeGraphService").warnOnce("Found `Content-Length` header when expecting a streaming HTTP response! Please investigate whether all intermediate HTTP proxies and/or load balancers are configured such that they don't forcefully buffer the entire response before returning it to the client. A valid HTTP streaming response should use Chunked Transfer Encoding and not have a Content Length defined.");
if(c?.includes("application/x-protobuf")){const e=a.body?.getReader(),h=new ((yield p.getWasmInterface()).GraphQueryDecoder);h.deleteLater();return new ReadableStream({start(f){return k._asyncToGenerator(function*(){function d(){return e?.read().then(({done:l,value:m})=>{if(l){let r;h.has_error()&&(r=new g("knowledge-graph:stream-decoding-error","One or more result rows were not successfully decoded",{errorCode:h.error.error_code,errorMessage:h.error.error_message}));e.releaseLock();if(r)throw f.error(r),
r;f.close()}else return l=B(h,m,b),0<l.length&&f.enqueue(l),d()})}try{return d()}catch(l){e?.releaseLock(),f.error(new g("knowledge-graph:stream-decoding-error","The server returned a valid response, but there was an error decoding the response stream",{error:l})),f.close()}})()}})}throw new g("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:c,data:a.text()});});return N.apply(this,arguments)}function S(a){return O.apply(this,arguments)}function O(){O=
k._asyncToGenerator(function*(a){a=yield w(`${a.url}/dataModel/queryDataModel`,{responseType:"array-buffer",query:{f:"pbf"}});const b=a.getHeader?.("content-type"),c=a.data;if(b?.includes("application/x-protobuf"))return a=(yield p.getWasmInterface()).decode_data_model_from_protocol_buffer(new Uint8Array(c)),W.wasmToDataModel(a);throw new g("knowledge-graph:unexpected-server-response","server returned an unexpected response",{responseType:b,data:a.data});});return O.apply(this,arguments)}n.executeApplyEdits=
function(a,b,c){return x.apply(this,arguments)};n.executeQuery=function(a,b,c){return A.apply(this,arguments)};n.executeQueryStreaming=function(a,b,c){return C.apply(this,arguments)};n.executeSearch=function(a,b,c){return D.apply(this,arguments)};n.executeSearchStreaming=function(a,b,c){return E.apply(this,arguments)};n.fetchKnowledgeGraph=function(a){return F.apply(this,arguments)};n.refreshDataModel=u;Object.defineProperties(n,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});