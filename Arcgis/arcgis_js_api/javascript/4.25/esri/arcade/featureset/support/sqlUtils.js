// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define(["exports","./shared","../../../core/sql/WhereClause","./errorsupport","../../../chunks/datetime"],function(m,k,u,f,v){function t(b,a){return g(b?.parseTree,a,b?.parameters)}function g(b,a,c,d=null,e=null){switch(b.type){case "interval":return w(g(b.value,a,c,d,e),b.qualifier,b.op);case "case-expression":var h=" CASE ";"simple"===b.format&&(h+=g(b.operand,a,c,d,e));for(var l=0;l<b.clauses.length;l++)h+=" WHEN "+g(b.clauses[l].operand,a,c,d,e)+" THEN "+g(b.clauses[l].value,a,c,d,e);null!==b.else&&
(h+=" ELSE "+g(b.else,a,c,d,e));return h+" END ";case "parameter":d=c[b.value.toLowerCase()];if("string"===typeof d)return"'"+c[b.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(d instanceof Date)return q(d,a);if(d instanceof Array){b=[];for(c=0;c<d.length;c++)"string"===typeof d[c]?b.push("'"+d[c].toString().replace(/'/g,"''")+"'"):d[c]instanceof Date?b.push(q(d[c],a)):b.push(d[c].toString());return b}return d.toString();case "expression-list":h=[];for(l of b.value)h.push(g(l,a,c,d,e));
return h;case "unary-expression":return" ( NOT "+g(b.expr,a,c,d,e)+" ) ";case "binary-expression":switch(b.operator){case "AND":return" ("+g(b.left,a,c,d,e)+" AND "+g(b.right,a,c,d,e)+") ";case "OR":return" ("+g(b.left,a,c,d,e)+" OR "+g(b.right,a,c,d,e)+") ";case "IS":if("null"!==b.right.type)throw new f.SqlError(f.SqlErrorCodes.UnsupportedIsRhs);return" ("+g(b.left,a,c,d,e)+" IS NULL )";case "ISNOT":if("null"!==b.right.type)throw new f.SqlError(f.SqlErrorCodes.UnsupportedIsRhs);return" ("+g(b.left,
a,c,d,e)+" IS NOT NULL )";case "IN":h=[];if("expression-list"===b.right.type)return h=g(b.right,a,c,d,e)," ("+g(b.left,a,c,d,e)+" IN ("+h.join(",")+")) ";h=g(b.right,a,c,d,e);return h instanceof Array?" ("+g(b.left,a,c,d,e)+" IN ("+h.join(",")+")) ":" ("+g(b.left,a,c,d,e)+" IN ("+h+")) ";case "NOT IN":h=[];if("expression-list"===b.right.type)return h=g(b.right,a,c,d,e)," ("+g(b.left,a,c,d,e)+" NOT IN ("+h.join(",")+")) ";h=g(b.right,a,c,d,e);return h instanceof Array?" ("+g(b.left,a,c,d,e)+" NOT IN ("+
h.join(",")+")) ":" ("+g(b.left,a,c,d,e)+" NOT IN ("+h+")) ";case "BETWEEN":return h=g(b.right,a,c,d,e)," ("+g(b.left,a,c,d,e)+" BETWEEN "+h[0]+" AND "+h[1]+" ) ";case "NOTBETWEEN":return h=g(b.right,a,c,d,e)," ("+g(b.left,a,c,d,e)+" NOT BETWEEN "+h[0]+" AND "+h[1]+" ) ";case "LIKE":return""!==b.escape?" ("+g(b.left,a,c,d,e)+" LIKE "+g(b.right,a,c,d,e)+" ESCAPE '"+b.escape+"') ":" ("+g(b.left,a,c,d,e)+" LIKE "+g(b.right,a,c,d,e)+") ";case "NOT LIKE":return""!==b.escape?" ("+g(b.left,a,c,d,e)+" NOT LIKE "+
g(b.right,a,c,d,e)+" ESCAPE '"+b.escape+"') ":" ("+g(b.left,a,c,d,e)+" NOT LIKE "+g(b.right,a,c,d,e)+") ";case "\x3c\x3e":case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "\x3d":case "*":case "-":case "+":case "/":return" ("+g(b.left,a,c,d,e)+" "+b.operator+" "+g(b.right,a,c,d,e)+") "}throw new f.SqlError(f.SqlErrorCodes.UnsupportedOperator,{operator:b.operator});case "null":return"null";case "boolean":return!0===b.value?"1":"0";case "string":return"'"+b.value.toString().replace(/'/g,
"''")+"'";case "timestamp":return q(b.value,a);case "date":return q(b.value,a);case "number":return b.value.toString();case "current-time":return x("date"===b.mode,a);case "column-reference":return d&&d.toLowerCase()===b.column.toLowerCase()?"("+e+")":b.column;case "function":return c=g(b.args,a,c,d,e),y(b.name,c,a)}throw new f.SqlError(f.SqlErrorCodes.UnsupportedSyntax,{node:b.type});}function y(b,a,c){switch(b.toLowerCase().trim()){case "abs":if(1!==a.length)throw new f.SqlError(f.SqlErrorCodes.InvalidFunctionParameters,
{function:"abs"});return"abs("+a[0]+")";case "ceiling":case "ceil":if(1!==a.length)throw new f.SqlError(f.SqlErrorCodes.InvalidFunctionParameters,{function:"ceiling"});switch(c){case k.FeatureServiceDatabaseType.Standardised:case k.FeatureServiceDatabaseType.StandardisedNoInterval:return"CEILING("+a[0]+")";default:return"CEILING("+a[0]+")"}case "floor":if(1!==a.length)throw new f.SqlError(f.SqlErrorCodes.InvalidFunctionParameters,{function:"floor"});return"FLOOR("+a[0]+")";case "log":if(1!==a.length)throw new f.SqlError(f.SqlErrorCodes.InvalidFunctionParameters,
{function:"log"});return"LOG("+a[0]+")";case "log10":if(1!==a.length)throw new f.SqlError(f.SqlErrorCodes.InvalidFunctionParameters,{function:"log10"});return"LOG10("+a[0]+")";case "power":if(2!==a.length)throw new f.SqlError(f.SqlErrorCodes.InvalidFunctionParameters,{function:"power"});return"POWER("+a[0]+","+a[1]+")";case "round":if(2===a.length)return"ROUND("+a[0]+","+a[1]+")";if(1===a.length)return"ROUND("+a[0]+")";throw new f.SqlError(f.SqlErrorCodes.InvalidFunctionParameters,{function:"round"});
case "truncate":if(1>a.length||2<a.length)throw new f.SqlError(f.SqlErrorCodes.InvalidFunctionParameters,{function:"truncate"});switch(c){case k.FeatureServiceDatabaseType.SqlServer:return"ROUND("+a[0]+(1===a.length?"0":","+a[1])+",1)";default:return"TRUNCATE("+a[0]+(1===a.length?")":","+a[1]+")")}case "char_length":case "len":if(1!==a.length)throw new f.SqlError(f.SqlErrorCodes.InvalidFunctionParameters,{function:"char_length"});switch(c){case k.FeatureServiceDatabaseType.SqlServer:return"LEN("+
a[0]+")";case k.FeatureServiceDatabaseType.Oracle:return"LENGTH("+a[0]+")";default:return"CHAR_LENGTH("+a[0]+")"}case "concat":if(1>a.length)throw new f.SqlError(f.SqlErrorCodes.InvalidFunctionParameters,{function:"concat"});c="CONCAT(";for(b=0;b<a.length;b++)0!==b&&(c+=","),c+=a[b];return c+")";case "lower":case "lcase":if(1!==a.length)throw new f.SqlError(f.SqlErrorCodes.InvalidFunctionParameters,{function:"lower"});return"LOWER("+a[0]+")";case "upper":case "ucase":if(1!==a.length)throw new f.SqlError(f.SqlErrorCodes.InvalidFunctionParameters,
{function:"upper"});return"UPPER("+a[0]+")";case "substring":switch(b="",c){case k.FeatureServiceDatabaseType.Oracle:return b="SUBSTR("+a[0]+","+a[1],3===a.length&&(b+=","+a[2]),b+")";case k.FeatureServiceDatabaseType.SqlServer:return b=3===a.length?"SUBSTRING("+a[0]+","+a[1]+","+a[2]+")":"SUBSTRING("+a[0]+",  "+a[1]+", LEN("+a[0]+") - "+a[1]+")";default:return b="SUBSTRING("+a[0]+" FROM "+a[1],3===a.length&&(b+=" FOR "+a[2]),b+")"}case "extract":return"EXTRACT("+a[0].replace(/'/g,"")+" FROM "+a[1]+
")"}throw new f.SqlError(f.SqlErrorCodes.InvalidFunctionParameters,{function:b});}function q(b,a){b=b instanceof Date?v.DateTime.fromJSDate(b):v.DateTime.fromSQL(b);const c=0===b.hour&&0===b.minute&&0===b.second&&0===b.millisecond;switch(a){case k.FeatureServiceDatabaseType.FILEGDB:case k.FeatureServiceDatabaseType.Standardised:case k.FeatureServiceDatabaseType.StandardisedNoInterval:return c?`date '${b.toFormat("yyyy-LL-dd")}'`:`date '${b.toFormat("yyyy-LL-dd HH:mm:ss")}'`;case k.FeatureServiceDatabaseType.Oracle:return c?
`TO_DATE('${b.toFormat("yyyy-LL-dd")}','YYYY-MM-DD')`:`TO_DATE('${b.toFormat("yyyy-LL-dd HH:mm:ss")}','YYYY-MM-DD HH24:MI:SS')`;case k.FeatureServiceDatabaseType.SqlServer:return`'${b.toFormat(c?"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")}'`;case k.FeatureServiceDatabaseType.PGDB:return`#${b.toFormat(c?"LL-dd-yyyy":"LL-dd-yyyy HH:mm:ss")}#`;case k.FeatureServiceDatabaseType.Postgres:return`TIMESTAMP '${b.toFormat(c?"yyyy-LL-dd":"yyyy-LL-dd HH:mm:ss")}'`;default:return`date '${b.toFormat("yyyy-LL-dd HH:mm:ss")}'`}}
function x(b,a){switch(a){case k.FeatureServiceDatabaseType.FILEGDB:case k.FeatureServiceDatabaseType.Standardised:case k.FeatureServiceDatabaseType.StandardisedNoInterval:return b?"CURRENT_DATE":"CURRENT_TIMESTAMP";case k.FeatureServiceDatabaseType.Oracle:return b?"CURRENT_DATE":"CURRENT_TIMESTAMP";case k.FeatureServiceDatabaseType.SqlServer:return b?"CAST(GETDATE() AS DATE)":"GETDATE()";case k.FeatureServiceDatabaseType.PGDB:return b?"CURRENT_DATE":"CURRENT_TIMESTAMP";case k.FeatureServiceDatabaseType.Postgres:return b?
"CURRENT_DATE":"CURRENT_TIMESTAMP";default:return b?"CURRENT_DATE":"CURRENT_TIMESTAMP"}}function p(b,a,c,d){switch(a.type){case "interval":return"integer";case "case-expression":var e=[];if("simple"===a.format)for(var h=0;h<a.clauses.length;h++)e.push(p(b,a.clauses[h].value,c,d));else for(h=0;h<a.clauses.length;h++)e.push(p(b,a.else,c,d));null!==a.else&&e.push(p(b,a.else,c,d));return r(e);case "parameter":b=d[a.value.toLowerCase()];if(void 0===b&&c){a=c[a.value.toLowerCase()];if(void 0===a||null===
a)return"";if("string"===typeof a||a instanceof String)return"string";if("boolean"===typeof a)return"boolean";if(a instanceof Date)return"date";if("number"===typeof a)return 0===a%1?"integer":"double"}return void 0===b?"":b;case "expression-list":e=[];for(h of a.value)e.push(p(b,h,c,d));return e;case "unary-expression":return"boolean";case "binary-expression":switch(a.operator){case "AND":return"boolean";case "OR":return"boolean";case "IS":if("null"!==a.right.type)throw new f.SqlError(f.SqlErrorCodes.UnsupportedIsRhs);
return"boolean";case "ISNOT":if("null"!==a.right.type)throw new f.SqlError(f.SqlErrorCodes.UnsupportedIsRhs);return"boolean";case "IN":return"boolean";case "NOT IN":return"boolean";case "BETWEEN":return"boolean";case "NOTBETWEEN":return"boolean";case "LIKE":return"boolean";case "NOT LIKE":return"boolean";case "\x3c\x3e":case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "\x3d":return"boolean";case "*":case "-":case "+":case "/":return r([p(b,a.left,c,d),p(b,a.right,c,d)]);default:throw new f.SqlError(f.SqlErrorCodes.UnsupportedOperator,
{operator:a.operator});}case "null":return"";case "boolean":return"boolean";case "string":return"string";case "number":return null===a.value?"":0===a.value%1?"integer":"double";case "date":return"date";case "timestamp":return"date";case "current-time":return"date";case "column-reference":return a=b[a.column.toLowerCase()],void 0===a?"":a;case "function":switch(a.name.toLowerCase()){case "position":case "extract":case "char_length":return"integer";case "round":a=p(b,a.args,c,d);if(a instanceof Array){if(0<
a.length)return a[0];break}return a;case "sign":return a=p(b,a.args,c,d),a instanceof Array&&(a=r(a)),"integer"===a||"double"===a?a:"double";case "ceiling":case "floor":case "abs":return a=p(b,a.args,c,d),a instanceof Array?r(a):a;case "area":case "length":case "log":case "log10":case "sin":case "cos":case "tan":case "asin":case "acos":case "atan":case "power":return"double";case "substring":case "trim":case "concat":case "lower":case "upper":return"string";case "truncate":return"double"}return""}throw new f.SqlError(f.SqlErrorCodes.UnsupportedSyntax,
{node:a.type});}function r(b){if(b){let a="";for(const c of b)""!==c&&(a=""===a?c:z[a]<z[c]?c:a);return a}return""}function n(b,a){if(null===b||void 0===b)return!1;switch(b.type){case "when-clause":return n(b.operand,a)||n(b.value,a);case "case-expression":for(const c of b.clauses)if(n(c,a))return!0;if("simple"===b.format&&n(b.operand,a)||null!==b.else&&n(b.else,a))return!0;break;case "expression-list":for(const c of b.value)if(n(c,a))return!0;break;case "unary-expression":return n(b.expr,a);case "binary-expression":return n(b.left,
a)||n(b.right,a);case "column-reference":return a.toLowerCase()===b.column.toLowerCase();case "function":return n(b.args,a)}return!1}function w(b,a,c){let d="";d="interval-period"===a.type?""+a.period.toUpperCase():""+a.start.period.toUpperCase()+" TO "+a.end.period.toUpperCase();return"INTERVAL "+c+" "+b+" "+d}const z={boolean:1,string:2,integer:3,double:4,date:5};m.combine=function(b,a,c="AND"){return u.WhereClause.create("(("+t(b,k.FeatureServiceDatabaseType.Standardised)+")"+c+"("+t(a,k.FeatureServiceDatabaseType.Standardised)+
"))",b.fieldsIndex)};m.convertIntervalToSql=w;m.isSingleField=function(b){return"column-reference"===b?.parseTree.type};m.makeDateString=q;m.makeToday=x;m.predictType=function(b,a,c={}){const d={},e={},h={esriFieldTypeSmallInteger:"integer",esriFieldTypeInteger:"integer",esriFieldTypeSingle:"double",esriFieldTypeDouble:"double",esriFieldTypeString:"string",esriFieldTypeDate:"date",esriFieldTypeOID:"integer",oid:"integer",long:"integer","small-integer":"integer",integer:"integer",single:"double",double:"double",
date:"date",string:"string"};for(var l of a)a=l.type?h[l.type]:void 0,d[l.name.toLowerCase()]=void 0===a?"":a;for(const A in c)l=h[c[A]],e[A.toLowerCase()]=void 0===l?"":l;switch(p(d,b.parseTree,b.parameters,e)){case "double":return"double";case "integer":return"integer";case "date":return"date";case "string":return"string"}return""};m.reformulateWithoutField=function(b,a,c,d){return u.WhereClause.create(g(b.parseTree,k.FeatureServiceDatabaseType.Standardised,b.parameters,a,c),d)};m.scanForField=
function(b,a){return n(b.parseTree,a)};m.toWhereClause=t;m.toWhereClauseFromTree=function(b,a,c){return g(b,a,c)};m.translateFunctionToDatabaseSpecific=y;Object.defineProperties(m,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});