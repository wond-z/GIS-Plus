// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define(["../../../chunks/_rollupPluginBabelHelpers","../../../core/maybe"],function(p,n){return function(){function q(c,a){this._lastId=-1;this._progress=a;this._parent=c}var m=q.prototype;m.reset=function(){this._lastId=-1};m.nextBatch=function(c){if(null!==this._parent._mainSetInUse)return this._parent._mainSetInUse.then(e=>this.nextBatch(c),e=>this.nextBatch(c));var a=null,d=!1;const f=[];a=new Promise((e,g)=>{this._parent._getSet(this._progress).then(b=>{const h=n.unwrapOrThrow(b._known,"known");
var l=h.length-1;"GETPAGES"===h[h.length-1]&&--l;if(this._lastId+c>l&&0<h.length&&"GETPAGES"===h[h.length-1])this._parent._expandPagedSet(b,this._parent._maxQueryRate(),0,0,this._progress).then(k=>{d=!0;this._parent._mainSetInUse=null;this.nextBatch(c).then(e,g)},k=>{d=!0;this._parent._mainSetInUse=null;g(k)});else{var r=n.unwrapOrThrow(b._candidates,"candidates");if(l>=this._lastId+c||0===r.length){for(b=0;b<c;b++){l=b+this._lastId+1;if(l>=h.length)break;f[b]=h[l]}this._lastId+=f.length;0===f.length&&
(d=!0,this._parent._mainSetInUse=null,e([]));this._parent._getFeatureBatch(f,this._progress).then(k=>{d=!0;this._parent._mainSetInUse=null;e(k)},k=>{d=!0;this._parent._mainSetInUse=null;g(k)})}else this._parent._refineSetBlock(b,this._parent._maxProcessingRate(),this._progress).then(()=>{d=!0;this._parent._mainSetInUse=null;this.nextBatch(c).then(e,g)},k=>{d=!0;this._parent._mainSetInUse=null;g(k)})}},b=>{d=!0;this._parent._mainSetInUse=null;g(b)})});!1===d&&(this._parent._mainSetInUse=a,d=!0);return a};
m.next=function(){if(null!==this._parent._mainSetInUse)return this._parent._mainSetInUse.then(d=>this.next(),d=>this.next());var c=null,a=!1;c=new Promise((d,f)=>{this._parent._getSet(this._progress).then(e=>{const g=n.unwrapOrThrow(e._known,"known");this._lastId<g.length-1?"GETPAGES"===g[this._lastId+1]?this._parent._expandPagedSet(e,this._parent._maxQueryRate(),0,0,this._progress).then(b=>{a=!0;this._parent._mainSetInUse=null;return this.next()}).then(d,f):(this._lastId+=1,this._parent._getFeature(e,
g[this._lastId],this._progress).then(b=>{a=!0;this._parent._mainSetInUse=null;d(b)},b=>{a=!0;this._parent._mainSetInUse=null;f(b)})):0<n.unwrapOrThrow(e._candidates,"candidates").length?this._parent._refineSetBlock(e,this._parent._maxProcessingRate(),this._progress).then(()=>{a=!0;this._parent._mainSetInUse=null;this.next().then(d,f)},b=>{a=!0;this._parent._mainSetInUse=null;f(b)}):(a=!0,this._parent._mainSetInUse=null,d(null))},e=>{a=!0;this._parent._mainSetInUse=null;f(e)})});!1===a&&(this._parent._mainSetInUse=
c,a=!0);return c};m.count=function(){var c=p._asyncToGenerator(function*(){if(-1!==this._parent._totalCount)return this._parent._totalCount;var a=yield this._parent._getSet(this._progress);a=yield this._refineAllSets(a);this._parent._totalCount=a._known.length;return this._parent._totalCount});return function(){return c.apply(this,arguments)}}();m._refineAllSets=function(){var c=p._asyncToGenerator(function*(a){if(0<a._known.length&&"GETPAGES"===a._known[a._known.length-1])return yield this._parent._expandPagedSet(a,
this._parent._maxQueryRate(),0,1,this._progress),this._refineAllSets(a);if(0<a._candidates.length){if("GETPAGES"===a._known[a._candidates.length-1])return yield this._parent._expandPagedSet(a,this._parent._maxQueryRate(),0,2,this._progress),this._refineAllSets(a);a=yield this._parent._refineSetBlock(a,this._parent._maxProcessingRate(),this._progress);return 0<a._candidates.length?this._refineAllSets(a):a}return a});return function(a){return c.apply(this,arguments)}}();return q}()});