// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../Graphic ../../kernel ../support/errorsupport ../support/FeatureSet ../support/IdSet ../support/shared ../support/sqlUtils ../../../core/maybe ../../../core/sql/WhereClause ../../../geometry/SpatialReference".split(" "),function(u,t,G,H,r,z,y,v,q,w,A,I){let x=function(){function p(g){this.field=g;this.sqlRewritable=!1}p.prototype.postInitialization=function(g,n){};return p}(),B=function(p){function g(a){a=p.call(this,a)||this;a.sqlRewritable=
!0;return a}t._inheritsLoose(g,p);var n=g.prototype;n.extractValue=function(a){return a.attributes[this.field.name]};n.rewriteSql=function(a){return{rewritten:this.sqlRewritable,where:a}};return g}(x),D=function(p){function g(a,b,c){var e=p.call(this,v.cloneField(a))||this;e.originalField=a;e.sqlRewritable=!0;e.field.name=b;e.field.alias=c;return e}t._inheritsLoose(g,p);var n=g.prototype;n.rewriteSql=function(a,b){return{rewritten:this.sqlRewritable,where:q.reformulateWithoutField(a,this.field.name,
this.originalField.name,b.getFieldsIndex())}};n.extractValue=function(a){return a.attributes[this.originalField.name]};return g}(x),E=function(p){function g(a,b,c){a=p.call(this,a)||this;a.codefield=b;a.lkp=c;a.reverseLkp={};for(const e in c)a.reverseLkp[c[e]]=e;a.sqlRewritable=!0;return a}t._inheritsLoose(g,p);var n=g.prototype;n.rewriteSql=function(a,b){const c=this.evaluateNodeToWhereClause(a.parseTree,v.FeatureServiceDatabaseType.Standardised,this.field.name,this.codefield instanceof A.WhereClause?
q.toWhereClause(this.codefield,v.FeatureServiceDatabaseType.Standardised):this.codefield,a.parameters);return c.includes(g.BADNESS)?{rewritten:!1,where:a}:{rewritten:this.sqlRewritable,where:A.WhereClause.create(c,w.unwrapOrThrow(b._parent).getFieldsIndex())}};n.evaluateNodeToWhereClause=function(a,b,c=null,e=null,d){var f;switch(a.type){case "interval":return q.convertIntervalToSql(this.evaluateNodeToWhereClause(a.value,b,c,e,d),a.qualifier,a.op);case "case-expression":e=" CASE ";"simple"===a.format&&
(e+=this.evaluateNodeToWhereClause(a.operand,b,c,g.BADNESS,d));for(f=0;f<a.clauses.length;f++)e+=" WHEN "+this.evaluateNodeToWhereClause(a.clauses[f].operand,b,c,g.BADNESS,d)+" THEN "+this.evaluateNodeToWhereClause(a.clauses[f].value,b,c,g.BADNESS,d);null!==a.else&&(e+=" ELSE "+this.evaluateNodeToWhereClause(a.else,b,c,g.BADNESS,d));return e+" END ";case "parameter":c=d[a.value.toLowerCase()];if("string"===typeof c)return"'"+d[a.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(c instanceof
Date)return q.makeDateString(c,b);if(c instanceof Array){a=[];for(d=0;d<c.length;d++)"string"===typeof c[d]?a.push("'"+c[d].toString().replace(/'/g,"''")+"'"):c[d]instanceof Date?a.push(q.makeDateString(c[d],b)):a.push(c[d].toString());return a}return c.toString();case "expression-list":f=[];for(h of a.value)f.push(this.evaluateNodeToWhereClause(h,b,c,e,d));return f;case "unary-expression":return" ( NOT "+this.evaluateNodeToWhereClause(a.expr,b,c,g.BADNESS,d)+" ) ";case "binary-expression":switch(a.operator){case "AND":return" ("+
this.evaluateNodeToWhereClause(a.left,b,c,e,d)+" AND "+this.evaluateNodeToWhereClause(a.right,b,c,e,d)+") ";case "OR":return" ("+this.evaluateNodeToWhereClause(a.left,b,c,e,d)+" OR "+this.evaluateNodeToWhereClause(a.right,b,c,e,d)+") ";case "IS":if("null"!==a.right.type)throw new r.SqlError(r.SqlErrorCodes.UnsupportedIsRhs);return" ("+this.evaluateNodeToWhereClause(a.left,b,c,e,d)+" IS NULL )";case "ISNOT":if("null"!==a.right.type)throw new r.SqlError(r.SqlErrorCodes.UnsupportedIsRhs);return" ("+
this.evaluateNodeToWhereClause(a.left,b,c,e,d)+" IS NOT NULL )";case "IN":var h=[];if("expression-list"===a.right.type){if("column-reference"===a.left.type&&a.left.column.toUpperCase()===this.field.name.toUpperCase()){var l=[];h=!0;for(f of a.right.value)if("string"===f.type)if(void 0!==this.lkp[f.value])l.push(this.lkp[f.value].toString());else{h=!1;break}else{h=!1;break}if(h)return" ("+this.evaluateNodeToWhereClause(a.left,b,c,e,d)+" IN ("+l.join(",")+")) "}h=this.evaluateNodeToWhereClause(a.right,
b,c,e,d);return" ("+this.evaluateNodeToWhereClause(a.left,b,c,e,d)+" IN ("+h.join(",")+")) "}f=this.evaluateNodeToWhereClause(a.right,b,c,e,d);return f instanceof Array?" ("+this.evaluateNodeToWhereClause(a.left,b,c,e,d)+" IN ("+f.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(a.left,b,c,e,d)+" IN ("+f+")) ";case "NOT IN":h=[];if("expression-list"===a.right.type){if("column-reference"===a.left.type&&a.left.column.toUpperCase()===this.field.name.toUpperCase()){f=[];h=!0;for(l of a.right.value)if("string"===
l.type)if(void 0!==this.lkp[l.value])f.push(this.lkp[l.value].toString());else{h=!1;break}else{h=!1;break}if(h)return" ("+this.evaluateNodeToWhereClause(a.left,b,c,e,d)+" NOT IN ("+f.join(",")+")) "}h=this.evaluateNodeToWhereClause(a.right,b,c,e,d);return" ("+this.evaluateNodeToWhereClause(a.left,b,c,e,d)+" NOT IN ("+h.join(",")+")) "}f=this.evaluateNodeToWhereClause(a.right,b,c,e,d);return f instanceof Array?" ("+this.evaluateNodeToWhereClause(a.left,b,c,e,d)+" NOT IN ("+f.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(a.left,
b,c,e,d)+" NOT IN ("+f+")) ";case "BETWEEN":return e=this.evaluateNodeToWhereClause(a.right,b,c,g.BADNESS,d)," ("+this.evaluateNodeToWhereClause(a.left,b,c,g.BADNESS,d)+" BETWEEN "+e[0]+" AND "+e[1]+" ) ";case "NOTBETWEEN":return e=this.evaluateNodeToWhereClause(a.right,b,c,g.BADNESS,d)," ("+this.evaluateNodeToWhereClause(a.left,b,c,g.BADNESS,d)+" NOT BETWEEN "+e[0]+" AND "+e[1]+" ) ";case "LIKE":return""!==a.escape?" ("+this.evaluateNodeToWhereClause(a.left,b,c,g.BADNESS,d)+" LIKE "+this.evaluateNodeToWhereClause(a.right,
b,c,g.BADNESS,d)+" ESCAPE '"+a.escape+"') ":" ("+this.evaluateNodeToWhereClause(a.left,b,c,g.BADNESS,d)+" LIKE "+this.evaluateNodeToWhereClause(a.right,b,c,g.BADNESS,d)+") ";case "NOT LIKE":return""!==a.escape?" ("+this.evaluateNodeToWhereClause(a.left,b,c,g.BADNESS,d)+" NOT LIKE "+this.evaluateNodeToWhereClause(a.right,b,c,g.BADNESS,d)+" ESCAPE '"+a.escape+"') ":" ("+this.evaluateNodeToWhereClause(a.left,b,c,g.BADNESS,d)+" NOT LIKE "+this.evaluateNodeToWhereClause(a.right,b,c,g.BADNESS,d)+") ";case "\x3c\x3e":case "\x3d":if("column-reference"===
a.left.type&&"string"===a.right.type){if(a.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[a.right.value.toString()])return" ("+e+" "+a.operator+" "+this.lkp[a.right.value.toString()].toString()+") "}else if("column-reference"===a.right.type&&"string"===a.left.type&&a.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[a.right.value.toString()].toString()+" "+a.operator+" "+e+") ";return" ("+this.evaluateNodeToWhereClause(a.left,b,c,g.BADNESS,
d)+" "+a.operator+" "+this.evaluateNodeToWhereClause(a.right,b,c,g.BADNESS,d)+") ";case "\x3c":case "\x3e":case "\x3e\x3d":case "\x3c\x3d":case "*":case "-":case "+":case "/":return" ("+this.evaluateNodeToWhereClause(a.left,b,c,g.BADNESS,d)+" "+a.operator+" "+this.evaluateNodeToWhereClause(a.right,b,c,g.BADNESS,d)+") "}case "null":return"null";case "boolean":return!0===a.value?"1":"0";case "string":return"'"+a.value.toString().replace(/'/g,"''")+"'";case "timestamp":return q.makeDateString(a.value,
b);case "date":return q.makeDateString(a.value,b);case "number":return a.value.toString();case "current-time":return q.makeToday("date"===a.mode,b);case "column-reference":return c&&c.toLowerCase()===a.column.toLowerCase()?"("+e+")":a.column;case "function":return d=this.evaluateNodeToWhereClause(a.args,b,c,g.BADNESS,d),q.translateFunctionToDatabaseSpecific(a.name,d,b)}throw new r.SqlError(r.SqlErrorCodes.UnsupportedSyntax,{node:a.type});};n.extractValue=function(a){return this.codefield instanceof
A.WhereClause?this.reverseLkp[this.codefield.calculateValueCompiled(a)]:this.reverseLkp[a.attributes[this.codefield]]};return g}(x);E.BADNESS="_!!!_BAD_LKP_!!!!";let J=function(p){function g(a,b){a=p.call(this,a)||this;a._sql=b;return a}t._inheritsLoose(g,p);var n=g.prototype;n.rewriteSql=function(a,b){return{rewritten:!0,where:q.reformulateWithoutField(a,this.field.name,q.toWhereClause(this._sql,v.FeatureServiceDatabaseType.Standardised),b.getFieldsIndex())}};n.extractValue=function(a){return this._sql.calculateValueCompiled(a)};
return g}(x);z=function(p){function g(a){var b=p.call(this,a)||this;b._calcFunc=null;b.declaredClass="esri.arcade.featureset.actions.Adapted";b.adaptedFields=[];b._extraFilter=null;b._extraFilter=a.extraFilter;b._parent=a.parentfeatureset;b._maxProcessing=30;b.adaptedFields=a.adaptedFields;return b}t._inheritsLoose(g,p);g.findField=function(a,b){for(const c of a)if(c.name.toLowerCase()===b.toString().toLowerCase())return c;return null};var n=g.prototype;n._initialiseFeatureSet=function(){null!==this._parent?
(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new I({wkid:4326}),this.globalIdField=this.objectIdField="",this.geometryType=v.layerGeometryEsriConstants.point,this.typeIdField="",this.types=null);this.fields=
[];for(const a of this.adaptedFields)a.postInitialization(this,this._parent),this.fields.push(a.field)};n._getSet=function(){var a=t._asyncToGenerator(function*(b){if(null===this._wset){yield this._ensureLoaded();let c=null;c=this._extraFilter?yield this._getFilteredSet("",null,null,null,b):yield this._parent?._getSet(b);this._checkCancelled(b);w.assertIsSome(c);this._wset=new y(c._candidates.slice(0),c._known.slice(0),c._ordered,this._clonePageDefinition(c.pagesDefinition))}return this._wset});return function(b){return a.apply(this,
arguments)}}();n._isInFeatureSet=function(a){return w.unwrapOrThrow(this._parent)._isInFeatureSet(a)};n._getFeatures=function(){var a=t._asyncToGenerator(function*(b,c,e,d){var f=[];-1!==c&&void 0===this._featureCache[c]&&f.push(c);const h=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(b,h))return yield this._expandPagedSet(b,h,0,0,d),this._getFeatures(b,c,e,d);let l=0;for(let k=b._lastFetchedIndex;k<b._known.length&&!(l++,l<=e&&(b._lastFetchedIndex+=1),void 0===this._featureCache[b._known[k]]&&
(b._known[k]!==c&&f.push(b._known[k]),f.length>=h));k++);if(0===f.length)return"success";b=new y([],f,b._ordered,null);c=Math.min(f.length,e);yield this._parent?._getFeatures(b,-1,c,d);this._checkCancelled(d);b=[];for(d=0;d<c;d++)e=this._parent?._featureFromCache(f[d]),void 0!==e&&b.push({geometry:e.geometry,attributes:e.attributes,id:f[d]});for(const k of b){f=[];for(const m of this.adaptedFields)f[m.field.name]=m.extractValue(k);this._featureCache[k.id]=new G({attributes:f,geometry:H.cloneGeometry(k.geometry)})}return"success"});
return function(b,c,e,d){return a.apply(this,arguments)}}();n._fetchAndRefineFeatures=function(){var a=t._asyncToGenerator(function*(){throw new r.FeatureSetError(r.FeatureSetErrorCodes.NeverReach);});return function(){return a.apply(this,arguments)}}();n._getFilteredSet=function(){var a=t._asyncToGenerator(function*(b,c,e,d,f){let h=!1;var l=this._reformulateWithoutAdaptions(e);h=l.cannot;e=l.where;l=!1;if(null!==d){l=!0;const k=[];for(const m of this.adaptedFields)if(!(m instanceof B)&&!0===d.scanForField(m.field.name))if(m instanceof
D)k.push({field:m.field.name,newfield:m.originalField.name});else{d=null;l=!1;break}d&&0<k.length&&(d=d.replaceFields(k))}null!==e?null!==this._extraFilter&&(e=q.combine(this._extraFilter,e)):e=this._extraFilter;yield this._ensureLoaded();b=yield w.unwrapOrThrow(this._parent)._getFilteredSet(b,c,e,d,f);this._checkCancelled(f);return!0===h?new y(b._candidates.slice(0).concat(b._known.slice(0)),[],!0===l?b._ordered:!1,this._clonePageDefinition(b.pagesDefinition)):new y(b._candidates.slice(0),b._known.slice(0),
!0===l?b._ordered:!1,this._clonePageDefinition(b.pagesDefinition))});return function(b,c,e,d,f){return a.apply(this,arguments)}}();n._reformulateWithoutAdaptions=function(a){const b={cannot:!1,where:a};if(null!==a)for(const c of this.adaptedFields)if(!0===q.scanForField(a,c.field.name)){const e=c.rewriteSql(a,this);if(!0===e.rewritten)b.where=e.where;else{b.cannot=!0;b.where=null;break}}return b};n._stat=function(){var a=t._asyncToGenerator(function*(b,c,e,d,f,h,l){var k=!1;let m=this._reformulateWithoutAdaptions(c);
k=m.cannot;c=m.where;m=this._reformulateWithoutAdaptions(f);k=k||m.cannot;f=m.where;null!==f?null!==this._extraFilter&&(f=q.combine(this._extraFilter,f)):f=this._extraFilter;if(!0===k)return null===f&&""===e&&null===d?this._manualStat(b,c,h,l):{calculated:!1};k=yield w.unwrapOrThrow(this._parent)._stat(b,c,e,d,f,h,l);return!1===k.calculated?null===f&&""===e&&null===d?this._manualStat(b,c,h,l):{calculated:!1}:k});return function(b,c,e,d,f,h,l){return a.apply(this,arguments)}}();n._canDoAggregates=
function(){var a=t._asyncToGenerator(function*(b,c,e,d,f){if(null===this._parent)return!1;for(var h=0;h<b.length;h++)for(var l of this.adaptedFields)if(b[h].toLowerCase()===l.field.name.toLowerCase()&&!(l instanceof B))return!1;h=[];for(l=0;l<c.length;l++){var k=c[l];if(null!==k.workingexpr){const m=this._reformulateWithoutAdaptions(k.workingexpr);if(m.cannot)return!1;k=k.clone();k.workingexpr=m.where;h.push(k)}else h.push(k)}c=this._reformulateWithoutAdaptions(f);if(c.cannot)return!1;f=c.where;null!==
f?null!==this._extraFilter&&(f=q.combine(this._extraFilter,f)):f=this._extraFilter;return this._parent._canDoAggregates(b,h,e,d,f)});return function(b,c,e,d,f){return a.apply(this,arguments)}}();n._getAggregatePagesDataSourceDefinition=function(){var a=t._asyncToGenerator(function*(b,c,e,d,f,h,l){if(null===this._parent)throw new r.FeatureSetError(r.FeatureSetErrorCodes.NeverReach);const k=[];for(let C=0;C<c.length;C++){var m=c[C];if(null!==m.workingexpr){const F=this._reformulateWithoutAdaptions(m.workingexpr);
if(F.cannot)throw new r.FeatureSetError(r.FeatureSetErrorCodes.NeverReach);m=m.clone();m.workingexpr=F.where;k.push(m)}else k.push(m)}c=this._reformulateWithoutAdaptions(f);if(c.cannot)throw new r.FeatureSetError(r.FeatureSetErrorCodes.NeverReach);f=c.where;null!==f?null!==this._extraFilter&&(f=q.combine(this._extraFilter,f)):f=this._extraFilter;return this._parent._getAggregatePagesDataSourceDefinition(b,k,e,d,f,h,l)});return function(b,c,e,d,f,h,l){return a.apply(this,arguments)}}();return g}(z);
u.AdaptedFeatureSet=z;u.AdaptedField=x;u.FieldRename=D;u.OriginalField=B;u.SqlExpressionAdapted=J;u.StringToCodeAdapted=E;Object.defineProperties(u,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});