// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define(["../../../chunks/_rollupPluginBabelHelpers","../support/errorsupport","../support/FeatureSet","../support/IdSet","../support/shared"],function(k,q,r,p,g){return function(t){function m(b){var a=t.call(this,b)||this;a._topnum=0;a.declaredClass="esri.arcade.featureset.actions.Top";a._countedin=0;a._maxProcessing=100;a._topnum=b.topnum;a._parent=b.parentfeatureset;return a}k._inheritsLoose(m,t);var h=m.prototype;h._getSet=function(){var b=k._asyncToGenerator(function*(a){null===this._wset&&(yield this._ensureLoaded(),
a=yield this._parent._getSet(a),this._wset=new p(a._candidates.slice(0),a._known.slice(0),!1,this._clonePageDefinition(a.pagesDefinition)),this._setKnownLength(this._wset)>this._topnum&&(this._wset._known=this._wset._known.slice(0,this._topnum)),this._setKnownLength(this._wset)>=this._topnum&&(this._wset._candidates=[]));return this._wset});return function(a){return b.apply(this,arguments)}}();h._setKnownLength=function(b){return 0<b._known.length&&"GETPAGES"===b._known[b._known.length-1]?b._known.length-
1:b._known.length};h._isInFeatureSet=function(b){const a=this._parent._isInFeatureSet(b);if(a===g.IdState.NotInFeatureSet)return a;const c=this._idstates[b];return c===g.IdState.InFeatureSet||c===g.IdState.NotInFeatureSet?c:a===g.IdState.InFeatureSet&&void 0===c?this._countedin<this._topnum?(this._idstates[b]=g.IdState.InFeatureSet,this._countedin++,g.IdState.InFeatureSet):this._idstates[b]=g.IdState.NotInFeatureSet:g.IdState.Unknown};h._expandPagedSet=function(){var b=k._asyncToGenerator(function*(a,
c,e,f,d){if(null===this._parent)throw new q.FeatureSetError(q.FeatureSetErrorCodes.NotImplemented);c>this._topnum&&(c=this._topnum);if(this._countedin>=this._topnum&&a.pagesDefinition.internal.set.length<=a.pagesDefinition.resultOffset)return c=a._known.length,0<c&&"GETPAGES"===a._known[c-1]&&(a._known.length=c-1),c=a._candidates.length,0<c&&"GETPAGES"===a._candidates[c-1]&&(a._candidates.length=c-1),"success";c=yield this._parent._expandPagedSet(a,c,e,f,d);this._setKnownLength(a)>this._topnum&&(a._known.length=
this._topnum);this._setKnownLength(a)>=this._topnum&&(a._candidates.length=0);return c});return function(a,c,e,f,d){return b.apply(this,arguments)}}();h._getFeatures=function(){var b=k._asyncToGenerator(function*(a,c,e,f){const d=[],l=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(a,l))return yield this._expandPagedSet(a,l,0,0,f),this._getFeatures(a,c,e,f);-1!==c&&void 0===this._featureCache[c]&&d.push(c);let u=0;for(let n=a._lastFetchedIndex;n<a._known.length&&!(u++,u<=e&&(a._lastFetchedIndex+=
1),void 0===this._featureCache[a._known[n]]&&(a._known[n]!==c&&d.push(a._known[n]),d.length>l));n++);if(0===d.length)return"success";a=new p([],d,!1,null);e=Math.min(d.length,e);yield this._parent._getFeatures(a,-1,e,f);for(f=0;f<e;f++)a=this._parent._featureFromCache(d[f]),void 0!==a&&(this._featureCache[d[f]]=a);return"success"});return function(a,c,e,f){return b.apply(this,arguments)}}();h._getFilteredSet=function(){var b=k._asyncToGenerator(function*(a,c,e,f,d){yield this._ensureLoaded();a=yield this._getSet(d);
return new p(a._candidates.slice(0).concat(a._known.slice(0)),[],!1,this._clonePageDefinition(a.pagesDefinition))});return function(a,c,e,f,d){return b.apply(this,arguments)}}();h._refineKnowns=function(b,a){let c=0,e=null;const f=[];for(let d=0;d<b._candidates.length;d++){const l=this._isInFeatureSet(b._candidates[d]);if(l===g.IdState.InFeatureSet){if(b._known.push(b._candidates[d]),c+=1,null===e?e={start:d,end:d}:e.end===d-1?e.end=d:(f.push(e),e={start:d,end:d}),b._known.length>=this._topnum)break}else if(l===
g.IdState.NotInFeatureSet)null===e?e={start:d,end:d}:e.end===d-1?e.end=d:(f.push(e),e={start:d,end:d}),c+=1;else if(l===g.IdState.Unknown)break;if(c>=a)break}null!==e&&f.push(e);for(a=f.length-1;0<=a;a--)b._candidates.splice(f[a].start,f[a].end-f[a].start+1);this._setKnownLength(b)>this._topnum&&(b._known=b._known.slice(0,this._topnum));this._setKnownLength(b)>=this._topnum&&(b._candidates=[])};h._stat=function(){var b=k._asyncToGenerator(function*(){return{calculated:!1}});return function(){return b.apply(this,
arguments)}}();h._canDoAggregates=function(){var b=k._asyncToGenerator(function*(){return!1});return function(){return b.apply(this,arguments)}}();m.registerAction=function(){r._featuresetFunctions.top=function(b){return new m({parentfeatureset:this,topnum:b})}};return m}(r)});