// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../Graphic ../../../chunks/languageUtils ./Adapted ./AttributeFilter ./OrderBy ../support/FeatureSet ../support/IdSet ../support/OrderbyClause ../support/shared ../support/sqlUtils ../support/stats ../support/StatsField ../../../core/MD5 ../../../core/sql/WhereClause ../../../geometry/SpatialReference ../../../layers/support/Field ../../../layers/support/FieldsIndex ../support/errorsupport".split(" "),function(n,A,G,y,H,B,C,u,D,q,m,r,E,F,v,I,
z,J,p){function K(w){if(!w)return"COUNT";switch(w.toLowerCase()){case "max":return"MAX";case "var":case "variance":return"VAR";case "avg":case "average":case "mean":return"AVG";case "min":return"MIN";case "sum":return"SUM";case "stdev":case "stddev":return"STDDEV"}return"COUNT"}return function(w){function x(c){var a=w.call(this,c)||this;a._decodedStatsfield=[];a._decodedGroupbyfield=[];a._candosimplegroupby=!0;a.phsyicalgroupbyfields=[];a.objectIdField="ROW__ID";a._internalObjectIdField="ROW__ID";
a._adaptedFields=[];a.declaredClass="esri.arcade.featureset.actions.Aggregate";a._uniqueIds=1;a._maxQuery=10;a._maxProcessing=10;a._parent=c.parentfeatureset;a._config=c;return a}n._inheritsLoose(x,w);var k=x.prototype;k.isTable=function(){return!0};k._getSet=function(){var c=n._asyncToGenerator(function*(a){null===this._wset&&(this._wset=yield this._getFilteredSet("",null,null,null,a));return this._wset});return function(a){return c.apply(this,arguments)}}();k._isInFeatureSet=function(){return q.IdState.InFeatureSet};
k._nextUniqueName=function(c){for(;1===c["T"+this._uniqueIds.toString()];)this._uniqueIds++;const a="T"+this._uniqueIds.toString();c[a]=1;return a};k._convertToEsriFieldType=function(c){return c};k._initialiseFeatureSet=function(){const c={};var a=!1;let d=1;var b=this._parent?this._parent.getFieldsIndex():new J([]);this.objectIdField="ROW__ID";for(this.globalIdField="";!1===a;){let t=!1;for(var e=0;e<this._config.groupbyfields.length;e++)if(this._config.groupbyfields[e].name.toLowerCase()===this.objectIdField.toLowerCase()){t=
!0;break}if(!1===t)for(e=0;e<this._config.statsfields.length;e++)if(this._config.statsfields[e].name.toLowerCase()===this.objectIdField.toLowerCase()){t=!0;break}!1===t?a=!0:(this.objectIdField="ROW__ID"+d.toString(),d++)}for(var g of this._config.statsfields)a=new E,a.field=g.name,a.tofieldname=g.name,a.workingexpr=g.expression instanceof v.WhereClause?g.expression:v.WhereClause.create(g.expression,b),a.typeofstat=K(g.statistic),this._decodedStatsfield.push(a);this._decodedGroupbyfield=[];for(var f of this._config.groupbyfields)g=
{name:f.name,singlefield:null,tofieldname:f.name,expression:f.expression instanceof v.WhereClause?f.expression:v.WhereClause.create(f.expression,b)},this._decodedGroupbyfield.push(g);if(null!==this._parent){this.geometryType=this._parent.geometryType;this.spatialReference=this._parent.spatialReference;this.hasM=this._parent.hasM;this.hasZ=this._parent.hasZ;this.typeIdField="";for(const t of this._parent.fields)c[t.name.toUpperCase()]=1;this.types=null}else this.geometryType=q.layerGeometryEsriConstants.point,
this.typeIdField="",this.types=null,this.spatialReference=new I({wkid:4326});this.fields=[];b=new E;b.field=this._nextUniqueName(c);b.tofieldname=this.objectIdField;b.workingexpr=v.WhereClause.create(this._parent.objectIdField,this._parent.getFieldsIndex());b.typeofstat="MIN";this._decodedStatsfield.push(b);for(var h of this._decodedGroupbyfield){b=new z;h.name=this._nextUniqueName(c);b.name=h.tofieldname;b.alias=b.name;if(m.isSingleField(h.expression)){f=this._parent.getField(m.toWhereClause(h.expression,
q.FeatureServiceDatabaseType.Standardised));if(!f)throw new p.FeatureSetError(p.FeatureSetErrorCodes.AggregationFieldNotFound);h.name=f.name;h.singlefield=f.name;this.phsyicalgroupbyfields.push(f.name);b.type=f.type}else b.type=this._convertToEsriFieldType(m.predictType(h.expression,this._parent.fields)),f=new z,f.name=h.name,f.alias=f.name,this.phsyicalgroupbyfields.push(h.name),this._adaptedFields.push(new y.SqlExpressionAdapted(f,h.expression)),this._candosimplegroupby=!1;this.fields.push(b)}if(0<
this._adaptedFields.length)for(var l of this._parent.fields)this._adaptedFields.push(new y.OriginalField(l));for(h=0;h<this._decodedStatsfield.length;h++){l=new z;b=null;b=this._decodedStatsfield[h];b.field=this._nextUniqueName(c);b.tofieldname===this.objectIdField&&(this._internalObjectIdField=b.field);l.name=b.tofieldname;l.alias=l.name;b=null!==b.workingexpr?m.isSingleField(b.workingexpr)?m.toWhereClause(b.workingexpr,q.FeatureServiceDatabaseType.Standardised):"":"";switch(this._decodedStatsfield[h].typeofstat){case "SUM":if(""!==
b){b=this._parent.getField(b);if(!b)throw new p.FeatureSetError(p.FeatureSetErrorCodes.AggregationFieldNotFound);l.type=b.type}else l.type="double";break;case "MIN":case "MAX":if(""!==b){b=this._parent.getField(b);if(!b)throw new p.FeatureSetError(p.FeatureSetErrorCodes.AggregationFieldNotFound);l.type=b.type}else l.type="double";break;case "COUNT":l.type="integer";break;case "STDDEV":case "VAR":case "AVG":if(""!==b&&(b=this._parent.getField(b),!b))throw new p.FeatureSetError(p.FeatureSetErrorCodes.AggregationFieldNotFound);
l.type="double"}this.fields.push(l)}};k._canDoAggregates=function(){var c=n._asyncToGenerator(function*(){return!1});return function(){return c.apply(this,arguments)}}();k._getFeatures=function(){var c=n._asyncToGenerator(function*(a,d,b,e){const g=this._maxQuery;return!0===this._checkIfNeedToExpandKnownPage(a,g)?(yield this._expandPagedSet(a,g,0,0,e),this._getFeatures(a,d,b,e)):"success"});return function(a,d,b,e){return c.apply(this,arguments)}}();k._getFilteredSet=function(){var c=n._asyncToGenerator(function*(a,
d,b,e,g){if(""!==a)return new u([],[],!0,null);a=null;a=d=!1;yield this._ensureLoaded();if(null!==b)for(var f=0;f<this._decodedStatsfield.length;f++)if(!0===m.scanForField(b,this._decodedStatsfield[f].tofieldname)){a=!0;b=null;break}if(null!==e){d=!0;for(f=0;f<this._decodedStatsfield.length;f++)if(!0===e.scanForField(this._decodedStatsfield[f].tofieldname)){e=null;d=!1;break}if(null!==e)for(var h of this._decodedGroupbyfield)if(null===h.singlefield&&!0===e.scanForField(h.tofieldname)){e=null;d=!1;
break}}if(!1===this._candosimplegroupby?0:yield this._parent._canDoAggregates(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,null))return h=null,b&&(h=this._reformulateWhereClauseWithoutGroupByFields(b)),b=null,e&&(b=this._reformulateOrderClauseWithoutGroupByFields(e)),b=yield this._parent._getAggregatePagesDataSourceDefinition(this.phsyicalgroupbyfields,this._decodedStatsfield,"",null,h,b,this._internalObjectIdField),this._checkCancelled(g),a=!0===a?new u(b._candidates.slice(0).concat(b._known.slice(0)),
[],!0===d?b._ordered:!1,this._clonePageDefinition(b.pagesDefinition)):new u(b._candidates.slice(0),b._known.slice(0),!0===d?b._ordered:!1,this._clonePageDefinition(b.pagesDefinition));g=this._parent;0<this._adaptedFields.length&&(g=new y.AdaptedFeatureSet({parentfeatureset:this._parent,adaptedFields:this._adaptedFields,extraFilter:null}));!0===a?a=new u(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,
type:"manual",iterator:null,set:[],subfeatureset:new B({parentfeatureset:g,orderbyclause:new D(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}}):(null!==b&&(e=null,b&&(e=this._reformulateWhereClauseWithoutGroupByFields(b)),g=new H({parentfeatureset:g,whereclause:e})),a=new u(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:this._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new B({parentfeatureset:g,
orderbyclause:new D(this.phsyicalgroupbyfields.join(",")+","+this._parent.objectIdField+" ASC")})}}));return a});return function(a,d,b,e,g){return c.apply(this,arguments)}}();k._reformulateWhereClauseWithoutStatsFields=function(c){for(const a of this._decodedStatsfield)c=m.reformulateWithoutField(c,a.tofieldname,m.toWhereClause(a.workingexpr,q.FeatureServiceDatabaseType.Standardised),this._parent.getFieldsIndex());return c};k._reformulateWhereClauseWithoutGroupByFields=function(c){for(const a of this._decodedGroupbyfield)a.tofieldname!==
a.name&&(c=m.reformulateWithoutField(c,a.tofieldname,m.toWhereClause(a.expression,q.FeatureServiceDatabaseType.Standardised),this._parent.getFieldsIndex()));return c};k._reformulateOrderClauseWithoutGroupByFields=function(c){const a=[];for(const d of this._decodedGroupbyfield)d.tofieldname!==d.name&&a.push({field:d.tofieldname,newfield:d.name});return 0<a.length?c.replaceFields(a):c};k._clonePageDefinition=function(c){return null===c?null:!0===c.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,
resultRecordCount:c.resultRecordCount,resultOffset:c.resultOffset,internal:c.internal}:this._parent._clonePageDefinition(c)};k._refineSetBlock=function(){var c=n._asyncToGenerator(function*(a,d,b){if(!0===this._checkIfNeedToExpandCandidatePage(a,this._maxQuery))return yield this._expandPagedSet(a,this._maxQuery,0,0,b),this._refineSetBlock(a,d,b);this._checkCancelled(b);this._refineKnowns(a,d);return a});return function(a,d,b){return c.apply(this,arguments)}}();k._expandPagedSet=function(c,a,d,b,e){return this._expandPagedSetFeatureSet(c,
a,d,b,e)};k._getPhysicalPage=function(){var c=n._asyncToGenerator(function*(a,d,b){if(!0===a.pagesDefinition.aggregatefeaturesetpagedefinition)return this._sequentialGetPhysicalItem(a,a.pagesDefinition.resultRecordCount,b,[]);a=yield this._getAgregagtePhysicalPage(a,d,b);for(const e of a){d={geometry:e.geometry,attributes:{}};for(const g of this._decodedGroupbyfield)d.attributes[g.tofieldname]=e.attributes[g.name];for(const g of this._decodedStatsfield)d.attributes[g.tofieldname]=e.attributes[g.field];
this._featureCache[d.attributes[this.objectIdField]]=new A(d)}return a.length});return function(a,d,b){return c.apply(this,arguments)}}();k._sequentialGetPhysicalItem=function(c,a,d,b){return new Promise((e,g)=>{null===c.pagesDefinition.internal.iterator&&(c.pagesDefinition.internal.iterator=c.pagesDefinition.internal.subfeatureset.iterator(d));!0===c.pagesDefinition.internal.fullyResolved?e(b.length):0===a?e(b.length):this._nextAggregateItem(c,a,d,b,f=>{null===f?e(b.length):(--a,e(this._sequentialGetPhysicalItem(c,
a,d,b)))},g)})};k._nextAggregateItem=function(c,a,d,b,e,g){try{G.tick(c.pagesDefinition.internal.iterator.next()).then(f=>{if(null===f)null!==c.pagesDefinition.internal.workingItem&&(f=this._calculateAndAppendAggregateItem(c.pagesDefinition.internal.workingItem),b.push(f),c.pagesDefinition.internal.workingItem=null,c.pagesDefinition.internal.set.push(f.attributes[this.objectIdField])),c.pagesDefinition.internal.fullyResolved=!0,e(null);else{const h=this._generateAggregateHash(f);if(null===c.pagesDefinition.internal.workingItem)c.pagesDefinition.internal.workingItem=
{features:[f],id:h};else{if(h!==c.pagesDefinition.internal.workingItem.id){const l=this._calculateAndAppendAggregateItem(c.pagesDefinition.internal.workingItem);b.push(l);c.pagesDefinition.internal.workingItem=null;c.pagesDefinition.internal.set.push(l.attributes[this.objectIdField]);--a;c.pagesDefinition.internal.workingItem={features:[f],id:h};e(l);return}c.pagesDefinition.internal.workingItem.features.push(f)}this._nextAggregateItem(c,a,d,b,e,g)}},g)}catch(f){g(f)}};k._calculateFieldStat=function(c,
a,d){const b=[];for(let e=0;e<c.features.length;e++)if(null!==a.workingexpr){const g=a.workingexpr.calculateValue(c.features[e]);null!==g&&b.push(g)}else b.push(null);switch(a.typeofstat){case "MIN":d.attributes[a.tofieldname]=r.calculateStat("min",b,-1);break;case "MAX":d.attributes[a.tofieldname]=r.calculateStat("max",b,-1);break;case "SUM":d.attributes[a.tofieldname]=r.calculateStat("sum",b,-1);break;case "COUNT":d.attributes[a.tofieldname]=b.length;break;case "VAR":d.attributes[a.tofieldname]=
r.calculateStat("var",b,-1);break;case "STDDEV":d.attributes[a.tofieldname]=r.calculateStat("stddev",b,-1);break;case "AVG":d.attributes[a.tofieldname]=r.calculateStat("avg",b,-1)}return!0};k._calculateAndAppendAggregateItem=function(c){const a={attributes:{},geometry:null};for(var d of this._decodedGroupbyfield){var b=d.singlefield?c.features[0].attributes[d.singlefield]:d.expression.calculateValue(c.features[0]);a.attributes[d.tofieldname]=b}for(const e of this._decodedStatsfield)this._calculateFieldStat(c,
e,a);d=[];for(b=0;b<this._decodedStatsfield.length;b++)d.push(this._calculateFieldStat(c,this._decodedStatsfield[b],a));this._featureCache[a.attributes[this.objectIdField]]=new A({attributes:a.attributes,geometry:a.geometry});return a};k._generateAggregateHash=function(c){let a="";for(const d of this._decodedGroupbyfield){const b=d.singlefield?c.attributes[d.singlefield]:d.expression.calculateValue(c);a=null===b||void 0===b?a+":":a+(":"+b.toString())}return F.createMD5Hash(a,F.outputTypes.String)};
k._stat=function(){var c=n._asyncToGenerator(function*(){return{calculated:!1}});return function(){return c.apply(this,arguments)}}();k.getFeatureByObjectId=function(){var c=n._asyncToGenerator(function*(){return null});return function(){return c.apply(this,arguments)}}();x.registerAction=function(){C._featuresetFunctions.groupby=function(c,a){return new x({parentfeatureset:this,groupbyfields:c,statsfields:a})}};return x}(C)});