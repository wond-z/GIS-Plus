// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../lib/arcade-parser ./diagnosticMessages ./types ../lib/types".split(" "),function(q,v,w,g,k,f){function t(h,d){return d?h.replace(/\${(.*?)}/g,(a,b)=>d[b]?.toString()??""):h}function r(h){return!!h&&"dictionary"!==h.type}function n(h){return f.isEmptyStatement(h)||f.isBlockStatement(h)&&!h?.body.length}function x(h,d){if(!h||void 0===d||null===d||0>d)return null;let a=null;for(const b of h.overloads){const {min:c,max:e}=b.parametersInfo;if(d<
c)a=0<c?{code:g.DiagnosticCodes.NotEnoughArguments,data:{min:c}}:{code:g.DiagnosticCodes.NoArgumentExpected};else if(0<=e&&d>e)a={code:g.DiagnosticCodes.TooManyArguments,data:{max:e}};else return null}return a}let u=function(){function h(a,b=[]){this._apiDefinitions=a;this._profileVariables=b;this._recordIdentifierAssignment=this._isInBlock=!1;this._scriptScopeIdentifiers=new Map;this._diagnostics=[];this._undeclaredIdentifiersInFunctions=new Map}var d=h.prototype;d.validateScript=function(a){if(!a)return{diagnostics:[],
program:null};this._recordIdentifierAssignment=this._isInBlock=!1;this._diagnostics=[];this._scriptScopeIdentifiers.clear();this._undeclaredIdentifiersInFunctions.clear();this._functionScopeIdentifiers=void 0;let b=null;try{b=w.parse(a,{tolerant:!0}),this.handleErrors(b.errors),b.body.forEach(c=>this.validateStatement(c)),this.diagnoseIdentifiers(),0<this._undeclaredIdentifiersInFunctions.size&&this._undeclaredIdentifiersInFunctions.forEach(c=>{for(const e of c)this.logDiagnostic(e.node.loc,{code:g.DiagnosticCodes.NotDefined,
data:{identifier:e.node.name}})})}catch(c){this.handleException(c)}return{diagnostics:this._diagnostics,program:b}};d.recordIdentifierAssignment=function(a,b,c=!0){const e=this._recordIdentifierAssignment;this._recordIdentifierAssignment=c;a.call(this,b);this._recordIdentifierAssignment=e};d.inBlock=function(a,b){const c=this._isInBlock;this._isInBlock=!0;a.call(this,b);this._isInBlock=c};d.inFunctionScope=function(a){this._functionScopeIdentifiers=new Map;a.call(this);this.diagnoseIdentifiers();
this._functionScopeIdentifiers=void 0};d.logDiagnostic=function(a,b){a={severity:k.DiagnosticSeverity.Error,...b,message:t(g.DiagnosticMessages[b.code]??f.ParsingErrorMessages[b.code],b.data),range:{start:{line:a.start.line-1,character:a.start.column},end:{line:a.end.line-1,character:a.end.column}}};this._diagnostics.push(a)};d.handleErrors=function(a){(a??[]).forEach(this.handleException,this)};d.handleException=function(a){if("ParsingError"===a?.name){const {range:b,code:c,data:e}=a;this.logDiagnostic(b,
{code:c,data:e})}else this.logDiagnostic({start:{line:1,column:0},end:{line:1,column:0}},{code:g.DiagnosticCodes.ExecutionError,data:{stack:a.stack}})};d.getIdentifierInfo=function(a){return this._functionScopeIdentifiers?.get(a)??this._scriptScopeIdentifiers.get(a)};d.setIdentiferInfo=function(a,b){this._functionScopeIdentifiers?this._functionScopeIdentifiers.set(a,b):((this._functionScopeIdentifiers??this._scriptScopeIdentifiers).set(a,b),!this._functionScopeIdentifiers&&this._undeclaredIdentifiersInFunctions.has(a)&&
(this._undeclaredIdentifiersInFunctions.delete(a),b.used=!0))};d.isProfileVariable=function(a){return(this._profileVariables??[]).some(b=>b.name.toLowerCase()===a)};d.isApiItem=function(a){const b=!!this._apiDefinitions?.constantDefinitions?.get(a);a=!!this._apiDefinitions?.functionDefinitions?.get(a);return b||a};d.validateStatement=function(a){if(a)switch(a.type){case f.Syntax.BlockStatement:a.body.forEach(b=>this.validateStatement(b));break;case f.Syntax.VariableDeclaration:a.declarations.forEach(b=>
this.validateVariableDeclarator(b));break;case f.Syntax.FunctionDeclaration:this.validateFunctionDeclaration(a);break;case f.Syntax.ExportNamedDeclaration:this.validateExportDeclaration(a);break;case f.Syntax.ImportDeclaration:this.validateImportDeclaration(a);break;case f.Syntax.WhileStatement:this.validateWhileStatement(a);break;case f.Syntax.ForStatement:this.validateForStatement(a);break;case f.Syntax.ForInStatement:this.validateForInStatement(a);break;case f.Syntax.IfStatement:this.validateIfStatement(a);
break;case f.Syntax.ReturnStatement:this.validateExpression(a.argument);break;case f.Syntax.ExpressionStatement:this.validateExpression(a.expression)}};d.validateVariableDeclarator=function(a){this.validateExpression(a.init);this.recordVariableIdentifier(a.id,{initialized:!!a.init})};d.validateFunctionDeclaration=function(a){this.recordFunctionIdentifier(a);this.inFunctionScope(()=>{a.params.forEach(b=>this.recordParamAsIdentifier(b));n(a.body)&&this.logDiagnostic(a.body.loc,{code:g.DiagnosticCodes.UnexpectedEmptyFunction,
data:{identifier:a.id.name},severity:k.DiagnosticSeverity.Warning});this.validateStatement(a.body)})};d.validateExportDeclaration=function(a){this.validateStatement(a.declaration)};d.validateImportDeclaration=function(a){this.recordImportIdentifier(a)};d.validateForStatement=function(a){f.isVariableDeclaration(a.init)?this.inBlock(this.validateStatement,a.init):this.validateExpression(a.init);this.validateExpression(a.update);this.validateExpression(a.test);n(a.body)&&this.logDiagnostic(a.body.loc,
{code:g.DiagnosticCodes.EmptyBlockStatement,severity:k.DiagnosticSeverity.Warning});this.inBlock(this.validateStatement,a.body)};d.validateWhileStatement=function(a){this.validateExpression(a.test);n(a.body)&&this.logDiagnostic(a.body.loc,{code:g.DiagnosticCodes.EmptyBlockStatement,severity:k.DiagnosticSeverity.Warning});this.inBlock(this.validateStatement,a.body)};d.validateForInStatement=function(a){f.isIdentifier(a.left)?this.validateExpression(a.left):this.recordVariableIdentifier(a.left.declarations[0].id,
{initialized:!0,inBlock:!0});this.validateExpression(a.right);n(a.body)&&this.logDiagnostic(a.body.loc,{code:g.DiagnosticCodes.EmptyBlockStatement,severity:k.DiagnosticSeverity.Warning});this.validateStatement(a.body)};d.validateIfStatement=function(a){this.validateExpression(a.test);n(a.consequent)&&this.logDiagnostic(a.consequent.loc,{code:g.DiagnosticCodes.EmptyBlockStatement,severity:k.DiagnosticSeverity.Warning});a.alternate&&n(a.alternate)&&this.logDiagnostic(a.alternate.loc,{code:g.DiagnosticCodes.EmptyBlockStatement,
severity:k.DiagnosticSeverity.Warning});this.inBlock(this.validateStatement,a.consequent);this.inBlock(this.validateStatement,a.alternate)};d.validateExpression=function(a){if(a)switch(a.type){case f.Syntax.AssignmentExpression:this.validateAssignmentExpression(a);break;case f.Syntax.CallExpression:this.validateCallExpression(a);break;case f.Syntax.Identifier:this.validateIdentifier(a);break;case f.Syntax.ArrayExpression:a.elements.forEach(b=>this.validateExpression(b));break;case f.Syntax.ObjectExpression:this.validateObjectExpression(a);
break;case f.Syntax.UnaryExpression:this.validateUnaryExpression(a);break;case f.Syntax.UpdateExpression:this.validateUpdateExpression(a);break;case f.Syntax.BinaryExpression:case f.Syntax.LogicalExpression:this.validateBinaryAndLogicalExpression(a);break;case f.Syntax.MemberExpression:this.validateMemberExpression(a);break;case f.Syntax.TemplateLiteral:a.expressions.forEach(b=>this.validateExpression(b))}};d.validateAssignmentExpression=function(a){this.recordIdentifierAssignment(this.validateExpression,
a.left);this.validateExpression(a.right)};d.validateCallExpression=function(a){this.validateExpression(a.callee);if(f.isIdentifier(a.callee)){var b=a.callee.name.toLowerCase(),c=this.getIdentifierInfo(b);b=this._apiDefinitions?.functionDefinitions?.get(b);!c&&b&&(c=x(b,a.arguments.length))&&this.logDiagnostic(a.loc,c)}a.arguments.forEach(e=>this.validateExpression(e))};d.validateIdentifier=function(a){const b=a.name.toLowerCase();var c=this.getIdentifierInfo(b);c?this._recordIdentifierAssignment?
c.initialized=!0:c.used=!0:this.isProfileVariable(b)||this.isApiItem(b)||(this._isInFunctionScope?(c=this._undeclaredIdentifiersInFunctions.get(b),c||(c=[],this._undeclaredIdentifiersInFunctions.set(b,c)),c.push({node:a,identifier:b})):this.logDiagnostic(a.loc,{code:g.DiagnosticCodes.NotDefined,data:{identifier:a.name}}))};d.logProfileOrApiConflict=function(a){var b=a.name.toLowerCase();const c=this.isProfileVariable(b);b=this.isApiItem(b);(c||b)&&this.logDiagnostic(a.loc,{code:c?g.DiagnosticCodes.ProfileVariablesConflict:
g.DiagnosticCodes.ApiConflict,severity:k.DiagnosticSeverity.Warning,data:{identifier:a.name}})};d.validateObjectExpression=function(a){a.properties.forEach(b=>{this.validateExpression(b.value)})};d.validateUnaryExpression=function(a){this.validateExpression(a.argument)};d.validateUpdateExpression=function(a){this.validateExpression(a.argument)};d.validateBinaryAndLogicalExpression=function(a){this.validateExpression(a.left);this.validateExpression(a.right)};d.validateMemberExpression=function(a){a=
this.flattenMemberExpressionAndValidate(a);const b=a[0].object;this.recordIdentifierAssignment(this.validateExpression,b,!1);f.isIdentifier(b)&&(this.getIdentifierInfo(b.name.toLowerCase())||this.validateMemberExpressionWithProfile(a)||this.validateConstantMemberExpression(a))};d.flattenMemberExpressionAndValidate=function(a){switch(a.type){case f.Syntax.MemberExpression:return f.isIdentifier(a.property)&&!a.computed||this.validateExpression(a.property),[...this.flattenMemberExpressionAndValidate(a.object),
a];default:return[]}};d.extractAndValidatePropertyName=function(a){switch(a.type){case "Identifier":return a.name.toLowerCase();case "Literal":return"string"!==typeof a.value?(this.logDiagnostic(a.loc,{code:g.DiagnosticCodes.UnexpectedPropertyIdentifier}),null):a.value.toLowerCase();default:return this.logDiagnostic(a.loc,{code:g.DiagnosticCodes.UnexpectedPropertyIdentifier}),null}};d.validateConstantMemberExpression=function(a){const b=a[0];if(!f.isIdentifier(b.object))return!1;var c=b.object.name.toLowerCase();
const e=this._apiDefinitions?.constantDefinitions?.get(c);if(!e)return!1;if("namespace"!==e.type)return this.logDiagnostic(b.property.loc,{code:g.DiagnosticCodes.NotADictionary,data:{identifier:c}}),!0;const l=this.extractAndValidatePropertyName(b.property);if(!l)return!0;e.members.some(m=>m.key===l)||(c=e.members.reduce((m,p)=>`${m}${m?" | ":""}${p.completion.label.split(".").pop()}`,""),this.logDiagnostic(b.property.loc,{code:g.DiagnosticCodes.InvalidConstantIdentifier,data:{list:c}}));1<a.length&&
this.logDiagnostic(a[1].property.loc,{code:g.DiagnosticCodes.UnexpectedPropertyIdentifier});return!0};d.validateMemberExpressionWithProfile=function(a){var b=a[0];if(b.object.type!==f.Syntax.Identifier)return!1;const c=b.object.name.toLowerCase();var e=this._profileVariables?.find(l=>l.key===c);if(!e)return!1;if(r(e))return this.logDiagnostic(b.object.loc,{code:g.DiagnosticCodes.NotADictionary,data:{identifier:e.name}}),!0;if(this._recordIdentifierAssignment)return this.logDiagnostic(b.loc,{code:g.DiagnosticCodes.ProfileVariablesAreImmutable}),
!0;for(b=0;b<a.length&&!a[b].computed;b++){if(r(e)){this.logDiagnostic(a[b-1]?.property.loc??a[b].object.loc,{code:g.DiagnosticCodes.NotADictionary,data:{identifier:e.name}});break}const l=this.extractAndValidatePropertyName(a[b].property);if(!l)break;if(0===e.properties.length){this.logDiagnostic(a[b].property.loc,{code:g.DiagnosticCodes.UnknownPropertyIdentifier,data:{identifier:l},severity:k.DiagnosticSeverity.Warning});break}const m=e.properties.find(p=>p.name.toLowerCase()===l);if(!m){e=e.properties.reduce((p,
y)=>`${p}${p?" | ":""}${y.name.split(".").pop()}`,"");this.logDiagnostic(a[b].property.loc,{code:g.DiagnosticCodes.InvalidPropertyIdentifier,data:{list:e}});break}e=m}return!0};d.recordVariableIdentifier=function(a,b){this.logProfileOrApiConflict(a);const c=a.name.toLowerCase();let e=this.getIdentifierInfo(c);var l=e&&!this._isInFunctionScope&&"script"===e.scope;(e&&this._isInFunctionScope&&"function"===e.scope||l)&&this.logDiagnostic(a.loc,{code:g.DiagnosticCodes.AlreadyDefined,data:{identifier:a.name},
severity:k.DiagnosticSeverity.Warning});l=b.inBlock??this._isInBlock;({initialized:b}=b);!e||this._isInFunctionScope&&"function"!==e.scope?e={node:a,used:!1,initialized:b,scope:this._isInFunctionScope?"function":l?"block":"script"}:(e.node=a,e.used=!1,e.initialized=b);"block"!==e.scope||l||(e.scope="script",this.logDiagnostic(a.loc,{code:g.DiagnosticCodes.AlreadyDefined,data:{identifier:a.name},severity:k.DiagnosticSeverity.Warning}));this.setIdentiferInfo(c,e);return!1};d.recordImportIdentifier=
function(a){var b=a.specifiers[0].local;this.logProfileOrApiConflict(b);b=b.name.toLowerCase();let c=this.getIdentifierInfo(b);c?.scope&&this.logDiagnostic(a.specifiers[0].local.loc,{code:g.DiagnosticCodes.AlreadyDefined,data:{identifier:a.specifiers[0].local.name},severity:k.DiagnosticSeverity.Warning});c={node:a.specifiers[0].local,used:!1,...c,scope:"script",initialized:!0};this.setIdentiferInfo(b,c)};d.recordFunctionIdentifier=function(a){this.logProfileOrApiConflict(a.id);const b=a.id.name.toLowerCase();
let c=this.getIdentifierInfo(b);c?.scope&&this.logDiagnostic(a.id.loc,{code:g.DiagnosticCodes.AlreadyDefined,data:{identifier:a.id.name},severity:k.DiagnosticSeverity.Warning});c={node:a.id,used:!1,...c,scope:"script",initialized:!0};this.setIdentiferInfo(b,c)};d.recordParamAsIdentifier=function(a){return this.recordVariableIdentifier(a,{initialized:!0})};d.diagnoseIdentifiers=function(){(this._functionScopeIdentifiers??this._scriptScopeIdentifiers).forEach(a=>{a.node&&(a.used?a.initialized||this.logDiagnostic(a.node.loc,
{code:g.DiagnosticCodes.DefinedNeverAssigned,data:{identifier:a.node.name},severity:k.DiagnosticSeverity.Warning}):this.logDiagnostic(a.node.loc,{code:a.initialized?g.DiagnosticCodes.AssignedNeverUsed:g.DiagnosticCodes.DefinedNeverUsed,data:{identifier:a.node.name},severity:k.DiagnosticSeverity.Warning}))})};v._createClass(h,[{key:"_isInFunctionScope",get:function(){return!!this._functionScopeIdentifiers}}]);return h}();q.ArcadeValidationService=u;q.format=t;q.isValueVariable=r;q.validateScript=function(h,
d=[],a){return h?(new u(a,d)).validateScript(h):{diagnostics:[]}};Object.defineProperties(q,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});