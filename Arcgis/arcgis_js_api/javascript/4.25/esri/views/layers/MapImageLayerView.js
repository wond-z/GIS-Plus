// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("require ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../symbols ../../core/Error ../../core/has ../../core/MapUtils ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/unitUtils ../../core/accessorSupport/decorators/property ../../core/arrayUtils ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ../../geometry/Extent ../../geometry/support/scaleUtils ../../layers/support/commonProperties ../../layers/support/ExportImageParameters ../../layers/support/floorFilterUtils ../../renderers/support/clickToleranceUtils ../../rest/identify ../../rest/support/IdentifyParameters ../../support/arcadeOnDemand ../../support/GraphicsCollection ./support/popupUtils ../../symbols/SimpleMarkerSymbol".split(" "),
function(E,m,t,V,A,F,G,v,B,H,I,u,W,X,J,K,L,M,N,O,C,P,Q,R,S,D,T){let y=null;return q=>{q=function(z){function x(){var f=z.apply(this,arguments)||this;f._featuresResolutions=new WeakMap;f.highlightGraphics=new S.GraphicsCollection;f.updateHighlightedFeatures=B.debounce(function(){var b=m._asyncToGenerator(function*(a){f.destroyed||f.updatingHandles.addPromise(f._updateHighlightedFeaturesGeometries(a).catch(()=>{}))});return function(a){return b.apply(this,arguments)}}());return f}m._inheritsLoose(x,
z);var n=x.prototype;n.initialize=function(){this.exportImageParameters=new N.ExportImageParameters({layer:this.layer});this.handles.add([H.on(()=>this.highlightGraphics,"change",f=>{this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(f.added).catch(()=>{}));this.updateHighlightedFeatures(this._highlightGeometriesResolution)})])};n.destroy=function(){this.exportImageParameters.destroy();this.exportImageParameters=null};n.fetchPopupFeatures=function(){var f=m._asyncToGenerator(function*(b,
a){const {layer:e}=this;if(!b)throw new A("mapimagelayer:fetchPopupFeatures","Nothing to fetch without area",{layer:e});const g=this.layer.capabilities?.operations?.supportsQuery??!0;if(!((this.layer.capabilities?.operations?.supportsIdentify??!0)&&10.5<=this.layer.version||g))throw new A("mapimagelayer:fetchPopupFeatures-not-supported","query operation is disabled for this service",{layer:e});return g?this._fetchPopupFeaturesUsingQueries(b,a):this._fetchPopupFeaturesUsingIdentify(b,a)});return function(b,
a){return f.apply(this,arguments)}}();n.canResume=function(){return!z.prototype.canResume.call(this)||this.timeExtent?.isEmpty?!1:!0};n._updateHighlightedFeaturesSymbols=function(){var f=m._asyncToGenerator(function*(b){var a=this;for(const e of b){const g="renderer"in e.sourceLayer&&e.sourceLayer.renderer;"geometryType"in e.sourceLayer&&"point"===e.sourceLayer.geometryType&&g&&"getSymbolAsync"in g&&g.getSymbolAsync(e).then(function(){var l=m._asyncToGenerator(function*(d){let c="width"in d&&"height"in
d&&null!=d.width&&null!=d.height?Math.max(d.width,d.height):"size"in d?d.size:null;const k="visualVariables"in g&&g.visualVariables?.find(h=>"size"===h.type);k&&(y||(y=(yield new Promise((h,p)=>E(["../../renderers/visualVariables/support/visualVariableUtils"],h,p))).getSize),c=y(k,e,{view:a.view.type,scale:a.view.scale,shape:"simple-marker"===d.type?d.style:null}));a.highlightGraphics.includes(e)&&(e.symbol=new T({style:"square",size:c,xoffset:"xoffset"in d?d.xoffset:0,yoffset:"yoffset"in d?d.yoffset:
0}),e.visible=!0,a.highlightGraphicUpdated(e,"symbol"))});return function(d){return l.apply(this,arguments)}}())}});return function(b){return f.apply(this,arguments)}}();n._updateHighlightedFeaturesGeometries=function(){var f=m._asyncToGenerator(function*(b){this._highlightGeometriesResolution=b;var a=this.highlightGraphics;if(a.length&&this.layer.capabilities.operations.supportsQuery){var e=this._getTargetResolution(b);b=new Map;for(const g of a)(!this._featuresResolutions.has(g)||this._featuresResolutions.get(g)>
e)&&G.getOrCreateMapValue(b,g.sourceLayer,()=>new Map).set(g.getObjectId(),g);a=Array.from(b,([g,l])=>{const d=g.createQuery();d.objectIds=[...l.keys()];d.outFields=[g.objectIdField];d.returnGeometry=!0;d.maxAllowableOffset=e;d.outSpatialReference=this.view.spatialReference;return g.queryFeatures(d)});a=yield Promise.all(a);if(!this.destroyed)for(const {features:g}of a)for(const l of g)(a=b.get(l.sourceLayer).get(l.getObjectId()))&&this.highlightGraphics.includes(a)&&(a.geometry=l.geometry,this.highlightGraphicUpdated(a,
"geometry"),this._featuresResolutions.set(a,e))}});return function(b){return f.apply(this,arguments)}}();n._getTargetResolution=function(f){const b=f*I.getMetersPerUnitForSR(this.view.spatialReference),a=b/16;return 10>=a?0:f/b*a};n._fetchPopupFeaturesUsingIdentify=function(){var f=m._asyncToGenerator(function*(b,a){b=yield this._createIdentifyParameters(b,a);if(v.isNone(b))return[];({results:b}=yield P.identify(this.layer.parsedUrl,b));return b.map(e=>e.feature)});return function(b,a){return f.apply(this,
arguments)}}();n._createIdentifyParameters=function(){var f=m._asyncToGenerator(function*(b,a){const {floors:e,spatialReference:g,scale:l}=this.view,d=v.isSome(a)?a.event:null;a=yield this._collectPopupProviders(this.layer.sublayers,l,a);if(!a.length)return null;yield Promise.all(a.map(({sublayer:p})=>p.load().catch(()=>{})));a=Math.min(F("mapimagelayer-popup-identify-max-tolerance"),this.layer.allSublayers.reduce((p,r)=>r.renderer?C.calculateTolerance({renderer:r.renderer,event:d}):p,2));var c=this.createFetchPopupFeaturesQueryGeometry(b,
a);const k=L.getResolutionForScale(l,g),h=Math.round(c.width/k);c=new K({xmin:c.center.x-k*h,ymin:c.center.y-k*h,xmax:c.center.x+k*h,ymax:c.center.y+k*h,spatialReference:c.spatialReference});return new Q({floors:e,gdbVersion:this.layer.gdbVersion,geometry:b,height:h,layerOption:"popup",mapExtent:c,returnGeometry:!0,spatialReference:g,sublayers:this.layer.sublayers,timeExtent:this.timeExtent,tolerance:a,width:h})});return function(b,a){return f.apply(this,arguments)}}();n._fetchPopupFeaturesUsingQueries=
function(){var f=m._asyncToGenerator(function*(b,a){var e=this;const g=yield this._collectPopupProviders(this.layer.sublayers,this.view.scale,a),l=v.isSome(a)?a.event:null;a=g.map(function(){var d=m._asyncToGenerator(function*({sublayer:c,popupTemplate:k}){yield c.load().catch(()=>{});var h=c.createQuery(),p=C.calculateTolerance({renderer:c.renderer,event:l}),r=e.createFetchPopupFeaturesQueryGeometry(b,p);h.geometry=r;h.outFields=yield D.getRequiredFields(c,k);h.timeExtent=e.timeExtent;if("floors"in
e.view){var w=e.view?.floors?.clone();w=O.getLayerFloorFilterClause(w,c);v.isSome(w)&&(h.where=h.where?`(${h.where}) AND (${w})`:w)}p=e._getTargetResolution(r.width/p);r=yield e._loadArcadeModules(k);k="point"===c.geometryType||r&&r.arcadeUtils.hasGeometryOperations(k);k||(h.maxAllowableOffset=p);({features:c}=yield c.queryFeatures(h));h=k?0:p;for(const U of c)e._featuresResolutions.set(U,h);return c});return function(c){return d.apply(this,arguments)}}());return(yield B.eachAlways(a)).reverse().reduce((d,
c)=>c.value?[...d,...c.value]:d,[]).filter(d=>null!=d)});return function(b,a){return f.apply(this,arguments)}}();n._collectPopupProviders=function(){var f=m._asyncToGenerator(function*(b,a,e){const g=[],l=function(){var d=m._asyncToGenerator(function*(c){var k=0===c.minScale||a<=c.minScale;const h=0===c.maxScale||a>=c.maxScale;c.visible&&k&&h&&(c.sublayers?c.sublayers.forEach(l):c.popupEnabled&&(k=D.getFetchPopupTemplate(c,{...e,defaultPopupTemplateEnabled:!1}),v.isSome(k)&&g.unshift({sublayer:c,
popupTemplate:k})))});return function(c){return d.apply(this,arguments)}}();b=b.toArray().reverse().map(l);yield Promise.all(b);return g});return function(b,a,e){return f.apply(this,arguments)}}();n._loadArcadeModules=function(f){if(f.expressionInfos?.length||Array.isArray(f.content)&&f.content.some(b=>"expression"===b.type))return R.loadArcade()};m._createClass(x,[{key:"exportImageVersion",get:function(){this.exportImageParameters?.commitProperty("version");this.commitProperty("timeExtent");return(this._get("exportImageVersion")||
0)+1}}]);return x}(q);t.__decorate([u.property()],q.prototype,"highlightGraphics",void 0);t.__decorate([u.property()],q.prototype,"exportImageParameters",void 0);t.__decorate([u.property({readOnly:!0})],q.prototype,"exportImageVersion",null);t.__decorate([u.property()],q.prototype,"layer",void 0);t.__decorate([u.property()],q.prototype,"suspended",void 0);t.__decorate([u.property(M.combinedViewLayerTimeExtentProperty)],q.prototype,"timeExtent",void 0);return q=t.__decorate([J.subclass("esri.views.layers.MapImageLayerView")],
q)}});