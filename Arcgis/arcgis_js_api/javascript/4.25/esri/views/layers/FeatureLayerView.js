// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Error ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/arrayUtils ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ../../layers/support/commonProperties ../../layers/support/FeatureEffect ../../layers/support/FeatureFilter ../../layers/support/fieldUtils ../../layers/support/floorFilterUtils ../../rest/support/Query ../../support/arcadeOnDemand ./support/popupUtils".split(" "),
function(u,q,y,F,n,B,v,r,L,M,G,H,I,J,f,C,D,K,w){const z=F.getLogger("esri.views.layers.FeatureLayerView");return l=>{l=function(A){function x(...a){a=A.call(this,...a)||this;a._updatingRequiredFieldsPromise=null;a.filter=null;a.timeExtent=null;a.layer=null;a.requiredFields=[];a.view=null;return a}u._inheritsLoose(x,A);var h=x.prototype;h.initialize=function(){this.handles.add([v.watch(()=>{const a=this.layer;return[a?.elevationInfo?.featureExpressionInfo,a&&"displayField"in a?a.displayField:null,
a?.timeInfo,a&&"renderer"in a&&a.renderer,a&&"labelingInfo"in a&&a.labelingInfo,a&&"floorInfo"in a&&a.floorInfo,this.filter,this.featureEffect,this.timeExtent]},()=>this._handleRequiredFieldsChange(),v.syncAndInitial),v.on(()=>this.view?.floors,"change",()=>this._handleRequiredFieldsChange()),v.on(()=>{const a=this.layer;return a&&"sublayers"in a&&a.sublayers},"change",()=>this._handleRequiredFieldsChange())])};h.highlight=function(a){throw Error("missing implementation");};h.createQuery=function(){var a=
{outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};a=n.isSome(this.filter)?this.filter.createQuery(a):new D(a);if("feature"===this.layer.type){const c=C.getFloorFilterClause(this);n.isSome(c)&&(a.where=a.where?`(${a.where}) AND (${c})`:c)}n.isSome(this.timeExtent)&&(a.timeExtent=n.isSome(a.timeExtent)?a.timeExtent.intersection(this.timeExtent):this.timeExtent.clone());return a};h.createAggregateQuery=function(){return new D({outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference})};
h.queryFeatures=function(a,c){throw Error("missing implementation");};h.queryObjectIds=function(a,c){throw Error("missing implementation");};h.queryFeatureCount=function(a,c){throw Error("missing implementation");};h.queryExtent=function(a,c){throw Error("missing implementation");};h.fetchPopupFeatures=function(){var a=u._asyncToGenerator(function*(c,b){if(c=this.validateFetchPopupFeatures(b))throw c;return this.fetchClientPopupFeatures(b)});return function(c,b){return a.apply(this,arguments)}}();
h._loadArcadeModules=function(a){if(a.get("expressionInfos.length")||Array.isArray(a.content)&&a.content.some(c=>"expression"===c.type))return K.loadArcade()};h._handleRequiredFieldsChange=function(){const a=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",a);a.then(()=>{this._updatingRequiredFieldsPromise===a&&this._set("_updatingRequiredFieldsPromise",null)})};h._updateRequiredFields=function(){var a=u._asyncToGenerator(function*(){if(this.layer&&this.view){var c="3d"===this.view.type,
{layer:b,layer:{fieldsIndex:e,objectIdField:m}}=this,g="renderer"in b&&b.renderer,k="orderBy"in b&&b.orderBy,p="featureReduction"in b?b.featureReduction:null,d=new Set;g=yield B.eachAlways([g?g.collectRequiredFields(d,e):null,f.collectLabelingFields(d,b),c?f.collectElevationFields(d,b):null,n.isSome(this.filter)?f.collectFilterFields(d,b,this.filter):null,n.isSome(this.featureEffect)?f.collectFilterFields(d,b,this.featureEffect.filter):null,p?f.collectFeatureReductionFields(d,b,p):null,k?f.collectOrderByInfos(d,
b,k):null]);b.timeInfo&&this.timeExtent&&f.collectFields(d,b.fieldsIndex,[b.timeInfo.startField,b.timeInfo.endField]);"feature"===b.type&&(b.floorInfo&&f.collectFields(d,b.fieldsIndex,[b.floorInfo.floorField]),c&&n.isSome(b.infoFor3D)&&(null==b.globalIdField&&z.error("globalIdField missing on 3DObjectFeatureLayer"),f.collectFields(d,b.fieldsIndex,[b.globalIdField])));"subtype-group"===b.type&&(f.collectField(d,e,b.subtypeField),k=b.sublayers.map(t=>Promise.all([t.renderer?.collectRequiredFields(d,
e),f.collectLabelingFields(d,t)])),yield B.eachAlways(k));for(const t of g)t.error&&z.error(t.error);f.collectField(d,e,m);c&&"displayField"in b&&b.displayField&&f.collectField(d,e,b.displayField);c=Array.from(d).sort();this._set("requiredFields",c)}});return function(){return a.apply(this,arguments)}}();h.validateFetchPopupFeatures=function(a){if(n.isNone(a))return null;for(const c of a.clientGraphics){const b=c.layer;if("popupEnabled"in b&&!b.popupEnabled)return new y("featurelayerview:fetchPopupFeatures",
"Popups are disabled",{layer:b});if(c.isAggregate){const e="featureReduction"in b?b.featureReduction:null;if(!(e&&"popupTemplate"in e&&e.popupEnabled&&e.popupTemplate))return new y("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:b})}else if("popupTemplate"in b&&!w.getFetchPopupTemplate(b,a))return new y("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:b})}};h.fetchClientPopupFeatures=function(){var a=u._asyncToGenerator(function*(c){const b=
n.isSome(c)?c.clientGraphics:null;if(!b||0===b.length)return[];const e=Array(b.length),m=new Map,g=yield this.createPopupQuery(c);for(let p=0;p<b.length;p++){const d=b[p];if(d.isAggregate){e[p]=d;continue}var {layer:k}=d;if(!("popupEnabled"in k))continue;const t=f.unpackFieldNames(this.layer.fieldsIndex,g.outFields);k=w.getFetchPopupTemplate(k,c);if(n.isNone(k))continue;const E=yield this._loadArcadeModules(k);E&&E.arcadeUtils.hasGeometryOperations(k)||!f.featureHasFields(t,d)?m.set(d.getObjectId(),
p):e[p]=d}if("stream"===this.layer.type||0===m.size)return e.filter(Boolean);g.objectIds=Array.from(m.keys());try{const p=yield this.layer.queryFeatures(g);for(const d of p.features){const t=m.get(d.getObjectId());e[t]=d}}catch{}return e.filter(Boolean)});return function(c){return a.apply(this,arguments)}}();h.createPopupQuery=function(){var a=u._asyncToGenerator(function*(c){const b=this.layer.createQuery(),e=new Set;var m=!1,g=n.isSome(c)&&c.clientGraphics?c.clientGraphics.map(k=>k.layer):[this.layer];
for(const k of g)if("popupEnabled"in k&&(g=w.getFetchPopupTemplate(k,c),!n.isNone(g))){m=(m=yield this._loadArcadeModules(g))&&m.arcadeUtils.hasGeometryOperations(g);m=!("point"!==this.layer.geometryType&&!m);g=yield w.getRequiredFields(this.layer,g);for(const p of g)e.add(p)}b.returnGeometry=m;b.returnZ=m;b.returnM=m;b.outFields=Array.from(e);b.outSpatialReference=this.view.spatialReference;"feature"===this.layer.type&&(c=C.getFloorFilterClause(this),n.isSome(c)&&(b.where=b.where?`(${b.where}) AND (${c})`:
c));return b});return function(c){return a.apply(this,arguments)}}();h.canResume=function(){return!A.prototype.canResume.call(this)||n.isSome(this.timeExtent)&&this.timeExtent.isEmpty?!1:!0};u._createClass(x,[{key:"availableFields",get:function(){const {layer:a,layer:{fieldsIndex:c},requiredFields:b}=this;return"outFields"in a&&a.outFields?f.fixFields(c,[...f.unpackFieldNames(c,a.outFields),...b]):f.fixFields(c,b)}},{key:"featureEffect",get:function(){return this.layer&&"featureEffect"in this.layer?
this.layer.featureEffect:null},set:function(a){this._override("featureEffect",a)}},{key:"maximumNumberOfFeatures",get:function(){return 0},set:function(a){z.error("#maximumNumberOfFeatures\x3d","Setting maximum number of features is not supported")}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!1}}]);return x}(l);q.__decorate([r.property()],l.prototype,"_updatingRequiredFieldsPromise",void 0);q.__decorate([r.property({readOnly:!0})],l.prototype,"availableFields",null);q.__decorate([r.property({type:I})],
l.prototype,"featureEffect",null);q.__decorate([r.property({type:J})],l.prototype,"filter",void 0);q.__decorate([r.property(H.combinedViewLayerTimeExtentProperty)],l.prototype,"timeExtent",void 0);q.__decorate([r.property()],l.prototype,"layer",void 0);q.__decorate([r.property({type:Number})],l.prototype,"maximumNumberOfFeatures",null);q.__decorate([r.property({readOnly:!0,type:Boolean})],l.prototype,"maximumNumberOfFeaturesExceeded",null);q.__decorate([r.property({readOnly:!0})],l.prototype,"requiredFields",
void 0);q.__decorate([r.property()],l.prototype,"suspended",void 0);q.__decorate([r.property()],l.prototype,"view",void 0);return l=q.__decorate([G.subclass("esri.views.layers.FeatureLayerView")],l)}});