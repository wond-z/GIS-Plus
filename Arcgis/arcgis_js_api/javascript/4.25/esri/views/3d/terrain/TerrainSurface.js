// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("require ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../Color ../../../core/Accessor ../../../core/arrayUtils ../../../core/CollectionFlattener ../../../core/Evented ../../../core/Handles ../../../core/Logger ../../../core/mathUtils ../../../core/maybe ../../../core/ObjectPool ../../../core/PooledArray ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../chunks/mat4 ../../../chunks/mat4f64 ../../../chunks/vec3 ../../../chunks/vec3f64 ../../../chunks/vec4f64 ../../../core/support/WatchUpdatingTracking ../../../geometry/projection ../../../geometry/projectionEllipsoid ../../../geometry/SpatialReference ../../../geometry/support/aaBoundingRect ../../../geometry/support/frustum ../../../geometry/support/spatialReferenceUtils ../../../layers/mixins/RefreshableLayer ../../../layers/support/ElevationQueryTileCache ../../../layers/support/layerUtils ../../../layers/support/LercDecoder ../../2d/engine/vectorTiles/VectorTile ../support/cameraUtils ../support/debugFlags ../support/extentUtils ../support/index ../support/updatingProperties ./ElevationBounds ./ElevationData ./ExtentHelper ./interfaces ./LayerClass ./OverlayManager ./PlanarPatch ./RenderOrder ./SphericalPatch ./TerrainConst ./TerrainRenderer ./TerrainSurfacePerformanceInfo ./terrainUtils ./Tile ./TilePerLayerInfo ./TileUpdate ./tileUtils ./TilingSchemeLogic ./UpsampleInfo ../webgl-engine/core/shaderLibrary/output/BlendOptions ../webgl-engine/lib/basicInterfaces ../../support/RenderState ../../support/Scheduler".split(" "),
function(ea,R,l,fa,k,ha,ia,ja,ka,B,la,q,J,S,D,t,m,Na,ma,na,oa,pa,T,qa,ra,I,sa,U,A,K,ta,ua,va,wa,xa,ya,za,V,Aa,W,Ba,L,X,Ca,F,x,Da,Ea,Fa,Ga,E,H,Ha,n,Y,Ia,u,G,Ja,Ka,Z,aa,La,O){function ba(v,y){return v[0]===y[0]&&v[1]===y[1]&&v[2]===y[2]}function ca(v){return v.isLeaf?!1:v.children.some(y=>y.shouldLoad)||v.children.some(y=>ca(y))}function da(v,y,g){for(const a of v)if(a.containsPointXY(y,g)){for(v=a;v&&!v.renderData;)v=v.children[(y>v.extentMidX?1:0)+(g<v.extentMidY?2:0)];return X.sampleElevation(y,
g,v?.renderData?.geometryState.samplerData??null)}return null}k=function(v){function y(a){var b=v.call(this,a)||this;b._iteratorPool=new J(G.IteratorPreorder,c=>c.remove=()=>b._iteratorPool.release(c));b._postorderIterator=new G.IteratorPostorder;b._hasPendingUpdates=!1;b._pendingUpdates=0;b._asyncWorkItems=0;b._allTilesDirty=!0;b._allTilesSorted=!0;b._visibleCached=!1;b._usedMemory=null;b._performanceInfo=new Ha;b._viewChanged=!1;b._inFrameTask=!1;b._viewChangeUpdateDirty=!1;b._eyePosRenderSR=T.create();
b._eyePosSurfaceSR=T.create();b._splitLimits=new Y.SplitLimits;b._frustum=K.create();b._viewProjectionMatrix=oa.create();b._layerViews=[[],[]];b._layerIndexByUid=[new Map,new Map];b._basemapLayerViewHandles=new Map;b._handles=new ka;b._watchUpdatingTracking=new ra.WatchUpdatingTracking;b._frameTask=O.ImmediateTask;b._allTiles=new S;b._upsampleInfoPool=new J(Ka.UpsampleInfo);b._rootTilesExtent=A.create();b._maxNumUpdating=1;b.maxTextureScale=1.2;b._spatialReference=U.WebMercator;b.visibleElevationBounds=
new L.ElevationBounds(Infinity,-Infinity);b.rootTileElevationBounds=new L.ElevationBounds(Infinity,-Infinity);b._updatingRootTiles=!1;b._pendingTilesForElevationUpdateEvent=new Set;b._pendingTilesToUpdate=new Set;b.totalGeometryUpdates=0;b.totalTileUpdates=0;b.oneBatchPerFrameTask=!0;b._layerViewsDirty=!1;b._shading=!0;b._isWebMercator=!1;b._isWebMercatorOnPlateeCarree=!1;b._isGlobal=!a.view?.state?.isLocal;return b}R._inheritsLoose(y,v);var g=y.prototype;g.initialize=function(){this._lercDecoder=
xa.acquireDecoder(this.view.resourceController);this._tilePool=this.view.state.isLocal?new J(Ea.PlanarPatch):new J(Ga.SphericalPatch);var a=this.view.resourceController.memoryController;this._upsampleMapCache=a.newCache("esri.views.3d.terrain.upsample",b=>b.unloadMapData());this._elevationQueryCache=new va.ElevationQueryTileCache(a.newCache("elevation-query"));this._set("overlayManager",new Da.OverlayManager({surface:this}));this._handles.add([t.watch(()=>this.overlayManager.hasHighlights,b=>this._renderer.setNeedsHighlight(b)),
t.watch(()=>this.overlayManager.rendersOccluded,b=>this._renderer.setRenderOccludedOverlay(b))],"overlayManager");this._renderer=new H.TerrainRenderer({_overlayRenderer:this.overlayManager.renderer,_ellipsoidRadius:sa.getReferenceEllipsoid(this.view.spatialReference).radius,_stage:this.view._stage,_allTiles:this._allTiles});this._handles.add([t.watch(()=>this.baseOpacity,b=>{this._handleLayerViewChanges();this._updateBaseOpacity(b)},t.syncAndInitial),t.watch(()=>this.hasCompositeBlendMode,()=>{this._updateBaseOpacity(this.baseOpacity)},
t.syncAndInitial),t.watch(()=>this.renderingDisabled,()=>this.view?._stage?.renderView.setRenderParameters({terrainRenderingEnabled:!this.renderingDisabled}),t.sync),t.watch(()=>this.backgroundColor,b=>{this._handleLayerViewChanges();this._renderer.updateTileBackground(b)},t.syncAndInitial),t.watch(()=>this.snapLevel,()=>this._viewChanged=!0,t.sync),t.watch(()=>this.view.pointsOfInterest,b=>{this._renderer.pointsOfInterest=b;this._watchUpdatingTracking.removeAll();b&&this._watchUpdatingTracking.add(()=>
b.focus.renderLocation,()=>this._allTilesSorted=!1)}),t.watch(()=>V.TERRAIN_TILE_TREE_SHOW_TILES,b=>{b&&!this._treeDebugger?(new Promise((c,e)=>ea(["../layers/support/TerrainTileTree3DDebugger"],c,e))).then(({TerrainTileTree3DDebugger:c})=>{!this._treeDebugger&&V.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new c({view:this.view}))}):b||(this._treeDebugger=q.destroyMaybe(this._treeDebugger))},t.initial)]);this._extentHelper=Ca.create(this.viewingMode,{layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,
viewSpatialReference:this.view.spatialReference});a=new ia({getCollections:()=>this.view?.defaultsFromMap?.mapCollections?.map(({layers:b})=>b),getChildrenFunction:b=>b&&"layers"in b?b.layers:null});a=new Ja.TilingSchemeLogic({layers:a,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:this.view.spatialReference});this._set("tilingSchemeLogic",a);this._updateTilingScheme();this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(W.ClientType.ELEVATION);
this._mapDataRequester=this.view.resourceController.createStreamDataRequester(W.ClientType.BASEMAP);this._frameTask=this.view.resourceController.scheduler.registerTask(O.TaskPriority.TERRAIN_SURFACE,this);this._handles.add([t.watch(()=>this._extentHelper.stencilEnabledExtents,b=>this._renderer.setStencilEnabledLayerExtents(b),t.initial),t.watch(()=>this.tilingSchemeLogic.tilingScheme,()=>this._updateTilingScheme(),t.sync),t.watch(()=>this.extent,()=>this._updateRootTiles(),t.initial),this.view.on("resize",
()=>this._viewChangeUpdate()),t.watch(()=>{const b=this.view,c=b.state;return[this._lodBias,this.lodSnapping,b.resourceController?.memoryController?.memoryFactor,c.camera,c.contentCamera,c.fixedContentCamera]},()=>this._viewChangeUpdate(),t.syncAndInitial),t.watch(()=>this.view.qualitySettings?.tiledSurface?.textureFadeDuration,b=>this._renderer.textureFadingEnabled=0<b,t.initial),t.watch(()=>this._userClippingExtent,()=>this._updateClippingExtent(),t.sync)]);this._handles.add(this.view.allLayerViews.on("after-changes",
()=>this._layerViewsDirty=!0));this._handles.add([t.watch(()=>this.view?.map.ground.shading,()=>{this._updateShadingIfChanged()})]);this._updateShading();this._layerViewsDirty=!0;this._handleLayerViewChanges()};g.destroy=function(){this._frameTask.remove();this._handles.destroy();this._watchUpdatingTracking.destroy();this._lercDecoder=q.releaseMaybe(this._lercDecoder);this._removeAllTiles();this._upsampleMapCache=q.destroyMaybe(this._upsampleMapCache);this._elevationQueryCache=q.destroyMaybe(this._elevationQueryCache);
const a=this.tilingSchemeLogic.layers;this._set("tilingSchemeLogic",q.destroyMaybe(this.tilingSchemeLogic));a.destroy();this._basemapLayerViewHandles.forEach((b,c)=>this._unregisterTiledLayerView(c));this._mapDataRequester=this._elevationDataRequester=null;this._set("overlayManager",q.destroyMaybe(this.overlayManager));this._tilePool=q.destroyMaybe(this._tilePool);Y.Tile.prune();this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null);this._renderer=q.destroyMaybe(this._renderer);
this._iteratorPool=q.destroyMaybe(this._iteratorPool);this._set("view",null);this._upsampleInfoPool=q.destroyMaybe(this._upsampleInfoPool);ya.printAllocations();Ia.printAllocations()};g.intersect=function(a,b,c,e){this._renderer.intersect(a,b,c,e)};g.getElevation=function(a,b,c,e){const d=this.rootTiles;if(q.isNone(d)||!d.length||0===d[0].layerInfo[x.LayerClass.ELEVATION].length)return null;const f=z;f[0]=a;f[1]=b;f[2]=c;return I.projectVectorToVector(f,e,f,this._spatialReference)?da(d,f[0],f[1]):
(B.getLogger(this.declaredClass).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null)};g.getElevations=function(a,b,c){const e=this.rootTiles;var d=e?e[0].layerInfo[x.LayerClass.ELEVATION].length:0;if(q.isNone(e)||!e.length||0===d)for(a=0;a<b;++a)c(a,null);else for(d=0;d<b;++d){var f=3*d;f=da(e,a[f+0],a[f+1]);c(d,f)}};g.getScale=function(a){if(this.tilingScheme){if(!I.projectPointToVector(a,z,this.spatialReference))return B.getLogger(this.declaredClass).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),
null;a=this.rootTiles;if(q.isSome(a))for(let b of a)if(b?.containsPoint(z)){for(;!b.isLeaf&&!b.rendered;)a=0,z[0]>b.children[0].extent[2]&&(a+=1),z[1]<b.children[0].extent[1]&&(a+=2),b=b.children[a];return this._getLodBiasCorrectedScale(b.level)}}return 1E100};g.getSphereElevationBounds=function(a,b,c,e,d){z[0]=a;z[1]=b;z[2]=c;z[3]=e;if(!I.projectVectorToVector(z,d,z,this.tilingScheme?.spatialReference))return B.getLogger(this.declaredClass).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),
null;let f=Infinity,h=-Infinity;const p=r=>{if(r&&A.intersectsSphere(r.extent,z))if(r.isLeaf||r.rendered)f=Math.min(f,r.elevationBounds[0]),h=Math.max(h,r.elevationBounds[1]);else for(const w of r.children)p(w)};a=this.rootTiles;if(q.isSome(a))for(const r of a)p(r);return{min:f,max:h}};g.getSphereScale=function(a,b){if(!this.tilingScheme)return null;if(!I.projectPointToVector(a,z,this.spatialReference))return B.getLogger(this.declaredClass).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),
null;z[3]=b;let c=null;const e=d=>{if(d&&A.intersectsSphere(d.extent,z))if(d.isLeaf||d.rendered)d=this._getLodBiasCorrectedScale(d.level),c=null==c?d:Math.min(c,d);else for(const f of d.children)e(f)};a=this.rootTiles;if(q.isSome(a))for(const d of a)e(d);return c};g.queryVisibleScaleRange=function(a,b,c,e){b=b?this.tilingScheme.levelAtScale(b):0;c=c?this.tilingScheme.levelAtScale(c):Infinity;const d=this._lodBias;this._renderer.queryVisibleLevelRange(a,b+d,c+d,e)};g._evaluateTransparency=function(a){var b=
this._renderer.transparency;a=this._allSurfaceLayersTransparent()?H.TransparencyMode.Invisible:1<=a&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?H.TransparencyMode.Opaque:H.TransparencyMode.Semitransparent;if(b=b!==a)this._renderer.transparency=a,this.view?._stage?.renderView.setRenderParameters({terrainTransparency:this._renderer.transparency});return b};g._updateBaseOpacity=function(a){a=this._evaluateTransparency(a);this._updateTileTextures(a?F.TextureUpdate.UNFADED:F.TextureUpdate.IMMEDIATE)};
g._updateTilingScheme=function(){const a=this.tilingSchemeLogic.tilingScheme;a!==this.tilingScheme&&(n.weakAssert(!!a,"tiling scheme cannot be reset to undefined"),this._isGlobal=!this.view?.state?.isLocal,this.tilingScheme&&this._removeAllTiles(),this._spatialReference=a?.spatialReference??U.WebMercator,this._set("tilingScheme",a),this._updateClippingExtent(),a&&(this._updateTiledLayers(),this._renderer.setTileSize(a.pixelSize),this.overlayManager.setSpatialReference(a.spatialReference),this._updateRootTiles()),
this._isWebMercatorOnPlateeCarree=(this._isWebMercator=!!this.tilingScheme?.spatialReference.isWebMercator)&&ta.isPlateCarree(this.view?.renderSpatialReference))};g._acquireTile=function(a,b,c,e){const d=this._tilePool.acquire();M[0]=a;M[1]=b;M[2]=c;d.init(M,e,this);return d};g._updateRootTiles=function(){const {extent:a,tilingScheme:b}=this;if(b){var c=Ma,e=b.rootTilesInExtent(a,c,5*E.MAX_ROOT_TILES);if(q.isSome(this.rootTiles)){if(e.length>E.MAX_ROOT_TILES){B.getLogger(this.declaredClass).warn(E.TOO_MANY_ROOT_TILES_AFTER_CHANGE_ERROR);
return}const d=this.rootTiles.map(h=>h.lij),f=ha.difference(d,e,ba);this._updatingRootTiles=!0;if(0<f.removed.length||0<f.added.length){const h=this.rootTiles.filter(p=>-1<f.removed.findIndex(r=>ba(r,p.lij))?(this._purgeTile(p),!1):!0);f.added.forEach(p=>h.push(this._newRootTile(p)));this._setRootTiles(h)}}else this._updatingRootTiles=!0,e.length>E.MAX_ROOT_TILES&&(B.getLogger(this.declaredClass).warn(E.TOO_MANY_ROOT_TILES_FOR_LAYER_ERROR),e=b.rootTilesInExtent(a,c,E.MAX_ROOT_TILES)),this._setRootTiles(e.map(d=>
this._newRootTile(d)));A.equals(c,this._rootTilesExtent)||(this._rootTilesExtent=A.create(c));this._visible=!0;this._viewChangeUpdate();this.overlayManager.setPlacementDirty();this.notifyChange("ready");this._updateAllTileGeometries();this._updatingRootTiles=!1;this.checkAllTilesWaterproofness()}};g._updateAllTileGeometries=function(){const a=this._allTiles.filter(b=>b.isLoaded&&b.intersectsClippingArea);a.forEach(b=>this._renderer.updateTileGeometryState(b));a.forEach(b=>b.renderData.updateNeighborData());
this._updateTilesGeometries(a);this._pendingTilesToUpdate.clear()};g._updateTilesGeometries=function(a){if(0!==a.length){a.sort(G.compareTilesByLij);var b=this.renderer;a.forEach(c=>b.updateGeometryIfNeeded(c));a.forEach(c=>this._pendingTilesForElevationUpdateEvent.add(c))}};g._shouldSplit=function(a){return a.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)===u.TileUpdate.SPLIT};g._newRootTile=function(a){a=this._acquireTile(0,a[1],a[2],null);this._shouldSplit(a)&&a.setPendingUpdate(u.TileUpdate.SPLIT);
this._loadTile(a);this._markTileToUpdate(a);this._updateRootTileElevationBounds();return a};g._setRootTiles=function(a){this._set("rootTiles",a);this._allTiles.clear();if(q.isSome(a)){const b=this._iteratorPool.acquire();for(b.reset(a);!b.done;)this._allTiles.push(b.next());b.remove()}this._renderer.setRootTiles(this.rootTiles);this._updateTilesVisibility(a)};g._runViewChangeUpdateIfDirty=function(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())};g._viewChangeUpdate=
function(){this.view&&!this.suspended&&this.tilingScheme&&this._visibleCached&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this.rootTiles)))};g._updateClippingStatus=function(a){a.updateClippingStatus(this.extent)&&a.resetPendingUpdate(u.TileUpdate.GEOMETRY)&&this._updateTileGeometryState(a)};g._updateTilesVisibility=function(a){if(!q.isNone(a)){var b=G.hasLoadableSiblings(a),c=this.visibleElevationBounds,
e=b?c.min:Infinity;b=b?c.max:-Infinity;var d=this.extent,f=this._viewProjectionMatrix;this.setTileTreeDirty();var h=this._iteratorPool.acquire();for(h.reset(a);!h.done;)a=h.next(),a.updateClippingStatus(d)&&a.resetPendingUpdate(u.TileUpdate.GEOMETRY)&&this._updateTileGeometryState(a),a.setPendingUpdate(u.TileUpdate.RENDERDATA),a.computeVisibility(),a.updateScreenDepth(f),a.renderData&&(e=Math.min(a.elevationBounds[0],e),b=Math.max(a.elevationBounds[1],b));h.remove();this._allTilesDirty=this._viewChanged=
!0;this._batchUpdatePendingTileGeometries();isFinite(e)&&isFinite(b)&&(c.min!==e||c.max!==b)&&(this.visibleElevationBounds=new L.ElevationBounds(e,b))}};g._updateRootTileElevationBounds=function(){let a=Infinity,b=-Infinity;var c=this.rootTiles;q.isSome(c)&&c.forEach(({elevationBounds:e})=>{a=Math.min(a,e[0]);b=Math.max(b,e[1])});c=this.rootTileElevationBounds;if(c.min!==a||c.max!==b)this.rootTileElevationBounds=new L.ElevationBounds(a,b)};g._updateViewDependentParameters=function(){const a=this.view.state.camera,
b=this.view.state.contentCamera,c=Math.tan(.5*b.fovX),e=Math.tan(.5*b.fovY),d=this.tilingScheme.pixelSize,f=2**-this._lodBias*a.pixelRatio;this._splitLimits.aboveGround=a.aboveGround;this._splitLimits.fovX=c;this._splitLimits.fovY=e;this._splitLimits.relativeWidthLimit=d/a.width*this.maxTextureScale*f;this._splitLimits.relativeHeightLimit=d/a.height*this.maxTextureScale*f;this._splitLimits.maxLod=this.tilingScheme.getMaxLod();this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias;
this.view.state.fixedContentCamera?(q.isNone(this._splitLimits.frustum)&&(this._splitLimits.frustum=K.create()),K.copy(this._splitLimits.frustum,b.frustum)):this._splitLimits.frustum=null;K.copy(this._frustum,a.frustum);na.multiply(this._viewProjectionMatrix,b.projectionMatrix,b.viewMatrix);pa.copy(this._eyePosRenderSR,b.eye);I.projectVectorToVector(a.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)};g._updateRenderData=function(a){a.rendered&&!a.shouldLoad&&(ca(a)?
this._loadChildren(a):a.isLeaf&&a.parent&&a.parent.shouldLoad&&this._loadParent(a))};g._updateTileGeometryState=function(a){a.updateVisibility();this._renderer.updateTileGeometryState(a)&&this._markTileToUpdate(a);this._usedMemory=null};g._markAllTileNeighborsForGeometryUpdate=function(a){const b=this._pendingTilesToUpdate;a.forEachLoadedNeighbor(c=>{b.add(c)})};g._updateTileTexture=function(a,b){const c=a.resetPendingUpdate(u.TileUpdate.TEXTURE_FADING)?u.TileUpdate.TEXTURE_FADING:a.resetPendingUpdate(u.TileUpdate.TEXTURE_NOFADING)?
u.TileUpdate.TEXTURE_NOFADING:!1;c&&(this._renderer.updateTileTexture(a,c),this._usedMemory=null,b.madeProgress())};g._emitElevationUpdateEventForTiles=function(){const a=P.extent;A.empty(a);this._pendingTilesForElevationUpdateEvent.forEach(b=>A.expand(a,b.extent,a));this._pendingTilesForElevationUpdateEvent.clear();P.spatialReference=this.spatialReference;this.emit("elevation-change",P)};g.runTask=function(a){this._handleLayerViewChanges(a);this._frameTask.processQueue(a);this._inFrameTask=!0;this._pendingUpdates=
0;this._hasPendingUpdates=!1;this._updateAllTilesStatus(a);this._sortTiles(a);const b=!this.view.state.fixedContentCamera;this._mergeAndSplit(a,b);this._updateElevation(a);this._updateTextures(a);b||this._mergeAndSplit(a,!0);this._inFrameTask=!1;this._runViewChangeUpdateIfDirty();this._batchUpdatePendingTileGeometries();this._emitElevationUpdateEventForTiles();a.done?this.requestUpdate():this.getUsedMemory();this.notifyChange("updatingProgressValue")};g._updateAllTilesStatus=function(a){if(this._viewChanged&&
this.rootTiles&&!a.done){this._viewChanged=!1;var b=this._iteratorPool.acquire();b.reset(this.rootTiles);for(var c=this.snapLevel,e=this._splitLimits,d=this._eyePosRenderSR;!b.done;){var f=b.next(),h=f.shouldSplit(e,d,c);if(h===u.TileUpdate.SPLIT)f.resetPendingUpdate(u.TileUpdate.MERGE),f.isLeaf&&(f.setPendingUpdate(u.TileUpdate.SPLIT),b.skipSubtree()),f.rendered&&f.setPendingUpdate(u.TileUpdate.RENDERDATA);else if(f.resetPendingUpdate(u.TileUpdate.SPLIT)&&f.updateAgentSuspension(),h===u.TileUpdate.VSPLITMERGE&&
f.updateAgents(x.LayerClass.ELEVATION),b.skipSubtree(),!f.isLeaf){f.setPendingUpdate(u.TileUpdate.MERGE);f.resetPendingUpdate(u.TileUpdate.SPLIT);h=this._iteratorPool.acquire();h.resetOne(f);f=this._viewProjectionMatrix;for(let p=h.next();!h.done;p=h.next())this._updateClippingStatus(p),p.updateVisibility(),p.updateScreenDepth(f);h.remove()}}b.remove();this.requestUpdate();!this.shortBatches&&this.oneBatchPerFrameTask||this._batchUpdatePendingTileGeometries();a.madeProgress()}};g._sortTiles=function(a){a.done||
this._allTilesSorted||(G.sortTilesByPOI(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),a.madeProgress())};g._markTileToUpdate=function(a){n.internalAssert(a.isLoaded);a.intersectsClippingArea&&(this._pendingTilesToUpdate.add(a),this._markAllTileNeighborsForGeometryUpdate(a))};g._batchUpdatePendingTileGeometries=function(){const a=this._pendingTilesToUpdate;if(0!==a.size){var b=Array.from(this._pendingTilesToUpdate.keys()).filter(f=>
f.isLoaded&&f.intersectsClippingArea),c=(f,h)=>{!h?.isLoaded||!h.intersectsClippingArea||h.level<f.level||a.has(h)||(a.add(h),b.push(h),h.renderData.updateNeighborData())};b.sort(G.compareTilesByLij);var e=b.length;for(let f=0;f<e;++f){const h=b[f];n.internalAssert(h.isLoaded);n.internalAssert(h.intersectsClippingArea);var d=h.renderData;d.updateNeighborData();const p=d._dirtyEdgeResolutions;d=d.geometryState.neighborData;for(let r=0;4>r;++r)if(p&1<<r){const w=h.renderData.geometryState.neighborData.edgePeerNeighbors[r];
w&&w?.level>=h.level&&w.forAllSubtreeOnSide(n.oppositeEdge(n.neighborEdgeIndices[r]),C=>C.isLoaded&&C.intersectsClippingArea?(n.internalAssert(a.has(C)||0>G.compareTilesByLij(h,C)),c(h,C),!0):!1);c(h,d.cornerPeerNeighbors[r]);c(h,d.cornerPeerNeighbors[(r+1)%4])}}a.clear();this._updateTilesGeometries(b);n.ENABLE_TERRAIN_INTERNAL_CHECKS&&n.ENABLE_WATERPROOFNESS_TESTS&&this.checkAllTilesWaterproofness()}};g._mergeAndSplit=function(a,b){if(!this.suspended&&!a.done&&this._allTilesDirty){this._allTilesDirty=
!1;this.requestUpdate();for(var c=!1,e=!1;!a.done;){e=!0;let d=!1;const f=!this._allTiles.some(h=>{if(!c&&!h.loadable)return a.done;let p=h;if(h.resetPendingUpdate(u.TileUpdate.MERGE)){if(!b)return h.setPendingUpdate(u.TileUpdate.MERGE),a.done;for(;p.parent?.resetPendingUpdate(u.TileUpdate.MERGE);)p=p.parent;this._mergeTile(p);d=!0;a.madeProgress()}else h.resetPendingUpdate(u.TileUpdate.SPLIT)&&(this._splitTile(h),d=!0,a.madeProgress());!a.done&&p===h&&h.resetPendingUpdate(u.TileUpdate.RENDERDATA)&&
(this._updateRenderData(h),a.madeProgress());return a.done});d&&(this._allTilesSorted=!1,this._allTilesDirty=!0);if(f)if(!c)c=!0;else{if(!d)break}else this._allTilesDirty=!0}e||(this._allTilesDirty=!0);!this.oneBatchPerFrameTask&&this._batchUpdatePendingTileGeometries();this._sortTiles(a)}};g._updateElevation=function(a){a.done||(this._allTiles.some(b=>{b.resetPendingUpdate(u.TileUpdate.GEOMETRY)&&(this._updateTileGeometryState(b),this._updateTileTexture(b,a),this.shortBatches&&this._batchUpdatePendingTileGeometries(),
a.madeProgress());return a.done}),!this.oneBatchPerFrameTask&&this._batchUpdatePendingTileGeometries())};g._updateTextures=function(a){a.done||this._allTiles.some(b=>{this._updateTileTexture(b,a);return a.done})};g._updateClippingExtent=function(){this.spatialReference&&(this.updateTileOverlayParams(aa.RenderRequestType.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())};g._getLodBiasCorrectedScale=function(a){const b=this.tilingScheme.levels;a=la.clamp(a-this._lodBias,0,b.length-
1);const c=a-Math.floor(a);return b[Math.floor(a)].scale*(1-c)+b[Math.ceil(a)].scale*c};g._removeAllTiles=function(){q.isSome(this.rootTiles)&&(this.rootTiles.forEach(a=>this._purgeTile(a)),this._setRootTiles(null),this.notifyChange("ready"));this._allTiles.clear();this._visible=!1};g._purgeDescendantTiles=function(a){if(a.isLeaf)return!1;let b=!1;for(let c=0;4>c;++c)b=this._purgeTile(a.children[c])||b;a.unsetChildren();return b};g._purgeTile=function(a){const b=this._purgeDescendantTiles(a)||a.rendered;
this._allTiles.removeUnordered(a);this._unloadTile(a);this._tilePool.release(a);return b};g._unloadTile=function(a){this._pendingTilesToUpdate.delete(a);this._pendingTilesForElevationUpdateEvent.delete(a);a.unload(this._renderer)};g._splitTile=function(a){n.weakAssert(a.isLeaf,"tile that is already split should not be split again!");const b=a.level+1,c=2*a.lij[1],e=2*a.lij[2];a.setChildren(this._createTile(b,c,e,a),this._createTile(b,c,e+1,a),this._createTile(b,c+1,e,a),this._createTile(b,c+1,e+1,
a));a.setPendingUpdate(u.TileUpdate.RENDERDATA);a.updateAgentSuspension();this._allTiles.pushArray(a.children);this._allTilesDirty=!0;++this._performanceInfo.numSplit};g._emitTileScaleChange=function(a,b=a.level){N.spatialReference=this.spatialReference;N.extent=a.extent;N.scale=this._getLodBiasCorrectedScale(b);this.emit("scale-change",N)};g._createTile=function(a,b,c,e){n.weakAssert(!!e,"_createTile sanity check");a=this._acquireTile(a,b,c,e);a.updateClippingStatus(this.extent);a.updateScreenDepth(this._viewProjectionMatrix);
this._shouldSplit(a)&&a.setPendingUpdate(u.TileUpdate.SPLIT);return a};g._mergeTile=function(a){n.weakAssert(!a.hasPendingUpdate(u.TileUpdate.SPLIT),"_mergeTile sanity check");this._purgeDescendantTiles(a)&&(n.weakAssert(!a.renderData,"_mergeTile sanity check"),this._loadTile(a),this._markTileToUpdate(a),this._emitTileScaleChange(a),this.shortBatches&&this._batchUpdatePendingTileGeometries());this._allTilesDirty=!0;++this._performanceInfo.numMerged};g._loadChildren=function(a){n.weakAssert(a.rendered,
"parent should be rendered");this._unloadTile(a);const b=a.children;b.forEach(c=>this._loadTile(c));b.forEach(c=>this._pendingTilesToUpdate.add(c));this._markAllTileNeighborsForGeometryUpdate(a);this._emitTileScaleChange(a,a.level+1);this.shortBatches&&this._batchUpdatePendingTileGeometries()};g._loadParent=function(a){a=a.parent;this._unloadChildren(a);this._loadTile(a);this._markTileToUpdate(a);this._emitTileScaleChange(a,a.level);this.shortBatches&&this._batchUpdatePendingTileGeometries()};g._unloadChildren=
function(a){if(!a.isLeaf)for(let b=0;4>b;++b){const c=a.children[b];this._unloadChildren(c);this._unloadTile(c)}};g._loadTile=function(a){a.load();a.setPendingUpdate(u.TileUpdate.RENDERDATA);this.requestUpdate();this._allTilesDirty=!0;this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(a)};g._elevationDataArrived=function(a,b,c){c=new X.ElevationData(a.lij,a.extent,c);a.dataArrived(b,x.LayerClass.ELEVATION,c);c=[a];a=a.level;const e=this._iteratorPool.acquire();
for(e.reset(c);!e.done;){const d=e.next();d.findElevationBoundsForLayer(b,a);d.computeElevationBounds()}0===a&&this._updateRootTileElevationBounds();e.remove();this._updateTilesVisibility(c)};g._handleLayerViewChanges=function(a=O.noBudget){if(this._layerViewsDirty){var b=this._layerViewsDirty=!1,c=new Set,e=-1;for(const f of this.view.allLayerViews.items)if(c.add(f.uid),n.isSurfaceLayerView(f)||n.isGroupLayerView(f))if(this._basemapLayerViewHandles.has(f.uid)&&!n.isGroupLayerView(f)){var d=this._layerClassFromLayerView(f);
d=this._getLayerIdxByUID(d,f.uid);if(q.isSome(d)){if(d<e||q.isNone(e))b=!0;e=d}}else this._registerTiledLayerView(f),f.layer.loaded&&(b=!0);this._basemapLayerViewHandles.forEach((f,h)=>{c.has(h)||(this._unregisterTiledLayerView(h),b=!0)});b&&this._updateTiledLayers();this._renderer.transparency=this._allSurfaceLayersTransparent()?H.TransparencyMode.Invisible:this._renderer.transparency;this.hasCompositeBlendMode=this._hasCompositeBlendMode();a.madeProgress()}};g._allSurfaceLayersTransparent=function(){let a=
0===this.view.map?.ground?.opacity;for(const b of this.view.allLayerViews.items)if(n.isMapTileLayerView(b)&&!wa.isBaseLayer(b.layer)&&0!==b.fullOpacity){a=!1;break}return a};g._hasCompositeBlendMode=function(){for(const a of this.view.allLayerViews.items)if((n.isBlendableLayerView(a)||n.isGroupLayerView(a))&&Z.isCompositeBlendMode(Z.blendModeFromString[a.layer.blendMode]))return!0;return!1};g._layerClassFromLayerView=function(a){return n.isElevationLayerView(a)?x.LayerClass.ELEVATION:x.LayerClass.MAP};
g._registerTiledLayerView=function(a){const b=[];(n.isBlendableLayerView(a)||n.isGroupLayerView(a))&&b.push(t.watch(()=>a.layer.blendMode,()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode();this._updateTileTextures(F.TextureUpdate.UNFADED)}));if(!n.isGroupLayerView(a)){var c=this._layerClassFromLayerView(a);b.push(t.watch(()=>a.suspended,()=>this._updateTiledLayers()));b.push(t.watch(()=>a.fullOpacity,()=>this._updateTileTextures(F.TextureUpdate.UNFADED)));b.push(t.watch(()=>"effectiveScaleRange"in
a.layer?a.layer.effectiveScaleRange:null,()=>this._restartAllAgents(c)));a.on("data-changed",()=>{const e=this._getLayerIdxByUID(c,a.uid);q.isSome(e)&&this._invalidateLayerData(e,c)});this._basemapLayerViewHandles.set(a.uid,b)}};g._unregisterTiledLayerView=function(a){const b=this._basemapLayerViewHandles.get(a);if(b){for(let c=0;c<b.length;c++)b[c].remove();this._basemapLayerViewHandles.delete(a)}};g._updateTiledLayers=function(){if(this.tilingScheme&&!this.view.suspended){var a=[[],[]],b=null;this.view.allLayerViews.forEach(e=>
{if(e.layer&&!e.suspended&&n.isSurfaceLayerView(e)&&e.fullExtent){var d=this._layerClassFromLayerView(e);if(d===x.LayerClass.MAP){const f=e.displayLevelRange.maxLevel;Infinity!==f&&(null===b||f>b)&&(b=f)}a[d].push(e)}});for(const e of x.LayerClasses){var c=this._layerViews[e];const d=a[e];d.reverse();const f=d.length;let h=c.length!==f;const p=Array(f),r=Array(c.length);this._layerIndexByUid[e].clear();for(let w=0;w<f;w++){this._layerIndexByUid[e].set(d[w].uid,w);const C=c.indexOf(d[w]);p[w]=C;w!==
C&&(h=!0);-1<C&&(r[C]=w)}if(h){c=this._postorderIterator;for(c.reset(this.rootTiles);!c.done;)c.next().modifyLayers(r,p,e);this._layerViews[e]=d;this._restartAllAgents(e);this._updateTilesVisibility(this.rootTiles)}}this.tilingScheme.ensureMaxLod(b)&&this._viewChangeUpdate()}};g._restartAllAgents=function(a){const b=this._postorderIterator;for(b.reset(this.rootTiles);!b.done;){const c=b.next();c.restartAgents(a);a===x.LayerClass.ELEVATION&&c.computeElevationBounds()}this._updateRootTileElevationBounds()};
g.layerViewByIndex=function(a,b){return this._layerViews[b][a]};g.numLayers=function(a){return this._layerViews[a].length};g._updateTileTextures=function(a){this._allTiles.forAll(b=>{b.updateAgents(x.LayerClass.MAP);a===F.TextureUpdate.IMMEDIATE?this.renderer.updateTileTexture(b,u.TileUpdate.TEXTURE_NOFADING):b.updateRenderData(x.LayerClass.MAP,a)});this._renderer.transparency=this._allSurfaceLayersTransparent()?H.TransparencyMode.Invisible:this._renderer.transparency};g._invalidateLayerData=function(a,
b){this._allTiles.forAll(c=>c.removeLayerAgent(a,b));this._allTiles.forAll(c=>c.invalidateLayerData(a,b))};g.setTileTreeDirty=function(){this._allTilesDirty=!0};g.requestRender=function(a=aa.RenderRequestType.UPDATE){this.renderer.setNeedsRender(a)};g.requestUpdate=function(){1===++this._pendingUpdates&&(this._hasPendingUpdates=!0)};g.requestTileData=function(a,b,c,e){const d=this.layerViewByIndex(b,c);b=d.layer;if(!b.tilemapCache||n.isVectorTileLayerView(d))return this._requestTileData(a,c,d,e);
++this._asyncWorkItems;return b.tilemapCache.fetchAvailability(a.lij[0],a.lij[1],a.lij[2],{...e,timeout:6E3}).then(()=>--this._asyncWorkItems).catch(f=>{--this._asyncWorkItems;D.throwIfAborted(e);D.isAbortError(f)||this._dataMissing(a,c,d,{notInTilemap:!0});throw f;}).then(()=>this._frameTask.schedule(()=>this._requestTileData(a,c,d,e),e.signal))};g._requestTileData=function(a,b,c,e){return b===x.LayerClass.ELEVATION?n.isElevationLayerView(c)?this._requestElevationTileData(a,c,e):Promise.reject():
n.isMapTileLayerView(c)?this._requestMapTileData(a,c,e):Promise.reject()};g._requestElevationTileData=function(a,b,c){++this._asyncWorkItems;const e=h=>{if(!D.isAborted(c)){var p=this._layerIndexByUid[x.LayerClass.ELEVATION].get(b.uid);null==p?B.getLogger(this.declaredClass).warn("TerrainSurface: received data from unknown layer %d %s",x.LayerClass.ELEVATION,a.lij.toString()):(this._usedMemory=null,this.requestUpdate(),this._elevationDataArrived(a,p,h))}},d=h=>{D.isAbortError(h)||(this._dataMissing(a,
x.LayerClass.ELEVATION,b,h),this.requestUpdate())};if(n.useFetchTileForLayer(b.layer))return b.layer.fetchTile(a.lij[0],a.lij[1],a.lij[2],{noDataValue:E.ELEVATION_NODATA_VALUE,signal:c.signal}).then(h=>{if(D.isAborted(c))B.getLogger(this.declaredClass).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true.");else return this._frameTask.schedule(()=>e(h),c.signal,d)},d).finally(()=>{--this._asyncWorkItems});const f=
b.getTileUrl(a.lij[0],a.lij[1],a.lij[2]);return this._elevationDataRequester.request(f,"binary",c).then(h=>this._lercDecoder.decode(h,{noDataValue:E.ELEVATION_NODATA_VALUE},c.signal)).then(h=>{h?e({values:h.pixelData,width:h.width,height:h.height,noDataValue:h.noDataValue,minValue:h.minValue,maxValue:h.maxValue}):d(Error("LERC decoding failed"))},d).finally(()=>{--this._asyncWorkItems})};g._requestMapTileData=function(a,b,c){++this._asyncWorkItems;const e=(r,w)=>{--this._asyncWorkItems;n.releaseTileData(w);
D.isAborted(c)||(this._dataMissing(a,x.LayerClass.MAP,b,r),this.requestUpdate())},d=r=>w=>e(w,r),f=r=>this._frameTask.schedule(()=>{--this._asyncWorkItems;this.requestUpdate();D.isAborted(c)?n.releaseTileData(r):this._mapTileDataArrived(a,b,r)},c.signal,d(r)).catch(d(r)),h=(r,w=null)=>this._frameTask.schedule(()=>e(r,w));if(n.isVectorTileLayerView(b)){var p=b.schemaHelper.getLevelRowColumn(a.lij);return b.fetchTile(p[0],p[1],p[2],c).then(f,h)}if(n.isImageryTileLayerView(b))return b.fetchTile(a.lij[0],
a.lij[1],a.lij[2],c).then(f,h);if(n.isTileLayerView(b)&&n.useFetchTileForLayer(b.layer))return b.layer.fetchTile(a.lij[0],a.lij[1],a.lij[2],c).then(r=>{D.isAborted(c)?(B.getLogger(this.declaredClass).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),h(D.createAbortError())):f(r)},h);p=b.getTileUrl(a.lij[0],a.lij[1],a.lij[2]);ua.isRefreshableLayer(b.layer)&&b.layer.refreshTimestamp&&(p+=`${p.includes("?")?"\x26":
"?"}_ts=${b.layer.refreshTimestamp}`);return this._mapDataRequester.request(p,b.hasMixedImageFormats?"image+type":"image",c).then(f,h)};g._mapTileDataArrived=function(a,b,c){b=this._getLayerIdxByUID(x.LayerClass.MAP,b.uid);q.isSome(b)?a.dataArrived(b,x.LayerClass.MAP,c):(n.releaseTileData(c),B.getLogger(this.declaredClass).warn("TerrainSurface: received data from unknown layer"))};g._getLayerIdxByUID=function(a,b){return this._layerIndexByUid[a].get(b)};g._dataMissing=function(a,b,c,e){c=this._getLayerIdxByUID(b,
c.uid);q.isSome(c)?a.dataMissing(c,b,e):B.getLogger(this.declaredClass).warn("TerrainSurface: received data from unknown layer")};g.updateTileOverlayParams=function(a){this.rootTiles&&this.overlayManager&&(this._allTiles.forAll(b=>{b.renderData&&this.overlayManager.setTileParameters(b)}),this._renderer.setNeedsRender(a))};g.getUsedMemory=function(){if(!this.tilingScheme)return 0;q.isNone(this._usedMemory)&&(this._usedMemory=this._recalculateUsedMemory());return q.isSome(this._usedMemory)?this._usedMemory:
0};g._recalculateUsedMemory=function(){return this.tilingScheme?this._allTiles.reduce((a,b)=>a+b.usedMemory,0):null};g.getUsedMemoryForLayerView=function(a){let b=0;const c=this._layerClassFromLayerView(a),e=this._getLayerIdxByUID(c,a.uid);q.isSome(e)&&this._allTiles.forAll(d=>b+=d.getUsedMemoryForLayer(c,e));return b};g.getTile=function(a){if(q.isNone(a)||q.isNone(this.rootTiles))return null;const b=a.split("/").map(f=>+f);if(0===b[0])return this.rootTiles.find(f=>f.lij[1]===b[1]&&f.lij[2]===b[2]);
a=2**b[0];const c=Math.floor(b[1]/a),e=Math.floor(b[2]/a);let d;this.rootTiles.some(f=>f.lij[1]===c&&f.lij[2]===e?(d=f,!0):!1);if(d){for(a=1<<b[0]-1;d.lij[0]<b[0];){let f=b[1]&a?2:0;0<(b[2]&a)&&f++;if(!d.children[f])return null;d=d.children[f];a>>=1}n.weakAssert(d.lij[0]===b[0]&&d.lij[1]===b[1]&&d.lij[2]===b[2],"not the right tile?");return d}return null};g.checkAllTilesWaterproofness=function(){if(n.ENABLE_WATERPROOFNESS_TESTS){var a=this.rootTiles;if(!q.isNone(a)){var b=d=>0<d?.renderData?.geometryInfo?.indices?.length,
c=d=>{if(d.intersectsClippingArea)if(d.renderData&&!d.renderData.geometryState&&console.error("Tile[",d.lij,"] has renderData but not geometryState"),d.renderData&&!d.renderData.geometryInfo&&console.error("Tile[",d.lij,"] has renderData but not geometryInfo"),!d.renderData?.geometryInfo||0<(d.renderData.geometryInfo.indices?.length??0)||console.error("Tile[",d.lij,"] has renderData but no indices - geometryInfo: ",d.renderData.geometryInfo),b(d)){d.checkGeometryWaterproofness();for(const p of d.children){var f=
p,h=d;b(f)&&console.error("Tile[",f.lij,"] has geometry although parent[",h.lij,"] has geom")}}else if(d.isLeaf)console.error("Tile[",d.lij,"] has no geometry and no children, from root to leaf");else for(f of d.children)c(f)},e=d=>{const f=d.parent?.visible??!0,h=d.visible;d.computeVisibility();const p=d.visible;h!==p&&f&&console.error(" Tile[",d.lij,"] has out of date visibility: ",h," instead of ",p);if(!d.isLeaf)for(const r of d.children)e(r)};for(const d of a)c(d),e(d)}}};g._updateShadingIfChanged=
function(){this.view?.map?.ground?.shading!==this._shading&&this._updateShading()};g._updateShading=function(){const a=this.view?.map?.ground?.shading;this._shading=a;this.renderer&&(this.renderer.shading=a,this.renderer.setNeedsRender());this._updateAllTileGeometries()};g.isEastEndWrap=function(a){return this.isGlobal&&a[2]===this.lijEastEnd(a[0])-1};g.isWestEndWrap=function(a){return this.isGlobal&&0===a[2]};g.lijEastEnd=function(a){const b=q.isSome(this.spatialReference)&&this.spatialReference.isGeographic;
return 2**(a+(b?1:0))};g.wrapEastWest=function(a){const b=this.lijEastEnd(a[0]),c=a[2];return 0<=c&&c<b?a:this.isGlobal?[a[0],a[1],(c+(0>c?b:0))%b]:null};g.enableInternalChecks=function(a){n.enableTerrainInternalChecks(a)};g.enableWaterproofnessChecks=function(a){n.enableTerrainWaterproofnessChecks(a)};R._createClass(y,[{key:"renderer",get:function(){return this._renderer}},{key:"frustum",get:function(){return this._frustum}},{key:"snapLevel",get:function(){if(this.lodSnapping===F.LODSnapping.ON){var a=
this.view,b=this.tilingScheme;const c=a.pointsOfInterest?.contentCameraOnSurface?.scale;if(c&&b){const e=a.state.contentCamera;a=za.directionToHeadingTilt(a,e.eye,e.viewForward,e.up).tilt;90<a&&(a=180-a);a=2*(a/90)**2;b=b.levelAtScale(c);return Math.round(b-a)}}return null}},{key:"lodSnapping",get:function(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?F.LODSnapping.ON:F.LODSnapping.OFF}},{key:"upsampleInfoPool",get:function(){return this._upsampleInfoPool}},{key:"upsampleMapCache",
get:function(){return this._upsampleMapCache}},{key:"elevationQueryCache",get:function(){return this._elevationQueryCache}},{key:"mapTileRequester",get:function(){return this._mapDataRequester}},{key:"_userClippingExtent",get:function(){var {spatialReference:a}=this,{clippingArea:b}=this.view;if(q.isNone(b)||q.isNone(a))return null;const c=A.create();a=Aa.toBoundingRect(b,c,a)?c:null;b=this._get("extent");return A.equals(a,b)?b:a}},{key:"rootTilesExtent",get:function(){return this._rootTilesExtent}},
{key:"extent",get:function(){const a=A.intersection(this.groundExtent,this._userClippingExtent,A.create()),b=this._get("extent");return A.equals(a,b)?b:a}},{key:"groundExtent",get:function(){return q.isSome(this._tilingSchemeExtent)?this._tilingSchemeExtent:this._rootTilesExtent}},{key:"_tilingSchemeExtent",get:function(){return this.tilingSchemeLogic?.extent}},{key:"updating",get:function(){this._hasPendingUpdates||(this._maxNumUpdating=1);return!!((this.running||this._watchUpdatingTracking.updating||
0<this._asyncWorkItems)&&this.ready&&!this.suspended||this.overlayManager.updating)}},{key:"running",get:function(){return(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._frameTask.updating)&&this.ready&&!this.suspended}},{key:"updatingProgressValue",get:function(){this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating);return 1-this._pendingUpdates/this._maxNumUpdating}},{key:"baseOpacity",get:function(){return this.view.map.ground.opacity},
set:function(a){this.view.map.ground.opacity=a}},{key:"viewingMode",get:function(){return this.view.state.viewingMode}},{key:"ready",get:function(){return q.isSome(this.rootTiles)}},{key:"renderOrder",set:function(a){this._renderer.renderOrder=a;this._set("renderOrder",a)}},{key:"spatialReference",get:function(){return this.tilingScheme?.spatialReference??null}},{key:"backgroundColor",get:function(){return this.view.map.ground.surfaceColor},set:function(a){this.view.map.ground.surfaceColor=a}},{key:"slicePlaneEnabled",
set:function(a){this._renderer.slicePlaneEnabled=a;this._set("slicePlaneEnabled",a);this._evaluateTransparency(this.baseOpacity)}},{key:"tilingSchemeLocked",get:function(){return this.tilingSchemeLogic?.tilingSchemeLocked??!1}},{key:"velvetOverground",set:function(a){a!==this.velvetOverground&&(this._renderer.velvetOverground=a);this._set("velvetOverground",a)}},{key:"wireframe",get:function(){return this._renderer.wireframe},set:function(a){a!==this._renderer.wireframe&&(this._renderer.wireframe=
a,this._updateAllTileGeometries())}},{key:"_visible",set:function(a){a!==this._visibleCached&&(this._visibleCached=a,this._renderer.setVisibility(a),this.suspended=!a)}},{key:"opaque",get:function(){return this._renderer.transparency===H.TransparencyMode.Opaque}},{key:"suspended",set:function(a){this._set("suspended",a);this._viewChangeUpdate()}},{key:"textureFadeDuration",get:function(){return this.view.qualitySettings.tiledSurface.textureFadeDuration??0}},{key:"updatingRootTiles",get:function(){return this._updatingRootTiles}},
{key:"_lodBias",get:function(){return this.view.qualitySettings.tiledSurface.lodBias-(1-this.view.resourceController.memoryController.memoryFactor)*E.MAX_MEMORY_LOD_BIAS}},{key:"shortBatches",get:function(){return this.view.state.mode!==La.RenderState.IDLE}},{key:"performanceInfo",get:function(){const a=this._performanceInfo;a.numNodes=this._allTiles.length;a.numLeaves=a.numVisible=a.numRendered=a.numLoadedPerLevel.length=a.numRenderedPerLevel.length=0;this._allTiles.forAll(b=>{b.isLeaf&&a.numLeaves++;
const c=b.level;b.renderData&&(a.numLoadedPerLevel[c]=(a.numLoadedPerLevel[c]||0)+1);b.visible&&(a.numVisible++,b.rendered&&(a.numRenderedPerLevel[c]=(a.numRenderedPerLevel[c]||0)+1,a.numRendered++))});return a}},{key:"renderPatchBorders",get:function(){return this._renderer.renderPatchBorders},set:function(a){this._renderer.renderPatchBorders=a}},{key:"visualizeNormals",get:function(){return this._renderer.visualizeNormals},set:function(a){this._renderer.visualizeNormals=a}},{key:"renderingDisabled",
get:function(){return this._renderer.renderingDisabled},set:function(a){this._renderer.renderingDisabled=a}},{key:"test",get:function(){const a=this;return{renderer:a._renderer,lercDecoder:a._lercDecoder,forceReload:()=>{q.isSome(a.rootTiles)&&(a._mergeTile(a.rootTiles[0]),a._viewChangeUpdate())},getTiles:()=>a._allTiles.toArray(),getRenderedTiles(){Q.clear();a._allTiles.forAll(c=>{c.visible&&c.rendered&&Q.push(c)});const b=Q.toArray();G.sortTiles(a.renderOrder,b);return b},lockTilingScheme(b,c){a._extentHelper.defaultTiledLayersExtent=
c;a.tilingSchemeLogic.test.lockTilingScheme(b)}}}},{key:"isGlobal",get:function(){return this._isGlobal}},{key:"shading",get:function(){return this._shading}},{key:"isWebMercator",get:function(){return this._isWebMercator}},{key:"isWebMercatorOnPlateeCarree",get:function(){return this._isWebMercatorOnPlateeCarree}}]);return y}(ja.EventedMixin(k));l.__decorate([m.property()],k.prototype,"_renderer",void 0);l.__decorate([m.property()],k.prototype,"_hasPendingUpdates",void 0);l.__decorate([m.property()],
k.prototype,"_asyncWorkItems",void 0);l.__decorate([m.property()],k.prototype,"_allTilesDirty",void 0);l.__decorate([m.property()],k.prototype,"_allTilesSorted",void 0);l.__decorate([m.property()],k.prototype,"_viewChanged",void 0);l.__decorate([m.property({readOnly:!0})],k.prototype,"_watchUpdatingTracking",void 0);l.__decorate([m.property()],k.prototype,"_frameTask",void 0);l.__decorate([m.property({readOnly:!0})],k.prototype,"snapLevel",null);l.__decorate([m.property({readOnly:!0})],k.prototype,
"lodSnapping",null);l.__decorate([m.property({constructOnly:!0})],k.prototype,"view",void 0);l.__decorate([m.property()],k.prototype,"_userClippingExtent",null);l.__decorate([m.property()],k.prototype,"_rootTilesExtent",void 0);l.__decorate([m.property({readOnly:!0})],k.prototype,"extent",null);l.__decorate([m.property({readOnly:!0})],k.prototype,"groundExtent",null);l.__decorate([m.property({readOnly:!0})],k.prototype,"_tilingSchemeExtent",null);l.__decorate([m.property({readOnly:!0})],k.prototype,
"updating",null);l.__decorate([m.property({readOnly:!0})],k.prototype,"running",null);l.__decorate([m.property(Ba.updatingProgress)],k.prototype,"updatingProgress",void 0);l.__decorate([m.property({readOnly:!0})],k.prototype,"updatingProgressValue",null);l.__decorate([m.property()],k.prototype,"_maxNumUpdating",void 0);l.__decorate([m.property()],k.prototype,"baseOpacity",null);l.__decorate([m.property()],k.prototype,"hasCompositeBlendMode",void 0);l.__decorate([m.property({readOnly:!0})],k.prototype,
"overlayManager",void 0);l.__decorate([m.property({readOnly:!0})],k.prototype,"viewingMode",null);l.__decorate([m.property()],k.prototype,"maxTextureScale",void 0);l.__decorate([m.property({readOnly:!0})],k.prototype,"ready",null);l.__decorate([m.property({value:Fa.RenderOrder.FRONT_TO_BACK})],k.prototype,"renderOrder",null);l.__decorate([m.property({readOnly:!0})],k.prototype,"rootTiles",void 0);l.__decorate([m.property({readOnly:!0})],k.prototype,"spatialReference",null);l.__decorate([m.property({type:fa})],
k.prototype,"backgroundColor",null);l.__decorate([m.property({value:!1})],k.prototype,"slicePlaneEnabled",null);l.__decorate([m.property({readOnly:!0})],k.prototype,"tilingScheme",void 0);l.__decorate([m.property({readOnly:!0})],k.prototype,"tilingSchemeLocked",null);l.__decorate([m.property({readOnly:!0})],k.prototype,"tilingSchemeLogic",void 0);l.__decorate([m.property({value:!0})],k.prototype,"velvetOverground",null);l.__decorate([m.property()],k.prototype,"wireframe",null);l.__decorate([m.property({value:!1})],
k.prototype,"suspended",null);l.__decorate([m.property()],k.prototype,"textureFadeDuration",null);l.__decorate([m.property()],k.prototype,"visibleElevationBounds",void 0);l.__decorate([m.property()],k.prototype,"rootTileElevationBounds",void 0);l.__decorate([m.property()],k.prototype,"_layerViewsDirty",void 0);l.__decorate([m.property()],k.prototype,"renderPatchBorders",null);l.__decorate([m.property()],k.prototype,"visualizeNormals",null);l.__decorate([m.property()],k.prototype,"renderingDisabled",
null);l=k=l.__decorate([ma.subclass("esri.views.3d.terrain.TerrainSurface")],k);const z=qa.create(),Ma=A.create(),M=[0,0,0],Q=new S,P={spatialReference:null,extent:A.create(),context:"ground"},N={spatialReference:null,extent:null,scale:0};return l});