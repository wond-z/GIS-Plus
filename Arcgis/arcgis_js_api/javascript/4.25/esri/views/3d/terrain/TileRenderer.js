// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/mathUtils ../../../core/maybe ../../../chunks/vec2 ../../../chunks/vec2f64 ../../../layers/support/layerUtils ../support/StreamDataLoader ./BlendLayersTechnique ./interfaces ./LayerClass ./terrainUtils ./TextureFader ./TextureReference ./TileCompositor ./TileTexture ./TileUpdate ../webgl-engine/core/shaderLibrary/output/BlendOptions ../webgl-engine/core/shaderLibrary/terrain/TileBackground.glsl ../webgl-engine/lib/glUtil3D ../../webgl/enums ../../webgl/Texture".split(" "),
function(K,ea,fa,m,Q,R,ha,ia,ja,S,H,t,L,M,ka,D,I,T,v,U,A,E){function N(e,d){p.layerIndex=d;const a=e.layerInfo[H.LayerClass.MAP][d];if(m.isSome(a.data))return Q.set(p.offset,0,0),p.tile=e,p.scale=1,p.sourceLod=e.lij,p.sourceLayerInfo=a,p;e=a.upsampleInfo;return m.isSome(e)?(d=e.tile.layerInfo[H.LayerClass.MAP][d],p.tile=e.tile,Q.copy(p.offset,e.offset),p.scale=e.scale,p.sourceLod=e.tile.lij,p.sourceLayerInfo=d,p):null}function V(e){let d="normal"!==e.blendMode;t.isGroupLayer(e.parent)&&(d=V(e.parent)||
d);return d}function W(e,d){t.isGroupLayer(e.parent)&&W(e.parent,d);const a=e.get("uid");m.isSome(a)&&""!==a&&(F.has(a)?F.get(a).start=d:F.set(a,new X(d,d,e.blendMode,e.opacity)))}let X=function(e,d,a,c){this.start=e;this.end=d;this.blendMode=a;this.opacity=c},la=function(){function e(a,c,b){this._rctx=a;this.tileSize=c;this._techniqueRepository=b;this._passParameters=new ja.BlendLayersPassParameters;this._backgroundColor=this._backgroundTexture=null;this._backgroundDirty=!1;this._blackTex=null;this._maxAnisotropy=
this._rctx.parameters.maxMaxAnisotropy;this._composition=new ka.TileCompositor(this._rctx,this._techniqueRepository);this._blackTex=new D(U.createColorTexture(this._rctx,[0,0,0,1]));this._ensureBackgroundTexture(this.tileSize)}var d=e.prototype;d.dispose=function(){this._composition=m.disposeMaybe(this._composition);this._backgroundTexture=m.releaseMaybe(this._backgroundTexture);this._blackTex=m.releaseMaybe(this._blackTex)};d.updateTileTexture=function(a,c){if(a.renderData){var b=a.surface,h=b.baseOpacity,
n=0,J=0,f=this.tileSize,G=!1,q=b.view.state.pixelRatio,B=!1;F.clear();C.length=0;for(var w=a.layerInfo[H.LayerClass.MAP],x=w.length,g=0;g<w.length;g++){const k=b.layerViewByIndex(g,H.LayerClass.MAP);var y=k.layer.opacity;Y[g]=y;const l=k.fullOpacity;Z[g]=l;ha.isBaseLayer(k.layer)&&x>=w.length&&(x=g);if(t.isBlendableLayerView(k)){aa[g]=k.layer.blendMode;var u="normal"!==k.layer.blendMode;if(t.isGroupLayer(k.layer.parent)){const z=k.layer.parent.get("uid");m.isSome(z)&&""!==z&&(u=V(k.layer.parent)||
u)}u&&(B=u,G=!1)}if(0!==y||B){if(++J,y=N(a,g))w[g].pendingUpdates&=~(I.TileUpdate.TEXTURE_NOFADING&I.TileUpdate.TEXTURE_FADING),t.isGroupLayer(k.layer.parent)&&(u=k.layer.parent.get("uid"),m.isSome(u)&&""!==u&&W(k.layer.parent,g)),t.isVectorTileLayerView(k)?f=Math.max(f,this.tileSize*q):1===h&&1===l&&(k.isOpaque||this._dataToTexture(y)&&y.sourceLayerInfo.data.descriptor.isOpaque)&&(G=!0),++n}else w[g].pendingUpdates&=~(I.TileUpdate.TEXTURE_NOFADING&I.TileUpdate.TEXTURE_FADING)}q=f;f=fa.nextHighestPowerOfTwo(q);
b=f*f;h=q*q;b===h?f=q:(q=f/2,f=b-h<h-q*q?f:q);b=f/this.tileSize;--g;this._ensureBackgroundTexture(this.tileSize);0===n?this._useBackgroundTexture(a,J):(1!==n||B||!this._useLayerTexture(a,g,x,Z[g]))&&this._composeMapLayers(a,c,g,x,Y,aa,f,b,!G||B,F,B)}};d._ensureBackgroundTexture=function(a){m.isNone(this._backgroundTexture)&&(this._backgroundTexture=this._buildTexture(a),this._backgroundDirty=!0);this._backgroundDirty&&(this._composition.bind(a),this._passParameters.offset=R.ZEROS,this._passParameters.scale=
1,this._passParameters.opacity=1,m.isSome(this.backgroundColor)&&(this._passParameters.backgroundColor=this.backgroundColor),this._composition.drawBackground(this._passParameters,m.isSome(this.backgroundColor)),this._composition.copyFBOToTexture(this._backgroundTexture),this._composition.unbind(),this._backgroundDirty=!1)};d._useBackgroundTexture=function(a,c){let b=L.ActivationTime.Immediate;if(a.surface.view.layerViewManager.updating||0<c)b=L.ActivationTime.Delayed;this._backgroundTexture&&m.isNone(a.renderData.textureReference)&&
(b=L.ActivationTime.Immediate);a.renderData.setTextureReference(m.isSome(this._backgroundTexture)?new M.TextureReference(this._backgroundTexture,S.TextureUpdate.FADING,ba,a.surface.baseOpacity,0,1):null,b)};d._useLayerTexture=function(a,c,b,h){var n=c<b;b=n?1:a.surface.baseOpacity;n=n?a.surface.baseOpacity:1;c=N(a,c);return this._dataToTexture(c)?(a.renderData.setTextureReference(new M.TextureReference(c.sourceLayerInfo.data,S.TextureUpdate.FADING,c,b,n,h)),!0):!1};d._composeMapLayers=function(a,
c,b,h,n,J,f,G,q,B,w){this._composition.ensureBuffer(f);const x=a.surface.baseOpacity;let g=!1,y=A.TextureSamplingMode.LINEAR_MIPMAP_LINEAR,u=!1,k=0;for(let r=b;0<=r;r--){var l=N(a,r);if(!l)continue;if(0===n[r]&&!w)continue;var z=r<h&&1>x&&!g;this._passParameters.baseOpacity=z?x:1;b=1>this._passParameters.baseOpacity?v.BaseOpacityMode.Required:v.BaseOpacityMode.NotRequired;z&&(g=!0);let ca=!1;B.forEach(da=>{da.start===r&&(C.push(da),this._composition.openGroup(f),ca=!0)});z=0===k;const O=ca?v.BlendLayersOutput.GroupBackgroundComposite:
q&&z?this.backgroundIsGrid?v.BlendLayersOutput.GridComposite:v.BlendLayersOutput.ColorComposite:v.BlendLayersOutput.Composite,P=T.blendModeFromString[J[r]];t.isVectorTileRenderInfo(l)?(this._passParameters.opacity=n[r],u=this._composition.drawVectorData(this._passParameters,O,f,P,b,l,G,this.tileSize,u)):t.isImageryTileRenderInfo(l)?(this._passParameters.opacity=n[r],this._composition.drawImageryTileData(this._passParameters,O,f,P,b,l),this._hasNearestInterpolation(l)&&(y=A.TextureSamplingMode.NEAREST)):
this._dataToTexture(l)&&(this._passParameters.texture=l.sourceLayerInfo.data.texture,this._passParameters.offset=l.offset,this._passParameters.scale=l.scale,this._passParameters.opacity=n[r],this._composition.drawRasterData(this._passParameters,O,f,P,b));for(;0<C.length&&C[C.length-1].end===r;)l=C.pop(),this._passParameters.opacity=l.opacity,this._passParameters.offset=R.ZEROS,this._passParameters.scale=1,this._composition.drawGroup(this._passParameters,q&&z?this.backgroundIsGrid?v.BlendLayersOutput.GridComposite:
v.BlendLayersOutput.ColorComposite:v.BlendLayersOutput.Composite,f,T.blendModeFromString[l.blendMode],b);k++}h=a.renderData.ensureTexture(f,()=>this._buildTexture(f,y));this._composition.copyFBOToTexture(h);this._composition.unbind();a.renderData.setTextureReference(new M.TextureReference(h,c,ba,g?1:x,0,1))};d._hasNearestInterpolation=function(a){a=a.sourceLayerInfo.data;return a.source?"nearest"===a.interpolation:!1};d._dataToTexture=function(a){if(t.isRasterTileRenderInfo(a)){const c=a.sourceLayerInfo;
c.data=this._buildTexture(c.data);a.tile.setMemoryDirty()}return t.isTextureTileRenderInfo(a)};d.setBackground=function(a){this._backgroundColor!==a&&(this._backgroundColor=a,this._backgroundDirty=!0)};d._buildTexture=function(a,c=A.TextureSamplingMode.LINEAR_MIPMAP_LINEAR){if(m.isNone(a))return null;const b={target:A.TextureType.TEXTURE_2D,pixelFormat:A.PixelFormat.RGBA,dataType:A.PixelType.UNSIGNED_BYTE,wrapMode:A.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:c,maxAnisotropy:this._maxAnisotropy,flipped:!0,
hasMipmap:!0};c=this._rctx;let h;if("number"===typeof a)b.width=b.height=a,h=new D(new E.Texture(c,b));else if(a instanceof ia.ImageWithType)b.isOpaque=a.isOpaque,h=new D(new E.Texture(c,b,a.image)),a.release();else try{b.width=a.width,b.height=a.height,h=new D(new E.Texture(c,b,a))}catch(n){h=new D(U.createEmptyTexture(c)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}a=c.bindTexture(h.texture,E.Texture.TEXTURE_UNIT_FOR_UPDATES);h.generateMipmap();
c.bindTexture(a,E.Texture.TEXTURE_UNIT_FOR_UPDATES);return h};ea._createClass(e,[{key:"backgroundIsGrid",get:function(){return m.isNone(this._backgroundColor)}},{key:"backgroundColor",get:function(){return this._backgroundColor}},{key:"test",get:function(){return{backgroundTexture:this._backgroundTexture}}}]);return e}();const Y=[],Z=[],aa=[],F=new Map,C=[],p={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0},ba={offset:[0,0],scale:1};K.GroupInfo=X;K.TileRenderer=la;
Object.defineProperties(K,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});