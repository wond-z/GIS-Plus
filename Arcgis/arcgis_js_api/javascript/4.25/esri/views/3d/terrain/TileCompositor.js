// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../core/Logger ../../../core/maybe ../../../chunks/vec2f64 ../../2d/engine/imagery/enums ../../2d/engine/vectorTiles/VectorTileRendererHelper3D ./BlendLayersTechnique ./LayerClass ./RasterColorizerTechnique ./support/MultiSizeFramebuffer ../webgl-engine/core/shaderLibrary/output/BlendOptions ../webgl-engine/core/shaderLibrary/terrain/TileBackground.glsl ../../../chunks/BlendLayers.glsl ../webgl-engine/lib/BindParameters ../webgl-engine/lib/DefaultVertexBufferLayouts ../webgl-engine/lib/glUtil3D ../../webgl/enums ../../webgl/Texture ../../webgl/Util".split(" "),
function(u,r,l,H,v,I,w,x,y,z,p,g,A,J,K,L,m,B,M){const N=r.getLogger("esri.views.3d.terrain");r=function(){function C(a,b){this._rctx=a;this._techniqueRepository=b;this._fbos=[];this._vectorTileHelper=new I.VectorTileRendererHelper3D;this._bindParameters=new J.BindParameters(null,null,null);this._blendLayersTechniqueConfig=new w.BlendLayersTechniqueConfiguration;this._current=0;this._lastUsedIds=[];this._lastCreatedBufferId=0;this._onHoldIds=[];this._vaoQuad=L.createQuadVAO(this._rctx,K.Pos2Tex)}var e=
C.prototype;e.dispose=function(){this._fbos.forEach(a=>{a.dispose();a=null});this._fbos=null;this._vtFBO=l.disposeMaybe(this._vtFBO);this._vaoQuad=l.disposeMaybe(this._vaoQuad);this._vectorTileHelper=l.disposeMaybe(this._vectorTileHelper);this._backgroundTechnique=l.releaseMaybe(this._backgroundTechnique);this._applyOpacityTechnique=l.releaseMaybe(this._applyOpacityTechnique);this._blendLayersTechnique=l.releaseMaybe(this._blendLayersTechnique)};e._getBlendLayersTechnique=function(a,b,c,d=g.PremultipliedAlphaSource.Off,
h=A.BackgroundMode.BelowLayer){this._blendLayersTechniqueConfig.output=b;this._blendLayersTechniqueConfig.blendMode=a;this._blendLayersTechniqueConfig.baseOpacityMode=c;this._blendLayersTechniqueConfig.premultipliedSource=d;this._blendLayersTechniqueConfig.background=h;return this._blendLayersTechnique=this._techniqueRepository.releaseAndAcquire(w.BlendLayersTechnique,this._blendLayersTechniqueConfig,this._blendLayersTechnique)};e.drawBackground=function(a,b){b=this._getBlendLayersTechnique(p.LayerBlendMode.Normal,
b?g.BlendLayersOutput.ColorComposite:g.BlendLayersOutput.GridComposite,g.BaseOpacityMode.NotRequired,g.PremultipliedAlphaSource.Off,A.BackgroundMode.Only);a=this._rctx.bindTechnique(b,a,this._bindParameters);this._render(a)};e._render=function(a){this._rctx.bindVAO(this._vaoQuad);a.assertCompatibleVertexAttributeLocations(this._vaoQuad);this._rctx.drawArrays(m.PrimitiveType.TRIANGLE_STRIP,0,M.vertexCount(this._vaoQuad,"geometry"))};e.drawGroup=function(a,b,c,d,h,f=g.PremultipliedAlphaSource.On){b===
g.BlendLayersOutput.Composite&&(a.fboTexture=this._fbos[this.getLastOnHoldId()].get(c).colorTexture);a.texture=this.currentFBO(c).colorTexture;this.closeGroup(c);b=this._getBlendLayersTechnique(d,b,h,f);a=this._rctx.bindTechnique(b,a,this._bindParameters);this._render(a)};e.drawRasterData=function(a,b,c,d,h,f=g.PremultipliedAlphaSource.Off){l.isNone(a.texture)||(a.fboTexture=b===g.BlendLayersOutput.GroupBackgroundComposite||d===p.LayerBlendMode.Normal&&h===g.BaseOpacityMode.NotRequired&&f===g.PremultipliedAlphaSource.Off?
null:this.switch(c).colorTexture,b=this._getBlendLayersTechnique(d,b,h,f),a=this._rctx.bindTechnique(b,a,this._bindParameters),this._render(a))};e.drawImageryTileData=function(a,b,c,d,h,f){var k=f.sourceLayerInfo.data;k.source&&(f.tile.surface.layerViewByIndex(f.layerIndex,x.LayerClass.MAP).ensureSymbolizerParameters(k),k.bind(this._rctx)&&(a.fboTexture=d===p.LayerBlendMode.Normal&&h===g.BaseOpacityMode.NotRequired?null:this.switch(c).colorTexture,b=this._getRasterColorizerTechnique(k,b,d,h),k.opacity=
a.opacity,k=k.getUniforms(),k.scale=f.scale,k.offset=f.offset,k.backgroundColor=a.backgroundColor,k.fboTexture=a.fboTexture,k.baseOpacity=a.baseOpacity,a=this._rctx.bindTechnique(b,k,null),this._render(a)))};e._getRasterColorizerTechnique=function(a,b,c,d){const h=a.symbolizerParameters,f=["stretch","lut","hillshade"].indexOf(h.type);l.isNone(this._rasterColorizerConfig)&&(this._rasterColorizerConfig=new y.RasterColorizerTechniqueConfiguration,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),
this._rctx.gl.getExtension("OES_texture_float"));this._rasterColorizerConfig.output=b;this._rasterColorizerConfig.blendMode=c;this._rasterColorizerConfig.baseOpacityMode=d;this._rasterColorizerConfig.colorizerType=f;this._rasterColorizerConfig.applyColormap=!!h.colormap;this._rasterColorizerConfig.stretchType=a.hasStretchTypeNone()?v.RasterColorizerStretchType.Noop:v.RasterColorizerStretchType.PerBand;return this._rasterColorizerTechnique=this._techniqueRepository.releaseAndAcquire(y.RasterColorizerTechnique,
this._rasterColorizerConfig,this._rasterColorizerTechnique)};e.drawVectorData=function(a,b,c,d,h,f,k,O,D){const n=this._rctx,P=f.sourceLayerInfo.data,t=f.tile.surface.layerViewByIndex(f.layerIndex,x.LayerClass.MAP),E=h===g.BaseOpacityMode.Required||1>a.opacity||d!==p.LayerBlendMode.Normal||b!==g.BlendLayersOutput.Composite,F=E?g.PremultipliedAlphaSource.On:g.PremultipliedAlphaSource.Off;this._getBlendLayersTechnique(d,b,h,F).bindPipelineState(n);let q=null,G=null;E?(G=this.currentFBO(c),l.isNone(this._vtFBO)&&
(this._vtFBO=new z.MultiSizeFramebuffer(this._rctx)),q=this._vtFBO.get(c),n.bindFramebuffer(q),this._clearCurrentFBO()):D&&n.clearSafe(m.ClearBufferBit.DEPTH_BUFFER_BIT);try{this._vectorTileHelper.render(n,f.sourceLod,P,t.painter,t.layer.styleRepository,t.schemaHelper,Math.round(1/f.scale),f.offset,O,k)}catch(Q){N.warnOnce("A render call containing vector tiles did not resolve correctly.",Q)}return l.isSome(q)?(n.bindFramebuffer(G),a.texture=q.colorTexture,a.offset=H.ZEROS,a.scale=1,this.drawRasterData(a,
b,c,d,h,F),D):!0};e.copyFBOToTexture=function(a){const b=this._rctx,c=b.bindTexture(a.texture,B.Texture.TEXTURE_UNIT_FOR_UPDATES),d=a.descriptor;b.gl.copyTexImage2D(m.TextureType.TEXTURE_2D,0,d.pixelFormat,0,0,d.width,d.height,0);a.generateMipmap();b.bindTexture(c,B.Texture.TEXTURE_UNIT_FOR_UPDATES)};e._clearCurrentFBO=function(){this._rctx.setClearColor(0,0,0,0);this._rctx.setClearDepth(1);this._rctx.clearSafe(m.ClearBufferBit.COLOR_BUFFER_BIT|m.ClearBufferBit.DEPTH_BUFFER_BIT)};e._initFBO=function(a,
b,c){this._rctx.bindFramebuffer(a);c&&(this._rctx.setViewport(0,0,b,b),this._clearCurrentFBO())};e.ensureBuffer=function(a){this._lastUsedIds.length=0;this._lastUsedIds.push(1);this._lastCreatedBufferId=1;this._onHoldIds.length=0;this.bind(a)};e.bind=function(a,b=0,c=!0){this._current=b;if(b>=this._fbos.length)for(let d=this._fbos.length;d<=b;d++)this._fbos.push(new z.MultiSizeFramebuffer(this._rctx));this._initFBO(this._fbos[b].get(a),a,c)};e._bindNextFreeBuffer=function(a){0<this._lastUsedIds.length?
this.bind(a,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(a,this._lastCreatedBufferId))};e.openGroup=function(a){this._onHoldIds.push(this._current);this._bindNextFreeBuffer(a)};e.switch=function(a){const b=this.currentFBO(a),c=this._current;this._bindNextFreeBuffer(a);this._lastUsedIds.push(c);return b};e.getLastOnHoldId=function(){return this._onHoldIds[this._onHoldIds.length-1]};e.closeGroup=function(a){const b=this._current;this._bindNextFreeBuffer(a);this._lastUsedIds.push(b);
this._lastUsedIds.push(this._onHoldIds.pop())};e.unbind=function(){this._rctx.bindFramebuffer(null)};e.currentFBO=function(a){return this._fbos[this._current].get(a)};return C}();u.TileCompositor=r;Object.defineProperties(u,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});