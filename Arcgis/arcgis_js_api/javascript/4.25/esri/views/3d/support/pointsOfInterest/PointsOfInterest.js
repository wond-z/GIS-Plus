// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Handles ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/support/ray ../debugFlags ../debugUtils ../PropertiesPool ../geometryUtils/ray ./CameraOnSurface ./CenterOnSurface ./ContentGeometryUpdates ./Focus ./StableSurfaceCenter ./SurfaceGeometryUpdates ../../webgl-engine/lib/Intersector ../../webgl-engine/lib/IntersectorInterfaces ../../webgl-engine/lib/verticalOffsetUtils ../../../support/Scheduler".split(" "),
function(b,x,d,F,G,r,g,e,V,W,H,t,z,A,I,l,J,K,B,u,L,M,N,O,C,P,Q,p){b.PointsOfInterest=function(D){function v(a){a=D.call(this,a)||this;a._handles=new G;a._tmpRay=A.create();a._centerRayDirty=!0;a._surfaceAltitudeAtCenter=0;a._surfaceAltitudeAtCenterDirty=!0;a._contentAltitudeAtCenter=0;a._contentAltitudeAtCenterDirty=!0;a._propertiesPool=new J.PropertiesPool({renderPointOfView:R},x._assertThisInitialized(a));a.renderPointOfView=z.create();a._pois=[];a._debugCenters=new Map;return a}x._inheritsLoose(v,
D);var k=v.prototype;k.initialize=function(){const {state:a,basemapTerrain:c,renderCoordsHelper:h,map:w}=this.view;this._surfaceIntersector=C.newIntersector(a.viewingMode);this._surfaceIntersector.options.backfacesTerrain=a.isGlobal?!1:!0;this._surfaceIntersector.options.invisibleTerrain=!1;this._surfaceIntersector.options.store=P.StoreResults.MIN;this._contentIntersector=C.newIntersector(a.viewingMode);var f=()=>this._estimateSurfaceAltitudeAtCenter();const E=this.view.resourceController.scheduler,
y=r.unwrap(this.view.basemapTerrain?.elevationQueryCache),m={state:a,scheduler:E,surface:c,renderCoordsHelper:h};this._set("centerOnSurfaceInfrequent",new u.CenterOnSurface({...m,task:p.TaskPriority.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:f}));this._set("centerOnSurfaceFrequent",new u.CenterOnSurface({...m,task:p.TaskPriority.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:f}));this._set("contentCenterOnSurface",new u.CenterOnSurface({...m,task:p.TaskPriority.POINT_OF_INTEREST_INFREQUENT,
estimateSurfaceAltitudeAtCenter:f,cameraName:"contentCamera"}));this._set("centerOnContent",new u.CenterOnSurface({...m,task:p.TaskPriority.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()}));this._set("cameraOnSurface",new B.CameraOnSurface({...m,cache:y,task:p.TaskPriority.POINT_OF_INTEREST_INFREQUENT,map:w}));this._set("contentCameraOnSurface",new B.CameraOnSurface({...m,cache:y,task:p.TaskPriority.POINT_OF_INTEREST_INFREQUENT,map:w,cameraName:"contentCamera"}));
this._set("surfaceGeometryUpdates",new O.SurfaceGeometryUpdates({...m,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]}));this._set("contentGeometryUpdates",new L.ContentGeometryUpdates({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:h}));this._set("surfaceOrigin",new N.StableSurfaceCenter({cache:y,view:this.view}));this._set("focus",new M.Focus({state:a,scheduler:E,surface:c,renderCoordsHelper:h,centerOnSurface:this.contentCenterOnSurface,
estimateSurfaceIntersectionAtRenderPoint:(n,S)=>this._estimateSurfaceIntersectionAtRenderPoint(n,this.view.state.contentCamera,S)}));this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.contentCenterOnSurface,this.cameraOnSurface,this.contentCameraOnSurface,this.focus);f=this.view.graphics;this._debugCenters.set(this.centerOnContent,new l.PointGraphics(f,"red","CenterOnContent"));this._debugCenters.set(this.centerOnSurfaceFrequent,new l.PointGraphics(f,
"red","CenterOnSurface"));this._debugCenters.set(this.centerOnSurfaceInfrequent,new l.PointGraphics(f,"red","CenterOnSurface"));this._debugCenters.set(this.contentCenterOnSurface,new l.PointGraphics(f,"red","ContentCenterOnSurface"));this._debugCenters.set(this.cameraOnSurface,new l.PointGraphics(f,"blue","CameraOnSurface"));this._debugCenters.set(this.contentCameraOnSurface,new l.PointGraphics(f,"blue","ContentCameraOnSurface"));this._debugCenters.set(this.focus,new l.PointGraphics(f,"green","Focus"));
this._handles.add([g.watch(()=>a.camera,n=>this._cameraChanged(n),g.sync),g.watch(()=>c.extent,()=>this._updateCenterPointsOfInterest()),g.when(()=>!c.updating,()=>this._updateCenterPointsOfInterest(),g.sync),g.on(()=>this.surfaceGeometryUpdates.events,"request-update",()=>this._updateCenterPointsOfInterest()),g.on(()=>this.contentGeometryUpdates.events,"request-update",()=>this._updateCenterOnContent()),g.when(()=>I.SHOW_POI,n=>this._setDebug(n),g.initial)]);this._cameraChanged(this.view.state.camera);
for(const n of this._pois)n.runTask()};k.destroy=function(){this._setDebug(!1);this._handles.destroy();this._propertiesPool.destroy();for(const a of this._pois)a.destroy();this.surfaceOrigin.destroy()};k._estimateContentAltitudeAtCenter=function(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const a=this._centerRay;if(r.isNone(a))return this._contentAltitudeAtCenter;this.view.sceneIntersectionHelper.intersectRay(a,this._contentIntersector,
q,T)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(q):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter();return this._contentAltitudeAtCenter};k._estimateSurfaceAltitudeAtCenter=function(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const a=this._centerRay;if(r.isNone(a))return this._surfaceAltitudeAtCenter;const c=a.origin,h=t.add(q,a.origin,a.direction);
this._surfaceIntersector.resetWithRay(a,this.view.state.camera);this.view.basemapTerrain.intersect(this._surfaceIntersector,null,c,h);this._surfaceIntersector.results.min.getIntersectionPoint(q)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(q));return this._surfaceAltitudeAtCenter};k._estimateSurfaceIntersectionAtRenderPoint=function(a,c,h){a=K.fromRenderAtEye(c,a,U);if(r.isNone(a))return null;const w=a.origin,f=t.add(q,a.origin,a.direction);this._surfaceIntersector.resetWithRay(a,
c);this.view.basemapTerrain.intersect(this._surfaceIntersector,null,w,f);return this._surfaceIntersector.results.min.getIntersectionPoint(h)?h:null};k._cameraChanged=function(a){this._updateCenterPointsOfInterest();a=a.eye;t.exactEquals(this.renderPointOfView,a)||this._set("renderPointOfView",t.copy(this._propertiesPool.get("renderPointOfView"),a))};k._updateCenterPointsOfInterest=function(){this._contentAltitudeAtCenterDirty=this._surfaceAltitudeAtCenterDirty=this._centerRayDirty=!0;for(const a of this._pois)a.updateRenderLocation()};
k._updateCenterOnContent=function(){this._contentAltitudeAtCenterDirty=!0;this.centerOnContent.updateRenderLocation()};k._setDebug=function(a){if(a)for(const c of this._pois)this._handles.add(g.watch(()=>c.renderLocation,h=>this._debugCenters.get(c).show(h,c.renderCoordsHelper.spatialReference),g.initial),"debug");else this._debugCenters.forEach(c=>c.hide()),this._handles.remove("debug")};x._createClass(v,[{key:"updating",get:function(){return!(!this.surfaceGeometryUpdates?.updating&&!this._pois.some(a=>
a.updating))}},{key:"_centerRay",get:function(){this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.camera,this._tmpRay),this._centerRayDirty=!1);return this._centerRayCached}},{key:"test",get:function(){return{update:()=>{this.surfaceGeometryUpdates.runTask();for(const a of this._pois)a.runTask()},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}}]);return v}(F);d.__decorate([e.property({readOnly:!0})],b.PointsOfInterest.prototype,
"centerOnContent",void 0);d.__decorate([e.property({readOnly:!0})],b.PointsOfInterest.prototype,"centerOnSurfaceFrequent",void 0);d.__decorate([e.property({readOnly:!0})],b.PointsOfInterest.prototype,"centerOnSurfaceInfrequent",void 0);d.__decorate([e.property({readOnly:!0})],b.PointsOfInterest.prototype,"contentCenterOnSurface",void 0);d.__decorate([e.property({readOnly:!0})],b.PointsOfInterest.prototype,"cameraOnSurface",void 0);d.__decorate([e.property({readOnly:!0})],b.PointsOfInterest.prototype,
"contentCameraOnSurface",void 0);d.__decorate([e.property({readOnly:!0})],b.PointsOfInterest.prototype,"focus",void 0);d.__decorate([e.property({readOnly:!0})],b.PointsOfInterest.prototype,"renderPointOfView",void 0);d.__decorate([e.property({readOnly:!0})],b.PointsOfInterest.prototype,"surfaceOrigin",void 0);d.__decorate([e.property({readOnly:!0})],b.PointsOfInterest.prototype,"contentGeometryUpdates",void 0);d.__decorate([e.property({readOnly:!0})],b.PointsOfInterest.prototype,"surfaceGeometryUpdates",
void 0);d.__decorate([e.property({constructOnly:!0})],b.PointsOfInterest.prototype,"view",void 0);d.__decorate([e.property({readOnly:!0})],b.PointsOfInterest.prototype,"updating",null);b.PointsOfInterest=d.__decorate([H.subclass("esri.views.3d.support.PointsOfInterest")],b.PointsOfInterest);const R=Array,q=z.create(),U=A.create(),T={exclude:new Set([Q.TERRAIN_ID])};Object.defineProperties(b,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});