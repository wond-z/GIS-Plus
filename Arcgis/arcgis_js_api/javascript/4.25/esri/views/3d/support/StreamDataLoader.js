// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../request ../../../core/Accessor ../../../core/arrayUtils ../../../core/Error ../../../core/lang ../../../core/maybe ../../../core/promiseUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ./AsyncWorkerQueue ../webgl-engine/lib/Util ../../support/Scheduler".split(" "),function(f,r,x,u,C,D,E,F,q,n,G,M,H,y,I,J){function K(d){if(2>
d.byteLength)return"unknown";d=new Uint8Array(d,0,d.byteLength);return 137===d[0]&&80===d[1]?"image/png":71===d[0]&&73===d[1]?"image/gif":66===d[0]&&77===d[1]?"image/bmp":255===d[0]&&216===d[1]?"image/jpeg":"unknown"}f.StreamDataLoader=function(d){function m(){var a=d.apply(this,arguments)||this;a._tasks=new Map;a._onLoadQueue=[];a._doneQueue=[];a.updating=!1;return a}r._inheritsLoose(m,d);var h=m.prototype;h.setup=function(a,b,c){this._loadQueue=new y.AsyncWorkerQueue((e,g)=>this._startLoading(e,
g),(e,g)=>this._doneLoadingCB(e,g),a,b);c&&(this._frameTask=c.registerTask(J.TaskPriority.STREAM_DATA_LOADER,this))};h.destroy=function(){this._frameTask=q.removeMaybe(this._frameTask);this._tasks.forEach(a=>q.abortMaybe(a.abortController));this._loadQueue=q.destroyMaybe(this._loadQueue);this._tasks=this._doneQueue=this._onLoadQueue=null};h.hasDownloadSlots=function(a){return this._loadQueue.hasQuota(a)};h.request=function(a,b,c,e={}){const g=n.createResolver();g.__signal=q.isSome(e)?e.signal:null;
const l=this._createOrUpdateTask(a,b,c,e,g);n.onAbort(e,()=>this._cancelRequest(l,g));return g.promise};h._createTask=function(a,b,c,e,g,l){a=new L(a,b,c,e,g);this._updateTask(a,l);this._tasks.set(g,a);1===this._tasks.size&&this._set("updating",!0);this._loadQueue.push(a);return a};h._cancelRequest=function(a,b){D.removeUnordered(a.resolvers,b);b.reject(n.createAbortError());0===a.resolvers.length&&(a.status===f.TaskStatus.DOWNLOADING&&(a.status=f.TaskStatus.CANCELLED,this._loadQueue.cancel(a),a.abortController?.abort(),
a.request=null,a.abortController=null),a.status=f.TaskStatus.CANCELLED,this._tasks.delete(a.key),0===this._tasks.size&&this._set("updating",!1))};h._updateTask=function(a,b){a.resolvers.push(b)};h._createOrUpdateTask=function(a,b,c,e,g){const l=`${q.isSome(e)&&e.uid||a}:${b}:${c}`,p=this._tasks.get(l);return p?(this._updateTask(p,g),p):this._createTask(a,e,b,c,l,g)};h._doneLoadingCB=function(a,b){this._loadQueue&&(I.assert(a.status===f.TaskStatus.DOWNLOADING),a.status=f.TaskStatus.DOWNLOADED,this._frameTask?
this._doneQueue.push({task:a,err:b}):this._doneLoading(a,b))};h.runTask=function(a){for(;!a.done&&0<this._onLoadQueue.length;){var b=this._onLoadQueue.shift();n.throwIfAborted(b.task.abortController);b.task.abortController=null;b.callback(b.task);a.madeProgress()}for(;!a.done&&0<this._doneQueue.length;)b=this._doneQueue.shift(),b.task.status!==f.TaskStatus.DOWNLOADED&&(b.err=b.err||n.createAbortError()),this._doneLoading(b.task,b.err),a.madeProgress()};h._doneLoading=function(a,b){if(b&&!n.isAbortError(b)&&
0<a.numRetries)--a.numRetries,this._loadQueue.push(a);else{var c=a.result instanceof HTMLImageElement?0:a.resolvers.length;for(const e of a.resolvers)if(b)n.isAbortError(b)?e.reject(b):e.reject(new E("stream-data-loader:request-error",`Failed to request resource at '${a.url}'. ${b}`,{url:a.url,error:b}));else{--c;const g=0>=c?a.result:F.clone(a.result);e.resolve(g)}this._tasks.delete(a.key);0===this._tasks.size&&this._set("updating",!1)}};h._startLoading=function(a,b){if(a.status===f.TaskStatus.CANCELLED)return!1;
a.startTime=performance.now();a.status=f.TaskStatus.DOWNLOADING;let c,e;switch(a.docType){case "binary":e="array-buffer";c=0;break;case "image":e="image";break;case "image+type":e="array-buffer";break;default:e="json"}a.abortController=new AbortController;const g=a.abortController.signal;a.request=u(a.url,{...a.options,responseType:e,timeout:c,signal:g});let l=()=>{};const p=k=>{a.duration=performance.now()-a.startTime;a.size=k instanceof ArrayBuffer?k.byteLength:a.size||0;a.result=k;this._frameTask?
this._onLoadQueue.push({callback:b,task:a}):(a.abortController=null,b(a))},t=k=>{a.status===f.TaskStatus.DOWNLOADING&&b(a,k);l()};if("image+type"!==a.docType)return a.request.then(k=>p(k.data),t),!0;a.request.then(k=>{k=k.data;const v=K(k);e="image";a.size=k.byteLength;if("unknown"===v)a.request=u(a.url,{responseType:e,timeout:c,signal:g}),a.request.then(w=>p(w.data),t);else{k=new Blob([k],{type:v});var z=window.URL.createObjectURL(k);l=()=>window.URL.revokeObjectURL(z);a.request=u(z,{responseType:e,
timeout:c,signal:g});a.request.then(w=>p(new A(w.data,v,l)),t)}},t);return!0};r._createClass(m,[{key:"running",get:function(){return 0<this._doneQueue.length||0<this._onLoadQueue.length}},{key:"test",get:function(){return{loadQueue:this._loadQueue}}}]);return m}(C);x.__decorate([G.property({readOnly:!0})],f.StreamDataLoader.prototype,"updating",void 0);f.StreamDataLoader=x.__decorate([H.subclass("esri.views.3d.support.StreamDataLoader")],f.StreamDataLoader);const B={numRetries:0};let A=function(){function d(m,
h,a){this.image=m;this.type=h;this.release=a}r._createClass(d,[{key:"isOpaque",get:function(){return"image/jpeg"===this.type}}]);return d}(),L=function(d){function m(h,a,b,c,e){c=d.call(this,c)||this;c.url=h;c.options=a;c.docType=b;c.key=e;c.result=null;c.status=f.TaskStatus.QUEUED;c.request=null;c.abortController=null;c.resolvers=[];c.startTime=0;c.numRetries=B.numRetries;return c}r._inheritsLoose(m,d);return m}(y.BaseTask);f.TaskStatus=void 0;(function(d){d[d.QUEUED=1]="QUEUED";d[d.DOWNLOADING=
2]="DOWNLOADING";d[d.DOWNLOADED=3]="DOWNLOADED";d[d.CANCELLED=4]="CANCELLED"})(f.TaskStatus||(f.TaskStatus={}));f.ImageWithType=A;f.test=B;Object.defineProperties(f,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});