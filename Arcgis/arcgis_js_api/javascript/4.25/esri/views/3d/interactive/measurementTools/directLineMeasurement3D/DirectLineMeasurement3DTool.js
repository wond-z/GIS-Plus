// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../geometry ../../../../../core/Handles ../../../../../core/maybe ../../../../../core/reactiveUtils ../../../../../core/screenUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/arrayUtils ../../../../../core/accessorSupport/ensureType ../../../../../core/accessorSupport/decorators/subclass ../../../../../chunks/vec3f64 ../../../../../layers/graphics/hydratedFeatures ../../../analysis/support/measurementUtils ../../editingTools/dragEventPipeline3D ./DirectLineMeasurement3DView ../support/PickRequest ../../../support/ElevationProvider ../../../webgl-engine/lib/Intersector ../../../webgl-engine/lib/IntersectorInterfaces ../../../../interactive/AnalysisToolBase ../../../../interactive/dragEventPipeline ../../../../support/screenUtils ../../../../../geometry/Point".split(" "),
function(x,f,d,G,c,y,H,g,W,X,I,J,K,L,r,M,z,N,O,P,Q,t,A,R){d=function(B){function p(a){a=B.call(this,a)||this;a._handles=new G;a._cachedPickRequest=null;a._isAnyPointerDown=!1;a.lineState="initial";a.analysisViewData=null;a.startPointSurfaceLocation=null;a.endPointSurfaceLocation=null;a.startManipulator=null;a.endManipulator=null;return a}x._inheritsLoose(p,B);var e=p.prototype;e.initialize=function(){const {view:a,analysis:b,analysisViewData:q,cursorPoint:h,visible:S}=this;this.measurementView=new M.DirectLineMeasurement3DView({toolState:this,
view:a,analysis:b,analysisViewData:q,cursorPoint:h,visible:S});this._intersector=O.newIntersector(this.view.state.viewingMode);this._intersector.options.store=P.StoreResults.MIN;const {start:k,end:l}=this.measurementView.createManipulators(),E=(m,u,C)=>t.createManipulatorDragEventPipeline(m,(v,T,U)=>{const D=r.hideManipulatorWhileDragging(v);T.next(D).next(r.screenToMap3D(this.view)).next(n=>"start"!==n.action?n:null).next(n=>{const w=K.clonePoint(n.mapEnd,new R);this.analysis[u]=w;v.location=w;this[C]=
this._surfaceLocation(w,n.surfaceType)});U.next(D).next(t.resetProperties(this.analysis,[u])).next(t.resetProperties(this,[C])).next(()=>{v.location=c.unwrap(this.analysis[u])})}),F=m=>m.events.on("grab-changed",()=>{this.lineState=k.grabbing||l.grabbing?"editing":"measured"});this._handles.add([E(k,"startPoint","startPointSurfaceLocation"),E(l,"endPoint","endPointSurfaceLocation"),F(k),F(l)]);this.manipulators.add(k);this.manipulators.add(l);this.startManipulator=k;this.endManipulator=l;this._handles.add(y.watch(()=>
this.state,m=>{"measured"===m&&this.finishToolCreation()},y.syncAndInitial))};e.destroy=function(){this.measurementView=c.destroyMaybe(this.measurementView);this._handles=c.destroyMaybe(this._handles)};e.onShow=function(){this.measurementView.show();this._updateManipulatorAvailability()};e.onHide=function(){this.measurementView.hide()};e.onInputEvent=function(a){switch(a.type){case "immediate-click":this._handleImmediateClick(a);break;case "pointer-move":this._handlePointerMove(a);break;case "pointer-down":this._handlePointerDown();
break;case "pointer-up":this._handlePointerUp()}this._updateManipulatorAvailability()};e._handlePointerMove=function(a){this._clearCachedPickRequest();const b=A.createScreenPointFromEvent(a);"mouse"===a.pointerType&&(this._hoverAt(b),"drawing"===this.lineState&&(this.endManipulator.events.emit("drag",{action:"update",start:b,screenPoint:b}),a.stopPropagation()))};e._handlePointerDown=function(){this._isAnyPointerDown=!0};e._handlePointerUp=function(){this._isAnyPointerDown=!1};e._handleImmediateClick=
function(a){this._clearCachedPickRequest();if(L.isPrimaryPointerAction(a)){var b=A.createScreenPointFromEvent(a),q=a.pointerType,h=!1;if(this.active)switch(this.lineState){case "initial":this.startManipulator.events.emit("drag",{action:"start",pointerType:q,start:b,screenPoint:b});this.startManipulator.events.emit("drag",{action:"end",start:b,screenPoint:b});c.isSome(this.analysis.startPoint)&&(this.startManipulator.interactive=!1,this.endManipulator.interactive=!1,this.lineState="drawing",this.endManipulator.events.emit("drag",
{action:"start",pointerType:q,start:b,screenPoint:b}),h=!0);break;case "drawing":this.endManipulator.events.emit("drag",{action:"update",start:b,screenPoint:b}),c.isSome(this.analysis.endPoint)&&(this.endManipulator.events.emit("drag",{action:"end",start:b,screenPoint:b}),this.startManipulator.interactive=!0,this.endManipulator.interactive=!0,this.lineState="measured",h=!0)}h&&a.stopPropagation();"mouse"===a.pointerType&&this._hoverAt(b)}};e._hoverAt=function(a){const b=this._isAnyPointerDown&&"drawing"!==
this.lineState&&"editing"!==this.lineState;(c.isNone(this.analysis.startPoint)||c.isNone(this.analysis.endPoint))&&this.active&&!b?(a=this._pick(a),c.isSome(a)&&(this.cursorPoint=a)):this.cursorPoint=null};e._pick=function(a){if(c.isSome(this._cachedPickRequest)&&c.isSome(this._cachedPickRequest.result)){var b=this._cachedPickRequest.screenPoint;if(b.x===a.x&&b.y===a.y)return this._cachedPickRequest.result.mapPoint}else this._cachedPickRequest=new z.PickRequest(a);a=H.screenPointObjectToArray(a);
this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(a,this._intersector);a=V;if(!this._intersector.results.min.getIntersectionPoint(a))return null;b=this.view.renderCoordsHelper.fromRenderCoords(a,this.view.spatialReference);this._cachedPickRequest.result=new z.PickResult(a,b);return b};e._clearCachedPickRequest=function(){this._cachedPickRequest=null};e._surfaceLocation=function(a,b){return b===r.SurfaceType.GROUND?"on-the-surface":a.z>=this._getElevation(a)?"above-the-surface":"below-the-surface"};
e._updateManipulatorAvailability=function(){this.startManipulator.available=c.isSome(this.analysis.startPoint);this.endManipulator.available=c.isSome(this.analysis.endPoint)};e._getElevation=function(a){return this.view.basemapTerrain.ready?c.unwrapOr(N.getElevationAtPoint(this.view.elevationProvider,a),0):0};x._createClass(p,[{key:"state",get:function(){return c.isNone(this.analysis.startPoint)&&c.isNone(this.analysis.endPoint)?"ready":this.validMeasurement&&"editing"!==this.lineState&&"drawing"!==
this.lineState?"measured":"measuring"}},{key:"cursor",get:function(){return"ready"===this.state||"drawing"===this.lineState?"crosshair":null}},{key:"cursorPoint",set:function(a){this._set("cursorPoint",a);this.measurementView.cursorPoint=a}},{key:"validMeasurement",get:function(){return c.isSome(this.analysis.startPoint)&&c.isSome(this.analysis.endPoint)}}]);return p}(Q.AnalysisToolBase);f.__decorate([g.property({readOnly:!0})],d.prototype,"state",null);f.__decorate([g.property()],d.prototype,"lineState",
void 0);f.__decorate([g.property({readOnly:!0})],d.prototype,"cursor",null);f.__decorate([g.property()],d.prototype,"cursorPoint",null);f.__decorate([g.property({constructOnly:!0})],d.prototype,"analysis",void 0);f.__decorate([g.property({constructOnly:!0})],d.prototype,"analysisViewData",void 0);f.__decorate([g.property()],d.prototype,"measurementView",void 0);f.__decorate([g.property({constructOnly:!0})],d.prototype,"view",void 0);f.__decorate([g.property({readOnly:!0})],d.prototype,"validMeasurement",
null);f.__decorate([g.property({value:null})],d.prototype,"startPointSurfaceLocation",void 0);f.__decorate([g.property({value:null})],d.prototype,"endPointSurfaceLocation",void 0);d=f.__decorate([I.subclass("esri.views.3d.interactive.measurementTools.directLineMeasurement3D.DirectLineMeasurement3DTool")],d);const V=J.create();return d});