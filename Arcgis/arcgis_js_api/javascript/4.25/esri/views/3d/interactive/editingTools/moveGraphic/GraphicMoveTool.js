// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/Collection ../../../../../core/Evented ../../../../../core/HandleOwner ../../../../../core/handleUtils ../../../../../core/maybe ../../../../../core/quantityUtils ../../../../../core/reactiveUtils ../../../../../core/accessorSupport/decorators/property ../../../../../core/arrayUtils ../../../../../core/accessorSupport/ensureType ../../../../../core/accessorSupport/decorators/subclass ../../../../../layers/graphics/dehydratedFeatures ../../../../../support/elevationInfoUtils ../../manipulatorUtils ../../SnappingVisualizer3D ../isSupportedGraphicUtils ../manipulatorUtils ../visualElementUtils ../manipulations/config ../manipulations/MoveManipulation ../manipulations/moveUtils ../manipulations/MoveXYGraphicManipulation ./isSupportedGraphic ../../visualElements/OutlineVisualElement ../../../layers/graphics/GraphicState ../../../../interactive/dragEventPipeline ../../../../interactive/InteractiveToolBase ../../../../interactive/editGeometry/EditGeometryOperations ../../../../interactive/sketch/SketchTooltipOptions ../../../../interactive/snapping/SnappingContext ../../../../interactive/snapping/SnappingDragPipelineStep ../../../../interactive/tooltip/Tooltip ../../../../interactive/tooltip/TranslateTooltipInfos ../../../../support/automaticLengthMeasurementUtils ../../../../support/euclideanLengthMeasurementUtils".split(" "),
function(m,B,t,M,N,O,P,n,D,y,v,ja,ka,Q,R,z,S,T,U,V,W,X,q,E,Y,Z,F,aa,G,ba,ca,H,da,ea,fa,A,I,ha){let J=function(p){this.allGraphics=p;this.type="graphic-move-start"},K=function(p,u,l){this.dx=p;this.dy=u;this.allGraphics=l;this.type="graphic-move"},C=function(p){this.allGraphics=p;this.type="graphic-move-stop"};m.GraphicMoveTool=function(p){function u(a){a=p.call(this,a)||this;a.graphics=new M;a.enableZ=!0;a.tooltipOptions=new H;a.type="move-3d";a._snappingPipeline=new ea.SnappingPipeline;a._tooltip=
null;return a}B._inheritsLoose(u,p);var l=u.prototype;l.initialize=function(){const {graphics:a,view:b}=this;this.addHandles([a.on("change",()=>this._refreshManipulators()),y.watch(()=>this.tooltipOptions.enabled,d=>{this._tooltip=d?new fa.Tooltip({view:b}):n.destroyMaybe(this._tooltip)},y.syncAndInitial)]);this._refreshManipulators();this.finishToolCreation()};l.destroy=function(){this._tooltip=n.destroyMaybe(this._tooltip);this._moveManipulation=n.destroyMaybe(this._moveManipulation);this.graphics.removeAll();
this._set("view",null)};l.reset=function(){};l._refreshManipulators=function(){this.handles.removeAll();this._moveManipulation&&this._moveManipulation.destroy();this.manipulators.removeAll();const a=this.graphics.toArray().filter(b=>Z.isSupportedGraphic(b)===U.SupportedGraphicResult.SUPPORTED).map(b=>new ia(b));a.length&&(this._createManipulators(a),this._createVisualElements(a),this.handles.add(a.map(b=>this.view.trackGraphicState(b.state))),this._updateMoveManipulation(a))};l._createManipulators=
function(a){for(const b of a){const d=b.state;b.manipulationXY=new Y.MoveXYGraphicManipulation({tool:this,view:this.view,graphicState:d});b.manipulationXY.forEachManipulator(e=>this.handles.add([e.events.on("immediate-click",c=>{this.emit("immediate-click",{...c,graphic:d.graphic});c.stopPropagation()}),e.events.on("grab-changed",({action:c})=>{const {tooltipOptions:f,_tooltip:g}=this;n.isNone(g)||("start"===c?g.info=new A.TranslateGraphicTooltipInfo({tooltipOptions:f}):g.clear())})]));this.handles.add(b.manipulationXY.createDragPipeline((e,
c,f,g)=>this._buildDragEventPipeline(a,q.ManipulationType.XY,e,c,f,g)))}this._createMoveManipulation(a)};l._createMoveManipulation=function(a){const b=new q.MoveManipulation({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===a.length?q.MoveManipulation.radiusForSymbol(a[0].graphic.symbol):X.DISC_RADIUS});this._moveManipulation=b;b.elevationInfo={mode:"absolute-height",offset:0};b.forEachManipulator(c=>{this.handles.add(c.events.on("immediate-click",
f=>{b.zManipulation.hasManipulator(c)||1!==this.graphics.length||this.emit("immediate-click",{...f,graphic:this.graphics.getItemAt(0)});f.stopPropagation()}))});var d=c=>f=>{this.handles.add(f.events.on("focus-changed",({action:g})=>{const k=this._tooltip;n.isNone(k)||("focus"===g?this._updateMoveTooltip(a,c):k.clear())}))};this._moveManipulation.xyManipulation.forEachManipulator(d(q.ManipulationType.XY));this._moveManipulation.xyAxisManipulation.forEachManipulator(d(q.ManipulationType.XY_AXIS));
this._moveManipulation.zManipulation.forEachManipulator(d(q.ManipulationType.Z));d=()=>this._updateMoveManipulation(a);for(const c of a)this.handles.add([c.state.on("changed",d),y.watch(()=>c.state.displaying,d)]);const e=a[a.length-1];this.handles.add(e.state.on("changed",()=>this._updateMoveManipulationAngle(e)));this.handles.add(b.createDragPipeline((c,f,g,k,w)=>this._buildDragEventPipeline(a,c,f,g,k,w),z.getGraphicEffectiveElevationInfo(e.graphic),n.unwrap(e.graphic.geometry).spatialReference,
e.graphic));this._updateMoveManipulationAngle(e)};l._createVisualElements=function(a){for(const b of a){const d=W.createVisualElements({view:this.view,graphic:b.graphic,forEachManipulator:e=>{b.manipulationXY.forEachManipulator(e);this._moveManipulation.forEachManipulator(e)},onManipulatorsChanged:()=>P.makeHandle()});n.isNone(d)||(b.geometryRepresentation=d.visualElement,b.geometryRepresentation instanceof F.OutlineVisualElement&&this.handles.add([b.geometryRepresentation.events.on("attachment-origin-changed",
()=>{b.state.isDraped||this._updateMoveManipulation(a)}),y.watch(()=>b.state.isDraped,()=>this._updateMoveManipulation(a))]),this.handles.add(d))}};l._updateMoveManipulationAngle=function(a){this._moveManipulation.angle=E.shapeOrientation(a.graphic.geometry)};l._updateMoveManipulation=function(a){const b=R.makeDehydratedPoint(0,0,0,this.view.spatialReference);let d=0,e=!1;const c=this._moveManipulation;for(const f of a)f.state.displaying&&(a=f.state.graphic,this.enableZ&&V.canMoveZ(a)&&(e=!0),a=f.geometryRepresentation instanceof
F.OutlineVisualElement&&!f.state.isDraped?f.geometryRepresentation.attachmentOrigin:S.getGraphicAttachmentOrigin(this.view,a),n.isSome(a)&&(b.x+=a.x,b.y+=a.y,b.z+=a.z,d++));0<d?(b.x/=d,b.y/=d,b.z/=d,c.location=b,c.xyManipulation.available=!0,c.xyAxisManipulation.available=!0,c.zManipulation.available=e):c.available=!1};l._buildDragEventPipeline=function(a,b,d,e,c,f){const g=[],k=[];let w=null,x=null;const L=()=>{for(const h of g)h.dragging=!1;g.length=0;k.length=0;x=w=null;this._moveManipulation.interactive=
!0};c=c.next(h=>x(h)).next(()=>{this.emit("graphic-move-stop",new C(k));if(this.destroyed)return null;L()});if(1===a.length&&b===q.ManipulationType.XY){const h=a[0].graphic;e=this._buildSnappingPipelineSteps(h,z.getGraphicEffectiveElevationInfo(h),e,c,f)}return e.next(h=>{if("start"===h.action){g.length=0;k.length=0;for(const r of a)r.dragging||!r.manipulationXY.hasManipulator(d)&&r.manipulationXY.grabbing||(g.push(r),k.push(r.graphic),r.dragging=!0);if(0!==k.length&&(this._moveManipulation.interactive=
!1,w=G.dragGraphicMany(k,this.view.state.viewingMode),x=G.resetGraphicMany(k),this.emit("graphic-move-start",new J(k)),this.destroyed))return null}return 0!==k.length?h:null}).next(h=>w(h)).next(h=>{this._updateMoveTooltip(a,b,h);return h}).next(h=>{switch(h.action){case "start":case "update":if(h.translationX||h.translationY||h.translationZ){const r=this.view.toScreen(h.mapStart);h=this.view.toScreen(h.mapEnd);this.emit("graphic-move",new K(h.x-r.x,h.y-r.y,k));if(this.destroyed)return null}break;
case "end":this.emit("graphic-move-stop",new C(k));if(this.destroyed)return null;L()}})};l._updateMoveTooltip=function(a,b,d){const {tooltipOptions:e,_tooltip:c}=this;if(!n.isNone(c)){c.clear();var f=0===a.length?"absolute-height":a[0].state.isDraped?"on-the-ground":"absolute-height";switch(b){case q.ManipulationType.XY:c.info=new A.TranslateGraphicTooltipInfo({tooltipOptions:e});this._updateMoveTooltipDistance(c.info,d,(g,k)=>I.autoHorizontalDistanceByElevationModeBetweenPoints(g,k,f));break;case q.ManipulationType.XY_AXIS:c.info=
new A.TranslateGraphicXYTooltipInfo({tooltipOptions:e});this._updateMoveTooltipDistance(c.info,d,(g,k)=>{g=I.autoHorizontalDistanceByElevationModeBetweenPoints(g,k,f);return D.scale(g,E.axisConstrainedDragSign(d))});break;case q.ManipulationType.Z:c.info=new A.TranslateGraphicZTooltipInfo({tooltipOptions:e}),this._updateMoveTooltipDistance(c.info,d,ha.verticalSignedDistanceBetweenPoints)}}};l._updateMoveTooltipDistance=function(a,b,d){if(n.isSome(b)&&"end"!==b.action){const {mapStart:e,mapEnd:c}=
b;b=d(e,c);a.distance=n.isSome(b)?b:D.zeroMeters}};l._buildSnappingPipelineSteps=function(a,b,d,e,c){const f=a.geometry;if(n.isNone(f)||"point"!==f.type&&"mesh"!==f.type)return d;const g=("point"===f.type?f:f.anchor).clone(),k=new da.SnappingContext({elevationInfo:b,pointer:c,editGeometryOperations:ca.EditGeometryOperations.fromGeometry(g,this.view.state.viewingMode),visualizer:new T.SnappingVisualizer3D,excludeFeature:a});b=this.snappingManager;return d.next(w=>{g.z=z.getConvertedElevation(this.view,
g,z.getGraphicEffectiveElevationInfo(a),{mode:"absolute-height",offset:0});const x=k.coordinateHelper.pointToVector(g);return{...w,snapOrigin:x}}).next(this._snappingPipeline.createSnapDragEventPipelineStep({snappingContext:k,snappingManager:b,cancel:e,updatingHandles:this.updatingHandles}),this._snappingPipeline.next)};B._createClass(u,[{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"test",get:function(){return{tooltip:this._tooltip}}}]);return u}(O.HandleOwnerMixin(N.EventedMixin(ba.InteractiveToolBase)));
t.__decorate([v.property({constructOnly:!0,nonNullable:!0})],m.GraphicMoveTool.prototype,"view",void 0);t.__decorate([v.property()],m.GraphicMoveTool.prototype,"graphics",void 0);t.__decorate([v.property({constructOnly:!0,nonNullable:!0})],m.GraphicMoveTool.prototype,"enableZ",void 0);t.__decorate([v.property({constructOnly:!0,type:H})],m.GraphicMoveTool.prototype,"tooltipOptions",void 0);t.__decorate([v.property({constructOnly:!0})],m.GraphicMoveTool.prototype,"snappingManager",void 0);t.__decorate([v.property()],
m.GraphicMoveTool.prototype,"type",void 0);t.__decorate([v.property()],m.GraphicMoveTool.prototype,"updating",null);m.GraphicMoveTool=t.__decorate([Q.subclass("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],m.GraphicMoveTool);let ia=function(){function p(u){this.manipulationXY=this.geometryRepresentation=this.state=null;this.dragging=!1;this.state=new aa.GraphicState({graphic:u})}B._createClass(p,[{key:"graphic",get:function(){return this.state.graphic}}]);return p}();m.GraphicMoveEvent=
K;m.GraphicMoveStartEvent=J;m.GraphicMoveStopEvent=C;Object.defineProperties(m,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});