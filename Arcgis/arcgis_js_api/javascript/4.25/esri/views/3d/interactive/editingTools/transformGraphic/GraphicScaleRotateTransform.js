// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/Cyclical ../../../../../core/Evented ../../../../../core/Handles ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/quantityUtils ../../../../../core/reactiveUtils ../../../../../core/scheduling ../../../../../core/screenUtils ../../../../../chunks/mat4 ../../../../../chunks/mat4f64 ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../chunks/vec4f64 ../../../../../geometry/support/plane ../../../../../geometry/support/ray ../../../../../geometry/support/vectorStacks ../../../../../support/elevationInfoUtils ../../Manipulator3D ../../manipulatorUtils ../dragEventPipeline3D ../ManipulatorType ../manipulations/config ../../../webgl-engine/lib/basicInterfaces ../../../webgl-engine/lib/GeometryUtil ../../../webgl-engine/lib/Material ../../../webgl-engine/materials/ColorMaterial ../../../../interactive/dragEventPipeline ../../../../interactive/interfaces ../../../../interactive/tooltip/Tooltip ../../../../interactive/tooltip/TransformTooltipInfos".split(" "),
function(R,X,Y,Z,aa,G,k,E,H,ba,ca,C,da,w,I,ea,J,K,t,fa,ha,ia,ja,ka,d,la,N,ma,na,oa,z,pa,O){function qa(c,f){var a=w.subtract(t.sv3d.get(),f.renderStart,c.origin);c=w.subtract(t.sv3d.get(),f.renderEnd,c.origin);a=w.length(a);c=w.length(c);return 0===a?0:c/a}function ra(c,f,a,b){const {renderStart:n,renderEnd:h}=c;var m=L(n,b,t.sv3d.get());c=L(h,b,t.sv3d.get());if(w.squaredDistance(m,c)<d.DRAG_THRESHOLD_PX*d.DRAG_THRESHOLD_PX)return null;const u=w.subtract(t.sv3d.get(),n,a);f=w.cross(t.sv3d.get(),u,
J.normal(f));f=w.add(t.sv3d.get(),n,f);a=L(a,b,t.sv3d.get());b=L(f,b,t.sv3d.get());f=w.subtract(t.sv3d.get(),b,m);b=w.subtract(t.sv3d.get(),m,a);m=K.wrap(m,f);b=K.wrap(a,b);return K.distance2(m,c)<K.distance2(b,c)?"rotate":"scale"}function L(c,f,a){f.projectToScreen(c,P);return w.set(a,P[0],P[1],0)}function S(c,f){let a=null,b=1;const n=()=>b;return{start:()=>{b=c.getScale();a=c.getScale;c.getScale=n;f()},update:h=>{b+=((b+1)/2-b)*Math.min(h*d.RING_RESET_ANIMATION_SPEED_FACTOR,1);f();return.01>Math.abs(b-
1)?D.STOP:D.CONTINUE},destroy:()=>{c.getScale=a;f()}}}function sa(c,f){let a=0,b=null;const n=()=>!1;return{start:()=>{b=c.getFocused;c.getFocused=n;a=0;f()},update:h=>{a+=h;return!b()||a>d.RING_INDICATOR_DELAY_MS?D.STOP:D.CONTINUE},destroy:()=>{c.getFocused=b;f()}}}function M(c){switch(c){case "integer":case "long":return 0;default:return null}}var g;(function(c){c.ScaleIn=z.ManipulatorStateCustomFlags.Custom2;c.ScaleOut=z.ManipulatorStateCustomFlags.Custom3;c.RotateLeft=z.ManipulatorStateCustomFlags.Custom4;
c.RotateRight=z.ManipulatorStateCustomFlags.Custom5;c.Unlocked=z.ManipulatorStateCustomFlags.Custom7;c.DelayedFocused=z.ManipulatorStateCustomFlags.Custom8;c.TouchInput=z.ManipulatorStateCustomFlags.Custom12})(g||(g={}));let ta=function(){function c({adapter:a,tooltipOptions:b,mode:n,tool:h}){this._mode=null;this._handles=new aa;this._activeAnimation=this._scaleRotateDragData=null;this.events=new Z;this.getFocused=()=>this._ringManipulator.focused;this.getScale=()=>k.isSome(this._scaleRotateDragData)&&
"scale"===this._scaleRotateDragData.mode?this._adapter.scale:1;this.tool=h;this._mode=n;this._adapter=a;this._tooltipOptions=b;this._tooltip=new pa.Tooltip({view:h.view});this._createManipulator();this._updateDragState();this._updateManipulatorTransform();this._handles.add(H.when(()=>!this._tooltipOptions.enabled,()=>this._tooltip.clear(),H.initial))}var f=c.prototype;f.destroy=function(){k.isSome(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=null);this._handles=
k.destroyMaybe(this._handles);this.tool.manipulators.remove(this._ringManipulator);this._ringManipulator=null;this._tooltip=k.destroyMaybe(this._tooltip)};f.startAnimation=function(a){this.cancelActiveAnimation();a.start();const b=ba.addFrameTask({update:({deltaTime:n})=>{a.update(n)&&this.cancelActiveAnimation()}});this._activeAnimation={...a,frameTask:b}};f.cancelActiveAnimation=function(){k.isSome(this._activeAnimation)&&(this._activeAnimation.frameTask.remove(),this._activeAnimation=k.destroyMaybe(this._activeAnimation))};
f.forEachManipulator=function(a){a(this._ringManipulator,ka.ManipulatorType.SCALE_ROTATE)};f._createManipulator=function(){const a=this._createRingManipulator();this._ringManipulator=a;this.tool.manipulators.add(a);const b=this.tool.graphicState.graphic,n=oa.createManipulatorDragEventPipeline(a,(h,m,u)=>{this._scaleRotateDragData=null;const A=this._adapter.startInteraction(),l={mode:"none",origin:I.clone(h.renderLocation),initialAngle:this._adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=
l;this._updateDragState();const q=t.sv3d.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(h.renderLocation,q);m.next(ja.screenToRenderPlane(this.tool.view,J.fromPositionAndNormal(h.renderLocation,q,J.create()))).next(e=>{var r=J.normal(e.plane);r=ia.calculateInputRotationTransform(e.renderStart,e.renderEnd,l.origin,r);var p=Y.cyclicalPI.shortestSignedDiff(l.angle,r);l.angleDir=G.clamp(l.angleDir+p,-d.ROTATE_INDICATOR_DIRECTION_BUFFER,d.ROTATE_INDICATOR_DIRECTION_BUFFER);l.angle=r;p=qa(l,
e);l.scaleDir=G.clamp(l.scaleDir+(p-this._adapter.scale),-d.SCALE_INDICATOR_DIRECTION_BUFFER,d.SCALE_INDICATOR_DIRECTION_BUFFER);this._onScaleChanged();if("none"===l.mode){const y=this._mode||ra(e,e.plane,l.origin,this.tool.view.state.camera);if(k.isSome(y)){switch(y){case "rotate":this.tool.emit("graphic-rotate-start",{graphic:b,angle:0});this.tool.emit("record-undo",{record:this._adapter.createUndoRecord()});break;case "scale":this.tool.emit("graphic-scale-start",{graphic:b,xScale:1,yScale:1}),
this.tool.emit("record-undo",{record:this._adapter.createUndoRecord()})}l.mode=y}}switch(l.mode){case "rotate":A.state.angle=l.initialAngle+r;break;case "scale":A.state.scale=p,this._onScaleChanged()}this._updateDragState();this._updateManipulatorTransform();switch(e.action){case "start":case "update":switch(l.mode){case "rotate":this.tool.emit("graphic-rotate",{graphic:b,angle:G.rad2deg(l.angle)});break;case "scale":this.tool.emit("graphic-scale",{graphic:b,xScale:p,yScale:p})}break;case "end":switch(l.mode){case "rotate":this.tool.emit("graphic-rotate-stop",
{graphic:b,angle:G.rad2deg(l.angle)});break;case "scale":this.tool.emit("graphic-scale-stop",{graphic:b,xScale:p,yScale:p})}}"end"===e.action&&(this.startAnimation(S(this,()=>this._onScaleChanged())),this._scaleRotateDragData=null,this._updateDragState(),A.done());return e}).next(this._updateTooltipPipelineStep(l));u.next(()=>{A.cancel();if(k.isSome(this._scaleRotateDragData)){switch(this._scaleRotateDragData.mode){case "rotate":this.tool.emit("graphic-rotate-stop",{graphic:b,angle:0});break;case "scale":this.tool.emit("graphic-scale-stop",
{graphic:b,xScale:1,yScale:1})}this.startAnimation(S(this,()=>this._onScaleChanged()));this._scaleRotateDragData=null;this._updateDragState()}this._updateFocusTooltip()})});this._handles.add([n,a.events.on("focus-changed",h=>{"focus"===h.action?this.startAnimation(sa(this,()=>this._updateDelayedFocusedState())):this._updateDelayedFocusedState()}),a.events.on("immediate-click",h=>{h.stopPropagation()}),H.watch(()=>this.tool.graphicState?.displaying,h=>this._ringManipulator.available=h,H.initial)])};
f._updateTooltipPipelineStep=function(a){return b=>{const n=this._tooltipOptions;if(!n.enabled)return b;if("end"===b.action)return this._updateFocusTooltip(),b;const h=this._tooltip;var m=this._tooltipOptions.visualVariables,u=k.isSome(m)?m.size:null;m=k.isSome(m)?m.rotation:null;switch(a.mode){case "scale":h.info=new O.TransformScaleTooltipInfo({tooltipOptions:n,scale:{value:this._adapter.scale},size:E.createLength(k.unwrapOr(this._adapter.size,-1),"meters"),sizeUnit:k.isSome(u)?u.unit:null,sizePrecision:k.isSome(u)?
M(u.valueType):null});break;case "rotate":u=k.isSome(m)?M(m.valueType):null,m=k.isSome(m)?m.rotationType:"geographic",h.info=new O.TransformRotateTooltipInfo({tooltipOptions:n,rotation:E.createAngle(k.unwrapOr(-this._adapter.relativeAngle,0),"radians","geographic"),rotationPrecision:u,orientation:E.createAngle(-this._adapter.angle,"radians","geographic"),orientationPrecision:u,rotationType:m})}return b}};f._updateFocusTooltip=function(){if(this._tooltipOptions.enabled)if(this.getFocused()){var a=
this._tooltipOptions.visualVariables;const b=k.isSome(a)?a.rotation:null;a=k.isSome(a)?a.size:null;this._tooltip.info=new O.TransformAbsoluteTooltipInfo({tooltipOptions:this._tooltipOptions,orientation:E.createAngle(-this._adapter.angle,"radians","geographic"),orientationEnabled:null==this._mode||"rotate"===this._mode,orientationPrecision:k.isSome(b)?M(b.valueType):null,rotationType:k.isSome(b)?b.rotationType:"geographic",size:E.createLength(k.unwrapOr(this._adapter.size,-1),"meters"),sizeUnit:k.isSome(a)?
a.unit:null,sizeEnabled:null==this._mode||"scale"===this._mode,sizePrecision:k.isSome(a)?M(a.valueType):null})}else this._tooltip.clear()};f._onScaleChanged=function(){this.events.emit("scale-changed");this._updateManipulatorTransform()};f._updateDelayedFocusedState=function(){this._ringManipulator.updateStateEnabled(g.DelayedFocused,this.getFocused());this._updateFocusTooltip()};f._updateDragState=function(){this._ringManipulator.updateStateEnabled(g.Unlocked,!(k.isSome(this._scaleRotateDragData)&&
"none"!==this._scaleRotateDragData.mode));if(k.isSome(this._scaleRotateDragData))switch(this._scaleRotateDragData.mode){case "rotate":this._ringManipulator.updateStateEnabled(g.ScaleIn|g.ScaleOut,!1);this._ringManipulator.updateStateEnabled(g.RotateLeft,0>this._scaleRotateDragData.angleDir);this._ringManipulator.updateStateEnabled(g.RotateRight,0<=this._scaleRotateDragData.angleDir);break;case "scale":this._ringManipulator.updateStateEnabled(g.RotateLeft|g.RotateRight,!1),this._ringManipulator.updateStateEnabled(g.ScaleIn,
0>this._scaleRotateDragData.scaleDir),this._ringManipulator.updateStateEnabled(g.ScaleOut,0<=this._scaleRotateDragData.scaleDir)}else this._ringManipulator.updateStateEnabled(g.ScaleIn|g.ScaleOut|g.RotateLeft|g.RotateRight,!1)};f._updateManipulatorTransform=function(){const a=C.fromRotation(t.sm4d.get(),this._adapter.angle,I.fromValues(0,0,1));if(!k.isNone(a)){var b=this.getScale();b=C.fromScaling(t.sm4d.get(),w.set(t.sv3d.get(),b,b,b));this._ringManipulator.modelTransform=C.multiply(t.sm4d.get(),
b,a)}};f._createRingManipulator=function(){var a=(F,B,T)=>{const U=[],V=Math.ceil(d.GEOMETRY_SEGMENTS*(B-F)/(2*Math.PI));for(let Q=0;Q<V+1;Q++){const W=F+Q*(B-F)/V;U.push(I.fromValues(T*Math.cos(W),T*Math.sin(W),0))}return U},b=(F,B)=>N.createPathExtrusionGeometry([[-B/2,0],[B/2,0],[B/2,d.RING_HEIGHT/2],[-B/2,d.RING_HEIGHT/2]],F,[],[],!1),n=a(0,2*Math.PI,d.RING_RADIUS),h=b(n,d.RING_THICKNESS),m=[],u=[];const A=[];for(var l=0;2>l;l++){var q=l*Math.PI-Math.PI/4,e=Math.PI/2-d.ROTATE_INDICATOR_ARC_LENGTH,
r=q+e;q=q+Math.PI/2-e;e=a(r,q,d.INNER_INDICATOR_RADIUS);var p=b(e,d.INDICATOR_THICKNESS);A.push(e);A.push(a(r,q,d.OUTER_INDICATOR_RADIUS-d.RING_THICKNESS/2));m.push(p);u.push(p);for(p=0;2>p;p++){var y=0===p,v=da.create();if(y){C.scale(v,v,[1,-1,1]);C.rotate(v,v,-r,[0,0,1]);var x=Math.round(d.ROTATE_INDICATOR_ARROW_PLACEMENT_PERCENTAGE*(e.length-1));v[12]=e[x][0];v[13]=e[x][1];v[14]=e[x][2]}else C.rotate(v,v,q,[0,0,1]),x=Math.round((1-d.ROTATE_INDICATOR_ARROW_PLACEMENT_PERCENTAGE)*(e.length-1)),v[12]=
e[x][0],v[13]=e[x][1],v[14]=e[x][2];x=N.createExtrudedTriangle(d.ROTATE_INDICATOR_ARROW_TIP_LENGTH,0,d.ROTATE_INDICATOR_ARROW_TIP_RADIUS,d.RING_HEIGHT);N.transformInPlace(x,v);(y?m:u).push(x)}}l=[];for(r=0;2>r;r++)q=r*Math.PI-Math.PI/4,e=Math.PI/2-d.SCALE_INDICATOR_ARC_LENGTH,q=a(q+e,q+Math.PI/2-e,d.OUTER_INDICATOR_RADIUS),l.push(b(q,d.INDICATOR_THICKNESS));r=a(0,2*Math.PI,d.RING_RADIUS+d.SCALE_INDICATOR_OFFSET1);q=a(0,2*Math.PI,d.RING_RADIUS+d.SCALE_INDICATOR_OFFSET2);r=b(r,d.INDICATOR_THICKNESS);
q=b(q,d.INDICATOR_THICKNESS);e=a(0,2*Math.PI,d.RING_RADIUS-d.SCALE_INDICATOR_OFFSET1);p=a(0,2*Math.PI,d.RING_RADIUS-d.SCALE_INDICATOR_OFFSET2);a=b(e,d.INDICATOR_THICKNESS);b=b(p,d.INDICATOR_THICKNESS);e=this._createMaterial();p=this._createMaterial(.66);v=this._createMaterial(.5);y=this._createMaterial(.33);h=[{geometry:h,material:e,stateMask:g.DelayedFocused},{geometry:h,material:v,stateMask:z.ManipulatorStateFlags.None}];this._mode&&"scale"!==this._mode||(h=h.concat([{geometry:l,material:e,stateMask:g.DelayedFocused|
g.Unlocked},{geometry:r,material:p,stateMask:g.DelayedFocused|g.ScaleIn},{geometry:q,material:y,stateMask:g.DelayedFocused|g.ScaleIn},{geometry:a,material:p,stateMask:g.DelayedFocused|g.ScaleOut},{geometry:b,material:y,stateMask:g.DelayedFocused|g.ScaleOut}]));this._mode&&"rotate"!==this._mode||(h=h.concat([{geometry:u,material:e,stateMask:g.DelayedFocused|g.Unlocked},{geometry:m,material:e,stateMask:g.DelayedFocused|g.RotateLeft},{geometry:u,material:e,stateMask:g.DelayedFocused|g.RotateRight}]));
n=[n,...A];return new ha.Manipulator3D({view:this.tool.view,renderObjects:h,autoScaleRenderObjects:!1,worldOriented:!0,radius:d.RING_THICKNESS,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:fa.getGraphicEffectiveElevationInfo(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:n,direction:I.fromValues(0,0,1)}})};f._createMaterial=function(a=1){const b=ea.fromArray([...d.HANDLE_COLOR,a]);return new na.ColorMaterial({color:b,transparent:1!==a,cullFace:la.CullFaceOptions.Back,renderOccluded:ma.RenderOccludedFlag.Transparent})};
X._createClass(c,[{key:"angle",get:function(){return this._adapter.angle}},{key:"scale",get:function(){return this._adapter.scale}},{key:"location",set:function(a){this._ringManipulator.location=a}},{key:"elevationAlignedLocation",set:function(a){this._ringManipulator.elevationAlignedLocation=a}},{key:"grabbing",get:function(){return this._ringManipulator.grabbing}},{key:"interactive",set:function(a){this._ringManipulator.interactive=a}},{key:"test",get:function(){return{ringManipulator:this._ringManipulator,
tooltip:this._tooltip}}}]);return c}();var D;(function(c){c[c.CONTINUE=0]="CONTINUE";c[c.STOP=1]="STOP"})(D||(D={}));const P=ca.createScreenPointArray();R.GraphicScaleRotateTransform=ta;Object.defineProperties(R,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});