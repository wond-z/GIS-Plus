// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../Color ../../../../core/maybe ../../../../core/unitUtils ../../../../chunks/earcut ../../../../chunks/mat4f64 ../../../../chunks/vec2 ../../../../chunks/vec2f64 ../../../../chunks/vec4 ../../../../chunks/common ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/aaBoundingRect ./ElevationAligners ./elevationAlignmentUtils ./ElevationContext ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./polygonUtils ../../support/renderInfoUtils/polygon ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/materials/WaterMaterial ../../webgl-engine/materials/internal/waterMaterialUtils".split(" "),
function(A,v,G,h,H,B,I,J,w,C,K,l,y,L,p,M,N,O,r,q,D,P,Q,E,R){const S=["polyline","polygon","extent"];r=function(k){function g(a,b,d,c){return k.call(this,a,b,d,c)||this}v._inheritsLoose(g,k);var f=g.prototype;f.doLoad=function(){var a=v._asyncToGenerator(function*(){});return function(){return a.apply(this,arguments)}}();f.destroy=function(){k.prototype.destroy.call(this);this._context.stage.remove(this._material);this._material=null};f.createGraphics3DGraphic=function(a){a=a.graphic;if(!this._validateGeometry(a.geometry,
S,this.symbolLayer.type))return null;const b=this.setGraphicElevationContext(a,new M.ElevationContext);this.ensureDrapedStatus("on-the-ground"===b.mode);this.ensureMaterial();return this.draped?this._createAsOverlay(a):this._createAs3DShape(a,b,a.uid)};f.ensureMaterial=function(){if(!h.isSome(this._material)){var a=new E.WaterMaterialParameters,b=this.symbolLayer.color;h.isSome(b)&&(a.color=G.toUnitRGBA(b));b=this._getCombinedOpacity(b,{hasIntrinsicColor:!0});a.color=[a.color[0],a.color[1],a.color[2],
b];a.transparent=1>b||this.needsDrivenTransparentPass;a.waveDirection=h.isSome(this.symbolLayer.waveDirection)?g.headingVectorFromAngle(this.symbolLayer.waveDirection):w.fromValues(0,0);b=R.wavePresets[this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize];a.waveStrength=b.waveStrength;a.waveTextureRepeat=b.textureRepeat;a.waveVelocity=b.waveVelocity;a.flowStrength=b.perturbationStrength;a.hasSlicePlane=this._context.slicePlaneEnabled;a.isDraped=this.draped;this._material=new E.WaterMaterial(a);
this._context.stage.add(this._material)}};f.layerOpacityChanged=function(){if(!h.isNone(this._material)){var a=this._material.parameters.color,b=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0});this._material.setParameters({color:[a[0],a[1],a[2],b],transparent:1>b||this.needsDrivenTransparentPass})}};f.layerElevationInfoChanged=function(a,b,d){const c=this._elevationContext.mode;d=p.elevationModeChangeUpdateType(g.elevationModeChangeTypes,d,c);if(d!==p.SymbolUpdateType.UPDATE)return d;
const e=p.needsElevationUpdates2D(c);return this.updateGraphics3DGraphicElevationInfo(a,b,()=>e)};f.slicePlaneEnabledChanged=function(){h.isSome(this._material)&&this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0};f.physicalBasedRenderingChanged=function(){return!0};f.pixelRatioChanged=function(){return!0};f._createAs3DShape=function(a,b,d){a=q.geometryAsPolygon(a.geometry);if(h.isNone(a))return null;var c=D.geometryToRenderInfo(a,this._context.elevationProvider,
this._context.renderCoordsHelper,b);const e=c.position.length/3,t=new Float64Array(2*e);c=new T(c,t);this._create3DShapeGeometries(c);this._logGeometryCreationWarnings(c.renderData,a.rings,"rings","WaterSymbol3DLayer");if(0===c.outGeometries.length)return null;this._createUVCoordsFromVertices(c.uvCoords,c.renderData.mapPosition,e,this._context.elevationProvider.spatialReference);d=new P.Object3D({geometries:c.outGeometries,materials:c.outMaterials,transformations:c.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,
graphicUid:d}});d=new O.Graphics3DObject3DGraphicLayer(this,d,c.outGeometries,null,null,L.perVertexElevationAligner,b);d.alignedSampledElevation=c.renderData.sampledElevation;d.needsElevationUpdates=p.needsElevationUpdates2D(b.mode);return d};f._createUVCoordsFromVertices=function(a,b,d,c){c=H.getMetersPerUnitForSR(c);y.empty(m);for(var e=0;e<d;e++)J.set(F,b[3*e],b[3*e+1]),y.expandPointInPlace(m,F);C.scale(m,m,c);e=m[1]%g.unitSizeOfTexture;x[0]=m[0]-m[0]%g.unitSizeOfTexture;x[1]=m[1]-e;for(e=0;e<
d;e++)a[2*e]=(b[3*e]*c-x[0])/g.unitSizeOfTexture,a[2*e+1]=(b[3*e+1]*c-x[1])/g.unitSizeOfTexture};f._create3DShapeGeometries=function(a){var b=a.renderData.polygons;const d=a.uvCoords;for(const {count:c,index:e,position:t,mapPosition:u,holeIndices:z}of b){if(h.isSome(this._context.clippingExtent)&&(l.empty(n),l.expandWithBuffer(n,u),!l.intersectsClippingArea(n,this._context.clippingExtent)))continue;b=B.earcut(u,z,3);if(0===b.length)continue;const U=new Float64Array(d.buffer,2*e*d.BYTES_PER_ELEMENT,
2*c);b=q.createWaterGeometry({indices:b,attributeData:{position:t,uv0:U,mapPosition:u}});a.outGeometries.push(b);a.outMaterials.push(h.unwrap(this._material));a.outTransforms.push(I.IDENTITY)}};f._createAsOverlay=function(a){const b=q.geometryAsPolygon(a.geometry);if(h.isNone(b))return null;h.unwrap(this._material).renderPriority=this._renderPriority;const d=D.geometryToRenderInfoDraped(b,this._context.overlaySR),c=d.position.length/3,e=new Float64Array(2*c);a=new V(d,e,this._context.layer.uid,a.uid);
a.outBoundingBox=l.empty();this._createAsOverlayWater(a);this._logGeometryCreationWarnings(a.renderData,b.rings,"rings","WaterSymbol3DLayer");if(0===a.outGeometries.length)return null;this._createUVCoordsFromVertices(a.uvCoords,a.renderData.position,c,this._context.overlaySR);return new N(this,a.outGeometries,a.outBoundingBox,this._context.drapeSourceRenderer)};f._createAsOverlayWater=function(a){const b=a.uvCoords;var d=a.renderData.polygons;for(const {position:e,holeIndices:t,index:u,count:z}of d)if(l.empty(n),
l.expandWithBuffer(n,e),l.intersectsClippingArea(n,this._context.clippingExtent)&&(l.expandWithAABB(a.outBoundingBox,n),d=B.earcut(e,t,3),0!==d.length)){var c=new Float64Array(b.buffer,2*u*b.BYTES_PER_ELEMENT,2*z);d=q.createWaterGeometry({indices:d,attributeData:{position:e,uv0:c}});d=new Q.RenderGeometry(d,h.unwrap(this._material),{layerUid:a.layerUid,graphicUid:a.graphicsUid});c=n;C.set(d.boundingSphere,.5*(c[0]+c[3]),.5*(c[1]+c[4]),0,.5*Math.sqrt((c[3]-c[0])*(c[3]-c[0])+(c[4]-c[1])*(c[4]-c[1])));
a.outGeometries.push(d)}};g.headingVectorFromAngle=function(a){const b=w.create();a=K.toRadian(a);b[0]=Math.sin(a);b[1]=Math.cos(a);return b};f.test=function(){return{...k.prototype.test.call(this),create3DShape:a=>this._createAs3DShape(a.graphic,a.elevationContext,a.graphicUid),ensureMaterial:()=>this.ensureMaterial()}};return g}(r.Graphics3DSymbolLayer);r.unitSizeOfTexture=100;r.elevationModeChangeTypes={definedChanged:p.SymbolUpdateType.RECREATE,staysOnTheGround:p.SymbolUpdateType.NONE,onTheGroundChanged:p.SymbolUpdateType.RECREATE};
const x=w.create(),m=y.create(),F=w.create(),n=l.create();let T=function(k){function g(f,a){f=k.call(this,f,null,null)||this;f.uvCoords=a;return f}v._inheritsLoose(g,k);return g}(q.PolygonCreationDataBase),V=function(k){function g(f,a,b,d){f=k.call(this,f,b,d)||this;f.uvCoords=a;return f}v._inheritsLoose(g,k);return g}(q.PolygonCreationDataBase);A.Graphics3DWaterSymbolLayer=r;Object.defineProperties(A,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});