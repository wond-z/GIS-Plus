// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/HandleOwner ../../../../core/Logger ../../../../core/maybe ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/projection ../../../../geometry/support/aaBoundingRect ./enums ../../../support/layerViewUtils ../../../support/Scheduler".split(" "),function(t,
f,e,B,l,g,E,F,C,u,v,h,w,D){const x=B.getLogger("esri.views.3d.layers.graphics.Graphics3DScaleVisibility");e=function(y){function n(a){a=y.call(this,a)||this;a._scaleRangeActive=!1;a._layerScaleRangeVisibilityQuery=!1;a._extent=null;a.graphicsCoreOwner=null;a.layer=null;a.queryGraphicUIDsInExtent=null;a.graphicsCore=null;a.basemapTerrain=null;a.layerScaleEnabled=!0;a.suspended=!1;a._dirty=!0;return a}t._inheritsLoose(n,y);var d=n.prototype;d.initialize=function(){this.updateScaleRangeActive();this.handles.add(this.graphicsCoreOwner.view.resourceController.scheduler.registerTask(D.TaskPriority.SCALE_VISIBILITY,
this));this.updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this.layerMinMaxScaleChangeHandler())};d.destroy=function(){this.updatingHandles.removeAll();this.handles.removeAll();this._dirty=!1;this.basemapTerrain=this.graphicsCore=this.queryGraphicUIDsInExtent=this.layer=this.graphicsCoreOwner=this._extent=null};d._setDirty=function(){this._dirty=!0};d.setExtent=function(a){const b=this.graphicsCoreOwner.view.spatialReference,c=this.graphicsCoreOwner.view.basemapTerrain.spatialReference;
if(b===c)this._extent=a;else{const p=v.create();u.projectBoundingRect(a,b,p,c)?this._extent=p:this._extent=null}this._setDirty()};d.scaleRangeActive=function(){return this._scaleRangeActive};d.updateScaleRangeActive=function(){var a=this.layer,b=a.effectiveScaleRange;b=this.layerScaleEnabled&&(0<b.minScale||0<b.maxScale);a.labelingInfo&&!b&&(b=a.labelingInfo.some(c=>c&&(0<c.minScale||0<c.maxScale)));a=this._scaleRangeActive!==b;(this._scaleRangeActive=b)&&!this.handles.has("terrain-events")&&this.basemapTerrain?
(this.handles.add(this.basemapTerrain.on("scale-change",c=>this._scaleUpdateHandler(c)),"terrain-events"),this.layerScaleEnabled&&this.handles.add(this.basemapTerrain.on("tiles-visibility-changed",()=>this._setDirty()),"terrain-events")):!b&&this.handles.has("terrain-events")&&this.handles.remove("terrain-events");return a};d.runTask=function(){const a=this.graphicsCoreOwner.view.basemapTerrain;if(!(this._extent&&a&&a.ready&&this._scaleRangeActive&&this.layerScaleEnabled))this._finishUpdate(!0);else if(!this._layerScaleRangeVisibilityQuery){this._layerScaleRangeVisibilityQuery=
!0;const b=this.layer.effectiveScaleRange;a.queryVisibleScaleRange(this._extent,b.minScale,b.maxScale,c=>this._finishUpdate(c))}};d._finishUpdate=function(a){this._layerScaleRangeVisibilityQuery=!1;this._set("suspended",!a);this._dirty=!1};d._visibleAtLayerScale=function(a){const b=this.layer.effectiveScaleRange;return!this.layerScaleEnabled||w.scaleBoundsPredicate(a,b.minScale||0,b.maxScale||0)};d._visibleAtLabelScale=function(a,b){return w.scaleBoundsPredicate(a,b.minScale||0,b.maxScale||0)};d._graphicScale=
function(a){let b;l.isSome(a.centroid)?b=a.centroid:l.isSome(a.graphic.geometry)&&"point"===a.graphic.geometry.type&&(b=a.graphic.geometry);return b?this.graphicsCoreOwner.view.basemapTerrain?this.graphicsCoreOwner.view.basemapTerrain.getScale(b):1:null};d._graphicVisible=function(a){if(!this.layerScaleEnabled)return!0;a=this._graphicScale(a);return this._visibleAtLayerScale(a)};d.updateVisibility=function(a){if(this._scaleRangeActive){const b=this._graphicVisible(a);return a.setVisibilityFlag(h.VisibilityFlag.SCALE_RANGE,
b,h.VisibilityGroup.GRAPHIC)}return!1};d.updateGraphicLabelScaleVisibility=function(a){if(!this._scaleRangeActive||!a.labelGraphics||0===a.labelGraphics.length)return!1;const b=this._graphicScale(a);if(a=this._updateLabelScaleVisibility(a,b))this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty();return a};d._updateLabelScaleVisibility=function(a,b){if(!a.labelGraphics||0===a.labelGraphics.length)return!1;const c=a.labelGraphics[0]._labelClass;return c&&
null!=c.minScale&&null!=c.maxScale&&(b=this._visibleAtLabelScale(b,c),a.setVisibilityFlag(h.VisibilityFlag.SCALE_RANGE,b,h.VisibilityGroup.LABEL))?!0:!1};d._scaleUpdateHandler=function(a){this._setDirty();if(!this.graphicsCoreOwner.suspended){var b=a.extent,c=a.scale,p=this._visibleAtLayerScale(c),r=!1,q=this.graphicsCoreOwner.view.spatialReference;a=a.spatialReference;if(l.isNone(a))x.error("scaleUpdate: Internal error, no SpatialReference given for tiles");else{var z=!a.equals(q);z&&!u.projectBoundingRect(b,
a,A,q)?x.error("scaleUpdate: Internal error, cannot project AABR from "+a+" to wkid "+q):(this.queryGraphicUIDsInExtent(z?A:b,q,k=>{k=this.graphicsCore.getGraphics3DGraphicById(k);if(!l.isNone(k)){var m=k.centroid;l.isSome(m)&&(b[0]>m.x||b[1]>m.y||b[2]<m.x||b[3]<m.y)||(k.setVisibilityFlag(h.VisibilityFlag.SCALE_RANGE,p,h.VisibilityGroup.GRAPHIC)&&(r=!0),this._updateLabelScaleVisibility(k,c)&&(r=!0))}}),r&&(this.graphicsCoreOwner.view.deconflictor.setDirty(),this.graphicsCoreOwner.view.labeler.setDirty()))}}};
d.layerMinMaxScaleChangeHandler=function(){this.updateScaleRangeActive()&&!this._scaleRangeActive?this.graphicsCore.modifyGraphics3DGraphicVisibilities(a=>a.clearVisibilityFlag(h.VisibilityFlag.SCALE_RANGE)):this._scaleRangeActive&&this.graphicsCore.updateAllGraphicsVisibility();this._setDirty()};t._createClass(n,[{key:"updating",get:function(){return this._dirty||this.updatingHandles.updating}},{key:"running",get:function(){return!(!this.graphicsCoreOwner.view.basemapTerrain||!this.updating)}}]);
return n}(e.HandleOwner);f.__decorate([g.property()],e.prototype,"graphicsCoreOwner",void 0);f.__decorate([g.property()],e.prototype,"layer",void 0);f.__decorate([g.property()],e.prototype,"queryGraphicUIDsInExtent",void 0);f.__decorate([g.property()],e.prototype,"graphicsCore",void 0);f.__decorate([g.property()],e.prototype,"basemapTerrain",void 0);f.__decorate([g.property({constructOnly:!0})],e.prototype,"layerScaleEnabled",void 0);f.__decorate([g.property({readOnly:!0})],e.prototype,"suspended",
void 0);f.__decorate([g.property({readOnly:!0})],e.prototype,"updating",null);f.__decorate([g.property()],e.prototype,"_dirty",void 0);e=f.__decorate([C.subclass("esri.views.3d.layers.graphics.Graphics3DScaleVisibility")],e);const A=v.create();return e});