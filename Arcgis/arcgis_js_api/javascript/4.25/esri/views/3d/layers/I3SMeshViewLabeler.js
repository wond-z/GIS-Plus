// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../Graphic ../../../symbols ../../../core/Accessor ../../../core/Handles ../../../core/maybe ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../core/accessorSupport/diffUtils ../../../chunks/vec3f64 ../../../layers/graphics/dehydratedFeatures ./graphics/Graphics3DCore ./graphics/Graphics3DScaleVisibility ./i3s/I3SGeometryUtil ../support/LimitGraphicsMap ../webgl-engine/lib/basicInterfaces ../../../symbols/PointSymbol3D".split(" "),
function(v,n,A,g,B,C,p,D,q,M,N,E,F,G,w,H,I,x,J,K,L){g=function(y){function r(a){a=y.call(this,a)||this;a.loadedGraphics=new J.LimitGraphicsMap(5E4);a.slicePlaneEnabled=!1;a._renderingInfo={symbol:new L};a._handles=new C;a._graphicsByNode=new Map;return a}v._inheritsLoose(r,y);var h=r.prototype;h.initialize=function(){const a=this.view.basemapTerrain;this._graphicsCore=new H.Graphics3DCore({owner:this,layer:this.layer,preferredUpdatePolicy:K.UpdatePolicy.ASYNC,elevationFeatureExpressionEnabled:!1,
graphicSymbolSupported:!1,getRenderingInfoWithoutRenderer:!0,hasZ:!0,hasM:!1,componentFactories:{deconflictor:c=>this.view.deconflictor.addGraphicsOwner(c),labeler:(c,b)=>this.view.labeler.addGraphicsOwner(c,b,{emptySymbolLabelSupported:!0,elevationInfoOverride:{mode:"absolute-height",offset:0},disablePlacement:{logEntityDescription:"3D Object Scene Layer features"}}),scaleVisibility:(c,b)=>new I({graphicsCoreOwner:this,layer:this.layer,queryGraphicUIDsInExtent:b,graphicsCore:c,basemapTerrain:a,layerScaleEnabled:!1})}});
this._graphicsCore.initializePromise.then(()=>this._graphicsCore.startCreateGraphics()).catch(()=>{});this._handles.add(D.watch(()=>this.layer.labelingInfo,(c,b)=>{F.diff(c,b)&&this._graphicsCore.updateLabelingInfo()}))};h.destroy=function(){this._handles=p.destroyMaybe(this._handles);this._graphicsCore=p.destroyMaybe(this._graphicsCore);this.loadedGraphics=p.destroyMaybe(this.loadedGraphics);this.view=null};h.addNodeMeta=function(a,c){let b=0;const d=a.filteredIds,k=this.view.spatialReference,l=
a.featureIds.map((e,t)=>{x.boundingBoxTop(t,this.collection,a.objectHandle,f);const z=w.makeDehydratedPoint(0,0,0,k);this.view.renderCoordsHelper.fromRenderCoords(f,z);t=c(t,a);let u=!1;p.isNone(d)?u=!0:b<d.length&&e===d[b]&&(u=!0,b++);return{objectId:e,uid:A.generateUID(),attributes:t,visible:u,geometry:z}});this.loadedGraphics.addMany(l);this._graphicsByNode.set(a.node.index,l)};h.updateLabelPositions=function(a){const c=this._graphicsByNode.get(a.node.index);let b=0;const d=this.view.spatialReference,
k=[];for(let l=0;l<a.featureIds.length;l++){const e=c[b];a.featureIds[l]===e.objectId&&(b++,x.boundingBoxTop(l,this.collection,a.objectHandle,f),this.view.renderCoordsHelper.fromRenderCoords(f,f,d),p.isSome(e.geometry)&&"point"===e.geometry.type&&e.geometry.x===f[0]&&e.geometry.y===f[1]&&e.geometry.z===f[2]||(p.isSome(e.geometry)&&"point"===e.geometry.type?(e.geometry.x=f[0],e.geometry.y=f[1],e.geometry.z=f[2]):e.geometry=w.makeDehydratedPoint(f[0],f[1],f[2],d),k.push(e.uid)))}this._graphicsCore.updateLabelingInfo(k)};
h.setNodeMetaAttributes=function(a,c){const b=this._graphicsByNode.get(a.node.index),d=Array(b.length);for(let k=0;k<b.length;k++){const l=b[k];l.attributes=c(k,a);d[k]=l.uid}this._graphicsCore.updateLabelingInfo(d)};h.applyFilterChange=function(a){var c=this._graphicsByNode.get(a.node.index);if(c)if(p.isNone(a.filteredIds))for(var b of c)b.visible||(b.visible=!0,m.graphic=b,m.property="visible",m.oldValue=!1,m.newValue=!0,this._graphicsCore.graphicUpdateHandler(m));else{b=0;for(const d of c)c=d.visible,
b<a.filteredIds.length&&d.objectId===a.filteredIds[b]?(d.visible=!0,b++):d.visible=!1,c!==d.visible&&(m.graphic=d,m.property="visible",m.oldValue=c,m.newValue=d.visible,this._graphicsCore.graphicUpdateHandler(m))}};h.removeNodeMeta=function(a){this.loadedGraphics.removeManyByObjectId(a.featureIds)};h.getRenderingInfo=function(){return this._renderingInfo};h.notifyGraphicGeometryChanged=function(){};h.notifyGraphicVisibilityChanged=function(){};v._createClass(r,[{key:"updating",get:function(){return this._graphicsCore?.updating??
!1}},{key:"updatePolicy",get:function(){return this._graphicsCore.effectiveUpdatePolicy}},{key:"usedMemory",get:function(){return this._graphicsCore.usedMemory}},{key:"unloadedMemoryEstimate",get:function(){return this._graphicsCore.unprocessedMemoryEstimate}},{key:"test",get:function(){return{graphicsCore:this._graphicsCore}}}]);return r}(B);n.__decorate([q.property()],g.prototype,"view",void 0);n.__decorate([q.property()],g.prototype,"layer",void 0);n.__decorate([q.property()],g.prototype,"collection",
void 0);n.__decorate([q.property()],g.prototype,"loadedGraphics",void 0);n.__decorate([q.property()],g.prototype,"updating",null);n.__decorate([q.property()],g.prototype,"slicePlaneEnabled",void 0);n.__decorate([q.property()],g.prototype,"_graphicsCore",void 0);g=n.__decorate([E.subclass("esri.views.3d.layers.I3SMeshViewLabeler")],g);const m={graphic:null,property:null,oldValue:null,newValue:null},f=G.create();return g});