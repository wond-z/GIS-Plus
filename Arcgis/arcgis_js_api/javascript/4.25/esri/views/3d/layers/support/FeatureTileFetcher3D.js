// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/Handles ../../../../core/Logger ../../../../core/MapUtils ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/scheduling ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/support/aaBoundingRect ../../../../layers/graphics/dehydratedFeatures ../../../../rest/support/QuantizationParameters ../../../../rest/support/Query ../../../ViewingMode ./featureReference ./FeatureTile ../../terrain/tileUtils ../../../support/Scheduler".split(" "),
function(p,w,q,N,O,P,Q,k,z,R,S,t,aa,ba,T,y,x,U,G,V,H,u,W,I){function D(n){return"dummy-tile-full-extent"===n.id}function X(n){let l=0;for(const e of n)e.features&&0<e.features.length&&e.alive&&(l=Math.max(l,e.descriptor.lij[0]));return l}function Y(n){n.setFeatures([],0,null);n.featuresMissing=!1;return u.FetchStatus.DONE}function J(n){return k.isNone(n)?new Set:new Set(n.map(l=>l.name))}function K(n,l){if(k.isNone(n)||k.isNone(l))return J(l);const e=new Set;for(const {name:a}of l)n.has(a)&&e.add(a);
return e}const E=P.getLogger("esri.views.3d.layers.support.FeatureTileFetcher3D");p.FeatureTileFetcher3D=function(n){function l(a){a=n.call(this,a)||this;a._useTileCount=!1;a.updating=!1;a.updatingTotal=0;a.updatingRemaining=0;a.expectedFeatureDiff=0;a.maximumNumberOfFeaturesExceeded=!1;a.maximumNumberOfFeaturesExceededThrottle=1E3;a._fullRatio=1;a._farRatio=1;a._changes={updates:{adds:[],removes:[]},adds:[],removes:[]};a._handles=new O;a._frameTask=I.ImmediateTask;a._dirty=!1;a._featureTiles=new Map;
a._displayingFeatureReferences=new Map;a._numDisplayingFeatureReferences=0;a._suspended=!0;a._pendingEdits=null;return a}w._inheritsLoose(l,n);var e=l.prototype;e.initialize=function(){this._handles.add(R.on(()=>this.tileDescriptors,"change",()=>this._setDirty(),{onListenerAdd:()=>this._setDirty()}));this._objectIdField=this.context.objectIdField;this.FeatureReferenceClass=this.context.capabilities.supportsMultipleResolutions?H.MultiFeatureReference:H.SingleFeatureReference;const a=this.context.scheduler;
k.isSome(a)&&(this._frameTask=a.registerTask(I.TaskPriority.FEATURE_TILE_FETCHER,this));this._setDirty()};e.destroy=function(){this._frameTask.remove();this._handles=k.destroyMaybe(this._handles);this._featureTiles.forEach(a=>{this._cancelFetchTile(a);this._removeTile(a)});this._featureTiles.clear();this._displayingFeatureReferences.clear();this._pendingEdits&&(this._pendingEdits.controller.abort(),this._pendingEdits=null)};e.restart=function(){this._featureTiles.forEach(a=>{this._cancelFetchTile(a);
this._clearTile(a);this._resetFetchTile(a)});k.isSome(this.context.memoryCache)&&this.context.memoryCache.clear();this._setDirty()};e.refetch=function(){this._featureTiles.forEach(a=>{this._cancelFetchTile(a);this._resetFetchTile(a)});k.isSome(this.context.memoryCache)&&this.context.memoryCache.clear();this._setDirty()};e.suspend=function(){this._suspended||(this._suspended=!0,this._pause(),this._setDirty())};e.resume=function(){this._suspended&&(this._suspended=!1,this._unpause())};e._pause=function(){this._paused&&
(this._featureTiles.forEach(a=>this._cancelFetchTile(a)),this._updated())};e._unpause=function(){this._paused||(this._setDirty(),this._updated())};e.applyEdits=function(a){this._pendingEdits||(this._pendingEdits={edits:Promise.resolve(),count:0,controller:new AbortController},this._pause());const b=this._pendingEdits;b.count++;const c=b.edits.then(()=>a.result.catch(d=>{if(z.isAbortError(d))throw d;return null}).then(d=>{if(!d)return d;this._applyEditsDeleteFeatures(d.deletedFeatures);return this._applyEditsAddUpdateFeatures(d.addedFeatures,
d.updatedFeatures,b.controller.signal).then(()=>d)}).then(d=>{0===--b.count&&(this._pendingEdits===b&&(this._pendingEdits=null),k.isSome(this.context.memoryCache)&&this.context.memoryCache.clear(),this._unpause(),this._updated());return d}));b.edits=c;this._updated();return c};e._applyEditsDeleteFeatures=function(a){if(0!==a.length){var b=this.context.globalIdField,c=b&&this.availableFields.has(b),d=new Set,f=this._objectIdField;a.forEach(({objectId:g,globalId:h})=>{(!g||0>g)&&b?(c||E.errorOncePerTick(`Editing the specified service requires the layer's globalIdField, ${b} to be included the layer's outFields for updates to be reflected in the view`),
(g=this.features.find(m=>m.attributes&&m.attributes[b]===h))&&d.add(x.getObjectId(g,f))):d.add(g)});this._featureTiles.forEach(g=>{if(g.features){var h=g.features.filter(m=>!d.has(x.getObjectId(m,this._objectIdField)));h.length!==g.features.length&&(g.setFeatures(h,0,g.availableFields),this._invalidateCounts())}})}};e._applyEditsAddUpdateFeatures=function(){var a=w._asyncToGenerator(function*(b,c,d){const f=[],g=new Set;b.forEach(m=>f.push(m.objectId));c.forEach(m=>{f.push(m.objectId);g.add(m.objectId)});
if(0!==f.length){var h=[];this._featureTiles.forEach(m=>{(m=this._applyEditsAddUpdateTile(m,f,g,d))&&h.push(m)});yield z.eachAlways(h)}});return function(b,c,d){return a.apply(this,arguments)}}();e._applyEditsAddUpdateTile=function(){var a=w._asyncToGenerator(function*(b,c,d,f){if(b.features){var g=this._createQuery(b);g.resultType=void 0;g.cacheHint=!1;g.objectIds=c;c=yield this._queryFeatures(g,f);f=null;0<d.size&&(g=b.features.filter(h=>!d.has(x.getObjectId(h,this._objectIdField))),g.length!==
b.features.length&&(f=g));if(0<c.features.length){f||(f=b.features.slice());for(const h of c.features)f.push(h)}f&&(b.hasPreciseFeatureCount&&(b.numFeatures=Math.max(b.numFeatures,f.length)),b.setFeatures(f,0,K(b.availableFields,c.fields)),this._invalidateCounts())}});return function(b,c,d,f){return a.apply(this,arguments)}}();e._queryFeatures=function(a,b){return this.context.query.queryFeaturesDehydrated(a,{signal:b,timeout:6E5})};e._setDirty=function(){this._dirty=!0;this._updated()};e.runTask=
function(a){this._frameTask.processQueue(a);if(this._dirty&&this.initialized){this._dirty=!1;var b=this._getListOfTiles();this._markTilesNotAlive(b);if(a.run(()=>this._addTiles(b,a))&&a.run(()=>this._filterExtentTiles(b,a))&&a.run(()=>this._removeTiles(b,a))&&!a.done){var c=this._sortTiles(b);a.run(()=>this._displayTiles(c,a))&&a.run(()=>this._fetchTiles(c,a))&&a.run(()=>this._updateMemoryEstimates(c,a))||this._setDirty();this._updated();this.updating||this._updateMaximumNumberOfFeaturesExceeded()}else this._setDirty()}};
e._markTilesNotAlive=function(a){for(const b of a)b.alive=!1};e._addTiles=function(a,b){if(this._suspended)return!1;this.tileDescriptors.forEach(c=>{const d=this._featureTiles.get(c.id);d?d.alive=!0:b.done||(a.push(this._addTile(c)),b.madeProgress())});return b.hasProgressed};e._filterExtentTiles=function(a,b){for(const c of a){if(b.done)break;c.alive&&(c.filtered=!c.intersects(this.filterExtent),c.filtered&&(this._clearTile(c),b.madeProgress()))}return b.hasProgressed};e._removeTiles=function(a,
b){for(let c=a.length-1;0<=c&&!b.done;c--){const d=a[c];d.alive||(this._removeTile(d),c!==a.length-1&&(a[c]=a[a.length-1]),a.pop(),b.madeProgress())}return b.hasProgressed};e._sortTiles=function(a){a.sort((b,c)=>b.descriptor.loadPriority-c.descriptor.loadPriority);return a};e._displayTiles=function(a,b){const c=this._updateRatio(a),d=f=>{const g=1>this._fullRatio?c(f)*this._farRatio:1;f.reduceFeatures(g,this.memoryFactor,this._objectIdField)&&this._setDirty();return this._showTile(f)};for(const f of a)if(!b.run(()=>
d(f))){this._setDirty();break}return b.hasProgressed};e._fetchTiles=function(a,b){if(this._paused)return!1;var c=!1;for(const f of a)if(f.needsFetching){var d=k.isSome(this.context.memoryCache)?this.context.memoryCache.pop(f.id):null;if(k.isSome(d))f.cache=d,this._setDirty(),this._scheduleUpdated(),b.madeProgress();else if(this._needsNumFeatures(f)&&(c=new AbortController,d=this._fetchTileCount(f,c.signal),this._handleRequest(f,d,c,()=>f.numFeatures=u.FAILED_FEATURE_COUNT),c=!0,b.madeProgress()),
b.done)return!0}if(c)return b.hasProgressed;for(const f of a)if(f.needsFetching&&(a=new AbortController,c=this._fetchTile(f,a.signal),this._handleRequest(f,c,a,g=>{f.setFeatures([],0,null);this._invalidateCounts();f.featuresMissing=!1;this.context.logFetchError(E,g)}),b.madeProgress(),b.done))return!0;return b.hasProgressed};e._updateMemoryEstimates=function(a,b){a.some(c=>b.run(()=>c.updateMemoryEstimates())?!1:(this._setDirty(),!0));return b.hasProgressed};e._reclip=function(a,b){if(this.initialized){var c=
[];this._featureTiles.forEach(d=>{k.isNone(d.displayingFeatures)||0===d.displayingFeatures.length||(d.intersectionIncludingBorrowed(b,L),d.intersectionIncludingBorrowed(a,M),y.equals(L,M)||c.push(d))});this._refreshDisplayingFeatures(c);this._updated()}};e._refreshDisplayingFeatures=function(a){const b=new Set,c=this._changes.updates;for(const d of a)if(!k.isNone(d.displayingFeatures))for(const f of d.displayingFeatures)a=x.getObjectId(f,this._objectIdField),b.has(a)||(b.add(a),{feature:a}=this._displayingFeatureReferences.get(a),
c.removes.push(a),c.adds.push(a));this._applyChanges()};e._updated=function(){let a=0;this._paused||this._featureTiles.forEach(c=>c.isFetching?++a:0);var b=this._dirty||0<a||!!this._pendingEdits;this._set("updating",b);if(b){let c=0,d=0,f=0,g=0,h=0;const m=this._displayingFeatureReferences.size/this._numDisplayingFeatureReferences;this._featureTiles.forEach(r=>{++d;if(r.isFetching&&r.hasPreciseFeatureCount){const A=this._maximumFeaturesForTile(r)*(1-r.emptyFeatureRatio),B=k.isSome(r.displayingFeatures)?
r.displayingFeatures.length*m:0;h+=A-B}r.needsFetching?++g:0<r.numFeatures&&(++f,c+=r.numFeatures)});g+=a;let v=b=0;c?(v=c,b=Math.min(g*c/f,c)):(v=d,b=g);h=Math.min(this.maximumNumberOfFeatures-this.features.length,h);this._set("updatingTotal",v);this._set("updatingRemaining",b);this._set("expectedFeatureDiff",h)}else this._set("updatingTotal",0),this._set("updatingRemaining",0),this._set("expectedFeatureDiff",0);this.debugger&&this.debugger.update()};e._updateMaximumNumberOfFeaturesExceeded=function(){const a=
Q.someMap(this._featureTiles,b=>b.perTileMaximumNumberOfFeaturesExceeded);this._set("maximumNumberOfFeaturesExceeded",a)};e._updateRatio=function(a){const b=X(a),c=g=>1/(1<<Math.max(0,b-g.descriptor.lij[0]));let d=0,f=0;for(const g of a)a=g.numFeatures,d+=a,f+=a*c(g);this._fullRatio=Math.min(1,this.maximumNumberOfFeatures/d);this._farRatio=this.maximumNumberOfFeatures/f;this._scheduleUpdated();return c};e._maximumFeaturesUpdated=function(a,b){a!==b&&(b>a&&this._featureTiles.forEach(c=>{if(c.featuresMissing){var d=
this._maximumFeaturesForTile(c);c.features&&(c.features.length>=d||c.fetchStatus===u.FetchStatus.FULL)||(this._cancelFetchTile(c),this._resetFetchTile(c))}}),this._setDirty())};e._addTile=function(a){a=new u.FeatureTile(a);this._featureTiles.set(a.id,a);this._resetFetchTile(a);this._referenceDisplayingFeaturesFromRelatedTiles(a);return a};e._referenceDisplayingFeaturesFromRelatedTiles=function(a){const b=a.descriptor.resolution;this._featureTiles.forEach(c=>{if(!(k.isNone(c.displayingFeatures)||a===
c||a.descriptor.lij&&c.descriptor.lij&&!W.tilesAreRelated(a.descriptor.lij,c.descriptor.lij))){k.isNone(a.displayingFeatures)&&(a.displayingFeatures=[]);a.descriptor.extent&&c.descriptor.extent&&(k.isNone(a.extentIncludingBorrowedFeatures)&&(a.extentIncludingBorrowedFeatures=y.clone(a.descriptor.extent)),y.expand(a.extentIncludingBorrowedFeatures,c.descriptor.extent,a.extentIncludingBorrowedFeatures));for(const d of c.displayingFeatures)a.displayingFeatures.push(d),c=this._displayingFeatureReferences.get(x.getObjectId(d,
this._objectIdField)),c.ref(c.feature,b),this._numDisplayingFeatureReferences++}});a.featureLimit=k.isSome(a.displayingFeatures)?a.displayingFeatures.length:0};e._removeTile=function(a){this._clearTile(a);this._featureTiles.delete(a.id)};e._resetFetchTile=function(a){a.filtered=!a.intersects(this.filterExtent);a.filtered?a.needsFetching&&(a.fetchStatus=u.FetchStatus.DONE):a.fetchStatus=u.FetchStatus.FETCH_NEEDED};e._cancelFetchTile=function(a){const b=a.requestController;k.isSome(b)&&(a.requestController=
null,a.resetFetching(),b.abort())};e._fetchTileCount=function(){var a=w._asyncToGenerator(function*(b,c){b.numFeatures=yield this._fetchCount(b,c);this._updateRatio(this._getListOfTiles());return b.fetchStatus===u.FetchStatus.REFETCHING?u.FetchStatus.REFETCH_NEEDED:u.FetchStatus.FETCH_NEEDED});return function(b,c){return a.apply(this,arguments)}}();e._fetchTile=function(){var a=w._asyncToGenerator(function*(b,c){var d=this._maximumFeaturesForTile(b);if(0>=d)return Y(b);const f=this._getMaxRecordCount(b);
var g=Math.ceil(d/f);if(D(b)||!this.context.capabilities.supportsMaxRecordCountFactor||b.numFeatures<=d&&g>G.MAX_MAX_RECORD_COUNT_FACTOR)return this._fetchPagedTile(b,c);g=this._createQuery(b);g.maxRecordCountFactor=Math.ceil(d/f);b.isRefetching&&b.features&&0<b.features.length&&(g.maxRecordCountFactor=Math.max(Math.ceil(b.features.length/(1-b.emptyFeatureRatio)/f)+1,g.maxRecordCountFactor));const {features:h,exceededTransferLimit:m,fields:v}=yield this._queryFeatures(g,c);d=m?g.maxRecordCountFactor>=
G.MAX_MAX_RECORD_COUNT_FACTOR?u.FetchStatus.FULL:u.FetchStatus.DONE:u.FetchStatus.FULL;yield this._frameTask.schedule(()=>{b.featuresMissing=h.length<b.numFeatures||m;const r=this._removeEmptyFeatures(h);b.setFeatures(h,r,J(v))},c);z.throwIfAborted(c);this._invalidateCounts();return d});return function(b,c){return a.apply(this,arguments)}}();e._fetchCount=function(){var a=w._asyncToGenerator(function*(b,c){return this.context.query.queryFeatureCount(this._createFeatureCountQuery(b),{signal:c})});
return function(b,c){return a.apply(this,arguments)}}();e._fetchPagedTile=function(){var a=w._asyncToGenerator(function*(b,c){let d=0,f=0,g,h=0,m=this._maximumFeaturesForTile(b)-h;const v=this._getMaxRecordCount(b);let r=null;for(;;){const A=this._createQuery(b),B=this._setPagingParameters(A,d,m,v),{features:C,exceededTransferLimit:F,fields:Z}=yield this._queryFeatures(A,c);yield this._frameTask.schedule(()=>{B&&(d+=k.unwrap(A.num));h+=C.length;f+=this._removeEmptyFeatures(C);b.featuresMissing=d<
b.numFeatures||F;g=g?g.concat(C):C;r=K(r,Z);b.setFeatures(g,f,r)},c);z.throwIfAborted(c);this._invalidateCounts();this._setDirty();m=this._maximumFeaturesForTile(b)-h;if(!B||!F||0>=m)return F?u.FetchStatus.DONE:u.FetchStatus.FULL}});return function(b,c){return a.apply(this,arguments)}}();e._createFeatureCountQuery=function(a){a=this._createQuery(a);this.context.capabilities.supportsCacheHint&&(a.resultType=void 0,a.cacheHint=!0);return a};e._createQuery=function(a){const b=this.context.createQuery(),
c=a.descriptor.extent;c&&(b.geometry=y.toExtent(c,this.context.tilingScheme.spatialReference));this._setResolutionParams(b,a);this._useTileQuery(a)?b.resultType="tile":this.context.capabilities.supportsCacheHint&&(b.cacheHint=!0);return b};e._setPagingParameters=function(a,b,c,d){if(!this.context.capabilities.supportsPagination)return!1;a.start=b;0<c&&this.context.capabilities.supportsMaxRecordCountFactor?(a.maxRecordCountFactor=Math.ceil(c/d),a.num=Math.min(a.maxRecordCountFactor*d,c)):a.num=Math.min(d);
return!0};e._getEffectiveTileResolution=function(a){if(null==a.descriptor.resolution)return null;const b=this.context.viewingMode===V.ViewingMode.Global?this.context.tilingScheme.resolutionAtLevel(3):Infinity;return Math.min(a.descriptor.resolution,b)/this.lodFactor};e._setResolutionParams=function(a,b){this._supportsResolution&&(b=this._getEffectiveTileResolution(b),null!=b&&(this.context.capabilities.supportsQuantization?a.quantizationParameters=new U({mode:"view",originPosition:"upper-left",tolerance:b,
extent:this.context.fullExtent}):"polyline"===this.context.geometryType&&(a.maxAllowableOffset=b)))};e._removeEmptyFeatures=function(a){const b=a.length;for(let c=0;c<a.length;)x.hasVertices(a[c].geometry)?++c:(a[c]=a[a.length-1],--a.length);return b-a.length};e._needsNumFeatures=function(a){return this.useTileCount&&a.needsFeatureCount&&!D(a)};e._getMaxRecordCount=function(a){const {tileMaxRecordCount:b,maxRecordCount:c}=this.context;return this._useTileQuery(a)&&k.isSome(b)&&0<b&&this.context.capabilities.supportsResultType?
b:k.isSome(c)&&0<c?c:2E3};e._useTileQuery=function(a){return D(a)&&this.context.capabilities.supportsCacheHint?!1:this.context.capabilities.supportsResultType};e._handleRequest=function(a,b,c,d){a.fetchStatus=a.needsRefetching?u.FetchStatus.REFETCHING:u.FetchStatus.FETCHING;a.requestController=c;let f=!1;b.then(g=>{a.requestController=null;a.fetchStatus=g}).catch(g=>{a.requestController===c&&(a.requestController=null,a.fetchStatus=u.FetchStatus.DONE);z.isAbortError(g)?f=!0:d(g)}).then(()=>{f||this._setDirty();
this._scheduleUpdated()})};e._scheduleUpdated=function(){this._handles&&!this._handles.has("scheduleUpdated")&&this._handles.add(S.schedule(()=>{this._handles.remove("scheduleUpdated");this._updated()}),"scheduleUpdated")};e._showTile=function(a){if(k.isSome(a.displayingFeatures)&&!a.needsDisplayUpdate)return!1;var b=a.features;if(0===a.featureLimit||!b)return b=k.isSome(a.displayingFeatures)&&0<a.displayingFeatures.length,this._hideTileFeatures(a),a.displayingFeatures=[],b;const c=a.descriptor.resolution,
d=this._changes.updates,f=this._changes.adds,g=Math.min(a.featureLimit,b.length);a.featureLimit=g;for(let m=0;m<g;++m){var h=b[m];const v=x.getObjectId(h,this._objectIdField),r=this._displayingFeatureReferences.get(v);r?(h=r.ref(h,c),h.oldVersion!==h.newVersion&&(d.removes.push(h.oldVersion),d.adds.push(h.newVersion))):(this._displayingFeatureReferences.set(v,new this.FeatureReferenceClass(h,c)),f.push(h));this._numDisplayingFeatureReferences++}this._hideTileFeatures(a);this._applyChanges();a.displayingFeatures=
b.slice(0,g);return!0};e._hideTile=function(a){this._cancelFetchTile(a);this._hideTileFeatures(a)};e._hideTileFeatures=function(a){if(!k.isNone(a.displayingFeatures)){var b=this._changes.updates,c=this._changes.removes;for(const f of a.displayingFeatures){const g=x.getObjectId(f,this._objectIdField);var d=this._displayingFeatureReferences.get(g);d&&((d=d.unref(a.descriptor.resolution),this._numDisplayingFeatureReferences--,d)?d.oldVersion!==d.newVersion&&(null==d.newVersion?(this._displayingFeatureReferences.delete(g),
c.push(d.oldVersion)):(b.adds.push(d.newVersion),b.removes.push(d.oldVersion))):console.error("Hiding unreferenced feature"))}this._applyChanges();a.displayingFeatures=null}};e._applyChanges=function(){var a=this._changes.updates;0<a.removes.length&&(this.features.removeMany(a.removes),a.removes.length=0);0<a.adds.length&&(this.features.addMany(a.adds),a.adds.length=0);a=this._changes.adds;const b=this._changes.removes,c=Math.min(a.length,b.length);let d=0;for(;d<c;){const f=Math.min(d+200,c);this.features.addMany(a.slice(d,
f));this.features.removeMany(b.slice(d,f));d=f}a.length>c&&this.features.addMany(0===d?a:a.slice(d));b.length>c&&this.features.removeMany(0===d?b:b.slice(d));a.length=0;b.length=0};e._clearTile=function(a){this._hideTile(a);a.features&&k.isSome(this.context.memoryCache)&&this.context.memoryCache.put(a.id,a.cache,16+a.estimatedSize);a.setFeatures(null,0,null);this._invalidateCounts()};e._invalidateCounts=function(){this.notifyChange("totalVertices");this.notifyChange("totalFeatures");this.notifyChange("memoryForUnusedFeatures")};
e._getListOfTiles=function(){return Array.from(this._featureTiles.values())};e._maximumFeaturesForTile=function(a){const b=a.hasPreciseFeatureCount?a.numFeatures:Infinity;return Math.min(Math.ceil((a.hasPreciseFeatureCount?b:this.maximumNumberOfFeatures)*(1>this._fullRatio?this._farRatio:1)/(1-a.emptyFeatureRatio)),b)};w._createClass(l,[{key:"maximumNumberOfFeatures",set:function(a){a=a||Infinity;const b=this._get("maximumNumberOfFeatures");a===b||1>a||(this._set("maximumNumberOfFeatures",a),this._maximumFeaturesUpdated(b,
a))}},{key:"memoryFactor",set:function(a){this.memoryFactor!==a&&(this._set("memoryFactor",a),this._setDirty())}},{key:"lodFactor",set:function(a){this.lodFactor!==a&&(this._set("lodFactor",a),this._supportsResolution&&this.refetch())}},{key:"useTileCount",get:function(){return this._useTileCount&&k.isSome(this.context.query.queryFeatureCount)},set:function(a){this._useTileCount=a;this.notifyChange("useTileCount")}},{key:"memoryForUnusedFeatures",get:function(){let a=0;this._featureTiles.forEach(b=>
a+=b.estimatedUnusedSize);return a}},{key:"totalVertices",get:function(){let a=0;this._featureTiles.forEach(b=>a+=b.numVertices);return a}},{key:"totalFeatures",get:function(){let a=0;this._featureTiles.forEach(b=>a+=b.numFeatures);return a}},{key:"filterExtent",set:function(a){if(a&&this.context.tilingScheme&&!a.spatialReference.equals(this.context.tilingScheme.spatialReference))E.error("#filterExtent\x3d","extent needs to be in the same spatial reference as the tiling scheme");else{var b=this._get("filterExtent");
b===a||b&&a&&b.equals(a)||(a=a?a.clone():null,this._set("filterExtent",a),this._reclip(a,b))}}},{key:"_paused",get:function(){return this._suspended||!!this._pendingEdits}},{key:"availableFields",get:function(){let a=null;this._featureTiles.forEach(b=>{k.isNone(b.displayingFeatures)||0===b.displayingFeatures.length||(k.isNone(a)?a=new Set(b.availableFields):a.forEach(c=>{b.availableFields.has(c)||k.unwrap(a).delete(c)}))});return k.isSome(a)?a:new Set}},{key:"running",get:function(){return this.updating}},
{key:"_supportsResolution",get:function(){return this.context.capabilities.supportsMultipleResolutions&&"point"!==this.context.geometryType}},{key:"storedFeatures",get:function(){return this._getListOfTiles().reduce((a,b)=>a+(b.features?b.features.length:0),0)}},{key:"test",get:function(){return{process:a=>this.runTask(a),getFeatureTileById:a=>this._featureTiles.get(a),forEachFeatureTile:a=>this._featureTiles.forEach(a)}}}]);return l}(N);q.__decorate([t.property({constructOnly:!0})],p.FeatureTileFetcher3D.prototype,
"features",void 0);q.__decorate([t.property()],p.FeatureTileFetcher3D.prototype,"tileDescriptors",void 0);q.__decorate([t.property({value:Infinity})],p.FeatureTileFetcher3D.prototype,"maximumNumberOfFeatures",null);q.__decorate([t.property({value:1})],p.FeatureTileFetcher3D.prototype,"memoryFactor",null);q.__decorate([t.property({value:1})],p.FeatureTileFetcher3D.prototype,"lodFactor",null);q.__decorate([t.property()],p.FeatureTileFetcher3D.prototype,"useTileCount",null);q.__decorate([t.property({readOnly:!0})],
p.FeatureTileFetcher3D.prototype,"updating",void 0);q.__decorate([t.property({readOnly:!0})],p.FeatureTileFetcher3D.prototype,"updatingTotal",void 0);q.__decorate([t.property({readOnly:!0})],p.FeatureTileFetcher3D.prototype,"updatingRemaining",void 0);q.__decorate([t.property({readOnly:!0})],p.FeatureTileFetcher3D.prototype,"expectedFeatureDiff",void 0);q.__decorate([t.property({readOnly:!0})],p.FeatureTileFetcher3D.prototype,"memoryForUnusedFeatures",null);q.__decorate([t.property({readOnly:!0})],
p.FeatureTileFetcher3D.prototype,"maximumNumberOfFeaturesExceeded",void 0);q.__decorate([t.property({constructOnly:!0})],p.FeatureTileFetcher3D.prototype,"maximumNumberOfFeaturesExceededThrottle",void 0);q.__decorate([t.property({readOnly:!0})],p.FeatureTileFetcher3D.prototype,"totalVertices",null);q.__decorate([t.property({readOnly:!0})],p.FeatureTileFetcher3D.prototype,"totalFeatures",null);q.__decorate([t.property()],p.FeatureTileFetcher3D.prototype,"filterExtent",null);q.__decorate([t.property({constructOnly:!0})],
p.FeatureTileFetcher3D.prototype,"context",void 0);p.FeatureTileFetcher3D=q.__decorate([T.subclass("esri.views.3d.layers.support.FeatureTileFetcher3D")],p.FeatureTileFetcher3D);const L=y.create(),M=y.create();p.contextCapabilitiesFromLayer=function(n){const l=n.capabilities.query;a:switch(n.geometryType){case "polyline":n=!0;break a;case "polygon":n=n.capabilities&&n.capabilities.query&&n.capabilities.query.supportsQuantization;break a;default:n=!1}return{supportsMultipleResolutions:n,supportsPagination:!(!l||
!l.supportsPagination),supportsResultType:!(!l||!l.supportsResultType),supportsCacheHint:!(!l||!l.supportsCacheHint),supportsQuantization:!(!l||!l.supportsQuantization),supportsQuantizationEditMode:!(!l||!l.supportsQuantizationEditMode),supportsMaxRecordCountFactor:!(!l||!l.supportsMaxRecordCountFactor),supportsFormatPBF:!(!l||!l.supportsFormatPBF)}};Object.defineProperties(p,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});