// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../geometry ../../../../renderers/ClassBreaksRenderer ../../../../renderers/DictionaryRenderer ../../../../renderers/DotDensityRenderer ../../../../renderers/HeatmapRenderer ../../../../renderers/PieChartRenderer ../../../../renderers/Renderer ../../../../renderers/SimpleRenderer ../../../../renderers/UniqueValueRenderer ../../../../renderers/support/jsonUtils ../../../../symbols ../../../../core/Accessor ../../../../core/has ../../../../core/Error ../../../../core/Handles ../../../../core/handleUtils ../../../../core/Logger ../../../../core/MapUtils ../../../../core/maybe ../../../../core/PooledArray ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/scheduling ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../core/accessorSupport/diffUtils ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/projection ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/spatialReferenceUtils ../../../../layers/Layer ../../../../layers/graphics/dehydratedFeatures ../../../../layers/graphics/hydratedFeatures ../../../../renderers/support/rendererConversion ../../../../support/arcadeOnDemand ../../../../symbols/support/defaults3D ../../../../symbols/support/symbolConversion ./ElevationQuery ./enums ./featureExpressionInfoUtils ./Graphics3DFeatureStore ./Graphics3DGraphicCreationContext ./Graphics3DSymbolCreationContext ./Graphics3DSymbolFactory ./Graphics3DWebStyleSymbol ./GraphicStateTracking ./graphicUtils ./interfaces ./Loadable ./SpatialIndex2D ./symbolComplexity ../support/StageLayerElevationProvider ../../support/extentUtils ../../support/PropertiesPool ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/GridLocalOriginFactory ../../webgl-engine/lib/WebGLLayer ../../../support/Scheduler ../../../../geometry/Extent ../../../../geometry/Point ../../../../symbols/LabelSymbol3D ../../../../symbols/TextSymbol ../../../../symbols/WebStyleSymbol".split(" "),
function(k,x,l,Ia,Ja,Ka,La,Ma,Na,Oa,Pa,S,Qa,Ra,aa,ba,G,ca,da,ea,T,e,U,D,y,fa,m,Sa,Ta,ha,O,H,J,E,I,ia,ja,ka,K,P,V,la,ma,W,na,z,L,oa,pa,qa,ra,sa,ta,ua,X,va,wa,Y,xa,ya,za,v,Aa,Ba,M,Ca,Da,Z,Ea,Fa){var Q;const R=J.create(),q=I.create(),u=ea.getLogger("esri.views.3d.layers.graphics.Graphics3DCore");k.Graphics3DCore=Q=function(w){function N(b){var a=w.call(this,b)||this;a._propertiesPool=new za.PropertiesPool({computedExtent:Ca},x._assertThisInitialized(a));a.computedExtent=null;a.currentRenderer=null;a.rendererHasGeometryOperations=
!1;a._graphicStateTracking=null;a.symbolCreationContext=new qa.Graphics3DSymbolCreationContext((c,d)=>a._frameTask.schedule(c,d));a.graphics3DGraphics=new Map;a.stageLayer=null;a.stage=null;a._graphicsDrapedUids=new Set;a._graphicsBySymbol=new Map;a._symbolConversionCache=new Map;a._symbols=new Map;a._graphicsWithoutSymbol=new Map;a._graphicsWaitingForSymbol=new Map;a._graphicsUpdateId=0;a._handles=new ca;a._frameTask=M.ImmediateTask;a._suspendSymbolCleanup=!1;a._viewSpatialReference=null;a._arcadeOnDemand=
null;a._rendererChangeAbortController=null;a._elevationInfoChangeAbortController=null;a._initializeAbortController=null;a._scaleVisibility=null;a._filterVisibility=null;a._spatialIndex=null;a.extentPadding=0;a._updatingPendingLoadedGraphicsChange=null;a._featureStore=null;a._deconflictor=null;a._labeler=null;a._objectStates=null;a._viewElevationProvider=null;a._stageLayerElevationProvider=null;a._sharedSymbolResourcesOwnerHandle=null;a._whenGraphics3DGraphicRequests={};a._pendingUpdates=new Map;a._numberOfGraphics=
0;a._numberOfGraphicsProvidingElevation=0;a._pendingAdds=0;a._pendingRemoves=0;a._loadingSymbols=0;a._pendingUpdatesPool=new U({allocator:c=>c||new Ga,deallocator:c=>{c.clear();return c}});a._symbolWarningLogged=!1;a._geometryWarningLogged=!1;a._objectIdInvisibleSet=new Set;a._whenSymbolRemoved=new U;a.preferredUpdatePolicy=v.UpdatePolicy.SYNC;a.forcedUpdatePolicy=null;a.elevationFeatureExpressionEnabled=!0;a.owner=null;a.layer=null;a.graphicSymbolSupported=!0;a.getRenderingInfoWithoutRenderer=!1;
a.setUidToIdOnAdd=!0;a.hasZ=null;a.hasM=null;a._usedMemory=0;a._visible=void 0;a._startCreateGraphics=!1;return a}x._inheritsLoose(N,w);var f=N.prototype;f._getConvertedSymbol=function(b){if("web-style"===b.type)return b.clone();var a=this._symbolConversionCache.get(b.id);if(e.isSome(a))return a;a=W.to3D(b,{geometryType:this.layer?.geometryType,retainId:!0,hasLabelingContext:this._hasLabelingContext(b)});const c=a.symbol||null;e.isNone(c)&&a.error&&u.error(a.error.message);this._symbolConversionCache.set(b.id,
c);return c};f._getSymbolComplexitiesUsedOrRenderer=function(b){if(e.isNone(b))return[];var a=b.getSymbols(),c="backgroundFillSymbol"in b&&b.backgroundFillSymbol;if(!(c||a&&a.length))return[];b=[];c=this._getSymbolComplexityUsedOrRenderer(c);e.isSome(c)&&b.push(c);for(const d of a)a=this._getSymbolComplexityUsedOrRenderer(d),e.isSome(a)&&b.push(a);return b};f._getSymbolComplexityUsedOrRenderer=function(b){if(e.isNone(b))return null;const a=this._symbols.get(b.id);if(e.isSome(a))return a.complexity;
b=this._getConvertedSymbol(b);return e.isSome(b)?Y.defaultSymbolComplexity(b):null};f._getSymbolComplexitiesUsed=function(){const b=[];this._symbols.forEach(a=>{e.isSome(a)&&b.push(a.complexity)});return b};f.initialize=function(){this._viewSpatialReference=this.owner.view.spatialReference;this._featureStore=new oa.Graphics3DFeatureStore({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,hasZ:this.hasZ,hasM:this.hasM,viewSpatialReference:this._viewSpatialReference,featureSpatialReference:this.owner.featureSpatialReference,
getSpatialIndex:()=>this.spatialIndex,forEach:c=>this.graphics3DGraphics.forEach(c),toArray:()=>Array.from(this.graphics3DGraphics.values())});const b=(c,d,g)=>this.spatialIndex.queryGraphicUIDsInExtent(c,d,g),{componentFactories:a}=this;e.isSome(a.elevationAlignment)&&(this._elevationAlignment=a.elevationAlignment(this,b));e.isSome(a.scaleVisibility)&&(this._scaleVisibility=a.scaleVisibility(this,b));e.isSome(a.filterVisibility)&&(this._filterVisibility=a.filterVisibility({featureStore:this._featureStore,
getFeatureCount:()=>this.graphics3DGraphics.size,updateFeatureVisibilities:c=>this.modifyGraphics3DGraphicVisibilities(d=>d.setVisibilityFlag(z.VisibilityFlag.FILTER,c(K.getObjectId(d.graphic,this._objectIdField)),z.VisibilityGroup.GRAPHIC)),setAllFeaturesVisibility:c=>this.modifyGraphics3DGraphicVisibilities(d=>d.setVisibilityFlag(z.VisibilityFlag.FILTER,c,z.VisibilityGroup.GRAPHIC)),clearFeaturesVisibility:()=>this.modifyGraphics3DGraphicVisibilities(c=>c.clearVisibilityFlag(z.VisibilityFlag.FILTER))}));
e.isSome(a.deconflictor)&&(this._deconflictor=a.deconflictor(this));e.isSome(a.labeler)&&e.isSome(this._scaleVisibility)&&(this._labeler=a.labeler(this,this._scaleVisibility));e.isSome(a.objectStates)&&(this._objectStates=a.objectStates(this));this._initializeAbortController=new AbortController;this._initializePromise=this._initializeAsync()};f._initializeAsync=function(){var b=x._asyncToGenerator(function*(){const a=this._initializeAbortController.signal,c=this.owner.view;this._viewElevationProvider=
new na.ViewElevationProvider(this._viewSpatialReference,c);this._initializeStage(c,this.layer.uid);this.symbolCreationContext.sharedResources=c.sharedSymbolResources;this._sharedSymbolResourcesOwnerHandle=c.sharedSymbolResources.addGraphicsOwner(this.owner);e.isSome(this.currentRenderer)&&(this.symbolCreationContext.renderer=this.currentRenderer);this.symbolCreationContext.stage=this.stage;this.symbolCreationContext.streamDataRequester=c.sharedSymbolResources.streamDataRequester;this.symbolCreationContext.renderCoordsHelper=
c.renderCoordsHelper;this.symbolCreationContext.layer=this.layer;this.symbolCreationContext.graphicsCoreOwner=this.owner;this.symbolCreationContext.localOriginFactory=new Aa.GridLocalOriginFactory(c.renderSpatialReference);this.symbolCreationContext.elevationProvider=c.elevationProvider;this.symbolCreationContext.notifyGraphicGeometryChanged=g=>this.notifyGraphicGeometryChanged(g);this.symbolCreationContext.notifyGraphicVisibilityChanged=g=>this.notifyGraphicVisibilityChanged(g);const d=L.extractExpressionInfo(this.layer.elevationInfo,
this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=yield L.createContext(d,this._viewSpatialReference,a,u);D.throwIfAborted(a);this.symbolCreationContext.screenSizePerspectiveEnabled=c.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled;this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled;this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled;this.symbolCreationContext.skipHighSymbolLods=
!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods;if("drapeSourceType"in this.owner){const {owner:g}=this;this.symbolCreationContext.drapeSourceRenderer=c.basemapTerrain.overlayManager.registerGeometryDrapeSource(g);this._handles.add(da.makeHandle(()=>c.basemapTerrain.overlayManager.unregisterDrapeSource(g)))}this._handles.add([y.watch(()=>this.suspendedOrOutsideOfView,()=>this._frameTask.reschedule(()=>this._updateLayerVisibility())),y.watch(()=>[this.layer?.screenSizePerspectiveEnabled,
this.owner.view.screenSizePerspectiveEnabled],()=>{const g=c.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled;g!==this.symbolCreationContext.screenSizePerspectiveEnabled&&(this.symbolCreationContext.screenSizePerspectiveEnabled=g,this._labeler?.reset(),this.recreateAllGraphicsAndSymbols())}),y.watch(()=>this.owner.slicePlaneEnabled,g=>this._slicePlaneEnabledChange(!!g)),y.watch(()=>this.owner.view.state?.pixelRatio,()=>this._pixelRatioChange()),y.watch(()=>!!this.owner.view.qualitySettings?.physicallyBasedRenderingEnabled,
g=>this._physicalBasedRenderingChange(g)),y.watch(()=>!!this.owner.view.qualitySettings?.graphics3D?.skipHighSymbolLods,g=>this._skipHighSymbolLoDsChange(g)),y.when(()=>c.basemapTerrain?.tilingScheme,g=>{!g.spatialReference.equals(this.symbolCreationContext.overlaySR)&&e.isSome(c.basemapTerrain.spatialReference)&&(this.symbolCreationContext.overlaySR=c.basemapTerrain.spatialReference);this._handles.has("loaded-graphics")?this.recreateAllGraphics():this._handles.add([y.on(()=>this.owner?.loadedGraphics,
"change",h=>{this._graphicsCollectionChanged(h);this._signalUpdatingDuringAsyncLoadedGraphicsChange()},{onListenerAdd:()=>{this.recreateAllGraphics();this._signalUpdatingDuringAsyncLoadedGraphicsChange()}})],"loaded-graphics")},{initial:!0}),y.watch(()=>this.effectiveUpdatePolicy,g=>{e.isSome(this.stageLayer)&&(this.stageLayer.updatePolicy=g);this.symbolCreationContext.isAsync=this.effectiveUpdatePolicy===v.UpdatePolicy.ASYNC;g===v.UpdatePolicy.SYNC&&this.runTask(M.noBudget)},y.syncAndInitial)]);
this._frameTask=c.resourceController.scheduler.registerTask(M.TaskPriority.GRAPHICS_CORE,this);this.layer&&"featureReduction"in this.layer&&this._handles.add(y.watch(()=>this.layer.featureReduction,()=>this._deconflictor.featureReductionChange()));this.notifyChange("averageSymbolComplexity");this.rendererChange(this.owner.renderer).catch(()=>{});this._initializeAbortController=null});return function(){return b.apply(this,arguments)}}();f._abortInitialize=function(){this._initializeAbortController&&
(this._initializeAbortController.abort(),this._initializeAbortController=null)};f.destroy=function(){this._abortInitialize();this._abortRendererChange();this._abortElevationInfoChange();this.owner.view.deconflictor.removeGraphicsOwner(this);this.owner.view.labeler.removeGraphicsOwner(this);this._elevationAlignment=e.destroyMaybe(this._elevationAlignment);this._scaleVisibility=e.destroyMaybe(this._scaleVisibility);this._filterVisibility=e.destroyMaybe(this._filterVisibility);this._labeler=this._deconflictor=
null;this._objectStates=e.destroyMaybe(this._objectStates);this.clear();this._featureStore=e.destroyMaybe(this._featureStore);this._updatingPendingLoadedGraphicsChange=e.removeMaybe(this._updatingPendingLoadedGraphicsChange);this._graphicStateTracking=e.destroyMaybe(this._graphicStateTracking);this.stage&&(this.stage.remove(this.stageLayer),this.stage=this.stageLayer=null);this._handles=e.destroyMaybe(this._handles);this._frameTask.remove();this._frameTask=M.ImmediateTask;this._viewSpatialReference=
null;this._set("owner",null);for(const b in this._whenGraphics3DGraphicRequests)this._whenGraphics3DGraphicRequests[b].reject(new G("graphic:layer-destroyed","Layer has been destroyed"));this._whenGraphics3DGraphicRequests=null;this._sharedSymbolResourcesOwnerHandle=e.removeMaybe(this._sharedSymbolResourcesOwnerHandle);this._propertiesPool=e.destroyMaybe(this._propertiesPool);this._pendingUpdatesPool=null;this._symbolConversionCache.clear();this._objectIdInvisibleSet.clear();this._spatialIndex=e.destroyMaybe(this._spatialIndex)};
f.clear=function(){this._objectStates?.allGraphicsDeleted();e.isSome(this._graphicStateTracking)&&this._graphicStateTracking.allGraphicsDeleted();this.graphics3DGraphics.forEach(b=>b.destroy());this._spatialIndex?.clear();this.graphics3DGraphics.clear();this._usedMemory=this._numberOfGraphics=0;this._updateLayerVisibility();this._symbols.forEach(e.destroyMaybe);this._symbols.clear();this._graphicsBySymbol.clear();this._graphicsWithoutSymbol.clear();this._graphicsWaitingForSymbol.clear();this._pendingUpdates.clear();
this._pendingUpdatesPool.clear();this._pendingRemoves=this._pendingAdds=0;this.notifyChange("updating");this.notifyChange("running");this.notifyChange("updatingRemaining");this._featureStore.events.emit("changed")};f._initializeStage=function(b,a){this.stage=b._stage;this.stageLayer=new Ba.WebGLLayer({isPickable:!this.suspendedOrOutsideOfView,updatePolicy:this.effectiveUpdatePolicy},a);this.stage.add(this.stageLayer);b=this.stageLayer.events;b.on("objectTransformation",c=>this.notifyGraphicGeometryChanged(c.metadata.graphicUid));
b.on("visibilityChanged",c=>this.notifyGraphicVisibilityChanged(c.metadata.graphicUid));b.on("objectGeometryAdded",c=>this.notifyGraphicGeometryChanged(c.object.metadata.graphicUid));b.on("objectGeometryRemoved",c=>this.notifyGraphicGeometryChanged(c.object.metadata.graphicUid));b.on("vertexAttrsUpdated",c=>this.notifyGraphicGeometryChanged(c.object.metadata.graphicUid))};f.notifyGraphicGeometryChanged=function(b){e.isNone(this._graphicStateTracking)||e.isNone(b)||(b=this.graphics3DGraphics.get(b))&&
this._graphicStateTracking.updateGraphicGeometry(b)};f.notifyGraphicVisibilityChanged=function(b){e.isNone(this._graphicStateTracking)||e.isNone(b)||(b=this.graphics3DGraphics.get(b))&&this._graphicStateTracking.updateGraphicVisibility(b)};f._updateLayerVisibility=function(){var b=this._numberOfGraphics>10*this.displayFeatureLimit.maximumNumberOfFeatures;b=!this.suspendedOrOutsideOfView&&!b;b!==this._visible&&((this._visible=b)?(this.stageLayer.isPickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.isPickable=
!1,this._hideAllGraphics()),this._updateStageLayerVisibility())};f._updateStageLayerVisibility=function(){this.stageLayer.isVisible=this._visible&&(null==this.layer.opacity||0<this.layer.opacity)};f.getGraphics3DGraphicById=function(b){return this.graphics3DGraphics.get(b)};f.getGraphics3DGraphicByObjectId=function(b){return this.owner.layer?.objectIdField?this._findGraphics3DGraphicByObjectId(b):null};f._getGraphicObjectID=function(b,a=this.owner.layer&&this.owner.layer.objectIdField){return K.getObjectId(b,
a)};f.updateLabelingInfo=function(){var b=x._asyncToGenerator(function*(a){const c=this._deconflictor&&this._deconflictor.labelingInfoChange(a);a=this._labeler&&this._labeler.labelingInfoChange(a);yield D.eachAlways([c,a])});return function(a){return b.apply(this,arguments)}}();f.updateVisibilityInfo=function(){this._deconflictor&&this._deconflictor.labelingInfoChange();this._labeler&&this._labeler.visibilityInfoChange()};f.runTask=function(b){this._frameTask.processQueue(b);this._applyPendingUpdates(b);
this.notifyChange("running");this.running||this.notifyChange("updating");this.notifyChange("updatingRemaining")};f.setObjectIdVisibility=function(b,a){a?this._objectIdInvisibleSet.delete(b):this._objectIdInvisibleSet.add(b);b=this._findGraphics3DGraphicByObjectId(b);e.isSome(b)&&this._updateUserVisibility(b)};f._findGraphics3DGraphicByObjectId=function(b){return T.findInMap(this.graphics3DGraphics,a=>this._getGraphicObjectID(a.graphic)===b)};f._updateUserVisibility=function(b){if(e.isNone(b))return!1;
var a=b.graphic;const c=this._getGraphicObjectID(a);a=a.visible&&!this.owner.suspended&&(e.isNone(c)||!this._objectIdInvisibleSet.has(c));return b.setVisibilityFlag(z.VisibilityFlag.USER_SETTING,a,z.VisibilityGroup.GRAPHIC)};f._whenGraphics3DGraphic=function(b){var a=this.graphics3DGraphics.get(b.uid);if(a)return Promise.resolve(a);if(a=this._whenGraphics3DGraphicRequests[b.uid])return a.promise;a=D.createDeferred();this._whenGraphics3DGraphicRequests[b.uid]=a;return a.promise};f._boundsForGraphics3DGraphic=
function(){var b=x._asyncToGenerator(function*(a,c){const d=this._viewSpatialReference,g=this.owner.view.renderSpatialReference,h=this.owner.view.basemapTerrain.spatialReference;var p=this._viewElevationProvider?{service:this._viewElevationProvider,useViewElevation:e.isSome(c)&&c.useViewElevation,minDemResolution:e.isSome(c)&&c.minDemResolution,minDemResolutionForPoints:this.owner.view.resolution}:null;a=yield a.getProjectedBoundingBox((n,r,A)=>E.projectBuffer(n,g,r,n,d,r,A),(n,r,A)=>E.projectBuffer(n,
h,r,n,d,r,A),p,e.get(c,"signal"));if(!a)return null;c=a.boundingBox;a.requiresDrapedElevation&&(p=this.symbolCreationContext.elevationProvider)&&(I.center(c,R),p=e.unwrapOr(p.getElevation(R[0],R[1],0,d,"ground"),0),c[2]=Math.min(c[2],p),c[5]=Math.max(c[5],p));return{boundingBox:c,screenSpaceObjects:a.screenSpaceObjects}});return function(a,c){return b.apply(this,arguments)}}();f.whenGraphicBounds=function(){var b=x._asyncToGenerator(function*(a,c){yield y.whenOnce(()=>this.owner?.loadedGraphics);
const d=this.owner.layer&&this.owner.layer.objectIdField;var g=this.owner.loadedGraphics.find(h=>h===a?!0:d&&h.attributes&&a.attributes&&h.attributes[d]===a.attributes[d]);if(!g)throw new G("internal:graphic-not-part-of-view","Graphic is not part of this view");g=yield this._whenGraphics3DGraphic(g);return this._boundsForGraphics3DGraphic(g,c)});return function(a,c){return b.apply(this,arguments)}}();f.computeAttachmentOrigin=function(b,a){b=this.graphics3DGraphics.get(b.uid);if(!b)return null;var c=
b.computeAttachmentOrigin();if(0===c.render.num&&0===c.draped.num)return null;H.set(B,0,0,0);b=0;if(0<c.render.num){if(!E.projectVectorToVector(c.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,F,a))return null;H.add(B,B,F);b++}if(0<c.draped.num){const [d,g]=c.draped.origin;c=e.unwrapOr(this._viewElevationProvider.getElevation(d,g,"ground"),0);H.set(F,d,g,c);if(!E.projectVectorToVector(F,this._viewElevationProvider.spatialReference,F,a))return null;H.add(B,B,F);b++}1<
b&&H.scale(B,B,1/b);return new Da({x:B[0],y:B[1],z:B[2],spatialReference:a})};f.getSymbolLayerSize=function(b,a){var c=this._symbols.get(b.id);if(e.isNone(c))throw new G("internal:symbol-not-part-of-view","Symbol is not part of this view");b=b.symbolLayers.indexOf(a);if(-1===b)throw new G("internal:missing-symbol-layer","Symbol layer is not in symbol");c=c.getSymbolLayerSize(b);if(null==c)throw new G("internal:missing-size","Symbol layer has no valid size");return c};f._graphicsCollectionChanged=
function(b){this._startCreateGraphics&&(this.add(b.added),this.remove(b.removed))};f.graphicUpdateHandler=function(b){const a=b.graphic.uid,c=this.graphics3DGraphics.get(a);if(!e.isNone(c)||!e.isNone(this._graphicsWithoutSymbol.get(a)))switch(b.property){case "visible":this._graphicUpdateVisibleHandler(c);break;case "geometry":this._graphicUpdateGeometryHandler(c,b);break;case "symbol":this._graphicUpdateSymbolHandler(c,b);break;case "transform":this._graphicUpdateTransformHandler(c,b)}};f._graphicUpdateGeometryHandler=
function(b,a){const c=a.graphic.geometry;if(e.isNone(c))this._recreateGraphic(a.graphic);else if(e.isNone(b)){if(b=a.graphic.symbol&&a.graphic.symbol.id)if(b=this._symbols.get(b),e.isSome(b)&&b.loadStatus===va.LoadStatus.LOADING)return;this._recreateGraphic(a.graphic)}else{var d=b.graphics3DSymbol;!e.isNone(a.newValue)&&d.updateGeometry(b,a.newValue)||this._recreateGraphic(b.graphic);this._expandComputedExtent(c)}};f._graphicUpdateSymbolHandler=function(b,a){var c=a.graphic;const d=e.isSome(b)?b.graphics3DSymbol:
e.isSome(a.oldValue)?this._symbols.get(a.oldValue.id):null;if(e.isNone(d)||e.isNone(a.newValue))this._recreateGraphic(c);else{var g=d.symbol;a=this._getConvertedSymbol(a.newValue);if(e.isSome(a)&&(a.type!==g.type||"web-style"===a.type)||"web-style"===g.type)this._recreateGraphic(c);else{var h=this._graphicsBySymbol.get(g.id);if(h&&1!==h.size)this._recreateGraphic(c);else if(h=O.diff(g,a),e.isNone(h))this._updateSymbolMapping(g.id,a);else if(h={diff:h,graphics3DGraphicPatches:[],symbolStatePatches:[]},
d.prepareSymbolPatch(h),O.isEmpty(h.diff)){var p=this._getRenderingInfo(c);if(e.isNone(p))this._recreateGraphic(c);else{c=d.extentPadding;for(const n of h.symbolStatePatches)n();c!==d.extentPadding&&this._recomputeExtentPadding();if(e.isSome(b))for(const n of h.graphics3DGraphicPatches)n(b,p);this._updateSymbolMapping(g.id,a)}}else this._recreateGraphic(c)}}};f._graphicUpdateVisibleHandler=function(b){this._updateUserVisibility(b)&&(this._labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())};
f._graphicUpdateTransformHandler=function(b,a){};f.recreateGraphics=function(b){this._suspendSymbolCleanup=!0;this.remove(b);this.add(b);this._suspendSymbolCleanup=!1;this.effectiveUpdatePolicy===v.UpdatePolicy.SYNC&&this._cleanupSymbols()};f._recreateGraphic=function(b){this.recreateGraphics([b])};f._beginGraphicUpdate=function(b){const a=this._graphicsUpdateId;this._graphicsUpdateId++;this._graphicsWaitingForSymbol.set(b.uid,a);1===this._graphicsWaitingForSymbol.size&&this.notifyChange("updating");
return a};f._endGraphicUpdate=function(b){b&&(this._graphicsWaitingForSymbol.delete(b.uid),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating")))};f._recomputeExtentPadding=function(){let b=0;this._symbols.forEach(a=>{e.isSome(a)&&(b=Math.max(b,a.extentPadding))});this._set("extentPadding",b)};f._expandComputedExtent=function(b){var a=b.spatialReference;K.computeAABB(b,q);b=this._viewSpatialReference;var c=Q.tmpVec;!ja.equals(a,b)&&E.projectXYZToVector(q[0],
q[1],0,a,c,b)&&(q[0]=c[0],q[1]=c[1],E.projectXYZToVector(q[3],q[4],0,a,c,b),q[3]=c[0],q[4]=c[1]);if(isFinite(q[0])&&isFinite(q[3])&&isFinite(q[1])&&isFinite(q[4])){a=this.computedExtent;c=null;var d=isFinite(q[2])&&isFinite(q[5]),g=d&&(!a||null==a.zmin||q[2]<a.zmin);d=d&&(!a||null==a.zmax||q[5]>a.zmax);if(a){if(q[0]<a.xmin||q[1]<a.ymin||q[3]>a.xmax||q[4]>a.ymax||g||d)c=this._propertiesPool.get("computedExtent"),c.xmin=Math.min(q[0],a.xmin),c.ymin=Math.min(q[1],a.ymin),c.xmax=Math.max(q[3],a.xmax),
c.ymax=Math.max(q[4],a.ymax),c.spatialReference=b}else c=this._propertiesPool.get("computedExtent"),c.xmin=q[0],c.ymin=q[1],c.xmax=q[3],c.ymax=q[4],c.spatialReference=b;c&&(g&&(c.zmin=q[2]),d&&(c.zmax=q[5]),this._set("computedExtent",c))}};f._abortElevationInfoChange=function(){this._elevationInfoChangeAbortController&&(this._elevationInfoChangeAbortController.abort(),this._elevationInfoChangeAbortController=null)};f.elevationInfoChange=function(){var b=x._asyncToGenerator(function*(){this._abortElevationInfoChange();
const a=new AbortController;this._elevationInfoChangeAbortController=a;const c=L.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled);this.symbolCreationContext.featureExpressionInfoContext=yield L.createContext(c,this._viewSpatialReference,a.signal,u);D.throwIfAborted(a.signal);this._elevationInfoChangeAbortController=null;this._labeler?.elevationInfoChange();this.forEachGraphics3DSymbol((d,g,h)=>{d.globalPropertyChanged("elevationInfo",g)?g.forEach(p=>{const n=
p.graphic;p=p.labelGraphics;for(const r of p)r.graphics3DSymbolLayer.updateGraphicElevationContext(n,r)}):this._recreateSymbol(h)});this.updateStageLayerElevationProvider();this._elevationAlignment?.elevationInfoChange()});return function(){return b.apply(this,arguments)}}();f.updateStageLayerElevationProvider=function(){if(this._stageLayerElevationProvider){if(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this._numberOfGraphicsProvidingElevation)this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),
this._stageLayerElevationProvider.dispose(),this._stageLayerElevationProvider=null}else(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==this.layer.elevationInfo.mode)&&0<this._numberOfGraphicsProvidingElevation&&(this._stageLayerElevationProvider=new xa.StageLayerElevationProvider({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this._stageLayerElevationProvider))};f._clearSymbolsAndGraphics=function(){this.clear();
e.isSome(this._filterVisibility)&&this._filterVisibility.clear();this._labeler?.reset();this._deconflictor?.clear();this._elevationAlignment?.clear();this.stageLayer?.invalidateSpatialQueryAccelerator();this._stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this._stageLayerElevationProvider),this._stageLayerElevationProvider.dispose(),this._stageLayerElevationProvider=null)};f.startCreateGraphics=function(){this._startCreateGraphics=!0;this.recreateAllGraphics()};f.recreateAllGraphics=
function(){this._recreateAllGraphics(!1)};f.recreateAllGraphicsAndSymbols=function(){this._recreateAllGraphics(!0)};f._recreateAllGraphics=function(b=!1){if(this._startCreateGraphics){var {loadedGraphics:a,view:c}=this.owner,d=c.basemapTerrain.tilingScheme&&a&&a.length?a.toArray():null;!b&&d||this._clearSymbolsAndGraphics();this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled;this.symbolCreationContext.slicePlaneEnabled=
!!this.owner.slicePlaneEnabled;this._set("computedExtent",null);d&&(b?this.add(d):this.recreateGraphics(d))}};f._recreateSymbol=function(b){var a=this._graphicsBySymbol.get(b);const c=[];a&&(a.forEach((d,g)=>{const h=d.usedMemory;this._conditionalRemove(d,g);this._spatialIndex?.remove(d);c.push(d.graphic);d.destroy();this._removeGraphics3DGraphic(g,h);this._updateLayerVisibility();this._featureStore.events.emit("changed")}),this._graphicsBySymbol.set(b,new Map));a=this._symbols.get(b);e.destroyMaybe(a);
this._symbols.delete(b);this.add(c)};f._recreateGraphicsForSymbol=function(b){if(b=this._graphicsBySymbol.get(b)){const a=[];b.forEach(c=>a.push(c.graphic));this.recreateGraphics(a)}};f._conditionalRemove=function(b,a){this._graphicsDrapedUids.delete(a);this._objectStates?.removeGraphic(b);this._labeler?.removeGraphic(b);this._deconflictor?.removeGraphic(b);e.isSome(this._graphicStateTracking)&&this._graphicStateTracking.removeGraphic(b)};f.add=function(b){b&&0!==b.length&&(this.owner.view.basemapTerrain&&
this.owner.view.basemapTerrain.tilingScheme?(this._updatePolicyForGraphics(b)===v.UpdatePolicy.ASYNC?this._addDelayed(b):this._addImmediate(b),this.notifyChange("updating")):u.error("#add()","Cannot add graphics before terrain surface has been initialized"))};f._updatePolicyForGraphics=function(b){if(this.effectiveUpdatePolicy===v.UpdatePolicy.SYNC&&("mesh"===this.layer.geometryType||null==this.layer.geometryType))for(const a of b)if(e.isSome(a.geometry)&&"mesh"===a.geometry.type&&!a.geometry.loaded)return v.UpdatePolicy.ASYNC;
return this.effectiveUpdatePolicy};f._addImmediate=function(b){this._symbolWarningLogged=this._geometryWarningLogged=!1;for(const a of b)this._addGraphic(a,this._getRenderingInfo(a,u),v.UpdatePolicy.SYNC);this._cleanupSymbols();this._labeler&&(this.owner.view.labeler.setDirty(),this._cleanupSymbols());this.owner.view.deconflictor.setDirty()};f._addDelayed=function(b){for(const a of b){b=a.uid;let c=this._pendingUpdates.get(b);c?c.add?c.state!==t.NEW&&c.abortController.abort():this._pendingAdds++:
(c=this._pendingUpdatesPool.pushNew(),this._pendingAdds++,this._pendingUpdates.set(b,c));c.add=a}this.notifyChange("running");this.notifyChange("updatingRemaining")};f.remove=function(b){this.effectiveUpdatePolicy===v.UpdatePolicy.ASYNC?this._removeDelayed(b):this._removeImmediate(b);this.notifyChange("updating")};f._removeImmediate=function(b){for(const a of b)this._removeGraphic(a);this._cleanupSymbols();this._labeler&&this.owner.view.labeler.setDirty();this.owner.view.deconflictor.setDirty()};
f._removeDelayed=function(b){for(const c of b){b=c.uid;var a=this._pendingUpdates.get(b);a?a.add&&(a.remove?a.add=null:this._pendingUpdates.delete(b),a.state===t.LOADING&&a.abortController.abort(),this._pendingAdds--):(a=this._pendingUpdatesPool.pushNew(),a.remove=c,this._pendingUpdates.set(b,a),this._pendingRemoves++)}0===this._pendingUpdates.size&&this._finishPendingUpdates();this.notifyChange("running");this.notifyChange("updatingRemaining")};f._finishPendingUpdates=function(){this._pendingUpdatesPool.clear();
this._cleanupSymbols();(this._pendingAdds||this._pendingRemoves)&&u.warn("pendingAdds/Removes in inconsistent state!");this._pendingRemoves=this._pendingAdds=0};f._applyPendingUpdates=function(b){this._symbolWarningLogged=this._geometryWarningLogged=!1;if(0===this._pendingUpdates.size&&this._spatialIndex?.updating)this._spatialIndex.update();else{for(const [a,c]of this._pendingUpdates){if(b.done)break;c.add&&c.state===t.NEW&&this._processPendingUpdateNew(c);let d=this.effectiveUpdatePolicy;!c.remove||
c.add&&c.state!==t.READY||(this._pendingRemoves--,b.madeProgress(),this._removeGraphic(c.remove),c.remove=null,d=v.UpdatePolicy.SYNC);if(c.add)switch(c.state){case t.READY:this._addGraphic(c.add,c.renderingInfo,d);c.add=null;this._pendingAdds--;b.madeProgress();break;case t.REJECTED:c.add=null,this._pendingAdds--}null==c.remove&&null==c.add&&this._pendingUpdates.delete(a)}0===this._pendingUpdates.size&&(this._finishPendingUpdates(),this.notifyChange("running"))}};f._processPendingUpdateNew=function(b){if(b.add){var a=
b.add.geometry;e.isSome(a)&&"mesh"===a.type&&!a.loaded?this._processPendingUpdateNewMesh(b,a):this._processPendingUpdateNewRenderingInfo(b)}else b.state=t.READY};f._processPendingUpdateNewMesh=function(){var b=x._asyncToGenerator(function*(a,c){a.state=t.LOADING;a.abortController=new AbortController;const d=a.abortController.signal;try{yield c.load({signal:d})}catch(g){return this._processPendingUpdateNewError(a,g)}a.abortController=null;this._processPendingUpdateNewRenderingInfo(a)});return function(a,
c){return b.apply(this,arguments)}}();f._processPendingUpdateNewError=function(b,a){b.abortController=null;D.isAbortError(a)?b.state=t.NEW:b.state=t.REJECTED};f._processPendingUpdateNewRenderingInfo=function(){var b=x._asyncToGenerator(function*(a){if(e.isNone(this.layer.renderer)||"dictionary"!==this.layer.renderer.type)a.renderingInfo=this._getRenderingInfo(a.add,u);else{a.state=t.LOADING;a.abortController=new AbortController;var c=null;try{c=yield this._getRenderingInfoAsync(a.add,{signal:a.abortController.signal})}catch(d){a.abortController=
null;D.isAbortError(d)?a.state=t.NEW:a.state=t.REJECTED;return}e.isNone(c)||e.isNone(c.symbol)?(u&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,u.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),a.renderingInfo=null):a.renderingInfo=c}a.state=t.READY});return function(a){return b.apply(this,arguments)}}();f._addGraphic=function(b,a,c){this._graphicsWithoutSymbol.set(b.uid,b);if(!e.isNone(a)&&!e.isNone(a.symbol)&&K.hasGeometry(b)){ba("enable-feature:objectAndLayerId-rendering")&&
this.setUidToIdOnAdd&&this.stage.renderView._objectAndLayerIdRenderHelper.setUidToObjectAndLayerId(b.objectId,b.uid,this.layer.id,this.layer.uid,this.layer.popupEnabled);var d=this.getOrCreateGraphics3DSymbol(a.symbol,a.renderer);if(!e.isNone(d)){this._expandComputedExtent(b.geometry);var g=this._beginGraphicUpdate(b),h=new pa(b,a,this.layer),p=!1,n=C=>{C===d.symbol.id&&(p=!0)};this._whenSymbolRemoved.push(n);var r=()=>{--this._loadingSymbols;if(!this.destroyed){this._whenSymbolRemoved.removeUnordered(n);
if(this._graphicsWaitingForSymbol.get(b.uid)!==g||p||d.destroyed||this.graphicSymbolSupported&&b.symbol&&b.symbol.id!==d.symbol.id)--d.referenced,this._cleanupSymbols();else{const C=this._createGraphics3DGraphic(d,h);this._spatialIndex&&e.isSome(C)&&this._spatialIndex.add(C);--d.referenced;this._endGraphicUpdate(b)}this._featureStore.events.emit("changed");this._labeler&&this.owner.view.labeler.setDirty()}},A=C=>{--this._loadingSymbols;this.destroyed||(this._whenSymbolRemoved.removeUnordered(n),p||
(D.isAbortError(C)?this.add([b]):d.destroyed||this._endGraphicUpdate(b)))};++this._loadingSymbols;c===v.UpdatePolicy.ASYNC?d.load(()=>this._frameTask.schedule(r),C=>this._frameTask.schedule(()=>A(C))):d.load(r,A)}}};f._removeGraphic=function(b){b=b.uid;const a=this.graphics3DGraphics.get(b);if(a){a.graphics3DSymbol.onRemoveGraphic(a);const c=a.usedMemory,d=a.isElevationSource;this._conditionalRemove(a,b);this._spatialIndex?.remove(a);this._graphicsBySymbol.get(a.graphics3DSymbol.symbol.id).delete(b);
this._graphicsWithoutSymbol.delete(b);this._removeGraphics3DGraphic(b,c,d);a.destroy();this._featureStore.events.emit("changed")}else this._graphicsWithoutSymbol.delete(b),this._graphicsWaitingForSymbol.delete(b),0===this._graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating"))};f._hasLabelingContext=function(b){if(b instanceof Z||b instanceof Ea){const a=this.symbolCreationContext.layer;return a.labelingInfo?a.labelingInfo.some(c=>c.symbol===b):!1}return!1};f._hasValidSymbolCreationContext=
function(b){return b instanceof Z&&!this._hasLabelingContext(b)?(u.error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1):!0};f._getRenderingInfo=function(b,a){const c=b.geometry;if(e.isNone(c))return a&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,a.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),null;if(!E.canProjectWithoutEngine(c.spatialReference,this._viewSpatialReference))return a&&
!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,a.warn(`Graphic in layer ${this.layer.id} has incompatible spatial reference and will not render`)),null;if(!this.graphicSymbolSupported&&e.isSome(b.symbol))return a&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,a.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;b=this.rendererHasGeometryOperations?P.hydrateGraphic(b,this.layer):b;b=this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||
e.isSome(this.currentRenderer))?this.owner.getRenderingInfo(b,this.currentRenderer,this._arcadeOnDemand):{symbol:b.symbol||ma.getDefaultSymbol3D(b.geometry)};return e.isNone(b)||e.isNone(b.symbol)?(a&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,a.warn(`Graphic in layer ${this.layer.id} has no symbol and will not render`)),null):b};f._getRenderingInfoAsync=function(b,a){if(e.isNone(b.geometry))return u&&!this._geometryWarningLogged&&(this._geometryWarningLogged=!0,u.warn(`Graphic in layer ${this.layer.id} has no geometry and will not render`)),
null;if(!this.graphicSymbolSupported&&e.isSome(b.symbol))return u&&!this._symbolWarningLogged&&(this._symbolWarningLogged=!0,u.warn(`Graphic in layer ${this.layer.id} is not allowed to have a symbol, use a renderer instead`)),null;b=this.rendererHasGeometryOperations?P.hydrateGraphic(b,this.layer):b;return this.owner.getRenderingInfoAsync(b,this.currentRenderer,this._arcadeOnDemand,a)};f._createGraphics3DSymbol=function(b,a){if(!this._hasValidSymbolCreationContext(b))return null;b=this._getConvertedSymbol(b);
if(!b)return null;let c;e.isSome(a)&&"backgroundFillSymbol"in a&&a.backgroundFillSymbol&&(a=W.to3D(a.backgroundFillSymbol,{ignoreDrivers:!0}),e.isSome(a.symbol)&&"web-style"!==a.symbol.type&&"cim"!==a.symbol.type&&(c=a.symbol.symbolLayers));const d=ra.make(b,this.symbolCreationContext,c);d.load(()=>{const g=d.extentPadding;g>this.extentPadding&&this._set("extentPadding",g);this.notifyChange("averageSymbolComplexity")},()=>{});return d};f.getOrCreateGraphics3DSymbol=function(b,a){let c=this._symbols.get(b.id);
void 0===c&&(c=b instanceof Fa?new sa(b,d=>this._frameTask.schedule(d),d=>this._createGraphics3DSymbol(d,a)):this._createGraphics3DSymbol(b,a),this._symbols.set(b.id,c));e.isSome(c)&&++c.referenced;return c};f.trackGraphicState=function(b){e.isNone(this._graphicStateTracking)&&(this._graphicStateTracking=new ta.GraphicStateTracking(this));return this._graphicStateTracking.add(b)};f._addGraphics3DGraphic=function(b){this._usedMemory+=b.usedMemory;this.graphics3DGraphics.set(b.graphic.uid,b);this._numberOfGraphics++;
b.isElevationSource&&(this._numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider());this._updateLayerVisibility()};f._removeGraphics3DGraphic=function(b,a,c=!1){this._usedMemory-=a;this.graphics3DGraphics.delete(b);this._numberOfGraphics--;c&&(this._numberOfGraphicsProvidingElevation--,this.updateStageLayerElevationProvider());this._updateLayerVisibility()};f._createGraphics3DGraphic=function(b,a){const c=a.graphic;this._graphicsWithoutSymbol.delete(c.uid);if(!this._symbols.has(b.symbol.id))return this.add([c]),
null;if(this.graphics3DGraphics.has(c.uid))return null;a=b.createGraphics3DGraphic(a);if(e.isNone(a))return null;this._addGraphics3DGraphic(a);b=b.symbol.id;this._graphicsBySymbol.has(b)||this._graphicsBySymbol.set(b,new Map);this._graphicsBySymbol.get(b).set(c.uid,a);a.isDraped&&this._graphicsDrapedUids.add(c.uid);a.centroid=null;e.isSome(c.geometry)&&"point"!==c.geometry.type&&(a.centroid=ua.computeCentroid(c.geometry,this._viewSpatialReference));this._updateUserVisibility(a);e.isSome(this._scaleVisibility)&&
this._scaleVisibility.updateVisibility(a);e.isSome(this._filterVisibility)&&({defaultVisibility:b}=this._filterVisibility,a.setVisibilityFlag(z.VisibilityFlag.FILTER,b,z.VisibilityGroup.GRAPHIC),b||this._filterVisibility.reapply());this._deconflictor?.addGraphic(a);this._labeler?.addGraphic(a);this._objectStates?.addGraphic(a);this._deconflictor&&this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,a);a.initialize(this.stage,this.stageLayer,this.owner);e.isSome(this._graphicStateTracking)&&
this._graphicStateTracking.addGraphic(a);if(b=this._whenGraphics3DGraphicRequests[c.uid])delete this._whenGraphics3DGraphicRequests[c.uid],b.resolve(a);return a};f._abortRendererChange=function(){this._rendererChangeAbortController&&(this._rendererChangeAbortController.abort(),this._rendererChangeAbortController=null)};f.rendererChange=function(){var b=x._asyncToGenerator(function*(a){this._abortRendererChange();if(a!==this.currentRenderer)if(this._validateRenderer(a),e.isNone(a)&&this._currentRendererChange(null,
!1),V.isSupportedRenderer3D(a))if(e.isSome(a)&&a.arcadeRequired){var c=new AbortController;this._rendererChangeAbortController=c;const {arcadeUtils:d}=yield this._ensureArcade();D.throwIfAborted(c);const g=d.hasGeometryOperations(a);g&&(yield d.enableGeometryOperations(),D.throwIfAborted(c));this.effectiveUpdatePolicy===v.UpdatePolicy.ASYNC?yield this._frameTask.schedule(()=>this._currentRendererChange(a,g),c.signal):this._currentRendererChange(a,g);this._rendererChangeAbortController=null}else this.effectiveUpdatePolicy===
v.UpdatePolicy.ASYNC?(this._rendererChangeAbortController=c=new AbortController,yield this._frameTask.schedule(()=>this._currentRendererChange(a,!1),c.signal),this._rendererChangeAbortController=null):this._currentRendererChange(a,!1);else this._currentRendererChange(a,!1)});return function(a){return b.apply(this,arguments)}}();f._ensureArcade=function(){var b=x._asyncToGenerator(function*(){e.isNone(this._arcadeOnDemand)&&(this._arcadeOnDemand=yield la.loadArcade());return this._arcadeOnDemand});
return function(){return b.apply(this,arguments)}}();f._currentRendererChange=function(b,a){this.currentRenderer=b;this.rendererHasGeometryOperations=a;this.symbolCreationContext.arcade=e.unwrap(this._arcadeOnDemand);a=this.symbolCreationContext.renderer;if(b!==a)if(this._symbolConversionCache.clear(),e.isNone(b))this.symbolCreationContext.renderer=null,this.recreateAllGraphicsAndSymbols();else{var c=O.diff(a,b);this._updateUnchangedSymbolMappings(c,b,a);this.symbolCreationContext.renderer=b;e.isNone(c)||
("complete"===c.type?this.recreateAllGraphicsAndSymbols():"partial"===c.type&&(this._applyRendererDiff(c,b,a)?this._volatileGraphicsUpdated():this.recreateAllGraphicsAndSymbols()),this.notifyChange("averageSymbolComplexity"))}};f._diffHasSymbolChange=function(b){for(const a in b.diff)switch(a){case "visualVariables":case "defaultSymbol":case "uniqueValueInfos":break;case "uniqueValueGroups":case "authoringInfo":case "fieldDelimiter":delete b.diff[a];break;default:return!0}return!1};f._applySymbolSetDiff=
function(b,a,c){b=b||[];a=a||[];const d=[];for(const g of a){const h=this._graphicsBySymbol.get(g.id);h&&h.forEach((p,n)=>{var r=p.graphic,A=this.layer instanceof ka?this.layer:null;const C=e.unwrap(this._arcadeOnDemand);if(g!==c.defaultSymbol||c.getSymbol(P.hydrateGraphic(r,A),{arcade:C})!==c.defaultSymbol)A=p.usedMemory,b.length||c.defaultSymbol?d.push(r):this._graphicsWithoutSymbol.set(n,r),r=this.graphics3DGraphics.get(n),this._conditionalRemove(r,n),p.destroy(),h.delete(n),this._removeGraphics3DGraphic(n,
A),this._updateLayerVisibility()});this._whenSymbolRemoved.forAll(p=>p(g.id))}if(b.length||d.length)this._graphicsWithoutSymbol.forEach(g=>d.push(g)),this._graphicsWithoutSymbol.clear(),this.add(d);this._cleanupSymbols();this._labeler&&this.owner.view.labeler.setDirty();this.owner.view.deconflictor.setDirty()};f._applyUniqueValueRendererDiff=function(b,a,c){const d=b.diff.defaultSymbol,g=b.diff.uniqueValueInfos;if(d||g){const h=g?g.added.map(n=>n.symbol):[],p=g?g.removed.map(n=>n.symbol):[];if(g)for(let n=
0;n<g.changed.length;n++)h.push(g.changed[n].newValue.symbol),p.push(g.changed[n].oldValue.symbol);d?(c.defaultSymbol&&p.push(c.defaultSymbol),a.defaultSymbol&&h.push(a.defaultSymbol)):c.defaultSymbol&&h.length&&p.push(a.defaultSymbol);this._applySymbolSetDiff(h,p,a);delete b.diff.defaultSymbol;delete b.diff.uniqueValueInfos;return!0}return!1};f._calculateUnchangedSymbolMapping=function(b,a,c){if("unique-value"!==a?.type||"unique-value"!==c?.type||e.isSome(b)&&"partial"!==b.type)return[];const d=
h=>e.isSome(h)?h.id:null;var g=b&&b.diff;b=g&&g.defaultSymbol;if(g=g&&g.uniqueValueInfos)g=g.unchanged.map(h=>({oldId:d(h.oldValue.symbol),newId:d(h.newValue.symbol)}));else{g=[];for(const h of c.uniqueValueInfos){const p=d(h.symbol),n=a.uniqueValueInfos.find(r=>r.value===h.value);n&&p!==d(n.symbol)&&g.push({oldId:p,newId:d(n.symbol)})}}!b&&c.defaultSymbol&&g.push({oldId:d(c.defaultSymbol),newId:d(a.defaultSymbol)});return g};f._updateSymbolMapping=function(b,a){const c=e.isSome(a)&&a?"string"===
typeof a?a:a.id:null;if(b&&b!==c){var d=this._graphicsBySymbol.get(b);this._graphicsBySymbol.delete(b);void 0!==d&&this._graphicsBySymbol.set(c,d);d=this._symbols.get(b);void 0!==d&&(this._symbols.delete(b),this._symbols.set(c,d),e.isSome(d)&&(b="string"===typeof a?null:a,e.isSome(b)?d.symbol=b:d.symbol.id=c))}};f._updateUnchangedSymbolMappings=function(b,a,c){b=this._calculateUnchangedSymbolMapping(b,a,c);for(const {oldId:d,newId:g}of b)this._updateSymbolMapping(d,g)};f._applyRendererDiff=function(b,
a,c){if(this._diffHasSymbolChange(b))return!1;if(a instanceof S&&c instanceof S&&this._applyUniqueValueRendererDiff(b,a,c)&&0===Object.keys(b.diff).length)return!0;for(const [d]of this._graphicsBySymbol)if(c=this._symbols.get(d),e.isSome(c))switch(c.applyRendererDiff(b,a)){case X.ApplyRendererDiffResult.Recreate_Symbol:this._recreateSymbol(d);break;case X.ApplyRendererDiffResult.Recreate_Graphics:this._recreateGraphicsForSymbol(d)}return!0};f.opacityChange=function(){this.forEachGraphics3DSymbol((b,
a)=>b.globalPropertyChanged("opacity",a));this._updateStageLayerVisibility()};f._slicePlaneEnabledChange=function(b){b!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=b,this.stageLayer.isSliceable=b,this.forEachGraphics3DSymbol((a,c)=>a.globalPropertyChanged("slicePlaneEnabled",c)),this._deconflictor&&this._deconflictor.slicePlaneEnabledChange(),this._labeler&&this._labeler.slicePlaneEnabledChange())};f._physicalBasedRenderingChange=function(b){this.symbolCreationContext.physicalBasedRenderingEnabled=
b;this.forEachGraphics3DSymbol((a,c,d)=>{a.globalPropertyChanged("physicalBasedRenderingEnabled",c)||this._recreateSymbol(d)})};f._skipHighSymbolLoDsChange=function(b){this.symbolCreationContext.skipHighSymbolLods=b;this.forEachGraphics3DSymbol((a,c,d)=>this._recreateSymbol(d))};f._pixelRatioChange=function(){this.forEachGraphics3DSymbol((b,a,c)=>{b.globalPropertyChanged("pixelRatio",a)||this._recreateSymbol(c)})};f._signalUpdatingDuringAsyncLoadedGraphicsChange=function(){this._updatingPendingLoadedGraphicsChange&&
this._updatingPendingLoadedGraphicsChange.remove();this._updatingPendingLoadedGraphicsChange=fa.schedule(()=>{this._updatingPendingLoadedGraphicsChange=null})};f.setClippingExtent=function(b,a){const c=this.symbolCreationContext.clippingExtent,d=ia.create();ya.toBoundingRect(b,d,a)?this.symbolCreationContext.clippingExtent=I.fromRect(I.create(),d):this.symbolCreationContext.clippingExtent=null;return!I.equals(this.symbolCreationContext.clippingExtent,c)};f.modifyGraphics3DGraphicVisibilities=function(b){let a=
!1;this.graphics3DGraphics.forEach(c=>{b(c)&&(a=!0)});a&&(this.owner.view.labeler?.setDirty(),this.owner.view.deconflictor.setDirty())};f.forEachGraphics3DSymbol=function(b){for(const [a,c]of this._symbols){if(e.isNone(c))break;const d=this._graphicsBySymbol.get(a);b(c,d||Ha,a)}};f.updateAllGraphicsVisibility=function(){e.isSome(this._filterVisibility)&&this._filterVisibility.reapply();this.modifyGraphics3DGraphicVisibilities(b=>{const a=this._updateUserVisibility(b);b=e.isSome(this._scaleVisibility)&&
this._scaleVisibility.updateVisibility(b);return a||b})};f._hideAllGraphics=function(){this.modifyGraphics3DGraphicVisibilities(b=>b.setVisibilityFlag(z.VisibilityFlag.USER_SETTING,!1,z.VisibilityGroup.GRAPHIC))};f._validateRenderer=function(b){(b=V.validateTo3D(b,{geometryType:this.layer?.geometryType}))&&u.warn(`Renderer for layer '${this.layer.title?`${this.layer.title}, `:""}, id:${this.layer.id}' is not supported in a SceneView`,b.message)};f._volatileGraphicsUpdated=function(){this._labeler?.reset();
this.stageLayer.shaderTransformationChanged();this.notifyChange("updating")};f._cleanupSymbols=function(){if(!(0<this._graphicsWaitingForSymbol.size||this._suspendSymbolCleanup)){var b=!1;this._symbols.forEach((a,c)=>{if(!(e.isNone(a)||0<a.referenced)){var d=this._graphicsBySymbol.get(c);d&&0!==d.size||(this._graphicsBySymbol.delete(c),this._symbols.delete(c),e.destroyMaybe(a),b=!0)}});b&&(this._recomputeExtentPadding(),this.notifyChange("averageSymbolComplexity"))}};x._createClass(N,[{key:"spatialIndex",
get:function(){this._spatialIndex||(this._spatialIndex=new wa.SpatialIndex2D({objectIdField:this.owner.layer?.objectIdField,spatialReference:this._viewSpatialReference,hasZ:this.hasZ,hasM:this.hasM}),this._spatialIndex.setup(Array.from(this.graphics3DGraphics.values())));this._spatialIndex.update();return this._spatialIndex}},{key:"numberOfGraphics",get:function(){return this._numberOfGraphics}},{key:"effectiveUpdatePolicy",get:function(){return e.isSome(this.currentRenderer)&&"dictionary"===this.currentRenderer.type?
v.UpdatePolicy.ASYNC:e.unwrapOr(this.forcedUpdatePolicy,this.preferredUpdatePolicy)}},{key:"featureStore",get:function(){return this._featureStore}},{key:"initializePromise",get:function(){return this._initializePromise}},{key:"scaleVisibility",get:function(){return this._scaleVisibility}},{key:"elevationAlignment",get:function(){return this._elevationAlignment}},{key:"objectStates",get:function(){return this._objectStates}},{key:"filterVisibility",get:function(){return this._filterVisibility}},{key:"updating",
get:function(){return!!(0<this._graphicsWaitingForSymbol.size||this.running||this._elevationAlignment?.updating||e.isSome(this._scaleVisibility)&&this._scaleVisibility.updating||e.isSome(this._filterVisibility)&&this._filterVisibility.updating||this._rendererChangeAbortController||this._elevationInfoChangeAbortController||this._updatingPendingLoadedGraphicsChange||this._frameTask.updating||0<this._loadingSymbols)}},{key:"running",get:function(){return 0<this._pendingUpdates.size||!!this._spatialIndex?.updating}},
{key:"suspendedOrOutsideOfView",get:function(){return this.owner.suspended||this.owner.suspendInfo?.outsideOfView}},{key:"updatingRemaining",get:function(){return this.updating?this._pendingUpdates.size+.1*(this._spatialIndex?.updatingRemaining||0)+.1*(this._elevationAlignment?.updatingRemaining||0):0}},{key:"displayFeatureLimit",get:function(){var b=this.owner&&this.owner.view&&this.owner.view.qualitySettings;const a=b?b.graphics3D.minTotalNumberOfFeatures:0,c=b?b.graphics3D.maxTotalNumberOfFeatures:
0;b=b?b.graphics3D.maxTotalNumberOfPrimitives:0;const d=this.averageSymbolComplexity;var g=Math.max(1,e.isSome(d)?d.primitivesPerFeature:1),h=e.isSome(d)&&0<d.drawCallsPerFeature?c/d.drawCallsPerFeature*.3:c;g=Math.max(a,Math.min(c,Math.ceil(b/g),h));return(h=this._get("displayFeatureLimit"))&&h.minimumTotalNumberOfFeatures===a&&h.maximumTotalNumberOfFeatures===c&&h.maximumTotalNumberOfPrimitives===b&&h.averageSymbolComplexity===d&&h.maximumNumberOfFeatures===g?h:{minimumTotalNumberOfFeatures:a,maximumTotalNumberOfFeatures:c,
maximumTotalNumberOfPrimitives:b,averageSymbolComplexity:d,maximumNumberOfFeatures:g}}},{key:"averageSymbolComplexity",get:function(){const b=Y.averageSymbolComplexities(this._symbolComplexities),a=this._get("averageSymbolComplexity");return 0===b.numComplexities||e.isSome(a)&&(b.estimated&&(a.primitivesPerFeature>=b.primitivesPerFeature||a.primitivesPerCoordinate>=b.primitivesPerCoordinate||a.drawCallsPerFeature>=b.drawCallsPerFeature)||a.primitivesPerFeature===b.primitivesPerFeature&&a.primitivesPerCoordinate===
b.primitivesPerCoordinate&&a.drawCallsPerFeature===b.drawCallsPerFeature)?a:b}},{key:"usedMemory",get:function(){const b=e.isSome(this.averageSymbolComplexity)&&this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel*this._numberOfGraphics:0,a=this._getSymbolComplexitiesUsed().reduce((c,d)=>c+d.memory.resourceBytes,0);return this._usedMemory+b+a}},{key:"usedMemoryPerGraphic",get:function(){return this._usedMemory&&this._numberOfGraphics?20<(this._pendingAdds+this._pendingRemoves)/
this._numberOfGraphics?0:this._usedMemory/this._numberOfGraphics:e.isSome(this.averageSymbolComplexity)?this.averageSymbolComplexity.memory.bytesPerFeature+(this.labelsEnabled?this.averageSymbolComplexity.memory.bytesPerFeatureLabel:0):0}},{key:"unprocessedMemoryEstimate",get:function(){return Math.max(0,(this._pendingAdds-this._pendingRemoves)*this.usedMemoryPerGraphic)}},{key:"_symbolComplexities",get:function(){return this.currentRenderer?this._getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):
this._getSymbolComplexitiesUsed()}},{key:"_objectIdField",get:function(){return this.layer.objectIdField}},{key:"graphics3DGraphicsByObjectID",get:function(){const b=this.owner.layer&&this.owner.layer.objectIdField;if(!b)return null;const a=new Map;this.graphics3DGraphics.forEach(c=>{if(c){var d=this._getGraphicObjectID(c.graphic,b);e.isSome(d)&&a.set(d,c)}});return a}},{key:"labelsEnabled",get:function(){return!(!this._labeler||!this._labeler.layerLabelsEnabled())}},{key:"symbolUpdateType",get:function(){if(0<
this._pendingUpdates.size)return"unknown";let b=0,a=0;return T.someMap(this._symbols,(c,d)=>{if(e.isSome(c)){c=c.getFastUpdateStatus();if(0<c.loading)return!0;this._graphicsBySymbol.has(d)&&(a+=c.fast,b+=c.slow)}return!1})?"unknown":0<=a&&0===b?"fast":0<=b&&0===a?"slow":"mixed"}},{key:"test",get:function(){return{snapshotInternals:()=>({graphics:[...this.graphics3DGraphics.keys()].sort(),symbols:[...this._symbols.keys()].sort(),graphicsBySymbol:[...this._graphicsBySymbol.keys()].sort().map(b=>({symbolId:b,
graphics:[...this._graphicsBySymbol.get(b).keys()].sort()})),graphicsWithoutSymbol:[...this._graphicsWithoutSymbol.keys()].sort(),graphicsDrapedUids:[...this._graphicsDrapedUids].sort(),pendingUpdates:this._pendingUpdates}),symbols:this._symbols,filterVisibility:this._filterVisibility,numPending:this._pendingUpdates.size,forceUpdatePolicy:b=>{this.forcedUpdatePolicy=b}}}},{key:"performanceInfo",get:function(){return{visible:this.graphics3DGraphics.size,missing:this._graphicsWithoutSymbol.size,pending:this._pendingUpdates.size}}}]);
return N}(aa);k.Graphics3DCore.tmpVec=J.create();l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"computedExtent",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"currentRenderer",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"rendererHasGeometryOperations",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_frameTask",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_rendererChangeAbortController",void 0);l.__decorate([m.property()],
k.Graphics3DCore.prototype,"_elevationInfoChangeAbortController",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_initializeAbortController",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_elevationAlignment",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_scaleVisibility",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_filterVisibility",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_initializePromise",void 0);l.__decorate([m.property()],
k.Graphics3DCore.prototype,"_spatialIndex",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"extentPadding",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_updatingPendingLoadedGraphicsChange",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_featureStore",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_deconflictor",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_labeler",void 0);l.__decorate([m.property()],
k.Graphics3DCore.prototype,"_objectStates",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_loadingSymbols",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"preferredUpdatePolicy",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"forcedUpdatePolicy",void 0);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"effectiveUpdatePolicy",null);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"elevationFeatureExpressionEnabled",
void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"owner",void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"layer",void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"graphicSymbolSupported",void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"getRenderingInfoWithoutRenderer",void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"componentFactories",
void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"setUidToIdOnAdd",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"featureStore",null);l.__decorate([m.property()],k.Graphics3DCore.prototype,"initializePromise",null);l.__decorate([m.property()],k.Graphics3DCore.prototype,"scaleVisibility",null);l.__decorate([m.property()],k.Graphics3DCore.prototype,"elevationAlignment",null);l.__decorate([m.property()],k.Graphics3DCore.prototype,"objectStates",null);
l.__decorate([m.property()],k.Graphics3DCore.prototype,"filterVisibility",null);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"updating",null);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"running",null);l.__decorate([m.property({readOnly:!0})],k.Graphics3DCore.prototype,"suspendedOrOutsideOfView",null);l.__decorate([m.property({readOnly:!0,dependsOn:[]})],k.Graphics3DCore.prototype,"updatingRemaining",null);l.__decorate([m.property({readOnly:!0,dependsOn:["owner.view.qualitySettings.graphics3D.maxTotalNumberOfPrimitives",
"owner.view.qualitySettings.graphics3D.maxTotalNumberOfFeatures","averageSymbolComplexity"]})],k.Graphics3DCore.prototype,"displayFeatureLimit",null);l.__decorate([m.property({readOnly:!0,dependsOn:[]})],k.Graphics3DCore.prototype,"averageSymbolComplexity",null);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"hasZ",void 0);l.__decorate([m.property({constructOnly:!0})],k.Graphics3DCore.prototype,"hasM",void 0);l.__decorate([m.property()],k.Graphics3DCore.prototype,"_objectIdField",
null);k.Graphics3DCore=Q=l.__decorate([ha.subclass("esri.views.3d.layers.graphics.Graphics3DCore")],k.Graphics3DCore);var t;(function(w){w[w.NEW=0]="NEW";w[w.LOADING=1]="LOADING";w[w.READY=2]="READY";w[w.REJECTED=3]="REJECTED"})(t||(t={}));let Ga=function(){function w(){this.renderingInfo=this.add=null;this.state=t.NEW;this.remove=null}w.prototype.clear=function(){this.renderingInfo=this.add=null;this.state=t.NEW;this.remove=this.abortController=null};return w}();const B=J.create(),F=J.create(),Ha=
new Map;Object.defineProperties(k,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});