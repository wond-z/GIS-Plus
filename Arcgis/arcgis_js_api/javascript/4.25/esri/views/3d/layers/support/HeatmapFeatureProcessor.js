// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/byteSizeEstimations ../../../../core/HandleOwner ../../../../core/handleUtils ../../../../core/Logger ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/screenUtils ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../geometry/projection ../../../../geometry/support/scaleUtils ../../../../layers/graphics/dehydratedFeatures ../../../../layers/graphics/featureConversionUtils ../../../../layers/graphics/OptimizedFeature ../../../../layers/graphics/OptimizedGeometry ../../../../layers/graphics/data/FeatureStore ../../../../layers/support/fieldUtils ../../../../renderers/support/heatmapUtils ../interfaces ./FeatureVisibilityFilter ../../terrain/OverlayRenderer ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/DrapedHeatmapRenderer ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/ModelDirtyTypes ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/lib/VertexAttribute ../../webgl-engine/materials/HeatmapDensityMaterial ../../../support/layerViewUtils ../../../webgl/enums ../../../webgl/heatmapTextureUtils".split(" "),
function(b,w,c,r,I,x,J,k,p,K,d,ca,da,L,M,N,O,P,y,z,Q,A,R,S,T,U,V,W,B,X,Y,t,Z,C,D,E,q,aa){const u=J.getLogger("esri.views.3d.layers.support.HeatmapFeatureProcessor");b.HeatmapFeatureProcessor=function(F){function v(a){a=F.call(this,a)||this;a.type="heatmap";a.preferredUpdatePolicy=B.UpdatePolicy.ASYNC;a.dataExtent=null;a.drapeSourceType=U.DrapeSourceType.Features;a._renderGeometries=new Map;a._fieldTotal=0;a._drapeSourceRenderer=null;a._dataType=q.PixelType.HALF_FLOAT;a._pixelFormat=q.PixelFormat.RGBA;
a.initializePromise=Promise.resolve();return a}w._inheritsLoose(v,F);var l=v.prototype;l.initialize=function(){this._featureStore=new R({geometryType:"esriGeometryPoint",hasZ:this.hasZ,hasM:this.hasM});const {dataType:a,samplingMode:e,pixelFormat:g,internalFormat:f}=aa.loadHeatmapTextureConfiguration(this._renderView.renderingContext,u);this._dataType=a;this._pixelFormat=g;const m=a!==q.PixelType.FLOAT;this._drapeSourceRenderer=this.view.basemapTerrain.overlayManager.registerDrapeSource(this,X.DrapedHeatmapRenderer,
{...this._rendererParameters,dataType:a,samplingMode:e,pixelFormat:g,internalFormat:f});this._material=new D.HeatmapDensityMaterial({usesHalfFloats:m});this._materialWithField=new D.HeatmapDensityMaterial({usesHalfFloats:m,isAttributeDriven:!0});this._filterVisibility=new V.FeatureVisibilityFilter({context:{layerView:this.owner,featureStore:this.featureStore,getFeatureCount:()=>this._loadedPointGraphics.length,setAllFeaturesVisibility:h=>this._setAllFeaturesVisibility(h),clearFeaturesVisibility:()=>
this._setAllFeaturesVisibility(!0),updateFeatureVisibilities:h=>this._updateFeatureVisibilities(h)}});this.updatingHandles.addOnCollectionChange(()=>this._loadedPointGraphics,h=>this._onLoadedFeaturesChange(h),p.initial);this.updatingHandles.addWhen(()=>this._materialParameters,h=>this._forEachMaterial(n=>n.setParameters(h)),p.initial);this.updatingHandles.add(()=>this._rendererParameters,h=>this._drapeSourceRenderer.set(h));this.updatingHandles.add(()=>this._heatmapRendererField,()=>{this._recreate()},
p.sync);this.updatingHandles.add(()=>({fieldName:this._heatmapRendererFieldName,numeric:this._heatmapRendererFieldIsNumeric}),({fieldName:h,numeric:n})=>{if(k.isSome(h)&&n){let G=0;this._featureStore.forEach(ba=>G+=ba.attributes[h]??0);this._fieldTotal=G}else this._fieldTotal=this._featureStore.numFeatures},p.initial);this.handles.add([p.watch(()=>({fieldName:this._heatmapRendererFieldName,field:this._heatmapRendererField}),({fieldName:h,field:n})=>{h&&!n&&u.warn(`Heatmap renderer field '${h}' for layer '${this.layer.title??
this.layer.id}' not found`)}),p.watch(()=>({field:this._heatmapRendererField,numeric:this._heatmapRendererFieldIsNumeric}),({field:h,numeric:n})=>{k.isSome(h)&&!n&&u.warn(`Heatmap renderer field '${h.name}' for layer '${this.layer.title??this.layer.id}' does not contain numeric values and cannot be used to drive the heatmap density`)}),x.makeHandle(()=>this.view.basemapTerrain.overlayManager.unregisterDrapeSource(this))])};l.destroy=function(){this._renderGeometries.clear();this._material=k.disposeMaybe(this._material);
this._materialWithField=k.disposeMaybe(this._materialWithField);this._featureStore.clear();this._featureStore=null};l.whenGraphicBounds=function(){var a=w._asyncToGenerator(function*(){return null});return function(){return a.apply(this,arguments)}}();l.computeAttachmentOrigin=function(){return null};l.highlight=function(){return H};l.maskOccludee=function(){return H};l.setObjectIdVisibility=function(){};l.refreshFilter=function(){this.filterVisibility.reapply()};l._onLoadedFeaturesChange=function(a){if(this._featuresArePoints){var {objectIdField:e}=
this.layer;this._featureStore.removeManyById(a.removed.map(f=>y.getObjectId(f,e)));this._featureStore.addMany(a.added.map(f=>{const m=new Q.OptimizedFeature(z.convertFromPoint(new A,f.geometry),f.attributes,k.applySome(f.centroid,h=>z.convertFromPoint(new A,h)),y.getObjectId(f,e));m.displayId=f.uid;return m}));var g=a.added;a=a.removed;this._fieldTotal+=this._computeFieldTotalChange(g,a);a=k.mapSome(a,({uid:f})=>{const m=this._renderGeometries.get(f);this._renderGeometries.delete(f);return m});g=
g.map(f=>{const m=this._pointGraphicToRenderGeometry(f);this._renderGeometries.set(f.uid,m);return m});0<a.length&&this._drapeSourceRenderer.removeGeometries(a,t.DirtyOperation.REMOVE);0<g.length&&this._drapeSourceRenderer.addGeometries(g,t.DirtyOperation.ADD);if(0<g.length||0<a.length)this.filterVisibility.reapply(),this._renderView.requestRender()}};l._recreate=function(){if(this._loadedPointGraphics){var a=this._loadedPointGraphics.toArray();this._onLoadedFeaturesChange({added:a,removed:a})}};
l._pointGraphicToRenderGeometry=function(a){const e=this._heatmapRendererFieldName,g=k.isSome(e)?this._materialWithField:this._material,f=N.create();O.projectPointToVector(a.geometry,f,this._overlaySpatialReference);f[2]=W.DRAPED_Z;const m=[[C.VertexAttribute.POSITION,{data:f,size:f.length}]],h=this._heatmapRendererFieldIsNumeric;k.isSome(e)&&m.push([C.VertexAttribute.FEATUREATTRIBUTE,{data:[h?a.attributes[e]??0:0],size:1}]);a=new Z.RenderGeometry(new Y.Geometry(m,null,B.PrimitiveType.Point),g,{layerUid:this.layer.uid,
graphicUid:a.uid});M.copy(a.boundingSphere,f);a.instanceParameters.visible=this.filterVisibility.defaultVisibility;return a};l._forEachMaterial=function(a){a(this._material);a(this._materialWithField)};l._computeFieldTotalChange=function(a,e){if(k.isNone(this._heatmapRendererFieldName)||!this._heatmapRendererFieldIsNumeric)return a.length-e.length;const g=this._heatmapRendererFieldName,f=(m,h)=>m+(h.attributes[g]??0);return a.reduce(f,0)-e.reduce(f,0)};l._clampSearchRadius=function(a){112<a&&u.warnOnce("SceneView supports a maximum radius of 112 pt for HeatmapRenderer.");
return Math.min(a,112)};l._updateFeatureVisibilities=function(a){const e=[];this._featureStore.forEach(({objectId:g,displayId:f})=>{g=a(g);f=this._renderGeometries.get(f);f.instanceParameters.visible!==g&&(e.push(f),f.instanceParameters.visible=g)});this._drapeSourceRenderer.modifyGeometries(e,t.DirtyState.VISIBILITIES)};l._setAllFeaturesVisibility=function(a){const e=[];for(const g of this._renderGeometries.values())g.instanceParameters.visible!==a&&(e.push(g),g.instanceParameters.visible=a);this._drapeSourceRenderer.modifyGeometries(e,
t.DirtyState.VISIBILITIES)};w._createClass(v,[{key:"layer",get:function(){return this.owner.layer}},{key:"featureStore",get:function(){return this._featureStore}},{key:"updating",get:function(){return this.updatingHandles.updating||this.filterVisibility.updating}},{key:"updatingRemaining",get:function(){return 0}},{key:"suspendInfo",get:function(){return{}}},{key:"legendEnabled",get:function(){return!0}},{key:"filterVisibility",get:function(){return this._filterVisibility}},{key:"displayFeatureLimit",
get:function(){var a=this.owner?.view?.resourceController?.memoryController?.memoryFactor??1;const e=this.owner?.view?.qualitySettings;a=e?Math.ceil(e.heatmap.maxTotalNumberOfFeatures*a):0;return{minimumTotalNumberOfFeatures:0,maximumTotalNumberOfFeatures:a,maximumTotalNumberOfPrimitives:2*a,maximumNumberOfFeatures:a}}},{key:"hasZ",get:function(){return"hasZ"in this.layer&&this.layer.hasZ}},{key:"hasM",get:function(){return"hasM"in this.layer&&this.layer.hasM}},{key:"view",get:function(){return this.owner.view}},
{key:"fullOpacity",get:function(){return this.owner.fullOpacity}},{key:"updatePolicy",get:function(){return this.owner.updatePolicy}},{key:"scaleVisibilitySuspended",get:function(){if(!this._isScaleRangeActive)return!1;const {minScale:a,maxScale:e}=this.layer.effectiveScaleRange,{scale:g}=this.view;return!E.scaleBoundsPredicate(g,a??0,e??0)}},{key:"usedMemory",get:function(){const a=Math.ceil(this._overlayRenderer?.overlays[0]?.resolution*this._densityMapPixelRatio)??0;return a*a*(this._pixelFormat===
q.PixelFormat.RED?1:4)*(this._dataType===q.PixelType.FLOAT?4:2)+this.usedMemoryPerFeature*this._featureStore.numFeatures}},{key:"usedMemoryPerFeature",get:function(){var a=this._loadedPointGraphics.find(()=>!0);if(k.isNone(a))return 0;a=r.estimateAttributesObjectSize(a);const e=r.estimateNumberByteSize(),g=6*r.estimateFixedArraySize([0,0,0],e),f=6*r.estimateFixedArraySize([0,0],e);return g+f+(this._heatmapRendererFieldIsNumeric?6*e:0)+a}},{key:"loadedFeatures",get:function(){return this._featureStore.numFeatures}},
{key:"unprocessedMemoryEstimate",get:function(){return 0}},{key:"performanceInfo",get:function(){return{core:{visible:this._visibleFeatures,missing:0,pending:0},elevationUpdating:!1,visibilityFrustum:!0,visibilityScale:!0}}},{key:"renderer",get:function(){return this._heatmapRenderer}},{key:"_overlayRenderer",get:function(){return this.view.basemapTerrain.overlayManager.renderer}},{key:"_overlaySpatialReference",get:function(){return k.unwrap(this._overlayRenderer.spatialReference)}},{key:"_rendererParameters",
get:function(){return{...this._radiusParameter,...this._densityParameters,...this._colorRampParameter,...this._pixelRatioParameter}}},{key:"_materialParameters",get:function(){return{...this._radiusParameter,...this._resolutionForScaleParameter}}},{key:"_densityParameters",get:function(){const a=this._heatmapRenderer;if(k.isNone(a))return null;const {minDensity:e,maxDensity:g}=a;return{minDensity:e,maxDensity:g,fieldTotal:this._fieldTotal}}},{key:"_radiusParameter",get:function(){return k.applySome(this._heatmapRenderer,
({radius:a})=>({searchRadius:K.pt2px(this._clampSearchRadius(a))}))}},{key:"_resolutionForScaleParameter",get:function(){return k.applySome(this._heatmapRenderer,({referenceScale:a})=>({resolutionForScale:0===a?0:P.getResolutionForScale(a,this.view.spatialReference)}))}},{key:"_colorRampParameter",get:function(){return k.applySome(this._heatmapRenderer,a=>({colorRampData:T.generateGradient(a.colorStops)}))}},{key:"_pixelRatioParameter",get:function(){return{pixelRatio:this._densityMapPixelRatio}}},
{key:"_densityMapPixelRatio",get:function(){return(this.owner?.view?.qualitySettings.heatmap.pixelRatio??1)*Math.sqrt(this.owner?.view?.resourceController?.memoryController?.memoryFactor??1)}},{key:"_renderView",get:function(){return this.view._stage.renderView}},{key:"_featuresArePoints",get:function(){return"point"===this.layer.geometryType}},{key:"_loadedPointGraphics",get:function(){return this.owner.loadedGraphics}},{key:"_heatmapRenderer",get:function(){const a=this.layer.renderer;return"heatmap"===
a?.type?a:null}},{key:"_heatmapRendererFieldName",get:function(){return k.applySome(this._heatmapRenderer,a=>a.field)}},{key:"_heatmapRendererField",get:function(){return k.applySome(this._heatmapRendererFieldName,a=>this.layer.fieldsIndex.get(a))}},{key:"_heatmapRendererFieldIsNumeric",get:function(){const a=this._heatmapRendererField;return k.isNone(a)?!1:S.isNumericField(a)}},{key:"_isScaleRangeActive",get:function(){const {layer:a}=this;if(!("effectiveScaleRange"in a))return!1;const {minScale:e,
maxScale:g}=a.effectiveScaleRange;return E.isScaleRangeActive(e,g)}},{key:"_visibleFeatures",get:function(){let a=0;this._renderGeometries.forEach(e=>{e.instanceParameters.visible&&++a});return a}},{key:"test",get:function(){return{visibleFeatureCount:this._visibleFeatures}}}]);return v}(I.HandleOwner);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"type",void 0);c.__decorate([d.property({constructOnly:!0})],b.HeatmapFeatureProcessor.prototype,"owner",void 0);c.__decorate([d.property()],
b.HeatmapFeatureProcessor.prototype,"layer",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"featureStore",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"updating",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"updatingRemaining",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"suspendInfo",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"legendEnabled",null);c.__decorate([d.property()],
b.HeatmapFeatureProcessor.prototype,"filterVisibility",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"displayFeatureLimit",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"preferredUpdatePolicy",void 0);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"hasZ",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"hasM",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"dataExtent",void 0);c.__decorate([d.property()],
b.HeatmapFeatureProcessor.prototype,"view",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"fullOpacity",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"updatePolicy",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"drapeSourceType",void 0);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"scaleVisibilitySuspended",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"renderer",null);c.__decorate([d.property()],
b.HeatmapFeatureProcessor.prototype,"_featureStore",void 0);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"_filterVisibility",void 0);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"_overlayRenderer",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"_overlaySpatialReference",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"_rendererParameters",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"_materialParameters",
null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"_densityParameters",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"_radiusParameter",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"_resolutionForScaleParameter",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"_colorRampParameter",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"_pixelRatioParameter",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,
"_densityMapPixelRatio",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"_renderGeometries",void 0);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"_material",void 0);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"_materialWithField",void 0);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"_renderView",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"_featuresArePoints",null);c.__decorate([d.property()],
b.HeatmapFeatureProcessor.prototype,"_loadedPointGraphics",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"_heatmapRenderer",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"_heatmapRendererFieldName",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"_heatmapRendererField",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"_heatmapRendererFieldIsNumeric",null);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,
"_fieldTotal",void 0);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"_drapeSourceRenderer",void 0);c.__decorate([d.property()],b.HeatmapFeatureProcessor.prototype,"_isScaleRangeActive",null);b.HeatmapFeatureProcessor=c.__decorate([L.subclass("esri.views.3d.layers.support.HeatmapFeatureProcessor")],b.HeatmapFeatureProcessor);const H=x.makeHandle();b.MAX_RADIUS_PT=112;Object.defineProperties(b,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});