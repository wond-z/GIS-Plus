// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/asyncUtils ../../../../core/Handles ../../../../core/Logger ../../../../core/MapUtils ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../layers/graphics/hydratedFeatures ../../../../layers/support/labelFormatUtils ../../../../layers/support/layerUtils ../../../../symbols/callouts/calloutUtils ./enums ./Graphics3DCalloutSymbolLayerFactory ./Graphics3DGraphicCreationContext ./graphicSymbolUtils ./labelPlacement ./placementUtils ../../support/debugFlags ../../webgl-engine/lib/MaterialCollection ../../webgl-engine/lib/TextRenderer ../../webgl-engine/lib/TextRenderParameters ../../webgl-engine/lib/TextTextureAtlas ../../webgl-engine/lib/WebGLLayer ../../../support/Scheduler".split(" "),
function(t,w,A,K,F,L,G,M,p,x,H,B,ca,da,N,O,P,E,Q,r,R,S,T,U,C,V,I,W,X,Y,Z,aa){t.Labeler=function(J){function D(b){b=J.call(this,b)||this;b._dirty=!1;b._labels=new Map;b._labelsToAdd=new Map;b._labelsToRemove=new Map;b._labelingContexts=[];return b}w._inheritsLoose(D,J);var f=D.prototype;f.setup=function(){this.dispose();this._handles=new L;this._handles.add([H.watch(()=>this.view.state?.camera,()=>this.setDirty()),H.watch(()=>this.view.state?.pixelRatio,()=>this._resetAllLabels()),this.view.resourceController.scheduler.registerTask(aa.TaskPriority.LABELER,
this)]);this._textTextureAtlas=new Y.TextTextureAtlas({view:this.view});this._hudMaterialCollection=new I.MaterialCollection(this.view._stage);this._calloutMaterialCollection=new I.MaterialCollection(this.view._stage)};f.dispose=function(){this._handles=p.destroyMaybe(this._handles);this._textTextureAtlas=p.disposeMaybe(this._textTextureAtlas);this._hudMaterialCollection=p.disposeMaybe(this._hudMaterialCollection);this._calloutMaterialCollection=p.disposeMaybe(this._calloutMaterialCollection);this._labelingContexts.length=
0;this._labels.clear();this._labelsToAdd.clear();this._labelsToRemove.clear()};f._activateLabelingContext=function(b){b.labels.forEach((a,c)=>{this._labels.set(c,a);a.graphics3DGraphic.setVisibilityFlag(r.VisibilityFlag.USER_SETTING,!0,r.VisibilityGroup.LABEL)});b.active=!0};f._deactivateLabelingContext=function(b){b.labels.forEach((a,c)=>{a.graphics3DGraphic.setVisibilityFlag(r.VisibilityFlag.USER_SETTING,!1,r.VisibilityGroup.LABEL);this.setLabelGraphicVisibility(a.graphics3DGraphic,!1);this._labels.delete(c)});
b.active=!1};f._addLabelTextureToAtlas=function(b){for(const a of b.graphics3DGraphic.labelGraphics){if(!a._labelClass)continue;const c=b.textTextureResources.textRenderers[a._labelIndex];p.isSome(c)&&this._textTextureAtlas.addTextTexture(c,a.stageObject)}b.rendered=!0};f._removeLabelTextureFromAtlas=function(b){for(const a of b.graphics3DGraphic.labelGraphics){if(!a._labelClass)continue;const c=b.textTextureResources.textRenderers[a._labelIndex];p.isSome(c)&&this._textTextureAtlas.removeTextTexture(c,
a.stageObject)}b.rendered=!1};f.runTask=function(b){this._updateLabels(b);!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(b)};f._updateLabels=function(b){if(this._dirty){this._dirty=!1;for(const a of this._labelingContexts)if(a.active&&E.areLabelsVisible(a.layer)){if(!a.labelClassContexts||!a.labelClassContexts.length){if(null===a.labelClassContexts){this._deactivateLabelingContext(a);continue}this._createLabelClassContext(a);if(a.labelClassPromise&&a.labelClassAbortController){this._dirty=
!0;continue}if(!a.labelClassContexts||!a.labelClassContexts.length)continue}M.someMap(a.labelsToInitialize,(c,d)=>{this._ensureGraphics3DResources(c)&&(this._labels.set(d,c),this.deconflictor.setDirty(),b.madeProgress());if(c.visible&&c.textTextureResources.initialized||!c.visible&&c.hasGraphics3DResources)a.labelsToInitialize.delete(d),b.madeProgress();return b.done})&&(this._dirty=!0)}this._labelsToRemove.forEach(a=>this._removeLabelTextureFromAtlas(a));this._labelsToAdd.forEach(a=>this._addLabelTextureToAtlas(a));
this._labelsToRemove.clear();this._labelsToAdd.clear();this._dirty||this.notifyChange("updating")}};f._createLabelClassContextAsync=function(){var b=w._asyncToGenerator(function*(a){var c=this;const d=a.labelClassAbortController.signal;yield a.layer.when();x.throwIfAborted(d);a.scaleVisibility&&a.scaleVisibility.updateScaleRangeActive();const g=a.graphics3DCore;var e=g.layer;if((e=e.labelingInfo&&e.labelingInfo.filter(n=>!!n.symbol))&&0!==e.length){var h=Array(e.length),k=!1;yield F.forEach(e,function(){var n=
w._asyncToGenerator(function*(l,q){var m=l.symbol;const y=T.getGraphics3DSymbol(g.getOrCreateGraphics3DSymbol(m));if(p.isNone(y))G.getLogger(c.declaredClass).error("Failed to create Graphics3DSymbol for label");else{yield y.load();x.throwIfAborted(d);var u=null;Q.hasCalloutSupport(m)&&m.hasVisibleCallout()&&(u=R.make(m,g.symbolCreationContext),yield u.load(),x.throwIfAborted(d));m=yield F.result(P.createLabelFunction(l,a.layer.fieldsIndex,c.view.spatialReference));x.throwIfAborted(d);if(!0===m.ok){const z=
yield c._createTextRenderParameters(y.symbol);x.throwIfAborted(d);h[q]={labelClass:l,labelFunction:m.value,graphics3DSymbol:y,graphics3DCalloutSymbolLayer:u,calloutSymbolLayerIndex:0,textRenderParameters:z}}else G.getLogger(c.declaredClass).error(`Label expression failed to evaluate: ${m.error}`),k=!0}});return function(l,q){return n.apply(this,arguments)}}());x.throwIfAborted(d);k||(a.labelClassContexts=h)}});return function(a){return b.apply(this,arguments)}}();f._createLabelClassContext=function(){var b=
w._asyncToGenerator(function*(a){a.labelClassPromise||(a.labelClassPromise=this._createLabelClassContextAsync(a).catch(c=>{if(x.isAbortError(c))throw c;a.labelClassContexts=null}).then(()=>{a.labelClassAbortController=null;this.notifyChange("updating")}).catch(()=>{}),this.notifyChange("updating"));return a.labelClassPromise});return function(a){return b.apply(this,arguments)}}();f._createTextRenderParameters=function(){var b=w._asyncToGenerator(function*(a){return(a=a.symbolLayers.getItemAt(0))&&
"text"===a.type?X.TextRenderParameters.fromSymbol(a,this.view.state.pixelRatio):null});return function(a){return b.apply(this,arguments)}}();f._destroyLabelClassContext=function(b){for(var a of b.labelClassContexts)--a.graphics3DSymbol.referenced,a.graphics3DSymbol=null;a=b.labelClassAbortController;b.labelClassAbortController=new AbortController;a&&a.abort();b.labelClassContexts=[];b.labelClassPromise=null;this.notifyChange("updating")};f._createTextSymbolGraphic=function(b,a,c,d,g){b={text:b.text,
centerOffset:c.centerOffset,translation:c.translation,elevationOffset:c.elevationOffset,screenOffset:c.screenOffset,centerOffsetUnits:c.centerOffsetUnits,horizontalPlacement:C.horizontalPlacementFromAnchor(c.anchor),verticalPlacement:C.verticalPlacementFromAnchor(c.anchor),verticalOffset:c.verticalOffset,debugDrawLabelBorder:V.LABELS_SHOW_BORDER,displayWidth:b.displayWidth,displayHeight:b.displayHeight};v.graphic=a;v.renderingInfo=null;v.layer=d;return g.createLabel(v,b,this._hudMaterialCollection,
this._textTextureAtlas)};f._createLineCalloutGraphic=function(b,a,c,d,g){a={symbol:a,translation:d.translation,elevationOffset:d.elevationOffset,screenOffset:d.screenOffset,centerOffset:d.centerOffset,centerOffsetUnits:d.centerOffsetUnits,materialCollection:this._calloutMaterialCollection};v.graphic=b;v.renderingInfo=a;v.layer=g;return c.createGraphics3DGraphic(v)};f._ensureGraphics3DResources=function(b){if(b.hasGraphics3DResources)return!1;const a=b.graphics3DGraphic;if(a.destroyed)return!1;this._ensureTextTextureResources(b);
const {textTextureResources:c}=b,d=b.labelingContext,g=d.labelClassContexts;if(!g||0===g.length||!d.emptySymbolLabelSupported&&0===a.graphics.length)return!1;var e=!1,h=a.graphic;const k=d.layer;var n=E.areLabelsVisible(d.layer);const l=this.view._stage;for(let m=0;m<g.length;m++){const y=c.textRenderers[m],u=c.labelPlacements[m];if(p.isNone(y)||p.isNone(u))continue;const z=g[m];var q=z.graphics3DSymbol;const ba=q.symbol&&"label-3d"===q.symbol.type?q.symbol:null;if(q=q.symbolLayers[0]){q.setElevationInfoOverride(d.elevationInfoOverride);
e=this._createTextSymbolGraphic(y,h,u,k,q);if(!e)return!1;e._labelClass=z.labelClass;e._labelIndex=m;a.addLabelGraphic(e,l,d.stageLayer);a.setVisibilityFlag(r.VisibilityFlag.USER_SETTING,n,r.VisibilityGroup.LABEL);a.clearVisibilityFlag(r.VisibilityFlag.SCALE_RANGE,r.VisibilityGroup.LABEL);a.setVisibilityFlag(r.VisibilityFlag.DECONFLICTION,!1,r.VisibilityGroup.LABEL);e=!0;(n=z.graphics3DCalloutSymbolLayer)&&u.hasLabelVerticalOffset&&(n.setElevationInfoOverride(d.elevationInfoOverride),h=this._createLineCalloutGraphic(h,
ba,n,u,k),p.isSome(h)&&(z.calloutSymbolLayerIndex=a.labelGraphics.length,a.addLabelGraphic(h,l,d.stageLayer)));break}}d.scaleVisibility&&e&&d.scaleVisibility.updateGraphicLabelScaleVisibility(a);return b.hasGraphics3DResources=!0};f._destroyGraphics3DResources=function(b){const a=b.labelingContext.labelClassContexts;for(const c of b.graphics3DGraphic.labelGraphics){if(null==c._labelClass)continue;const d=a[c._labelIndex].graphics3DSymbol.symbolLayers[0];if(null!=d)d.onRemoveGraphic(c)}b.graphics3DGraphic.clearLabelGraphics();
b.hasGraphics3DResources=!1};f._ensureTextTextureResources=function(b){const {textTextureResources:a}=b;if(!a.initialized){var c=b.labelingContext,d=c.labelClassContexts;if(d&&0!==d.length){var g=b.graphics3DGraphic.graphic;for(let k=0;k<d.length;k++){const n=d[k];a.textRenderers[k]=null;a.labelPlacements[k]=null;if(!n.textRenderParameters)continue;var e=n.labelFunction;let l;if("arcade"===e.type)try{const q=e.needsHydrationToEvaluate()?O.hydrateGraphic(g,c.layer):g;l=e.evaluate(q)}catch(q){l=null}else l=
e.evaluate(g);if(!p.isNone(l)&&""!==l&&!/^\s+$/.test(l)&&(e=n.graphics3DSymbol,e.symbolLayers[0]&&(e=U.get({graphics3DGraphic:b.graphics3DGraphic,labelSymbol:e.symbol&&"label-3d"===e.symbol.type?e.symbol:null,labelClass:n.labelClass,disablePlacement:c.disablePlacement}),!p.isNone(e)))){var h=C.horizontalPlacementFromAnchor(e.anchor);h=C.textRenderAlignmentFromHorizontalPlacement(h);a.textRenderers[k]=new W.TextRenderer(l,h,n.textRenderParameters);a.labelPlacements[k]=e}}a.initialized=!0}}};f._destroyTextTextureResources=
function(b){({textTextureResources:b}=b);b.initialized=!1;b.textRenderers=[];b.labelPlacements=[]};f._addGraphic=function(b,a){const c={hasGraphics3DResources:!1,visible:!1,rendered:!1,labelingContext:b,graphics3DGraphic:a,textTextureResources:{initialized:!1,textRenderers:[],labelPlacements:[]}};a=a.graphic.uid;b.labels.set(a,c);b.labelsToInitialize.set(a,c);this.setDirty();this.deconflictor.setDirty()};f._removeGraphic=function(b,a){a=a.graphic.uid;const c=b.labels.get(a);c&&(this._destroyGraphic(c,
a),b.labels.delete(a),b.labelsToInitialize.delete(a),this.setDirty(),this.deconflictor.setDirty())};f._destroyGraphic=function(b,a){this._labels.has(a)&&(this._labels.delete(a),this._labelsToAdd.delete(a),this._labelsToRemove.delete(a));b.textTextureResources.initialized&&(this._removeLabelTextureFromAtlas(b),this._destroyTextTextureResources(b));b.hasGraphics3DResources&&this._destroyGraphics3DResources(b)};f._labelingInfoChange=function(){var b=w._asyncToGenerator(function*(a,c){if(c)for(const d of c){if(c=
a.labels.get(d))this._removeGraphic(a,c.graphics3DGraphic),this._addGraphic(a,c.graphics3DGraphic)}else return this._visibilityInfoChange(a),this._resetLabels(a),this._createLabelClassContext(a)});return function(a,c){return b.apply(this,arguments)}}();f._globalPropertyChanged=function(b,a){for(const c of a.labelClassContexts){const d=new Map;a.labels.forEach(g=>{g=g.graphics3DGraphic;d.set(g.graphic.uid,g)});p.unwrap(c.graphics3DSymbol.symbolLayers[0]).globalPropertyChanged(b,d,g=>g.labelGraphics[0]);
c.graphics3DCalloutSymbolLayer&&c.graphics3DCalloutSymbolLayer.globalPropertyChanged(b,d,g=>g.labelGraphics[c.calloutSymbolLayerIndex])}};f._visibilityInfoChange=function(b){const a=b.layer.labelsVisible;a&&!b.active&&this._activateLabelingContext(b);!a&&b.active&&this._deactivateLabelingContext(b);this.setDirty()};f._resetAllLabels=function(){for(const b of this._labelingContexts)this._resetLabels(b)};f._resetLabels=function(b){b.labels.forEach((a,c)=>{this._destroyGraphic(a,c);a.visible=!1;a.rendered=
!1;b.labelsToInitialize.set(c,a)});this._destroyLabelClassContext(b);this.setDirty();this.deconflictor.setDirty()};f._findLabelingContext=function(b){for(const a of this._labelingContexts)if(a.graphics3DCore===b)return a;return null};f.addGraphicsOwner=function(b,a,c){const d=c&&c.emptySymbolLabelSupported||!1,g=c&&c.elevationInfoOverride||null;c=c&&c.disablePlacement||null;if(!this._findLabelingContext(b)){var e=b.layer,h={graphics3DCore:b,layer:e,scaleVisibility:a,emptySymbolLabelSupported:d,elevationInfoOverride:g,
disablePlacement:c,active:e.labelsVisible,labelClassPromise:null,labelClassAbortController:new AbortController,labelClassContexts:[],labels:new Map,labelsToInitialize:new Map,stageLayer:new Z.WebGLLayer({isPickable:!0},e.uid)};this.view._stage.add(h.stageLayer);this._labelingContexts.push(h);this.setDirty();return{addGraphic:k=>this._addGraphic(h,k),removeGraphic:k=>this._removeGraphic(h,k),featureReductionChange:()=>{},layerLabelsEnabled:()=>E.areLabelsVisible(h.layer),labelingInfoChange:k=>this._labelingInfoChange(h,
k),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",h),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",h),visibilityInfoChange:()=>this._visibilityInfoChange(h),reset:()=>this._resetLabels(h),clear:()=>{}}}};f.removeGraphicsOwner=function(b){const a=this._findLabelingContext(b);a&&(b=this._labelingContexts.indexOf(a),this._labelingContexts.splice(b,1),a.labels.forEach(c=>this._removeGraphic(a,c.graphics3DGraphic)),this.view._stage.remove(a.stageLayer),
a.stageLayer=null,this.setDirty())};f.setLabelGraphicVisibility=function(b,a){b=b.graphic.uid;const c=this._labels.get(b);c&&c.visible!==a&&(a&&!c.rendered?(this._labelsToAdd.set(b,c),this._labelsToRemove.delete(b),c.textTextureResources.initialized||c.labelingContext.labelsToInitialize.set(b,c)):!a&&c.rendered&&(this._labelsToRemove.set(b,c),this._labelsToAdd.delete(b)),c.visible=a,this.setDirty())};f.setDirty=function(){!this._dirty&&0<this._labelingContexts.length&&(this._dirty=!0,this.notifyChange("updating"))};
w._createClass(D,[{key:"running",get:function(){return this.view.ready&&(this._dirty||this._textTextureAtlas?.updating||this.deconflictor.running)}},{key:"updating",get:function(){return this._dirty||this._textTextureAtlas?.updating||this.deconflictor.updating||this._labelingContexts.some(b=>b.labelClassPromise&&!!b.labelClassAbortController)}},{key:"updatingProgress",get:function(){if(!this.updating||!this._textTextureAtlas)return 1;const b=0<this._labelingContexts.length?this._labelingContexts.reduce((a,
c)=>a+(c.labelClassPromise&&c.labelClassAbortController?0:1),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*b+.5*this.deconflictor.updatingProgress}},{key:"test",get:function(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}}]);return D}(K);A.__decorate([B.property({constructOnly:!0})],t.Labeler.prototype,"view",void 0);A.__decorate([B.property({constructOnly:!0})],t.Labeler.prototype,"deconflictor",
void 0);A.__decorate([B.property()],t.Labeler.prototype,"_textTextureAtlas",void 0);A.__decorate([B.property({type:Boolean,readOnly:!0})],t.Labeler.prototype,"updating",null);t.Labeler=A.__decorate([N.subclass("esri.views.3d.layers.graphics.Labeler")],t.Labeler);const v=new S(null,null,null);Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});