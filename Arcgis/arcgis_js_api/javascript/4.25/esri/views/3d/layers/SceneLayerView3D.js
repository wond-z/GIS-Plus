// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../Graphic ../../../core/Logger ../../../core/maybe ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../core/sql/WhereClause ../../../layers/support/FeatureFilter ../../../layers/support/floorFilterUtils ../../../rest/support/Query ../../../support/featureFlags ./I3SMeshView3D ./II3SMeshView3D ./LayerView3D ./i3s/attributeEditing ./i3s/I3SGeometryUtil ./i3s/I3SMeshViewFilter ./i3s/I3SNode ./i3s/I3SQueryEngine ./i3s/I3SQueryFeatureAdapter ./i3s/I3SQueryFeatureStore ./i3s/I3SUtil ./support/DefinitionExpressionSceneLayerView ./support/fieldProperties ./support/PopupSceneLayerView ./support/SceneLayerViewRequiredFields ../support/updatingProperties ../../layers/SceneLayerView ../../support/Scheduler".split(" "),
function(u,g,A,B,c,v,h,p,T,C,D,E,F,q,w,f,r,G,t,H,x,y,I,J,K,z,L,M,N,O,P,Q,R){p=M.defineFieldProperties();f=function(m){function n(){var a=m.apply(this,arguments)||this;a.type="scene-layer-3d";a.progressiveLoadFactor=1;a._elevationContext="scene";a._isIntegratedMesh=!1;a._supportsLabeling=!0;a._interactiveEditingSessions=new Map;a._queryEngine=null;return a}u._inheritsLoose(n,m);var d=n.prototype;d.initialize=function(){this._fieldsHelper=new O.SceneLayerViewRequiredFields({layerView:this});this.updatingHandles.add(()=>
this.layer.rangeInfos,b=>this._rangeInfosChanged(b),v.initial);this.updatingHandles.add(()=>this.layer.renderer,b=>this.updatingHandles.addPromise(this._rendererChange(b)),v.initial);const a=()=>this._filterChange();this.updatingHandles.add(()=>this.parsedDefinitionExpression,a);this.updatingHandles.add(()=>this.filter,a);this.updatingHandles.add(()=>this._floorFilterClause,a);this.updatingHandles.add(()=>this._excludeObjectIdsSorted,a);this.updatingHandles.add(()=>c.isSome(this.viewFilter)?this.viewFilter.sortedObjectIds:
null,a);this.updatingHandles.add(()=>c.isSome(this.viewFilter)?this.viewFilter.parsedWhereClause:null,a);this.updatingHandles.add(()=>[c.isSome(this.viewFilter)?this.viewFilter.parsedGeometry:null,c.isSome(this.filter)?this.filter.spatialRelationship:null,c.isSome(this.layer.filter)?this.layer.filter.spatialRelationship:null],()=>this._geometryFilterChange());this.handles.add(this.layer.on("apply-edits",b=>this.updatingHandles.addPromise(b.result)));this.handles.add(this.layer.on("edits",b=>this._handleEdits(b)))};
d.destroy=function(){this._fieldsHelper=c.destroyMaybe(this._fieldsHelper)};d._rangeInfosChanged=function(a){null!=a&&0<a.length&&B.getLogger(this.declaredClass).warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")};d.createQuery=function(){const a={outFields:["*"],returnGeometry:!1,outSpatialReference:this.view.spatialReference};return c.isSome(this.filter)?this.filter.createQuery(a):new q(a)};d.queryExtent=function(a,b){return this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(a),
b?.signal)};d.queryFeatureCount=function(a,b){return this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(a),b?.signal)};d.queryFeatures=function(a,b){return this._ensureQueryEngine().executeQuery(this._ensureQuery(a),b?.signal).then(e=>{if(!e?.features)return e;const k=this.layer;for(const l of e.features)l.layer=k,l.sourceLayer=k;return e})};d.queryObjectIds=function(a,b){return this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(a),b?.signal)};d._ensureQueryEngine=function(){this._queryEngine||
(this._queryEngine=this._createQueryEngine());return this._queryEngine};d._createQueryEngine=function(){const a=H.createGetFeatureExtent(this.view.spatialReference,this.view.renderSpatialReference,this._collection);return new I.I3SQueryEngine({layerView:this,priority:R.TaskPriority.FEATURE_QUERY_ENGINE,spatialIndex:new K.I3SQueryFeatureStore({featureAdapter:new J.I3SQueryFeatureAdapter({objectIdField:this.layer.objectIdField,attributeStorageInfo:this.layer.attributeStorageInfo,getFeatureExtent:a}),
toArray:()=>{const b=[];this._forAllFeatures((e,k,l)=>{b.push({id:e,index:k,meta:l});return r.ForAllFeaturesReturnType.CONTINUE},null,r.ForAllFeaturesVisibilityMode.ALL_IN_CLIPPING_AREA);return b},forAllFeatures:(b,e)=>this._forAllFeatures((k,l,S)=>b({id:k,index:l,meta:S}),e,r.ForAllFeaturesVisibilityMode.ALL_IN_CLIPPING_AREA),getFeatureExtent:a,sourceSpatialReference:z.getIndexCrs(this.layer),viewSpatialReference:this.view.spatialReference})})};d.highlight=function(a){const b=this._highlights;if(a instanceof
q){const {set:e,handle:k}=b.acquireSet();this.queryObjectIds(a).then(l=>b.setFeatureIds(e,l));return k}return m.prototype.highlight.call(this,a)};d.createInteractiveEditSession=function(a){return t.createInteractiveEditSession(this._attributeEditingContext,a)};d._createLayerGraphic=function(a){a=new A(null,null,a);a.layer=this.layer;a.sourceLayer=this.layer;return a};d.canResume=function(){return m.prototype.canResume.call(this)&&(!this._controller||this._controller.rootNodeVisible)};d.getFilters=
function(){const a=m.prototype.getFilters.call(this),b=this._excludeObjectIdsSorted;c.isSome(b)&&a.push(e=>z.objectIdFilter(b,!1,e));this._floorFilterClause&&this.addSqlFilter(a,this._floorFilterClause,this.logError);this.addSqlFilter(a,this.parsedDefinitionExpression,this.logError);c.isSome(this.viewFilter)&&this.viewFilter.addFilters(a,this.view,this._controller.crsIndex,this._collection);return a};d.isUpdating=function(){return m.prototype.isUpdating.call(this)||this.layerFilterUpdating||c.isSome(this.viewFilter)&&
this.viewFilter.updating||c.isSome(this.i3sOverrides)&&this.i3sOverrides.updating};d._ensureQuery=function(a){return this._addDefinitionExpressionToQuery(c.isNone(a)?this.createQuery():q.from(a))};d._handleEdits=function(a){w.sceneLayerEditingEnabled()&&t.processGeometryEdits(this._attributeEditingContext,a);t.processAttributeEdits(this._attributeEditingContext,a)};d.computeNodeFiltering=function(a){const b=this.viewFilter;return c.isNone(b)||b.isMBSGeometryVisible(a,this.view.spatialReference,this._controller.crsIndex)?
y.NodeFilterImpact.Unmodified:y.NodeFilterImpact.Culled};u._createClass(n,[{key:"i3slayer",get:function(){return this.layer}},{key:"layerPopupEnabled",get:function(){return this.layer.popupEnabled}},{key:"filter",get:function(){return this._get("filter")},set:function(a){this._set("filter",x.I3SMeshViewFilter.checkSupport(a)?a:null)}},{key:"viewFilter",get:function(){const a=this.filter,b=this.layerFilter;if(c.isNone(a)&&c.isNone(b))return null;const e=this._get("viewFilter");if(c.isNone(e))return new x.I3SMeshViewFilter({layerFilter:b,
viewFilter:a,layerFieldsIndex:this.layer.fieldsIndex,loadAsyncModule:k=>this._loadAsyncModule(k),addSqlFilter:(k,l)=>this.addSqlFilter(k,l,this.logError)});e.viewFilter=a;e.layerFilter=b;return e}},{key:"requiredFields",get:function(){return this._fieldsHelper?.requiredFields??[]}},{key:"_floorFilterClause",get:function(){const a=F.getFloorFilterClause(this);return c.isSome(a)?D.WhereClause.create(a,this.layer.fieldsIndex):null}},{key:"_excludeObjectIdsSorted",get:function(){let a=this.layer.excludeObjectIds.toArray();
w.sceneLayerEditingEnabled()&&0<this.i3sOverrides.geometryChangedObjectIds.length&&(a=a.concat(this.i3sOverrides.geometryChangedObjectIds));return a.length?a.sort((b,e)=>b-e):null}},{key:"_objectQualitySettings",get:function(){return this.view?.qualitySettings?.sceneService?.object}},{key:"lodFactor",get:function(){return this._objectQualitySettings?.lodFactor??1}},{key:"lodCrossfadeinDuration",get:function(){return this._objectQualitySettings.lodCrossfadeinDuration??0}},{key:"lodCrossfadeoutDuration",
get:function(){return this._objectQualitySettings.lodCrossfadeoutDuration??0}},{key:"lodCrossfadeUncoveredDuration",get:function(){return this._objectQualitySettings.lodCrossfadeUncoveredDuration??0}},{key:"updatingProgressValue",get:function(){return this._controller?.updatingProgress??0}},{key:"_attributeEditingContext",get:function(){return{sessions:this._interactiveEditingSessions,fieldsIndex:this.layer.fieldsIndex,objectIdField:this._getObjectIdField(),forEachNode:a=>this._forAllNodes(b=>c.isSome(b)?
a(b.node,b.featureIds):null),attributeStorageInfo:this.i3slayer.attributeStorageInfo,i3sOverrides:this.i3sOverrides,getAttributeData:a=>this.getAttributeData(a),setAttributeData:(a,b)=>this.setAttributeData(a,b),clearMemCache:()=>this.clearMemCache()}}},{key:"hasGeometryFilter",get:function(){const a=this.viewFilter;return c.isSome(a)&&c.isSome(a.parsedGeometry)}}]);return n}(f.I3SMeshView3D(L.DefinitionExpressionSceneLayerView(N.PopupSceneLayerView(G.LayerView3D(Q)))));g.__decorate([h.property()],
f.prototype,"i3slayer",null);g.__decorate([h.property(P.updatingProgress)],f.prototype,"updatingProgress",void 0);g.__decorate([h.property({type:E})],f.prototype,"filter",null);g.__decorate([h.property({readOnly:!0})],f.prototype,"viewFilter",null);g.__decorate([h.property(p.requiredFields)],f.prototype,"requiredFields",null);g.__decorate([h.property(p.availableFields)],f.prototype,"availableFields",void 0);g.__decorate([h.property()],f.prototype,"_fieldsHelper",void 0);g.__decorate([h.property()],
f.prototype,"_floorFilterClause",null);g.__decorate([h.property()],f.prototype,"_excludeObjectIdsSorted",null);g.__decorate([h.property()],f.prototype,"_objectQualitySettings",null);g.__decorate([h.property()],f.prototype,"lodFactor",null);g.__decorate([h.property()],f.prototype,"updatingProgressValue",null);return f=g.__decorate([C.subclass("esri.views.3d.layers.SceneLayerView3D")],f)});