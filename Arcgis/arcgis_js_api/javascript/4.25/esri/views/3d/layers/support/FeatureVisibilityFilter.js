// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/asyncUtils ../../../../core/HandleOwner ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../layers/support/FeatureFilter ../../../../layers/support/floorFilterUtils ../graphics/QueryEngine ../../../support/Scheduler".split(" "),
function(b,n,e,q,r,t,c,u,v,f,C,D,w,x,y,z,A){b.FeatureVisibilityFilter=function(p){function m(g){var a=p.call(this,g)||this;a._updateTask=null;a._frameTask=null;a._queryEngine=null;a._updateRequested=!0;a._updateVisibility=function(){var h=n._asyncToGenerator(function*(d){if(c.isNone(a._compositedFeatureFilter)&&c.isNone(a._sceneFilter)||0===a.context.getFeatureCount())return a._frameTask.schedule(()=>a.clear(),d);try{const k=yield a._queryEngine.executeQueryForIdSet(a._compositedFeatureFilter,a._sceneFilter,
d);return a._frameTask.schedule(()=>{a.context.updateFeatureVisibilities(B=>k.has(B))},d)}catch(k){return u.throwIfAbortError(k),t.getLogger(a.declaredClass).warn(`FeatureFilter query failed: ${k}`,{error:k}),a._frameTask.schedule(()=>{a.context.setAllFeaturesVisibility(!0)},d)}});return function(d){return h.apply(this,arguments)}}();return a}n._inheritsLoose(m,p);var l=m.prototype;l.initialize=function(){const g=A.TaskPriority.FILTER_VISIBILITY,{layer:a,view:h}=this._layerView,{featureStore:d}=this.context;
this._queryEngine=new z.QueryEngine({context:{spatialReference:h.spatialReference,layer:a,scheduler:h.resourceController.scheduler,featureStore:d,hasM:"hasM"in this._layerView?this._layerView.hasM:!1,hasZ:"hasZ"in this._layerView?this._layerView.hasZ:!1},priority:g});this._frameTask=this._layerView.view.resourceController.scheduler.registerTask(g,this);this.updatingHandles.add(()=>[this._compositedFeatureFilter,this._sceneFilter],()=>this.reapply(),v.initial)};l.destroy=function(){this._updateRequested=
!1;this.handles.removeAll();this.updatingHandles.removeAll();this.clear();this._updateTask=c.abortMaybe(this._updateTask);this._frameTask=c.removeMaybe(this._frameTask);this._queryEngine=c.destroyMaybe(this._queryEngine);this._set("context",null)};l.reapply=function(){this._updateRequested=!0};l.clear=function(){this._queryEngine.clear();this.context.clearFeaturesVisibility()};l.runTask=function(g){this._updateRequested&&(this._updateTask=c.abortMaybe(this._updateTask),this._updateTask=q.createTask(this._updateVisibility),
this._updateRequested=!1,g.madeProgress());this._frameTask.processQueue(g)};n._createClass(m,[{key:"updating",get:function(){return this.running||this.updatingHandles.updating||c.isSome(this._updateTask)&&!this._updateTask.finished}},{key:"running",get:function(){return this._updateRequested||this._frameTask.updating}},{key:"defaultVisibility",get:function(){return c.isNone(this._compositedFeatureFilter)&&c.isNone(this._sceneFilter)}},{key:"_featureFilter",get:function(){return"filter"in this._layerView?
this._layerView.filter:null}},{key:"_sceneFilter",get:function(){return"layerFilter"in this._layerView?this._layerView.layerFilter:null}},{key:"_floorFilter",get:function(){return y.getFloorFilterClause(this._layerView)}},{key:"_timeExtent",get:function(){return"timeExtent"in this._layerView?this._layerView.timeExtent:null}},{key:"_compositedFeatureFilter",get:function(){const {_featureFilter:g,_timeExtent:a,_floorFilter:h}=this;if(c.isNone(a)&&c.isNone(h))return g;const d=c.isSome(g)?g.clone():new x;
c.isSome(a)&&(d.timeExtent=c.isSome(d.timeExtent)?d.timeExtent.intersection(a):a);if(c.isSome(h)){const k=c.isNone(d.where)||""===d.where;d.where=k?h:`(${d.where}) AND (${h})`}return d}},{key:"_layerView",get:function(){return this.context.layerView}}]);return m}(r.HandleOwner);e.__decorate([f.property({constructOnly:!0})],b.FeatureVisibilityFilter.prototype,"context",void 0);e.__decorate([f.property()],b.FeatureVisibilityFilter.prototype,"updating",null);e.__decorate([f.property()],b.FeatureVisibilityFilter.prototype,
"running",null);e.__decorate([f.property()],b.FeatureVisibilityFilter.prototype,"defaultVisibility",null);e.__decorate([f.property()],b.FeatureVisibilityFilter.prototype,"_featureFilter",null);e.__decorate([f.property()],b.FeatureVisibilityFilter.prototype,"_sceneFilter",null);e.__decorate([f.property()],b.FeatureVisibilityFilter.prototype,"_floorFilter",null);e.__decorate([f.property()],b.FeatureVisibilityFilter.prototype,"_timeExtent",null);e.__decorate([f.property()],b.FeatureVisibilityFilter.prototype,
"_compositedFeatureFilter",null);e.__decorate([f.property()],b.FeatureVisibilityFilter.prototype,"_layerView",null);e.__decorate([f.property()],b.FeatureVisibilityFilter.prototype,"_updateTask",void 0);e.__decorate([f.property()],b.FeatureVisibilityFilter.prototype,"_updateRequested",void 0);b.FeatureVisibilityFilter=e.__decorate([w.subclass("esri.views.3d.layers.support.FeatureVisibilityFilter")],b.FeatureVisibilityFilter);Object.defineProperties(b,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});