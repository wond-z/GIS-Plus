// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../geometry ../../../../core/Error ../../../../core/maybe ../../../../core/screenUtils ../../../../chunks/mat4f64 ../../../../chunks/vec4 ../../../../chunks/vec4f64 ../../../../geometry/support/aaBoundingBox ../../../../renderers/support/renderingInfoUtils ./ElevationAligners ./elevationAlignmentUtils ./ElevationContext ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./interfaces ./lineUtils ../support/FastSymbolUpdates ../../support/debugFlags ../../support/engineContent/line ../../support/engineContent/marker ../../support/renderInfoUtils/line ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/materials/LineMarkerMaterial ../../webgl-engine/materials/lineStippleUtils ../../webgl-engine/materials/RibbonLineMaterial ../../../../geometry/Extent ../../../../geometry/Polygon".split(" "),
function(K,D,E,N,e,w,F,O,G,l,P,Q,u,R,S,T,z,H,I,L,J,U,V,M,W,X,Y,Z,A,aa,ba){const ca=["polyline","polygon","extent"];E=function(t){function x(a,b,c,d){return t.call(this,a,b,c,d)||this}D._inheritsLoose(x,t);var f=x.prototype;f.doLoad=function(){var a=D._asyncToGenerator(function*(){this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}};this._fastUpdates=this._context.renderer&&
this._context.renderer.visualVariables&&0<this._context.renderer.visualVariables.length?L.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions):{enabled:!1};if(!this._drivenProperties.size&&0>(null!=this.symbolLayer.size?this.symbolLayer.size:w.px2pt(1)))throw new N("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");this._markerTexture=e.isSome(this.symbolLayer.marker)&&e.isSome(this._context.sharedResources.textures)?V.prepareMarkerResources(this._context.sharedResources.textures,
I.parseLineMarkerStyle(this.symbolLayer.marker.style)):null});return function(){return a.apply(this,arguments)}}();f._getMaterialParameters=function(a,b=!1){const c=this._getCombinedOpacityAndColor(b&&this._markerColor||this._materialColor);this._patternHidesLine&&!b&&(c[3]=0);a={width:this._computeMaterialWidth(this.symbolLayer?.size),color:c,hasPolygonOffset:!0,join:this.symbolLayer.join||"miter",cap:I.parseCapType(this.symbolLayer.cap||"butt"),hasSlicePlane:this._context.slicePlaneEnabled,isClosed:a,
stipplePattern:Z.getStipplePatternForLinePattern(this.symbolLayer.pattern),stippleScaleWithLineWidth:!0};return this._fastUpdates&&this._fastUpdates.visualVariables?{...a,...this._fastUpdates.materialParameters}:a};f.destroy=function(){t.prototype.destroy.call(this);this._forEachMaterial(a=>this._context.stage.remove(a));this._markerMaterialCached=this._wireframeRingMaterialCached=this._wireframeLineMaterialCached=this._ringMaterialCached=this._lineMaterialCached=null;this._markerTexture=e.releaseMaybe(this._markerTexture)};
f._getDrivenSize=function(a){return this._drivenProperties.size&&a.size?w.pt2px(P.getDriverAxisSizeValueAny(a.size)):1};f._getSizeFeatureAttributeData=function(a){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?z.getAttributeValue(this._fastUpdates.visualVariables.size.field,a):null};f._getDrivenColor=function(a){const b=G.fromValues(1,1,1,1);this._drivenProperties.color&&a.color&&(b[0]=a.color[0],b[1]=a.color[1],b[2]=a.color[2],0<a.color.length&&(b[3]=a.color[3]));this._drivenProperties.opacity&&
a.opacity&&(b[3]=a.opacity);return b};f._getColorFeatureAttributeData=function(a){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?z.getAttributeValue(this._fastUpdates.visualVariables.color.field,a):null};f._getOpacityFeatureAttributeData=function(a){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity?z.getAttributeValue(this._fastUpdates.visualVariables.opacity.field,a):null};f.createGraphics3DGraphic=function(a){const b=a.graphic;if(!this._validateGeometry(b.geometry,
ca,this.symbolLayer.type))return null;const c=this.setGraphicElevationContext(b,new R.ElevationContext);this.ensureDrapedStatus("on-the-ground"===c.mode);return this.draped?this._createAsOverlay(a,this._context.layer.uid):this._createAs3DShape(a,c,b.uid)};f.applyRendererDiff=function(a,b){for(const c in a.diff)switch(c){case "visualVariables":if(L.updateFastSymbolUpdatesState(this._fastUpdates,b,this._vvConvertOptions))this._forEachMaterial(d=>d.setParameters(this._fastUpdates.materialParameters));
else return H.ApplyRendererDiffResult.Recreate_Symbol;break;default:return H.ApplyRendererDiffResult.Recreate_Symbol}return H.ApplyRendererDiffResult.Fast_Update};f.prepareSymbolLayerPatch=function(a){if("partial"===a.diff.type){var b=a.diff.diff,c={};"complete"===b.size?.type&&(c.width=this._computeMaterialWidth(b.size.newValue),delete b.size);"complete"===b.cap?.type&&(c.cap=I.parseCapType(e.unwrapOr(b.cap.newValue,"butt")),delete b.cap);var d=this._prepareMarkerPatch(a,b);this._prepareMaterialPatch(a,
b,d);a.symbolLayerStatePatches.push(()=>this._forEachMaterial(g=>g.setParameters(c)))}};f.layerOpacityChanged=function(){this._forEachMaterial((a,b)=>this._updateMaterialLayerOpacity(a,b))};f._forEachMaterial=function(a){e.isSome(this._lineMaterialCached)&&a(this._lineMaterialCached);e.isSome(this._ringMaterialCached)&&a(this._ringMaterialCached);e.isSome(this._wireframeLineMaterialCached)&&a(this._wireframeLineMaterialCached);e.isSome(this._wireframeRingMaterialCached)&&a(this._wireframeRingMaterialCached);
e.isSome(this._markerMaterialCached)&&a(this._markerMaterialCached,!0)};f._updateMaterialLayerOpacity=function(a,b=!1){var c=a.parameters.color;const d=e.get(this.symbolLayer,"material","color");b=this._patternHidesLine&&!b?0:this._getCombinedOpacity(d);c=G.fromValues(c[0],c[1],c[2],b);a.setParameters({color:c})};f.layerElevationInfoChanged=function(a,b,c){const d=this._elevationContext.mode;c=u.elevationModeChangeUpdateType(x.elevationModeChangeTypes,c,d);if(c!==u.SymbolUpdateType.UPDATE)return c;
const g=u.needsElevationUpdates2D(d);return this.updateGraphics3DGraphicElevationInfo(a,b,()=>g)};f.slicePlaneEnabledChanged=function(){const a={hasSlicePlane:this._context.slicePlaneEnabled};this._forEachMaterial(b=>b.setParameters(a));return!0};f.physicalBasedRenderingChanged=function(){return!0};f.pixelRatioChanged=function(){return!0};f._getGeometryAsPolygonOrPolyline=function(a){switch(a.type){case "extent":if(a instanceof aa)return ba.fromExtent(a);break;case "polygon":case "polyline":return a}return null};
f._createAs3DShape=function(a,b,c){const d=this._getGeometryAsPolygonOrPolyline(a.graphic.geometry);var g="polygon"===d.type?d.rings:d.paths,h=[];const n=[],m=[],v=l.create(),k=M.geometryToRenderInfo(d,this._context.elevationProvider,this._context.renderCoordsHelper,b);this._logGeometryCreationWarnings(k,g,"polygon"===d.type?"rings":"paths","LineSymbol3DLayer");for(g=0;g<k.lines.length;g++){const {position:B,mapPosition:p}=k.lines[g];if(e.isSome(this._context.clippingExtent)&&(l.empty(v),l.expandWithBuffer(v,
p),!l.intersectsClippingArea(v,this._context.clippingExtent)))continue;const q=this._createGeometry(a,B,p,d.type,y.ELEVATED,c);h.push(q);n.push("polygon"===d.type?this._ringMaterial:this._lineMaterial);m.push(F.IDENTITY);J.LINE_WIREFRAMES&&(h.push(q.cloneShallow()),n.push("polygon"===d.type?this._wireframeRingMaterial:this._wireframeLineMaterial),m.push(F.IDENTITY));const C=this._markerMaterial;e.isSome(C)&&(h.push(q.cloneShallow()),n.push(C),m.push(F.IDENTITY))}if(0===h.length)return null;a=new W.Object3D({geometries:h,
materials:n,transformations:m,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:c}});h=new T.Graphics3DObject3DGraphicLayer(this,a,h,null,null,Q.sharedGeometryElevationAligner,b);h.alignedSampledElevation=k.sampledElevation;h.needsElevationUpdates=u.needsElevationUpdates2D(b.mode);return h};f._createGeometry=function(a,b,c,d,g,h){d="polygon"===d;const n=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color,m=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size;
h=this._context.stage.renderView._getObjectAndLayerIdColor({graphicUid:h,layerUid:this._context.layer.uid});return U.createGeometry({overlayInfo:g===y.DRAPED?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,removeDuplicateStartEnd:d,attributeData:{position:b,mapPosition:c,size:m?null:this._getDrivenSize(a.renderingInfo),color:n?null:this._getDrivenColor(a.renderingInfo),sizeFeature:this._getSizeFeatureAttributeData(a.graphic),colorFeature:this._getColorFeatureAttributeData(a.graphic),
opacityFeature:this._getOpacityFeatureAttributeData(a.graphic)}},h)};f._createAsOverlay=function(a,b){const c=a.graphic,d=this._getGeometryAsPolygonOrPolyline(c.geometry);var g="polygon"===d.type?d.rings:d.paths;const h="polygon"===d.type?this._ringMaterial:this._lineMaterial;h.renderPriority=this._renderPriority;const n=J.LINE_WIREFRAMES?"polygon"===d.type?this._wireframeRingMaterial:this._wireframeLineMaterial:null,m=this._markerMaterial;e.isSome(n)&&(n.renderPriority=this._renderPriority-.001);
e.isSome(m)&&(m.renderPriority=this._renderPriority-.002);const v=[],k=l.create(),B=l.empty();var p=M.geometryToRenderInfoDraped(d,this._context.overlaySR);this._logGeometryCreationWarnings(p,g,"polygon"===d.type?"rings":"paths","LineSymbol3DLayer");for(const q of p.lines){l.empty(k);l.expandWithBuffer(k,q.position);if(!l.intersectsClippingArea(k,this._context.clippingExtent))continue;l.expandWithAABB(B,k);const C=this._createGeometry(a,q.position,null,d.type,y.DRAPED,c.uid);g=r=>{r=new X.RenderGeometry(C,
r,{layerUid:b,graphicUid:c.uid});v.push(r);return r};if(e.isSome(m)){p=g(m);const r=e.unwrap(this.symbolLayer.marker).placement;"begin"!==r&&"begin-end"!==r||l.expandWithBuffer(k,q.position,0,1);"end"!==r&&"begin-end"!==r||l.expandWithBuffer(k,q.position,q.position.length-3,1);this._updateBoundingSphere(p,k)}p=g(h);this._updateBoundingSphere(p,k);J.LINE_WIREFRAMES&&(g=g(n),this._updateBoundingSphere(g,k))}return new S(this,v,B,this._context.drapeSourceRenderer)};f._updateBoundingSphere=function(a,
b){O.set(a.boundingSphere,.5*(b[0]+b[3]),.5*(b[1]+b[4]),0,.5*Math.sqrt((b[3]-b[0])*(b[3]-b[0])+(b[4]-b[1])*(b[4]-b[1])))};f._computeMaterialWidth=function(a){a=e.unwrapOr(a,w.px2pt(1));return this._drivenProperties.size?this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?w.pt2px(1):1:w.pt2px(a)};f._prepareMaterialPatch=function(a,b,c){var d=b.material;e.isNone(d)?c.changed&&c.useMaterialColor&&this._patchMaterialColor(this._getCombinedOpacityAndColor(this._materialColor),this._markerMaterialCached,
a):"collection"!==d.type&&(d="complete"===d.type?e.applySome(d.newValue,g=>g.color):"complete"===d.diff.color.type?d.diff.color.newValue:null,d=this._getCombinedOpacityAndColor(d),c.useMaterialColor&&this._patchMaterialColor(G.clone(d),this._markerMaterialCached,a),this._patternHidesLine&&(d[3]=0),this._patchMaterialColor(d,this._lineMaterialCached,a),delete b.material)};f._prepareMarkerPatch=function(a,b){var c=b.marker;if(e.isNone(c)||"partial"!==c.type||e.isSome(c.diff.style)||e.isSome(c.diff.placement)||
e.isSome(c.diff.color)&&"complete"!==c.diff.color.type)return{changed:!1,useMaterialColor:e.isNone(this._markerColor)};c=c.diff.color;if(e.isNone(c))return delete b.marker,{changed:!1,useMaterialColor:e.isNone(this._markerColor)};c=e.unwrap(c.newValue);if(e.isNone(c))return delete b.marker,{changed:!0,useMaterialColor:!0};this._patchMaterialColor(this._getCombinedOpacityAndColor(c),this._markerMaterialCached,a);delete b.marker;return{changed:!0,useMaterialColor:!1}};f._patchMaterialColor=function(a,
b,c){e.isNone(b)||c.symbolLayerStatePatches.push(()=>b.setParameters({color:a}))};D._createClass(x,[{key:"_materialColor",get:function(){return e.applySome(this.symbolLayer.material,a=>a.color)}},{key:"_markerColor",get:function(){return e.applySome(this.symbolLayer.marker,a=>a.color)}},{key:"_lineMaterial",get:function(){e.isNone(this._lineMaterialCached)&&(this._lineMaterialCached=new A.RibbonLineMaterial(this._getMaterialParameters(!1)),this._context.stage.add(this._lineMaterialCached));return this._lineMaterialCached}},
{key:"_ringMaterial",get:function(){e.isNone(this._ringMaterialCached)&&(this._ringMaterialCached=new A.RibbonLineMaterial(this._getMaterialParameters(!0)),this._context.stage.add(this._ringMaterialCached));return this._ringMaterialCached}},{key:"_wireframeLineMaterial",get:function(){e.isNone(this._wireframeLineMaterialCached)&&(this._wireframeLineMaterialCached=new A.RibbonLineMaterial({...this._getMaterialParameters(!1),wireframe:!0}),this._context.stage.add(this._wireframeLineMaterialCached));
return this._wireframeLineMaterialCached}},{key:"_wireframeRingMaterial",get:function(){e.isNone(this._wireframeRingMaterialCached)&&(this._wireframeRingMaterialCached=new A.RibbonLineMaterial({...this._getMaterialParameters(!0),wireframe:!0}),this._context.stage.add(this._wireframeRingMaterialCached));return this._wireframeRingMaterialCached}},{key:"_markerMaterial",get:function(){e.isNone(this._markerMaterialCached)&&e.isSome(this.symbolLayer.marker)&&e.isSome(this._markerTexture)&&(this._markerMaterialCached=
new Y.LineMarkerMaterial({...this._getMaterialParameters(!1,!0),placement:this.symbolLayer.marker.placement,textureId:this._markerTexture.texture.id}),this._context.stage.add(this._markerMaterialCached));return this._markerMaterialCached}},{key:"_patternHidesLine",get:function(){const a=this.symbolLayer.pattern;return e.isSome(a)&&"style"===a.type&&"none"===a.style}}]);return x}(z.Graphics3DSymbolLayer);E.elevationModeChangeTypes={definedChanged:u.SymbolUpdateType.RECREATE,staysOnTheGround:u.SymbolUpdateType.NONE,
onTheGroundChanged:u.SymbolUpdateType.RECREATE};var y;(function(t){t[t.DRAPED=0]="DRAPED";t[t.ELEVATED=1]="ELEVATED"})(y||(y={}));K.Graphics3DLineSymbolLayer=E;Object.defineProperties(K,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});