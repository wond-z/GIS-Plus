// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/Error ../../../../core/mathUtils ../../../../core/maybe ../../../../chunks/mat2 ../../../../chunks/vec2 ../../../../chunks/vec2f64 ../../../../chunks/vec3 ../../../../chunks/vec3f32 ../../../../chunks/vec3f64 ../../../../geometry/projection ../../../../geometry/support/aaBoundingBox ../../../../layers/graphics/dehydratedFeatures ./elevationAlignmentUtils ./ElevationContext ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ./interfaces ../support/FastSymbolUpdates ../../webgl-engine/lib/basicInterfaces ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/PathGeometry ../../webgl-engine/lib/pathGeometryUtils ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/materials/PathMaterial".split(" "),
function(C,O,da,H,B,ea,P,Q,n,R,S,T,F,U,D,fa,ha,G,V,I,W,X,ia,Y,k,ja,ka){function Z(f,w,l){switch(w){case "world":for(const a of f.vertices)n.add(y,a.pos,f.offset),l.worldUpAtPosition(y,v),a.setFrameFromUpVector(v),a.computeRotationAxisAndAngleFromUpVector();break;case "path":n.add(y,f.vertices[0].pos,f.offset);l.worldUpAtPosition(y,v);k.computeMinimumRotationTangentFrame(f,v);for(const a of f.vertices)f=Math.sign(n.dot(a.frame.right,a.vRight)),n.cross(a.rotationFrame.up,a.vRight,a.vLeft),n.scale(a.rotationFrame.up,
a.rotationFrame.up,f),n.normalize(a.rotationFrame.up,a.rotationFrame.up),w=n.dot(a.rotationFrame.up,a.frame.up),l=n.dot(a.rotationFrame.up,a.frame.right),n.scale(y,a.frame.up,-l),n.scale(aa,a.frame.right,w),n.add(y,y,aa),n.normalize(a.rotationFrame.right,y),k.vertexSpaceToProfileSpace(a.rotationRight,a.frame,a.rotationFrame.right),n.negate(y,a.vLeft),a.rotationAngle=-f*(Math.PI-H.acosClamped(n.dot(y,a.vRight))),0<Math.abs(a.rotationAngle)&&(f=H.reciprocalClamped(Math.cos(.5*a.rotationAngle)),ea.set(a.miterStretch,
1+(f-1)*a.rotationRight[0]*a.rotationRight[0],(f-1)*a.rotationRight[0]*a.rotationRight[1],(f-1)*a.rotationRight[0]*a.rotationRight[1],1+(f-1)*a.rotationRight[1]*a.rotationRight[1])),a.maxStretchDistance=Math.abs(Math.min(a.vLeftLength,a.vRightLength)*H.reciprocalClamped(Math.cos(.5*(Math.PI-a.rotationAngle))))}}function ba(f,w,l){switch(f){case "symbol-value":return l;case "proportional":return w;default:return f}}function la(f,w,l,a){f=f.stageObject;const b=f.geometryRecords;var h=0;ma.spatialReference=
a.spatialReference;for(const r of b){const q=r.geometry;if(!Y.isPathGeometry(q))continue;const z=q.path,A=z.builder.path;ca.spatialReference=q.geometrySR;var d=A,g=w,c=l,x=a;let m=0;for(const e of d.vertices)D.evaluateElevationInfoAtPoint(e.posES,c,g,x,J),m+=J.sampledElevation,n.add(v,e.pos,d.offset),x.setAltitude(v,J.z),n.subtract(e.pos,v,d.offset);d.updatePathVertexInformation();h+=m/d.vertices.length;"world"!==q.upVectorAlignment&&Z(A,q.upVectorAlignment,a);z.onPathChanged();q.invalidateBoundingInfo();
f.geometryVertexAttrsUpdated(r)}return h/b.length}const na=["polyline"];let qa=function(f){function w(a,b,h,d){a=f.call(this,a,b,h,d)||this;a._intrinsicSize=Q.fromValues(1,1);a._upVectorAlignment="path";a._stencilWidth=.1;a.ensureDrapedStatus(!1);return a}O._inheritsLoose(w,f);var l=w.prototype;l.doLoad=function(){var a=O._asyncToGenerator(function*(){var b=B.isSome(this.symbolLayer.width)?this.symbolLayer.width:this.symbolLayer.height;const h=B.isSome(this.symbolLayer.height)?this.symbolLayer.height:
b;this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[b,1,h],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}};this._fastUpdates=this._context.renderer&&this._context.renderer.visualVariables&&0<this._context.renderer.visualVariables.length?W.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions):{enabled:!1};var d=this.symbolLayer.anchor||"center";
this._upVectorAlignment="path";"heading"===this.symbolLayer.profileRotation&&(this._upVectorAlignment="world");var g=this.symbolLayer.profile||"circle";switch(g){default:this._profile=k.Profile.circle(10);break;case "quad":this._profile=k.Profile.rect()}var c=[0,0];"center"!==d&&(c={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[d],this._profile.translate(c[0],c[1]));switch(this.symbolLayer.join||"simple"){case "round":this._extruder=new k.MiterExtruder(0,3);break;case "bevel":this._extruder=
new k.MiterExtruder(0,1);break;case "miter":this._extruder=new k.MiterExtruder(.8*Math.PI,1);break;default:this._extruder=new k.SimpleExtruder}d=this.symbolLayer.cap||"butt";switch(d){case "none":this._startCap=new k.NoCapBuilder;this._endCap=new k.NoCapBuilder;break;default:this._startCap=new k.TriangulationCapBuilder(this._profile,0);this._endCap=new k.TriangulationCapBuilder(this._profile,0,!0);break;case "square":this._startCap=new k.TriangulationCapBuilder(this._profile,-.5);this._endCap=new k.TriangulationCapBuilder(this._profile,
.5,!0);break;case "round":g="quad"===g?!0:!1,this._startCap=new k.RoundCapBuilder({profile:this._profile,flip:!1,breakNormals:g,subdivisions:3}),this._endCap=new k.RoundCapBuilder({profile:this._profile,flip:!0,breakNormals:g,subdivisions:3})}g=B.get(this.symbolLayer,"material","color");c=this._getCombinedOpacityAndColor(g);g=S.fromArray(c);c=c[3];const x=1>c||this.needsDrivenTransparentPass;d={diffuse:g,ambient:g,opacity:c,transparent:x,hasVertexColors:!1,hasSlicePlane:this._context.slicePlaneEnabled,
castShadows:this.symbolLayer.castShadows,cullFace:x||"none"===d?X.CullFaceOptions.None:X.CullFaceOptions.Back,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(P.set(this._intrinsicSize,b,h),!V.isValidSize(this._intrinsicSize[0])||!V.isValidSize(this._intrinsicSize[1])))throw new da("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||P.scale(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters);
this._fastUpdates.enabled?(b={...d,...this._fastUpdates.materialParameters,size:Q.fromArray(this._intrinsicSize)},this._material=new ka.PathMaterial(b)):(d.hasVertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new ja.DefaultMaterial(d));this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0});this._context.stage.add(this._material)});return function(){return a.apply(this,arguments)}}();l.destroy=function(){f.prototype.destroy.call(this);
this._context.stage.remove(this._material);this._material=null};l.createGraphics3DGraphic=function(a){const b=a.graphic;if(!this._validateGeometry(b.geometry,na,this.symbolLayer.type))return null;const h=this.setGraphicElevationContext(b,new fa.ElevationContext);return this._createAs3DShape(b,a.renderingInfo,h,b.uid)};l.layerOpacityChanged=function(){var a=B.get(this.symbolLayer,"material","color");a=this._getCombinedOpacity(a);this._material.setParameters({opacity:a,transparent:1>a||this.needsDrivenTransparentPass})};
l.layerElevationInfoChanged=function(a,b){return this.updateGraphics3DGraphicElevationInfo(a,b,D.needsElevationUpdates3D)};l.slicePlaneEnabledChanged=function(){this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0};l.physicalBasedRenderingChanged=function(){this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0});return!0};l.pixelRatioChanged=function(){return!0};l.applyRendererDiff=function(a,b){for(const h in a.diff)switch(h){case "visualVariables":if(W.updateFastSymbolUpdatesState(this._fastUpdates,
b,this._vvConvertOptions))this._material.setParameters(this._fastUpdates.materialParameters);else return I.ApplyRendererDiffResult.Recreate_Symbol;break;default:return I.ApplyRendererDiffResult.Recreate_Symbol}return I.ApplyRendererDiffResult.Fast_Update};l.getVertexData=function(a){let b=0;const h=a.paths,d=[],g=a.spatialReference,c=this._context.elevationProvider.spatialReference,x=this._context.renderCoordsHelper.spatialReference;for(var r of h)b+=r.length;r=new Float64Array(3*b);const q=new Float64Array(3*
b),z=new Float64Array(3*b);let A=0;for(const m of h){d.push({index:A,numVertices:m.length});for(const e of m)r[A++]=e[0],r[A++]=e[1],r[A++]=a.hasZ?e[2]:0}a=!0;B.isSome(c)&&!g.equals(c)?a=T.projectBuffer(r,g,0,q,c,0,b):this._copyVertices(r,0,q,0,b);B.isSome(c)&&!c.equals(x)?T.projectBuffer(q,c,0,z,x,0,b):this._copyVertices(q,0,z,0,b);return{pathVertexDataInfos:d,vertexDataGS:r,vertexDataES:q,vertexDataRS:z,projectionSuccess:a,terrainElevation:0}};l._copyVertices=function(a,b,h,d,g){b*=3;d*=3;for(let c=
0;c<g;++c)h[d++]=a[b++],h[d++]=a[b++],h[d++]=a[b++]};l._createAs3DShape=function(a,b,h,d){var g=a.geometry,c=[];const x=[],r=[],q=g.spatialReference,z=F.create(),A=this._context.renderCoordsHelper;ca.spatialReference=q;const m=this.getVertexData(g);if(!m.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(0<m.pathVertexDataInfos.length){for(g=0;g<m.pathVertexDataInfos.length;++g){var e=m.pathVertexDataInfos[g],
p=e.index;e=e.numVertices;if(2>e)continue;if(B.isSome(this._context.clippingExtent)&&(F.empty(z),F.expandWithBuffer(z,m.vertexDataES,3*p,e),!F.intersectsClippingArea(z,this._context.clippingExtent)))continue;var t=[];for(var u=p;u<p+3*e;){const K=u++,L=u++,M=u++,E=new k.PathVertex;n.set(E.posGS,m.vertexDataGS[K],m.vertexDataGS[L],m.vertexDataGS[M]);n.set(E.posES,m.vertexDataES[K],m.vertexDataES[L],m.vertexDataES[M]);const oa=D.evaluateElevationAlignmentAtPoint(E.posES,this._context.elevationProvider,
h,A);n.set(v,m.vertexDataRS[K],m.vertexDataRS[L],m.vertexDataRS[M]);A.setAltitude(v,oa);n.set(E.pos,v[0],v[1],v[2]);t.push(E)}p=new k.Path(t);Z(p,this._upVectorAlignment,this._context.renderCoordsHelper);p=new k.Builder(p,this._profile,this._extruder,this._startCap,this._endCap);e=null;this._fastUpdates.enabled?(u=this._fastUpdates.visualVariables,e=u.size?G.getAttributeValue(u.size.field,a):0,t=u.color?G.getAttributeValue(u.color.field,a):0,u=u.opacity?G.getAttributeValue(u.opacity.field,a):0,e=
new k.FastUpdatePathGeometry(p,e,t,u)):(e=[this._intrinsicSize[0],this._intrinsicSize[1]],this._drivenProperties.size&&(e[0]*=ba(b.size[0],"symbol-value"===b.size[2]?this.symbolLayer.height||0:b.size[2],this.symbolLayer.width||0),e[1]*=ba(b.size[2],"symbol-value"===b.size[0]?this.symbolLayer.width||0:b.size[0],this.symbolLayer.height||0)),t=null,this._drivenProperties.color&&(t=b.color),this._drivenProperties.opacity&&null!=b.opacity&&(t=t?[t[0],t[1],t[2],b.opacity]:[1,1,1,b.opacity]),p=new k.StaticPathGeometry(p),
p.bake(e),t&&p.bakeVertexColors(t),e=p);const {vertexAttributes:N,indices:pa}=e.createGeometryData();p=this._context.stage.renderView._getObjectAndLayerIdColor({graphicUid:d,layerUid:this._context.layer.uid});p=new Y.PathGeometry(N,pa,e,q,this._upVectorAlignment,this._stencilWidth,p);c.push(p);x.push(this._material);r.push(e.xform)}if(0<c.length)return a=new ia.Object3D({geometries:c,materials:x,transformations:r,metadata:{layerUid:this._context.layer.uid,graphicUid:d}}),c=new ha.Graphics3DObject3DGraphicLayer(this,
a,c,null,null,la,h),c.alignedSampledElevation=m.terrainElevation,c.needsElevationUpdates=D.needsElevationUpdates3D(h.mode),c}else 0!==g.paths.length&&g.paths.some(N=>0<N.length)||this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)");return null};return w}(G.Graphics3DSymbolLayer);const ma=U.makeDehydratedPoint(0,0,0,null),ca=U.makeDehydratedPoint(0,0,0,null),v=S.create(),y=R.create(),aa=R.create(),J=new D.SampleElevationInfo;C.Graphics3DPathSymbolLayer=qa;C.NUM_CIRCLE_PROFILE_SUBDIVISIONS=
10;C.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS=3;C.NUM_ROUND_JOIN_SUBDIVISIONS=3;Object.defineProperties(C,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});