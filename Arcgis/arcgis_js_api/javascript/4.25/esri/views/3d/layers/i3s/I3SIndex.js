// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../core/PooledArray ../../../../core/promiseUtils ../../../../chunks/vec3 ../../../../chunks/vec4f64 ./I3SNode ./I3SUtil ../../support/orientedBoundingBox".split(" "),function(B,L,e,z,E,M,F,q,v,G){function H(p){e.isSome(p.node)&&(v.invalidateMbs(p.node.renderMbs),v.invalidateObb(p.node.serviceObbInRenderSR));e.isSome(p.ref)&&(v.invalidateMbs(p.ref.renderMbs),v.invalidateObb(p.ref.serviceObbInRenderSR))}function C(p,
h){return 0===h?0:p/h|0}function A(p,h){return 0===h?p:p%h}function I(p){if(p)for(let h=0;h<p.length;h++)for(const a of N)if(a[0]===p[h].metricType)return{lodMetric:a[1],maxError:p[h].maxError};return{lodMetric:q.LodMetric.None,maxError:0}}function O(p){return Math.sqrt(4/Math.PI*p)}let J=function(p,h,a,b,c){this.childOffset=p;this.childCount=h;this.visibilityCache=a;this.ref=b;this.node=c;this.useAsHole=0;this.filterImpact=q.NodeFilterImpact.NotChecked},Q=function(){function p(a,b,c,f,d,g,n,r,t,
k,l,x,m,w){this._streamDataController=c;this._viewportQueries=f;this._logger=d;this.holeFilling=g;this._isLoaded=n;this._isReloading=r;this._isSelected=t;this._enable=k;this._needsUpdate=l;this._canRequest=x;this._computeVisibilityObb=m;this._computeNodeFiltering=w;this._dirty=!0;this._nodePages=[];this._rootIndex=this._nodesPerPage=this._nodeCount=0;this._lodMetric=q.LodMetric.None;this._lodConversion=y=>y;this._urlPrefix="";this._loading=new Set;this._failedNodes=new Set;this._failedPages=new Set;
this._indexMissing=1;this._maxUnloadedPrio=Number.NEGATIVE_INFINITY;this._maxProcessingPrio=Number.POSITIVE_INFINITY;this._nodeTraversalState=new Map;this._version=v.addWraparound(0,2);this._visibilityCacheVersion=v.addWraparound(0,2);this._maxLevel=1;this._featureEstimate={estimate:0,leavesReached:!1};this._unloadedMemoryEstimate=0;this._missing=new z({deallocator:null});this._prefetch=new z({deallocator:null});this._updates=new P(this._missing);this._imModificationUncategorized=new z({deallocator:null});
this.ignoreServiceObb=!1;this.progressiveLoadPenalty=0;this._pageQueue=[];this._layerHasFilter=this.layerHasModifications=this.needNodeElevationRange=!1;this._logLayer=a;a.serviceUpdateTimeStamp&&a.serviceUpdateTimeStamp.lastUpdate&&(this._lastUpdate=`${a.serviceUpdateTimeStamp.lastUpdate}`);this._maxLodLevel=this._viewportQueries?this._viewportQueries.maxLodLevel:1;this._init(b)}var h=p.prototype;h._init=function(a){if("page"===a.type){this._urlPrefix=a.urlPrefix;this._nodesPerPage=a.pageSize;this._rootIndex=
a.rootIndex;switch(a.lodMetric){case "maxScreenThreshold":this._lodMetric=q.LodMetric.MaxScreenThreshold;break;case "maxScreenThresholdSQ":this._lodMetric=q.LodMetric.MaxScreenThreshold,this._lodConversion=O}this._addPage(C(this._rootIndex,this._nodesPerPage),a.rootPage);this._updateParentsAndLevel()}else"node"===a.type&&(this._urlPrefix=a.urlPrefix,this._nodePages.push({nodes:[],children:[],parents:[]}),this._makeRefNode(new q.NodeBase(a.rootNode.id,null),-1),(a=this._validateNode(a.rootNode.id,
a.rootNode))&&this._addNode(a,0))};h._loadPage=function(a){this._loading.add(a);this._streamDataController.request(this._urlPrefix+a,"json").then(b=>{this._pageQueue.push({pageIndex:a,page:b})}).catch(b=>{this._loading.delete(a);E.isAbortError(b)||(this._failedPages.add(a),this._logger.error("#loadPage()",this._logLayer,`Error when loading page ${a}`,b))})};h._addQueuedPages=function(a){for(;0<this._pageQueue.length&&!a.done;){const {pageIndex:b,page:c}=this._pageQueue.shift();this._addPage(b,c);
this._loading.delete(b);a.madeProgress()}this._updateParentsAndLevel()};h._addPage=function(a,b){for(let d=this._nodePages.length;d<a;d++)this._nodePages[d]=null;const c=[],f=[];b=b.nodes.map((d,g)=>{const n=c.length,r=d.children?d.children.length:0;f.push(-1);for(var t=0;t<r;t++)c.push(d.children[t]);const k=`${d.index}`;t=G.clone(d.obb);const l=F.fromArray([t.center[0],t.center[1],t.center[2],M.length(t.halfSize)]),x=d.mesh&&d.mesh.attribute,m=d.mesh&&d.mesh.geometry,w=d.mesh&&d.mesh.material;d=
new q.Node(k,a*this._nodesPerPage+g,l,r,0,{hasSharedResource:!1,hasFeatureData:!!m,attributes:x&&null!=x.resource?`${x.resource}`:null,geometry:m&&null!=m.resource?`${m.resource}`:null,texture:w&&null!=w.resource?`${w.resource}`:null,geometryDefinition:m?m.definition:-1,materialDefinition:w?w.definition:-1},this._lastUpdate,this._lodMetric,this._lodConversion(d.lodThreshold),m?m.featureCount:null);d.serviceObb=t;d.visibilityObb=this._computeVisibilityObb(d);d.vertexCount=m?m.vertexCount:0;return new J(n,
r,v.addWraparound(this._visibilityCacheVersion,-2),null,d)});this._nodePages[a]={nodes:b,children:c,parents:f};this._nodeCount+=b.length};h._updateParentsAndLevel=function(){const a=[],b=(c,f,d)=>{const g=this._getPage(c);if(e.isSome(g)){const n=A(c,this._nodesPerPage);g.parents[n]=f;f=g.nodes[n].node;e.isSome(f)&&(f.level=d,a.push(c))}};for(b(this._rootIndex,-1,0);a.length;){const c=a.pop(),f=this.getNode(c);if(e.isSome(f))for(let d=0;d<f.childCount;d++){const g=this.getChildIndex(f.index,d);b(g,
c,f.level+1);this._maxLevel=Math.max(this._maxLevel,f.level+1)}}};h._getPage=function(a){return this._nodePages[C(a,this._nodesPerPage)]};h._getNodeInternal=function(a){const b=this._getPage(a);return e.isNone(b)?null:b.nodes[A(a,this._nodesPerPage)]};h._addNode=function(a,b){null!=a.children&&this.populateChildren(b,a.children);var c=this.getParent(b);c=e.isSome(c)?c.level+1:0;this._maxLevel=Math.max(this._maxLevel,a.children?c+1:c);const {lodMetric:f,maxError:d}=I(a.lodSelection),g=e.unwrap(this._getNodeInternal(b));
g.node=new q.Node(a.id,b,F.fromArray(a.mbs),g.childCount,c,a.resources,a.version,f,d,a.numFeatures);a.obb&&(g.node.serviceObb=G.clone(a.obb));g.node.visibilityObb=this._computeVisibilityObb(g.node);e.isSome(g.ref)&&(null==g.ref.mbs&&(g.ref.mbs=a.mbs),g.node.renderMbs=g.ref.renderMbs,g.node.serviceObbInRenderSR=g.ref.serviceObbInRenderSR,g.ref.visibilityObb=g.node.visibilityObb);return g.node};h._makeRefNode=function(a,b){const c=this._nodePages[0],f=c.nodes.length;c.nodes.push(new J(0,0,v.addWraparound(this._visibilityCacheVersion,
-2),a,null));this._nodeCount++;c.parents.push(b);v.invalidateMbs(a.renderMbs);v.invalidateObb(a.serviceObbInRenderSR);return f};h.populateChildren=function(a,b){var c=e.unwrap(this._getNodeInternal(a));const f=e.unwrap(this._getPage(a));c.childOffset=f.children.length;c.childCount=b.length;for(c=0;c<b.length;c++){const d=this._makeRefNode(b[c],a);f.children.push(d)}};h.getNode=function(a){a=this._getNodeInternal(a);return e.isSome(a)?a.node:null};h.getIndexById=function(a){let b;this._forAllNodes((c,
f)=>{e.isSome(c.node)&&c.node.id===a?b=f:e.isSome(c.ref)&&c.ref.id===a&&(b=f)});return b};h.getNodeById=function(a){a=this.getIndexById(a);return 0<=a?this.getNode(a):null};h.getChildIndex=function(a,b){const c=this._getPage(a);if(e.isNone(c))return-1;a=c.nodes[A(a,this._nodesPerPage)];return c.children[a.childOffset+b]};h.getParentIndex=function(a){const b=this._getPage(a);return e.isSome(b)?b.parents[A(a,this._nodesPerPage)]:-1};h.getParent=function(a){a=this.getParentIndex(a);return 0<=a?this.getNode(a):
null};h.isLeaf=function(a){a=this._getNodeInternal(a);return e.isSome(a)&&0===a.childCount};h.removeAllGeometryObbs=function(){this._forAllNodes(a=>{e.isSome(a.node)&&(a.node.geometryObb=null)})};h.invalidateVisibilityCache=function(){this._visibilityCacheVersion=v.addWraparound(this._visibilityCacheVersion,2)};h.invalidateNodeVisibilityCache=function(a){a=this._getNodeInternal(a);e.isSome(a)&&this.invalidateNodeVisibilityCacheInternal(a)};h.invalidateNodeVisibilityCacheInternal=function(a){a.visibilityCache=
v.addWraparound(this._visibilityCacheVersion,-2)};h.invalidateBoundingVolumeCache=function(a){a=this._getNodeInternal(a);e.isSome(a)&&(H(a),this.invalidateNodeVisibilityCacheInternal(a))};h.updateElevationChanged=function(a){const b=this._getNodeInternal(a);e.isNone(b)||(this.needNodeElevationRange?(a=e.isSome(b.node)?b.node:b.ref,e.isNone(a)||(a=a.elevationRange,e.isNone(a)||(a.valid=!1))):this.invalidateBoundingVolumeCache(a))};h.invalidateGeometryVisibility=function(a){a=this._getNodeInternal(a);
e.isSome(a)&&e.isSome(a.node)&&(a.node.geometryObb=null,v.invalidateMbs(a.node.renderMbs),v.invalidateObb(a.node.serviceObbInRenderSR))};h.invalidateVisibilityObbs=function(){e.isNone(this.rootNode)||this.traverse(this.rootNode,a=>{a.visibilityObb=this._computeVisibilityObb(a);a.geometryObb=null;return!0})};h._updateElevationRange=function(a){var b=this._getNodeInternal(a);if(e.isNone(b))return null;const c=e.isSome(b.node)?b.node:b.ref;if(e.isNone(c))return null;const f=c.elevationRange;if(e.isSome(f)&&
f.valid)return f;const d=new q.ElevationRange;let g=!1;for(let n=0;n<b.childCount;n++){const r=this._updateElevationRange(this.getChildIndex(a,n));e.isNone(r)?g=!0:(d.min=Math.min(d.min,r.min),d.max=Math.max(d.max,r.max))}if(0===b.childCount||g&&e.isSome(b.node)&&b.node.resources.geometry)b=this._viewportQueries.getElevationRange(c),e.isSome(b)&&(d.min=Math.min(d.min,b.min),d.max=Math.max(d.max,b.max));if(e.isSome(f)&&f.min===d.min&&f.max===d.max)return f.valid=!0,f;d.valid=!0;c.elevationRange=d;
this.invalidateBoundingVolumeCache(a);return d};h.isNodeVisible=function(a){const b=this._getNodeInternal(a);if(e.isNone(b)||e.isSome(b.ref)&&!b.ref.mbs)return!0;this.needNodeElevationRange&&this._updateElevationRange(a);if((b.visibilityCache&-2)!==this._visibilityCacheVersion){a=b.node;const f=e.isSome(a)&&(e.isNone(b.ref)||e.isSome(a.visibilityObb))?a:e.isSome(b.ref)?b.ref:null;if(this._layerHasFilter&&this._computeNodeFiltering&&(e.isSome(a)||e.isSome(b.ref))&&b.filterImpact===q.NodeFilterImpact.NotChecked){var c=
e.isSome(a)?a.mbs:e.isSome(b.ref)?b.ref.mbs:null;b.filterImpact=null!=c?this._computeNodeFiltering(c):q.NodeFilterImpact.Unmodified}c=e.isSome(a)&&b.filterImpact===q.NodeFilterImpact.Culled;a=!(e.isSome(a)&&a.imModificationImpact===q.NodeIMModificationImpact.Culled)&&(!f||this._viewportQueries.isNodeVisible(f))&&!c;b.visibilityCache=this._visibilityCacheVersion+(a?1:0);return a}return 1===(b.visibilityCache&1)};h.isGeometryVisible=function(a){if(!this.isNodeVisible(a))return!1;a=this._getNodeInternal(a);
return e.isSome(a)&&e.isSome(a.node)&&e.isSome(a.node.geometryObb)&&(!this.layerHasModifications||a.node.imModificationImpact!==q.NodeIMModificationImpact.NotChecked)?this._viewportQueries.isGeometryVisible(a.node):!0};h._traverseCoverage=function(a,b,c,f,d){a=this._getPage(a);if(!e.isNone(a)&&0!==b.childCount){var g=b.childOffset+b.childCount,n=[];for(b=b.childOffset;b<g;++b){const r=a.children[b],t=this._getNodeInternal(r);e.isSome(t)&&e.isSome(t.node)&&this.isGeometryVisible(r)&&n.push(t)}f/=n.length;
for(const r of n)a=e.unwrap(r.node).index,this._isLoaded(a)||this._isReloading(a)?(d.delta=Math.max(d.delta,c),d.coverage+=f):this._traverseCoverage(a,r,c+1,f,d)}};h.useNodeAsHole=function(a){if("off"===this.holeFilling)return!1;const b=this._getNodeInternal(a);if(e.isNone(b))return!1;if("always"===this.holeFilling)return!0;if((b.useAsHole&-2)===this._version)return 1===(b.useAsHole&1);const c={delta:0,coverage:0};this._traverseCoverage(a,b,0,1,c);a=.5>=c.delta*c.coverage;b.useAsHole=this._version+
(a?1:0);return a};h.destroy=function(){this._updates.add.prune();this._updates.update.prune()};h.requestUpdate=function(){this._dirty=!0;this._indexMissing=1;this._version=v.addWraparound(this._version,2)};h.imModificationsChanged=function(a){this.layerHasModifications=a;this._forAllNodes(({node:b})=>{e.isSome(b)&&(b.imModificationImpact=q.NodeIMModificationImpact.NotChecked,b.visibilityObb=this._computeVisibilityObb(b),b.hasModifications&&this.invalidateGeometryVisibility(b.index))});this.invalidateVisibilityCache()};
h.layerFilterChanged=function(a){this._layerHasFilter=a;this._forAllNodes(b=>{e.isSome(b)&&(b.filterImpact=q.NodeFilterImpact.NotChecked,b=b.node,e.isSome(b)&&this.invalidateNodeVisibilityCache(b.index))});this.invalidateVisibilityCache()};h.update=function(a,b,c){if(this._dirty){0<this._pageQueue.length&&this._addQueuedPages(b);this._maxProcessingPrio=this._maxUnloadedPrio=Number.NEGATIVE_INFINITY;this._missing.clear();this._prefetch.clear();this._updates.reset(a);u.clear();var f=!0,d=new D,g=new D,
n=this._imModificationUncategorized;n.clear();var r=new Set;this.traverseVisible((k,l,x)=>{if(e.isNone(l))l=this._entryPriority(k),Infinity===l&&(l=this._entryPriority(x)),k=C(k,this._nodesPerPage),u.set(k,Math.max(l,u.get(k)||0)),this._loading.has(k)||this._failedPages.has(k)||this._missing.push(k),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,l);else{var m=l.node;this._updateNodeFeatureEstimate(m,g);if(e.isNone(m))l=this._entryPriority(k),this._loading.has(k)||this._failedNodes.has(k)||
(this._missing.push(k),u.set(k,l)),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,l);else{x=e.unwrap(this._getPage(k));if(0===this._missing.length&&0===this._nodesPerPage)for(let w=0;w<l.childCount;w++){const y=x.children[l.childOffset+w],K=this._getNodeInternal(y);!e.isSome(K)||K.node||this._loading.has(y)||this._failedNodes.has(y)||(u.set(y,this._entryPriority(y)),this._prefetch.push(y))}m.failed||!m.resources.hasFeatureData?f&&0<l.childCount&&this._isSelected(m)&&(f=!1):(r.add(m.id),
this._isLoaded(k)?(d.known+=m.memory,++d.knownNodes,this._isSelected(m)?0<l.childCount&&(f=!1):(d.unremoved+=m.memory,f=!1),this._needsUpdate(m)&&(l=this._entryPriority(k),u.set(k,l),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,l),this._updates.update.push(k))):(m.memory&&(d.known+=m.memory,++d.knownNodes),this._isSelected(m)?(0<l.childCount&&(f=!1),m.memory?(d.missing+=m.memory,d.known+=m.memory,++d.knownNodes):++d.missingNodes,a.includes(m.index)?(this._maxProcessingPrio=Math.max(this._maxProcessingPrio,
this._entryPriority(k)),this._updates.cancel=this._updates.cancel.filter(w=>w!==m.index)):!b.done&&this._enable(m)?b.madeProgress():(l=this._entryPriority(k),u.set(k,l),this._maxProcessingPrio=Math.max(this._maxProcessingPrio,l),this._updates.add.push(k),this.layerHasModifications&&c&&e.isSome(m)&&m.imModificationImpact===q.NodeIMModificationImpact.NotChecked&&n.push(k))):this._isReloading(k)&&this._updates.remove.push(k)))}}});var t=this._updates.add;0<t.length&&this.layerHasModifications&&(0<n.length&&
c(n),t.filterInPlace(k=>{var l=this._getNodeInternal(k);(l=e.isNone(l)||e.isNone(l.node)||l.node.imModificationImpact!==q.NodeIMModificationImpact.Culled)||this.invalidateNodeVisibilityCache(k);return l}));this._unloadedMemoryEstimate=d.missing-d.unremoved;3<d.knownNodes&&0<d.missingNodes&&(this._unloadedMemoryEstimate+=d.known/d.knownNodes*d.missingNodes);this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate);this._featureEstimate.estimate=this._computeFeatureEstimate(g);this._featureEstimate.leavesReached=
f;this._missing.sort((k,l)=>k-l);this._missing.filterInPlace((k,l)=>1>l||this._missing.data[l-1]!==k);this._missing.sort((k,l)=>u.get(k)-u.get(l));0<this._missing.length&&(this._maxUnloadedPrio=u.get(this._missing.back()),this._prefetch.clear());this._updates.add.filterInPlace(k=>u.get(k)>=this._maxUnloadedPrio).sort((k,l)=>u.get(k)-u.get(l));this._updates.update.sort((k,l)=>u.get(k)-u.get(l));this._indexMissing=this._loading.size+this._missing.length;this._dirty=0<this._indexMissing;u.clear()}};
h.checkFeatureTarget=function(a,b){const c=this._viewportQueries.updateScreenSpaceErrorBias(b);let f=b,d=b,g=c,n=10;for(;n--;){const r=new D;this._updateFeatureEstimate(f,r);if(this._computeFeatureEstimate(r)<=a){if(f>=b||0<r.missingNodes||0===n)break;g=f;f=.5*(f+d)}else d=f,f=.5*(f+g)}this._version=v.addWraparound(this._version,2);this._viewportQueries.updateScreenSpaceErrorBias(c);return Math.min(b,f)};h._updateFeatureEstimate=function(a,b){this._version=v.addWraparound(this._version,2);this._viewportQueries.updateScreenSpaceErrorBias(a);
this.traverseVisible((c,f)=>this._updateNodeFeatureEstimate(e.isSome(f)&&f.node,b))};h._updateNodeFeatureEstimate=function(a,b){e.isNone(a)||a.failed||e.isNone(a.numFeatures)||(this._isLoaded(a.index)?(b.known+=a.numFeatures,++b.knownNodes,this._isSelected(a)||(b.unremoved+=a.numFeatures)):this._isSelected(a)&&(e.isSome(a.numFeatures)?(b.missing+=a.numFeatures,b.known+=a.numFeatures,++b.knownNodes):++b.missingNodes))};h._computeFeatureEstimate=function(a){let b=a.known-a.unremoved;3<a.knownNodes&&
0<a.missingNodes&&(b+=a.known/a.knownNodes*a.missingNodes);return Math.max(0,b)};h.load=function(){return this._load(this._missing)};h.prefetch=function(){this._prefetch.sort((a,b)=>u.get(a)-u.get(b));return this._load(this._prefetch)};h._load=function(a){if(0===a.length||!this._canRequest())return!1;for(;0<a.length&&this._canRequest();)0===this._nodesPerPage?this._loadNode(a.pop()):this._loadPage(a.pop());return!0};h.nodeTraversalState=function(a){if(e.isNone(a))return null;let b=this._nodeTraversalState.get(a.index);
if(b&&(b.version&-2)===this._version)return b;const c=this._viewportQueries.getLodLevel(a),f=this._viewportQueries.hasLOD(a);var d=!0;f?(d=this.getParentIndex(a.index),d=0<=d?(d=this._nodeTraversalState.get(d))&&c>d.lodLevel:0<c):d=0===a.childCount;if(b)return b.lodLevel=c,b.isChosen=d,b.version=this._version+1,b;b=new q.NodeTraversalState(f,d,c,this._version+1);this._nodeTraversalState.set(a.index,b);return b};h._loadNode=function(a){this._loading.add(a);const b=e.unwrap(this._getNodeInternal(a)).ref;
if(e.isNone(b))this._failedNodes.add(a);else{var c=b.id,f=this._urlPrefix+c,d=()=>{this._loading.delete(a);0===this._missing.length&&0===this._loading.size&&this.requestUpdate()};this._streamDataController.request(f,"json").then(g=>{d();g=this._validateNode(c,g);null!=g&&(g.obb&&this.invalidateNodeVisibilityCache(a),g=this._addNode(g,a),this.nodeTraversalState(g))},g=>{d();E.isAbortError(g)||(this._logger.error("#loadNode()",this._logLayer,"Error loading node: "+f),this._failedNodes.add(a))})}};h._validateNode=
function(a,b){if(null==b||"object"!==typeof b||b.id!==a)return this._logger.error("#validateNode()",this._logLayer,`Invalid node. Wrong type or wrong id "${a}"`),null;if(!Array.isArray(b.mbs))return this._logger.error("#validateNode()",this._logLayer,`Invalid bounding volume on node ${a}.`),null;b.sharedResource&&"./shared"!==b.sharedResource.href&&"./shared/"!==b.sharedResource.href&&this._logger.warn("#validateNode()",this._logLayer,`Invalid shared resource href on node "${a}"`);null==b.geometryData||
Array.isArray(b.geometryData)&&1===b.geometryData.length&&"./geometries/0"===b.geometryData[0].href||this._logger.warn("#validateNode()",this._logLayer,`Invalid geometry data on node "${a}"`);null==b.attributeData||Array.isArray(b.attributeData)&&!b.attributeData.some((g,n)=>g.href!==`./attributes/f_${n}/0`)||this._logger.warn("#validateNode()",this._logLayer,`Invalid attribute data on node "${a}"`);b.featureData&&1<b.featureData.length&&this._logger.warn("#validateNode()",this._logLayer,`Node ${a} has ${b.featureData.length} bundles. Only the first bundle will be loaded.`);
const c=b.hasOwnProperty("obb")&&!this.ignoreServiceObb?b.obb:null,f=b.featureData&&1===b.featureData.length&&b.featureData[0].featureRange?b.featureData[0].featureRange[1]-b.featureData[0].featureRange[0]+1:null;var d=g=>{if(null==g)return null;var n=r=>this._logger.error("#validateNode()",this._logLayer,`Invalid node reference on node ${a}: ${r}`);if("number"===typeof g.id)n(`id ${g.id} is a number instead of a string.`);else if("string"!==typeof g.id||!Array.isArray(g.mbs))return n("Missing or invalid id."),
null;if(!Array.isArray(g.mbs))return n(`Invalid bounding volume on reference ${g.id}.`),null;g.href&&g.href!=="../"+g.id&&this._logger.error("#validateNode()",this._logLayer,`Invalid node href on node "${a}"`);n=g.hasOwnProperty("obb")&&!this.ignoreServiceObb?g.obb:null;g=new q.NodeBase(`${g.id}`,g.mbs);g.serviceObb=n;g.visibilityObb=this._computeVisibilityObb(g);return g};d=Array.isArray(b.children)?b.children.map(d).filter(g=>null!=g):null;return{id:a,mbs:b.mbs,obb:c,children:d,resources:{hasFeatureData:b.featureData&&
0<b.featureData.length,hasSharedResource:null!=b.sharedResource,attributes:b.attributeData?a:null,texture:b.textureData&&0<b.textureData.length?a:null,geometry:null!=b.geometryData?a:null},version:"string"===typeof b.version?b.version:null,lodSelection:Array.isArray(b.lodSelection)?b.lodSelection:null,numFeatures:f}};h.resetFailedNodes=function(){this._failedNodes.clear();this._failedPages.clear();this._forAllNodes(a=>{e.isSome(a.node)&&(a.node.failed=!1)})};h._entryPriority=function(a){var b=this._getNodeInternal(a),
c=this.getParentIndex(a);if(e.isNone(b)||0>c&&null==b.node)return 0>c?Infinity:this._entryPriority(c);let f=0;b.node&&0<=c&&(c=this._nodeTraversalState.get(c),null!=c&&(f=c.lodLevel));for(c=this.progressiveLoadPenalty;0<=a;a=this.getParentIndex(a))if(this._isLoaded(a)){c=0;break}b=e.isSome(b.ref)?this._viewportQueries.distToPOI(b.ref):e.isSome(b.node)?this._viewportQueries.distToPOI(b.node):0;return-b-f*(b+this.progressiveLoadPenalty)+c};h.traverseVisible=function(a){const b=this._getNodeInternal(this._rootIndex);
e.isNone(b)?a(this._rootIndex,null,null):this._traverseVisible(this._rootIndex,-1,b,a)};h._traverseVisible=function(a,b,c,f){if(c.node&&0===c.childCount)this.isGeometryVisible(a)&&f(a,c,b);else if(this.isNodeVisible(a)&&(f(a,c,b),null!=c.node&&(b=this.nodeTraversalState(c.node),!b.nodeHasLOD||b.lodLevel!==this._maxLodLevel))){b=e.unwrap(this._getPage(a));for(let d=0;d<c.childCount;d++){const g=b.children[c.childOffset+d],n=this._getNodeInternal(g);e.isSome(n)?this._traverseVisible(g,a,n,f):f(g,null,
a)}}};h.traverse=function(a,b){b(a)&&this.traverseChildren(a,b)};h.traverseChildren=function(a,b){a=a.index;const c=this._getNodeInternal(a);e.isSome(c)&&this._traverseChildren(a,c,b)};h._traverseChildren=function(a,b,c){a=this._getPage(a);if(!e.isNone(a)){var f=b.childOffset+b.childCount;for(b=b.childOffset;b<f;++b){const d=a.children[b],g=this._getNodeInternal(d);e.isSome(g)&&e.isSome(g.node)&&c(g.node)&&this._traverseChildren(d,g,c)}}};h.updateChildrenLoaded=function(a,b){for(a=this.getNode(a);e.isSome(a);)a.childrenLoaded+=
b,a=this.getParent(a.index)};h.checkChildrenLoadedInvariant=function(){if(e.isNone(this.rootNode))return!0;const a=[],b=c=>{let f=this._isLoaded(c.index)||this._isReloading(c.index)?1:0;this.traverseChildren(c,d=>{f+=b(d);return!1});c.childrenLoaded!==f&&a.push(c.index);return f};b(this.rootNode);a.length&&this._logger.error("childrenLoaded invariant broken at following nodes: "+a.join(","));return 0<a.length};h.updateStats=function(a){0<this._updates.add.length&&(a.nodes+=" + "+this._updates.add.length);
if(this._indexMissing||0<this._prefetch.length)a.index+=" + "+this._indexMissing||this._prefetch.length;a.prio=this._maxProcessingPrio;if(this._featureEstimate.estimate){const b=this._featureEstimate.estimate-a.features;0<b?a.features+=" + "+b:0>b&&(a.features+=" - "+-b)}};h.updateElevationInfo=function(a,b){this.needNodeElevationRange=b&&a&&("relative-to-ground"===a.mode||"on-the-ground"===a.mode);this._viewportQueries.updateElevationInfo(a);this.invalidateAllElevationRanges()};h.invalidateAllElevationRanges=
function(){this._forAllNodes(a=>{H(a);e.isSome(a.node)&&(a.node.elevationRange=null);e.isSome(a.ref)&&(a.ref.elevationRange=null)})};h._forAllNodes=function(a){for(let b=0;b<this._nodePages.length;b++){const c=this._nodePages[b];if(c){const f=b*this._nodesPerPage;for(let d=0;d<c.nodes.length;d++)a(c.nodes[d],f+d)}}};L._createClass(p,[{key:"rootNode",get:function(){return this.getNode(this._rootIndex)}},{key:"size",get:function(){return this._nodeCount}},{key:"maxLevel",get:function(){return this._maxLevel}},
{key:"dirty",get:function(){return this._dirty}},{key:"isLoading",get:function(){return 0<this._indexMissing}},{key:"isPrefetching",get:function(){return 0<this._prefetch.length}},{key:"indexLoading",get:function(){return this._loading.size}},{key:"indexMissing",get:function(){return this._indexMissing}},{key:"unloadedMemoryEstimate",get:function(){return this._unloadedMemoryEstimate}},{key:"updates",get:function(){return this._updates}},{key:"featureEstimate",get:function(){return this._featureEstimate}},
{key:"maxPriority",get:function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)}},{key:"test",get:function(){return{addNode:(a,b)=>this._addNode(a,b)}}}]);return p}();const u=new Map;let P=function(){function p(h){this.missing=h;this.update=new z({deallocator:null});this.add=new z({deallocator:null});this.remove=new z({deallocator:null});this.cancel=[]}p.prototype.reset=function(h){this.add.clear();this.update.clear();this.cancel=h};return p}();const N=[["maxScreenThreshold",q.LodMetric.MaxScreenThreshold],
["screenSpaceRelative",q.LodMetric.ScreenSpaceRelative],["removedFeatureDiameter",q.LodMetric.RemovedFeatureDiameter],["distanceRangeFromDefaultCamera",q.LodMetric.DistanceRangeFromDefaultCamera]];let D=function(){this.unremoved=this.missingNodes=this.missing=this.knownNodes=this.known=0};B.I3SIndex=Q;B.selectErrorMetric=I;Object.defineProperties(B,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});