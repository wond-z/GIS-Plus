// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../Color ../../../../geometry ../../../../analysis/dimensionUtils ../../../../analysis/LengthDimension ../../../../core/HandleOwner ../../../../core/Handles ../../../../core/lang ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec3f64 ../../../../layers/graphics/hydratedFeatures ./lengthDimensionConstraintUtils ./lengthDimensionManipulatorUtils ./lengthDimensionUtils ./settings ../Slice/images/Factory ../../interactive/SnappingVisualizer3D ../../interactive/visualElements/LineVisualElement ../../interactive/visualElements/VerticesVisualElement ../../webgl-engine/lib/Material ../../webgl-engine/materials/ImageMaterial ../../webgl-engine/materials/lineStippleUtils ../../webgl-engine/materials/RibbonLineMaterial ../../../interactive/coordinateHelper ../../../interactive/editGeometry/EditGeometry ../../../interactive/editGeometry/EditGeometryOperations ../../../interactive/snapping/SceneSnappingManagerPool ../../../interactive/snapping/SnappingContext ../../../interactive/snapping/SnappingDragPipelineStep ../../../interactive/snapping/SnappingOperation ../../../../geometry/Point".split(" "),
function(l,L,n,G,la,v,R,S,T,M,d,U,k,p,ma,V,N,H,r,h,z,w,W,X,Y,Z,A,aa,O,ba,ca,da,ea,fa,ha,ia,ja,I){function J(){const {color:B,opacity:x}=w.settings.offsetManipulator;return new ba.RibbonLineMaterial({color:[...G.toUnitRGB(B),x],width:1,renderOccluded:A.RenderOccludedFlag.OccludeAndTransparent,writeDepth:!1,hasPolygonOffset:!0})}l.LengthDimensionSubTool=function(B){function x(b){var a=B.call(this,b)||this;a._stagedDimension=null;a._computationManipulators=new Map;a._computationHandles=new T;a._snappingPipeline=
new ia.SnappingPipeline;a._snappingManagerResult=fa.acquire(b.view);a.addHandles(a._snappingManagerResult);a._unfocusedOffsetManipulatorMaterial=J();a._focusedOffsetManipulatorMaterial=J();a._thinOffsetManipulatorMaterial=J();a._thinOffsetManipulatorMaterial.setParameters({stipplePattern:O.createStipplePatternSimple(2)});a._constraintSnappingIndicator=new Y.LineVisualElement({view:b.view,attached:!0,width:1,color:G.toUnitRGBA(w.settings.constraint.color),renderOccluded:A.RenderOccludedFlag.OccludeAndTransparent,
stipplePattern:O.createStipplePatternSimple(5)});const c=G.toUnitRGBA(w.settings.disabledPointIndicator.color);c[3]*=w.settings.disabledPointIndicator.opacity;a._stagedStartIndicator=new Z.VerticesVisualElement({view:b.view,attached:!1,color:c,size:2*w.settings.disabledPointIndicator.radius,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:b.view.renderCoordsHelper.spatialReference,outlineSize:0,renderOccluded:A.RenderOccludedFlag.OccludeAndTransparent});return a}L._inheritsLoose(x,
B);var f=x.prototype;f.initialize=function(){this._snappingOperation=new ja.SnappingOperation({view:this.view});this._orientationManipulatorTexture=W.getRotateHeadingTexture(this.view.toolViewManager.textures);this._orientationManipulatorMaterial=new aa.ImageMaterial({transparent:!0,writeDepth:!1,textureId:this._orientationManipulatorTexture.texture.id,renderOccluded:A.RenderOccludedFlag.Opaque});const {computations:b}=this.analysisViewData;for(const a of b)this._addComputation(a);this.addHandles([b.on("after-add",
a=>this._addComputation(a.item)),b.on("after-remove",a=>this._removeComputation(a.item))]);this.addHandles([k.watch(()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation}),({stagedPoint:a,stagedComputation:c})=>{d.isNone(c)||d.isNone(a)||(a=H.clonePoint(a,new I),this._applyPointUpdate(c,{endPoint:a}))},k.sync),k.watch(()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}),
(a,c)=>{const {stagedDimension:e,selectedComputation:g,firstGrabbedManipulator:m}=a;if(e!==c.stagedDimension||m!==c.firstGrabbedManipulator)for(const [q,y]of this._computationManipulators)this._updateManipulators(q,y,a);else for(const q of[g,c.selectedComputation])d.isSome(q)&&(c=this._computationManipulators.get(q),this._updateManipulators(q,c,a))},k.syncAndInitial),k.watch(()=>this.analysis.style.lineSize,a=>{this._updateManipulatorStyle(a)},k.initial),k.watch(()=>this.view.state.camera,()=>{d.isSome(this._stagedComputation)&&
this._updateStagedDimensionOffset(this._stagedComputation)}),k.watch(()=>d.applySome(this._stagedComputation,a=>{a=a.elevationAlignedStartPoint;const c=N.create();return d.isSome(a)&&this.view.renderCoordsHelper.toRenderCoords(a,c)?c:null}),a=>{d.isSome(a)?(this._stagedStartIndicator.vertices=[a],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1})]);this.addHandles(this._constraintHandles);this.addHandles(this._snappingIndicatorHandles)};f.destroy=function(){this._snappingOperation=
d.destroyMaybe(this._snappingOperation);this._computationHandles.destroy();this._constraintSnappingIndicator.destroy();this._stagedStartIndicator.destroy();this._orientationManipulatorMaterial.dispose();this._orientationManipulatorTexture.release()};f.removeStaged=function(){return d.isSome(this._stagedDimension)?(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0):!1};f.onDeactivate=function(){this.removeStaged();this._resetSnappingState()};f.onClick=function(b){const {_stagedDimension:a}=
this;if(d.isNone(a))return b=this._onUnstagedClick(b),this.analysis.dimensions.add(b),null;this._onStagedClick(b);return a};f.onPointerMove=function({mapPoint:b,pointerType:a}){"touch"!==a&&(a=this._snappingContext(a),this.updatingHandles.addPromise(U.ignoreAbortErrors(this._snappingOperation.snap({point:b},this._snappingManager,a))))};f.onManipulatorSelectionChanged=function(){d.isSome(this.analysisViewData.selectedComputation)&&!this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected&&
(this.analysisViewData.selectedDimension=null)};f._onUnstagedClick=function({mapPoint:b,pointerType:a}){let c=b;"mouse"===a&&(a=this._snappingContext(a),c=this._snappingManager.update({point:b,context:a}));this._stagedDimension=b=new R({startPoint:H.clonePoint(c,new I),endPoint:null,measureType:v.LengthDimensionMeasureType.Horizontal});this._resetSnappingState();return b};f._onStagedClick=function({mapPoint:b,pointerType:a}){const c=this._stagedComputation;if(!d.isNone(c)){var e=b;"mouse"===a&&(a=
this._snappingContext(a),e=this._snappingManager.update({point:b,context:a}));b=H.clonePoint(e,new I);this._applyPointUpdate(c,{endPoint:b});this._stagedDimension=null;this._resetSnappingState()}};f._resetSnappingState=function(){this._snappingManager.doneSnapping();this._snappingOperation.abort();this._snappingOperation.stagedPoint=null};f._addComputation=function(b){if(!this._computationManipulators.has(b)){var a=this._setupPointManipulator(b,{isStart:!0}),c=this._setupPointManipulator(b,{isStart:!1}),
e=this._setupOffsetManipulator(b),g=this._setupHeadingManipulator(b),m=this._setupRotationManipulator(b),q=this._setupMeasureTypeManipulator(b,v.LengthDimensionMeasureType.Direct),y=this._setupMeasureTypeManipulator(b,v.LengthDimensionMeasureType.Horizontal),C=this._setupMeasureTypeManipulator(b,v.LengthDimensionMeasureType.Vertical);a=new h.LengthDimensionManipulators({start:a,end:c,offset:e,heading:g,rotation:m,direct:q,horizontal:y,vertical:C});this._setupComputationToManipulatorsSync(b,a);this._computationManipulators.set(b,
a);this.manipulators.addMany(a.values())}};f._removeComputation=function(b){const a=this._computationManipulators.get(b);if(!d.isNone(a)){this._computationHandles.remove(b);this._computationManipulators.delete(b);for(const c of a.values())this.manipulators.remove(c)}};f._setupComputationToManipulatorsSync=function(b,a){this._computationHandles.add([k.watch(()=>b.geometry,()=>this._updateManipulators(b,a),{...k.syncAndInitial,equals:M.equals})],b)};f._setupPointManipulator=function(b,a){const {view:c}=
this,{dimension:e}=b,g=h.createPointManipulator(c,{metadata:e});a=h.pointManipulatorHandles(g,{isStart:a.isStart,createSnappingPipelineStep:(m,q)=>this._snappingPipeline.createSnapDragEventPipelineStep({snappingContext:this._snappingContext(q),snappingManager:this._snappingManager,updatingHandles:this.updatingHandles,cancel:m}),dimension:e,onUpdate:m=>{this._applyPointUpdate(b,m)},snappingPipeline:this._snappingPipeline,view:c});this._computationHandles.add(a,b);return g};f._setupOffsetManipulator=
function(b){var {view:a}=this;const c=h.createOffsetManipulator(a,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:b.dimension});a=h.offsetManipulatorHandles(c,{computation:b,view:a});this._computationHandles.add(a,b);return c};f._setupHeadingManipulator=function(b){var {view:a}=this;const c=h.createOrientationManipulator(a,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,
metadata:b.dimension});a=h.headingManipulatorHandles(c,{computation:b,view:a});this._computationHandles.add(a,b);return c};f._setupRotationManipulator=function(b){var {view:a}=this;const c=h.createOrientationManipulator(a,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:b.dimension});a=h.rotationManipulatorHandles(c,{computation:b,view:a});this._computationHandles.add(a,b);return c};f._setupMeasureTypeManipulator=function(b,a){const {view:c}=this,e=h.createMeasureTypeManipulator(c,
{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:b.dimension});a=h.measureTypeManipulatorHandles(e,{computation:b,manipulatorMeasureType:a,view:c});this._computationHandles.add(a,b);return e};f._updateManipulators=function(b,a,c={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,
firstGrabbedManipulator:this.firstGrabbedManipulator}){const {stagedDimension:e,selectedComputation:g,firstGrabbedManipulator:m}=c,{start:q,end:y,offset:C,heading:D,rotation:E}=a;c=g===b;const P=z.isValidComputation(b),{dimension:K}=b;for(var t of a.values()){const u=P&&d.isNone(e)&&(d.isNone(m)||t===m);t===C?(t.available=u,t.selected=c):t.available=u&&c}if(P){d.isSome(r.computeConstraint(b,this.view))?a.forEachMeasureTypeManipulator(u=>u.available=!1):a.manipulatorForMeasureType(K.measureType).available=
!1;for(const u of[D,E])if(K.measureType!==v.LengthDimensionMeasureType.Direct||0===K.offset)u.available=!1;z.arePointsVerticallyAligned(b)?E.available=!1:D.available=!1;({geometry:t}=b);q.renderLocation=t.directSegment.startRenderSpace;y.renderLocation=t.directSegment.endRenderSpace;var {renderCoordsHelper:F}=this.view;h.updateOffsetManipulatorTransform(C,t,F);D.available&&h.updateHeadingManipulatorTransform(D,b,F);E.available&&h.updateRotationManipulatorTransform(E,b,F);a.forEachMeasureTypeManipulator((u,
ka)=>{u.available&&h.updateMeasureTypeManipulatorTransform(u,b,ka,F)})}};f._updateManipulatorStyle=function(b){const a=h.unfocusedOffsetWidth(b),c=h.focusedOffsetWidth(b);b={lineSizePt:b,material:this._orientationManipulatorMaterial};for(const {offset:e,heading:g,rotation:m}of this._computationManipulators.values())e.radius=c/2,h.updateOrientationManipulator(g,b),h.updateOrientationManipulator(m,b);this._unfocusedOffsetManipulatorMaterial.setParameters({width:a});this._focusedOffsetManipulatorMaterial.setParameters({width:c})};
f._snappingContext=function(b){return new ha.SnappingContext({elevationInfo:{mode:"absolute-height",offset:0},pointer:b,editGeometryOperations:new ea.EditGeometryOperations(new da.EditGeometry("point",ca.createCoordinateHelper(!0,!1,this.view.spatialReference))),visualizer:new X.SnappingVisualizer3D})};f._applyPointUpdate=function(b,a){const {view:c}=this,e=z.computationToGeometryDependencies(b);"startPoint"in a&&(e.elevationAlignedStartPoint=a.startPoint);"endPoint"in a&&(e.elevationAlignedEndPoint=
a.endPoint);const g=z.computeGeometryFromDimension(e,c.renderCoordsHelper);if(!d.isNone(g)){var m=r.computeConstraint({...e,geometry:g},c);r.applyConstraint(b,a,{...e,constraint:m,unconstrainedGeometry:g,view:c});b===this._stagedComputation&&this._updateStagedDimensionOffset(b)}};f._updateStagedDimensionOffset=function(b){if(!d.isNone(b.geometry)){b.geometry.directSegment.eval(.5,Q);var a=this.view.state.camera.computeRenderPixelSizeAt(Q);b.dimension.offset=w.settings.initialOffsetPx*a}};L._createClass(x,
[{key:"updating",get:function(){return this.updatingHandles.updating||this._snappingManager.updating}},{key:"firstGrabbedManipulator",get:function(){return this.parentTool.firstGrabbedManipulator}},{key:"hasGrabbedManipulators",get:function(){return this.parentTool.hasGrabbedManipulators}},{key:"_snappingManager",get:function(){return this._snappingManagerResult.snappingManager}},{key:"_activeComputation",get:function(){if(d.isSome(this._stagedComputation))return this._stagedComputation;const {selectedComputation:b}=
this.analysisViewData;return this.hasGrabbedManipulators&&d.isSome(b)?b:null}},{key:"_stagedComputation",get:function(){const b=this._stagedDimension,a=this.analysisViewData.computations.at(-1);return d.isNone(b)||d.isNone(a)||a.dimension!==b?null:a}},{key:"_constraintHandles",get:function(){return[k.when(()=>this.analysisViewData.selectedComputation,b=>{b.previousConstraint=r.computeConstraint(b,this.view)},{...k.syncAndInitial,equals:M.equals}),k.watch(()=>{const b=this._activeComputation;if(d.isNone(b))return null;
const {measureType:a,orientation:c}=b.dimension;return{measureType:a,orientation:c,computation:b}},(b,a)=>{if(d.isSome(b)&&d.isNone(a)){const {measureType:c,orientation:e,computation:g}=b;switch(g.previousConstraint){case r.LengthDimensionConstraint.Horizontal:g.preConstraintProperties={measureType:v.LengthDimensionMeasureType.Horizontal,orientation:0};break;case r.LengthDimensionConstraint.Vertical:g.preConstraintProperties={measureType:v.LengthDimensionMeasureType.Vertical,orientation:0};break;
case r.LengthDimensionConstraint.Direct:g.preConstraintProperties={measureType:v.LengthDimensionMeasureType.Direct,orientation:e};break;default:g.preConstraintProperties={measureType:c,orientation:e}}}d.isNone(b)&&d.isSome(a)&&(a.computation.preConstraintProperties=null)},k.sync)]}},{key:"_snappingIndicatorHandles",get:function(){return[k.watch(()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation}),({stagedComputation:b,activeComputation:a})=>{const c=this._constraintSnappingIndicator;
this.removeHandles("snapping-indicator-event-handles");if(d.isNone(a))c.attached=!1;else if(a===b)c.attached=!0;else{const {start:e,end:g}=this._computationManipulators.get(a);b=()=>{c.attached=e.grabbing||g.grabbing};b();this.addHandles([e.events.on("grab-changed",b),g.events.on("grab-changed",b)],"snapping-indicator-event-handles")}}),k.watch(()=>{const b=this._activeComputation;return d.isSome(b)?{geometry:b.geometry,constraint:b.previousConstraint}:{}},({geometry:b,constraint:a})=>{const c=this._constraintSnappingIndicator;
d.isSome(b)&&d.isSome(a)&&a!==r.LengthDimensionConstraint.Direct?(c.visible=!0,c.setGeometryFromSegment(b.directSegment)):c.visible=!1})]}},{key:"testInfo",get:function(){const b=a=>this.analysisViewData.computations.find(c=>c.dimension===a);return{getManipulatorsForDimension:a=>this._computationManipulators.get(b(a)),getComputationForDimension:a=>b(a),getConstraintForDimension:a=>{a=b(a);return d.isSome(a)?r.computeConstraint(a,this.view):null},stagedDimension:this._stagedDimension,stagedStartIndicator:this._stagedStartIndicator,
constraintSnappingIndicator:this._constraintSnappingIndicator,snappingManager:this._snappingManager}}}]);return x}(S.HandleOwner);n.__decorate([p.property({constructOnly:!0})],l.LengthDimensionSubTool.prototype,"analysis",void 0);n.__decorate([p.property({constructOnly:!0})],l.LengthDimensionSubTool.prototype,"analysisViewData",void 0);n.__decorate([p.property({constructOnly:!0})],l.LengthDimensionSubTool.prototype,"manipulators",void 0);n.__decorate([p.property({constructOnly:!0})],l.LengthDimensionSubTool.prototype,
"parentTool",void 0);n.__decorate([p.property({constructOnly:!0,nonNullable:!0})],l.LengthDimensionSubTool.prototype,"view",void 0);n.__decorate([p.property({readOnly:!0})],l.LengthDimensionSubTool.prototype,"updating",null);n.__decorate([p.property()],l.LengthDimensionSubTool.prototype,"firstGrabbedManipulator",null);n.__decorate([p.property()],l.LengthDimensionSubTool.prototype,"hasGrabbedManipulators",null);n.__decorate([p.property()],l.LengthDimensionSubTool.prototype,"_stagedDimension",void 0);
n.__decorate([p.property()],l.LengthDimensionSubTool.prototype,"_activeComputation",null);n.__decorate([p.property()],l.LengthDimensionSubTool.prototype,"_stagedComputation",null);l.LengthDimensionSubTool=n.__decorate([V.subclass("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],l.LengthDimensionSubTool);const Q=N.create();Object.defineProperties(l,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});