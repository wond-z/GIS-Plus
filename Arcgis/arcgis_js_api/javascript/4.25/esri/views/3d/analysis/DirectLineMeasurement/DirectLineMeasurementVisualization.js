// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../Color ../../../../intl ../../../../core/Accessor ../../../../core/analysisThemeUtils ../../../../core/Handles ../../../../core/mathUtils ../../../../core/maybe ../../../../core/quantityFormatUtils ../../../../core/quantityUtils ../../../../core/reactiveUtils ../../../../core/screenUtils ../../../../core/unitUtils ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec2 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../interfaces ./interfaces ../support/viewUtils ../../interactive/visualElements/LabelVisualElement ../../interactive/visualElements/LineVisualElement ../../interactive/visualElements/MeasurementArrowVisualElement ../../interactive/visualElements/RightAngleQuadVisualElement ../../interactive/visualElements/support/Segment ../../webgl-engine/lib/Material ../../webgl-engine/materials/lineStippleUtils ../../../../intl/locale ../../../../intl/messages".split(" "),
function(l,G,m,H,fa,S,z,T,M,e,t,I,w,A,N,n,ha,ia,U,O,P,B,V,h,J,C,D,W,X,x,E,K,Y,Z){l.DirectLineMeasurementVisualization=function(Q){function F(a){a=Q.call(this,a)||this;a._params={triangleColor:new Float32Array(H.toUnitRGBA(z.getAccentColor(.75))),triangleLineWidth:3,geodesicProjectionLineWidth:2,geodesicProjectionLineColor:new Float32Array(H.toUnitRGBA(z.getAccentColor(.75))),guideLineWidth:2,guideStippleLengthPixels:6,direcLabelFontSize:16,horizontalLabelFontSize:12,verticalLabelFontSize:12};a._handles=
new T;a._segmentVisualElement=null;a._triangleVisualElement=null;a._rightAngleQuad=null;a._projectedGeodesicLine=null;a._geodesicStartHint=null;a._geodesicEndHint=null;a._segmentLabel=null;a._verticalLabel=null;a._horizontalLabel=null;a._startPosition=B.create();a._endPosition=B.create();a._cornerPosition=B.create();a._startPositionAtSeaLevel=B.create();a._endPositionAtSeaLevel=B.create();a._triangleOrientationOverride=null;a.messages=null;a.loadingMessages=!0;a.visualElementOrientation=h.VisualElementOrientation.Auto;
a.triangleCollapseRatioThreshold=.03;return a}G._inheritsLoose(F,Q);var u=F.prototype;u.initialize=function(){var a=this;const b=this._params;var c={attached:!0,view:this.view};this._segmentVisualElement=new W.MeasurementArrowVisualElement({...c,geometry:null,renderOccluded:E.RenderOccludedFlag.OccludeAndTransparent});this._triangleVisualElement=new D.LineVisualElement({...c,width:b.triangleLineWidth,color:b.triangleColor,renderOccluded:E.RenderOccludedFlag.OccludeAndTransparent});this._rightAngleQuad=
new X.RightAngleQuadVisualElement({...c,color:new Float32Array(H.toUnitRGBA(z.getAccentColor(.75))),renderOccluded:E.RenderOccludedFlag.OccludeAndTransparent});const f={...c,polygonOffset:!0,renderOccluded:E.RenderOccludedFlag.OccludeAndTransparent};this._projectedGeodesicLine=new D.LineVisualElement({...f,width:b.geodesicProjectionLineWidth,color:b.geodesicProjectionLineColor,stipplePattern:K.createStipplePatternSimple(b.guideStippleLengthPixels)});this._geodesicStartHint=new D.LineVisualElement({...f,
width:b.guideLineWidth,color:b.geodesicProjectionLineColor,stipplePattern:K.createStipplePatternSimple(b.guideStippleLengthPixels)});this._geodesicEndHint=new D.LineVisualElement({...f,width:b.guideLineWidth,color:b.geodesicProjectionLineColor,stipplePattern:K.createStipplePatternSimple(b.guideStippleLengthPixels)});c={...c,backgroundColor:z.getTextHaloColor(.6),textColor:z.getTextColor()};this._segmentLabel=new C.LabelVisualElement({...c,fontSize:b.direcLabelFontSize});this._verticalLabel=new C.LabelVisualElement({...c,
fontSize:b.verticalLabelFontSize});this._horizontalLabel=new C.LabelVisualElement({...c,fontSize:b.horizontalLabelFontSize});this._handles.add([w.watch(()=>{const {elevationAlignedStartPoint:d,elevationAlignedEndPoint:g}=this.analysisView,p=this.view;return{view:p,camera:p.state.camera,viewMode:this.viewMode,elevationAlignedStartPoint:d,elevationAlignedEndPoint:g,orientation:this._actualVisualElementsOrientation,visualizedMeasurement:this.actualVisualizedMeasurement,stripeLength:this._measurementArrowStripeLength}},
d=>this._updateGeometryAndViewMode(d),w.syncAndInitial),w.watch(()=>({visible:this.visible,viewMode:this.viewMode}),d=>this._updateVisualElementVisibility(d),w.syncAndInitial),w.watch(()=>({text:this._labelsText,visualizedMeasurement:this.actualVisualizedMeasurement}),d=>this._updateLabelText(d),w.syncAndInitial),w.watch(()=>({visible:this.visible,viewMode:this.viewMode}),d=>this._updateLabelVisibility(d),w.syncAndInitial),w.watch(()=>this._measurementArrowStripeLength,d=>this._updateSegmentStripeLength(d),
w.syncAndInitial),Y.onLocaleChange(G._asyncToGenerator(function*(){return a._updateMessageBundle()}))]);this._updateMessageBundle()};u.destroy=function(){this._handles=e.destroyMaybe(this._handles);this._segmentVisualElement=e.destroyMaybe(this._segmentVisualElement);this._triangleVisualElement=e.destroyMaybe(this._triangleVisualElement);this._rightAngleQuad=e.destroyMaybe(this._rightAngleQuad);this._projectedGeodesicLine=e.destroyMaybe(this._projectedGeodesicLine);this._geodesicStartHint=e.destroyMaybe(this._geodesicStartHint);
this._geodesicEndHint=e.destroyMaybe(this._geodesicEndHint);this._segmentLabel=e.destroyMaybe(this._segmentLabel);this._verticalLabel=e.destroyMaybe(this._verticalLabel);this._horizontalLabel=e.destroyMaybe(this._horizontalLabel);this.set("view",null)};u._updateVisualElementVisibility=function({visible:a,viewMode:b}){this._segmentVisualElement.visible=!1;this._triangleVisualElement.visible=!1;this._rightAngleQuad.visible=!1;this._projectedGeodesicLine.visible=!1;this._geodesicStartHint.visible=!1;
this._geodesicEndHint.visible=!1;if(a)switch(b){case h.ViewMode.Direct:this._segmentVisualElement.visible=!0;break;case h.ViewMode.Triangle:this._segmentVisualElement.visible=!0;this._triangleVisualElement.visible=!0;this._rightAngleQuad.visible=!0;break;case h.ViewMode.ProjectedGeodesic:this._segmentVisualElement.visible=!0,this._projectedGeodesicLine.visible=!0,this._geodesicStartHint.visible=!0,this._geodesicEndHint.visible=!0}};u._updateGeometryAndViewMode=function({view:a,camera:b,viewMode:c,
elevationAlignedStartPoint:f,elevationAlignedEndPoint:d,orientation:g,visualizedMeasurement:p,stripeLength:v}){const k=a.renderCoordsHelper;if(!(e.isNone(k)||e.isNone(f)||e.isNone(d)||f.equals(d))){var q=this._startPosition,r=this._endPosition;k.toRenderCoords(f,q);k.toRenderCoords(d,r);f=g===h.VisualElementOrientation.AboveSegment?1:-1;d=k.getAltitude(r);var y=k.getAltitude(q);d=f*(d-y);0>d&&(q=this._endPosition,r=this._startPosition);p="geodesic"===p?new x.GeodesicSegment(this._startPosition,this._endPosition,
k.spatialReference):new x.EuclideanSegment(this._startPosition,this._endPosition);this._segmentVisualElement.geometry=p;this._updateSegmentStripeLength(v);switch(c){case h.ViewMode.Direct:this._updateSegment(p,g);break;case h.ViewMode.Triangle:this._updateSegmentAndTriangle({view:a,camera:b,segment:p,orientation:g,startPosition:q,endPosition:r,deltaSign:f,altitudeDelta:d});break;case h.ViewMode.ProjectedGeodesic:this._updateSegmentAndProjection({view:a,orientation:g,startPosition:q,endPosition:r})}}};
u._updateSegment=function(a,b){this._segmentLabel.anchor=b===h.VisualElementOrientation.AboveSegment?"top":"bottom";this._segmentLabel.geometry={type:"segment",segment:a,sampleLocation:"center"}};u._updateSegmentAndTriangle=function({view:{renderCoordsHelper:a},camera:b,segment:c,orientation:f,startPosition:d,endPosition:g,deltaSign:p,altitudeDelta:v}){const k=this._cornerPosition;a.worldUpAtPosition(d,k);P.scale(k,k,p*Math.abs(v));P.add(k,k,d);this._triangleVisualElement.geometry=[[[d[0],d[1],d[2]],
[k[0],k[1],k[2]],[g[0],g[1],g[2]]]];this._rightAngleQuad.geometry={previous:d,center:k,next:g};a=new x.EuclideanSegment(d,k);p=new x.EuclideanSegment(k,g);var q=aa,r=ba;b.projectToRenderScreen(k,q);b.projectToRenderScreen(g,r);v="bottom";var y="top";q=q[0]<r[0]?"left":"right";const L=ca;r=da;J.screenSpaceTangent(d,k,L,b);J.screenSpaceTangent(d,g,r,b);O.dot(L,r)>=R?v=Math.sign(L[1])===Math.sign(r[1])?C.mirrorPosition(q):q:(d=ea,J.screenSpaceTangent(k,g,d,b),O.dot(d,r)>=R&&(v=Math.sign(d[0])===Math.sign(r[0])?
C.mirrorPosition(y):y));f===h.VisualElementOrientation.BelowSegment&&(v="top"===v?"bottom":"top",y="top"===y?"bottom":"top",q="top"===q?"bottom":"top");this._segmentLabel.anchor=v;this._segmentLabel.geometry={type:"segment",segment:c,sampleLocation:"center"};this._verticalLabel.geometry={type:"segment",segment:a,sampleLocation:"center"};this._verticalLabel.anchor=q;this._horizontalLabel.geometry={type:"segment",segment:p,sampleLocation:"center"};this._horizontalLabel.anchor=y};u._updateSegmentAndProjection=
function({view:{renderCoordsHelper:a},orientation:b,startPosition:c,endPosition:f}){a.setAltitude(this._startPositionAtSeaLevel,0,c);a.setAltitude(this._endPositionAtSeaLevel,0,f);a=new x.GeodesicSegment(this._startPositionAtSeaLevel,this._endPositionAtSeaLevel,a.spatialReference);this._projectedGeodesicLine.setGeometryFromSegment(a);this._geodesicStartHint.setGeometryFromSegment(new x.EuclideanSegment(this._startPositionAtSeaLevel,c));this._geodesicEndHint.setGeometryFromSegment(new x.EuclideanSegment(this._endPositionAtSeaLevel,
f));this._segmentLabel.geometry={type:"segment",segment:a,sampleLocation:"center"};this._segmentLabel.anchor=b===h.VisualElementOrientation.AboveSegment?"top":"bottom"};u._updateLabelText=function({text:a,visualizedMeasurement:b}){e.isSome(a)?(this._segmentLabel.text="euclidean"===b?a.euclideanDistance:a.geodesicDistance,this._horizontalLabel.text=a.horizontalDistance,this._verticalLabel.text=a.verticalDistance):(this._segmentLabel.text=null,this._horizontalLabel.text=null,this._verticalLabel.text=
null);this.notifyChange("labels")};u._updateLabelVisibility=function({visible:a,viewMode:b}){const c=this._segmentLabel,f=this._horizontalLabel,d=this._verticalLabel;c.visible=!1;f.visible=!1;d.visible=!1;if(a)switch(b){case h.ViewMode.Direct:c.visible=!0;break;case h.ViewMode.Triangle:c.visible=!0;f.visible=!0;d.visible=!0;break;case h.ViewMode.ProjectedGeodesic:c.visible=!0}};u._updateSegmentStripeLength=function(a){const b=this._segmentVisualElement;e.isSome(a)?(b.stripeLength=a,b.stripesEnabled=
!0):b.stripesEnabled=!1};u._requiresGeodesicGuideAt=function(a){var b=this.view;if(!b?.state)return!1;const c=b.renderCoordsHelper;b=b.state.camera.computeScreenPixelSizeAt(a);return 10<=c.getAltitude(a)/b};u._updateMessageBundle=function(){this.loadingMessages=!0;Z.fetchMessageBundle("esri/core/t9n/Units").then(a=>{this.messages=a}).finally(()=>{this.loadingMessages=!1})};G._createClass(F,[{key:"visible",get:function(){return this.analysisView.visible}},{key:"viewMode",get:function(){const {elevationAlignedStartPoint:a,
elevationAlignedEndPoint:b}=this.analysisView;if(e.isNone(a)||e.isNone(b)||a.equals(b))return h.ViewMode.None;var c=this.analysisView.result;if(e.isNone(c))return h.ViewMode.Direct;if("geodesic"===c.mode)return this._requiresGeodesicGuideAt(this._startPosition)||this._requiresGeodesicGuideAt(this._endPosition)?h.ViewMode.ProjectedGeodesic:h.ViewMode.Direct;const {verticalDistance:f,horizontalDistance:d}=c;c=f.value;const g=d.value;return Math.min(c/g,g/c)<this.triangleCollapseRatioThreshold?h.ViewMode.Direct:
h.ViewMode.Triangle}},{key:"actualVisualizedMeasurement",get:function(){if(e.isNone(this.analysisView.result))switch(this.analysisView.measurementMode){default:return"euclidean";case V.MeasurementMode.Geodesic:return"geodesic"}return this.analysisView.result.mode}},{key:"allowVisualElementsOrientationChange",get:function(){return e.isNone(this._triangleOrientationOverride)},set:function(a){e.isNone(this._triangleOrientationOverride)!==a&&(e.isNone(this._triangleOrientationOverride)?this._triangleOrientationOverride=
this._actualVisualElementsOrientation:this._triangleOrientationOverride=null)}},{key:"labels",get:function(){return{direct:this._segmentLabel,horizontal:"geodesic"===this.actualVisualizedMeasurement?this._segmentLabel:this._horizontalLabel,vertical:this._verticalLabel}}},{key:"_labelsText",get:function(){if(this.destroyed)return null;const a=this.messages;var b=this.analysisView.result;if(e.isNone(b)||e.isNone(a))return null;const {directDistance:c,horizontalDistance:f,verticalDistance:d,geodesicDistance:g}=
b;b=this.analysisView.unit;const p=v=>({euclideanDistance:"",geodesicDistance:"",horizontalDistance:"",verticalDistance:"",...v});switch(b){case "metric":return p({euclideanDistance:c&&t.formatMetricLength(a,c),geodesicDistance:g&&t.formatMetricLength(a,g),horizontalDistance:f&&t.formatMetricLength(a,f),verticalDistance:d&&t.formatMetricVerticalLength(a,d)});case "imperial":return p({euclideanDistance:c&&t.formatImperialLength(a,c),geodesicDistance:g&&t.formatImperialLength(a,g),horizontalDistance:f&&
t.formatImperialLength(a,f),verticalDistance:d&&t.formatImperialVerticalLength(a,d)});default:return p({euclideanDistance:c&&t.formatDecimal(a,c,b),geodesicDistance:g&&t.formatDecimal(a,g,b),horizontalDistance:f&&t.formatDecimal(a,f,b),verticalDistance:d&&t.formatDecimal(a,d,b)})}}},{key:"_actualVisualElementsOrientation",get:function(){if(e.isSome(this._triangleOrientationOverride))return this._triangleOrientationOverride;const a=this.visualElementOrientation;return a===h.VisualElementOrientation.Auto?
this.view.state.camera.aboveGround?h.VisualElementOrientation.AboveSegment:h.VisualElementOrientation.BelowSegment:a}},{key:"_measurementArrowStripeLength",get:function(){const {result:a,unit:b}=this.analysisView;if(e.isNone(a))return null;var c=null;c=a.directDistance;switch(b){case "metric":c=c&&I.toUnit(c,"meters");break;case "imperial":c=c&&I.toUnit(c,N.preferredImperialLengthUnit(c.value,c.unit));break;default:c=c&&I.toUnit(c,b)}return e.isNone(c)?null:M.nextHighestPowerOfTen(c.value/30)*N.convertUnit(1,
c.unit,"meters")}},{key:"testData",get:function(){return{labels:this.labels,stripeLength:this._segmentVisualElement?.stripeLength}}}]);return F}(S);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,"_triangleOrientationOverride",void 0);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,"messages",void 0);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,"view",void 0);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,
"analysis",void 0);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,"analysisView",void 0);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,"loadingMessages",void 0);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,"visible",null);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,"viewMode",null);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,"actualVisualizedMeasurement",
null);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,"visualElementOrientation",void 0);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,"triangleCollapseRatioThreshold",void 0);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,"allowVisualElementsOrientationChange",null);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,"labels",null);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,
"_labelsText",null);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,"_actualVisualElementsOrientation",null);m.__decorate([n.property()],l.DirectLineMeasurementVisualization.prototype,"_measurementArrowStripeLength",null);l.DirectLineMeasurementVisualization=m.__decorate([U.subclass("esri.views.3d.analysis.DirectLineMeasurement.DirectLineMeasurementVisualization")],l.DirectLineMeasurementVisualization);const R=Math.cos(M.deg2rad(12)),aa=A.createRenderScreenPointArray3(),
ba=A.createRenderScreenPointArray3(),ca=A.createRenderScreenPointArray(),da=A.createRenderScreenPointArray(),ea=A.createRenderScreenPointArray();Object.defineProperties(l,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});