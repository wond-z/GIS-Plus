// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../core/Collection ../../../core/Logger ../../../core/reactiveUtils ./RenderContext ../webgl-engine/core/shaderLibrary/ShaderOutput ../webgl-engine/lib/RenderSlot".split(" "),function(k,g,l,h,m,n,f){function e(d,c,a){if("function"===typeof d[c])d[c](a)}let q=function(){function d(){this._renderers=new g}var c=d.prototype;c.add=function(a,b){this._findOrCreateStageRenderer(a).add(b)};c.remove=function(a,b){(a=this._findStageRenderer(a))&&a.remove(b);
0===a.renderers.length&&(a.destroy(),this._renderers.remove(a))};c._findStageRenderer=function(a){return this._renderers.find(b=>b.view===a)};c._findOrCreateStageRenderer=function(a){let b=this._findStageRenderer(a);b||(b=new p(a),this._renderers.add(b));return b};return d}(),p=function(){function d(a){this.view=a;this.canRender=!0;this.renderers=new g;this._readyWatchHandle=h.watch(()=>a.ready,b=>{b?(this.context=new m(this.view),this.view._stage.addRenderPlugin([f.RenderSlot.OPAQUE_MATERIAL,f.RenderSlot.TRANSPARENT_MATERIAL],
this)):(this.renderers.forEach(r=>e(r,"dispose",this.context)),this.context=null)},h.initial)}var c=d.prototype;c.destroy=function(){this.renderers.drain(a=>{this.context&&e(a,"dispose",this.context)});this.view._stage&&this.view._stage.removeRenderPlugin(this);this._readyWatchHandle&&(this._readyWatchHandle.remove(),this._readyWatchHandle=null);this.context=null};c.add=function(a){this.renderers.includes(a)?l.getLogger("esri.views.3d.externalRenderers.ExternalRendererStore").warn("add(): Cannot add external renderer: renderer has already been added"):
(this.renderers.add(a),this.context&&(this._webglStateReset(),e(a,"setup",this.context),this.view._stage.renderView.requestRender()))};c.remove=function(a){const b=this.renderers.indexOf(a);-1!==b&&(this.renderers.removeAt(b),this.context&&(e(a,"dispose",this.context),this.view._stage.renderView.requestRender()))};c.initializeRenderContext=function(a){this.context.rctx=a.renderContext.rctx;0<this.renderers.length&&this._webglStateReset();this.renderers.forEach(b=>e(b,"setup",this.context))};c.uninitializeRenderContext=
function(){};c.render=function(a){0===this.renderers.length||a.output!==n.ShaderOutput.Color||a.bindParameters.slot!==f.RenderSlot.OPAQUE_MATERIAL&&a.bindParameters.slot!==f.RenderSlot.TRANSPARENT_MATERIAL||(this._updateContext(a),this._webglStateReset(),this.renderers.forEach(b=>{switch(a.bindParameters.slot){case f.RenderSlot.OPAQUE_MATERIAL:e(b,"render",this.context);break;case f.RenderSlot.TRANSPARENT_MATERIAL:e(b,"renderTransparent",this.context)}}))};c._updateContext=function(a){this.context.camera.copyFrom(a.bindParameters.camera);
this.context.sunLight=a.bindParameters.lighting.legacy;this.context._renderTargetHelper=a.offscreenRenderingHelper};c._webglStateReset=function(){this.context.rctx.resetState();this.context._renderTargetHelper?.bindFramebuffer()};k._createClass(d,[{key:"needsTransparentPass",get:function(){return this.renderers.some(a=>"function"===typeof a.renderTransparent)}}]);return d}();return q});