// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/Handles ../../../core/mathUtils ../../../core/maybe ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../chunks/mat3 ../../../chunks/mat4 ../../../chunks/mat4f64 ../../../chunks/vec2 ../../../chunks/vec2f64 ../../../chunks/vec3f32 ../../../geometry/projectionEllipsoid ../../../chunks/Clouds.glsl ./CloudsData ./CloudsPresets ./CloudsTechnique ./CloudsTechniqueConfiguration ./NoiseTextureAtlas ../webgl-engine/lib/BindParameters ../webgl-engine/lib/glUtil3D ../../support/Scheduler ../../webgl/enums ../../webgl/FramebufferObject".split(" "),
function(c,x,f,B,C,m,k,y,h,S,T,D,E,F,G,w,H,l,I,z,u,d,J,r,K,L,M,N,q,O){c.CloudsGenerator=function(A){function v(a){a=A.call(this,a)||this;a.runOncePerFrame=!0;a._handles=new C;a._techniques=[];a._techniqueConfiguration=new r.CloudsTechniqueConfiguration;a._bindParameters=new L.BindParameters(null,null,null);a._passParameters=new z.CloudsPassParameters;a._drawParameters=new z.CloudsDrawParameters;a._weatherTile=H.create();a._weatherTileCount=128;a._faceIndex=0;a._tileIndex=0;a.coverage=m.lerp(d.cloudPresets.default.coverage[0],
d.cloudPresets.default.coverage[1],.5);a.density=m.lerp(d.cloudPresets.default.density[0],d.cloudPresets.default.density[1],.5);a.absorption=m.lerp(d.cloudPresets.default.absorption[0],d.cloudPresets.default.absorption[1],.5);a.cloudSize=m.lerp(d.cloudPresets.default.cloudSize[0],d.cloudPresets.default.cloudSize[1],.5);a.detailSize=m.lerp(d.cloudPresets.default.detailSize[0],d.cloudPresets.default.detailSize[1],.5);a.smoothness=m.lerp(d.cloudPresets.default.smoothness[0],d.cloudPresets.default.smoothness[1],
.5);a.cloudHeight=m.lerp(d.cloudPresets.default.cloudHeight[0],d.cloudPresets.default.cloudHeight[1],.5);a.raymarchingSteps=d.cloudPresets.default.raymarchingSteps;a._viewMatrix=G.create();a._dirty=!1;a.running=!1;return a}x._inheritsLoose(v,A);var n=v.prototype;n._getTechnique=function(a){const b=1-this.context.renderContext.bindParameters.cloudsFade.readChannels,e=b===u.CloudsTextureChannels.RG?2*a:2*a+1,g=this._techniques[e];if(g)return g;this._techniqueConfiguration.writeTextureChannels=b;this._techniqueConfiguration.steps=
a;this._techniques[e]=new J.CloudsTechnique({rctx:this.context.renderContext.rctx,viewingMode:this.view.state.viewingMode},this._techniqueConfiguration);return this._techniques[e]};n.updateWeatherTile=function(){w.set(this._weatherTile,(this.view.camera.position.latitude+90)/180,(this.view.camera.position.longitude+180)/360);var a=Math.floor(this._weatherTileCount*Math.abs(2*this._weatherTile[0]-1));this._weatherTile[0]=Math.floor(2*this._weatherTileCount*this._weatherTile[0]);this._weatherTile[1]=
Math.floor(4*(this._weatherTileCount-a)*this._weatherTile[1]);var b=a=0;k.isSome(this.view.environment)&&"virtual"!==this.view.environment.lighting.type&&k.isSome(this.view.environment.lighting.date)&&(b=new Date(this.view.environment.lighting.date),b.setUTCHours(this.view.environment.lighting.date.getUTCHours()+this.view.environment.lighting.displayUTCOffset),a=31*b.getUTCMonth()+b.getUTCDate(),b=b.getUTCFullYear());this._weatherTile[0]=(this._weatherTile[0]+a)%(2*this._weatherTileCount);this._weatherTile[1]=
(this._weatherTile[1]+b%100)%(4*this._weatherTileCount);w.equals(this._passParameters.weatherTile,this._weatherTile)||this.setDirty()};n.initialize=function(){this._vao=M.createQuadVAO(this.context.renderContext.rctx);const a=I.getReferenceEllipsoid(this.view.spatialReference);this._passParameters.cloudRadius=.5*a.radius;this.setDirty();this.updateWeatherTile();this._handles.add([this.view.resourceController.scheduler.registerTask(N.TaskPriority.CLOUDS_GENERATOR,this),y.watch(()=>[this.coverage,this.density,
this.absorption,this.cloudSize,this.detailSize,this.smoothness,this.cloudHeight,this.raymarchingSteps],()=>this.setDirty(),y.initial)])};n.destroy=function(){this._handles.destroy();this._techniques.forEach(a=>k.releaseMaybe(a));this._frameBufferCube=k.disposeMaybe(this._frameBufferCube);this._techniques.length=0;this._vao=k.disposeMaybe(this._vao);this._passParameters.noiseTexture=k.destroyMaybe(this._passParameters.noiseTexture)};n._ensureNoiseTexture=function(){k.isSome(this._passParameters.noiseTexture)||
(this._passParameters.noiseTexture=new K.NoiseTextureAtlas({context:this.context}));this._passParameters.noiseTexture.updateWeatherMap(this._passParameters.weatherTile);return k.isSome(this._passParameters.noiseTexture.textureAtlas)};n._ensureFrameBufferCube=function(a){k.isNone(this._frameBufferCube)&&(this._frameBufferCube=new O.FramebufferObject(this.context.renderContext.rctx,{colorTarget:q.TargetType.CUBEMAP,width:a,height:a},{target:q.TextureType.TEXTURE_CUBE_MAP,pixelFormat:q.PixelFormat.RGBA,
dataType:q.PixelType.UNSIGNED_BYTE,wrapMode:q.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:q.TextureSamplingMode.LINEAR,hasMipmap:!1,width:a,height:a}));return this._frameBufferCube};n.destroyFrameBufferCube=function(){this._frameBufferCube=k.disposeMaybe(this._frameBufferCube)};n.applyPreset=function(a,b){const e=a.median,g=p=>{const t=m.lerp(p[0],p[1],e);return.5>b?m.lerp(p[0],t,2*b):m.lerp(t,p[1],2*(b-.5))};this.coverage=g(a.coverage);this.density=g(a.density);this.absorption=g(a.absorption);this.cloudSize=
g(a.cloudSize);this.detailSize=g(a.detailSize);this.smoothness=g(a.smoothness);this.cloudHeight=g(a.cloudHeight);this.raymarchingSteps=a.raymarchingSteps};n.setDirty=function(){this._dirty=this.running=!0};n.runTask=function(a){if(k.isNone(this._vao))this._dirty=this.running=!1,this.context.renderContext.bindParameters.cloudsFade.renderingStage=u.CloudsRenderingStages.FINISHED_RENDERING;else{0===this._faceIndex&&0===this._tileIndex&&(this._passParameters.raymarchingSteps=this.raymarchingSteps,this.updateWeatherTile(),
w.copy(this._passParameters.weatherTile,this._weatherTile));var b=this._getTechnique(this._passParameters.raymarchingSteps);if(b.compiled&&this.context.renderContext.bindParameters.cloudsFade.isCameraPositionFinal&&!this.context.renderContext.bindParameters.cloudsFade.isFading&&this._ensureNoiseTexture()){0===this._faceIndex&&0===this._tileIndex&&(this.context.renderContext.bindParameters.cloudsFade.renderingStage=u.CloudsRenderingStages.RENDERING,this._passParameters.absorption=this.absorption,this._passParameters.density=
this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._dirty=!1);var e=this.context.renderContext.rctx,g=e.bindTechnique(b,this._passParameters,this._bindParameters);e.bindVAO(this._vao);g.assertCompatibleVertexAttributeLocations(this._vao);var p=e.getViewport();b=b.configuration.cubeMapSize;var t=b/
this._tilesPerFace;e.setViewport(0,this._tileIndex*t,b,t);b=this._ensureFrameBufferCube(b);e.bindFramebuffer(b);F.targetTo(this._viewMatrix,P,Q[this._faceIndex],R[this._faceIndex]);E.fromMat4(this._drawParameters.viewMatrix,this._viewMatrix);b.setColorTextureTarget(q.TextureType.TEXTURE_CUBE_MAP_POSITIVE_X+this._faceIndex);g.bindDraw(this._drawParameters,this._bindParameters,this._passParameters);e.gl.drawArrays(e.gl.TRIANGLE_STRIP,0,4);e.gl.flush();e.setViewport(p.x,p.y,p.width,p.height);this.requestRender();
a.madeProgress();++this._tileIndex;4===this._faceIndex&&this._tileIndex===this._tilesPerFace?(this.running=this._dirty,this._tileIndex=this._faceIndex=0,this.context.renderContext.bindParameters.cloudsFade.renderingStage=u.CloudsRenderingStages.FINISHED_RENDERING):this._tileIndex===this._tilesPerFace&&(++this._faceIndex,this._tileIndex=0)}}};x._createClass(v,[{key:"_tilesPerFace",get:function(){switch(this._techniqueConfiguration.steps){case r.RayMarchingSteps.SIXTEEN:return 1;case r.RayMarchingSteps.HUNDRED:return 4;
case r.RayMarchingSteps.COUNT:case r.RayMarchingSteps.TWOHUNDRED:return 8}}},{key:"cubeMap",get:function(){return this._frameBufferCube}}]);return v}(B);f.__decorate([h.property({constructOnly:!0})],c.CloudsGenerator.prototype,"context",void 0);f.__decorate([h.property({constructOnly:!0})],c.CloudsGenerator.prototype,"view",void 0);f.__decorate([h.property({constructOnly:!0})],c.CloudsGenerator.prototype,"requestRender",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"coverage",void 0);
f.__decorate([h.property()],c.CloudsGenerator.prototype,"density",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"absorption",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"cloudSize",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"detailSize",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"smoothness",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"cloudHeight",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,
"raymarchingSteps",void 0);f.__decorate([h.property()],c.CloudsGenerator.prototype,"running",void 0);c.CloudsGenerator=f.__decorate([D.subclass("esri.views.3d.environment.CloudsGenerator")],c.CloudsGenerator);const Q=[l.fromValues(1,0,0),l.fromValues(-1,0,0),l.fromValues(0,1,0),l.fromValues(0,-1,0),l.fromValues(0,0,1)],R=[l.fromValues(0,1,0),l.fromValues(0,1,0),l.fromValues(0,0,-1),l.fromValues(0,0,1),l.fromValues(0,1,0)],P=l.zeros();Object.defineProperties(c,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});