// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/asyncUtils ../../../../core/Evented ../../../../core/Handles ../../../../core/mathUtils ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/screenUtils ../../../../core/urlUtils ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../support/requestImageUtils ./DefaultVertexBufferLayouts ./glUtil3D ./Program ./VertexAttribute ../shaders/Magnifier.glsl ../../../magnifier/resources ../../../webgl/enums ../../../webgl/renderState ../../../webgl/Texture".split(" "),
function(l,t,q,C,D,E,F,y,b,G,u,H,v,O,P,I,z,J,K,L,M,A,N,d,w,x){l.MagnifierHelper=function(B){function r(){var a=B.apply(this,arguments)||this;a._handles=new F;a._magnifier=null;a._imageSources=null;a._imageLoadTask=null;a._resources=null;a._passParameters=new A.MagnifierPassParameters;a.events=new E;a.attributeLocations=new Map([[M.VertexAttribute.POSITION,0]]);a._tmpScreenPoint=u.createScreenPointArray();a._tmpRenderPoint=u.createRenderScreenPointArray();return a}t._inheritsLoose(r,B);var k=r.prototype;
k.dispose=function(){this._magnifier=null;this._handles.destroy();b.isSome(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null);this._disposeResources()};k.render=function(a,c){const g=this._validMagnifier;if(!b.isNone(g)){var e=Math.ceil(c.camera.pixelRatio*g.size);this._updateResources(a,e);if(!b.isNone(this._resources)){var m=this._passParameters.textures;e=Math.ceil(1/this._factor*e);m.input.resize(e,e);u.screenPointObjectToArray(g.position,this._tmpScreenPoint);var f=
c.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),n=c.camera.fullHeight,p=.5*e,h=.5*e;f[0]=y.clamp(f[0],p,c.camera.fullWidth-p-1);f[1]=y.clamp(f[1],h,n-h-1);n=Math.floor(f[0]-p);f=Math.floor(f[1]-h);h=this._resources.program;h.bindTexture("textureInput",m.input);a.gl.copyTexImage2D(m.input.descriptor.target,0,m.input.descriptor.pixelFormat,n,f,e,e,0);this._passParameters.magnifier=g;a.useProgram(h);h.bindPass(this._passParameters,c);a.bindVAO(this._resources.vao);a.setPipelineState(this._resources.pipelineState);
a.drawArrays(d.PrimitiveType.TRIANGLE_STRIP,0,4)}}};k._updateResourceLoading=function(){var a=this;const c=this._validMagnifier;if(!b.isNone(c)){var g=c.maskUrl,e=c.overlayUrl;!b.isSome(this._imageLoadTask)||this._imageLoadTask.maskUrl===g&&this._imageLoadTask.overlayUrl===e||(this._imageLoadTask.task.abort(),this._imageSources=this._imageLoadTask=null);b.isSome(this._imageSources)||b.isSome(this._imageLoadTask)||(this._imageLoadTask={maskUrl:g,overlayUrl:e,task:D.createTask(function(){var m=t._asyncToGenerator(function*(f){const n=
b.isNone(g)||b.isNone(e)?N.loadMagnifierResources(f):null,p=b.isSome(g)?z.requestImage(g,{signal:f}):n.then(h=>h.mask);f=b.isSome(e)?z.requestImage(e,{signal:f}):n.then(h=>h.overlay);a._imageSources={mask:yield p,overlay:yield f};a._disposeResources();a.events.emit("request-render")});return function(f){return m.apply(this,arguments)}}())},this._imageLoadTask.task.promise.then(()=>this.notifyChange("updating"),()=>this.notifyChange("updating")))}};k._updateResources=function(a,c){this.enabled?b.isSome(this._resources)?
this._passParameters.textures.size!==c&&(a=this._createTextureResources(a,c),b.isNone(a)?this._disposeResources():(this._disposeTextureResources(this._passParameters.textures),this._passParameters.textures=a)):(c=this._createTextureResources(a,c),b.isNone(c)||(this._resources={program:this._createProgram(a),vao:K.createQuadVAO(a,J.Pos2,this.attributeLocations,0,1),pipelineState:w.makePipelineState({blending:w.simpleBlendingParams(d.BlendFactor.ONE,d.BlendFactor.ONE_MINUS_SRC_ALPHA),depthTest:null,
depthWrite:null,colorWrite:w.defaultColorWriteParams})},this._passParameters.textures=c)):this._disposeResources()};k._disposeResources=function(){b.isNone(this._resources)||(this._disposeTextureResources(this._passParameters.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)};k._disposeTextureResources=function(a){a.mask.dispose();a.overlay.dispose();a.input.dispose()};k._createTextureResources=function(a,c){if(b.isNone(this._imageSources))return null;
this._imageSources.overlay.width=c;this._imageSources.overlay.height=c;this._imageSources.mask.width=c;this._imageSources.mask.height=c;const g=new x.Texture(a,{target:d.TextureType.TEXTURE_2D,pixelFormat:d.PixelFormat.RGBA,internalFormat:d.PixelFormat.RGBA,dataType:d.PixelType.UNSIGNED_BYTE,wrapMode:d.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:d.TextureSamplingMode.LINEAR,flipped:!0,preMultiplyAlpha:H.isSVG(this._imageSources.overlay.src)&&a.driverTest.svgAlwaysPremultipliesAlpha?!1:!0},this._imageSources.overlay),
e=new x.Texture(a,{target:d.TextureType.TEXTURE_2D,pixelFormat:d.PixelFormat.ALPHA,internalFormat:d.PixelFormat.ALPHA,dataType:d.PixelType.UNSIGNED_BYTE,wrapMode:d.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:d.TextureSamplingMode.LINEAR,flipped:!0},this._imageSources.mask);return{input:new x.Texture(a,{target:d.TextureType.TEXTURE_2D,pixelFormat:d.PixelFormat.RGBA,internalFormat:d.PixelFormat.RGBA,dataType:d.PixelType.UNSIGNED_BYTE,wrapMode:d.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:d.TextureSamplingMode.LINEAR,
flipped:!1}),mask:e,overlay:g,size:c}};k._createProgram=function(a){return new L.Program(a,A.build(),this.attributeLocations)};t._createClass(r,[{key:"updating",get:function(){return b.isNone(this._imageSources)&&b.isSome(this._imageLoadTask)&&!this._imageLoadTask.task.finished}},{key:"magnifier",get:function(){return this._magnifier},set:function(a){a!==this._magnifier&&(this._handles.removeAll(),this._magnifier=a,a=()=>{this._updateResourceLoading();this.events.emit("request-render")},b.isSome(this._magnifier)&&
this._handles.add(G.watch(()=>b.applySome(this._magnifier,c=>c.version),a)),a())}},{key:"enabled",get:function(){return b.isSome(this._validMagnifier)}},{key:"_validMagnifier",get:function(){return b.isSome(this._magnifier)&&this._magnifier.visible&&b.isSome(this._magnifier.position)&&0<this._magnifier.size?this._magnifier:null}},{key:"_factor",get:function(){return b.isSome(this._magnifier)?this._magnifier.factor||1:1}}]);return r}(C);q.__decorate([v.property()],l.MagnifierHelper.prototype,"_imageSources",
void 0);q.__decorate([v.property()],l.MagnifierHelper.prototype,"_imageLoadTask",void 0);q.__decorate([v.property({readOnly:!0})],l.MagnifierHelper.prototype,"updating",null);l.MagnifierHelper=q.__decorate([I.subclass("esri/views/3d/webgl-engine/lib/MagnifierHelper")],l.MagnifierHelper);Object.defineProperties(l,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});