// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/has ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/PooledArray ../../../../../chunks/mat3 ../../../../../chunks/mat3f32 ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../chunks/vec4f32 ../../../../../chunks/vec32 ../../../../../chunks/vec33 ../../../../ViewingMode ../../../layers/i3s/I3SUtil ../../../layers/support/symbolColorUtils ../../../support/orientedBoundingBox ../../../support/buffer/glUtil ../../../support/buffer/InterleavedLayout ./ComponentData ./ComponentObject ./IntersectionGeometry ./Renderable ./RenderGeometry ./RenderSubmitSystem ./SourceGeometry ./Material/ComponentMaterial ./Material/ComponentTechnique ./Material/shader/ComponentData.glsl ../../lib/ComponentUtils ../../lib/Util ../../lib/VertexAttribute ../../lib/verticalOffsetUtils ../../lib/edgeRendering/bufferLayouts ../../lib/edgeRendering/edgeProcessing ../../lib/TextureBackedBuffer/BufferManager ../../../../webgl/BufferObject ../../../../webgl/enums ../../../../webgl/VertexArrayObject".split(" "),
function(M,N,W,D,m,O,P,X,w,E,Q,Y,Z,aa,ba,F,G,R,ca,da,y,ea,fa,ha,ia,ja,r,ka,la,S,ma,na,oa,pa,qa,ra,H,z,sa){function I(u,h){return u===h?r.ComponentParameterSummary.All:0===u?r.ComponentParameterSummary.None:r.ComponentParameterSummary.Some}const T=D.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");D=function(){function u(a,b){this._renderManager=a;this._viewingMode=b;this._objects=[new O,new O];this._renderSubmit=new ia.RenderSubmitSystem(this);this._renderManager.register(this._renderSubmit);
this._hasObjectAndLayerId=W("enable-feature:objectAndLayerId-rendering");this._componentBufferManager=new ra.BufferManager(a.rctx,2+(this._hasObjectAndLayerId?1:0))}var h=u.prototype;h.dispose=function(){ma.assert(0===this._objects[y.State.Hidden].length&&0===this._objects[y.State.Visible].length,"ObjectCollection should be empty upon disposal");this._componentBufferManager.destroy()};h.createObject=function(a){const b=new y.ComponentObject;b.toMapSpace=a.toMapSpace;b.transform=a.transform;b.obb=
G.clone(a.obb);b.components=new da(this._componentBufferManager,a.geometry.componentOffsets);b.renderable=this._createRenderable(a,b.components);b.intersectionGeometry=new ea(a.geometry.positionData,b.components);this._objects[b.visible].push(b);return b};h.destroyObject=function(a){this._objects[a.visible].removeUnordered(a);a.dispose();this._notifyDirty()};h.setObjectVisibility=function(a,b){b!==a.visible&&(this._objects[a.visible].removeUnordered(a),this._objects[b].push(a),a.visible=b,this._notifyDirty())};
h.preSubmit=function(a){const b=a.camera.eye;this.visibleObjects.forAll(c=>c.renderable.meta.cameraDepthSquared=w.squaredDistance(b,c.obb.center))};h.getMaterial=function(a){return a.renderable.material};h.updateMaterial=function(a,b){a=a.renderable.material;b(a);a.dirty&&this._notifyDirty()};h.setAllComponentVisibilities=function(a,b){a.components.visibility.reset(b);a.components.visibilityDirty();this._notifyDirty()};h.forEachVisibleComponent=function(a,b){return a.components.visibility.forEachComponent(b)};
h.getComponentCount=function(a){const b=a.components.visibility.componentCount();return{visible:b,invisible:a.components.count-b}};h.setComponentData=function(a,b){const c=a.renderable.material,d=a.components;var e=d.materialDataBuffer;const k=d.materialDataIndices,f={castShadows:!0,pickable:!0,externalColor:Q.create(),externalColorMixMode:F.ColorMixModeEnum.Multiply,elevationOffset:0,objectAndLayerIdColor:this._hasObjectAndLayerId?Q.create():null};e=e.textureBuffer;const g=new Uint8Array(4),l=new Uint32Array(g.buffer);
let q=0,p=0,x=0,t=d.verticalOffsets,J=Infinity,K=-Infinity,L=!1,v=!1,U=0;for(let n=0;n<d.count;n++){b(n,f);q+=+(1>f.externalColor[3]);p+=+(f.externalColorMixMode===F.ColorMixModeEnum.Replace&&1===f.externalColor[3]);x+=+f.castShadows;F.encodeSymbolColor(f.externalColor,f.externalColorMixMode,g);g[2]=g[2]&254|+f.castShadows;e.setData(k[n],0,g[0],g[1],g[2],g[3]);L||(L=0<n&&U!==l[0]);U=l[0];v||(v=0!==f.elevationOffset);v&&m.isNone(t)&&(t=Array(n).fill(0));m.isSome(t)&&(t[n]=f.elevationOffset);J=Math.min(J,
f.elevationOffset);K=Math.max(K,f.elevationOffset);la.encodeElevationOffset(f.elevationOffset,g);e.setData(k[n],1,g[0],g[1],g[2],g[3]);if(this._hasObjectAndLayerId){const A=f.objectAndLayerIdColor;e.setData(k[n],2,A[0],A[1],A[2],A[3])}f.pickable!==S.getVisibility(d.pickability,n)&&(d.pickability=S.updateVisibilityWithCount(d.pickability,d.count,n,f.pickable))}d.verticalOffsets=v?t:null;a.offsetObb=v?ba.computeOffsetObb(a.obb,J,K,this._viewingMode,m.isSome(a.offsetObb)?a.offsetObb:G.clone(a.obb)):
null;L||v||this._hasObjectAndLayerId?(c.componentParameters=new r.ComponentParametersVarying,c.componentParameters.castShadows=I(x,d.count),c.componentParameters.transparent=I(q,d.count),c.componentParameters.opaqueOverride=I(p,d.count),c.componentParameters.texture=e,e.updateTexture()):(c.componentParameters=new r.ComponentParametersUniform,c.componentParameters.castShadows=f.castShadows?r.ComponentParameterSummary.All:r.ComponentParameterSummary.None,c.componentParameters.externalColor=f.externalColor,
c.componentParameters.externalColorMixMode=f.externalColorMixMode);this._notifyDirty()};h.getComponentAabb=function(a,b,c,d=!1){a.intersectionGeometry.getComponentAabb(b,c);const e=a.components.verticalOffsets;if(d||m.isNone(e))return c;b=e[b];if(this._viewingMode===aa.ViewingMode.Local||0===b)return c[2]+=b,c[5]+=b,c;b=m.unwrap(oa.getVerticalOffsetI3S(b));b.localOrigin=a.transform.position;return b.applyToAabb(c)};h.getComponentObb=function(a){return a.obb};h.getObjectTransform=function(a){return a.transform};
h.getComponentPositions=function(a,b,c){return a.intersectionGeometry.getComponentPositions(b,c)};h.intersect=function(a,b,c,d,e,k){m.isSome(e)&&(e.localOrigin=a.transform.position);const f=P.invert(V,a.transform.rotationScale);w.sub(B,b,a.transform.position);w.sub(C,c,a.transform.position);w.transformMat3(B,B,f);w.transformMat3(C,C,f);b=P.transpose(V,f);return a.intersectionGeometry.intersect(B,C,d,b,e,a.components.verticalOffsets,k)};h.addEdges=function(a,b,c,d){const {indices:e,positions:k}=a.intersectionGeometry,
f=a.components.offsets;return b.addComponentObject(a,a.transform,{center:a.obb.center,radius:G.radius(a.obb)},k,e,f,c,d)};h.extractEdgeInformation=function(){var a=N._asyncToGenerator(function*(b,c,d){var e=b.components.visibility;if(e.allInvisible())return{buffer:qa.extractComponentsEdgeLocationsLayout.createBuffer(0),origin:[0,0,0]};const {indices:k,positions:f}=b.intersectionGeometry,g=b.components.offsets,l=pa.EdgeInputBufferLayout.createBuffer(f.count);Z.copy(l.position,f);Y.transformMat3(l.position,
l.position,b.transform.rotationScale);this._setComponentIndices(l.componentIndex,k,g);e=this._computeVisibilityIndices(k,e,g,l.count);b=E.clone(b.transform.position);c=yield c.extractComponentsEdgeLocations({indices:e,indicesLength:e.length,skipDeduplicate:!0,data:l,writerSettings:{reducedPrecision:!1,variants:0}},d);return{origin:b,buffer:c}});return function(b,c,d){return a.apply(this,arguments)}}();h._setComponentIndices=function(a,b,c){let d=0;for(let k=0;k<c.length-1;k++){var e=c[k];const f=
c[k+1];for(;e<f;e++)a.set(b?b[e]:e,d);d++}};h._computeVisibilityIndices=function(a,b,c,d){if(a&&b.allVisible())return a;let e=0;b.forEachComponentRange((g,l)=>{e+=c[l]-c[g];return!0});const k=Array.isArray(a)?Array(e):2===a?.BYTES_PER_ELEMENT||65536>=d?new Uint16Array(e):new Uint32Array(e);let f=0;b.forEachComponentRange((g,l)=>{g=c[g];for(l=c[l];g<l;g++)k[f++]=a?a[g]:g;return!0});return k};h.addComponentHighlight=function(a,b){a=a.components;m.isNone(a.highlightCounts)&&(a.highlightCounts=new Uint32Array(a.count+
1));0===a.highlightCounts[b]++&&(a.highlightsDirty(),this._notifyDirty());a.highlightCounts[a.count]++};h.removeComponentHighlight=function(a,b){a=a.components;if(m.isNone(a.highlightCounts))T.warn("Removing non-existing highlight.");else{var c=a.highlightCounts[b],d=a.highlightCounts[a.count];0===c?T.warn("Removing non-existing highlight."):1<c?(a.highlightCounts[b]=c-1,a.highlightCounts[a.count]=d-1):(a.highlightCounts[b]=0,a.highlightsDirty(),this._notifyDirty(),1===d?a.highlightCounts=null:a.highlightCounts[a.count]=
d-1)}};h.clearHighlights=function(a){a=a.components;m.isSome(a.highlightCounts)&&(a.highlightCounts=null,a.highlightsDirty(),this._notifyDirty())};h.getObjectGPUMemoryUsage=function(a){return a.renderable.meta.gpuMemoryEstimate};h._createRenderable=function(a,b){const c=this._renderManager.rctx,d=a.geometry;var e=d.vertices.layoutParameters,k=H.BufferObject.createVertex(c,z.Usage.STATIC_DRAW,d.vertices.data);const f=m.applySome(d.indices,p=>H.BufferObject.createIndex(c,z.Usage.STATIC_DRAW,p));var g=
R.glLayout(ja.createVertexBufferLayout(e));const l=new Uint16Array(d.vertices.count);for(let p=0;p<b.count;p++){var q=b.offsets[p];const x=b.offsets[p+1],t=b.materialDataIndices[p];if(m.isSome(d.indices))for(;q<x;q++)l[d.indices[q]]=t;else for(;q<x;q++)l[q]=t}b=H.BufferObject.createVertex(c,z.Usage.STATIC_DRAW,l.buffer);a=new r.ComponentMaterial(a.transform,a.toMapSpace);g=new sa.VertexArrayObject(c,ka.attributeLocations,{data:g,componentIndices:ta},{data:k,componentIndices:b},m.unwrap(f));e=new ha.RenderGeometry(g,
z.PrimitiveType.TRIANGLES,e,m.isSome(f));k={cameraDepthSquared:.5,gpuMemoryEstimate:k.byteSize+b.byteSize+(m.isSome(f)?f.byteSize:0)};return new fa.Renderable(a,e,k)};h._notifyDirty=function(){this._renderManager.notifyDirty()};N._createClass(u,[{key:"visibleObjects",get:function(){return this._objects[y.State.Visible]}}]);return u}();const ta=R.glLayout(ca.newLayout().u16(na.VertexAttribute.COMPONENTINDEX)),V=X.create(),B=E.create(),C=E.create();M.ComponentObjectCollection=D;Object.defineProperties(M,
{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});