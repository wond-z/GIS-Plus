// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/compilerUtils ../../../../core/Error ../../../../core/Evented ../../../../core/mathUtils ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/typedArrayUtil ../../../../core/urlUtils ../../../../support/requestImageUtils ../../../../support/requestUtils ../../../../chunks/TextureOnly.glsl ./basicInterfaces ./BasisUtil ./ContentObject ./ContentObjectType ./DDSUtil ./glUtil3D ./Util ../../../webgl/enums ../../../webgl/FramebufferObject ../../../webgl/Texture ../../../webgl/Util ../../../webgl/capabilities/isWebGL2Context".split(" "),
function(C,w,D,E,F,x,n,y,p,A,G,H,I,B,z,r,J,K,L,M,h,N,t,O,P){r=function(m){function l(b,c){var a=m.call(this)||this;a._data=b;a.type=J.ContentObjectType.Texture;a._glTexture=null;a._powerOfTwoStretchInfo=null;a._loadingPromise=null;a._loadingController=null;a.events=new F;a._passParameters=new I.TextureOnlyPassParameters;a.params=c||{};a.params.mipmap=!1!==a.params.mipmap;a.params.noUnpackFlip=a.params.noUnpackFlip||!1;a.params.preMultiplyAlpha=a.params.preMultiplyAlpha||!1;a.params.wrap=a.params.wrap||
{s:h.TextureWrapMode.REPEAT,t:h.TextureWrapMode.REPEAT};a.params.powerOfTwoResizeMode=a.params.powerOfTwoResizeMode||B.PowerOfTwoResizeMode.STRETCH;a.estimatedTexMemRequired=l._estimateTexMemRequired(a._data,a.params);a._startPreload();return a}w._inheritsLoose(l,m);var g=l.prototype;g._startPreload=function(){const b=this._data;n.isNone(b)||(b instanceof HTMLVideoElement?this._startPreloadVideoElement(b):b instanceof HTMLImageElement&&this._startPreloadImageElement(b))};g._startPreloadVideoElement=
function(b){if(!(A.isBlobProtocol(b.src)||"auto"===b.preload&&b.crossOrigin)){b.preload="auto";b.crossOrigin="anonymous";const c=!b.paused;b.src=b.src;if(c&&b.autoplay){const a=()=>{b.removeEventListener("canplay",a);b.play()};b.addEventListener("canplay",a)}}};g._startPreloadImageElement=function(b){A.isDataProtocol(b.src)||A.isBlobProtocol(b.src)||b.crossOrigin||(b.crossOrigin="anonymous",b.src=b.src)};l._getDataDimensions=function(b){return b instanceof HTMLVideoElement?{width:b.videoWidth,height:b.videoHeight}:
b};l._estimateTexMemRequired=function(b,c){if(n.isNone(b))return 0;if(p.isArrayBuffer(b)||p.isUint8Array(b))return c.encoding===l.KTX2_ENCODING?z.estimateMemoryKTX2(b,c.mipmap):c.encoding===l.BASIS_ENCODING?z.estimateMemoryBasis(b,c.mipmap):b.byteLength;const {width:a,height:d}=b instanceof Image||b instanceof ImageData||b instanceof HTMLCanvasElement||b instanceof HTMLVideoElement?l._getDataDimensions(b):c;return(c.mipmap?4/3:1)*a*d*(c.components||4)||0};g.dispose=function(){this._data=void 0};g._createDescriptor=
function(b){return{target:h.TextureType.TEXTURE_2D,pixelFormat:h.PixelFormat.RGBA,dataType:h.PixelType.UNSIGNED_BYTE,wrapMode:this.params.wrap,flipped:!this.params.noUnpackFlip,samplingMode:this.params.mipmap?h.TextureSamplingMode.LINEAR_MIPMAP_LINEAR:h.TextureSamplingMode.LINEAR,hasMipmap:this.params.mipmap,preMultiplyAlpha:this.params.preMultiplyAlpha,maxAnisotropy:this.params.maxAnisotropy??(this.params.mipmap?b.parameters.maxMaxAnisotropy:1)}};g.load=function(b,c){if(n.isSome(this._glTexture))return this._glTexture;
if(n.isSome(this._loadingPromise))return this._loadingPromise;const a=this._data;return n.isNone(a)?this._glTexture=new t.Texture(b,this._createDescriptor(b),null):"string"===typeof a?this._loadFromURL(b,c,a):a instanceof Image?this._loadFromImageElement(b,c,a):a instanceof HTMLVideoElement?this._loadFromVideoElement(b,c,a):a instanceof ImageData||a instanceof HTMLCanvasElement?this._loadFromImage(b,a,c):(p.isArrayBuffer(a)||p.isUint8Array(a))&&this.params.encoding===l.DDS_ENCODING?(this._data=void 0,
this._loadFromDDSData(b,a)):(p.isArrayBuffer(a)||p.isUint8Array(a))&&this.params.encoding===l.KTX2_ENCODING?(this._data=void 0,this._loadFromKTX2(b,a)):(p.isArrayBuffer(a)||p.isUint8Array(a))&&this.params.encoding===l.BASIS_ENCODING?(this._data=void 0,this._loadFromBasis(b,a)):p.isUint8Array(a)?this._loadFromPixelData(b,a):p.isArrayBuffer(a)?this._loadFromPixelData(b,new Uint8Array(a)):null};g.frameUpdate=function(b,c,a){if(!(this._data instanceof HTMLVideoElement)||n.isNone(this._glTexture)||this._data.readyState<
u.HAVE_CURRENT_DATA||a===this._data.currentTime)return a;if(n.isSome(this._powerOfTwoStretchInfo)){const {framebuffer:d,vao:f,sourceTexture:e}=this._powerOfTwoStretchInfo;e.setData(this._data);this._drawStretchedTexture(b,c,d,f,e,this._glTexture)}else{const {videoWidth:d,videoHeight:f}=this._data,{width:e,height:k}=this._glTexture.descriptor;d!==e||f!==k?this._glTexture.updateData(0,0,0,Math.min(d,e),Math.min(f,k),this._data):this._glTexture.setData(this._data)}this._glTexture.descriptor.hasMipmap&&
this._glTexture.generateMipmap();this.params.updateCallback&&this.params.updateCallback();return this._data.currentTime};g._loadFromDDSData=function(b,c){return this._glTexture=K.createDDSTexture(b,this._createDescriptor(b),c)};g._loadFromKTX2=function(b,c){return this._loadAsync(()=>z.createTextureKTX2(b,this._createDescriptor(b),c).then(a=>this._glTexture=a))};g._loadFromBasis=function(b,c){return this._loadAsync(()=>z.createTextureBasis(b,this._createDescriptor(b),c).then(a=>this._glTexture=a))};
g._loadFromPixelData=function(b,c){M.assert(0<this.params.width&&0<this.params.height);const a=this._createDescriptor(b);a.pixelFormat=1===this.params.components?h.PixelFormat.LUMINANCE:3===this.params.components?h.PixelFormat.RGB:h.PixelFormat.RGBA;a.width=this.params.width;a.height=this.params.height;return this._glTexture=new t.Texture(b,a,c)};g._loadFromURL=function(b,c,a){var d=this;return this._loadAsync(function(){var f=w._asyncToGenerator(function*(e){const k=yield G.requestImage(a,{signal:e});
y.throwIfAborted(e);return d._loadFromImage(b,k,c)});return function(e){return f.apply(this,arguments)}}())};g._loadFromImageElement=function(b,c,a){var d=this;return a.complete?this._loadFromImage(b,a,c):this._loadAsync(function(){var f=w._asyncToGenerator(function*(e){const k=yield H.loadImageAsync(a,a.src,!1,e);y.throwIfAborted(e);return d._loadFromImage(b,k,c)});return function(e){return f.apply(this,arguments)}}())};g._loadFromVideoElement=function(b,c,a){return a.readyState>=u.HAVE_CURRENT_DATA?
this._loadFromImage(b,a,c):this._loadFromVideoElementAsync(b,c,a)};g._loadFromVideoElementAsync=function(b,c,a){return this._loadAsync(d=>new Promise((f,e)=>{const k=()=>{a.removeEventListener("loadeddata",v);a.removeEventListener("error",q);n.removeMaybe(Q)},v=()=>{a.readyState>=u.HAVE_CURRENT_DATA&&(k(),f(this._loadFromImage(b,a,c)))},q=R=>{k();e(R||new E("Failed to load video"))};a.addEventListener("loadeddata",v);a.addEventListener("error",q);const Q=y.onAbort(d,()=>q(y.createAbortError()))}))};
g._loadFromImage=function(b,c,a){const d=l._getDataDimensions(c);this.params.width=d.width;this.params.height=d.height;const f=this._createDescriptor(b);f.pixelFormat=3===this.params.components?h.PixelFormat.RGB:h.PixelFormat.RGBA;if(this._requiresPowerOfTwo(b,f)&&(!x.isPowerOfTwo(d.width)||!x.isPowerOfTwo(d.height)))return this._glTexture=this._makePowerOfTwoTexture(b,c,d,f,a);f.width=d.width;f.height=d.height;return this._glTexture=new t.Texture(b,f,c)};g._loadAsync=function(b){const c=new AbortController;
this._loadingController=c;const a=b(c.signal);this._loadingPromise=a;b=()=>{this._loadingController===c&&(this._loadingController=null);this._loadingPromise===a&&(this._loadingPromise=null)};a.then(b,b);return a};g._requiresPowerOfTwo=function(b,c){var a=h.TextureWrapMode.CLAMP_TO_EDGE;a="number"===typeof c.wrapMode?c.wrapMode===a:c.wrapMode.s===a&&c.wrapMode.t===a;return!P(b.gl)&&(c.hasMipmap||!a)};g._makePowerOfTwoTexture=function(b,c,a,d,f){const {width:e,height:k}=a;a=x.nextHighestPowerOfTwo(e);
const v=x.nextHighestPowerOfTwo(k);d.width=a;d.height=v;let q;switch(this.params.powerOfTwoResizeMode){case B.PowerOfTwoResizeMode.PAD:d.textureCoordinateScaleFactor=[e/a,k/v];q=new t.Texture(b,d);q.updateData(0,0,0,e,k,c);break;case B.PowerOfTwoResizeMode.STRETCH:case null:case void 0:q=this._stretchToPowerOfTwo(b,c,d,f());break;default:D.neverReached(this.params.powerOfTwoResizeMode)}d.hasMipmap&&q.generateMipmap();return q};g._stretchToPowerOfTwo=function(b,c,a,d){const f=new t.Texture(b,a),e=
new N.FramebufferObject(b,{colorTarget:h.TargetType.TEXTURE,depthStencilTarget:h.DepthStencilTargetType.NONE},f);c=new t.Texture(b,{target:h.TextureType.TEXTURE_2D,pixelFormat:a.pixelFormat,dataType:h.PixelType.UNSIGNED_BYTE,wrapMode:h.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:h.TextureSamplingMode.LINEAR,flipped:!!a.flipped,maxAnisotropy:8,preMultiplyAlpha:a.preMultiplyAlpha},c);a=L.createQuadVAO(b);const k=b.getBoundFramebufferObject();this._drawStretchedTexture(b,d,e,a,c,f);this.requiresFrameUpdates?
this._powerOfTwoStretchInfo={vao:a,sourceTexture:c,framebuffer:e}:(a.dispose(!0),c.dispose(),e.detachColorTexture(),e.dispose());b.bindFramebuffer(k);return f};g._drawStretchedTexture=function(b,c,a,d,f,e){this._passParameters.texture=f;b.bindFramebuffer(a);a=b.getViewport();b.setViewport(0,0,e.descriptor.width,e.descriptor.height);b.bindTechnique(c,this._passParameters,null);b.bindVAO(d);b.drawArrays(h.PrimitiveType.TRIANGLE_STRIP,0,O.vertexCount(d,"geometry"));b.bindFramebuffer(null);b.setViewport(a.x,
a.y,a.width,a.height);this._passParameters.texture=null};g.unload=function(){if(n.isSome(this._powerOfTwoStretchInfo)){const {framebuffer:b,vao:c,sourceTexture:a}=this._powerOfTwoStretchInfo;c.dispose(!0);a.dispose();b.dispose();this._powerOfTwoStretchInfo=this._glTexture=null}n.isSome(this._glTexture)&&(this._glTexture.dispose(),this._glTexture=null);if(n.isSome(this._loadingController)){const b=this._loadingController;this._loadingPromise=this._loadingController=null;b.abort()}this.events.emit("unloaded")};
w._createClass(l,[{key:"width",get:function(){return this.params.width}},{key:"height",get:function(){return this.params.height}},{key:"glTexture",get:function(){return this._glTexture}},{key:"requiresFrameUpdates",get:function(){return this._data instanceof HTMLVideoElement}}]);return l}(r.ContentObject);r.DDS_ENCODING="image/vnd-ms.dds";r.KTX2_ENCODING="image/ktx2";r.BASIS_ENCODING="image/x.basis";var u;(function(m){m[m.HAVE_NOTHING=0]="HAVE_NOTHING";m[m.HAVE_METADATA=1]="HAVE_METADATA";m[m.HAVE_CURRENT_DATA=
2]="HAVE_CURRENT_DATA";m[m.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA";m[m.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"})(u||(u={}));C.Texture=r;Object.defineProperties(C,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});