// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/MapUtils ../../../../../core/maybe ../../../../../core/PooledArray ../../../../../chunks/mat4 ../../../../../chunks/mat4f64 ../../../support/buffer/glUtil ../../core/shaderLibrary/ShaderOutput ../../lib/GLMaterials ../../lib/Material ../../lib/ModelDirtyTypes ../../lib/Util ../DrawParameters ../WaterMaterial ./Instance ./MergedGeometryBuffer ./MergedGeometryBufferPool ./utils".split(" "),function(F,G,K,w,v,B,C,L,D,
M,N,x,A,O,P,r,H,Q,R){function S(m,k){const a=new Map;for(const b of m)I(a,b,!0);for(const b of k)I(a,b,!1);return a}function I(m,k,a){const b=k.origin;if(!w.isNone(b)){var c=m.get(b.id);null==c&&(c=new T(b.vec3),m.set(b.id,c));a?c.add.push(k):c.remove.push(k)}}function U(m,k){let a;if(!m.some(c=>{if(c.to-c.from<k)return!1;a=c;return!0}))return null;const b=a.from;a.from+=k;a.from>=a.to&&m.removeUnordered(a);return b}function J(m){const k=new Map;m.forAll(b=>k.set(b.from,b));let a=!0;for(;a;)a=!1,
m.forEach(b=>{const c=k.get(b.to);c&&(b.to=c.to,k.delete(c.from),m.removeUnordered(c),a=!0)})}let Z=function(){function m(a,b,c){this._rctx=a;this._materialRepository=b;this._material=c;this.type="MergedRenderer";this._dataByOrigin=new Map;this._renderCommandData=new v;this._hasOccludees=this._hasHighlights=!1;this._glMaterials=new M.GLMaterials(this._material,this._materialRepository);this._bufferWriter=c.createBufferWriter();this._bufferPool=new Q.MergedGeometryBufferPool(a,c.vertexAttributeLocations,
L.glLayout(this._bufferWriter.vertexBufferLayout))}var k=m.prototype;k.dispose=function(){this._glMaterials.destroy();this._dataByOrigin.forEach(a=>a.geometry.dispose());this._dataByOrigin.clear();this._bufferPool.dispose()};k.modify=function(a){this._updateGeometries(a.updates);this._addAndRemoveGeometries(a.adds,a.removes);this._updateDrawCommands()};k._addAndRemoveGeometries=function(a,b){const c=this._bufferWriter,d=c.vertexBufferLayout.stride/4,n=this._dataByOrigin,e=S(a,b);e.forEach((f,h)=>
{e.delete(h);var g=f.add.reduce((q,u)=>q+c.elementCount(u.data),0);let l=n.get(h);if(null==l)A.assert(0===f.remove.length),l=new V(f.origin,new H.MergedGeometryBuffer(this._bufferPool,g*d)),n.set(h,l);else if(0===f.add.length&&l.instances.size===f.remove.length){l.geometry.dispose();n.delete(h);return}let t=0;l.instances.forEach(q=>t+=q.to-q.from);var p=f.remove.reduce((q,u)=>q+c.elementCount(u.data),0);h=l.geometry.size;p=(t+g-p)*d;g=W;p>H.BLOCK_SIZE&&(p<h/2||1048576<h-p)?this._removeAndRebuild(l,
f.remove,d,p,g):0<f.remove.length&&this._remove(l,f.remove,d,g);0<f.add.length&&(h=X,A.setMatrixTranslation3(h,-f.origin[0],-f.origin[1],-f.origin[2]),this._add(l,f.add,d,h,g));const y=l.geometry.buffer.vao.vertexBuffers.geometry;J(g);g.forAll(({from:q,to:u})=>{q<u&&y.setSubData(l.geometry.buffer.array,q,q,u)});g.clear();l.drawCommandsDirty=!0})};k._updateGeometries=function(a){const b=this._bufferWriter,c=b.vertexBufferLayout.stride/4;for(const d of a){a=d.renderGeometry;const n=this._dataByOrigin.get(a.origin.id),
e=n&&n.instances.get(a.id);if(!e)break;const f=d.updateType;f&x.DirtyState.VISIBILITIES&&(e.isVisible=a.instanceParameters.visible);if(f&(x.DirtyState.HIGHLIGHTS|x.DirtyState.VISIBILITIES)){const h=a.instanceParameters.visible;e.hasHighlights=!!a.instanceParameters.highlights&&h}f&x.DirtyState.OCCLUDEES&&(e.hasOccludees=!!a.instanceParameters.occludees);if(f&(x.DirtyState.VERTEXATTRS|x.DirtyState.TRANSFORMATION)){const {array:h,vao:g}=n.geometry.buffer;R.calculateTransformRelativeToOrigin(a,E,z);
b.write(E,z,a.data,b.vertexBufferLayout.createView(h.buffer),e.from);A.assert(e.from+b.elementCount(a.data)===e.to,"material VBO layout has changed");g.vertexBuffers.geometry.setSubData(h,e.from*c,e.from*c,e.to*c)}n.drawCommandsDirty=!0}};k._updateDrawCommands=function(){this._hasOccludees=this._hasHighlights=!1;this._dataByOrigin.forEach(b=>{b.hasHiddenInstances=!1;b.hasHighlights=!1;b.hasOccludees=!1;K.someMap(b.instances,c=>{c.isVisible?(c.hasHighlights&&(this._hasHighlights=!0,b.hasHighlights=
!0),c.hasOccludees&&(this._hasOccludees=!0,b.hasOccludees=!0)):b.hasHiddenInstances=!0;return b.hasHiddenInstances&&b.hasHighlights&&b.hasOccludees})});const a=b=>{b.drawCommandsDefault.clear();b.drawCommandsHighlight.clear();b.drawCommandsOccludees.clear();b.drawCommandsShadowHighlightRest.clear();if(0!==b.instances.size)if(b.hasOccludees||b.hasHighlights||b.hasHiddenInstances){var c=r.sortInstancesByRange(b.instances);for(const d of c)d.isVisible&&(d.hasOccludees?r.addOrMerge(b.drawCommandsOccludees,
d):r.addOrMerge(b.drawCommandsDefault,d),d.hasHighlights?r.addOrMerge(b.drawCommandsHighlight,d):r.addOrMerge(b.drawCommandsShadowHighlightRest,d))}else{const d=b.drawCommandsDefault.pushNew();d.first=Infinity;d.count=0;b.instances.forEach(n=>{d.first=Math.min(d.first,n.from);d.count=Math.max(d.count,n.to)});d.count-=d.first}};this._dataByOrigin.forEach(b=>{b.drawCommandsDirty&&(a(b),b.drawCommandsDirty=!1)})};k.updateAnimation=function(a){return this._material.update(a)};k.requiresSlot=function(a,
b){return this._material.requiresSlot(a,b)};k.render=function(a,b){if(!this.requiresSlot(b.slot,a))return!1;const c=a===D.ShaderOutput.Highlight||a===D.ShaderOutput.ShadowHighlight;if(c&&!this._hasHighlights)return!1;const d=a===D.ShaderOutput.ShadowExludeHighlight,n=!(c||d);this._dataByOrigin.forEach(g=>{if(!c||g.hasHighlights){var l=(c?g.drawCommandsHighlight:d&&(g.hasOccludees||g.hasHighlights||g.hasHiddenInstances)?g.drawCommandsShadowHighlightRest:g.drawCommandsDefault)||null,t=n&&g.drawCommandsOccludees||
null;(l?.length||t?.length)&&this._renderCommandData.push(new Y(g.origin,g.geometry,l,t))}});if(0===this._renderCommandData.length)return!1;const e=this._rctx;a=this._glMaterials.load(e,b.slot,a);if(w.isNone(a))return this._renderCommandData.clear(),!1;const f=a.beginSlot(b),h=e.bindTechnique(f,this._material.parameters,b);this._renderCommandData.forAll(g=>{h.bindDraw(g,b,this._material.parameters);const {geometry:l,renderCommands:t,occludeeCommands:p}=g;f.ensureAttributeLocations(l.buffer.vao);e.bindVAO(l.buffer.vao);
const y=f.primitiveType;w.isSome(t)&&0<t.length&&(f.bindPipelineState(e,b.slot,!1),t.forAll(q=>e.drawArrays(y,q.first,q.count)));w.isSome(p)&&0<p.length&&(f.bindPipelineState(e,b.slot,!0),p.forAll(q=>e.drawArrays(y,q.first,q.count)))});this._renderCommandData.clear();return!0};k._removeAndRebuild=function(a,b,c,d,n){for(var e of b)a.instances.delete(e.id);var f=r.sortInstancesByRange(a.instances);a.instances.clear();b=a.geometry.size;d=a.geometry.allocate(d);e=0;for(const h of f){f=h.from*c;const g=
h.to*c;d.copy(e,f,g);h.from=e/c;e+=g-f;h.to=e/c;a.instances.set(h.id,h)}n.push(new r.BufferRange(0,d.hasNewBuffer?a.geometry.buffer.array.length:b));d.dispose();a.geometry.erase(e,n.back().to);a.holes.clear()};k._remove=function(a,b,c,d){for(const n of b){b=n.id;const e=a.instances.get(b),f=e.from*c,h=e.to*c;a.geometry.erase(f,h);a.holes.push(new r.BufferRange(e.from,e.to));a.instances.delete(b);d.push(new r.BufferRange(f,h))}J(a.holes)};k._add=function(a,b,c,d,n){if(0!==b.length){var e=this._bufferWriter,
f=e.vertexBufferLayout.createView(a.geometry.buffer.array.buffer),h=0<a.holes.length,g=Number.MAX_SAFE_INTEGER,l=Number.MIN_SAFE_INTEGER;for(const p of b){var t=w.isSome(p.transformation)?B.multiply(E,d,p.transformation):d;B.invert(z,t);const y=B.transpose(z,z);b=e.elementCount(p.data);const q=b*c;let u=U(a.holes,b);w.isNone(u)&&(u=a.geometry.size/c,a.geometry.grow(q),f=e.vertexBufferLayout.createView(a.geometry.buffer.array.buffer));e.write(t,y,p.data,f,u);t=p.instanceParameters.visible;b=new r.Instance(p.id,
u,u+b,t,!!p.instanceParameters.highlights&&t,!!p.instanceParameters.occludees);A.assert(null==a.instances.get(p.id));a.instances.set(p.id,b);h?n.push(new r.BufferRange(b.from*c,b.to*c)):(g=Math.min(b.from,g),l=Math.max(b.to,l))}h||n.push(new r.BufferRange(g*c,l*c))}};G._createClass(m,[{key:"isEmpty",get:function(){return 0===this._dataByOrigin.size}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasOccludees",get:function(){return this._hasOccludees}},{key:"hasWater",get:function(){return!this.isEmpty&&
this._material instanceof P.WaterMaterial}},{key:"rendersOccluded",get:function(){return!this.isEmpty&&this._material.renderOccluded!==N.RenderOccludedFlag.Occlude}},{key:"test",get:function(){return{material:this._material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}}]);return m}(),T=function(m){this.origin=m;this.add=[];this.remove=[]},V=function(m,k){this.origin=m;this.geometry=k;this.instances=new Map;this.holes=new v({deallocator:null});this.drawCommandsDirty=this.hasOccludees=
this.hasHighlights=this.hasHiddenInstances=!1;this.drawCommandsDefault=new v({allocator:a=>a||new r.DrawCommand,deallocator:a=>a});this.drawCommandsHighlight=new v({allocator:a=>a||new r.DrawCommand,deallocator:a=>a});this.drawCommandsOccludees=new v({allocator:a=>a||new r.DrawCommand,deallocator:a=>a});this.drawCommandsShadowHighlightRest=new v({allocator:a=>a||new r.DrawCommand,deallocator:a=>a})},Y=function(m){function k(a,b,c,d){a=m.call(this,a)||this;a.geometry=b;a.renderCommands=c;a.occludeeCommands=
d;return a}G._inheritsLoose(k,m);return k}(O.DrawParameters);const W=new v({deallocator:null}),X=C.create(),E=C.create(),z=C.create();F.MergedRenderer=Z;Object.defineProperties(F,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});