// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("require exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/maybe ../../../../chunks/vec2 ../../../../support/requestImageUtils ./glUtil3D ./SSAOBlurTechnique ./SSAOTechnique ../shaders/SSAOParameters ../../../webgl/enums ../../../webgl/FramebufferObject ../../../webgl/Texture ../../../webgl/Util".split(" "),function(v,m,w,a,r,x,y,z,A,t,e,n,B,p){let C=function(){function q(b,c,d){this._techniqueRepository=b;this._rctx=c;this._requestRender=d;this._enabled=!1;this._quadVAO=
null;this._passParameters=new t.SSAOPassParameters;this._drawParameters=new t.BlurDrawParameters}var g=q.prototype;g.dispose=function(){this._quadVAO=a.disposeMaybe(this._quadVAO)};g.disposeOffscreenBuffers=function(){a.applySome(this._ssaoFBO,b=>b.resize(0,0));a.applySome(this._blur0FBO,b=>b.resize(0,0));a.applySome(this._blur1FBO,b=>b.resize(0,0))};g.computeSSAO=function(b,c,d){if(!(!this.enabled||a.isNone(c)||a.isNone(d)||a.isNone(this._passParameters.noiseTexture)||a.isNone(this._ssaoFBO)||a.isNone(this._blur0FBO)||
a.isNone(this._blur1FBO))){var f=this._rctx,h=b.camera;this._passParameters.normalTexture=d;this._passParameters.depthTexture=c;this._passParameters.projScale=1/h.computeRenderPixelSizeAtDist(1);c=h.fullViewport;d=c[2];h=c[3];var k=d/2,l=h/2;this._ssaoFBO.resize(d,h);this._blur0FBO.resize(k,l);this._blur1FBO.resize(k,l);a.isNone(this._quadVAO)&&(this._quadVAO=y.createQuadVAO(this._rctx));f.bindFramebuffer(this._ssaoFBO);f.setViewport(0,0,d,h);f.bindTechnique(this._ssaoTechnique,this._passParameters,
b).bindDraw(this._drawParameters,b,this._passParameters);f.bindVAO(this._quadVAO);f.drawArrays(e.PrimitiveType.TRIANGLE_STRIP,0,p.vertexCount(this._quadVAO,"geometry"));var u=f.bindTechnique(this._blurTechnique,this._passParameters,b);f.setViewport(0,0,k,l);f.bindFramebuffer(this._blur0FBO);this._drawParameters.colorTexture=this._ssaoFBO.colorTexture;r.set(this._drawParameters.blurSize,0,2/h);u.bindDraw(this._drawParameters,b,this._passParameters);f.setViewport(0,0,k,l);f.drawArrays(e.PrimitiveType.TRIANGLE_STRIP,
0,p.vertexCount(this._quadVAO,"geometry"));f.bindFramebuffer(this._blur1FBO);this._drawParameters.colorTexture=this._blur0FBO.colorTexture;r.set(this._drawParameters.blurSize,2/d,0);u.bindDraw(this._drawParameters,b,this._passParameters);f.drawArrays(e.PrimitiveType.TRIANGLE_STRIP,0,p.vertexCount(this._quadVAO,"geometry"));f.setViewport(c[0],c[1],c[2],c[3])}};g._selectPrograms=function(){a.isNone(this._ssaoTechnique)&&(this._ssaoTechnique=this._techniqueRepository.acquire(A.SSAOTechnique));a.isNone(this._blurTechnique)&&
(this._blurTechnique=this._techniqueRepository.acquire(z.SSAOBlurTechnique))};g._enable=function(){this.enabled||(this._enabled=!0,this._loadResources(()=>{this._enabled&&this._initialize()}))};g._loadResources=function(b){this._data?b():(new Promise((c,d)=>v(["./SSAOHelperData"],c,d))).then(c=>{this._data=c;b()})};g._initialize=function(){const b={target:e.TextureType.TEXTURE_2D,pixelFormat:e.PixelFormat.RGBA,dataType:e.PixelType.UNSIGNED_BYTE,samplingMode:e.TextureSamplingMode.LINEAR,wrapMode:e.TextureWrapMode.CLAMP_TO_EDGE,
width:0,height:0},c={colorTarget:e.TargetType.TEXTURE,depthStencilTarget:e.DepthStencilTargetType.NONE};x.requestImage(this._data.noiseTexture).then(d=>{this._enabled&&(this._ssaoFBO=new n.FramebufferObject(this._rctx,c,b),this._blur0FBO=new n.FramebufferObject(this._rctx,c,b),this._blur1FBO=new n.FramebufferObject(this._rctx,c,b),this._passParameters.noiseTexture=new B.Texture(this._rctx,{target:e.TextureType.TEXTURE_2D,pixelFormat:e.PixelFormat.RGBA,dataType:e.PixelType.UNSIGNED_BYTE,hasMipmap:!0,
width:d.width,height:d.height},d),this._requestRender())});this._selectPrograms()};g._disable=function(){this._enabled=!1;this._passParameters.noiseTexture=a.disposeMaybe(this._passParameters.noiseTexture);this._blur1FBO=a.disposeMaybe(this._blur1FBO);this._blur0FBO=a.disposeMaybe(this._blur0FBO);this._ssaoFBO=a.disposeMaybe(this._ssaoFBO)};w._createClass(q,[{key:"enabled",get:function(){return this._enabled},set:function(b){b?this._enable():this._disable()}},{key:"ready",get:function(){return this.enabled&&
a.isSome(this._passParameters.noiseTexture)&&a.isSome(this._ssaoFBO)&&a.isSome(this._blur0FBO)&&a.isSome(this._blur1FBO)}},{key:"loading",get:function(){return this.enabled&&!this.ready}},{key:"colorTexture",get:function(){return a.isSome(this._blur1FBO)?this._blur1FBO.colorTexture:null}},{key:"width",get:function(){return a.isSome(this._ssaoFBO)?this._ssaoFBO.width:-1}},{key:"height",get:function(){return a.isSome(this._ssaoFBO)?this._ssaoFBO.height:-1}},{key:"gpuMemoryUsage",get:function(){return(a.isSome(this._blur0FBO)?
this._blur0FBO.gpuMemoryUsage:0)+(a.isSome(this._blur1FBO)?this._blur1FBO.gpuMemoryUsage:0)+(a.isSome(this._ssaoFBO)?this._ssaoFBO.gpuMemoryUsage:0)}},{key:"test",get:function(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}]);return q}();m.SSAOHelper=C;m.blurSizePixels=2;Object.defineProperties(m,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});