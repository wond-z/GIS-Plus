// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/has ../../../../core/maybe ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../ViewingMode ../../support/buffer/InterleavedLayout ../core/shaderLibrary/ShaderOutput ../core/shaderLibrary/attributes/NormalAttribute.glsl ../core/shaderLibrary/shading/Normals.glsl ../core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl ../lib/basicInterfaces ../lib/GLTextureMaterial ../lib/Material ../lib/OrderIndependentTransparency ../lib/RenderSlot ../lib/VertexAttribute ../lib/verticalOffsetUtils ./internal/bufferWriterUtils ./internal/MaterialUtil ../shaders/DefaultMaterialTechnique ../shaders/DefaultMaterialTechniqueConfiguration ../shaders/RealisticTreeTechnique".split(" "),
function(u,y,P,n,l,q,D,E,g,F,v,z,Q,w,A,R,x,h,S,T,G,H,U,V){function I(f){let e=E.newLayout();e=f.instancedDoublePrecision?e.vec3f(h.VertexAttribute.MODELORIGINHI).vec3f(h.VertexAttribute.MODELORIGINLO).mat3f(h.VertexAttribute.MODEL).mat3f(h.VertexAttribute.MODELNORMAL):e.mat4f(h.VertexAttribute.MODEL).mat4f(h.VertexAttribute.MODELNORMAL);n.isSome(f.instanced)&&f.instanced.includes("color")&&(e=e.vec4f(h.VertexAttribute.INSTANCECOLOR));n.isSome(f.instanced)&&f.instanced.includes("featureAttribute")&&
(e=e.vec4f(h.VertexAttribute.INSTANCEFEATUREATTRIBUTE));n.isSome(f.instanced)&&f.instanced.includes("objectAndLayerIdColor")&&(e=e.vec4u8(h.VertexAttribute.OBJECTANDLAYERIDCOLOR_INSTANCED));return e}A=function(f){function e(a){var b=f.call(this,a,W)||this;b.supportsEdges=!0;b._configuration=new U.DefaultMaterialTechniqueConfiguration;var c=b.parameters;const m=c.textureId||c.normalTextureId||c.metallicRoughnessTextureId||c.emissiveTextureId||c.occlusionTextureId,k=E.newLayout().vec3f(h.VertexAttribute.POSITION).vec3f(h.VertexAttribute.NORMAL);
c.hasVertexTangents&&k.vec4f(h.VertexAttribute.TANGENT);m&&k.vec2f(h.VertexAttribute.UV0);c.hasVertexColors&&k.vec4u8(h.VertexAttribute.COLOR);c.hasSymbolColors&&k.vec4u8(h.VertexAttribute.SYMBOLCOLOR);P("enable-feature:objectAndLayerId-rendering")&&k.vec4u8(h.VertexAttribute.OBJECTANDLAYERIDCOLOR);b._vertexBufferLayout=k;b._instanceBufferLayout=a.instanced?I(b.parameters):null;return b}y._inheritsLoose(e,f);var d=e.prototype;d.isVisibleForOutput=function(a){return a===g.ShaderOutput.Shadow||a===
g.ShaderOutput.ShadowExludeHighlight||a===g.ShaderOutput.ShadowHighlight?this.parameters.castShadows:!0};d.isVisible=function(){var a=this.parameters;if(!f.prototype.isVisible.call(this)||0===a.layerOpacity)return!1;const {instanced:b,hasVertexColors:c,hasSymbolColors:m,vvColorEnabled:k}=a,r=n.isSome(b)&&b.includes("color"),t="replace"===a.colorMixMode,p=0<a.opacity;a=a.externalColor&&0<a.externalColor[3];return c&&(r||k||m)?t?!0:p:c?t?a:p:r||k||m?t?!0:p:t?a:p};d.getConfiguration=function(a,b){this._configuration.output=
a;this._configuration.hasNormalTexture=!!this.parameters.normalTextureId;this._configuration.hasColorTexture=!!this.parameters.textureId;this._configuration.hasVertexTangents=this.parameters.hasVertexTangents;this._configuration.instanced=!!this.parameters.instanced;this._configuration.instancedDoublePrecision=this.parameters.instancedDoublePrecision;this._configuration.vvSize=this.parameters.vvSizeEnabled;this._configuration.hasVerticalOffset=n.isSome(this.parameters.verticalOffset);this._configuration.hasScreenSizePerspective=
n.isSome(this.parameters.screenSizePerspective);this._configuration.hasSlicePlane=this.parameters.hasSlicePlane;this._configuration.hasSliceHighlight=this.parameters.hasSliceHighlight;this._configuration.alphaDiscardMode=this.parameters.textureAlphaMode;this._configuration.normalType="screenDerivative"===this.parameters.normals?F.NormalAttributeType.ScreenDerivative:F.NormalAttributeType.Attribute;this._configuration.transparent=this.parameters.transparent;this._configuration.writeDepth=this.parameters.writeDepth;
n.isSome(this.parameters.customDepthTest)&&(this._configuration.customDepthTest=this.parameters.customDepthTest);this._configuration.hasOccludees=this.parameters.hasOccludees;this._configuration.cullFace=this.parameters.hasSlicePlane?Q.CullFaceOptions.None:this.parameters.cullFace;this._configuration.hasMultipassTerrain=b.multipassTerrain.enabled;this._configuration.cullAboveGround=b.multipassTerrain.cullAboveGround;this._configuration.hasModelTransformation=n.isSome(this.parameters.modelTransformation);
if(a===g.ShaderOutput.Color||a===g.ShaderOutput.Alpha)this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSymbolColors=this.parameters.hasSymbolColors,this._configuration.doubleSidedMode=this.parameters.treeRendering?v.NormalsDoubleSidedMode.WindingOrder:this.parameters.doubleSided&&"normal"===this.parameters.doubleSidedType?v.NormalsDoubleSidedMode.View:this.parameters.doubleSided&&"winding-order"===this.parameters.doubleSidedType?v.NormalsDoubleSidedMode.WindingOrder:
v.NormalsDoubleSidedMode.None,this._configuration.instancedColor=n.isSome(this.parameters.instanced)&&this.parameters.instanced.includes("color"),this._configuration.receiveShadows=this.parameters.receiveShadows&&this.parameters.shadowMappingEnabled,this._configuration.receiveAmbientOcclusion=b.ssaoHelper.ready?this.parameters.receiveSSAO:!1,this._configuration.vvColor=this.parameters.vvColorEnabled,this._configuration.textureAlphaPremultiplied=!!this.parameters.textureAlphaPremultiplied,this._configuration.pbrMode=
this.parameters.usePBR?this.parameters.isSchematic?z.PBRMode.Schematic:z.PBRMode.Normal:z.PBRMode.Disabled,this._configuration.hasMetallicRoughnessTexture=!!this.parameters.metallicRoughnessTextureId,this._configuration.hasEmissionTexture=!!this.parameters.emissiveTextureId,this._configuration.hasOcclusionTexture=!!this.parameters.occlusionTextureId,this._configuration.offsetBackfaces=!(!this.parameters.transparent||!this.parameters.offsetTransparentBackfaces),this._configuration.transparencyPassType=
b.transparencyPassType,this._configuration.enableOffset=b.camera.relativeElevation<R.OITPolygonOffsetLimit,this._configuration.snowCover=this.hasSnowCover(b),this._configuration.hasColorTextureTransform=!!this.parameters.colorTextureTransformMatrix,this._configuration.hasNormalTextureTransform=!!this.parameters.normalTextureTransformMatrix,this._configuration.hasEmissionTextureTransform=!!this.parameters.emissiveTextureTransformMatrix,this._configuration.hasOcclusionTextureTransform=!!this.parameters.occlusionTextureTransformMatrix,
this._configuration.hasMetallicRoughnessTextureTransform=!!this.parameters.metallicRoughnessTextureTransformMatrix;return this._configuration};d.hasSnowCover=function(a){return n.isSome(a.weather)&&a.weatherVisible&&"snowy"===a.weather.type&&"enabled"===a.weather.snowCover};d.intersect=function(a,b,c,m,k,r,t){if(n.isSome(this.parameters.verticalOffset)){const J=m.camera;l.set(B,c[12],c[13],c[14]);c=null;switch(m.viewingMode){case D.ViewingMode.Global:c=l.normalize(K,B);break;case D.ViewingMode.Local:c=
l.copy(K,X)}let L=0;var p=l.subtract(Y,B,J.eye);const M=l.length(p);p=l.scale(p,p,1/M);let N=null;this.parameters.screenSizePerspective&&(N=l.dot(c,p));L+=G.verticalOffsetAtDistance(J,M,this.parameters.verticalOffset,N,this.parameters.screenSizePerspective);l.scale(c,c,L);l.transformMat3(C,c,m.transform.inverseRotation);k=l.subtract(Z,k,C);r=l.subtract(aa,r,C)}G.intersectTriangleGeometry(a,b,m,k,r,S.getVerticalOffsetObject3D(m.verticalOffset),t)};d.requiresSlot=function(a,b){return b===g.ShaderOutput.Color||
b===g.ShaderOutput.Alpha||b===g.ShaderOutput.Depth||b===g.ShaderOutput.Normal||b===g.ShaderOutput.Shadow||b===g.ShaderOutput.ShadowHighlight||b===g.ShaderOutput.ShadowExludeHighlight||b===g.ShaderOutput.Highlight||b===g.ShaderOutput.ObjectAndLayerIdColor?a===(this.parameters.transparent?this.parameters.writeDepth?x.RenderSlot.TRANSPARENT_MATERIAL:x.RenderSlot.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:x.RenderSlot.OPAQUE_MATERIAL)||a===x.RenderSlot.DRAPED_MATERIAL||b===g.ShaderOutput.ObjectAndLayerIdColor:
!1};d.createGLMaterial=function(a){return new O(a)};d.createBufferWriter=function(){return new ba(this._vertexBufferLayout,this._instanceBufferLayout)};return e}(A.Material);let O=function(f){function e(a){return f.call(this,{...a,...a.material.parameters})||this}y._inheritsLoose(e,f);var d=e.prototype;d._updateParameters=function(a){const b=this._material.parameters;this.updateTexture(b.textureId);const c=a.camera.viewInverseTransposeMatrix;l.set(b.origin,c[3],c[7],c[11]);this._material.setParameters(this.textureBindParameters);
return this.ensureTechnique(b.treeRendering?V.RealisticTreeTechnique:H.DefaultMaterialTechnique,a)};d._updateShadowState=function(a){a.shadowMap.enabled!==this._material.parameters.shadowMappingEnabled&&this._material.setParameters({shadowMappingEnabled:a.shadowMap.enabled})};d._updateOccludeeState=function(a){a.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:a.hasOccludees})};d.beginSlot=function(a){if(this._output===g.ShaderOutput.Color||this._output===
g.ShaderOutput.Alpha)this._updateShadowState(a),this._updateOccludeeState(a);return this._updateParameters(a)};return e}(w.GLTextureMaterial);w=function(f){function e(){var d=f.apply(this,arguments)||this;d.initTextureTransparent=!1;d.treeRendering=!1;d.hasVertexTangents=!1;return d}y._inheritsLoose(e,f);return e}(H.DefaultMaterialPassParameters);const W=new w;let ba=function(){function f(d,a){this.vertexBufferLayout=d;this.instanceBufferLayout=a}var e=f.prototype;e.allocate=function(d){return this.vertexBufferLayout.createBuffer(d)};
e.elementCount=function(d){return d.indices.get(h.VertexAttribute.POSITION).length};e.write=function(d,a,b,c,m){T.writeDefaultAttributes(b,this.vertexBufferLayout,d,a,c,m)};return f}();const Z=q.create(),aa=q.create(),X=q.fromValues(0,0,1),K=q.create(),C=q.create(),B=q.create(),Y=q.create();u.DefaultGLMaterial=O;u.DefaultMaterial=A;u.DefaultMaterialParameters=w;u.getInstanceBufferLayout=I;Object.defineProperties(u,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});