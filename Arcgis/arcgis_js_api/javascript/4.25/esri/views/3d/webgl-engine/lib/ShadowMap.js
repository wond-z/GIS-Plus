// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/has ../../../../core/mathUtils ../../../../core/maybe ../../../../chunks/mat3f64 ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec2 ../../../../chunks/vec2f64 ../../../../chunks/vec3 ../../../../chunks/vec3f64 ../../../../chunks/vec4 ../../../../chunks/vec4f64 ../../../ViewingMode ./Camera ./Util ../../../webgl/enums ../../../webgl/FramebufferObject ../../../webgl/Texture ../../../webgl/Util".split(" "),
function(O,pa,qa,W,I,ra,F,J,d,p,G,S,X,Y,sa,ta,t,u,ua,T,va){function x(y,l){d.set(ca,y[l],y[l+3]);return ca}O.SnapshotSlot=void 0;(function(y){y[y.Highlight=0]="Highlight";y[y.Default=1]="Default"})(O.SnapshotSlot||(O.SnapshotSlot={}));let U=function(){this.camera=new ta.Camera;this.lightMat=J.create()},xa=function(){function y(a,c){this._rctx=a;this._viewingMode=c;this._enabled=!1;this._snapshots=[];this._textureSize=0;this._numCascades=1;this._maxNumCascades=4;this._splitSchemeLambda=0;this._warp=
!0;this._cascadeDistances=[0,0,0,0,0];this._usedCascadeDistances=Y.create();this._cascades=[new U,new U,new U,new U];this._maxTextureSize=Math.min(qa("esri-mobile")?2048:8192,this._rctx.parameters.maxTextureSize)}var l=y.prototype;l.dispose=function(){this._discardDepthTexture();this._discardAllSnapshots()};l.getSnapshot=function(a){return this.enabled?this._snapshots[a]:null};l.getCascades=function(){for(let a=0;a<this._numCascades;++a)Z[a]=this._cascades[a];Z.length=this._numCascades;return Z};
l.start=function(a,c,f){t.assert(this.enabled);this._textureSize=this._computeTextureSize(a.fullWidth,a.fullHeight);this._ensureDepthTexture();const {near:g,far:e}=this._clampNearFar(f);this._computeCascadeDistances(e,g);this._setupMatrices(a,c);f=a.viewMatrix;a=a.projectionMatrix;for(let k=0;k<this._numCascades;++k)this._constructCascade(k,a,f,c);this._lastOrigin=null;this.clear()};l.finish=function(a){t.assert(this.enabled);this._rctx.bindFramebuffer(a)};l.getShadowMapMatrices=function(a){if(!this._lastOrigin||
!G.exactEquals(a,this._lastOrigin)){this._lastOrigin=this._lastOrigin||S.create();G.copy(this._lastOrigin,a);for(let c=0;c<this._numCascades;++c){F.translate(da,this._cascades[c].lightMat,a);for(let f=0;16>f;++f)ea[16*c+f]=da[f]}}return ea};l.takeCascadeSnapshotTo=function(a,c){t.assert(this.enabled);var f=this._ensureSnapshot(c);this._bindFbo();c=this._rctx;f=c.bindTexture(f,T.Texture.TEXTURE_UNIT_FOR_UPDATES);c.gl.copyTexSubImage2D(u.TextureType.TEXTURE_2D,0,a.camera.viewport[0],a.camera.viewport[1],
a.camera.viewport[0],a.camera.viewport[1],a.camera.viewport[2],a.camera.viewport[3]);c.bindTexture(f,T.Texture.TEXTURE_UNIT_FOR_UPDATES)};l.clear=function(){const a=this._rctx;this._bindFbo();a.setClearColor(1,1,1,1);a.clearSafe(u.ClearBufferBit.COLOR_BUFFER_BIT|u.ClearBufferBit.DEPTH_BUFFER_BIT)};l._computeTextureSize=function(a,c){return Math.min(this._maxTextureSize,2*2**Math.round(.5*Math.log(a*a+c*c)*Math.LOG2E+.35))};l._ensureDepthTexture=function(){I.isSome(this._depthTexture)&&this._depthTexture.descriptor.width===
this._textureSize||(this._discardDepthTexture(),this._depthTexture=new T.Texture(this._rctx,{target:u.TextureType.TEXTURE_2D,pixelFormat:u.PixelFormat.RGBA,dataType:u.PixelType.UNSIGNED_BYTE,wrapMode:u.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:u.TextureSamplingMode.NEAREST,flipped:!0,width:this._textureSize,height:this._textureSize}),this._fbo=new ua.FramebufferObject(this._rctx,{colorTarget:u.TargetType.TEXTURE,depthStencilTarget:u.DepthStencilTargetType.DEPTH_RENDER_BUFFER,width:this._textureSize,
height:this._textureSize},this._depthTexture))};l._ensureSnapshot=function(a){let c=this._snapshots[a];if(I.isSome(c)&&c.descriptor.width===this._textureSize)return c;this._discardSnapshot(a);c=new T.Texture(this._rctx,{target:u.TextureType.TEXTURE_2D,pixelFormat:u.PixelFormat.RGBA,dataType:u.PixelType.UNSIGNED_BYTE,wrapMode:u.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:u.TextureSamplingMode.NEAREST,flipped:!0,width:this._textureSize,height:this._textureSize});return this._snapshots[a]=c};l._discardDepthTexture=
function(){this._fbo=I.disposeMaybe(this._fbo);this._depthTexture=I.disposeMaybe(this._depthTexture)};l._discardSnapshot=function(a){this._snapshots[a]=I.disposeMaybe(this._snapshots[a])};l._discardAllSnapshots=function(){for(let a=0;a<this._snapshots.length;++a)this._discardSnapshot(a);this._snapshots.length=0};l._bindFbo=function(){const a=this._rctx;a.unbindTexture(this._depthTexture);a.bindFramebuffer(this._fbo)};l._constructCascade=function(a,c,f,g){const e=this._cascades[a];var k=-this._cascadeDistances[a],
h=-this._cascadeDistances[a+1];k=(c[10]*k+c[14])/Math.abs(c[11]*k+c[15]);c=(c[10]*h+c[14])/Math.abs(c[11]*h+c[15]);t.assert(k<c);for(h=0;8>h;++h){X.set(fa,0===h%4||3===h%4?-1:1,0===h%4||1===h%4?-1:1,4>h?k:c,1);X.transformMat4(v[h],fa,ha);for(let q=0;3>q;++q)v[h][q]/=v[h][3]}G.negate(aa,v[0]);F.translate(ia,ja,aa);e.camera.viewMatrix=ia;for(k=0;8>k;++k)G.transformMat4(v[k],v[k],e.camera.viewMatrix);G.copy(B,v[0]);G.copy(C,v[0]);for(k=1;8>k;++k)for(c=0;3>c;++c)B[c]=Math.min(B[c],v[k][c]),C[c]=Math.max(C[c],
v[k][c]);B[2]-=200;C[2]+=200;e.camera.near=-C[2];e.camera.far=-B[2];this._warp?this._constructTrapezoidalProjection(f,g,e):this._constructOrthogonalProjection(e);F.multiply(e.lightMat,e.camera.projectionMatrix,e.camera.viewMatrix);f=this._textureSize/2;e.camera.viewport[0]=0===a%2?0:f;e.camera.viewport[1]=0===Math.floor(a/2)?0:f;e.camera.viewport[2]=f;e.camera.viewport[3]=f};l._constructOrthogonalProjection=function(a){F.ortho(a.camera.projectionMatrix,B[0],C[0],B[1],C[1],a.camera.near,a.camera.far)};
l._constructTrapezoidalProjection=function(a,c,f){var g=1/v[0][3],e=1/v[4][3];t.assert(g<e);g+=Math.sqrt(g*e);var k=Math.sin(W.acosClamped(a[2]*c[0]+a[6]*c[1]+a[10]*c[2]));a=v;var h=g/k;c=ka;var q=la,m=wa;e=ma;g=na;d.set(z,0,0);for(var r=0;4>r;++r)d.add(z,z,a[r]);d.scale(z,z,.25);d.set(K,0,0);for(r=4;8>r;++r)d.add(K,K,a[r]);d.scale(K,K,.25);d.lerp(H[0],a[4],a[5],.5);d.lerp(H[1],a[5],a[6],.5);d.lerp(H[2],a[6],a[7],.5);d.lerp(H[3],a[7],a[4],.5);r=0;var D=d.squaredDistance(H[0],z);for(var A=1;4>A;++A){var L=
d.squaredDistance(H[A],z);L<D&&(D=L,r=A)}d.subtract(n,H[r],a[r+4]);r=n[0];n[0]=-n[1];n[1]=r;d.subtract(ba,K,z);0>d.dot(ba,n)&&d.negate(n,n);d.lerp(n,n,ba,k);d.normalize(n,n);k=r=d.dot(d.subtract(E,a[0],z),n);for(D=1;8>D;++D)A=d.dot(d.subtract(E,a[D],z),n),A<k?k=A:A>r&&(r=A);d.copy(c,z);d.scale(E,n,k-h);d.add(c,c,E);A=-1;L=1;h=D=0;for(let P=0;8>P;++P){d.subtract(Q,a[P],c);d.normalize(Q,Q);const R=n[0]*Q[1]-n[1]*Q[0];0<R?R>A&&(A=R,D=P):R<L&&(L=R,h=P)}t.verify(0<A,"leftArea");t.verify(0>L,"rightArea");
d.scale(M,n,k);d.add(M,M,z);d.scale(N,n,r);d.add(N,N,z);V[0]=-n[1];V[1]=n[0];q=t.rayRay2D(c,a[h],N,d.add(E,N,V),1,q);m=t.rayRay2D(c,a[D],N,E,1,m);e=t.rayRay2D(c,a[D],M,d.add(E,M,V),1,e);a=t.rayRay2D(c,a[h],M,E,1,g);t.verify(q,"rayRay");t.verify(m,"rayRay");t.verify(e,"rayRay");t.verify(a,"rayRay");m=ka;a=la;c=ma;e=na;g=f.camera.projectionMatrix;d.subtract(w,c,e);d.scale(w,w,.5);b[0]=w[0];b[1]=w[1];b[2]=0;b[3]=w[1];b[4]=-w[0];b[5]=0;b[6]=w[0]*w[0]+w[1]*w[1];b[7]=w[0]*w[1]-w[1]*w[0];b[8]=1;b[6]=-d.dot(x(b,
0),m);b[7]=-d.dot(x(b,1),m);m=d.dot(x(b,0),c)+b[6];q=d.dot(x(b,1),c)+b[7];h=d.dot(x(b,0),e)+b[6];e=d.dot(x(b,1),e)+b[7];m=-(m+h)/(q+e);b[0]+=b[1]*m;b[3]+=b[4]*m;b[6]+=b[7]*m;m=1/(d.dot(x(b,0),c)+b[6]);q=1/(d.dot(x(b,1),c)+b[7]);b[0]*=m;b[3]*=m;b[6]*=m;b[1]*=q;b[4]*=q;b[7]*=q;b[2]=b[1];b[5]=b[4];b[8]=b[7];b[7]+=1;m=d.dot(x(b,1),a)+b[7];q=d.dot(x(b,2),a)+b[8];h=d.dot(x(b,1),c)+b[7];e=d.dot(x(b,2),c)+b[8];m=-.5*(m/q+h/e);b[1]+=b[2]*m;b[4]+=b[5]*m;b[7]+=b[8]*m;m=d.dot(x(b,1),a)+b[7];q=d.dot(x(b,2),a)+
b[8];h=-q/m;b[1]*=h;b[4]*=h;b[7]*=h;g[0]=b[0];g[1]=b[1];g[2]=0;g[3]=b[2];g[4]=b[3];g[5]=b[4];g[6]=0;g[7]=b[5];g[8]=0;g[9]=0;g[10]=1;g[11]=0;g[12]=b[6];g[13]=b[7];g[14]=0;g[15]=b[8];f.camera.projectionMatrix[10]=2/(B[2]-C[2]);f.camera.projectionMatrix[14]=-(B[2]+C[2])/(B[2]-C[2])};l._setupMatrices=function(a,c){F.multiply(oa,a.projectionMatrix,a.viewMatrix);F.invert(ha,oa);a=this._viewingMode===sa.ViewingMode.Global?a.eye:G.set(aa,0,0,1);F.lookAt(ja,[0,0,0],[-c[0],-c[1],-c[2]],a)};l._clampNearFar=
function(a){let {near:c,far:f}=a;2>c&&(c=2);2>f&&(f=2);c>=f&&(c=2,f=4);return{near:c,far:f}};l._computeCascadeDistances=function(a,c){this._numCascades=Math.min(1+Math.floor(t.logWithBase(a/c,4)),this._maxNumCascades);const f=(a-c)/this._numCascades;a=(a/c)**(1/this._numCascades);let g=c;for(let e=0;e<this._numCascades+1;++e)this._cascadeDistances[e]=W.lerp(g,c,this._splitSchemeLambda),g*=a,c+=f};pa._createClass(y,[{key:"depthTexture",get:function(){return this._depthTexture}},{key:"textureSize",
get:function(){return this._textureSize}},{key:"numCascades",get:function(){return this._numCascades}},{key:"cascadeDistances",get:function(){return X.set(this._usedCascadeDistances,this._cascadeDistances[0],1<this._numCascades?this._cascadeDistances[1]:Infinity,2<this._numCascades?this._cascadeDistances[2]:Infinity,3<this._numCascades?this._cascadeDistances[3]:Infinity)}},{key:"maxCascades",get:function(){return this._maxNumCascades},set:function(a){this._maxNumCascades=W.clamp(Math.floor(a),1,4)}},
{key:"enabled",get:function(){return this._enabled},set:function(a){this._enabled=a;a||(this._discardDepthTexture(),this._discardAllSnapshots())}},{key:"ready",get:function(){return this._enabled&&I.isSome(this._depthTexture)}},{key:"gpuMemoryUsage",get:function(){return this._snapshots.reduce((a,c)=>a+va.getGpuMemoryUsage(c),this._fbo?.gpuMemoryUsage??0)}},{key:"test",get:function(){const a=this;return{maxNumCascades:this._maxNumCascades,cascades:this._cascades,textureSize:this._textureSize,set splitSchemeLambda(c){a._splitSchemeLambda=
c},get splitSchemeLambda(){return a._splitSchemeLambda},set warp(c){a._warp=c},get warp(){return a._warp}}}}]);return y}();const ia=J.create(),oa=J.create(),ha=J.create(),fa=Y.create(),v=[];for(let y=0;8>y;++y)v.push(Y.create());const B=S.create(),C=S.create(),ka=p.create(),la=p.create(),wa=p.create(),ma=p.create(),na=p.create(),ja=J.create(),aa=S.create(),Z=[],da=J.create(),ea=new Float32Array(64),z=p.create(),K=p.create(),H=[p.create(),p.create(),p.create(),p.create()],n=p.create(),ba=p.create(),
E=p.create(),Q=p.create(),M=p.create(),N=p.create(),V=p.create(),ca=p.create(),w=p.create(),b=ra.create();O.ShadowMap=xa;Object.defineProperties(O,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});