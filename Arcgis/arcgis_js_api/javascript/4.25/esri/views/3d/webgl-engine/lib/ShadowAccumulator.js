// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/arrayUtils ../../../../core/Handles ../../../../core/mathUtils ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../chunks/vec3 ../../../../chunks/vec3f64 ./BindParameters ./Camera ./depthRange ./glUtil3D ./ShadowCastRenderer ./ShadowMap ../../../../chunks/ShadowCastAccumulate.glsl ../shaders/ShadowCastAccumulateTechnique ../../../support/Scheduler ../../../webgl/enums ../../../webgl/FramebufferObject ../../../webgl/Util".split(" "),
function(c,q,f,B,C,D,E,m,v,g,Q,F,w,G,H,I,x,J,r,K,y,L,M,k,N,O){var n;c.ShadowAccumulator=n=function(z){function t(a,d,h,l,u,p){var b=z.call(this,{})||this;b._rctx=a;b._stage=h;b._prepareForShadowMapPass=l;b._renderToShadowMap=u;b._requestRender=p;b._progress=0;b._sampleCount=0;b._passParameters=new y.ShadowCastAccumulatePassParameters;b._enabledInternal=!1;b._cachedLightDirections=[];b._depthRange=x.ZERO;b._previewingCached=!1;b._handles=new D;b._cameraForcedForScreenshot=!1;b._bindParameters=new H.BindParameters(new K.ShadowMap(a,
h.viewingMode),null,null);b._bindParameters.shadowMap.enabled=!0;b._bindParameters.camera=new I.Camera;b._vao=J.createQuadVAO(a);b._fbo=new N.FramebufferObject(a,{colorTarget:k.TargetType.TEXTURE,depthStencilTarget:k.DepthStencilTargetType.NONE,width:0,height:0},{target:k.TextureType.TEXTURE_2D,pixelFormat:k.PixelFormat.RGBA,dataType:k.PixelType.UNSIGNED_BYTE,samplingMode:k.TextureSamplingMode.LINEAR,wrapMode:k.TextureWrapMode.CLAMP_TO_EDGE,width:0,height:0});b._accumulationRenderer=new r.ShadowCastRenderer(d,
a,q._assertThisInitialized(b),p);b._handles.add(b._stage.resourceController.scheduler.registerTask(M.TaskPriority.SHADOW_ACCUMULATOR,q._assertThisInitialized(b)));b._handles.add(v.watch(()=>h.renderView,A=>{b._handles.remove(n.renderViewHandleKey);m.isNone(A)||b._handles.add(A.events.on("force-camera-for-screenshot",()=>b._cameraForcedForScreenshot=!0),n.renderViewHandleKey)},v.syncAndInitial));return b}q._inheritsLoose(t,z);var e=t.prototype;e.normalizeCtorArgs=function(){return{}};e.runTask=function(a){for(this._prepareForShadowMapPass(this._bindParameters);!a.done&&
!this._isDoneAccumulating;)this._accumulateShadow(),a.madeProgress();this._requestRender()};e.renderAccumulation=function(a,d,h,l){this._passParameters.linearDepthTexture=a;this._depthRange=d;this._updateCamera(h);this._bindParameters.contentCamera=l;this.notifyChange("canAccumulate");if(this.isAccumulating&&this.canAccumulate){(this._previewingCached||0===this._progress||this._cameraForcedForScreenshot)&&this._clear();a=this._cameraForcedForScreenshot?this._sampleCount:Math.min(n.previewSamples,
this._sampleCount-this._progress);for(d=0;d<a;++d)this._accumulateShadow();this._cameraForcedForScreenshot=!1}};e.render=function(a){this._accumulationRenderer.render(a)};e.dispose=function(){this._stop();this._handles.destroy();this._accumulationRenderer=m.disposeMaybe(this._accumulationRenderer);this._bindParameters.shadowMap.dispose();this._fbo=m.disposeMaybe(this._fbo);this._vao=m.disposeMaybe(this._vao);this._accumulationTechniqueCached=m.releaseMaybe(this._accumulationTechniqueCached);this._sampleCount=
this._cachedLightDirections.length=0};e.setOptions=function(a){void 0!==a.enabled&&(this._enabled=a.enabled);void 0!==a.previewing&&(this._previewing=a.previewing);void 0!==a.lightDirections&&(this._lightDirections=a.lightDirections);this._accumulationRenderer.setOptions(a)};e.readAccumulatedShadow=function(a,d){if(!this._isActive||1>this._progress||0>a||a>this._fbo.width||0>d||d>this._fbo.height)return 0;const h=P;this._fbo.readPixels(a,d,1,1,k.PixelFormat.RGBA,k.PixelType.UNSIGNED_BYTE,h);return h[0]/
this._progress};e._start=function(){this._progress=0;this._enabledInternal=!0};e._stop=function(){this._enabledInternal=!1};e._invalidate=function(){this._progress=0;this._requestRenderIfEnabled()};e._clear=function(){this._rctx.bindFramebuffer(this._fbo);this._rctx.setClearColor(0,0,0,0);this._rctx.clearSafe(k.ClearBufferBit.COLOR_BUFFER_BIT);this._progress=0};e._accumulateShadow=function(){this._renderToShadowMap(this._bindParameters,this._lightDirectionsInternal[this._progress],this._depthRange);
this._passParameters.origin=this._bindParameters.camera.center;this._rctx.bindFramebuffer(this._fbo);const a=this._accumulationTechnique;this._rctx.bindTechnique(a,this._passParameters,this._bindParameters);this._rctx.bindVAO(this._vao);this._rctx.drawArrays(a.primitiveType,0,O.vertexCount(this._vao,"geometry"));this._progress++};e._updateCamera=function(a){a.equals(this._bindParameters.camera)||(this._bindParameters.camera.copyFrom(a),this._fbo.resize(a.fullWidth,a.fullHeight),this._opacityFromElevation=
1-E.smoothstep(r.shadowCastDisableElevationMin,r.shadowCastDisableElevationMax,a.relativeElevation))};e._requestRenderIfEnabled=function(){this._enabledInternal&&this._requestRender()};q._createClass(t,[{key:"computedSamples",get:function(){return this._progress}},{key:"shadowCastTexture",get:function(){return this._fbo.colorTexture}},{key:"isAccumulating",get:function(){return this._isPreviewing||this._isRefining}},{key:"_accumulationTechnique",get:function(){m.isNone(this._accumulationTechniqueCached)&&
(this._accumulationTechniqueCached=new L.ShadowCastAccumulateTechnique({rctx:this._rctx,viewingMode:this._stage.viewingMode}));return this._accumulationTechniqueCached}},{key:"_isRefining",get:function(){return this._isActive&&!this._isDoneAccumulating&&!this._previewingCached}},{key:"_isPreviewing",get:function(){return this._isActive&&this._previewingCached}},{key:"_isActive",get:function(){return this._enabledInternal&&0<this._sampleCount}},{key:"canAccumulate",get:function(){return null!==this._passParameters.linearDepthTexture&&
this._depthRange!==x.ZERO&&this._opacityFromElevation>r.shadowCastDisabledElevationThreshold}},{key:"_isDoneAccumulating",get:function(){return this._progress>=this._sampleCount}},{key:"_lightDirectionsInternal",get:function(){return this._cachedLightDirections},set:function(a){const d=this._cachedLightDirections;if(!C.equals(d,a,w.equals)){var h=a.length;d.length=h;this._sampleCount=Math.min(y.shadowCastMaxSamples,h);for(let l=0;l<h;++l){const u=a[l],p=d[l]||G.create();w.copy(p,u);d[l]=p}this._invalidate()}}},
{key:"_opacityFromElevation",get:function(){return this._accumulationRenderer.opacityFromElevation},set:function(a){this._accumulationRenderer.opacityFromElevation=a}},{key:"running",get:function(){return this._isRefining&&this.canAccumulate&&0<this._progress}},{key:"_previewing",set:function(a){this._previewingCached!==a&&(this._previewingCached=a,this._requestRenderIfEnabled())}},{key:"_lightDirections",set:function(a){this._lightDirectionsInternal=a}},{key:"_enabled",set:function(a){a!==this._enabledInternal&&
(a?this._start():this._stop())}},{key:"test",get:function(){const a=this;return{lightDirections:this._lightDirectionsInternal,get isDone(){return a._isDoneAccumulating},get isActive(){return a._isActive}}}}]);return t}(B);c.ShadowAccumulator.previewSamples=6;c.ShadowAccumulator.renderViewHandleKey="renderView";f.__decorate([g.property()],c.ShadowAccumulator.prototype,"_progress",void 0);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"_sampleCount",void 0);f.__decorate([g.property()],c.ShadowAccumulator.prototype,
"_enabledInternal",void 0);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"_depthRange",void 0);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"_previewingCached",void 0);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"_accumulationRenderer",void 0);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"_isRefining",null);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"_isActive",null);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"canAccumulate",
null);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"_isDoneAccumulating",null);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"_opacityFromElevation",null);f.__decorate([g.property()],c.ShadowAccumulator.prototype,"running",null);c.ShadowAccumulator=n=f.__decorate([F.subclass("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],c.ShadowAccumulator);const P=new Uint8Array(4);Object.defineProperties(c,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});