// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../chunks/tslib.es6 ../../../../../core/Accessor ../../../../../core/arrayUtils ../../../../../core/Logger ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/accessorSupport/decorators/property ../../../../../core/accessorSupport/ensureType ../../../../../core/accessorSupport/decorators/subclass ../../../../../chunks/mat3 ../../../../../chunks/mat3f64 ../../../../../chunks/mat4f64 ../../../../../chunks/vec3 ../../../../../chunks/vec3f64 ../../../../../core/support/WatchUpdatingTracking ../../../../../chunks/sphere ../../../../../chunks/vec33 ../../../../ViewingMode ../../collections/Component/Material/shader/ComponentData.glsl ../../core/util/TwoVectorPosition ../GridLocalOriginFactory ../localOriginHelper ../LocalOriginManager ../Object3D ../VertexArrayObject ../VertexAttribute ./bufferLayouts ./edgeBufferWriters ./edgePreprocessing ./EdgeRenderer ./EdgeShaderParameters ./EdgeWorkerHandle ./interfaces ./strokes ./util ../TextureBackedBuffer/BufferManager ../../../../webgl/BufferObject ../../../../webgl/enums".split(" "),
function(v,w,x,J,O,ca,P,r,z,va,da,K,ea,Q,D,L,fa,R,ha,ia,ja,ka,la,ma,na,oa,S,E,B,T,U,C,pa,qa,V,ra,A,sa,M,N){function ta(q){let p=null,k=null;for(let b=0;b<q.geometries.length;b++){const a=q.geometryRecords[b];if(a.material.supportsEdges){if(!p)p=a.transformation;else if(!O.equals(p,a.transformation))return!1;if(!k&&r.isSome(a.origin))k=a;else if(r.isSome(k?.origin)&&r.isSome(a.origin)&&k.origin.id!==a.origin.id)return!1}}return!0}function G(q,p,k){p*=k;k=O.binaryIndexOf(q,p,!0);return-1===k?p<q[0]?
q.length:0:q.length-k}v.EdgeView=function(q){function p(b){var a=q.call(this,b)||this;a._updatingHandles=new fa.WatchUpdatingTracking;a._perObjectData=new Map;a._perObjectDataEvictionCache=new Set;a._renderers=new Map;a._gpuMemoryUsage=0;a._workerAbort=new AbortController;a._tmpModelPosition=L.create();a._localOrigins=new na.LocalOriginManager(new la.GridLocalOriginFactory(b.renderSR));return a}w._inheritsLoose(p,q);var k=p.prototype;k.initialize=function(){this._worker=new qa.EdgeWorkerHandle(this.schedule);
this._componentColorManager=new sa.BufferManager(this.rctx,3);const b=B.VertexLayout.createBuffer(4);for(let a=0;4>a;a++)b.sideness.set(a,0,0===a||3===a?0:1),b.sideness.set(a,1,0===a||1===a?0:1);this._verticesBufferObject=M.BufferObject.createVertex(this.rctx,N.Usage.STATIC_DRAW,b.buffer)};k.destroy=function(){this.destroyed||(this._perObjectData.forEach(b=>this._discardObjectEntry(b)),this._perObjectData.clear(),this._strokesTexture=r.disposeMaybe(this._strokesTexture),this._componentColorManager=
r.destroyMaybe(this._componentColorManager),this._workerAbort.abort(),this._worker.destroy(),this._verticesBufferObject=r.disposeMaybe(this._verticesBufferObject),this._renderers.clear(),this._updatingHandles.destroy())};k.shouldRender=function(){return 0<this._renderers.size};k.addComponentObject=function(){var b=w._asyncToGenerator(function*(a,c,d,e,f,g,h,l){if(this.hasObject(a))return this.getObjectMemoryUsage(a);let m;d=new W(new Promise(n=>m=n),d.center,d.radius);this._perObjectData.set(a,d);
a=yield this._updatingHandles.addPromise(this._addComponentGeometry(c,d,e,f,g,h,l));this.setNeedsRender();m();return a});return function(a,c,d,e,f,g,h,l){return b.apply(this,arguments)}}();k.addOrUpdateObject3D=function(){var b=w._asyncToGenerator(function*(a,c,d,e){if(this.destroyed)ca.getLogger(this.declaredClass).warn("Attempt to add an object to a destroyed instance");else{var f=this._perObjectData.get(a);0<f?.renderables.length&&this._perObjectDataEvictionCache.add(f);var g,h=a.boundingVolumeWorldSpace.bounds;
h=new W(new Promise(m=>g=m),R.getCenter(h),R.getRadius(h));this._perObjectData.set(a,h);var l=[];if(d.mergeGeometries&&1<a.geometries.length&&ta(a))l.push(this._addObjectMergedGeometries(a,h,c,d,e));else for(let m=0;m<a.geometries.length;m++){const n=a.geometryRecords[m];n.material.supportsEdges&&l.push(this._addGeometry(a,h,a.geometries[m],n,c[0],d,e))}yield this._updatingHandles.addPromise(Promise.all(l));this._perObjectDataEvictionCache.delete(h);this._discardObjectEntry(f);this.setNeedsRender();
g()}});return function(a,c,d,e){return b.apply(this,arguments)}}();k._discardObjectEntry=function(b){b&&(b.renderables.length&&(b.renderables.forEach(a=>this._removeRenderable(a)),this.setNeedsRender()),b.loaded=null)};k.hasObject=function(b){return this._perObjectData.has(b)};k.updateAllComponentOpacities=function(){var b=w._asyncToGenerator(function*(a,c){a=yield this._updatingHandles.addPromise(this._getObjectEntry(a));if(!r.isNone(a)){var d=c instanceof Array?e=>c[e]:()=>c;a.renderables.forEach(e=>
{const f=e.components.meta.length;for(let g=0;g<f;g++){const h=d(g),l=e.components.meta[g],m=l.index;l.material.opacity=h;e.components.buffer.textureBuffer.setDataElement(m,1,3,255*h)}this._updateTransparency(e)});this.setNeedsRender()}});return function(a,c){return b.apply(this,arguments)}}();k.getObjectMemoryUsage=function(){var b=w._asyncToGenerator(function*(a){a=yield this._getObjectEntry(a);return r.isSome(a)?a.renderables.reduce((c,d)=>c+d.statistics.gpuMemoryUsage,0):0});return function(a){return b.apply(this,
arguments)}}();k.updateAllComponentMaterials=function(){var b=w._asyncToGenerator(function*(a,c,d,e){const f=a instanceof oa.Object3D,g=!!d.hasSlicePlane,h=A.determineRendererType(c),l=C.EdgeRenderer.getKey(h,g,f);a=yield this._updatingHandles.addPromise(this._getObjectEntry(a));r.isNone(a)||(a.renderables.forEach(m=>{if(l!==m.rendererKey){var n=this._renderers.get(m.rendererKey);const t=this._acquireRenderer(h,g,f);n.removeRenderable(m);--n.refCount;m.rendererKey=l;t.addRenderable(m)}for(n=0;n<c.length;n++)m.components.meta[n].material=
c[n];e&&this._updateComponentBuffer(m.components);this._updateTransparency(m)}),this.setNeedsRender())});return function(a,c,d,e){return b.apply(this,arguments)}}();k.updateAllVerticalOffsets=function(){var b=w._asyncToGenerator(function*(a,c){a=yield this._updatingHandles.addPromise(this._getObjectEntry(a));r.isNone(a)||(a.renderables.forEach(d=>{const e=d.components.meta;for(let f=0;f<e.length;f++)d.components.meta[f].verticalOffset=c?.[f]??0;this._updateComponentBuffer(d.components)}),this.setNeedsRender())});
return function(a,c){return b.apply(this,arguments)}}();k.updateObjectVisibility=function(){var b=w._asyncToGenerator(function*(a,c){a=yield this._updatingHandles.addPromise(this._getObjectEntry(a));r.isSome(a)&&(a.renderables.forEach(d=>d.visible=c),this.setNeedsRender())});return function(a,c){return b.apply(this,arguments)}}();k.removeObject=function(b){const a=this._perObjectData.get(b);a&&(this._perObjectData.delete(b),this._discardObjectEntry(a))};k._getObjectEntry=function(){var b=w._asyncToGenerator(function*(a){a=
this._perObjectData.get(a);if(!a)throw"no object";yield a.loaded;return null==a.loaded?null:a});return function(a){return b.apply(this,arguments)}}();k.render=function(b,a){if(!r.isNone(this._componentColorManager)){this._localOrigins.updateViewMatrices(b.camera.viewMatrix);var c=b.camera.viewInverseTransposeMatrix,d=L.create(),e=new ka.TwoVectorPosition,f=0,g=0;this._renderers.forEach(l=>{if(0===l.refCount)this._renderers.delete(l.key),l.dispose();else{let m=!0,n=!0;l.forEachRenderable(t=>{t.visible&&
(f+=t.statistics.averageEdgeLength,g++,m&&t.regular&&(l.updateTechnique(b,!1),m=!1),n&&t.silhouette&&(l.updateTechnique(b,!0),n=!1))},a)}});this._componentColorManager.garbageCollect();this._componentColorManager.updateTextures();if(0!==g){var h=new pa.EdgePassParameters(40*f/g,a);D.set(d,c[3],c[7],c[11]);e.set(d);D.copy(h.transformWorldFromViewTH,e.high);D.copy(h.transformWorldFromViewTL,e.low);K.fromMat4(h.transformViewFromCameraRelativeRS,b.camera.viewMatrix);K.transpose(X,h.transformViewFromCameraRelativeRS);
K.invert(h.transformNormalViewFromGlobal,X);h.transformProjFromView=b.camera.projectionMatrix;this._updateObjectCameraDistances(b);this._renderers.forEach(l=>{this._renderRegularEdges(l,b,h);this._renderSilhouetteEdges(l,b,h)})}}};k._updateTransparency=function(b){const a=A.determineEdgeTransparency(b.components.meta),c=A.determineObjectTransparency(b.components.meta);if(a!==b.edgeTransparency||c!==b.objectTransparency)b.edgeTransparency=a,b.objectTransparency=c,this._renderers.get(b.rendererKey).setRenderablesDirty()};
k._computeModelTransformWithLocalOrigin=function(b,a,c){b.getCombinedStaticTransformation(a,c);b=r.isSome(a.origin)?this._localOrigins.register(a.origin):this._localOrigins.acquire(D.set(this._tmpModelPosition,c[12],c[13],c[14]));a.origin=b.origin;ma.applyToModelMatrix(b.origin.vec3,c);return b};k._updateComponentBuffer=function(b){const {meta:a,buffer:c}=b;b=new Uint8Array(4);for(let e=0;e<a.length;e++){var d=a[e].material;const f=a[e].index,g=P.clamp(Math.round(d.size*C.LINE_WIDTH_FRACTION_FACTOR),
0,255),h=P.clamp(d.extensionLength,-C.EXTENSION_LENGTH_OFFSET,255-C.EXTENSION_LENGTH_OFFSET)+C.EXTENSION_LENGTH_OFFSET,l="solid"===d.type?U.EdgeType.SOLID:U.EdgeType.SKETCH,m=255*d.opacity;d=d.color;c.textureBuffer.setData(f,0,255*d[0],255*d[1],255*d[2],255*d[3]);c.textureBuffer.setData(f,1,g,h,l,m);ja.encodeElevationOffset(a[e].verticalOffset,b);c.textureBuffer.setData(f,2,b[0],b[1],b[2],b[3])}};k._createComponentBuffers=function(b){if(r.isNone(this._componentColorManager))return null;const a=[],
c=this._componentColorManager.getBuffer(b.length);for(let d=0;d<b.length;d++){const e=b[d],f=c.acquireIndex();a.push({index:f,verticalOffset:0,material:e})}b=new ua(c,a);this._updateComponentBuffer(b);return b};k._extractEdges=function(b,a,c,d,e,f=e.length){return this._worker.process({data:a,indices:e,indicesLength:f,writerSettings:b,skipDeduplicate:c},this._workerAbort.signal,d)};k._createRenderable=function(b,a,c,d,e){const f=r.isSome(this._verticesBufferObject)&&0<b.regular.lodInfo.lengths.length?
new Y(new S.VertexArrayObject(this.rctx,B.EdgeShaderAttributeLocations,{vertices:B.glVertexLayout,instances:T.RegularEdgeBufferWriter.glLayout},{vertices:this._verticesBufferObject,instances:M.BufferObject.createVertex(this.rctx,N.Usage.STATIC_DRAW,b.regular.instancesData.buffer)}),b.regular.lodInfo):null,g=r.isSome(this._verticesBufferObject)&&0<b.silhouette.lodInfo.lengths.length?new Y(new S.VertexArrayObject(this.rctx,B.EdgeShaderAttributeLocations,{vertices:B.glVertexLayout,instances:T.SilhouetteEdgeBufferWriter.glLayout},
{vertices:this._verticesBufferObject,instances:M.BufferObject.createVertex(this.rctx,N.Usage.STATIC_DRAW,b.silhouette.instancesData.buffer)}),b.silhouette.lodInfo):null,h=(r.isSome(f)?f.vao.size:0)+(r.isSome(g)?g.vao.size:0);return new H(f,g,{gpuMemoryUsage:h,externalMemoryUsage:e,averageEdgeLength:b.averageEdgeLength},c,A.determineEdgeTransparency(a.meta),A.determineObjectTransparency(a.meta),a,d)};k._addGeometry=function(){var b=w._asyncToGenerator(function*(a,c,d,e,f,g,h){var l=d.vertexAttributes.get(E.VertexAttribute.POSITION);
const m=d.indices.get(E.VertexAttribute.POSITION),n=Q.create();a=this._computeModelTransformWithLocalOrigin(a,e,n);l=new Z(l,m,n,a);return this._addPositionData(c,l,d.edgeIndicesLength,f,g,h)});return function(a,c,d,e,f,g,h){return b.apply(this,arguments)}}();k._addPositionData=function(){var b=w._asyncToGenerator(function*(a,c,d,e,f,g=!1){if(null!=a.loaded){var h=this._createComponentBuffers([e]);if(!(r.isNone(h)||0>=d)){e=this._acquireRenderer(e.type,!!f.hasSlicePlane,!0);var {modelTransform:l,
origin:m}=c;f=c.indices;c=c.position;var n=c.data.length/c.size,t=B.EdgeInputBufferLayout.createBuffer(n);for(let u=0;u<n;u++)t.position.set(u,0,c.data[u*c.size]),t.position.set(u,1,c.data[u*c.size+1]),t.position.set(u,2,c.data[u*c.size+2]);A.fillComponenBufferIndices(h.meta,[0,t.componentIndex.count],t.componentIndex);d=yield this._updatingHandles.addPromise(this._extractEdges(e.writerSettings,t,!1,g,f,d));null!=a.loaded&&(h=this._createRenderable(d,h,new aa(l,m),e.key,!1),a.renderables.push(h),
e.addRenderable(h),this._gpuMemoryUsage+=h.statistics.gpuMemoryUsage)}}});return function(a,c,d,e,f){return b.apply(this,arguments)}}();k._addComponentGeometry=function(){var b=w._asyncToGenerator(function*(a,c,d,e,f,g,h){if(null==c.loaded)return 0;const l=this._createComponentBuffers(g);if(r.isNone(l))return 0;g=A.determineRendererType(g);h=this._acquireRenderer(g,h.hasSlicePlane||!1,!1);g=B.EdgeInputBufferLayout.createBuffer(d.count);ha.copy(g.position,d);A.fillComponenBufferIndices(l.meta,f,g.componentIndex,
e);d=yield this._updatingHandles.addPromise(this._extractEdges(h.writerSettings,g,!0,!1,e));if(null==c.loaded)return 0;a=this._createRenderable(d,l,a,h.key,!0);c.renderables.push(a);h.addRenderable(a);return a.statistics.gpuMemoryUsage});return function(a,c,d,e,f,g,h){return b.apply(this,arguments)}}();k._addObjectMergedGeometries=function(){var b=w._asyncToGenerator(function*(a,c,d,e,f){var g=new Map,h=0,l=null,m=0;for(var n=0;n<a.geometries.length;n++){var t=a.geometries[n],u=a.geometryRecords[n];
u.material.supportsEdges&&(!l&&u.origin&&(l=u),u=t.vertexAttributes.get(E.VertexAttribute.POSITION),m+=u.data.length/u.size,h+=t.edgeIndicesLength)}m=65536<=m?Uint32Array:Uint16Array;h=h?new m(h):null;m=[];n=0;for(t=0;t<a.geometries.length;t++){u=a.geometries[t];if(!a.geometryRecords[t].material.supportsEdges)continue;var y=u.vertexAttributes.get(E.VertexAttribute.POSITION);const ba=u.indices.get(E.VertexAttribute.POSITION);let I=g.get(y.data);if(null==I){I=m.length/3;for(let F=0;F<y.data.length;F+=
y.size)m.push(y.data[F+0]),m.push(y.data[F+1]),m.push(y.data[F+2]);g.set(y.data,I)}if(ba)for(y=0;y<u.edgeIndicesLength;y++)h[n++]=I+ba[y]}l=l||a.geometryRecords[0];g=Q.create();l=this._computeModelTransformWithLocalOrigin(a,l,g);for(n=0;n<a.geometryRecords.length;n++)a.geometryRecords[n].origin=l.origin;a=new Z({data:m,size:3},h,g,l);yield this._updatingHandles.addPromise(this._addPositionData(c,a,h.length,d[0],e,f))});return function(a,c,d,e,f){return b.apply(this,arguments)}}();k._acquireRenderer=
function(b,a,c){const d=C.EdgeRenderer.getKey(b,a,c);let e=this._renderers.get(d);r.isNone(this._strokesTexture)&&(this._strokesTexture=ra.generateStrokesTexture(this.rctx));e||(e=new C.EdgeRenderer(this.rctx,this.techniqueRepository,{type:b,hasSlicePlane:a,strokesTexture:this._strokesTexture,legacy:c,spherical:this.viewingMode===ia.ViewingMode.Global}),this._renderers.set(d,e));++e.refCount;return e};k._removeRenderable=function(b){r.isSome(b.regular)&&(b.regular.vao.vertexBuffers.instances.dispose(),
b.regular.vao.dispose(!1),b.regular.vao=null);r.isSome(b.silhouette)&&(b.silhouette.vao.vertexBuffers.instances.dispose(),b.silhouette.vao.dispose(!1),b.silhouette.vao=null);const a=this._renderers.get(b.rendererKey);if(a){a.removeRenderable(b);--a.refCount;"origin"in b.transform&&this._localOrigins.release(b.transform.origin);this._gpuMemoryUsage-=b.statistics.externalMemoryUsage?0:b.statistics.gpuMemoryUsage;for(const c of b.components.meta)b.components.buffer.releaseIndex(c.index)}};k._updateObjectCameraDistances=
function(b){const a=b.camera.eye,c=b.camera.viewForward,d=L.create();b=e=>{D.sub(d,e.center,a);const f=D.dot(d,c),g=e.radius,h=f<-g?Infinity:f<g?0:f-g;e.renderables.forEach(l=>l.distanceToCamera=h)};this._perObjectData.forEach(b);this._perObjectDataEvictionCache.forEach(b)};k._renderRegularEdges=function(b,a,c){const d=b.bindRegularEdges(c,a),e=a.camera.perScreenPixelRatio;b.forEachRenderable(f=>{if(r.isSome(f.regular)&&f.visible){var g=G(f.regular.lod.lengths,f.distanceToCamera,e);b.renderRegularEdges(d,
f,c,a,g)}},c.transparency)};k._renderSilhouetteEdges=function(b,a,c){const d=b.bindSilhouetteEdges(c,a),e=a.camera.perScreenPixelRatio;b.forEachRenderable(f=>{if(r.isSome(f.silhouette)&&f.visible){var g=G(f.silhouette.lod.lengths,f.distanceToCamera,e);b.renderSilhouetteEdges(d,f,c,a,g)}},c.transparency)};w._createClass(p,[{key:"updating",get:function(){return this._updatingHandles.updating}},{key:"usedMemory",get:function(){return this._gpuMemoryUsage}},{key:"test",get:function(){return{hasRenderedPrimitives:b=>
{let a=!1;const c=b.perScreenPixelRatio,d=(e,f)=>e.forEachRenderable(g=>{g.visible&&!a&&(r.isSome(g.regular)&&(a=0<G(g.regular.lod.lengths,g.distanceToCamera,c)),!a&&r.isSome(g.silhouette)&&(a=0<G(g.silhouette.lod.lengths,g.distanceToCamera,c)))},f);this._renderers.forEach(e=>{a||(d(e,V.Transparency.OPAQUE),d(e,V.Transparency.TRANSPARENT))});return a}}}}]);return p}(J);x.__decorate([z.property({constructOnly:!0})],v.EdgeView.prototype,"rctx",void 0);x.__decorate([z.property({constructOnly:!0})],v.EdgeView.prototype,
"renderSR",void 0);x.__decorate([z.property({constructOnly:!0})],v.EdgeView.prototype,"viewingMode",void 0);x.__decorate([z.property({constructOnly:!0})],v.EdgeView.prototype,"techniqueRepository",void 0);x.__decorate([z.property({constructOnly:!0})],v.EdgeView.prototype,"setNeedsRender",void 0);x.__decorate([z.property({constructOnly:!0})],v.EdgeView.prototype,"schedule",void 0);x.__decorate([z.property({readOnly:!0})],v.EdgeView.prototype,"_updatingHandles",void 0);x.__decorate([z.property({readOnly:!0})],
v.EdgeView.prototype,"updating",null);v.EdgeView=x.__decorate([da.subclass("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],v.EdgeView);let W=function(q,p,k){this.center=p;this.radius=k;this.renderables=[];this.loaded=q;this.loaded.then(()=>{null!=this.loaded&&(this.loaded=!0)})},ua=function(q,p){this.buffer=q;this.meta=p},Y=function(q,p){this.vao=q;this.lod=p},aa=function(q,p){this.modelMatrix=q;this.origin=p},H=function(q,p,k,b,a,c,d,e){this.regular=q;this.silhouette=p;this.statistics=
k;this.transform=b;this.edgeTransparency=a;this.objectTransparency=c;this.components=d;this.rendererKey=e;this.distanceToCamera=0;this.visible=!0};x=function(q){function p(){return q.apply(this,arguments)||this}w._inheritsLoose(p,q);return p}(H);J=function(q){function p(){return q.apply(this,arguments)||this}w._inheritsLoose(p,q);return p}(H);let Z=function(q,p,k,b){this.position=q;this.indices=p;this.modelTransform=k;this.origin=b};const X=ea.create();v.LegacyTransform=aa;v.RegularRenderable=x;v.Renderable=
H;v.SilhouetteRenderable=J;Object.defineProperties(v,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});