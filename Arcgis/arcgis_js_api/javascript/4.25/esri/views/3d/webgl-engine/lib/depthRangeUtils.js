// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/floatRGBA ../../../../core/maybe ../../../../core/PooledArray ../../../../chunks/mat4 ../../../../chunks/mat4f64 ../../../../chunks/vec3 ../../../../chunks/vec4 ../../../../chunks/vec4f64 ../../../../geometry/support/frustum ../../../../chunks/sphere ../../support/mathUtils ./depthRange ./Octree ./Util".split(" "),function(x,M,N,y,O,z,A,C,P,r,B,Q,D,t,u,R){function H(h,g){if(g.isVisible){var a=t.empty(),b=g.getSpatialQueryAccelerator();
y.isSome(b)?S(a,h,b):T(a,h,g.objects);return a}}function S(h,g,a){var b=g.eye;const c=g.viewForward,d=g.frustum,e=k=>k.isVisible;var f=a.objectCount;500>f?(t.set(q,g.near,Math.min(h.near,g.far)),a.forEachInDepthRange(b,c,u.DepthOrder.FRONT_TO_BACK,q,(k,m)=>{E(h,g,k);q.far=h.near;m.setRange(q)},d,e),t.set(q,Math.max(h.far,g.near),g.far),a.forEachInDepthRange(b,c,u.DepthOrder.BACK_TO_FRONT,q,(k,m)=>{E(h,g,k);q.near=h.far;m.setRange(q)},d,e)):(f=Math.max(Math.min(f,500),Math.ceil(.1*f)),b=a.findClosest(c,
u.DepthOrder.FRONT_TO_BACK,d,e,f),a=a.findClosest(c,u.DepthOrder.BACK_TO_FRONT,d,e,f),b&&a&&(I(h,g,b.boundingVolumeWorldSpace.bounds),I(h,g,a.boundingVolumeWorldSpace.bounds)))}function T(h,g,a){v.clear();a.forAll(b=>{b.isVisible&&0!==b.geometryRecords.length&&v.add(b)});v.empty||(v.sort(g),t.set(q,g.near,Math.min(h.near,g.far)),v.forEachInDepthRange(q,u.DepthOrder.FRONT_TO_BACK,(b,c)=>{c<h.near&&E(h,g,b)}),t.set(q,Math.max(h.far,g.near),g.far),v.forEachInDepthRange(q,u.DepthOrder.BACK_TO_FRONT,(b,
c,d)=>{h.far=Math.max(h.far,d)}))}function E(h,g,a){if(a.isVisible&&B.intersectsSphere(g.frustum,a.boundingVolumeWorldSpace.bounds)){var b=a.transformation,c=U;a.geometryRecords.forEach(d=>{z.multiply(c,b,d.getShaderTransformation());const e=D.maxScale(c);J(h,g,d.geometry.boundingInfo,c,e)})}}function J(h,g,a,b,c){if(!y.isNone(a)){C.transformMat4(n,a.center,b);var {eye:d,viewForward:e}=g,f=e[0]*(n[0]-d[0])+e[1]*(n[1]-d[1])+e[2]*(n[2]-d[2]);n[3]=a.radius*c;if(!(f-n[3]>h.near&&f+n[3]<h.far)&&B.intersectsSphere(g.frustum,
n))if(100<a.radius&&a.getChildren())for(a=a.getChildren(),f=0;8>f;++f)a[f]&&J(h,g,a[f],b,c);else F.unionDepthRangeWithAABB(h,g.viewProjectionMatrix,b,a.bbMin,a.bbMax)}}function I(h,g,a){var b=g.eye;g=g.viewForward;b=(a[0]-b[0])*g[0]+(a[1]-b[1])*g[1]+(a[2]-b[2])*g[2];h.near=Math.min(h.near,b-a[3]);h.far=Math.max(h.far,b+a[3])}let V=function(){function h(){this._items=new O({allocator:a=>a||{obj:null,distance:0,near:0,far:0},deallocator:a=>{a.obj=null;a.distance=0;a.near=0;a.far=0;return a}})}var g=
h.prototype;g.clear=function(){this._items.clear()};g.add=function(a){this._items.pushNew().obj=a};g.sort=function(a){const b=a.eye,c=a.viewForward;this._items.forAll(d=>{const e=d.obj.boundingVolumeWorldSpace.bounds,f=(e[0]-b[0])*c[0]+(e[1]-b[1])*c[1]+(e[2]-b[2])*c[2];d.distance=f;d.near=f-e[3];d.far=f+e[3]});this._items.sort((d,e)=>d.distance-e.distance)};g.forEachInDepthRange=function(a,b,c){if(b===u.DepthOrder.FRONT_TO_BACK)for(b=0;b<this._items.length;++b){var d=this._items.data[b];d.far<a.near||
d.near>a.far||c(d.obj,d.near,d.far)}else for(b=this._items.length-1;0<=b;--b)d=this._items.data[b],d.far<a.near||d.near>a.far||c(d.obj,d.near,d.far)};M._createClass(h,[{key:"length",get:function(){return this._items.length}},{key:"empty",get:function(){return 0===this._items.length}}]);return h}(),L=function(){function h(){this._view=A.create();this._viewProj=A.create();this._frustum=B.create();this._geometries=[];this._near=[];this._far=[];this._nearCandidates=[];this._farCandidates=[];this._range=
{near:0,far:0};this._looseRange={near:0,far:0}}var g=h.prototype;g.compute=function(a,b){this._reset();z.copy(this._view,a.viewMatrix);z.multiply(this._viewProj,a.projectionMatrix,this._view);B.copy(this._frustum,a.frustum);a=this._view;const c=a[2],d=a[6],e=a[10],f=a[14];a=this._range;let k=0;b.forEach(l=>{if(l.instanceParameters.visible&&l.castShadow){if(l.hasShaderTransformation){l.computeBoundingSphere(l.getShaderTransformation(),n,1);var p=n}else p=l.boundingSphere;var K=c*p[0]+d*p[1]+e*p[2]+
f,W=K-p[3];p=K+p[3];this._geometries[k]=l;this._near[k]=-p;this._far[k]=-W;++k}});if(0===this._geometries.length)return a;for(b=0;b<this._geometries.length;++b)this._near[b]>a.far&&(a.far=this._near[b]),2<this._near[b]&&this._far[b]<a.near&&(a.near=this._far[b]);b=this._looseRange;b.near=Math.max(.5*a.near,2);b.far=2*a.far;var m=0;let w=0;for(let l=0;l<this._geometries.length;++l)this._near[l]<a.near&&(this._near[l]>=b.near?a.near=this._near[l]:this._nearCandidates[m++]=l),this._far[l]>a.far&&(this._far[l]<=
b.far?a.far=this._far[l]:this._farCandidates[w++]=l);if(0===this._nearCandidates.length&&0===this._farCandidates.length)return a;this._nearCandidates.sort((l,p)=>this._near[l]<this._near[p]?-1:this._near[l]>this._near[p]?1:0);this._farCandidates.sort((l,p)=>this._far[l]<this._far[p]?1:this._far[l]>this._far[p]?-1:0);for(b=0;b<this._nearCandidates.length;++b)m=this._nearCandidates[b],this._near[m]<a.near&&(m=this._geometries[m],this._includeNearBoundingInfoRec(m.boundingInfo,m.getShaderTransformation()));
for(b=0;b<this._farCandidates.length;++b)m=this._farCandidates[b],this._far[m]>a.far&&(m=this._geometries[m],this._includeFarBoundingInfoRec(m.boundingInfo,m.getShaderTransformation()));return a};g._reset=function(){this._geometries.length=0;this._near.length=0;this._far.length=0;this._nearCandidates.length=0;this._farCandidates.length=0;this._range.near=Number.MAX_VALUE;this._range.far=-Number.MAX_VALUE};g._includeNearBoundingInfoRec=function(a,b){if(!y.isNone(a)){var c=a.getCenter();C.transformMat4(n,
c,b);c=D.maxScale(b);var d=n[0],e=n[1],f=n[2];c*=a.getBSRadius();var k=this._frustum;if(!(k[0][0]*d+k[0][1]*e+k[0][2]*f+k[0][3]>c||k[1][0]*d+k[1][1]*e+k[1][2]*f+k[1][3]>c||k[2][0]*d+k[2][1]*e+k[2][2]*f+k[2][3]>c||k[3][0]*d+k[3][1]*e+k[3][2]*f+k[3][3]>c||(d=this._view[2]*d+this._view[6]*e+this._view[10]*f+this._view[14],e=d+c,2>-(d-c)||-e>=this._range.near)))if(-e>this._looseRange.near)this._range.near=-e;else{if(100<c&&(c=a.getChildren(),void 0!==c)){for(a=0;8>a;++a)void 0!==c[a]&&this._includeNearBoundingInfoRec(c[a],
b);return}F.unionDepthRangeWithAABB(this._range,this._viewProj,b,a.getBBMin(),a.getBBMax())}}};g._includeFarBoundingInfoRec=function(a,b){if(!y.isNone(a)){var c=a.getBSRadius(),d=a.getCenter();C.transformMat4(n,d,b);var e=D.maxScale(b);d=n[0];var f=n[1],k=n[2];c*=e;e=this._frustum;if(!(e[0][0]*d+e[0][1]*f+e[0][2]*k+e[0][3]>c||e[1][0]*d+e[1][1]*f+e[1][2]*k+e[1][3]>c||e[2][0]*d+e[2][1]*f+e[2][2]*k+e[2][3]>c||e[3][0]*d+e[3][1]*f+e[3][2]*k+e[3][3]>c||(d=this._view[2]*d+this._view[6]*f+this._view[10]*
k+this._view[14]-c,-d<=this._range.far)))if(-d<this._looseRange.far)this._range.far=-d;else{if(100<c&&(c=a.getChildren(),void 0!==c)){for(a=0;8>a;++a)void 0!==c[a]&&this._includeFarBoundingInfoRec(c[a],b);return}F.unionDepthRangeWithAABB(this._range,this._viewProj,b,a.getBBMin(),a.getBBMax())}}};return h}(),X=function(){function h(){this._modelViewProj=A.create();this._clipPosition=[r.create(),r.create(),r.create(),r.create(),r.create(),r.create(),r.create(),r.create()]}var g=h.prototype;g.unionDepthRangeWithAABB=
function(a,b,c,d,e){var f=this._modelViewProj;z.multiply(f,b,c);b=!1;for(c=0;8>c;++c){const k=this._clipPosition[c],m=0===c||3===c||4===c||7===c?d[0]:e[0],w=0===c||1===c||4===c||5===c?d[1]:e[1],l=4>c?d[2]:e[2];k[0]=f[0]*m+f[4]*w+f[8]*l+f[12];k[1]=f[1]*m+f[5]*w+f[9]*l+f[13];k[2]=f[2]*m+f[6]*w+f[10]*l+f[14];k[3]=f[3]*m+f[7]*w+f[11]*l+f[15]}for(d=0;12>d;++d){e=this._clipTriangle(this._clipPosition[G[d][0]],this._clipPosition[G[d][1]],this._clipPosition[G[d][2]]);f=!0;for(c=0;c<e.length;++c)if(2<=e[c][3]){f=
!1;break}if(!f)for(b=!0,f=0;f<e.length;++f)c=e[f][3],Number.isFinite(c)&&(a.near=Math.min(c,a.near),a.far=Math.max(c,a.far))}return b};g._inside=function(a,b){if(0===b)return a[0]>=-a[3];if(1===b)return a[1]>=-a[3];if(2===b)return a[0]<=a[3];if(3===b)return a[1]<=a[3];R.assert(!1)};g._intersect=function(a,b,c){let d=0;0===c?d=(-a[3]-a[0])/(b[0]-a[0]+b[3]-a[3]):1===c?d=(-a[3]-a[1])/(b[1]-a[1]+b[3]-a[3]):2===c?d=(a[3]-a[0])/(b[0]-a[0]-b[3]+a[3]):3===c&&(d=(a[3]-a[1])/(b[1]-a[1]-b[3]+a[3]));return P.lerp(r.create(),
a,b,d)};g._clipTriangle=function(a,b,c){a=[a,b,c];for(b=0;4>b;++b){c=a;a=[];for(let d=0;d<c.length;++d){const e=c[d],f=c[(d+1)%c.length];this._inside(f,b)?(this._inside(e,b)||a.push(this._intersect(e,f,b)),a.push(f)):this._inside(e,b)&&a.push(this._intersect(e,f,b))}}return a};return h}();const G=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],n=Q.create(),U=A.create(),q=t.empty(),v=new V,Y=new L,F=new X;x.DepthRangeFromRenderGeometries=L;x.depthRangeFromLayer=
H;x.depthRangeFromScene=function(h,g,a){if(1E4>g.size)return Y.compute(h,g);const b=t.empty();a.forAll(c=>{c.isVisible&&t.union(b,H(h,c))});return b};x.textureToDepth=function(h,g,a){return N.unpackFloatRGBA(g,h)*(a[1]-a[0])+a[0]};Object.defineProperties(x,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});