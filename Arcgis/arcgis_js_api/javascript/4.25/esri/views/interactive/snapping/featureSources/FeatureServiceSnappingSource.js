// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/HandleOwner ../../../../core/handleUtils ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../core/accessorSupport/tracking/ObservableValue ../../../../support/elevationInfoUtils ../../../2d/interactive/snapping/featureSources/featureServiceSource/FeatureServiceTiles2D ../../../3d/interactive/snapping/featureSources/featureServiceSource/FeatureServiceTiles3D ./queryEngineUtils ./WorkerTileTreeDebugger ./featureServiceSource/FeatureServiceSnappingSourceWorkerHandle ./featureServiceSource/FeatureServiceTilesSimple ../../../support/debugFlags".split(" "),
function(c,n,f,B,C,w,p,x,e,g,K,L,D,E,y,F,G,z,H,v,I,J){c.FeatureServiceSnappingSource=function(A){function t(a){return A.call(this,a)||this}n._inheritsLoose(t,A);var u=t.prototype;u.initialize=function(){const a=this.view;if(p.isSome(a))switch(a.type){case "2d":this._tilesOfInterest=new F.FeatureServiceTiles2D({view:a,layer:this._layer});this._workerHandle=new v.FeatureServiceSnappingSourceWorkerHandle;break;case "3d":const {resourceController:d}=a,m=this._layer,l=a.whenLayerView(m);this._tilesOfInterest=
new G.FeatureServiceTiles3D({view:a});this._workerHandle=new v.FeatureServiceSnappingSourceWorkerHandle({schedule:b=>d.schedule(b),hasZ:this._layer.hasZ&&(this._layer.returnZ??!0),elevationAlignPointsInFeatures:function(){var b=n._asyncToGenerator(function*(h,k){const q=yield l;x.throwIfAborted(k);return q.elevationAlignPointsInFeatures(h,k)});return function(h,k){return b.apply(this,arguments)}}(),queryForSymbologySnapping:function(){var b=n._asyncToGenerator(function*(h,k){const q=yield l;x.throwIfAborted(k);
return q.queryForSymbologySnapping(h,k)});return function(h,k){return b.apply(this,arguments)}}()});const r=new E.ObservableValue(null);l.then(b=>r.set(b));this.addHandles([a.elevationProvider.on("elevation-change",({context:b})=>{const {elevationInfo:h}=m;y.elevationContextAffectsAlignment(b,h)&&this._workerHandle?.notifyElevationSourceChange()}),e.watch(()=>m.elevationInfo,()=>this._workerHandle?.notifyElevationSourceChange(),e.initial),e.watch(()=>p.applySome(r.get(),({processor:b})=>b?.renderer),
()=>this._workerHandle?.notifySymbologyChange(),e.initial),e.watch(()=>p.mapOr(r.get(),!1,b=>b.symbologySnappingSupported),b=>this._workerHandle?.setSymbologySnappingSupported(b),e.initial)])}else this._tilesOfInterest=new I.FeatureServiceTilesSimple({layer:this._layer}),this._workerHandle=new v.FeatureServiceSnappingSourceWorkerHandle;this.handles.add([w.destroyHandle(this._workerHandle)]);this._workerHandle.setup({layer:this._layer,spatialReference:this.spatialReference,configuration:this.configuration},
null);this.updatingHandles.add(()=>this._updateTilesParameters,()=>this._workerHandle.updateTiles(this._updateTilesParameters,null),e.initial);this.handles.add([e.watch(()=>this.configuration,d=>this._workerHandle.configure(d,null),e.sync)]);p.isSome(a)&&this.handles.add(e.watch(()=>J.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES,d=>{d&&!this._debug?(this._debug=new H.WorkerTileTreeDebugger({view:a,handle:this._workerHandle}),this.handles.add(w.destroyHandle(this._debug),"debug")):!d&&this._debug&&
this.handles.remove("debug")},e.initial));this.handles.add(this.layerSource.layer.on("apply-edits",d=>{this._workerHandle.applyEdits(d,null)}))};u.refresh=function(){this._workerHandle.refresh(null)};u.fetchCandidates=function(){var a=n._asyncToGenerator(function*(d,m){const {coordinateHelper:l,elevationInfo:r,point:b}=d;this._tilesOfInterest.pointOfInterest=l.vectorToPoint(b);const h=l.hasZ()?y.absoluteHeightElevationInfo:r,k=this._getGroundElevation;return(yield this._workerHandle.fetchCandidates({...d},
m)).candidates.map(q=>z.convertSnappingCandidate(q,l,h,k))});return function(d,m){return a.apply(this,arguments)}}();u.getDebugInfo=function(a){return this._workerHandle.getDebugInfo(a)};n._createClass(t,[{key:"_updateTilesParameters",get:function(){return{tiles:this._tilesOfInterest.tiles,tileInfo:this._tilesOfInterest.tileInfo,tileSize:this._tilesOfInterest.tileSize}}},{key:"updating",get:function(){return this._workerHandle.updating||this.updatingHandles.updating}},{key:"configuration",get:function(){var {view:a}=
this;a=p.isSome(a)?a.type:"2d";return{filter:this._layer.createQuery(),customParameters:this._layer.customParameters,viewType:a}}},{key:"availability",get:function(){return this._workerHandle.availability}},{key:"_layer",get:function(){return this.layerSource.layer}},{key:"_getGroundElevation",get:function(){return z.makeGetGroundElevation(this.view)}}]);return t}(C.HandleOwnerMixin(B));f.__decorate([g.property({constructOnly:!0})],c.FeatureServiceSnappingSource.prototype,"spatialReference",void 0);
f.__decorate([g.property({constructOnly:!0})],c.FeatureServiceSnappingSource.prototype,"layerSource",void 0);f.__decorate([g.property({constructOnly:!0})],c.FeatureServiceSnappingSource.prototype,"view",void 0);f.__decorate([g.property()],c.FeatureServiceSnappingSource.prototype,"_tilesOfInterest",void 0);f.__decorate([g.property({readOnly:!0})],c.FeatureServiceSnappingSource.prototype,"_updateTilesParameters",null);f.__decorate([g.property({readOnly:!0})],c.FeatureServiceSnappingSource.prototype,
"updating",null);f.__decorate([g.property({readOnly:!0})],c.FeatureServiceSnappingSource.prototype,"configuration",null);f.__decorate([g.property({readOnly:!0})],c.FeatureServiceSnappingSource.prototype,"availability",null);f.__decorate([g.property()],c.FeatureServiceSnappingSource.prototype,"_getGroundElevation",null);c.FeatureServiceSnappingSource=f.__decorate([D.subclass("esri.views.interactive.snapping.featureSources.FeatureServiceSnappingSource")],c.FeatureServiceSnappingSource);Object.defineProperties(c,
{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});