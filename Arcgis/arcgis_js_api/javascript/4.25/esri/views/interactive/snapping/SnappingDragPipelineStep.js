// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/maybe ../../../core/promiseUtils ../../../layers/graphics/dehydratedFeatureComparison ../../../layers/graphics/hydratedFeatures ../dragEventPipeline ./SnappingContext ../../support/Scheduler".split(" "),function(x,G,e,y,H,I,z,J,A){let Q=function(){function B(){this.next=new z.EventPipeline}var l=B.prototype;l.createSnapDragEventPipelineStep=function({predicate:a=()=>!0,cancel:b,snappingManager:c,snappingContext:g,updatingHandles:h,
useZ:m=!0}){if(e.isNone(c))return d=>d;let n=null,f=null;const q=()=>{n=e.abortMaybe(n);c.doneSnapping();e.isSome(f)&&f.frameTask.remove();f=null};b.next(d=>{q();return d});this.next=new z.EventPipeline;const v=this._createSnapFunction(c,m);let p=null,r=null,t=null;return d=>{if(!a(d))return d;if("start"===d.action){var k=this._createFrameTask(c.view);f=this._createSnappingInfo(g,d,k);f.context.selfSnappingZ=null;!m&&e.isSome(d.info)&&(k=this._extractSelfSnappingZ(g.coordinateHelper,d.info.handle.component),
e.isSome(k)&&(f.context.selfSnappingZ={value:k,elevationInfo:g.elevationInfo}))}if(e.isSome(f)){const {context:K,originalScenePos:L,originalPos:C}=f,{mapEnd:D,mapStart:E,action:M,scenePoints:N}=d;k=this._updatePosition(C,this._computeMapDelta(D,E));const F=this._computeMapDelta(E,C),O={...d,action:"update"},P=f.context,w=this._updateScenePosition(L,N);var u=c.update({point:k,scenePoint:w,context:K});t=u;this._applySnappedUpdate(D,u,F,m);p=k;r=w;"end"!==M&&({frameTask:u}=f,e.isNone(n)&&(n=new AbortController),
h.addPromise(y.ignoreAbortErrors(v({frameTask:u,event:O,context:P,point:k,scenePoint:w,delta:F,lastPos:p,lastScenePos:r,lastUpdate:t},n.signal))))}"end"===d.action&&q();return d}};l._createSnapFunction=function(a,b){var c=this;return y.debounce(function(){var g=G._asyncToGenerator(function*({frameTask:h,point:m,scenePoint:n,context:f,event:q,delta:v,lastPos:p,lastScenePos:r,lastUpdate:t},d){const k=yield h.schedule(()=>a.snap({point:m,scenePoint:n,context:f,signal:d}),d);k.valid&&(h=yield h.schedule(()=>
k.apply(),d),m!==p&&e.isSome(p)&&(h=a.update({point:p,scenePoint:r,context:f})),H.pointEquals(h,t)||(c._applySnappedUpdate(q.mapEnd,h,v,b),c.next.execute(q)))});return function(h,m){return g.apply(this,arguments)}}())};l._createFrameTask=function(a){return"3d"===a.type?a.resourceController.scheduler.registerTask(A.TaskPriority.SNAPPING):A.ImmediateTask};l._createSnappingInfo=function(a,b,c){return{context:new J.SnappingContext({editGeometryOperations:a.editGeometryOperations,elevationInfo:a.elevationInfo,
pointer:a.pointer,vertexHandle:e.isSome(b.info)?b.info.handle:null,excludeFeature:a.excludeFeature,visualizer:a.visualizer}),originalPos:e.isSome(b.snapOrigin)?a.coordinateHelper.vectorToDehydratedPoint(b.snapOrigin):b.mapStart,originalScenePos:e.isSome(b.scenePoints)?b.scenePoints.sceneStart:null,frameTask:c}};l._updatePosition=function(a,[b,c,g]){a=I.clonePoint(a);a.x+=b;a.y+=c;a.hasZ&&(a.z+=g);return a};l._updateScenePosition=function(a,b){return e.isNone(a)||e.isNone(b)?null:this._updatePosition(a,
this._computeMapDelta(b.sceneEnd,b.sceneStart))};l._computeMapDelta=function(a,b){return[a.x-b.x,a.y-b.y,a.hasZ&&b.hasZ?a.z-b.z:0]};l._applySnappedUpdate=function(a,b,[c,g,h],m){a.x=b.x+c;a.y=b.y+g;m&&a.hasZ&&b.hasZ&&(a.z=b.z+h)};l._extractSelfSnappingZ=function(a,b){if(!a.hasZ())return null;var c=b.vertices;b=null;for(const g of c){c=a.getZ(g.pos);if(e.isSome(b)&&1E-6<Math.abs(c-b))return null;e.isNone(b)&&(b=c)}return b};return B}();x.SnappingPipeline=Q;Object.defineProperties(x,{__esModule:{value:!0},
[Symbol.toStringTag]:{value:"Module"}})});