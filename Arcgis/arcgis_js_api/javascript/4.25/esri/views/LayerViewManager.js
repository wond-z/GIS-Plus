// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../core/Accessor ../core/Error ../core/Logger ../core/MapUtils ../core/maybe ../core/promiseUtils ../core/reactiveUtils ../core/scheduling ../core/accessorSupport/decorators/property ../core/arrayUtils ../core/accessorSupport/ensureType ../core/accessorSupport/decorators/subclass ../core/support/WatchUpdatingTracking".split(" "),function(u,k,h,v,x,y,r,n,w,z,l,D,E,A,B){let C=function(){function t(f,b,a){this.layer=f;this.view=b;this.layerViewImporter=
a;this._controller=new AbortController;this._deferred=n.createDeferred();this.done=this._started=!1;n.onAbort(this._controller.signal,()=>{const c=new v("cancelled:layerview-create","layerview creation cancelled",{layer:f});this._deferred.reject(c)})}var p=t.prototype;p.destroy=function(){this._controller.abort();const {layerView:f}=this;if(f){var {layer:b,view:a}=this;b.emit("layerview-destroy",{view:a,layerView:f});a.emit("layerview-destroy",{layer:b,layerView:f});this.done=!0;this.layerViewImporter=
this.view=this.layerView=this.layer=null}};p.start=function(){var f=u._asyncToGenerator(function*(){if(!this._started){this._started=!0;var {_controller:{signal:b},layer:a,view:c}=this;this._map=c.map;try{yield a.load({signal:b});"prefetchResources"in a&&(yield a.prefetchResources({signal:b}));let d;if(a.createLayerView)d=yield a.createLayerView(c,{signal:b});else{if(!this.layerViewImporter.hasLayerViewModule(a))throw new v("layer:view-not-supported","No layerview implementation was found");var e=
yield this.layerViewImporter.importLayerView(a);n.throwIfAborted(b);d="default"in e?new e.default({layer:a,view:c}):new e({layer:a,view:c})}let q;e=()=>{q=r.removeMaybe(q);d.destroyed||d.destroy();d.layer=null;d.parent=null;d.view=null;this.done=!0};q=n.onAbort(b,e);n.throwIfAborted(b);try{yield d.when()}catch(g){throw e(),g;}this._map?.allLayers?.includes(a)?(this.layerView=d,a.emit("layerview-create",{view:c,layerView:d}),c.emit("layerview-create",{layer:a,layerView:d}),this.done=!0,this._deferred.resolve(d)):
(e(),this._deferred.reject(new v("view:no-layerview-for-layer","The layer has been removed from the map",{layer:a})))}catch(d){a.emit("layerview-create-error",{view:c,error:d}),c.emit("layerview-create-error",{layer:a,error:d}),this.done=!0,this._deferred.reject(new v("layerview:create-error","layerview creation failed",{layer:a,error:d}))}}});return function(){return f.apply(this,arguments)}}();u._createClass(t,[{key:"promise",get:function(){return this._deferred.promise}}]);return t}();h=function(t){function p(b){var a=
t.call(this,b)||this;a._layerLayerViewInfoMap=new Map;a._watchUpdatingTracking=new B.WatchUpdatingTracking;a.supportsGround=!0;a._preloadLayerViewModules=()=>{const c=a.view.map?.allLayers;if(c)for(const e of c)a.layerViewImporter.hasLayerViewModule(e)&&a.layerViewImporter.importLayerView(e)};a._reschedule=()=>{r.isNone(a._workPromise)&&(a._workPromise=n.createDeferred(),a._workPromise.promise.catch(()=>{}));a.removeHandles("reschedule");a.addHandles(z.schedule(a._doWork),"reschedule");return a._workPromise.promise};
a._doWork=()=>{var c=a.view.map;a._map!==c&&(a.clear(),a._map=c);if(r.isNone(a._workPromise))a.notifyChange("updating");else{a.removeHandles("reschedule");a.removeHandles("collection-change");var e=[],d=g=>{if(!r.isNone(g))for(const m of g)m&&(e.push(m),a._createLayerView(m),"layers"in m&&m.layers&&d(m.layers))};for(var q of a._rootCollectionNames)d(a.get(q));a._refreshCollections();for(const [g,m]of a._layerLayerViewInfoMap)e.includes(g)||(a._layerLayerViewInfoMap.delete(m.layer),m.destroy());q=
e.filter(g=>"group"===g.type).map(g=>g.layers);c=[c?.ground?.layers,c?.basemap?.baseLayers,c?.basemap?.referenceLayers,c?.layers,...q].filter(g=>!!g);a.addHandles(c.map(g=>a._watchUpdatingTracking.addOnCollectionChange(()=>g,a._reschedule)),"collection-change");a._workPromise.resolve();a._workPromise=null}};return a}u._inheritsLoose(p,t);var f=p.prototype;f.initialize=function(){this.own([w.on(()=>this.view?.map?.allLayers,"change",this._preloadLayerViewModules,{onListenerAdd:this._preloadLayerViewModules}),
w.watch(()=>{const b=this.view,a=b?.map;return[a?.basemap,a?.ground,a?.layers,b?.ready]},()=>this._reschedule(),w.syncAndInitial)]);this._preloadLayerViewModules();this._reschedule()};f.destroy=function(){this.clear();this._watchUpdatingTracking.destroy();this._map=null;r.isSome(this._workPromise)&&(this._workPromise.reject(n.createAbortError()),this._workPromise=null)};f.clear=function(){if(!this.destroyed){for(const b of this._layerLayerViewInfoMap.values())b.destroy();this._layerLayerViewInfoMap.clear();
this._refreshCollections()}};f.whenLayerView=function(){var b=u._asyncToGenerator(function*(a){yield this._reschedule();if(!this._layerLayerViewInfoMap.has(a))throw new v("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:a});return this._layerLayerViewInfoMap.get(a).promise});return function(a){return b.apply(this,arguments)}}();f._refreshCollections=function(){for(const [b,a]of this._layersToLayerViews)this._populateLayerViewsOwners(this.get(b),this.get(a),this.view);
this.notifyChange("updating");this.notifyChange("updatingRemaining")};f._populateLayerViewsOwners=function(b,a,c){if(b&&a){var e=0;for(const d of b)(b=this._layerLayerViewInfoMap.get(d))&&b.layerView&&(b=b.layerView,b.layer=d,b.parent=c,a.getItemAt(e)!==b&&a.splice(e,0,b),d.layers&&this._populateLayerViewsOwners(d.layers,b.layerViews,b),e+=1);e<a.length&&a.splice(e,a.length)}else a&&a.removeAll()};f._createLayerView=function(b){if(this._layerLayerViewInfoMap.has(b))this.view.ready&&this._layerLayerViewInfoMap.get(b).start();
else{b.load().catch(()=>{});this.layerViewImporter.hasLayerViewModule(b)&&this.layerViewImporter.importLayerView(b);var a=new C(b,this.view,this.layerViewImporter);a.promise.then(()=>this._refreshCollections(),c=>{c&&(n.isAbortError(c)||"cancelled:layerview-create"===c.name)||x.getLogger(this.declaredClass).error(`Failed to create layerview for layer title:'${b.title??"no title"}', id:'${b.id??"no id"}' of type '${b.type}'.`,{layer:b,error:c});this._refreshCollections()});this._layerLayerViewInfoMap.set(b,
a);this.view.ready&&a.start()}this.notifyChange("updating");this.notifyChange("updatingRemaining")};u._createClass(p,[{key:"_layersToLayerViews",get:function(){const b=[["view.map.basemap.baseLayers","view.basemapView.baseLayerViews"],["view.map.layers","view.layerViews"],["view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews"]];this.supportsGround&&b.push(["view.map.ground.layers","view.groundView.layerViews"]);return new Map(b)}},{key:"_rootCollectionNames",get:function(){return Array.from(this._layersToLayerViews.keys())}},
{key:"updating",get:function(){return r.isSome(this._workPromise)||this._watchUpdatingTracking.updating||y.someMap(this._layerLayerViewInfoMap,b=>!b.done)}},{key:"updatingRemaining",get:function(){let b=0;for(const a of this._layerLayerViewInfoMap.values())a.done||++b;return b}}]);return p}(h);k.__decorate([l.property()],h.prototype,"_workPromise",void 0);k.__decorate([l.property({readOnly:!0})],h.prototype,"_watchUpdatingTracking",void 0);k.__decorate([l.property({readOnly:!0})],h.prototype,"_layersToLayerViews",
null);k.__decorate([l.property({readOnly:!0})],h.prototype,"_rootCollectionNames",null);k.__decorate([l.property()],h.prototype,"layerViewImporter",void 0);k.__decorate([l.property()],h.prototype,"supportsGround",void 0);k.__decorate([l.property({readOnly:!0})],h.prototype,"updating",null);k.__decorate([l.property({readOnly:!0})],h.prototype,"updatingRemaining",null);k.__decorate([l.property({constructOnly:!0})],h.prototype,"view",void 0);return h=k.__decorate([A.subclass("esri.views.LayerViewManager")],
h)});