// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Evented ../../core/Handles ../../core/lang ../../core/maybe ../../core/promiseUtils ../../core/screenUtils ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ../../layers/GraphicsLayer ../../layers/graphics/dehydratedFeatures ../ViewingMode ../2d/interactive/SnappingVisualizer2D ../interactive/coordinateHelper ../interactive/editGeometry/EditGeometry ../interactive/editGeometry/EditGeometryOperations ../interactive/snapping/SnappingContext ../interactive/snapping/SnappingOperation".split(" "),
function(m,f,d,r,t,e,u,n,g,H,v,w,x,y,z,A,p,B,C,D){var l;d=l=function(q){function h(a){var b=q.call(this,a)||this;b._hasZ=null;b._cursorScreenPoint=null;b._activePointerId=null;b._stagedVertexUnsnapped=null;b._lastVertexUnsnapped=null;b._handles=new r;b._viewHandlesKey="view-handles";b._undoRedoHandlesKey="undo-redo-handles";b._drawToolHandlesKey="draw-tool";b._nativeEventHistory={undoStack:[],redoStack:[]};b.interactiveUndoDisabled=!1;b.history=[];b.redoHistory=[];b.snapToScene=!1;b.view=null;b.elevationInfo=
null;b.defaultZ=0;b._coordinateHelper=A.createCoordinateHelper(a.hasZ,!1,a.view.spatialReference);b._snappingManager=a.snappingManager;b._editGeometryOperations=new B.EditGeometryOperations(new p.EditGeometry(a.editGeometryType??"polygon",b._coordinateHelper));b._snappingGraphicsLayer=new w({id:l.SNAPPING_GRAPHICS_LAYER_ID,listMode:"hide",internal:!0});b._snappingContext=new C.SnappingContext({editGeometryOperations:b._editGeometryOperations,elevationInfo:{mode:"on-the-ground",offset:0},pointer:"mouse",
visualizer:new z.SnappingVisualizer2D(b._snappingGraphicsLayer)});b._activeComponent=new p.Component(a.view.spatialReference,y.ViewingMode.Local);b._editGeometryOperations.data.components.push(b._activeComponent);return b}m._inheritsLoose(h,q);var c=h.prototype;c.normalizeCtorArgs=function(a){a={...a};delete a.editGeometryType;return a};c.initialize=function(){this._snappingOperation=new D.SnappingOperation({view:this.view});"2d"===this.view.type&&this.view.map.layers.add(this._snappingGraphicsLayer)};
c.destroy=function(){this._handles.destroy();this.view.map.layers.remove(this._snappingGraphicsLayer);this._snappingGraphicsLayer.destroy();e.isSome(this._snappingManager)&&this._snappingManager.doneSnapping();this._snappingOperation=e.destroyMaybe(this._snappingOperation);this._editGeometryOperations.destroy()};c.canUndo=function(){return this._editGeometryOperations.canUndo};c.canRedo=function(){return this._editGeometryOperations.canRedo};c.undo=function(){this.canUndo&&this._editGeometryOperations.undo()};
c.redo=function(){this.canRedo&&this._editGeometryOperations.redo()};c.getCoordsFromScreenPoint=function(a){a=this.screenToMap(a);return e.isNone(a)?null:a.hasZ?[a.x,a.y,a.z]:[a.x,a.y]};c.getCoordsAndPointFromScreenPoint=function(a){a=this.screenToMap(a);return e.isNone(a)?null:a.hasZ?{vertex:[a.x,a.y,a.z],mapPoint:a}:{vertex:[a.x,a.y],mapPoint:a}};c.screenToMap=function(a){var b=null;"3d"===this.view.type?this.hasZ?(b=e.unwrapOr(this.elevationInfo,E),b=this.view.sceneIntersectionHelper.intersectElevationFromScreen(n.createScreenPointArray(a.x,
a.y),b,this._getGeometryZValue())):(b=e.unwrapOr(this.elevationInfo,F),b=this.view.sceneIntersectionHelper.intersectElevationFromScreen(n.createScreenPointArray(a.x,a.y),b,0),e.isSome(b)&&(b.z=void 0)):(b=this.view.toMap(a),e.isSome(b)&&(b.z=this.hasZ?this._getGeometryZValue():void 0));return b};c._pushCursorVertex=function(a,b){this._stagedVertexUnsnapped=a=x.makeDehydratedPoint(a[0],a[1],null,this.view.spatialReference);const k=this._snappingManager;e.isNone(k)?(this._stagedVertex=a,b()):u.ignoreAbortErrors(this._snappingOperation.snap({point:a},
k,this._snappingContext)).then(()=>{b()})};c._popCursorVertex=function(){this._stagedVertex=this._stagedVertexUnsnapped=null};c._getGeometryZValue=function(){return this.defaultZ};c._abortSnapping=function(){this._snappingOperation.abort()};c._isDuplicateOfLastVertex=function(a){const b=this._editGeometryOperations.data.components[0].getLastVertex();if(e.isSome(b)&&a[0]===b[0]&&a[1]===b[1])return!0;const {x:k,y:G}=this._coordinateHelper.vectorToDehydratedPoint(a);return e.isSome(this._lastVertexUnsnapped)&&
k===this._lastVertexUnsnapped.x&&G===this._lastVertexUnsnapped.y?!0:!1};c._shouldHandlePointerEvent=function(a){return this._isPrimaryPointerAction(a)&&(e.isNone(this._activePointerId)||this._activePointerId===a.pointerId)};c._vertexAddHandler=function(a){const b=e.isSome(this._stagedVertex)?this._coordinateHelper.pointToArray(this._stagedVertex):this.getCoordsFromScreenPoint(this._cursorScreenPoint);e.isSome(b)&&this._addVertex(b,a.native)};c._drawCompleteHandler=function(a){this._completeDrawing(a.native)};
c._isPrimaryPointerAction=function(a){return"mouse"!==a.pointerType||0===a.button};m._createClass(h,[{key:"_committedVertices",get:function(){return this._editGeometryOperations.data.components[0].vertices.map(a=>a.pos)}},{key:"vertices",get:function(){return e.isSome(this._stagedVertex)?[...this._committedVertices,this._coordinateHelper.pointToArray(this._stagedVertex)]:this._committedVertices}},{key:"hasZ",get:function(){return e.isSome(this._hasZ)?this._hasZ:"3d"===this.view.type},set:function(a){this._hasZ=
a;this.notifyChange("hasZ")}},{key:"_stagedVertex",get:function(){return this._snappingOperation.stagedPoint},set:function(a){this._snappingOperation.stagedPoint=t.clone(a)}}]);return h}(d.EventedAccessor);d.SNAPPING_GRAPHICS_LAYER_ID="DrawAction-snapping-graphics-layer";f.__decorate([g.property({readOnly:!0})],d.prototype,"vertices",null);f.__decorate([g.property({type:Boolean,nonNullable:!0})],d.prototype,"interactiveUndoDisabled",void 0);f.__decorate([g.property({readOnly:!0})],d.prototype,"history",
void 0);f.__decorate([g.property({readOnly:!0})],d.prototype,"redoHistory",void 0);f.__decorate([g.property()],d.prototype,"snapToScene",void 0);f.__decorate([g.property()],d.prototype,"view",void 0);f.__decorate([g.property()],d.prototype,"elevationInfo",void 0);f.__decorate([g.property({nonNullable:!0})],d.prototype,"defaultZ",void 0);f.__decorate([g.property()],d.prototype,"hasZ",null);f.__decorate([g.property()],d.prototype,"_snappingOperation",void 0);f.__decorate([g.property()],d.prototype,
"_stagedVertex",null);d=l=f.__decorate([v.subclass("esri.views.draw.DrawAction")],d);const E={mode:"absolute-height",offset:0},F={mode:"on-the-ground",offset:0};return d});