// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../request ../../../core/asyncUtils ../../../core/Handles ../../../core/mathUtils ../../../core/maybe ../../../core/reactiveUtils ../../../core/urlUtils ../../../chunks/mat3f32 ../engine/DisplayObject ../engine/webgl/DefaultVertexAttributeLayouts ../engine/webgl/enums ../engine/webgl/shaders/MagnifierPrograms ../../magnifier/resources ../../webgl/BufferObject ../../webgl/enums ../../webgl/Texture ../../webgl/VertexArrayObject".split(" "),function(t,
w,B,C,x,g,q,D,E,F,G,H,y,I,J,c,u,K){return function(z){function r(){var a=z.call(this)||this;a._handles=new C;a._resourcePixelRatio=1;a.visible=!1;return a}t._inheritsLoose(r,z);var m=r.prototype;m.destroy=function(){this._handles.destroy();this._handles=null;this._disposeRenderResources();this._resourcesTask&&(this._resourcesTask.abort(),this._resourcesTask=null)};m._createTransforms=function(){return{dvs:E.create()}};m.doRender=function(a){const b=a.context;if(!this._resourcesTask)this._reloadResources();
else if(a.drawPhase===H.WGLDrawPhase.MAP&&this._canRender()){this._updateResources(a);var d=this._magnifier;if(!g.isNone(d.position)){var h=a.pixelRatio,k=d.size*h,e=Math.ceil(1/d.factor*k);this._readbackTexture.resize(e,e);var {size:f}=a.state;a=h*f[0];f=h*f[1];var n=.5*e,p=.5*e,l=x.clamp(h*d.position.x,n,a-n-1),A=x.clamp(f-h*d.position.y,p,f-p-1);b.setBlendingEnabled(!0);n=l-n;p=A-p;var v=this._readbackTexture;b.bindTexture(v,0);b.gl.copyTexImage2D(v.descriptor.target,0,v.descriptor.pixelFormat,
n,p,e,e,0);e=(e=this.background?.color)?[e.a*e.r/255,e.a*e.g/255,e.a*e.b/255,e.a]:[1,1,1,1];l=-1+(l+d.offset.x*h)/a*2;h=-1+(A-d.offset.y*h)/f*2;a=k/a*2;k=k/f*2;f=this._program;b.bindVAO(this._vertexArrayObject);b.bindTexture(this._overlayTexture,6);b.bindTexture(this._maskTexture,7);b.useProgram(f);f.setUniform4fv("u_background",e);f.setUniform1i("u_readbackTexture",0);f.setUniform1i("u_overlayTexture",6);f.setUniform1i("u_maskTexture",7);f.setUniform4f("u_drawPos",l,h,a,k);f.setUniform1i("u_maskEnabled",
d.maskEnabled?1:0);f.setUniform1i("u_overlayEnabled",d.overlayEnabled?1:0);b.setStencilTestEnabled(!1);b.setColorMask(!0,!0,!0,!0);b.drawArrays(c.PrimitiveType.TRIANGLE_STRIP,0,4);b.bindVAO()}}};m._canRender=function(){return this.mask&&this.overlay&&null!=this._magnifier};m._reloadResources=function(){var a=this;this._resourcesTask&&this._resourcesTask.abort();const b=g.isSome(this._magnifier)?this._magnifier.maskUrl:null,d=g.isSome(this._magnifier)?this._magnifier.overlayUrl:null;this._resourcesTask=
B.createTask(function(){var h=t._asyncToGenerator(function*(k){const e=g.isNone(b)||g.isNone(d)?I.loadMagnifierResources(k):null,f=g.isSome(b)?w(b,{responseType:"image",signal:k}).then(l=>l.data):e.then(l=>l.mask);k=g.isSome(d)?w(d,{responseType:"image",signal:k}).then(l=>l.data):e.then(l=>l.overlay);const [n,p]=yield Promise.all([f,k]);a.mask=n;a.overlay=p;a._disposeRenderResources();a.requestRender()});return function(k){return h.apply(this,arguments)}}())};m._disposeRenderResources=function(){this._readbackTexture=
g.disposeMaybe(this._readbackTexture);this._overlayTexture=g.disposeMaybe(this._overlayTexture);this._maskTexture=g.disposeMaybe(this._maskTexture);this._vertexArrayObject=g.disposeMaybe(this._vertexArrayObject);this._program=g.disposeMaybe(this._program)};m._updateResources=function(a){a.pixelRatio!==this._resourcePixelRatio&&this._disposeRenderResources();if(!this._readbackTexture){var b=a.context;this._resourcePixelRatio=a.pixelRatio;var d=Math.ceil(this._magnifier.size*a.pixelRatio);this._program=
y.createMagnifierProgram(b);var h=new Uint16Array([0,1,0,0,1,1,1,0]);this._vertexArrayObject=new K.VertexArrayObject(b,y.magnifierProgramTemplate.attributes,G.Pos2us,{geometry:J.BufferObject.createVertex(b,c.Usage.STATIC_DRAW,h)});this.overlay.width=d;this.overlay.height=d;this._overlayTexture=new u.Texture(b,{target:c.TextureType.TEXTURE_2D,pixelFormat:c.PixelFormat.RGBA,internalFormat:c.PixelFormat.RGBA,dataType:c.PixelType.UNSIGNED_BYTE,wrapMode:c.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:c.TextureSamplingMode.NEAREST,
flipped:!0,preMultiplyAlpha:D.isSVG(this.overlay.src)&&a.context.driverTest.svgAlwaysPremultipliesAlpha?!1:!0},this.overlay);this.mask.width=d;this.mask.height=d;this._maskTexture=new u.Texture(b,{target:c.TextureType.TEXTURE_2D,pixelFormat:c.PixelFormat.ALPHA,internalFormat:c.PixelFormat.ALPHA,dataType:c.PixelType.UNSIGNED_BYTE,wrapMode:c.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:c.TextureSamplingMode.NEAREST,flipped:!0},this.mask);a=1/this._magnifier.factor;this._readbackTexture=new u.Texture(b,
{target:c.TextureType.TEXTURE_2D,pixelFormat:c.PixelFormat.RGBA,internalFormat:c.PixelFormat.RGBA,dataType:c.PixelType.UNSIGNED_BYTE,wrapMode:c.TextureWrapMode.CLAMP_TO_EDGE,samplingMode:c.TextureSamplingMode.LINEAR,flipped:!1,width:Math.ceil(a*d),height:Math.ceil(a*d)})}};t._createClass(r,[{key:"background",get:function(){return this._background},set:function(a){this._background=a;this.requestRender()}},{key:"magnifier",get:function(){return this._magnifier},set:function(a){this._magnifier=a;this._handles.removeAll();
this._handles.add([q.watch(()=>a.version,()=>{this.visible=a.visible&&g.isSome(a.position)&&0<a.size;this.requestRender()},q.initial),q.watch(()=>[a.maskUrl,a.overlayUrl],()=>this._reloadResources()),q.watch(()=>a.size,()=>{this._disposeRenderResources();this.requestRender()})])}}]);return r}(F.DisplayObject)});