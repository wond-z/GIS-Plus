// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/has ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/RandomLCG ./BaseFeatureSource ../support/FeatureSetReaderPBFIndirect ../support/UpdateToken".split(" "),function(y,q,z,A,p,w,B,C,D,v){function E(m,k,l){var c=m.getXHydrated();m=m.getYHydrated();c=k.getColumnForX(c);c=Math.floor(k.normalizeCol(c));k=Math.floor(k.getRowForY(m));return`${l}/${k}/${c}`}function x(m,
k){if(p.isNone(m))return null;k=k.transform;const l=m.getQuantizationTransform();if(p.isNone(l)){const [n,r]=k.scale,[t,u]=k.translate;return m.transform(-t/n,u/r,1/n,1/-r)}const [c,a]=l.scale,[b,d]=l.translate,[e,g]=k.scale,[f,h]=k.translate;return m.transform((b-f)/e,(-d+h)/g,c/e,a/g)}z=function(m){function k(c){var a=m.call(this,c)||this;a.mode="snapshot";a._loading=!0;a._controller=new AbortController;a._downloadPromise=null;a._didSendEnd=!1;a._queries=[];a._invalidated=!1;a._hasAggregates=!1;
a._random=new B(1E3);a._store=c.store;a._markedIdsBufId=a._store.storage.createBitset();return a}q._inheritsLoose(k,m);var l=k.prototype;l.destroy=function(){m.prototype.destroy.call(this);this._controller.abort()};l.update=function(c,a){m.prototype.update.call(this,c,a);null==this._featureCount&&(this._featureCount=a.initialFeatureCount);p.isSome(a.changedFeatureCount)&&(this._featureCount=a.changedFeatureCount);this._hasAggregates=c.targets.aggregate};l.resend=function(){var c=q._asyncToGenerator(function*(a=
!1){yield this._downloadPromise;this._invalidated||a?(a=p.unwrapOrThrow(this._featureCount,"Expected featureCount to be defined"),this._invalidated=!1,this._subscriptions.forEach(b=>b.clear()),this._downloadPromise=this._download(a),yield this._downloadPromise):(a=this._queries.map(({query:b,reader:d})=>this._sendPatchQuery(b,d)),yield Promise.all(a),this._subscriptions.forEach(b=>{b.requests.done.forEach(d=>this._onMessage(d.message))}))});return function(){return c.apply(this,arguments)}}();l.refresh=
function(){var c=q._asyncToGenerator(function*(a,b){b&&(this._featureCount=b.featureCount);yield this.resend(!0)});return function(a,b){return c.apply(this,arguments)}}();l._sendPatchQuery=function(){var c=q._asyncToGenerator(function*(a,b){const d=p.isSome(a.outFields)?a.outFields:[],e=this._queryInfo.outFields,g=e.filter(n=>!d.includes(n));if(g.length){var f=a.clone(),h=this._signal;f.returnGeometry=!1;f.returnCentroid=!1;f.outFields=g;a.outFields=e;a=yield this._queue.push({query:f,depth:0,signal:h});
w.throwIfAborted({signal:h});b.joinAttributes(a)}});return function(a,b){return c.apply(this,arguments)}}();l._fetchDataTile=function(){var c=q._asyncToGenerator(function*(a){if(!this._downloadPromise){var b=p.unwrapOrThrow(this._featureCount,"Expected featureCount to be defined");this._downloadPromise=this._download(b)}var d=this._store.search(a);b=this._subscriptions.get(a.key.id);const e=d.length-1;for(let f=0;f<e;f++){var g=x(d[f],a);g={type:"append",id:a.id,addOrUpdate:g,end:!1,status:v.UpdateToken.empty()};
b.add({query:null,message:g});this._hasAggregates||(yield w.after(1));this._onMessage(g)}d=x(0<=e?d[e]:null,a);a={type:"append",id:a.id,addOrUpdate:d,end:this._didSendEnd,status:v.UpdateToken.empty()};b.add({query:null,message:a});this._onMessage(a)});return function(a){return c.apply(this,arguments)}}();l._download=function(){var c=q._asyncToGenerator(function*(a){try{yield this.whenInitialized();const b=this._store.storage.getBitset(this._markedIdsBufId),d=new Set;b.clear();const e=Array.from({length:Math.ceil(a/
this.pageSize)},(g,f)=>f).sort((g,f)=>this._random.getInt()-this._random.getInt()).map(g=>this._downloadPage(g,b,d));yield Promise.all(e);this._store.sweepFeatures(b,this._store.storage);this._store.sweepFeatureSets(d)}catch(b){A.getLogger("esri.views.2d.layers.features.sources.SnapshotFeatureSource").error("mapview-snapshot-source","Encountered and error when downloading feature snapshot",b)}this._sendEnd();this._loading=!1});return function(a){return c.apply(this,arguments)}}();l._downloadPage=
function(){var c=q._asyncToGenerator(function*(a,b,d){var e=this.pageSize;e={start:a*e,num:e,cacheHint:!0};p.isSome(this.maxRecordCountFactor)&&(e.maxRecordCountFactor=this.maxRecordCountFactor);e=this.createQuery(e);const g=this._signal;a=yield this._queue.push({query:e,depth:a,signal:g});w.throwIfAborted({signal:g});this._queries.push({query:e,reader:a});this._store.insert(a);d.add(a.instance);for(d=a.getCursor();d.next();)b.set(d.getDisplayId());this._send(a)});return function(a,b,d){return c.apply(this,
arguments)}}();l._send=function(c){if(this._subscriptions.size){var a=null,b=new Map,d=new Set,e=new Map;this._subscriptions.forEach(f=>{var h=f.tile;b.set(h.key.id,null);a=h.tileInfoView;d.add(h.level);const {row:n,col:r}=h.key;h=`${h.level}/${n}/${r}`;const t=e.get(h)??[];t.push(f);e.set(h,t)});for(const f of d){const h=a.getLODInfoAt(f),n=c.getCursor();for(;n.next();){var g=E(n,h,f);const r=n.getIndex();if(e.has(g))for(const t of e.get(g)){g=t.tile.id;let u=b.get(g);p.isNone(u)&&(u=[],b.set(g,
u));u.push(r)}}}b.forEach((f,h)=>{if(p.isSome(f)){const n=this._subscriptions.get(h);f=x(D.FeatureSetReaderIndirect.from(c,f),n.tile);h={type:"append",id:h,addOrUpdate:f,end:!1,status:v.UpdateToken.empty()};n.add({query:null,message:h});this._onMessage(h)}})}};l._sendEnd=function(){this._subscriptions.forEach(c=>{const a={type:"append",id:c.tile.id,addOrUpdate:null,end:!0,status:v.UpdateToken.empty()};c.add({query:null,message:a});this._onMessage(a)});this._didSendEnd=!0};q._createClass(k,[{key:"loading",
get:function(){return this._loading}},{key:"_signal",get:function(){return this._controller.signal}}]);return k}(C.BaseFeatureSource);y.SnapshotFeatureSource=z;Object.defineProperties(y,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});