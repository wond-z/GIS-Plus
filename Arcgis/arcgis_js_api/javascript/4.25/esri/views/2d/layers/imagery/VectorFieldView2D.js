// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../Graphic ../../../../request ../../../../core/HandleOwner ../../../../core/maybe ../../../../core/reactiveUtils ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/Extent ../../../../layers/support/rasterFunctions/rasterProjectionHelper ../../../../layers/support/rasterFunctions/vectorFieldUtils ../../engine/imagery/RasterVFContainer ./ImageryVFStrategy".split(" "),
function(m,g,x,y,c,n,r,l,G,H,z,A,B,t,C,D){c=function(u){function p(){var a=u.apply(this,arguments)||this;a.attached=!1;a.container=new C.RasterVFContainer;a.type="imageryVF";a._dataParameters={exportParametersVersion:0,bbox:"",symbolTileSize:0,time:""};a._fetchpixels=function(){var e=m._asyncToGenerator(function*(d,b,v,h){const q=yield a._projectFullExtentPromise,{symbolTileSize:w}=a.layer.renderer,{extent:k,width:E,height:F}=t.snapImageToSymbolTile(d,b,v,w,q);if(n.isSome(q)&&!q.intersects(d))return{extent:k,
pixelBlock:null};d={bbox:`${k.xmin}, ${k.ymin}, ${k.xmax}, ${k.ymax}`,exportParametersVersion:a.layer.exportImageServiceParameters.version,symbolTileSize:w,time:JSON.stringify(a.timeExtent||"")};if(a._canReuseVectorFieldData(d)&&(b=a.getPixelData(),n.isSome(b)&&`${b.extent.xmin}, ${b.extent.ymin}, ${b.extent.xmax}, ${b.extent.ymax}`===d.bbox))return b;({pixelData:h}=yield a.layer.fetchImage(k,E,F,{timeExtent:a.timeExtent,requestAsImageElement:!1,signal:h}));a._dataParameters=d;if(n.isNone(h.pixelBlock))return{extent:k,
pixelBlock:null};h="vector-uv"===a.layer.rasterInfo.dataType?n.unwrap(t.convertVectorFieldData(h.pixelBlock,"vector-uv")):h.pixelBlock;return{extent:k,pixelBlock:h}});return function(d,b,v,h){return e.apply(this,arguments)}}();return a}m._inheritsLoose(p,u);var f=p.prototype;f.attach=function(){this._projectFullExtentPromise=this._getProjectedFullExtent(this.view.spatialReference);this._strategy=new D({container:this.container,fetchPixels:this._fetchpixels});this.handles.add(r.watch(()=>this.layer.renderer,
a=>this._updateSymbolizerParams(a),r.syncAndInitial),"vector-field-view-update")};f.detach=function(){this._strategy.destroy();this.container.children.forEach(a=>a.destroy());this.container.removeAllChildren();this.handles.remove("vector-field-view-update");this._strategy=this.container=this._projectFullExtentPromise=null};f.getPixelData=function(){if(this.updating||!this.container.children.length)return null;const {extent:a,pixelBlock:e}=this.container.children[0].rawPixelData;return{extent:a,pixelBlock:e}};
f.hitTest=function(a){return new x({attributes:{},geometry:a.clone(),layer:this.layer})};f.update=function(a){this._strategy.update(a,this._symbolizerParams)};f.redraw=function(){this._updateSymbolizerParams(this.layer.renderer);this._strategy.redraw(this._symbolizerParams)};f._canReuseVectorFieldData=function(a){const e=this._dataParameters.time===a.time,d=this._dataParameters.symbolTileSize===a.symbolTileSize,b=this._dataParameters.bbox===a.bbox;return this._dataParameters.exportParametersVersion===
a.exportParametersVersion&&e&&d&&b};f._getProjectedFullExtent=function(){var a=m._asyncToGenerator(function*(e){try{return yield B.projectExtent(this.layer.fullExtent,e)}catch(d){try{const b=(yield y(this.layer.url,{query:{option:"footprints",outSR:e.wkid||JSON.stringify(e.toJSON()),f:"json"}})).data.featureCollection.layers[0].layerDefinition.extent;return b?A.fromJSON(b):null}catch{return null}}});return function(e){return a.apply(this,arguments)}}();f._updateSymbolizerParams=function(a){"vector-field"===
a.type&&(this._symbolizerParams=this.layer.symbolizer.generateWebGLParameters({pixelBlock:null}))};m._createClass(p,[{key:"updating",get:function(){return!this.attached||this._strategy.updating}}]);return p}(c.HandleOwner);g.__decorate([l.property()],c.prototype,"attached",void 0);g.__decorate([l.property()],c.prototype,"container",void 0);g.__decorate([l.property()],c.prototype,"layer",void 0);g.__decorate([l.property()],c.prototype,"timeExtent",void 0);g.__decorate([l.property()],c.prototype,"type",
void 0);g.__decorate([l.property()],c.prototype,"view",void 0);g.__decorate([l.property()],c.prototype,"updating",null);return c=g.__decorate([z.subclass("esri.views.2d.layers.imagery.VectorFieldView2D")],c)});