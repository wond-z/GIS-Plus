// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../geometry ../../../../../core/Evented ../../../../../core/has ../../../../../core/maybe ../../../../../core/accessorSupport/diffUtils ../../../../../geohash/GeohashTree ../../../../../geohash/geohashUtils ../../../../../geometry/support/aaBoundingBox ../../../../../geometry/support/Ellipsoid ../../../../../geometry/support/spatialReferenceUtils ../../../../../layers/graphics/featureConversionUtils ../../../../../layers/graphics/OptimizedFeature ../../../../../layers/graphics/OptimizedGeometry ../../../../../layers/graphics/data/projectionSupport ../../../engine/webgl/definitions ../../../engine/webgl/DisplayId ../FeatureStore2D ../Store2D ./FeatureSetReaderJSON ../../../../../geometry/SpatialReference ../../../../../geometry/Polygon ../../../../../geometry/Extent".split(" "),
function(E,z,I,R,J,t,K,S,A,T,w,U,C,L,M,F,q,N,V,W,O,G,X,Y){let P=function(x){function r(a,b,c,d,e){b=new M([],[b,c]);a=x.call(this,b,d,null,a)||this;a.geohashBoundsInfo=e;return a}z._inheritsLoose(r,x);r.create=function(a,b,c,d,e,f,h,k){b=new r(b,c,d,f,h);b.displayId=a.createDisplayId(!0);b.referenceId=k;b.tileLevel=e;return b};var g=r.prototype;g.update=function(a,b,c,d,e,f){this.geometry.coords[0]=a;this.geometry.coords[1]=b;this.tileLevel=c;this.attributes=d;this.geohashBoundsInfo=e;this.referenceId=
null;this.referenceId=f;return this};g.toJSON=function(){return{attributes:{...this.attributes,aggregateId:this.objectId,referenceId:1===this.attributes.cluster_count?this.referenceId:null},geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}};z._createClass(r,[{key:"count",get:function(){return this.attributes.cluster_count}}]);return r}(L.OptimizedFeatureWithGeometry);I=function(x){function r(a,b,c,d){var e=x.call(this,a,c)||this;e.type="cluster";e.events=new R;e.objectIdField="aggregateId";
e.featureAdapter=V.featureAdapter;e._geohashLevel=0;e._tileLevel=0;e._aggregateValueRanges={};e._aggregateValueRangesChanged=!1;e._geohashBuf=[];e._clusters=new Map;e._tiles=new Map;e._serviceInfo=d;e.geometryInfo=a.geometryInfo;e._spatialReference=b;e._projectionSupportCheck=F.checkProjectionSupport(b,G.WGS84);e._bitsets.geohash=c.getBitset(c.createBitset());e._bitsets.inserted=c.getBitset(c.createBitset());return e}z._inheritsLoose(r,x);var g=r.prototype;g.destroy=function(){this._tree.destroy()};
g.updateSchema=function(){var a=z._asyncToGenerator(function*(b,c){const d=this._schema;try{yield x.prototype.updateSchema.call(this,b,c),yield this._projectionSupportCheck}catch(f){}this._fields=this._schema.params.fields;const e=K.diff(d,c);if(!c||t.isNone(e)&&!b.source&&!b.storage.filters)d&&(b.mesh=!0);else{if(K.hasDiff(e,"params.fields")||!this._tree||b.source)this._tree&&this._tree.destroy(),this._tree=new S.GeohashTree(this._statisticFields,this._serviceInfo),this._rebuildTree(),J("esri-2d-update-debug")&&
console.debug("Aggregate mesh needs update due to tree changing");J("esri-2d-update-debug")&&console.debug("Applying Update - ClusterStore:",e);b.targets[c.name]=!0;b.mesh=!1;this._aggregateValueRanges={}}});return function(b,c){return a.apply(this,arguments)}}();g.clear=function(){this._rebuildTree()};g.sweepFeatures=function(a,b){this._bitsets.inserted.forEachSet(c=>{a.has(c)||(c=b.lookupByDisplayIdUnsafe(c),this._remove(c))})};g.sweepAggregates=function(a,b,c){this._clusters.forEach((d,e)=>{d&&
d.tileLevel!==c&&(a.releaseDisplayId(d.displayId),b.unsetAttributeData(d.displayId),this._clusters.delete(e))})};g.onTileData=function(a,b,c,d,e=!0){if(!this._schema||t.isNone(b.addOrUpdate))return b;this.events.emit("changed");var f=this._getTransforms(a,this._spatialReference);const h=b.addOrUpdate.getCursor();for(;h.next();)this._update(h,d);if(b.status.mesh||!e)return b;d=[];this._getClustersForTile(d,a,this._schema.params.clusterRadius,c,f);b.addOrUpdate=O.FeatureSetReaderJSON.fromOptimizedFeatures(d,
this._serviceInfo);b.addOrUpdate.attachStorage(c);b.clear=!0;b.end=!0;for(f=b.addOrUpdate.getCursor();f.next();)d=f.getDisplayId(),this._bitsets.computed.unset(d),this.setComputedAttributes(c,f,d,a.scale);this._aggregateValueRangesChanged&&b.end&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1);return b};g.onTileUpdate=function({added:a,removed:b}){a.length&&(this._tileLevel=a=a[0].level,this._setGeohashLevel(a));if(this._schema){var c=
this._schema.params.clusterRadius;b.forEach(d=>{this._tiles.delete(d.key.id);this._markTileClustersForDeletion(d,c)})}};g.getAggregate=function(a){for(const b of this._clusters.values())if((b?.displayId&N.DISPLAY_ID_TEXEL_MASK)===(a&N.DISPLAY_ID_TEXEL_MASK))return b.toJSON();return null};g.getAggregates=function(){const a=[];for(const b of this._clusters.values())b?.tileLevel===this._tileLevel&&a.push(b.toJSON());return a};g.getDisplayId=function(a){return(a=this._clusters.get(a))?a.displayId:null};
g.getFeatureDisplayIdsForAggregate=function(a){return(a=this._clusters.get(a))?this._tree.getRegionDisplayIds(a.geohashBoundsInfo):[]};g.getDisplayIdForReferenceId=function(a){for(const b of this._clusters.values())if(b?.referenceId===a)return b.displayId;return null};g.getAggregateValueRanges=function(){return this._aggregateValueRanges};g.forEach=function(a){this._clusters.forEach(b=>{b&&(b=b.toJSON(),b=O.FeatureSetReaderJSON.fromFeatures([b],{objectIdField:this.objectIdField,globalIdField:null,
geometryType:this.geometryInfo.geometryType,fields:this.fields}).getCursor(),b.next(),a(b))})};g.forEachInBounds=function(a,b){};g.forEachBounds=function(a,b,c){const {hasM:d,hasZ:e}=this.geometryInfo;for(const f of a)a=C.getBoundsOptimizedGeometry([0,0,0,0],f.readGeometry(),e,d),t.isNone(a)||b(T.fromRect(c,a))};g.toArray=function(){const a=[];this.forEach(b=>a.push(b));return a};g.size=function(){let a=0;this.forEach(b=>a++);return a};g._rebuildTree=function(){this._bitsets.computed.clear();this._bitsets.inserted.clear();
this._tree&&this._tree.clear()};g._remove=function(a){const b=a.getDisplayId(),c=a.getXHydrated(),d=a.getYHydrated(),e=this._geohashBuf[2*b],f=this._geohashBuf[2*b+1];this._bitsets.inserted.has(b)&&(this._bitsets.inserted.unset(b),this._tree.removeCursor(a,c,d,e,f,this._geohashLevel))};g._update=function(a,b){const c=a.getDisplayId(),d=this._bitsets.inserted;b=b.isVisible(c);var e=d.has(c);b!==e&&(b?(b=a.getXHydrated(),e=a.getYHydrated(),this._setGeohash(c,b,e)&&(this._tree.insertCursor(a,c,b,e,this._geohashBuf[2*
c],this._geohashBuf[2*c+1],this._geohashLevel),d.set(c))):this._remove(a))};g._setGeohash=function(a,b,c){if(this._bitsets.geohash.has(a))return!0;const d=this._geohashBuf;if(this._spatialReference.isWebMercator)b=b/w.earth.radius*57.29577951308232,A.setGeohashBuf(d,a,57.29577951308232*(Math.PI/2-2*Math.atan(Math.exp(-c/w.earth.radius))),b-360*Math.floor((b+180)/360),12);else{c=F.project({x:b,y:c},this._spatialReference,G.WGS84);if(!c)return!1;A.setGeohashBuf(d,a,c.y,c.x,12)}this._bitsets.geohash.set(a);
return!0};g._getClustersForTile=function(a,b,c,d,e,f=!0){var h=2*c;c=Math.ceil(2**b.key.level*q.TILE_SIZE/h)+1;var k=Math.ceil(this._schema.params.clusterPixelBuffer/h)+0,l=Math.ceil(q.TILE_SIZE/h);const {row:m,col:y}=b.key;var n=Math.floor(y*q.TILE_SIZE/h)-k;h=Math.floor(m*q.TILE_SIZE/h)-k;const D=n+l+2*k;k=h+l+2*k;for(l=b.tileInfoView.getLODInfoAt(b.key.level);n<=D;n++)for(let B=h;B<=k;B++){var p=n;l.wrap&&(p=0>n?n+c:n%c);const H=l.wrap&&0>n,Z=l.wrap&&n%c!==n;p=this._lookupCluster(d,l,b.key.level,
p,B,b);if(t.isSome(p)){var v=t.applySome(e,u=>H?u.left:Z?u.right:u.tile);if((!f||!t.isNone(v))&&p.count&&t.isSome(v)&&f){const u=p.geometry.clone();let Q=p.attributes;u.coords[0]=C.quantizeX(v,u.coords[0]);u.coords[1]=C.quantizeY(v,u.coords[1]);1===p.count&&t.isSome(p.referenceId)&&(Q={...p.attributes,referenceId:p.referenceId});v=new L.OptimizedFeature(u,Q);v.displayId=p.displayId;a.push(v)}}}};g._getGeohashLevel=function(a){return Math.min(Math.ceil(a/2+2),12)};g._setGeohashLevel=function(a){a=
this._getGeohashLevel(a);a=1*(Math.floor(a/1)+1)-1;this._geohashLevel!==a&&(this._geohashLevel=a,this._rebuildTree(),this._bitsets.geohash.clear())};g._getTransforms=function(a,b){const c={originPosition:"upperLeft",scale:[a.resolution,a.resolution],translate:[a.bounds[0],a.bounds[3]]};b=U.getInfo(b);if(!b)return{tile:c,left:null,right:null};const [d,e]=b.valid;return{tile:c,left:{...c,translate:[e,a.bounds[3]]},right:{...c,translate:[d-e+a.bounds[0],a.bounds[3]]}}};g._getClusterId=function(a,b,c){return(a&
15)<<28|(b&16383)<<14|c&16383};g._markForDeletion=function(a,b,c){a=this._getClusterId(a,b,c);this._clusters.delete(a)};g._getClusterBounds=function(a,b,c){var d=this._schema.params.clusterRadius,e=2*d;b=c%2?b*e:b*e-d;const f=c*e;d=b+e;c=2**a.level*q.TILE_SIZE;a.wrap&&0>b&&(b=0);a.wrap&&d>c&&(d=c);c=f/q.TILE_SIZE;d/=q.TILE_SIZE;e=(f-e)/q.TILE_SIZE;b=a.getXForColumn(b/q.TILE_SIZE);c=a.getYForRow(c);d=a.getXForColumn(d);a=a.getYForRow(e);return[b,c,d,a]};g._getGeohash=function(a,b,c){const d={geohashX:0,
geohashY:0};A.setGeohashXY(d,b,a,c);return d};g._getGeohashBounds=function(a,b){const c=this._getGeohashLevel(a.key.level);if(this._spatialReference.isWebMercator){const [l,m,y,n]=b;var d=m,e=y,f=n,h=a=b=0,k=0;b=l/w.earth.radius*57.29577951308232;b-=360*Math.floor((b+180)/360);a=57.29577951308232*(Math.PI/2-2*Math.atan(Math.exp(-d/w.earth.radius)));h=e/w.earth.radius*57.29577951308232;h-=360*Math.floor((h+180)/360);k=57.29577951308232*(Math.PI/2-2*Math.atan(Math.exp(-f/w.earth.radius)));f={geohashX:0,
geohashY:0};d={geohashX:0,geohashY:0};A.setGeohashXY(f,a,b,c);A.setGeohashXY(d,k,h,c);return{bounds:[l,m,y,n],geohashBounds:{xLL:f.geohashX,yLL:f.geohashY,xTR:d.geohashX,yTR:d.geohashY},level:c}}f=X.fromExtent(Y.fromBounds(b,this._spatialReference));a=F.project(f,this._spatialReference,G.WGS84,{densificationStep:64*a.resolution});if(!a)return null;a=C.convertFromPolygon(new M,a,!1,!1);h=a.coords.filter((l,m)=>!(m%2));k=a.coords.filter((l,m)=>m%2);a=Math.min(...h);f=Math.min(...k);h=Math.max(...h);
k=Math.max(...k);a=this._getGeohash(a,f,c);f=this._getGeohash(h,k,c);return{bounds:b,geohashBounds:{xLL:a.geohashX,yLL:a.geohashY,xTR:f.geohashX,yTR:f.geohashY},level:c}};g._lookupCluster=function(a,b,c,d,e,f){const h=this._getClusterId(c,d,e),k=this._clusters.get(h);b=this._getClusterBounds(b,d,e);f=this._getGeohashBounds(f,b);if(t.isNone(f))return null;var l=this._tree.getRegionStatistics(f);const {count:m,xTotal:y,yTotal:n,referenceId:D}=l;d=m?y/m:0;e=m?n/m:0;if(0===m)return this._clusters.set(h,
null),null;l={cluster_count:m,...l.attributes};a=t.isSome(k)?k.update(d,e,c,l,f,D):P.create(a,h,d,e,c,l,f,D);if(0===m){const [p,v,B,H]=b;a.geometry.coords[0]=(p+B)/2;a.geometry.coords[1]=(v+H)/2}this._clusters.set(h,a);this._updateAggregateValueRangeForCluster(a,a.tileLevel);return a};g._updateAggregateValueRangeForCluster=function(a,b){const c=this._aggregateValueRanges[b]||{minValue:Infinity,maxValue:0},d=c.minValue,e=c.maxValue;c.minValue=Math.min(d,a.count);c.maxValue=Math.max(e,a.count);this._aggregateValueRanges[b]=
c;if(d!==c.minValue||e!==c.maxValue)this._aggregateValueRangesChanged=!0};g._markTileClustersForDeletion=function(a,b){var c=2*b;b=Math.ceil(q.TILE_SIZE/c);const {row:d,col:e}=a.key,f=Math.floor(e*q.TILE_SIZE/c);c=Math.floor(d*q.TILE_SIZE/c);for(let h=f;h<f+b;h++)for(let k=c;k<c+b;k++)this._markForDeletion(a.key.level,h,k)};z._createClass(r,[{key:"featureSpatialReference",get:function(){return this._spatialReference}},{key:"fields",get:function(){return this._fields}}]);return r}(W.Store2D);E.ClusterInfo=
P;E.ClusterStore=I;Object.defineProperties(E,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});