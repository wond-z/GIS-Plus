// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/has ../../../../../core/maybe ../../../../../core/reactiveUtils ../../../../../chunks/rbush ../../../../../layers/graphics/featureConversionUtils ../../../../../layers/graphics/OptimizedGeometry ../../../../../layers/graphics/data/StreamFeatureManager ../../../../../layers/graphics/sources/connections/createConnection ./DataTileSource ../support/FeatureSetReaderJSON ../support/UpdateToken".split(" "),function(v,m,
w,n,x,A,q,y,B,C,D,E,F){function G(e,d){const c=e.weakClone();if(n.isSome(e.geometry)){const b=q.quantizeX(d,e.geometry.coords[0]);e=q.quantizeY(d,e.geometry.coords[1]);c.geometry=new y([],[b,e])}return c}function H(e){switch(e){case "esriGeometryPoint":return G;default:return(d,c)=>{const b=d.weakClone(),a=new y;d=q.quantizeOptimizedGeometry(a,d.geometry,!1,!1,e,c,!1,!1);b.geometry=d;return b}}}function I(e){switch(e){case "esriGeometryPoint":return d=>n.isSome(d.geometry)?{minX:d.geometry.coords[0],
minY:d.geometry.coords[1],maxX:d.geometry.coords[0],maxY:d.geometry.coords[1]}:{minX:Infinity,minY:Infinity,maxX:-Infinity,maxY:-Infinity};default:return d=>{let c=Infinity,b=Infinity,a=-Infinity,f=-Infinity;n.isSome(d.geometry)&&d.geometry.forEachVertex((k,g)=>{c=Math.min(c,k);b=Math.min(b,g);a=Math.max(a,k);f=Math.max(f,g)});return{minX:c,minY:b,maxX:a,maxY:f}}}}let J=function(){function e(c,b){this.onUpdate=c;this._geometryType=b;this._objectIdToFeature=new Map}var d=e.prototype;d.add=function(c){this._objectIdToFeature.set(c.objectId,
c);this._index=null};d.get=function(c){return this._objectIdToFeature.has(c)?this._objectIdToFeature.get(c):null};d.forEach=function(c){this._objectIdToFeature.forEach(c)};d.search=function(c){if(!this._index){var b=this._features;const a=A.rbush(9,I(this._geometryType));a.load(b);this._index=a}return this._index.search({minX:c.bounds[0],minY:c.bounds[1],maxX:c.bounds[2],maxY:c.bounds[3]})};d.removeById=function(c){const b=this._objectIdToFeature.get(c);return b?(this._objectIdToFeature.delete(c),
this._index=null,b):null};d.update=function(c,b){this.onUpdate(c,b)};m._createClass(e,[{key:"_features",get:function(){const c=[];this._objectIdToFeature.forEach(b=>c.push(b));return c}},{key:"size",get:function(){return this._objectIdToFeature.size}}]);return e}();w=function(e){function d(b){var a=e.call(this,b)||this;a.type="geoevent";a._dataReceiveEventEnabled=!1;a._level=0;a._updateInfo={websocket:0,client:0};a._inUpdate=!1;const {outSR:f}=b,{geometryType:k,objectIdField:g,timeInfo:h,purgeOptions:t,
source:K,spatialReference:L,serviceFilter:M,maxReconnectionAttempts:N,maxReconnectionInterval:O,updateInterval:P,enableDataReceived:Q,customParameters:R}=b.serviceInfo,z=new J(a._onUpdate.bind(m._assertThisInitialized(a)),k),S=new B.StreamFeatureManager(z,g,h,t),u=C.createConnection(K,L,f,k,M,N,O,R);a._store=z;a._manager=S;a._connection=u;a._quantize=H(k);a._dataReceiveEventEnabled=Q;a._handles=[a._connection.on("data-received",l=>a._onFeature(l)),x.watch(()=>u.connectionStatus,l=>a.events.emit("connectionStatus",
l)),x.watch(()=>u.errorString,l=>a.events.emit("errorString",l))];a._initUpdateInterval=()=>{let l=performance.now();a._updateIntervalId=setInterval(()=>{var r=performance.now(),p=r-l;2500<p&&(l=r,r=Math.round(a._updateInfo.client/(p/1E3)),p=Math.round(a._updateInfo.websocket/(p/1E3)),a._updateInfo.client=0,a._updateInfo.websocket=0,a.events.emit("updateRate",{client:r,websocket:p}));b.canAcceptRequest()&&!a._inUpdate&&a._manager.checkForUpdates()},P)};a._initUpdateInterval();return a}m._inheritsLoose(d,
e);var c=d.prototype;c.destroy=function(){e.prototype.destroy.call(this);this._clearUpdateInterval();this._handles.forEach(b=>b.remove());this._connection.destroy()};c._fetchDataTile=function(){};c.pauseStream=function(){this._clearUpdateInterval()};c.resumeStream=function(){this._initUpdateInterval()};c.enableEvent=function(b,a){"data-received"===b&&(this._dataReceiveEventEnabled=a)};c.subscribe=function(b,a){e.prototype.subscribe.call(this,b,a);a=this._subscriptions.get(b.id);this._level=b.level;
const f=this._getTileFeatures(b);this._onMessage({type:"append",id:b.key.id,addOrUpdate:f,end:!0});a.didSend=!0};c.unsubscribe=function(b){e.prototype.unsubscribe.call(this,b)};c.readers=function*(b){b=this._subscriptions.get(b);const {tile:a}=b;yield this._getTileFeatures(a);for(const f of b.requests.stream.entries)n.isSome(f)&&n.isSome(f.addOrUpdate)&&(yield f.addOrUpdate)};c.createTileQuery=function(b){throw Error("Service does not support tile  queries");};c.resend=function(){var b=m._asyncToGenerator(function*(){this._subscriptions.forEach(a=>
{({tile:a}=a);a={type:"append",id:a.id,addOrUpdate:this._getTileFeatures(a),end:!0};this._onMessage(a)})});return function(){return b.apply(this,arguments)}}();c._getTileFeatures=function(b){const a=this._store.search(b).map(f=>this._quantize(f,b.transform));return E.FeatureSetReaderJSON.fromOptimizedFeatures(a,this._serviceInfo,b.transform)};c._onFeature=function(b){this._updateInfo.websocket++;try{this._dataReceiveEventEnabled&&this.events.emit("data-received",b);const a=q.convertFromFeature(b,
this._serviceInfo.geometryType,!1,!1,this._serviceInfo.objectIdField);this._manager.add(a)}catch(a){}};c._clearUpdateInterval=function(){clearInterval(this._updateIntervalId);this._updateIntervalId=0};c._onUpdate=function(){var b=m._asyncToGenerator(function*(a,f){this._inUpdate=!0;try{n.isSome(a)&&(this._updateInfo.client+=a.length);this._subscriptions.forEach((g,h)=>{g.didSend&&g.tile.level===this._level&&this._onMessage({type:"append",id:h,addOrUpdate:null,clear:!0,end:!1})});const k=[];this._subscriptions.forEach((g,
h)=>{if(g.didSend&&g.tile.level===this._level){var t=this._getTileFeatures(g.tile);h={type:"append",id:h,addOrUpdate:t,remove:[],end:!1,status:F.UpdateToken.empty()};g.requests.stream.enqueue(h);k.push(this._onMessage(h))}});yield Promise.all(k);this._subscriptions.forEach((g,h)=>{g.didSend&&g.tile.level===this._level&&this._onMessage({type:"append",id:h,addOrUpdate:null,end:!0})})}catch{}this._inUpdate=!1});return function(a,f){return b.apply(this,arguments)}}();m._createClass(d,[{key:"updating",
get:function(){return!1}}]);return d}(D.DataTileSource);v.GeoEventSource=w;Object.defineProperties(v,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});