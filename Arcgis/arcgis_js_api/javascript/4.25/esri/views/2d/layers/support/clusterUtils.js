// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../core/Error ../../../../core/has ../../../../core/Logger ../../../../core/maybe ../../../../core/MD5 ../../../../layers/support/AggregateField ../../../../layers/support/ExpressionInfo ../../../../renderers/support/AuthoringInfo ../../../../renderers/visualVariables/SizeVariable ../../../../renderers/visualVariables/support/SizeStop ../../engine/LevelDependentSizeVariable".split(" "),function(h,z,u,A,p,v,q,w,B,C,m,D){function E(b,a,d){switch(b){case "sum":return`cluster_sum_${a}`;
case "avg":case "avg_angle":return`cluster_avg_${a}`;case "mode":return`cluster_type_${a}`;case "avg_norm":return b=a.toLowerCase()+",norm:field,"+d.toLowerCase(),"cluster_avg_"+v.createMD5Hash(b)}}function n(b,a,d,g){const f=v.createMD5Hash(a),c="mode"===d?`cluster_type_${f}`:"sum"===d?`cluster_sum_${f}`:`cluster_avg_${f}`;b.some(k=>k.name===c)||b.push(new q({name:c,isAutoGenerated:!0,onStatisticExpression:new w({expression:a,returnType:g}),statisticType:d}));return c}function l(b,a,d,g,f){if("cluster_count"===
a||b.some(k=>k.name===a))return a;const c=E(d,a,f);b.some(k=>k.name===c)||("avg_norm"===d?b.push(new q({name:c,isAutoGenerated:!0,onStatisticExpression:new w({expression:`$feature.${a} / $feature.${f}`,returnType:g}),statisticType:"avg"})):b.push(new q({name:c,isAutoGenerated:!0,onStatisticField:a,statisticType:d})));return c}const F=A.getLogger("esri.views.2d.layers.support.clusterUtils");u.add("esri-cluster-arcade-enabled",!0);const G=u("esri-cluster-arcade-enabled"),r=b=>{for(const a of b)if("size"===
a.type)return a;return null},x=b=>{for(const a of b)if("cluster_count"===a.field)return!0;return!1},t=(b,a)=>{const d=[new m({value:0,size:0}),new m({value:1})];if(p.isNone(a))return new C({field:"cluster_count",stops:[...d,new m({value:2,size:0})]});const g=Object.keys(a).reduce((f,c)=>({...f,[c]:[...d,new m({value:Math.max(2,a[c].minValue),size:b.clusterMinSize}),new m({value:Math.max(3,a[c].maxValue),size:b.clusterMaxSize})]}),{});return new D.LevelDependentSizeVariable({field:"cluster_count",
levels:g})},y=b=>{const a=d=>F.error(new z("Unsupported-renderer",d,{renderer:b}));switch(b.type){case "unique-value":if(b.field2||b.field3)return a("FeatureReductionCluster does not support multi-field UniqueValueRenderers"),!1;break;case "class-breaks":if(b.normalizationField){const d=b.normalizationType;if("field"!==d)return a(`FeatureReductionCluster does not support a normalizationType of ${d}`),!1;break}case "simple":case "pie-chart":break;default:return a(`FeatureReductionCluster does not support renderers of type ${b.type}`),
!1}if(!G){if("valueExpression"in b&&b.valueExpression)return a("FeatureReductionCluster does not currently support renderer.valueExpression. Support will be added in a future release"),!1;if(("visualVariables"in b&&b.visualVariables||[]).some(d=>!!("valueExpression"in d&&d.valueExpression)))return a("FeatureReductionCluster does not currently support visualVariables with a valueExpression. Support will be added in a future release"),!1}return!0};h.createClusterCountSizeVariable=t;h.createClusterRenderer=
(b,a,d,g,f)=>{a=a.clone();if(!y(a))return a;a.authoringInfo||(a.authoringInfo=new B);a.authoringInfo.isAutoGenerated=!0;if("visualVariables"in a){const c=(a.visualVariables||[]).filter(e=>"$view.scale"!==e.valueExpression),k=r(c);c.forEach(e=>{"rotation"===e.type?e.field?e.field=l(b,e.field,"avg_angle","number"):e.valueExpression&&(e.field=n(b,e.valueExpression,"avg_angle","number"),e.valueExpression=null):e.normalizationField?(e.field=l(b,e.field,"avg_norm","number",e.normalizationField),e.normalizationField=
null):e.field?e.field=l(b,e.field,"avg","number"):e.valueExpression&&(e.field=n(b,e.valueExpression,"avg","number"),e.valueExpression=null)});p.isNone(k)&&!x(c)&&f&&(c.push(t(d,g)),a.dynamicClusterSize=!0);a.visualVariables=c}switch(a.type){case "pie-chart":for(const c of a.attributes)c.field?c.field=l(b,c.field,"sum","number"):c.valueExpression&&(c.field=n(b,c.valueExpression,"sum","number"),c.valueExpression=null);break;case "unique-value":a.field?a.field=l(b,a.field,"mode","string"):a.valueExpression&&
(a.field=n(b,a.valueExpression,"mode","string"),a.valueExpression=null);break;case "class-breaks":a.normalizationField?(a.field=l(b,a.field,"avg_norm","number",a.normalizationField),a.normalizationField=null):a.field?a.field=l(b,a.field,"avg","number"):a.valueExpression&&(a.field=n(b,a.valueExpression,"avg","number"),a.valueExpression=null)}return a};h.findSizeVV=r;h.hasClusterCountVV=x;h.injectDynamicLevelDependentSizeVisualVariable=function(b,a,d){b=b.clone();let g=!1;if("visualVariables"in b){var f=
(b.visualVariables||[]).filter(c=>"$view.scale"!==c.valueExpression);f=r(f);p.isNone(f)&&(b.visualVariables||(b.visualVariables=[]),b.visualVariables.push(t(a,d)),g=b.dynamicClusterSize=!0)}return{renderer:b,didInject:g}};h.isClusterCompatibleRenderer=y;Object.defineProperties(h,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});