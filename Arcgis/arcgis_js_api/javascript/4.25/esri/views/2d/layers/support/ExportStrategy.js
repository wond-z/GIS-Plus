// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Accessor ../../../../core/has ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/spatialReferenceUtils ../../../../layers/support/TileInfo ../../viewStateUtils ../../engine/Bitmap ../../tiling/TileInfoView ../../tiling/TileKey".split(" "),
function(u,k,g,K,p,m,L,M,E,B,F,G,C,H,I,J){const r=B.create(),q=[0,0],w=new J(0,0,0,0);g=function(D){function x(l){var a=D.call(this,l)||this;a._imagePromise=null;a.bitmaps=[];a.hidpi=!1;a.imageMaxWidth=2048;a.imageMaxHeight=2048;a.imageRotationSupported=!1;a.imageNormalizationSupported=!1;a.update=p.debounce(function(){var h=u._asyncToGenerator(function*(e,c){p.throwIfAborted(c);if(e.stationary&&!a.destroyed){var b=e.state,f=F.getInfo(b.spatialReference);e=a.hidpi?e.pixelRatio:1;var d=a.imageNormalizationSupported&&
b.worldScreenWidth&&b.worldScreenWidth<b.size[0];d?(q[0]=b.worldScreenWidth,q[1]=b.size[1]):a.imageRotationSupported?(q[0]=b.size[0],q[1]=b.size[1]):C.getOuterSize(q,b);f=f&&(b.extent.xmin<f.valid[0]||b.extent.xmax>f.valid[1]);var v=!a.imageNormalizationSupported&&f,y=!(Math.floor(q[0]*e)>a.imageMaxWidth||Math.floor(q[1]*e)>a.imageMaxHeight)&&!v,z=a.imageRotationSupported?b.rotation:0;f=a.container.children.slice();y?(d=d?b.paddedViewState.center:b.center,a._imagePromise&&console.error("Image promise was not defined!"),
a._imagePromise=a._singleExport(b,q,d,b.resolution,z,e,c)):(d=Math.min(a.imageMaxWidth,a.imageMaxHeight),v&&(d=Math.min(b.worldScreenWidth,d)),a._imagePromise=a._tiledExport(b,d,e,c));try{const t=yield a._imagePromise;p.throwIfAborted(c);c=[];a._imagePromise=null;if(!a.destroyed){a.bitmaps=t??[];for(const n of f)t.includes(n)||c.push(n.fadeOut().then(()=>{n.remove();n.destroy()}));for(const n of t)c.push(n.fadeIn());yield Promise.all(c)}}catch(t){a._imagePromise=null,p.throwIfAbortError(t)}}});return function(e,
c){return h.apply(this,arguments)}}(),5E3);a.updateExports=p.debounce(function(){var h=u._asyncToGenerator(function*(e){const c=[];for(const b of a.container.children){if(!b.visible||!b.stage)return;c.push(e(b).then(()=>{b.invalidateTexture();b.requestRender()}))}a._imagePromise=p.eachAlways(c).then(()=>a._imagePromise=null);yield a._imagePromise});return function(e){return h.apply(this,arguments)}}());return a}u._inheritsLoose(x,D);var A=x.prototype;A.destroy=function(){this.bitmaps.forEach(l=>l.destroy());
this.bitmaps=[]};A._export=function(){var l=u._asyncToGenerator(function*(a,h,e,c,b,f){e=yield this.fetchSource(a,Math.floor(h*b),Math.floor(e*b),{rotation:c,pixelRatio:b,signal:f});p.throwIfAborted(f);const d=new H.Bitmap(null,{immutable:!0,requestRenderOnSourceChangedEnabled:!0});d.x=a.xmin;d.y=a.ymax;d.resolution=a.width/h;d.rotation=c;d.pixelRatio=b;d.opacity=0;this.container.addChild(d);yield d.setSourceAsync(e,f);p.throwIfAborted(f);return d});return function(a,h,e,c,b,f){return l.apply(this,
arguments)}}();A._singleExport=function(){var l=u._asyncToGenerator(function*(a,h,e,c,b,f,d){C.getBBox(r,e,c,h);a=B.toExtent(r,a.spatialReference);return[yield this._export(a,h[0],h[1],b,f,d)]});return function(a,h,e,c,b,f,d){return l.apply(this,arguments)}}();A._tiledExport=function(l,a,h,e){var c=G.create({size:a,spatialReference:l.spatialReference,scales:[l.scale]});const b=new I(c);c=b.getTileCoverage(l);if(!c)return null;const f=[];c.forEach((d,v,y,z)=>{w.set(d,v,y,0);b.getTileBounds(r,w);const t=
B.toExtent(r,l.spatialReference);f.push(this._export(t,a,a,0,h,e).then(n=>{0!==z&&(w.set(d,v,y,z),b.getTileBounds(r,w),n.x=r[0],n.y=r[3]);return n}))});return Promise.all(f)};u._createClass(x,[{key:"updating",get:function(){return!this.destroyed&&null!==this._imagePromise}}]);return x}(g);k.__decorate([m.property()],g.prototype,"_imagePromise",void 0);k.__decorate([m.property()],g.prototype,"bitmaps",void 0);k.__decorate([m.property()],g.prototype,"container",void 0);k.__decorate([m.property()],g.prototype,
"fetchSource",void 0);k.__decorate([m.property()],g.prototype,"hidpi",void 0);k.__decorate([m.property()],g.prototype,"imageMaxWidth",void 0);k.__decorate([m.property()],g.prototype,"imageMaxHeight",void 0);k.__decorate([m.property()],g.prototype,"imageRotationSupported",void 0);k.__decorate([m.property()],g.prototype,"imageNormalizationSupported",void 0);k.__decorate([m.property()],g.prototype,"requestUpdate",void 0);k.__decorate([m.property()],g.prototype,"updating",null);return g=k.__decorate([E.subclass("esri.views.2d.layers.support.ExportStrategy")],
g)});