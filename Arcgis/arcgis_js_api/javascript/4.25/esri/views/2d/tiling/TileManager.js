// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/maybe","./TileCoverage","./TileKey"],function(p,u,v,q){let y=function(){function r(a){this._tiles=new Map;this.buffer=0;this.acquireTile=a.acquireTile;this.releaseTile=a.releaseTile;this.tileInfoView=a.tileInfoView;this.buffer=a.buffer}var d=r.prototype;d.destroy=function(){};d.clear=function(){this._tiles.forEach(a=>this._releaseTile(a))};d.tileKeys=function(){const a=[];this._tiles.forEach((b,c)=>a.push(c));return a};d.update=function(a){a=this.tileInfoView.getTileCoverage(a.state,
this.buffer,"closest");const {spans:b,lodInfo:c}=a,{level:f}=c,e=[],h=[],l=new Set,m=new Set;for(const {row:g,colFrom:w,colTo:x}of b)for(let k=w;k<=x;k++){const t=q.getId(f,g,c.normalizeCol(k),c.getWorldForColumn(k)),n=this._getOrAcquireTile(e,t);l.add(t);n.isReady?n.visible=!0:m.add(n.key)}m.forEach(g=>this._addPlaceholders(l,g));this._tiles.forEach(g=>{l.has(g.key.id)||(h.push(g.key.id),this._releaseTile(g))});v.pool.release(a);return{hasMissingTiles:0<m.size,added:e,removed:h}};d._getOrAcquireTile=
function(a,b){if(!this._tiles.has(b)){const c=this.acquireTile(new q(b));a.push(b);this._tiles.set(b,c);c.visible=!1}return this._tiles.get(b)};d._getTile=function(a){return this._tiles.get(a)};d._releaseTile=function(a){this._tiles.delete(a.key.id);this.releaseTile(a)};d._addPlaceholders=function(a,b){const c=this._addPlaceholderChildren(a,b);1E-6>Math.abs(1-c)||this._addPlaceholderParent(a,b)||(this._getTile(b.id).visible=!0)};d._addPlaceholderChildren=function(a,b){let c=0;this._tiles.forEach(f=>
{c+=this._addPlaceholderChild(a,f,b)});return c};d._addPlaceholderChild=function(a,b,c){if(b.key.level<=c.level||!b.hasData||!c.contains(b.key))return 0;b.visible=!0;a.add(b.key.id);return 1/(1<<2*(b.key.level-c.level))};d._addPlaceholderParent=function(a,b){b=b.getParentKey();var c=0;let f=null;for(;u.isSome(b);){if(a.has(b.id))return!0;const e=this._getTile(b.id);if(e?.isReady){for(const h of a)c=this._getTile(h),b.contains(c.key)&&(c.visible=!1);e.visible=!0;a.add(e.key.id);return!0}e?.hasData&&
e.patchCount>c&&(c=e.patchCount,f=e);b=b.getParentKey()}return f?(f.visible=!0,a.add(f.key.id),!0):!1};return r}();p.TileManager=y;Object.defineProperties(p,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});