// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/CircularArray ../../../../core/has ../../../../core/maybe ../../../../chunks/mat2df32 ./enums ./Utils ./WGLTile ./collisions/MetricReader ./cpuMapped/Geometry".split(" "),function(p,q,r,h,e,u,v,t,m,w,x){let y=0;m=function(n){function l(a,b,c,f,g,k){a=n.call(this,a,b,c,f)||this;a.instanceId=y++;a.patchCount=0;a._renderState={current:{geometry:new Map,metrics:null},next:null,swap:!1,swapFrames:0,locked:!1};a._patches=new r(100);
a._bufferPatches=new r(100);a._lastCommitTime=0;a.transforms.labelMat2d=u.create();a._store=g;a._requestLabelUpdate=k;return a}q._inheritsLoose(l,n);var d=l.prototype;d.destroy=function(){n.prototype.destroy.call(this);this._renderState.current.geometry.forEach(a=>a.destroy());e.isSome(this._renderState.next)&&this._renderState.next.geometry.forEach(a=>a.destroy());this._renderState.current=null;this._renderState.next=null};d.getGeometry=function(a){return this._renderState.current.geometry.get(a)};
d.patch=function(a,b){this.patchCount++;a.clear&&50<=this._patches.size&&this._dropPatches();const c=a.addOrUpdate&&this.key.id!==a.addOrUpdate.tileKeyOrigin;b&&c?this._bufferPatches.enqueue(a):(a.sort=a.sort&&!b,this._patches.enqueue(a));this.requestRender()};d.commit=function(a){if(this._lastCommitTime!==a.time){this._lastCommitTime=a.time;for(a=0;4>a;a++)this._updateMesh(),this.isReady&&this._updateBufferMesh();this._renderState.swap&&(this._swapRenderStates(),this.requestRender())}};d.lock=function(){this._renderState.locked=
!0};d.unlock=function(){this._renderState.locked=!1;this._flushUpdates();this._swap()};d._swapRenderStates=function(){this._renderState.next&&(this._renderState.locked?(this._renderState.swap=!0,this.requestRender()):(this._renderState.swap=!0,this._swap()))};d._swap=function(){this._renderState.swap&&(this._renderState.swap=!1,e.isSome(this._renderState.next)&&(this._renderState.current.geometry.forEach(a=>a.destroy()),this._renderState.current=this._renderState.next,this._renderState.next=null,
this._requestLabelUpdate()))};d._flushUpdates=function(){let a=this._patches.maxSize;for(;this._patches.size&&a--;)this._updateMesh(),this._swap()};d._updateBufferMesh=function(){var a=this._bufferPatches.peek();if(!e.isSome(a)||!a.clear||null===this._renderState.next)for(;this._bufferPatches.size;)a=this._bufferPatches.dequeue(),e.isSome(a)&&this._patchBuffer(a)};d._updateMesh=function(){const a=this._patches.dequeue();if(e.isSome(a)){if(h("esri-2d-update-debug")){var b=a.addOrUpdate?.tileKeyOrigin;
b=this.key.id===b?"SELF":b;let c="";for(let f=0;5>f;f++)c+=a.addOrUpdate?.data[f]?.records?.byteLength?1:0;console.debug(this.key.id,"FeatureTile:patch",`[clear: ${a.clear} origin: ${b}, end:${a.end} data:${c}]`)}!0===a.clear&&(e.isSome(this._renderState.next)&&(this._renderState.next.geometry.forEach(c=>c.destroy()),this._renderState.next=null),this._renderState.next={geometry:new Map,metrics:null},h("esri-2d-update-debug")&&console.debug(this.key.id,"FeatureTile:_updateMesh - Creating new renderState"));
this.requestRender();this._patch(a);a.end&&(h("esri-2d-update-debug")&&console.debug(this.key.id,"FeatureTile:_updateMesh - Encountered end message"),this.ready(),this._swapRenderStates())}};d._patch=function(a){t.forEachGeometryType(b=>{this._remove(b,a.remove);this._insert(b,a,!1)})};d._patchBuffer=function(a){t.forEachGeometryType(b=>{this._insert(b,a,!0)})};d._insert=function(a,b,c){try{const f=e.unwrapOr(this._renderState.next,this._renderState.current),g=b.addOrUpdate?.data[a],k=f.geometry;
e.isNone(g)||(k.has(a)||(h("esri-2d-update-debug")&&console.debug(this.key.id,`FeatureTile:_insert - Creating geometry buffer ${a}`),k.set(a,new x.Geometry(a,this.stage))),h("esri-2d-update-debug")&&console.debug(this.key.id,`FeatureTile:_insert - Inserting into ${a}, version=${b.addOrUpdate.version} stride=${g.stride}`),k.get(a).insert(g,b.sort,c),a===v.WGLGeometryType.LABEL&&this._insertLabelMetrics(b.type,g.metrics,b.clear))}catch(f){}};d._insertLabelMetrics=function(a,b,c){c=e.unwrapOr(this._renderState.next,
this._renderState.current);if(!e.isNone(b))if(b=w.MetricReader.from(b),e.isNone(c.metrics))c.metrics=b;else{if("update"===a)for(a=b.getCursor();a.next();)c.metrics.delete(a.id);c.metrics.link(b)}};d._remove=function(a,b){a=e.unwrapOr(this._renderState.next,this._renderState.current).geometry.get(a);b&&b.length&&a&&(a.remove(b),this._removeLabelMetrics(b))};d._removeLabelMetrics=function(a){const {metrics:b}=e.unwrapOr(this._renderState.next,this._renderState.current);if(!e.isNone(b)&&a.length)for(const c of a)for(;b.delete(c););
};d._dropPatches=function(){const a=[];let b=!1;for(;this._patches.size;){const c=this._patches.dequeue();if(e.isNone(c))break;if(c.clear){if(b)break;b=!0}a.push(c)}this._patches.clear();a.forEach(c=>this._patches.enqueue(c))};q._createClass(l,[{key:"labelMetrics",get:function(){return this._renderState.current.metrics}},{key:"hasData",get:function(){return!!this._renderState.current.geometry.size}}]);return l}(m.WGLTile);p.FeatureTile=m;Object.defineProperties(p,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});