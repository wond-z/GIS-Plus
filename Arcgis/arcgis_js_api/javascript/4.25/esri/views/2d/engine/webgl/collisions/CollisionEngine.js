// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../../core/maybe ../../../../../core/screenUtils ../definitions ./CollisionGrid ./visualVariableSimpleUtils".split(" "),function(x,v,A,y,u,B){function t(n,h){const e=[];n.forEachTile(c=>e.push(c));e.sort((c,f)=>c.instanceId-f.instanceId);e.forEach(c=>{v.isSome(c.labelMetrics)&&c.isReady&&h(c,c.labelMetrics.getCursor())})}function C(n){return h=>A.pt2px(B.getSizeForValueSimple(h,n))}function D(n){for(const h of n)if(n=("featureReduction"in h&&h.featureReduction&&"labelingInfo"in
h.featureReduction&&h.featureReduction)?.labelingInfo||[],n=[...(h.labelingInfo||[]),...n],h.labelsVisible&&n.length&&n.some(e=>"none"===e.deconflictionStrategy))return!0;return!1}let F=function(){function n(){}var h=n.prototype;h.run=function(e,c,f){const k=[];for(let r=e.length-1;0<=r;r--)a:{var b=k,a=e[r];if(!a.layer||"feature"!==a.layer.type&&"csv"!==a.layer.type&&"geojson"!==a.layer.type&&"ogc-feature"!==a.layer.type&&"stream"!==a.layer.type&&"subtype-group"!==a.layer.type&&"wfs"!==a.layer.type)break a;
const p=a.layer.geometryType,m=!D("subtype-group"===a.layer.type?a.layer.sublayers.items:[a.layer]),l={};if("subtype-group"!==a.layer.type){if("heatmap"===a.tileRenderer?.type)break a;b:{var d=a.layer.renderer;if(d="visualVariables"in d&&d.visualVariables)for(const g of d)if("size"===g.type){d=C(g);break b}d=null}l[0]=d}d=a.tileRenderer;v.isNone(d)||b.push({tileRenderer:d,vvEvaluators:l,deconflictionEnabled:m,geometryType:p,visible:a.layer.visible&&!a.suspended})}this._transformMetrics(k);this._runCollision(k,
c,f)};h._runCollision=function(e,c,f){const [k,b]=c.state.size,a=new u.CollisionBitsetGrid(k,b,c.pixelRatio);for(const {tileRenderer:d,deconflictionEnabled:r,visible:p}of e){const m=d.featuresView.attributeView;r?p?(this._prepare(d),this._collideVisible(a,d,f),this._collideInvisible(a,d)):t(d,(l,g)=>{for(;g.nextId();)m.setLabelMinZoom(g.id,255)}):t(d,(l,g)=>{for(;g.nextId();)m.setLabelMinZoom(g.id,0),p&&a.insertMetrics(g)})}};h._isFiltered=function(e,c,f){c=c.getFilterFlags(e);e=!f.hasFilter||!!(c&
y.FILTER_FLAG_0);f=v.isNone(f.featureEffect)||f.featureEffect.excludedLabelsVisible||!!(c&y.EFFECT_FLAG_0);return!(e&&f)};h._prepare=function(e){const c=e.featuresView.attributeView,f=new Set;t(e,(k,b)=>{for(;b.nextId();)f.has(b.id)||(f.add(b.id),this._isFiltered(b.id,c,e.layerView)?c.setLabelMinZoom(b.id,254):0!==c.getLabelMinZoom(b.id)?c.setLabelMinZoom(b.id,255):c.setLabelMinZoom(b.id,0))})};h._collideVisible=function(e,c,f){const k=c.featuresView.attributeView,b=new Set;t(c,(a,d)=>{for(;d.nextId();)if(!b.has(d.id))if(a.key.level!==
f)k.setLabelMinZoom(d.id,254);else if(0===k.getLabelMinZoom(d.id))switch(e.insertMetrics(d)){case u.HAS_COLLISION:k.setLabelMinZoom(d.id,254);b.add(d.id);break;case u.NONE:k.setLabelMinZoom(d.id,0),b.add(d.id)}})};h._collideInvisible=function(e,c){const f=c.featuresView.attributeView,k=new Set;t(c,(b,a)=>{for(;a.nextId();)if(!k.has(a.id)&&255===f.getLabelMinZoom(a.id))switch(e.insertMetrics(a)){case u.HAS_COLLISION:f.setLabelMinZoom(a.id,255);k.add(a.id);break;case u.NONE:f.setLabelMinZoom(a.id,0),
k.add(a.id)}})};h._transformMetrics=function(e){for(const {tileRenderer:c,geometryType:f,vvEvaluators:k}of e)t(c,(b,a)=>{const d=c.featuresView.attributeView;b=b.transforms.labelMat2d;b[4]=Math.round(b[4]);b[5]=Math.round(b[5]);const r="polyline"===f;for(;a.next();){const E=a.boundsCount,w=a.anchorX,z=a.anchorY;var p=a.size,m=k[0];if(v.isSome(m)){var l=d.getVVSize(a.id);m=m(l);p=isNaN(m)||null==m||Infinity===m?p:m}m=p/2*a.directionX;p=p/2*a.directionY;for(l=0;l<E;l++){var g=w,q=a.anchorY;r?(g=g+a.boundsX(l)+
m,q=q+a.boundsY(l)+p,g=b[0]*g+b[2]*q+b[4],q=b[1]*g+b[3]*q+b[5],a.setBoundsComputedAnchorX(l,Math.floor(g)),a.setBoundsComputedAnchorY(l,Math.floor(q))):(g=b[0]*w+b[2]*z+b[4],q=b[1]*w+b[3]*z+b[5],g=g+a.boundsX(l)+m,q=q+a.boundsY(l)+p,a.setBoundsComputedAnchorX(l,g),a.setBoundsComputedAnchorY(l,q))}}})};return n}();x.CollisionEngine=F;Object.defineProperties(x,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});