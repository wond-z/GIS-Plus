// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/Logger ../../../../../core/maybe ../enums ../VertexStream ./WGLGeometryBrushMarker ../effects/Effect ../techniques/utils ../../../../webgl/context-util ../../../../webgl/enums ../../../../webgl/FramebufferObject ../../../../webgl/heatmapTextureUtils ../../../../webgl/Renderbuffer ../../../../webgl/Texture".split(" "),function(x,v,k,B,C,D,E,y,F,c,G,H,I,z){const A=v.getLogger("esri.views.2d.engine.webgl.brushes.WGLBrushHeatmap");
v=function(p){function q(){var a=p.apply(this,arguments)||this;a.brushEffect=new J;return a}x._inheritsLoose(q,p);var e=q.prototype;e.supportsSymbology=function(a){return a===B.WGLSymbologyType.HEATMAP};e.dispose=function(){p.prototype.dispose.call(this);this.brushEffect.dispose();this.brushEffect=null};e.prepareState=function(){};e.drawGeometry=function(a,b,h,f){const {defines:d}=this.brushEffect.loadQualityProfile(a.context);p.prototype.drawGeometry.call(this,a,b,h,f?[...f,...d]:d)};e._drawMarkers=
function(a,b,h,f,d,g,l){const {context:m,rendererInfo:n,state:u}=a;({rendererSchema:a}=n);y.assertRendererSchema(a,"heatmap");const {referenceScale:r,radius:t,isFieldActive:w}=a;h.setUniform1f("u_radius",t*(0!==r?r/u.scale:1));l||(h.setUniform1f("u_isFieldActive",w),m.setStencilFunction(c.CompareFunction.GEQUAL,b.stencilRef,255));m.drawElements(f,d,c.DataType.UNSIGNED_INT,g)};return q}(D);const K={vsPath:"heatmap/heatmapResolve",fsPath:"heatmap/heatmapResolve",attributes:new Map([["a_position",0]])};
let J=function(p){function q(){var a=p.apply(this,arguments)||this;a.name=a.constructor.name;return a}x._inheritsLoose(q,p);var e=q.prototype;e.createOptions=function({passOptions:a}){return a};e.dispose=function(){this._prevFBO=null;this._accumulateOutputTexture=k.disposeMaybe(this._accumulateOutputTexture);k.isSome(this._accumulateFramebuffer)&&this._accumulateFramebuffer.detachDepthStencilBuffer();this._accumulateOutputStencilBuffer=k.disposeMaybe(this._accumulateOutputStencilBuffer);this._accumulateFramebuffer=
k.disposeMaybe(this._accumulateFramebuffer);this._resolveGradientTexture=k.disposeMaybe(this._resolveGradientTexture);this._tileQuad=k.disposeMaybe(this._tileQuad)};e.bind=function(a){const {context:b,rendererInfo:h,passOptions:f}=a,{rendererSchema:d}=h;k.isSome(f)&&"hittest"===f.type||"heatmap"!==d.type||(this._prevFBO=b.getBoundFramebufferObject(),this._prevViewport=b.getViewport(),y.assertRendererSchema(d,"heatmap"),this._loadResources(a),this._updateResources(b,d),b.bindFramebuffer(this._accumulateFramebuffer),
b.setViewport(0,0,this._accumulateFramebuffer.width,this._accumulateFramebuffer.height),b.setStencilTestEnabled(!0),b.setBlendingEnabled(!0),b.setBlendFunction(c.BlendFactor.ONE,c.BlendFactor.ONE),b.setClearColor(0,0,0,0),b.clear(c.ClearBufferBit.COLOR_BUFFER_BIT))};e.unbind=function(){this._prevViewport=this._prevFBO=null};e.draw=function(a){const {context:b,painter:h,rendererInfo:f,passOptions:d}=a;({rendererSchema:a}=f);if(!(k.isSome(d)&&"hittest"===d.type||"heatmap"!==a.type)){var {defines:g}=
this.loadQualityProfile(b);g=h.materialManager.getProgram(K,g);b.useProgram(g);b.bindFramebuffer(this._prevFBO);b.setViewport(0,0,this._prevViewport.width,this._prevViewport.height);b.setBlendFunction(c.BlendFactor.ONE,c.BlendFactor.ONE_MINUS_SRC_ALPHA);b.setStencilTestEnabled(!1);var {radius:l,minDensity:m,densityRange:n}=a;b.bindTexture(this._accumulateOutputTexture,8);b.bindTexture(this._resolveGradientTexture,9);g.setUniform1i("u_texture",8);g.setUniform1i("u_gradient",9);g.setUniform2f("u_densityMinAndInvRange",
m,1/n);g.setUniform1f("u_densityNormalization",3/(l*l*Math.PI));this._tileQuad.draw()}};e._loadResources=function({context:a,painter:b}){const {dataType:h,samplingMode:f,pixelFormat:d,internalFormat:g,shadingRate:l,requiresSharedStencilBuffer:m}=this.loadQualityProfile(a),{width:n,height:u}=this._prevViewport,r=n*l,t=u*l;this._accumulateOutputTexture??(this._accumulateOutputTexture=new z.Texture(a,{target:c.TextureType.TEXTURE_2D,pixelFormat:d,internalFormat:g,dataType:h,samplingMode:f,wrapMode:c.TextureWrapMode.CLAMP_TO_EDGE,
width:r,height:t}));m||(this._accumulateOutputStencilBuffer??(this._accumulateOutputStencilBuffer=new I.Renderbuffer(a,{width:r,height:t,internalFormat:c.RenderbufferFormat.DEPTH_STENCIL})));this._accumulateFramebuffer??(this._accumulateFramebuffer=new G.FramebufferObject(a,{},this._accumulateOutputTexture,m?b.getSharedStencilBuffer():this._accumulateOutputStencilBuffer));this._resolveGradientTexture??(this._resolveGradientTexture=new z.Texture(a,{target:c.TextureType.TEXTURE_2D,pixelFormat:c.PixelFormat.RGBA,
dataType:c.PixelType.UNSIGNED_BYTE,samplingMode:c.TextureSamplingMode.LINEAR,wrapMode:c.TextureWrapMode.CLAMP_TO_EDGE}));this._tileQuad??(this._tileQuad=new C(a,[0,0,1,0,0,1,1,1]))};e._updateResources=function(a,b){const {gradientHash:h,gradient:f}=b;this._prevGradientHash!==h&&(this._resolveGradientTexture.resize(f.length/4,1),this._resolveGradientTexture.setData(f),this._prevGradientHash=h);const {shadingRate:d,requiresSharedStencilBuffer:g}=this.loadQualityProfile(a),{width:l,height:m}=this._prevViewport;
b=l*d;const n=m*d,{width:u,height:r}=this._accumulateFramebuffer;if(u!==b||r!==n){const t=this._accumulateFramebuffer.depthStencilAttachment;if(g&&k.isSome(t)){const {width:w,height:L}=t.descriptor;if(w!==b||L!==n)A.errorOnce("Attempted to resize shared stencil buffer! Detaching instead."),this._accumulateFramebuffer.detachDepthStencilBuffer()}this._accumulateFramebuffer.resize(b,n)}g||a.blitFramebuffer(this._prevFBO,this._accumulateFramebuffer,0,0,this._prevFBO.width,this._prevFBO.height,0,0,this._accumulateFramebuffer.width,
this._accumulateFramebuffer.height,c.ClearBufferBit.STENCIL_BUFFER_BIT,c.TextureSamplingMode.NEAREST)};e.loadQualityProfile=function(a){if(k.isNone(this._qualityProfile)){const b=H.loadHeatmapTextureConfiguration(a,A);a=a.type===F.ContextType.WEBGL1;this._qualityProfile={...b,requiresSharedStencilBuffer:a,shadingRate:a?1:.25,defines:b.dataType!==c.PixelType.FLOAT?["heatmapPrecisionHalfFloat"]:[]}}return this._qualityProfile};return q}(E.Effect);return v});