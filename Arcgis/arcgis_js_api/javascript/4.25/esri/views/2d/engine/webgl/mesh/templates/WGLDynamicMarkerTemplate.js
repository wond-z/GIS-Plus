// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../../../../../../chunks/_rollupPluginBabelHelpers ../../../../../../core/Error ../../../../../../core/Logger ../../../../../../core/maybe ../../../../../../core/screenUtils ../../../../../../chunks/mat2df32 ../../../../../../chunks/vec2f32 ../../../../../../symbols/cim/enums ../../color ../../definitions ../../number ../../materialKey/MaterialKey ./util ./WGLBaseMarkerTemplate ./WGLDynamicMeshTemplate ../../util/Result".split(" "),function(C,D,E,y,h,F,G,H,w,x,q,I,k,J,K,L){const M=G.create(),
N=F.create();return function(B){function t(a,c,r){var b=B.call(this,a)||this;b._cimMarkerLayer=a;b._minMaxZoom=q.i1616to32(Math.round(c*x.MIN_MAX_ZOOM_PRECISION_FACTOR),Math.round(r*x.MIN_MAX_ZOOM_PRECISION_FACTOR));const l=a.color;k.isFunction(l)?b._dynamicPropertyMap.set("_fillColor",(g,d,e)=>w.premultiplyAlphaRGBA(l(g,d,e))):b._fillColor=w.premultiplyAlphaRGBA(l);const f=a.outlineColor;k.isFunction(f)?b._dynamicPropertyMap.set("_outlineColor",(g,d,e)=>w.premultiplyAlphaRGBA(f(g,d,e))):b._outlineColor=
w.premultiplyAlphaRGBA(f);const n=a.size;k.isFunction(n)?b._dynamicPropertyMap.set("_size",(g,d,e)=>h.pt2px(n(g,d,e))):b._size=h.pt2px(n)||0;c=a.scaleX;k.isFunction(c)?b._dynamicPropertyMap.set("_scaleX",c):b._scaleX=c;const m=a.offsetX;k.isFunction(m)?b._dynamicPropertyMap.set("xOffset",(g,d,e)=>h.pt2px(m(g,d,e))):b.xOffset=h.pt2px(m)||0;const p=a.offsetY;k.isFunction(p)?b._dynamicPropertyMap.set("yOffset",(g,d,e)=>h.pt2px(p(g,d,e))):b.yOffset=h.pt2px(p)||0;const u=a.outlineWidth;k.isFunction(u)?
b._dynamicPropertyMap.set("_outlineWidth",(g,d,e)=>h.pt2px(u(g,d,e))):b._outlineWidth=h.pt2px(u)||0;c=a.rotation;k.isFunction(c)?b._dynamicPropertyMap.set("_angle",c):b._angle=c||0;y.isSome(a.effects)&&(c=a.effects,k.isFunction(c)?b._dynamicPropertyMap.set("_effects",c):b._effects=c);y.isSome(a.markerPlacement)&&(c=a.markerPlacement,k.isFunction(c)?b._dynamicPropertyMap.set("_markerPlacement",c):b._markerPlacement=c);b._scaleFactor=y.unwrapOr(a.scaleFactor,1);b._bitSet=(a.alignment===H.Alignment.MAP?
1:0)|(a.colorLocked?1:0)<<1|(a.scaleSymbolsProportionally?1:0)<<3;b._materialKey=a.materialKey;return b}C._inheritsLoose(t,B);t.fromCIMMarker=function(a,c){const [r,b]=k.getMinMaxZoom(a.scaleInfo,c);return new t(a,r,b)};t.prototype.bindFeature=function(a,c,r){const b=a.readLegacyFeature();a=a.getObjectId();this._dynamicPropertyMap.forEach((O,P)=>{this[P]=O(b,c,r)});var l=this._cimMarkerLayer.materialHash;a="function"===typeof l?l(b,c,r,a):l;if((a=this._materialCache.get(a))&&L.ok(a.spriteMosaicItem)&&
a.spriteMosaicItem){a=a.spriteMosaicItem;l=this._cimMarkerLayer.sizeRatio;var f=a.width/a.height*this._scaleX,n=this._cimMarkerLayer.rotateClockwise?this._angle:-this._angle,m=this._size,p=m*f,u=this.xOffset,g=this.yOffset;this.xOffset*=this._scaleFactor;this.yOffset*=this._scaleFactor;var d=this._cimMarkerLayer.scaleSymbolsProportionally&&this._cimMarkerLayer.frameHeight?this._size/h.pt2px(this._cimMarkerLayer.frameHeight):1;d*=this._outlineWidth;var e=h.pt2px(this._cimMarkerLayer.referenceSize),
z=0,A=0,v=this._cimMarkerLayer.anchorPoint;v&&(this._cimMarkerLayer.isAbsoluteAnchorPoint?this._size&&(z=h.pt2px(v.x)/(this._size*f),A=h.pt2px(v.y)/this._size):(z=v.x,A=v.y));this._anchorX=z;this._anchorY=A;this._sizeOutlineWidth=q.i8888to32(Math.round(Math.min(Math.sqrt(128*p),255)),Math.round(Math.min(Math.sqrt(128*m),255)),Math.round(Math.min(Math.sqrt(128*d),255)),Math.round(Math.min(Math.sqrt(128*e),255)));this.angle=n;this._bitestAndDistRatio=q.i1616to32(this._bitSet,Math.round(64*l));f=a.rect.x+
x.SPRITE_PADDING;n=a.rect.y+x.SPRITE_PADDING;d=f+a.width;e=n+a.height;this._texUpperLeft=q.i1616to32(f,n);this._texUpperRight=q.i1616to32(d,n);this._texBottomLeft=q.i1616to32(f,e);this._texBottomRight=q.i1616to32(d,e);f=I.MarkerMaterialKey.load(this._materialKey);f.sdf=a.sdf;f.pattern=!0;f.textureBinding=a.textureBinding;this._materialKey=f.data;p=p*l*this._scaleFactor;m=m*l*this._scaleFactor;p*=a.rect.width/a.width;m*=a.rect.height/a.height;this._computedWidth=p;this._computedHeight=m;this._applyTransformation(N,
M);this.xOffset=u;this.yOffset=g}else E.getLogger("esri.views.2d.engine.webgl.WGLDynamicMarkerTemplate").error(new D("mapview-cim","Encountered an error when binding feature"))};return t}(J(K))});