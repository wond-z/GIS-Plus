// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define(["../../../../../chunks/_rollupPluginBabelHelpers","../enums","./BaseBucket","../../webgl/TurboLine"],function(C,I,J,K){const L=r=>(t,p,a,b,d,e,c,g,h,l,q)=>{r._lineVertexBuffer.add(t,p,c,g,a,b,d,e,h,l,q,r._ddValues);return r._lineVertexBuffer.index-1},M=r=>(t,p,a)=>{r._lineIndexBuffer.add(t,p,a)};return function(r){function t(a,b,d,e,c){b=r.call(this,a,b,d)||this;b.type=I.BucketType.LINE;b._tessellationOptions={pixelCoordRatio:8,halfWidth:0,offset:0};b._patternMap=new Map;b.tessellationProperties=
{_lineVertexBuffer:null,_lineIndexBuffer:null,_ddValues:null};b.tessellationProperties._lineVertexBuffer=e;b.tessellationProperties._lineIndexBuffer=c;b._lineTessellator=new K.LineTessellation(L(b.tessellationProperties),M(b.tessellationProperties),a.canUseThinTessellation);return b}C._inheritsLoose(t,r);var p=t.prototype;p.getResources=function(a,b,d){a=this.layer;const e=this.zoom,c=a.getPaintProperty("line-pattern"),g=a.getPaintProperty("line-dasharray"),h=a.getLayoutProperty("line-cap");if(c||
g){d=h?.getValue(e)||0;var l=h?.isDataDriven,q=c?.isDataDriven;if(q||g?.isDataDriven)for(var m of this._features)q?b(c.getValue(e,m)):b(this._getDashArrayKey(m,e,a,g,l,h,d));else c?b(c.getValue(e)):g&&(m=g.getValue(e),b(a.getDashKey(m,d)))}};p.processFeatures=function(a){this._lineIndexStart=3*this.tessellationProperties._lineIndexBuffer.index;this._lineIndexCount=0;const b=this.layer,d=this.zoom;var e=this._features;const c=this._tessellationOptions,{hasDataDrivenLine:g,lineMaterial:h}=b;a&&a.setExtent(this.layerExtent);
var l=b.getPaintProperty("line-pattern"),q=b.getPaintProperty("line-dasharray"),m=l?.isDataDriven,A=q?.isDataDriven;var f=b.getLayoutProperty("line-cap");const u=f?.isDataDriven?f:null,B=u?null:b.getLayoutValue("line-cap",d),N=B||0,O=!!u;f=b.getLayoutProperty("line-join");const v=f?.isDataDriven?f:null,D=v?null:b.getLayoutValue("line-join",d);f=b.getLayoutProperty("line-miter-limit");const w=f?.isDataDriven?f:null,E=w?null:b.getLayoutValue("line-miter-limit",d);f=b.getLayoutProperty("line-round-limit");
const x=f?.isDataDriven?f:null,F=x?null:b.getLayoutValue("line-round-limit",d);f=b.getPaintProperty("line-width");const y=f?.isDataDriven?f:null,G=y?null:b.getPaintValue("line-width",d);f=b.getPaintProperty("line-offset");const H=(f=f?.isDataDriven?f:null)?null:b.getPaintValue("line-offset",d);if(m||A){var n=[];for(const k of e){e=m?l.getValue(d,k):this._getDashArrayKey(k,d,b,q,O,u,N);e=this._spriteInfo[e];if(!e||!e.rect)continue;A=h.encodeAttributes(k,d,b,e);const z=k.getGeometry(a);n.push({ddAttributes:A,
page:e.page,cap:u?u.getValue(d,k):B,join:v?v.getValue(d,k):D,miterLimit:w?w.getValue(d,k):E,roundLimit:x?x.getValue(d,k):F,halfWidth:.5*(y?y.getValue(d,k):G),offset:f?f.getValue(d,k):H,geometry:z})}n.sort((k,z)=>k.page-z.page);c.textured=!0;for(const {ddAttributes:k,page:z,cap:P,join:Q,miterLimit:R,roundLimit:S,halfWidth:T,offset:U,geometry:V}of n)c.capType=P,c.joinType=Q,c.miterLimit=R,c.roundLimit=S,c.halfWidth=T,c.offset=U,this._processFeature(V,k,z)}else{if(l&&(m=l.getValue(d),m=this._spriteInfo[m],
!m||!m.rect))return;c.textured=!(!l&&!q);c.capType=B;c.joinType=D;c.miterLimit=E;c.roundLimit=F;c.halfWidth=.5*G;c.offset=H;for(n of e)l=g?h.encodeAttributes(n,d,b):null,u&&(c.capType=u.getValue(d,n)),v&&(c.joinType=v.getValue(d,n)),w&&(c.miterLimit=w.getValue(d,n)),x&&(c.roundLimit=x.getValue(d,n)),y&&(c.halfWidth=.5*y.getValue(d,n)),f&&(c.offset=f.getValue(d,n)),q=n.getGeometry(a),this._processFeature(q,l)}};p.serialize=function(){var a=6+this.layerUIDs.length;a+=this.tessellationProperties._lineVertexBuffer.array.length;
a+=this.tessellationProperties._lineIndexBuffer.array.length;a+=3*this._patternMap.size+1;a=new Uint32Array(a);var b=new Int32Array(a.buffer);let d=0;a[d++]=this.type;a[d++]=this.layerUIDs.length;for(var e=0;e<this.layerUIDs.length;e++)a[d++]=this.layerUIDs[e];a[d++]=this._lineIndexStart;a[d++]=this._lineIndexCount;e=this._patternMap;const c=e.size;a[d++]=c;if(0<c)for(const [g,[h,l]]of e)a[d++]=g,a[d++]=h,a[d++]=l;a[d++]=this.tessellationProperties._lineVertexBuffer.array.length;for(e=0;e<this.tessellationProperties._lineVertexBuffer.array.length;e++)b[d++]=
this.tessellationProperties._lineVertexBuffer.array[e];a[d++]=this.tessellationProperties._lineIndexBuffer.array.length;for(b=0;b<this.tessellationProperties._lineIndexBuffer.array.length;b++)a[d++]=this.tessellationProperties._lineIndexBuffer.array[b];return a.buffer};p._processFeature=function(a,b,d){if(a){var e=a.length;for(let c=0;c<e;c++)this._processGeometry(a[c],b,d)}};p._processGeometry=function(a,b,d){if(!(2>a.length)){for(var e=a[0],c=1,g,h;c<a.length;)g=a[c].x-e.x,h=a[c].y-e.y,1E-6>g*g+
h*h?a.splice(c,1):(e=a[c],++c);2>a.length||(c=this.tessellationProperties._lineIndexBuffer,e=3*c.index,this._tessellationOptions.initialDistance=0,this._tessellationOptions.wrapDistance=65535,this.tessellationProperties._ddValues=b,this._lineTessellator.tessellate(a,this._tessellationOptions),a=3*c.index-e,void 0!==d&&(b=this._patternMap,(c=b.get(d))?c[1]+=a:b.set(d,[e+this._lineIndexCount,a])),this._lineIndexCount+=a)}};p._getDashArrayKey=function(a,b,d,e,c,g,h){c=c?g.getValue(b,a):h;a=e.getValue(b,
a);return d.getDashKey(a,c)};C._createClass(t,[{key:"lineIndexStart",get:function(){return this._lineIndexStart}},{key:"lineIndexCount",get:function(){return this._lineIndexCount}}]);return t}(J)});