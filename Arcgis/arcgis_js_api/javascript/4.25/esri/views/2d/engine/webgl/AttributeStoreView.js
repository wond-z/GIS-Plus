// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../core/Error ../../../../core/has ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ./definitions ./DisplayId ./Utils ./util/debug ../../../webgl/enums ../../../webgl/FramebufferObject ../../../webgl/Texture".split(" "),function(B,C,D,u,v,d,I,h,E,p,F,m,J,G){const w=v.getLogger("esri.views.2d.engine.webgl.AttributeStoreView"),x=F.createDebugLogger(F.DEBUG_ATTR_UPDATES,w);let H=function(){function n(a,
b,c){this._lastTexture=this._texture=null;this._fbos={};this.texelSize=4;const {buffer:e,pixelType:f,textureOnly:k}=a;a=p.getPixelArrayCtor(f);this.shared=c;this.pixelType=f;this.size=b;this.textureOnly=k;k||(this.data=new a(d.unwrap(e)));this._resetRange()}var g=n.prototype;g.destroy=function(){d.applySome(this._texture,a=>a.dispose());for(const a in this._fbos)d.applySome(this._fbos[a],b=>{"0"===a&&b.detachColorTexture();b.dispose()}),this._fbos[a]=null;this._texture=null};g.setData=function(a,
b,c){a=E.getDisplayIdTexel(a);const e=d.unwrap(this.data);b=a*this.texelSize+b;!e||b>=e.length||(e[b]=c,this.dirtyStart=Math.min(this.dirtyStart,a),this.dirtyEnd=Math.max(this.dirtyEnd,a))};g.getData=function(a,b){if(d.isNone(this.data))return null;a=E.getDisplayIdTexel(a)*this.texelSize+b;return!this.data||a>=this.data.length?null:this.data[a]};g.getTexture=function(a){return d.unwrapOr(this._texture,()=>this._initTexture(a))};g.getFBO=function(a,b=0){if(d.isNone(this._fbos[b])){const c={colorTarget:m.TargetType.TEXTURE,
depthStencilTarget:m.DepthStencilTargetType.NONE},e=0===b?this.getTexture(a):this._textureDesc;this._fbos[b]=new J.FramebufferObject(a,c,e)}return this._fbos[b]};g.updateTexture=function(a,b){if(!this.locked){try{const c=this.dirtyStart,e=this.dirtyEnd;if(!this.hasDirty)return;this._resetRange();const f=d.unwrap(this.data).buffer,k=this.getTexture(a),l=(c-c%this.size)/this.size,r=(e-e%this.size)/this.size,q=l*this.size*4,y=4*(this.size+r*this.size)-q,t=p.getPixelArrayCtor(this.pixelType),z=new t(f,
q*t.BYTES_PER_ELEMENT,y),A=this.size;a=r-l+1;if(a>this.size){w.error(new D("mapview-webgl","Out-of-bounds index when updating AttributeData"));return}k.updateData(0,0,l,A,a,z)}catch(c){}b()}};g.update=function(a){const {data:b,start:c,end:e}=a;if(d.isSome(b)){const f=this.data,k=c*this.texelSize;for(let l=0;l<b.length;l++)a.layout&1<<l%this.texelSize&&(f[k+l]=b[l])}this.dirtyStart=Math.min(this.dirtyStart,c);this.dirtyEnd=Math.max(this.dirtyEnd,e)};g.resize=function(a,b){const c=this.size;this.size=
b;this.textureOnly?c!==this.size&&(this._lastTexture=this._texture,this._texture=null):(b=p.getPixelArrayCtor(this.pixelType),this.destroy(),this.data=new b(d.unwrap(a.buffer)))};g._resetRange=function(){this.dirtyStart=2147483647;this.dirtyEnd=0};g._initTexture=function(a){const b=new G.Texture(a,this._textureDesc,d.unwrapOr(this.data,void 0));if(d.isSome(this._lastTexture)&&this._fbos[0]){const f=this._lastTexture.descriptor.width,k=this._lastTexture.descriptor.height,l=this._lastTexture.descriptor.dataType,
r=this._lastTexture.descriptor.pixelFormat,q=this.getFBO(a);var c=p.getPixelBytes(l),e=p.getPixelArrayCtor(l);c=new ArrayBuffer(f*k*c*this.texelSize);e=new e(c);c=a.getBoundFramebufferObject();const {x:y,y:t,width:z,height:A}=a.getViewport();a.bindFramebuffer(q);q.readPixels(0,0,f,k,r,l,e);b.updateData(0,0,0,2*f,k/2,e);a.setViewport(y,t,z,A);a.bindFramebuffer(c)}this.destroy();return this._texture=b};C._createClass(n,[{key:"_textureDesc",get:function(){return{target:m.TextureType.TEXTURE_2D,wrapMode:m.TextureWrapMode.CLAMP_TO_EDGE,
pixelFormat:m.PixelFormat.RGBA,dataType:this.pixelType,samplingMode:m.TextureSamplingMode.NEAREST,width:this.size,height:this.size}}},{key:"locked",get:function(){return this.pixelType===m.PixelType.UNSIGNED_BYTE&&this.shared&&!this.textureOnly&&u("esri-atomics")&&this.data?1===Atomics.load(this.data,0):!1}},{key:"hasDirty",get:function(){return this.dirtyEnd>=this.dirtyStart}}]);return n}();v=function(){function n(a){this._onUpdate=a;this._locked=this._forceNextUpload=this._initialized=!1}var g=
n.prototype;g.initialize=function(a){const {blocks:b,shared:c,size:e}=a;this.shared=c;this.size=e;x("Initializing AttributeStoreView",a);if(d.isNone(this._data))this._data=d.mapMany(b,f=>new H(f,e,c));else for(a=0;a<this._data.length;a++){const f=this._data[a],k=b[a];d.isSome(k)&&(d.isNone(f)?this._data[a]=new H(k,e,c):f.resize(k,e))}this._initialized=!0};g.destroy=function(){d.applySome(this._data,a=>d.mapMany(a,b=>b.destroy()));d.applySome(this._defaultTexture,a=>a.dispose())};g.isEmpty=function(){return d.isNone(this._data)};
g.isUpdating=function(){const a=d.isSome(this._pendingAttributeUpdate);u("esri-2d-log-updating")&&console.log(`Updating AttributeStoreView ${a}\n  -> hasPendingUpdate ${a}`);return a};g.getBlock=function(a){return d.isNone(this._data)?null:this._data[a]};g.setLabelMinZoom=function(a,b){this.setData(a,0,1,b)};g.getLabelMinZoom=function(a){return this.getData(a,0,1,255)};g.getFilterFlags=function(a){return this.getData(a,0,0,0)};g.getVVSize=function(a){return this.getData(a,h.ATTRIBUTE_DATA_VV,0,0)};
g.getData=function(a,b,c,e){if(!this._data)return 0;b=d.unwrap(this._data)[b];if(d.isNone(b))return 0;a=b.getData(a,c);return d.isSome(a)?a:e};g.setData=function(a,b,c,e){b=d.unwrap(this._data)[b];d.unwrap(b).setData(a,c,e)};g.lockTextureUpload=function(){this._locked=!0};g.unlockTextureUpload=function(){this._locked=!1};g.forceTextureUpload=function(){this._forceNextUpload=!0};g.requestUpdate=function(){var a=C._asyncToGenerator(function*(b){if(this._pendingAttributeUpdate)w.error(new D("mapview-webgl",
"Tried to update attribute data with a pending update"));else{var c=I.createResolver();x("AttributeStoreView Update Requested",b);this._pendingAttributeUpdate={data:b,resolver:c};this._onUpdate();return c.promise}});return function(b){return a.apply(this,arguments)}}();g.update=function(){if(this._initialized&&d.isSome(this._pendingAttributeUpdate)){u("esri-2d-update-debug")&&console.debug("AttributeStoreView::update");const {data:a,resolver:b}=this._pendingAttributeUpdate,c=d.unwrap(this._data);
for(let e=0;e<a.blocks.length;e++){const f=a.blocks[e];d.applySome(c[e],k=>d.applySome(f,l=>{x(`Updating block ${e}`,l);k.update(l)}))}this._pendingAttributeUpdate=null;b();this._onUpdate()}};g.bindTextures=function(a,b=!0){const c=this._getDefaultTexture(a);if(this._initialized){var e=d.unwrap(this._data);if(!this._locked||this._forceNextUpload)d.forEachSome(e,f=>f.updateTexture(a,()=>this._onUpdate())),this._forceNextUpload=!1;a.bindTexture(d.mapOr(e[h.ATTRIBUTE_DATA_FILTER_FLAGS],c,f=>f.getTexture(a)),
h.TEXTURE_BINDING_ATTRIBUTE_DATA_0);b&&(a.bindTexture(d.mapOr(e[h.ATTRIBUTE_DATA_GPGPU],c,f=>f.getTexture(a)),h.TEXTURE_BINDING_GPGPU),a.bindTexture(d.mapOr(e[h.ATTRIBUTE_DATA_ANIMATION],c,f=>f.getTexture(a)),h.TEXTURE_BINDING_ATTRIBUTE_DATA_1),a.bindTexture(d.mapOr(e[h.ATTRIBUTE_DATA_VV],c,f=>f.getTexture(a)),h.TEXTURE_BINDING_ATTRIBUTE_DATA_2),a.bindTexture(d.mapOr(e[h.ATTRIBUTE_DATA_DD1],c,f=>f.getTexture(a)),h.TEXTURE_BINDING_ATTRIBUTE_DATA_3),a.bindTexture(d.mapOr(e[h.TEXTURE_BINDING_ATTRIBUTE_DATA_4],
c,f=>f.getTexture(a)),h.TEXTURE_BINDING_ATTRIBUTE_DATA_4),a.bindTexture(d.mapOr(e[h.TEXTURE_BINDING_ATTRIBUTE_DATA_5],c,f=>f.getTexture(a)),h.TEXTURE_BINDING_ATTRIBUTE_DATA_5))}else a.bindTexture(c,h.TEXTURE_BINDING_ATTRIBUTE_DATA_0),b&&(a.bindTexture(c,h.TEXTURE_BINDING_ATTRIBUTE_DATA_1),a.bindTexture(c,h.TEXTURE_BINDING_ATTRIBUTE_DATA_2),a.bindTexture(c,h.TEXTURE_BINDING_ATTRIBUTE_DATA_3),a.bindTexture(c,h.TEXTURE_BINDING_ATTRIBUTE_DATA_4),a.bindTexture(c,h.TEXTURE_BINDING_ATTRIBUTE_DATA_5),a.bindTexture(c,
h.TEXTURE_BINDING_GPGPU))};g._getDefaultTexture=function(a){d.isNone(this._defaultTexture)&&(this._defaultTexture=new G.Texture(a,{wrapMode:m.TextureWrapMode.CLAMP_TO_EDGE,pixelFormat:m.PixelFormat.RGBA,dataType:m.PixelType.UNSIGNED_BYTE,samplingMode:m.TextureSamplingMode.NEAREST,width:1,height:1},new Uint8Array(4)));return this._defaultTexture};return n}();B.AttributeStoreView=v;Object.defineProperties(B,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});