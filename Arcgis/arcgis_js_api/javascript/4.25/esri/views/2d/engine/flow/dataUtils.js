// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../geometry ../../../../core/has ../../../../core/Logger ../../../../core/mathUtils ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/RandomLCG ../../../../geometry/support/spatialReferenceUtils ../../../../geometry/Extent".split(" "),function(O,S,ua,P,ca,da,R,ea,W,fa,ha){function T(){T=S._asyncToGenerator(function*(a,d,f,b){const c=performance.now();var g=ia(d,f);const l=performance.now();f=ja(d,g,f.width,f.height);
d=performance.now();g=X(f,!0);f=performance.now();a="Streamlines"===a?Y(g,10):Z(g);g=performance.now();P("esri-2d-profiler")&&(G.info("I.1","_createFlowFieldFromData (ms)",Math.round(l-c)),G.info("I.2","_getStreamlines (ms)",Math.round(d-l)),G.info("I.3","createAnimatedLinesData (ms)",Math.round(f-d)),G.info("I.4","create{Streamlines|Particles}Mesh (ms)",Math.round(g-f)),G.info("I.5","createFlowMesh (ms)",Math.round(g-c)),G.info("I.6","Mesh size (bytes)",a.vertexData.buffer.byteLength+a.indexData.buffer.byteLength));
yield Promise.resolve();ea.throwIfAborted(b);return a});return T.apply(this,arguments)}function ia(a,d){const f=ka(d.data,d.width,d.height,a.smoothing);return a.interpolate?(b,c)=>{const g=Math.floor(b),l=Math.floor(c);if(0>g||g>=d.width||0>l||l>=d.height)return[0,0];b-=g;c-=l;const e=g<d.width-1?g+1:g,h=l<d.height-1?l+1:l;return[(f[2*(l*d.width+g)]*(1-c)+f[2*(h*d.width+g)]*c)*(1-b)+(f[2*(l*d.width+e)]*(1-c)+f[2*(h*d.width+e)]*c)*b,(f[2*(l*d.width+g)+1]*(1-c)+f[2*(h*d.width+g)+1]*c)*(1-b)+(f[2*(l*
d.width+e)+1]*(1-c)+f[2*(h*d.width+e)+1]*c)*b]}:(b,c)=>{b=Math.round(b);c=Math.round(c);return 0>b||b>=d.width||0>c||c>=d.height?[0,0]:[f[2*(c*d.width+b)],f[2*(c*d.width+b)+1]]}}function la(a,d,f,b,c,g,l,e,h){const q=[];let k=0,[m,r]=d(f,b);m*=a.velocityScale;r*=a.velocityScale;q.push({x:f,y:b,t:k,speed:Math.sqrt(m*m+r*r)});for(let t=0;t<a.verticesPerLine;t++){let [w,B]=d(f,b);w*=a.velocityScale;B*=a.velocityScale;const v=Math.sqrt(w*w+B*B);if(v<a.minSpeedThreshold)break;const E=w/v,x=B/v;f+=E*a.segmentLength;
b+=x*a.segmentLength;k+=a.segmentLength/v;if(Math.acos(E*u+x*y)>a.maxTurnAngle)break;if(a.collisions){var u=Math.round(f*h);var y=Math.round(b*h);if(0>u||u>l-1||0>y||y>e-1)break;const p=g[y*l+u];if(-1!==p&&p!==c)break;g[y*l+u]=c}q.push({x:f,y:b,t:k,speed:v});u=E;y=x}return q}function ja(a,d,f,b){const c=[],g=new W,l=1/Math.max(a.lineCollisionWidth,1),e=Math.round(f*l),h=Math.round(b*l),q=new Int32Array(e*h);for(var k=0;k<q.length;k++)q[k]=-1;k=[];for(let m=0;m<b;m+=a.lineSpacing)for(let r=0;r<f;r+=
a.lineSpacing)k.push({x:r,y:m,sort:g.getFloat()});k.sort((m,r)=>m.sort-r.sort);for(const {x:m,y:r}of k)g.getFloat()<a.density&&(f=la(a,d,m,r,c.length,q,e,h,l),2>f.length||c.push(f));return c}function ka(a,d,f,b){if(0===b)return a;const c=Math.round(3*b),g=Array(2*c+1);var l=0;for(var e=-c;e<=c;e++){var h=Math.exp(-e*e/(b*b));g[e+c]=h;l+=h}for(b=-c;b<=c;b++)g[b+c]/=l;l=new Float32Array(a.length);for(b=0;b<f;b++)for(e=0;e<d;e++){var q=h=0;for(var k=-c;k<=c;k++)if(!(0>e+k||e+k>=d)){var m=g[k+c];h+=m*
a[2*(b*d+(e+k))];q+=m*a[2*(b*d+(e+k))+1]}l[2*(b*d+e)]=h;l[2*(b*d+e)+1]=q}a=new Float32Array(a.length);for(b=0;b<d;b++)for(e=0;e<f;e++){q=h=0;for(k=-c;k<=c;k++)0>e+k||e+k>=f||(m=g[k+c],h+=m*l[2*((e+k)*d+b)],q+=m*l[2*((e+k)*d+b)+1]);a[2*(e*d+b)]=h;a[2*(e*d+b)+1]=q}return a}function X(a,d){const f=new W;var b=a.reduce((e,h)=>e+h.length,0);b=new Float32Array(4*b);const c=Array(a.length);let g=0,l=0;for(const e of a){a=g;for(const h of e)b[4*g]=h.x,b[4*g+1]=h.y,b[4*g+2]=h.t,b[4*g+3]=h.speed,g++;c[l++]=
{startVertex:a,numberOfVertices:e.length,totalTime:e[e.length-1].t,timeSeed:d?f.getFloat():0}}return{lineVertices:b,lineDescriptors:c}}function Y(a,d){function f(u,y,t,w,B,v,E,x){const p=9*h;let n=0;e[p+n++]=u;e[p+n++]=y;e[p+n++]=1;e[p+n++]=t;e[p+n++]=v;e[p+n++]=E;e[p+n++]=w/2;e[p+n++]=B/2;e[p+n++]=x;h++;e[p+n++]=u;e[p+n++]=y;e[p+n++]=-1;e[p+n++]=t;e[p+n++]=v;e[p+n++]=E;e[p+n++]=-w/2;e[p+n++]=-B/2;e[p+n++]=x;h++}const {lineVertices:b,lineDescriptors:c}=a;var g=a=0;for(var l of c)a+=2*l.numberOfVertices,
g+=6*(l.numberOfVertices-1);const e=new Float32Array(9*a);l=new Uint32Array(g);let h=0;a=0;for(const u of c){const {totalTime:y,timeSeed:t}=u;let w=g=null,B=null;var q=null,k=null,m=null;for(let v=0;v<u.numberOfVertices;v++){q=b[4*(u.startVertex+v)];const E=b[4*(u.startVertex+v)+1],x=b[4*(u.startVertex+v)+2],p=b[4*(u.startVertex+v)+3];let n=null,z=null;var r=null;let F=null;0<v&&(n=q-g,z=E-w,r=Math.sqrt(n*n+z*z),n/=r,z/=r,1<v?(k=n+k,m=z+m,r=Math.sqrt(k*k+m*m),k/=r,m/=r,r=Math.min(1/(k*n+m*z),d),k*=
r,m*=r,r=-m,F=k):(r=-z,F=n),null!==r&&null!==F&&(f(g,w,B,r,F,y,t,p),l[a++]=h-2,l[a++]=h,l[a++]=h-1,l[a++]=h,l[a++]=h+1,l[a++]=h-1));g=q;w=E;B=x;k=n;m=z;q=p}f(g,w,B,-m,k,y,t,q)}return{vertexData:e,indexData:l}}function Z(a){function d(C,I){var H=x+n,J=p+z,K=Math.sqrt(H*H+J*J);H/=K;J/=K;var Q=x*H+p*J,L=n+F,N=z+M;K=Math.sqrt(L*L+N*N);L/=K;N/=K;var A=n*L+z*N;K=r;var ma=u,na=y,oa=t;J=-(J/Q);H/=Q;Q=w;var pa=B,qa=v,ra=E;N=-(N/A);L/=A;A=16*k;let D=0;for(const sa of[1,2])for(const ta of[1,2,3,4])h[A+D++]=
K,h[A+D++]=ma,h[A+D++]=na,h[A+D++]=oa,h[A+D++]=Q,h[A+D++]=pa,h[A+D++]=qa,h[A+D++]=ra,h[A+D++]=sa,h[A+D++]=ta,h[A+D++]=C,h[A+D++]=I,h[A+D++]=J/2,h[A+D++]=H/2,h[A+D++]=N/2,h[A+D++]=L/2,k++;q[m++]=k-8;q[m++]=k-7;q[m++]=k-6;q[m++]=k-7;q[m++]=k-5;q[m++]=k-6;q[m++]=k-4;q[m++]=k-3;q[m++]=k-2;q[m++]=k-3;q[m++]=k-1;q[m++]=k-2}function f(C,I,H,J,K,Q){x=n;p=z;n=F;z=M;null==x&&null==p&&(x=n,p=z);if(null!=w&&null!=B){F=C-w;M=I-B;const L=Math.sqrt(F*F+M*M);F/=L;M/=L}null!=x&&null!=p&&d(K,Q);r=w;u=B;y=v;t=E;w=C;
B=I;v=H;E=J}function b(C,I){x=n;p=z;n=F;z=M;null==x&&null==p&&(x=n,p=z);null!=x&&null!=p&&d(C,I)}const {lineVertices:c,lineDescriptors:g}=a;let l=a=0;for(var e of g){const C=e.numberOfVertices-1;a+=8*C;l+=12*C}const h=new Float32Array(16*a),q=new Uint32Array(l);let k=0,m=0,r,u,y,t,w,B,v,E,x,p,n,z,F,M;for(const C of g){M=F=z=n=p=x=E=v=B=w=t=y=u=r=null;const {totalTime:I,timeSeed:H}=C;for(e=0;e<C.numberOfVertices;e++)f(c[4*(C.startVertex+e)],c[4*(C.startVertex+e)+1],c[4*(C.startVertex+e)+2],c[4*(C.startVertex+
e)+3],I,H);b(I,H)}return{vertexData:h,indexData:q}}function aa(a,d){const f=d.pixels,{width:b,height:c}=d,g=new Float32Array(b*c*2),l=d.mask||new Uint8Array(b*c*2);d.mask||l.fill(255);if("vector-uv"===a)for(a=0;a<b*c;a++)g[2*a]=f[0][a],g[2*a+1]=-f[1][a];else if("vector-magdir"===a)for(a=0;a<b*c;a++){d=f[0][a];const e=da.deg2rad(f[1][a]),h=Math.sin(e-Math.PI/2);g[2*a]=Math.cos(e-Math.PI/2)*d;g[2*a+1]=h*d}return{data:g,mask:l,width:b,height:c}}function U(){U=S._asyncToGenerator(function*(a,d,f,b,c,
g){const l=performance.now();var e=fa.getInfo(d.spatialReference);if(!e)return f=yield ba(a,d,f,b,c,g),P("esri-2d-profiler")&&G.info("I.7","loadImagery, early exit (ms)",Math.round(performance.now()-l)),P("esri-2d-profiler")&&G.info("I.9","Number of parts",1),f;const [h,q]=e.valid,k=Math.ceil(d.width/(q-h)),m=d.width/k,r=Math.round(f/k);let u=d.xmin;const y=[];e=performance.now();for(let t=0;t<k;t++){const w=new ha({xmin:u,xmax:u+m,ymin:d.ymin,ymax:d.ymax,spatialReference:d.spatialReference});y.push(ba(a,
w,r,b,c,g));u+=m}a=yield Promise.all(y);P("esri-2d-profiler")&&G.info("I.8","All calls to _fetchPart (ms)",Math.round(performance.now()-e));P("esri-2d-profiler")&&G.info("I.9","Number of parts",a.length);b={data:new Float32Array(f*b*2),mask:new Uint8Array(f*b),width:f,height:b};d=0;for(const t of a){for(a=0;a<t.height;a++)for(c=0;c<t.width;c++)d+c>=f||(b.data[2*(a*f+d+c)]=t.data[2*(a*t.width+c)],b.data[2*(a*f+d+c)+1]=t.data[2*(a*t.width+c)+1],b.mask[a*f+d+c]=t.mask[a*t.width+c]);d+=t.width}P("esri-2d-profiler")&&
G.info("I.10","loadImagery, general exit (ms)",Math.round(performance.now()-l));return b});return U.apply(this,arguments)}function ba(a,d,f,b,c,g){return V.apply(this,arguments)}function V(){V=S._asyncToGenerator(function*(a,d,f,b,c,g){const l={requestProjectedLocalDirections:!0,signal:g};R.isSome(c)&&(l.timeExtent=c);if("imagery"===a.type)return yield a.load({signal:g}),c=a.rasterInfo.dataType,a=yield a.fetchImage(d,f,b,l),!a||R.isNone(a.pixelData)||R.isNone(a.pixelData.pixelBlock)?{data:new Float32Array(f*
b*2),mask:new Uint8Array(f*b),width:f,height:b}:aa(c,a.pixelData.pixelBlock);yield a.load({signal:g});c=a.rasterInfo.dataType;a=yield a.fetchPixels(d,f,b,l);return!a||R.isNone(a.pixelBlock)?{data:new Float32Array(f*b*2),mask:new Uint8Array(f*b),width:f,height:b}:aa(c,a.pixelBlock)});return V.apply(this,arguments)}const G=ca.getLogger("esri.views.2d.engine.flow.dataUtils");O.createAnimatedLinesData=X;O.createFlowMesh=function(a,d,f,b){return T.apply(this,arguments)};O.createParticlesMesh=Z;O.createStreamlinesMesh=
Y;O.loadImagery=function(a,d,f,b,c,g){return U.apply(this,arguments)};Object.defineProperties(O,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});