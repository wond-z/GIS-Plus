// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/maybe ../../vectorTiles/style/StyleDefinition ../definitions ../enums ../number ./WGLBrush ../../../../webgl/enums".split(" "),function(I,P,x,J,B,F,Q,G,p){const K=1/65536;G=function(L){function H(){var d=L.apply(this,arguments)||this;d._fillProgramOptions={id:!1,pattern:!1};d._outlineProgramOptions={id:!1};return d}P._inheritsLoose(H,L);var C=H.prototype;C.dispose=function(){};C.drawMany=function(d,u){const {displayLevel:k,
drawPhase:c,renderPass:h,spriteMosaic:f,styleLayerUID:m}=d;var a=!1;for(var l of u)if(l.layerData.has(m)){var q=l.layerData.get(m);if(0<q.fillIndexCount||0<q.outlineIndexCount){a=!0;break}}if(a){a=d.styleLayer;var g=a.getPaintProperty("fill-pattern");q=(l=void 0!==g)&&g.isDataDriven;if(l&&!q){var r=g.getValue(k);r=f.getMosaicItemPosition(r,!0)}g=!l&&a.getPaintValue("fill-antialias",k);var y=!0,v=1;if(!l){var w=a.getPaintProperty("fill-color"),z=a.getPaintProperty("fill-opacity");w?.isDataDriven||
z?.isDataDriven||(v=a.getPaintValue("fill-color",k),v=a.getPaintValue("fill-opacity",k)*v[3],1<=v&&(y=!1))}if(!y||"opaque"!==h){var b;c===F.WGLDrawPhase.HITTEST&&(b=Q.u32to4Xu8(m+1));w=a.getPaintValue("fill-translate",k);z=a.getPaintValue("fill-translate-anchor",k);(y||"translucent"!==h)&&this._drawFill(d,m,a,u,w,z,l,r,q,b);r=!a.hasDataDrivenOutlineColor&&a.outlineUsesFillColor&&1>v;g&&"opaque"!==h&&!r&&this._drawOutline(d,m,a,u,w,z,b)}}};C._drawFill=function(d,u,k,c,h,f,m,a,l,q){if(!m||l||!x.isNone(a)){var {context:g,
displayLevel:r,state:y,drawPhase:v,painter:w,pixelRatio:z,spriteMosaic:b,requestRender:D,allowDelayedRender:E}=d;d=k.fillMaterial;var e=w.vectorTilesMaterialManager,t=z>B.VTL_HIGH_RES_CUTOFF?2:1,M=v===F.WGLDrawPhase.HITTEST,A=this._fillProgramOptions;A.id=M;A.pattern=m;e=e.getMaterialProgram(g,d,A);if(E&&x.isSome(D)&&!e.isCompiled)D();else{g.useProgram(e);x.isSome(a)&&({page:a}=a,A=b.getPageSize(a),x.isSome(A)&&(b.bind(g,p.TextureSamplingMode.LINEAR,a,B.VTL_TEXTURE_BINDING_UNIT_SPRITES),e.setUniform2fv("u_mosaicSize",
A),e.setUniform1i("u_texture",B.VTL_TEXTURE_BINDING_UNIT_SPRITES)));e.setUniformMatrix3fv("u_displayMat3",f===J.TranslateAnchor.VIEWPORT?y.displayMat3:y.displayViewMat3);e.setUniform2fv("u_fillTranslation",h);e.setUniform1f("u_depth",k.z+K);M&&e.setUniform4fv("u_id",q);h=-1;for(const n of c)if(n.layerData.has(u)&&(n.key.level!==h&&(h=n.key.level,d.setDataUniforms(e,r,k,h,b)),c=n.layerData.get(u),c.fillIndexCount&&(c.prepareForRendering(g),f=c.fillVertexArrayObject,!x.isNone(f)))){g.bindVAO(f);e.setUniformMatrix3fv("u_dvsMat3",
n.transforms.dvs);g.setStencilFunction(p.CompareFunction.EQUAL,n.stencilRef,255);m&&e.setUniform1f("u_patternFactor",n.rangeX/(t*n.width*Math.max(2**(Math.round(r)-n.key.level),1)));if(l){f=c.patternMap;if(!f)continue;for(const [N,O]of f)f=b.getPageSize(N),x.isSome(f)&&(b.bind(g,p.TextureSamplingMode.LINEAR,N,B.VTL_TEXTURE_BINDING_UNIT_SPRITES),e.setUniform2fv("u_mosaicSize",f),e.setUniform1i("u_texture",B.VTL_TEXTURE_BINDING_UNIT_SPRITES),g.drawElements(p.PrimitiveType.TRIANGLES,O[1],p.DataType.UNSIGNED_INT,
Uint32Array.BYTES_PER_ELEMENT*O[0]))}else g.drawElements(p.PrimitiveType.TRIANGLES,c.fillIndexCount,p.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*c.fillIndexStart);n.triangleCount+=c.fillIndexCount/3}}}};C._drawOutline=function(d,u,k,c,h,f,m){const {context:a,displayLevel:l,state:q,drawPhase:g,painter:r,pixelRatio:y,spriteMosaic:v,requestRender:w,allowDelayedRender:z}=d;d=k.outlineMaterial;var b=r.vectorTilesMaterialManager;const D=.75/y,E=g===F.WGLDrawPhase.HITTEST,e=this._outlineProgramOptions;
e.id=E;b=b.getMaterialProgram(a,d,e);if(z&&x.isSome(w)&&!b.isCompiled)w();else{a.useProgram(b);b.setUniformMatrix3fv("u_displayMat3",f===J.TranslateAnchor.VIEWPORT?q.displayMat3:q.displayViewMat3);b.setUniform2fv("u_fillTranslation",h);b.setUniform1f("u_depth",k.z+K);b.setUniform1f("u_outline_width",D);E&&b.setUniform4fv("u_id",m);h=-1;for(const t of c)t.layerData.has(u)&&(t.key.level!==h&&(h=t.key.level,d.setDataUniforms(b,l,k,h,v)),c=t.layerData.get(u),c.prepareForRendering(a),c.outlineIndexCount&&
(f=c.outlineVertexArrayObject,x.isNone(f)||(a.bindVAO(f),b.setUniformMatrix3fv("u_dvsMat3",t.transforms.dvs),a.setStencilFunction(p.CompareFunction.EQUAL,t.stencilRef,255),a.drawElements(p.PrimitiveType.TRIANGLES,c.outlineIndexCount,p.DataType.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*c.outlineIndexStart),t.triangleCount+=c.outlineIndexCount/3)))}};return H}(G);I.WGLBrushVTLFill=G;Object.defineProperties(I,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});