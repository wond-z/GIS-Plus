// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../../../../chunks/_rollupPluginBabelHelpers ../../../../config ../../../../request ../../../../core/BidiText ../../../../core/Error ../../../../core/fontUtils ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../chunks/vec2 ../../../../chunks/vec2f32 ../../../../symbols/cim/Rasterizer ./definitions ./enums ./GlyphMosaic ./GlyphSource ./SDFConverter ./SpriteMosaic ./Utils ./animatedFormats/AnimatableTextureResource ./util/Result ./util/symbolUtils ../../../support/QueueProcessor ../../../webgl/enums".split(" "),
function(l,D,E,F,n,G,H,x,y,t,z,I,J,u,v,K,L,M,N,h,O,P,Q,R,A){function B(m,g){g=Math.round(t.pt2px(g)*window.devicePixelRatio);return Math.min(m,g*(128<=g?2:4))}const C=I.create(),w=H.getLogger("esri.views.2d.engine.webgl.TextureManager");let S=function(){function m(g,f,a){this.mosaicType=g;this.page=f;this.sdf=a}m.fromMosaic=function(g,f){return new m(g,f.page,f.sdf)};return m}();return function(){function m(f,a){this._requestRender=f;this.resourceManager=a;this._invalidFontsMap=new Map;this._sdfConverter=
new M(126);this._bindingInfos=[];this._hashToBindingIndex=new Map;this._ongoingRasterizations=new Map;this._imageRequestQueue=new R.QueueProcessor({concurrency:10,process:function(){var b=l._asyncToGenerator(function*(c,d){y.throwIfAborted(d);try{return yield E(c,{responseType:"image",signal:d})}catch(e){if(!y.isAbortError(e))throw new n("mapview-invalid-resource",`Could not fetch requested resource at ${c}`,e);throw e;}});return function(c,d){return b.apply(this,arguments)}}()});this._spriteMosaic=
new N(2048,2048,500);this._glyphSource=new L(`${D.fontsUrl}/{fontstack}/{range}.pbf`);this._glyphMosaic=new K(1024,1024,this._glyphSource);this._rasterizer=new J(a)}var g=m.prototype;g.dispose=function(){this._spriteMosaic.dispose();this._glyphMosaic.dispose();this._rasterizer.dispose();this._sdfConverter.dispose();this._sdfConverter=this._glyphMosaic=this._spriteMosaic=null;this._hashToBindingIndex.clear();this._bindingInfos=this._hashToBindingIndex=null;this._ongoingRasterizations.clear();this._ongoingRasterizations=
null;this._imageRequestQueue.clear();this._imageRequestQueue=null};g.rasterizeItem=function(){var f=l._asyncToGenerator(function*(a,b,c,d){if(x.isNone(a))return w.error(new n("mapview-null-resource","Unable to rasterize null resource",void 0)),null;switch(a.type){case "text":case "esriTS":return a=yield this._rasterizeText(a,c,d),a.forEach(e=>this._setTextureBinding(v.MosaicType.GLYPH,e)),{glyphMosaicItems:a};default:if(h.is3D(a))return w.error(new n("mapview-invalid-type",`MapView does not support symbol type: ${a.type}`,
a)),null;a=yield this._rasterizeSpriteSymbol(a,b,d);P.ok(a)&&a&&this._setTextureBinding(v.MosaicType.SPRITE,a);return{spriteMosaicItem:a}}});return function(a,b,c,d){return f.apply(this,arguments)}}();g.bindTextures=function(f,a,b,c=!1){if(0!==b.textureBinding){var d=this._bindingInfos[b.textureBinding-1];b=d.page;c=c?A.TextureSamplingMode.LINEAR_MIPMAP_LINEAR:A.TextureSamplingMode.LINEAR;switch(d.mosaicType){case v.MosaicType.SPRITE:d=this.sprites.getWidth(b);const e=this.sprites.getHeight(b);d=
z.set(C,d,e);this._spriteMosaic.bind(f,c,b,u.TEXTURE_BINDING_SPRITE_ATLAS);a.setUniform1i("u_texture",u.TEXTURE_BINDING_SPRITE_ATLAS);a.setUniform2fv("u_mosaicSize",d);break;case v.MosaicType.GLYPH:d=z.set(C,this.glyphs.width,this.glyphs.height);this._glyphMosaic.bind(f,c,b,u.TEXTURE_BINDING_GLYPH_ATLAS);a.setUniform1i("u_texture",u.TEXTURE_BINDING_GLYPH_ATLAS);a.setUniform2fv("u_mosaicSize",d);break;default:w.error("mapview-texture-manager",`Cannot handle unknown type ${d.mosaicType}`)}}};g._hashMosaic=
function(f,a){return 1|f<<1|(a.sdf?1:0)<<2|a.page<<3};g._setTextureBinding=function(f,a){const b=this._hashMosaic(f,a);this._hashToBindingIndex.has(b)||(f=S.fromMosaic(f,a),this._hashToBindingIndex.set(b,this._bindingInfos.length+1),this._bindingInfos.push(f));a.textureBinding=this._hashToBindingIndex.get(b)};g._rasterizeText=function(){var f=l._asyncToGenerator(function*(a,b,c){let d,e;d="cim"in a?a.fontName:G.getFullyQualifiedFontName(a.font);e=a.text;a=this._invalidFontsMap.has(d);b=b?b:h.charCodes(F.bidiText(e)[0]);
try{return yield this._glyphMosaic.getGlyphItems(a?"arial-unicode-ms-regular":d,b,c)}catch(k){return w.error(new n("mapview-invalid-resource",`Couldn't find font ${d}. Falling back to Arial Unicode MS Regular`,void 0)),this._invalidFontsMap.set(d,!0),this._glyphMosaic.getGlyphItems("arial-unicode-ms-regular",b,c)}});return function(a,b,c){return f.apply(this,arguments)}}();g._rasterizeSpriteSymbol=function(){var f=l._asyncToGenerator(function*(a,b,c){if(h.isSimple(a))return null;b=Q.keyFromSymbol(a);
if(this._spriteMosaic.has(b))return this._spriteMosaic.getSpriteItem(b);if(h.isSVGResource(a)||h.isImageResource(a)&&!h.isMarkerPlacementInsidePolygon(a))return this._handleAsyncResource(b,a,c);if(c=this._rasterizer.rasterizeJSONResource(a,u.PATTERN_FILL_RASTERIZATION_SCALE)){const {size:d,image:e,sdf:k,simplePattern:p,rasterizationScale:q}=c;return this._addItemToMosaic(b,d,{type:"static",data:e},h.shouldRepeat(a),k,p,q)}return new n("TextureManager","unrecognized or null rasterized image")});return function(a,
b,c){return f.apply(this,arguments)}}();g._handleAsyncResource=function(){var f=l._asyncToGenerator(function*(a,b,c){if(this._ongoingRasterizations.has(a))return this._ongoingRasterizations.get(a);b=h.isSVGResource(b)?this._handleSVG(b,a,c):this._handleImage(b,a,c);this._ongoingRasterizations.set(a,b);try{yield b,this._ongoingRasterizations.delete(a)}catch{this._ongoingRasterizations.delete(a)}return b});return function(a,b,c){return f.apply(this,arguments)}}();g._handleSVG=function(){var f=l._asyncToGenerator(function*(a,
b,c){a=yield this._sdfConverter.draw(a.path,c);return this._addItemToMosaic(b,[126,126],{type:"static",data:new Uint32Array(a.buffer)},!1,!0,!0)});return function(a,b,c){return f.apply(this,arguments)}}();g._handleGIFOrPNG=function(){var f=l._asyncToGenerator(function*(a,b,c){var d=h.getUrl(a);yield this.resourceManager.fetchResource(d,c);c=this.resourceManager.getResource(d);if(x.isNone(c))return new n("mapview-invalid-resource",`Could not fetch requested resource at ${d}.`);if(c instanceof HTMLImageElement){d=
c.width;let e=c.height;"esriPMS"===a.type&&(d=Math.round(B(c.width,h.getPMSResourceSize(a))),e=Math.round(d/c.width*c.height));const {size:k,sdf:p,image:q}=this._rasterizer.rasterizeImageResource(d,e,c,"cim"in a?a.cim.colorSubstitutions:void 0);return this._addItemToMosaic(b,k,{type:"static",data:q},h.shouldRepeat(a),p,!1)}c=new O.AnimatableTextureResource(c,this._requestRender,a.animatedSymbolProperties||{},a.objectId);return this._addItemToMosaic(b,[c.width,c.height],{type:"animated",data:c},h.shouldRepeat(a),
!1,!1)});return function(a,b,c){return f.apply(this,arguments)}}();g._handleImage=function(){var f=l._asyncToGenerator(function*(a,b,c){if(h.isGIF(a)||h.isPNG(a))return this._handleGIFOrPNG(a,b,c);const d=h.getUrl(a);try{let e;const k=this.resourceManager.getResource(d);if(x.isSome(k)&&k instanceof HTMLImageElement)e=k;else{const {data:r}=yield this._imageRequestQueue.push(d,{...c});e=r}if(h.isSVGImage(d))if("width"in a&&"height"in a)e.width=t.pt2px(a.width),e.height=t.pt2px(a.height);else if("cim"in
a){const r=a.cim;e.width=t.pt2px(r.width??r.scaleX*r.size);e.height=t.pt2px(r.size)}if(!e.width||!e.height)return null;let p=e.width,q=e.height;"esriPMS"===a.type&&(p=Math.round(B(e.width,h.getPMSResourceSize(a))),q=Math.round(p/e.width*e.height));const {size:T,sdf:U,image:V}=this._rasterizer.rasterizeImageResource(p,q,e,"cim"in a?a.cim.colorSubstitutions:void 0);return this._addItemToMosaic(b,T,{type:"static",data:V},h.shouldRepeat(a),U,!1)}catch(e){if(!y.isAbortError(e))return new n("mapview-invalid-resource",
`Could not fetch requested resource at ${d}. ${e.message}`)}});return function(a,b,c){return f.apply(this,arguments)}}();g._addItemToMosaic=function(f,a,b,c,d,e,k){return this._spriteMosaic.addSpriteItem(f,a,b,c,d,e,k)};l._createClass(m,[{key:"sprites",get:function(){return this._spriteMosaic}},{key:"glyphs",get:function(){return this._glyphMosaic}}]);return m}()});