// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/maybe ../../../../../core/RandomLCG ../definitions ../enums ./WGLGeometryBrushFill ../techniques/utils ../../../../webgl/BufferObject ../../../../webgl/enums ../../../../webgl/FramebufferObject ../../../../webgl/Renderbuffer ../../../../webgl/Texture ../../../../webgl/VertexArrayObject".split(" "),function(z,n,A,p,x,B,t,C,f,D,E,F,G){return function(q){function u(){var a=q.apply(this,arguments)||this;a._dotTextureSize=0;a._dotTextures=
null;a._dotSamplers=new Int32Array([p.TEXTURE_BINDING_RENDERER_0,p.TEXTURE_BINDING_RENDERER_1]);a._dotVAO=null;a._dotDesc={vsPath:"dot/dot",fsPath:"dot/dot",attributes:new Map([["a_pos",0]])};return a}z._inheritsLoose(u,q);var h=u.prototype;h.dispose=function(){q.prototype.dispose.call(this);this._disposeTextures();this._dotFBO=n.disposeMaybe(this._dotFBO);this._dotVAO=n.disposeMaybe(this._dotVAO)};h.getGeometryType=function(){return x.WGLGeometryType.FILL};h.supportsSymbology=function(a){return a===
x.WGLSymbologyType.DOT_DENSITY};h._drawFills=function(a,b,c,d,g,e){const {passOptions:l}=a;n.isSome(l)&&"hittest"===l.type?q.prototype._drawFills.call(this,a,b,c,d,g,e):(c=this._drawDotLocations(a,b,c,g,e),this._drawDotDensity(a,b,c))};h._drawDotDensity=function(a,b,c){const {context:d,painter:g,rendererInfo:e,requestRender:l,allowDelayedRender:v}=a,k=g.materialManager.getProgram(this._dotDesc);if(v&&n.isSome(l)&&!k.isCompiled)l();else{var {rendererSchema:m}=e;t.assertRendererSchema(m,"dot-density");
var r=this._createDotDensityMesh(d,this._dotDesc.attributes,{geometry:[{name:"a_pos",count:2,type:f.DataType.SHORT,divisor:0,normalized:!1,offset:0,stride:4}]});d.setStencilTestEnabled(!0);d.useProgram(k);k.setUniform1f("u_tileZoomFactor",1);k.setUniform1i("u_texture",this._dotSamplers[0]);k.setUniform1f("u_dotSize",Math.max(m.dotSize,1));k.setUniform1f("u_pixelRatio",window.devicePixelRatio);this._setSharedUniforms(k,a,b);d.bindTexture(c,this._dotSamplers[0]);d.bindVAO(r);d.drawArrays(f.PrimitiveType.POINTS,
0,262144)}};h._drawDotLocations=function(a,b,c,d,g){const {context:e,rendererInfo:l,requiredLevel:v}=a,k=e.getViewport();var {rendererSchema:m}=l;t.assertRendererSchema(m,"dot-density");const {dotScale:r,colors:H,activeDots:I,backgroundColor:J,dotValue:K}=m;e.setViewport(0,0,512,512);m=e.getBoundFramebufferObject();const y=this._createFBO(e);e.bindFramebuffer(y);e.setClearColor(0,0,0,0);e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.STENCIL_BUFFER_BIT);e.setStencilTestEnabled(!1);b=1/2**(v-b.key.level);const w=
p.TILE_SIZE,L=w*window.devicePixelRatio*w*window.devicePixelRatio,M=1/b*(1/b);a=r?a.state.scale/r:1;c.setUniform1f("u_tileZoomFactor",b);c.setUniform1f("u_tileDotsOverArea",L/(p.TILE_SIZE*window.devicePixelRatio*p.TILE_SIZE*window.devicePixelRatio));c.setUniformMatrix4fv("u_dotColors",H);c.setUniform4fv("u_isActive",I);c.setUniform4fv("u_dotBackgroundColor",J);c.setUniform1f("u_dotValue",Math.max(1,K*a*M));this._bindDotDensityTextures(e,c,l,w);e.drawElements(f.PrimitiveType.TRIANGLES,d,f.DataType.UNSIGNED_INT,
g);e.setViewport(k.x,k.y,k.width,k.height);e.bindFramebuffer(m);return y.colorTexture};h._createFBO=function(a){if(n.isNone(this._dotFBO)){const b={target:f.TextureType.TEXTURE_2D,pixelFormat:f.PixelFormat.RGBA,dataType:f.PixelType.UNSIGNED_BYTE,samplingMode:f.TextureSamplingMode.NEAREST,wrapMode:f.TextureWrapMode.CLAMP_TO_EDGE,width:512,height:512},c={colorTarget:f.TargetType.TEXTURE,depthStencilTarget:f.DepthStencilTargetType.DEPTH_STENCIL_RENDER_BUFFER},d=new E.Renderbuffer(a,{width:512,height:512,
internalFormat:f.RenderbufferFormat.DEPTH_STENCIL});this._dotFBO=new D.FramebufferObject(a,c,b,d)}return this._dotFBO};h._disposeTextures=function(){if(this._dotTextures){for(let a=0;a<this._dotTextures.length;a++)this._dotTextures[a].dispose();this._dotTextures=null}};h._bindDotDensityTextures=function(a,b,c,d){({rendererSchema:c}=c);t.assertRendererSchema(c,"dot-density");d=this._createDotDensityTextures(a,d,c.seed);b.setUniform1iv("u_dotTextures",this._dotSamplers);for(b=0;b<d.length;b++)a.bindTexture(d[b],
this._dotSamplers[b])};h._createDotDensityMesh=function(a,b,c){if(n.isNone(this._dotVAO)){var d=new Int16Array(524288);for(let g=0;512>g;g++)for(let e=0;512>e;e++)d[2*(e+512*g)]=e,d[2*(e+512*g)+1]=g;d=C.BufferObject.createVertex(a,f.Usage.STATIC_DRAW,d);this._dotVAO=new G.VertexArrayObject(a,b,c,{geometry:d},null)}return this._dotVAO};h._createDotDensityTextures=function(a,b,c){if(this._dotTextureSize!==b||this._seed!==c)this._disposeTextures(),this._dotTextureSize=b,this._seed=c;null===this._dotTextures&&
(c=new A(c),this._dotTextures=[this._allocDotDensityTexture(a,b,c),this._allocDotDensityTexture(a,b,c)]);return this._dotTextures};h._allocDotDensityTexture=function(a,b,c){const d=new Float32Array(b*b*4);for(let g=0;g<d.length;g++)d[g]=c.getFloat();return new F.Texture(a,{wrapMode:f.TextureWrapMode.REPEAT,pixelFormat:f.PixelFormat.RGBA,dataType:f.PixelType.FLOAT,samplingMode:f.TextureSamplingMode.NEAREST,width:b,height:b},d)};return u}(B)});