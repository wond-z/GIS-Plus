// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../chunks/_rollupPluginBabelHelpers ../../../../../core/Error ../../../../../core/Logger ../../../../../core/LRUCache ../../../../../support/arcadeOnDemand ../../../arcade/callExpressionWithFeature ../../../layers/support/cimSymbolUtils".split(" "),function(F,t,m,K,L,M,N,O,r){function G(k,f,g,b){return y.apply(this,arguments)}function y(){y=m._asyncToGenerator(function*(k,f,g,b){switch(k.type){case "simple":case "heatmap":return v.fromBasicRenderer(k,f,g,b);case "map":return H.fromUVRenderer(k,
f,g,b);case "interval":return I.fromCBRenderer(k,f,g,b);case "dictionary":return J.fromDictionaryRenderer(k,f,g,b);case "pie-chart":return z.fromPieChartRenderer(k,f,g,b);case "subtype":return z.fromSubtypes(k,f,g,b)}});return y.apply(this,arguments)}function P(k,f){return A.apply(this,arguments)}function A(){A=m._asyncToGenerator(function*(k,f){const g=k||1;if("number"===typeof g)return(a,d,c)=>g;const b=yield N.createRendererExpression(g,f.spatialReference,f.fields);return(a,d,c)=>O(b,a,{$view:c},
f.geometryType,d)||1});return A.apply(this,arguments)}function Q(){return B.apply(this,arguments)}function B(){B=m._asyncToGenerator(function*(){C||(C=new Promise((k,f)=>F(["../../../layers/features/createSymbolSchema"],k,f)));return C});return B.apply(this,arguments)}const D=L.getLogger("esri/views/2d/engine/webgl/util/Matcher");let v=function(){function k(){this.type="feature";this._defaultResult=null}k.fromBasicRenderer=function(){var g=m._asyncToGenerator(function*(b,a,d,c){const e=new k;b.symbol&&
(b=yield r.expandSymbol(b.symbol,d,c),a=a.createTemplateGroup(b,null),e.setDefault(a));return e});return function(b,a,d,c){return g.apply(this,arguments)}}();k.fromPieChartRenderer=function(){var g=m._asyncToGenerator(function*(b,a,d,c){const e=new k;if(b.markerSymbol){const l=yield r.expandSymbol(b.markerSymbol,d,c);let h;b.fillSymbol&&(h=yield r.expandSymbol(b.fillSymbol,d,c));b=a.createTemplateGroup(l,h);e.setDefault(b)}return e});return function(b,a,d,c){return g.apply(this,arguments)}}();var f=
k.prototype;f.size=function(){return 1};f.getDefault=function(){return this._defaultResult};f.setDefault=function(g){this._defaultResult=g};f.match=function(g,b,a,d,c){return this.getDefault()};f.analyze=function(){var g=m._asyncToGenerator(function*(b,a,d,c,e,l){return null});return function(b,a,d,c,e,l){return g.apply(this,arguments)}}();return k}(),z=function(k){function f(g,b){var a=k.call(this)||this;a._subMatchers=g;a._subtypeField=b;return a}m._inheritsLoose(f,k);f.fromSubtypes=function(){var g=
m._asyncToGenerator(function*(b,a,d,c){const e=new Map,l=[];for(const h in b.renderers){const q=parseInt(h,10),n=G(b.renderers[h],a,d,c).then(p=>e.set(q,p));l.push(n)}yield Promise.all(l);return new f(e,b.subtypeField)});return function(b,a,d,c){return g.apply(this,arguments)}}();f.prototype.match=function(g,b,a,d,c){var e=b.readAttribute(this._subtypeField);return(e=this._subMatchers.get(e))?e.match(g,b,a,d,c):null};return f}(v),I=function(k){function f(b,a,d,c){var e=k.call(this)||this;e.type="interval";
e._intervals=[];e._isMaxInclusive=a;e._fieldIndex=c;e._field=b;e._normalizationInfo=d;return e}m._inheritsLoose(f,k);f.fromCBRenderer=function(){var b=m._asyncToGenerator(function*(a,d,c,e){const {isMaxInclusive:l,normalizationField:h,normalizationTotal:q,normalizationType:n}=a,p=new f(a.field,l,{normalizationField:h,normalizationTotal:q,normalizationType:n},a.fieldIndex),u=yield r.expandSymbol(a.backgroundFillSymbol,c,e);yield Promise.all(a.intervals.map(function(){var w=m._asyncToGenerator(function*(x){var E=
yield r.expandSymbol(x.symbol,c,e);E=yield d.createTemplateGroup(E,u);p.add({min:x.min,max:x.max},E)});return function(x){return w.apply(this,arguments)}}()));if(a=yield r.expandSymbol(a.defaultSymbol,c,e))a=yield d.createTemplateGroup(a,u),p.setDefault(a);return p});return function(a,d,c,e){return b.apply(this,arguments)}}();var g=f.prototype;g.add=function(b,a){this._intervals.push({interval:b,result:a});this._intervals.sort((d,c)=>d.interval.min-c.interval.min)};g.size=function(){return k.prototype.size.call(this)+
this._intervals.length};g.match=function(b,a,d,c,e){if(null==this._fieldIndex&&!this._field)return this.getDefault();b=null!=this._fieldIndex?a.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(a);if(null===b||void 0===b||isNaN(b)||Infinity===b||-Infinity===b)return this.getDefault();for(a=0;a<this._intervals.length;a++){const {interval:l,result:h}=this._intervals[a];d=this._isMaxInclusive?b<=l.max:b<l.max;if(b>=l.min&&d)return h}return this.getDefault()};g._needsNormalization=function(){const b=
this._normalizationInfo;return b&&(b.normalizationField||b.normalizationTotal||b.normalizationType)};g._getValueFromField=function(b){const a=b.readAttribute(this._field);if(!this._needsNormalization()||null==a)return a;const {normalizationField:d,normalizationTotal:c,normalizationType:e}=this._normalizationInfo;b=!!d&&b.readAttribute(d);if(e)switch(e){case "esriNormalizeByField":return(b||void 0)&&a/b;case "esriNormalizeByLog":return Math.log(a)*Math.LOG10E;case "esriNormalizeByPercentOfTotal":return a/
c*100;default:D.error(`Found unknown normalization type: ${e}`)}else D.error("Normalization is required, but no type was set!")};return f}(v),H=function(k){function f(b,a,d){var c=k.call(this)||this;c.type="map";c._nullResult=null;c._resultsMap=new Map;c._fieldsIndex=d;c._fields=b;c._seperator=a||"";return c}m._inheritsLoose(f,k);f.fromUVRenderer=function(){var b=m._asyncToGenerator(function*(a,d,c,e){const l=a.fieldDelimiter,h=[a.field];a.field2&&h.push(a.field2);a.field3&&h.push(a.field3);const q=
yield r.expandSymbol(a.backgroundFillSymbol,c,e),n=new f(h,l,a.fieldIndex);yield Promise.all(a.map.map(function(){var p=m._asyncToGenerator(function*(u){var w=yield r.expandSymbol(u.symbol,c,e);w=yield d.createTemplateGroup(w,q);"\x3cNull\x3e"===u.value?n.setNullResult(w):n.add(u.value,w)});return function(u){return p.apply(this,arguments)}}()));if(a=yield r.expandSymbol(a.defaultSymbol,c,e))a=yield d.createTemplateGroup(a,q),n.setDefault(a);return n});return function(a,d,c,e){return b.apply(this,
arguments)}}();var g=f.prototype;g.setNullResult=function(b){this._nullResult=b};g.add=function(b,a){this._resultsMap.set(b.toString(),a)};g.size=function(){return k.prototype.size.call(this)+this._resultsMap.size};g.match=function(b,a,d,c,e){if(null==this._fieldsIndex&&!this._fields)return this.getDefault();b=null!=this._fieldsIndex?a.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(a);if(null!==this._nullResult&&(null==b||""===b||"\x3cNull\x3e"===b))return this._nullResult;if(null==
b)return this.getDefault();b=b.toString();return this._resultsMap.has(b)?this._resultsMap.get(b):this.getDefault()};g._getValueFromFields=function(b){const a=[];for(const d of this._fields){const c=b.readAttribute(d);null==c||""===c?a.push("\x3cNull\x3e"):a.push(c)}return a.join(this._seperator)};return f}(v),C,J=function(k){function f(b,a,d,c,e,l){var h=k.call(this)||this;h.type="dictionary";h._groupIdCache=new M(100);h._loader=b;h._fieldMap=b.fieldMap;h._symbolFields=b.getSymbolFields();h._templates=
a;h._info=d;h._scaleFn=c;h._schemaUtilsModule=e;h._symbolOptions=l;return h}m._inheritsLoose(f,k);f.fromDictionaryRenderer=function(){var b=m._asyncToGenerator(function*(a,d,c,e){const [{DictionaryLoader:l},h]=yield Promise.all([new Promise((n,p)=>F(["../../../../../renderers/support/DictionaryLoader"],n,p)),Q()]);e=new l(a.url,a.config,a.fieldMap);yield e.fetchResources({spatialReference:c.spatialReference,fields:c.fields});const q=yield P(a.scaleExpression,c);return new f(e,d,c,q,h,a.symbolOptions)});
return function(a,d,c,e){return b.apply(this,arguments)}}();var g=f.prototype;g._analyzeFeature=function(){var b=m._asyncToGenerator(function*(a,d,c,e,l){a=a.readLegacyFeature();const h=this._scaleFn(a,c,e);c=this._attributeHash(a)+"-"+h;const q=this._groupIdCache.get(c);if(q)return q;e=yield this._loader.getSymbolAsync(a,{...e,spatialReference:this._info.spatialReference,abortOptions:l,fields:this._info.fields});e=this._schemaUtilsModule.createSymbolSchema(e,this._symbolOptions);d=r.expandSymbol(e,
this._info,d,l).then(n=>{if("expanded-cim"!==n.type)return D.error(new K("mapview-bad-type",`Found unexpected type ${n.type} in dictionary response`)),null;n.hash+="-"+h;for(const p of n.layers)p.scaleFactor=h,p.templateHash+="-"+h;return this._templates.createTemplateGroup(n,null)});this._groupIdCache.put(c,d,1);return d});return function(a,d,c,e,l){return b.apply(this,arguments)}}();g.analyze=function(){var b=m._asyncToGenerator(function*(a,d,c,e,l,h){a=d.getCursor();for(d=[];a.next();)d.push(this._analyzeFeature(a,
c,e,l,h));return Promise.all(d)});return function(a,d,c,e,l,h){return b.apply(this,arguments)}}();g.match=function(b,a,d,c,e){return null};g._attributeHash=function(b){let a="";for(const d of this._symbolFields){const c=this._fieldMap[d];c&&(a+=b.attributes[c]+"-")}return a};return f}(v);t.DictionaryMatcher=J;t.FeatureMatcher=v;t.IntervalMatcher=I;t.MapMatcher=H;t.SubtypeMatcher=z;t.createMatcher=G;Object.defineProperties(t,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});