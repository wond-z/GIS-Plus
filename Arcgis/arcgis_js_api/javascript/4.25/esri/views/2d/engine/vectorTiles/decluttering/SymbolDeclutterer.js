// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define(["exports","../../../../../chunks/_rollupPluginBabelHelpers","../../../../../core/maybe","./config"],function(w,x,y,z){function A(k,g){if(k.priority-g.priority)return k.priority-g.priority;const a=k.tile.key,b=g.tile.key;return a.world-b.world?a.world-b.world:a.level-b.level?a.level-b.level:a.row-b.row?a.row-b.row:a.col-b.col?a.col-b.col:k.xTile-g.xTile?k.xTile-g.xTile:k.yTile-g.yTile}let B=function(){function k(a,b,l,d,m,n){this._visibleTiles=a;this._symbolRepository=b;this._createCollisionJob=
l;this._assignTileSymbolsOpacity=d;this._symbolLayerSorter=m;this._isLayerVisible=n;this._selectionJob=null;this._selectionJobCompleted=!1;this._collisionJob=null;this._collisionJobCompleted=!1;this._opacityJob=null;this._opacityJobCompleted=!1;this._running=!0}var g=k.prototype;g.setScreenSize=function(a,b){this._screenWidth===a&&this._screenHeight===b||this.restart();this._screenWidth=a;this._screenHeight=b};g.restart=function(){this._selectionJob=null;this._selectionJobCompleted=!1;this._collisionJob=
null;this._collisionJobCompleted=!1;this._opacityJob=null;this._opacityJobCompleted=!1;this._running=!0};g.continue=function(a){this._selectionJob||(this._selectionJob=this._createSelectionJob());if(!this._selectionJobCompleted){var b=performance.now();if(!this._selectionJob.work(a))return!1;this._selectionJobCompleted=!0;a=Math.max(0,a-(performance.now()-b));if(0===a)return!1}this._collisionJob||(this._collisionJob=this._createCollisionJob(this._selectionJob.sortedSymbols,this._screenWidth,this._screenHeight));
if(!this._collisionJobCompleted){b=performance.now();if(!this._collisionJob.work(a))return!1;this._collisionJobCompleted=!0;a=Math.max(0,a-(performance.now()-b));if(0===a)return!1}this._opacityJob||(this._opacityJob=this._createOpacityJob());if(!this._opacityJobCompleted){b=performance.now();if(!this._opacityJob.work(a))return!1;this._opacityJobCompleted=!0;a=Math.max(0,a-(performance.now()-b));if(0===a)return!1}this._running=!1;return!0};g._createSelectionJob=function(){const a=this._symbolRepository.uniqueSymbols;
for(let e=0;e<a.length;e++){const h=a[e];for(let c=0;c<h.uniqueSymbols.length;c++){const p=h.uniqueSymbols[c];for(const f of p.tileSymbols)f.selectedForRendering=!1}}const b=[];let l=0,d=0;const m=this._isLayerVisible,n=this._symbolLayerSorter;return{work:function(e){const h=performance.now();for(;d<a.length;d++,l=0){const p=a[d];var c=p.styleLayerUID;if(!m(c)){b[d]||(b[d]={styleLayerUID:c,symbols:[]});continue}b[d]=b[d]||{styleLayerUID:c,symbols:[]};const f=b[d];for(;l<p.uniqueSymbols.length;l++){c=
p.uniqueSymbols[l];if(99===l%100&&performance.now()-h>e)return!1;let r=null,u=!1,v=!1;for(const t of c.tileSymbols)if(!v||!u){const q=t.tile;if(!r||q.isCoverage||q.neededForCoverage&&!u){r=t;if(q.neededForCoverage||q.isCoverage)v=!0;q.isCoverage&&(u=!0)}}r.selectedForRendering=!0;if(v){f.symbols.push(r);c.show=!0;for(const t of c.parts)t.show=!0}else c.show=!1}}for(const p of b)p.symbols.sort(A);return!0},get sortedSymbols(){return b.sort(n)}}};g._createOpacityJob=function(){function a(m,n){var e=
m.symbols;for(const [,c]of e){var h=c;e=n;for(const p of h){h=p.unique;for(const f of h.parts)f.startOpacity+=(e-f.startTime)/z.FADE_DURATION*(.5<f.targetOpacity?1:-1),f.startOpacity=Math.min(Math.max(f.startOpacity,0),1),f.startTime=e,f.targetOpacity=h.show&&f.show?1:0}}b(m,n);for(const c of m.childrenTiles)a(c,n)}const b=this._assignTileSymbolsOpacity,l=this._visibleTiles;let d=0;return{work(m){const n=performance.now();for(;d<l.length;d++){if(performance.now()-n>m)return!1;const e=l[d];if(y.isSome(e.parentTile))continue;
const h=performance.now();a(e,h)}return!0}}};x._createClass(k,[{key:"running",get:function(){return this._running}}]);return k}();w.SymbolDeclutterer=B;Object.defineProperties(w,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});