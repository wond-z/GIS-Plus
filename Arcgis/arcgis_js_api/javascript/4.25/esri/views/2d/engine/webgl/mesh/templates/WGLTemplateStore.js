// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../../../chunks/_rollupPluginBabelHelpers ../../../../../../core/Error ../../../../../../core/Logger ../../../../../../core/promiseUtils ../../../../../../symbols/support/defaultsJSON ../../enums ../../materialKey/MaterialKey ./WGLDynamicFillTemplate ./WGLDynamicLineTemplate ./WGLDynamicMarkerTemplate ./WGLDynamicTextTemplate ./WGLFillTemplate ./WGLLineTemplate ./WGLMarkerTemplate ./WGLTextTemplate ../../util/Lock ../../util/Result ../../../../layers/features/textUtils ../../../../layers/support/cimSymbolUtils".split(" "),
function(p,f,G,q,H,n,r,v,I,J,K,L,w,y,t,z,A,h,M,u){function l(k,e){const b=k.length;k.push(null);e.then(a=>k[b]=a);return k}function B(k){return!!(k&1)}const g=q.getLogger("esri.views.2d.engine.webgl.mesh.templates.WGLTemplateStore"),C=[];q={isOutline:!1,placement:null,symbologyType:r.WGLSymbologyType.DEFAULT,vvFlags:0};const D={...n.errorPointSymbolJSON,hash:JSON.stringify(n.errorPointSymbolJSON),materialKey:v.createMaterialKey(r.WGLGeometryType.MARKER,q)},E={...n.errorPolylineSymbolJSON,hash:JSON.stringify(n.errorPolylineSymbolJSON),
materialKey:v.createMaterialKey(r.WGLGeometryType.LINE,q)},F={...n.errorPolygonSymbolJSON,hash:JSON.stringify(n.errorPolygonSymbolJSON),materialKey:v.createMaterialKey(r.WGLGeometryType.FILL,q)};n=function(){function k(b,a){this._templateIdCounter=this._idCounter=1;this._idToTemplateGroup=new Map;this._symbolToTemplate=new Map;this._fetchQueue=[];this._idToResolver=new Map;this._cimTemplateCache=new Map;this._cimAnalyses=[];this._lock=new A.Lock;this._fetchResource=b;this._tileInfo=a}var e=k.prototype;
e.createTemplateGroup=function(b,a){this._initErrorTemplates();const c=b.hash;if(this._symbolToTemplate.has(c))return this._symbolToTemplate.get(c);const d=[];a&&this._createMeshTemplates(d,a,!0);this._createMeshTemplates(d,b,!1);a=this._createGroupId;var m;if(m="expanded-cim"===b.type)a:{if(b.layers)for(const x of b.layers)if("function"===typeof x.materialHash){m=!0;break a}m=!1}b=a.call(this,m);this._idToTemplateGroup.set(b,d);this._symbolToTemplate.set(c,b);return b};e.getTemplateGroup=function(b){return this._idToTemplateGroup.has(b)?
this._idToTemplateGroup.get(b):C};e.getDynamicTemplateGroup=function(b){if(!this._idToTemplateGroup.has(b))return C;B(b)||g.error("mapview-template-store",`Id ${b} does not refer to a dynamic template`);return this._idToTemplateGroup.get(b)};e.getMosaicItem=function(b,a){const c=this._createTemplateId(),d=new Promise(m=>this._idToResolver.set(c,m));this._fetchQueue.push({symbol:b,id:c,glyphIds:a});return d};e.finalize=function(b){return this._fetchQueue.length||this._lock.isHeld()?A.withLock(this._lock,
this._fetchAllQueuedResources.bind(this),b):Promise.resolve()};e._initErrorTemplates=function(){this._errorTemplates||(this._errorTemplates={fill:this._createMeshTemplates([],F,!1),marker:this._createMeshTemplates([],D,!1),line:this._createMeshTemplates([],E,!1)})};e._fetchAllQueuedResources=function(b){if(!this._fetchQueue.length)return Promise.resolve();const a=this._fetchQueue,c=this._cimAnalyses;this._fetchQueue=[];this._cimAnalyses=[];return Promise.all(c).then(()=>this._fetchResource(a,b).then(d=>
{for(const {id:m,mosaicItem:x}of d)this._idToResolver.get(m)(x),this._idToResolver.delete(m)})).catch(d=>{H.isAbortError(d)?this._fetchQueue=this._fetchQueue.concat(a):"worker:port-closed"!==d.name&&g.error(new G("mapview-template-store","Unable to fetch requested texture resources",d))})};e._createGroupId=function(b){return this._idCounter++<<1|(b?1:0)};e._createTemplateId=function(){return this._templateIdCounter++};e._createSMS=function(){var b=f._asyncToGenerator(function*(a){const {spriteMosaicItem:c}=
yield this.getMosaicItem(a);return h.ok(c,g)?t.fromSimpleMarker(a,c):this._markerError});return function(a){return b.apply(this,arguments)}}();e._createPMS=function(){var b=f._asyncToGenerator(function*(a){const {spriteMosaicItem:c}=yield this.getMosaicItem(a);return h.ok(c,g)?t.fromPictureMarker(a,c):this._markerError});return function(a){return b.apply(this,arguments)}}();e._createSFS=function(){var b=f._asyncToGenerator(function*(a,c){const {spriteMosaicItem:d}=yield this.getMosaicItem(a);return h.ok(d,
g)?w.fromSimpleFill(a,d,c):this._fillError});return function(a,c){return b.apply(this,arguments)}}();e._createPFS=function(){var b=f._asyncToGenerator(function*(a,c){const {spriteMosaicItem:d}=yield this.getMosaicItem(a);return h.ok(d,g)?w.fromPictureFill(a,d,c):this._fillError});return function(a,c){return b.apply(this,arguments)}}();e._createSLS=function(){var b=f._asyncToGenerator(function*(a,c){({spriteMosaicItem:c}=yield this.getMosaicItem(a));return h.ok(c,g)?y.fromSimpleLine(a,c):this._lineError});
return function(a,c){return b.apply(this,arguments)}}();e._createLMS=function(){var b=f._asyncToGenerator(function*(a){const {spriteMosaicItem:c}=yield this.getMosaicItem(a);return h.ok(c,g)?t.fromLineSymbolMarker(a,c):this._markerError});return function(a){return b.apply(this,arguments)}}();e._createTS=function(){var b=f._asyncToGenerator(function*(a){const {glyphMosaicItems:c}=yield this.getMosaicItem(a);return z.fromText(a,c)});return function(a){return b.apply(this,arguments)}}();e._createCIMText=
function(){var b=f._asyncToGenerator(function*(a){const {glyphMosaicItems:c}=yield this.getMosaicItem(u.cimLayerToRasterizationInfo(a),M.codepoints(a.text));return h.ok(c,g)?z.fromCIMText(a,c,this._tileInfo):this._textError});return function(a){return b.apply(this,arguments)}}();e._createCIMFill=function(){var b=f._asyncToGenerator(function*(a){const {spriteMosaicItem:c}=yield this.getMosaicItem(u.cimLayerToRasterizationInfo(a));return h.ok(c,g)?w.fromCIMFill(a,c,this._tileInfo):this._fillError});
return function(a){return b.apply(this,arguments)}}();e._createCIMLine=function(){var b=f._asyncToGenerator(function*(a){const {spriteMosaicItem:c}=yield this.getMosaicItem(u.cimLayerToRasterizationInfo(a));return h.ok(c,g)?y.fromCIMLine(a,c,this._tileInfo):this._lineError});return function(a){return b.apply(this,arguments)}}();e._createCIMMarker=function(){var b=f._asyncToGenerator(function*(a){const {spriteMosaicItem:c}=yield this.getMosaicItem(u.cimLayerToRasterizationInfo(a));return h.ok(c,g)?
t.fromCIMMarker(a,c,this._tileInfo):this._markerError});return function(a){return b.apply(this,arguments)}}();e._createCIM=function(){var b=f._asyncToGenerator(function*(a){const c=a.templateHash;if(this._cimTemplateCache.has(c))return this._cimTemplateCache.get(c);let d;switch(a.type){case "marker":d=yield this._createCIMMarker(a);break;case "line":d=yield this._createCIMLine(a);break;case "fill":d=yield this._createCIMFill(a);break;case "text":d=yield this._createCIMText(a)}this._cimTemplateCache.set(c,
d);return d});return function(a){return b.apply(this,arguments)}}();e._createDynamicCIM=function(){var b=f._asyncToGenerator(function*(a){const c=a.templateHash;if(this._cimTemplateCache.has(c))return this._cimTemplateCache.get(c);let d;switch(a.type){case "marker":d=K.fromCIMMarker(a,this._tileInfo);break;case "line":d=J.fromCIMLine(a,this._tileInfo);break;case "fill":d=I.fromCIMFill(a,this._tileInfo);break;case "text":d=L.fromCIMText(a,this._tileInfo)}this._cimTemplateCache.set(c,d);return d});
return function(a){return b.apply(this,arguments)}}();e._createPrimitiveMeshTemplates=function(b,a,c){switch(a.type){case "esriSMS":return l(b,this._createSMS(a));case "esriPMS":return l(b,this._createPMS(a));case "esriSFS":return l(b,this._createSFS(a,c));case "line-marker":return l(b,this._createLMS(a));case "esriPFS":return l(b,this._createPFS(a,c));case "esriSLS":return l(b,this._createSLS(a,!1));case "esriTS":return l(b,this._createTS(a));default:return g.error("Unable to create mesh template for unknown symbol type {: $ }{symbol.type}"),
b}};e._createMeshTemplates=function(b,a,c){if(a.type.includes("3d"))return g.error("3D symbols are not supported with MapView"),b;if("expanded-cim"===a.type){for(const d of a.layers)"function"===typeof d.materialHash?l(b,this._createDynamicCIM(d)):l(b,this._createCIM(d));return b}if("composite-symbol"===a.type){for(const d of a.layers)this._createPrimitiveMeshTemplates(b,d,c);return b}return"cim"===a.type||"label"===a.type||"web-style"===a.type?b:this._createPrimitiveMeshTemplates(b,a,c)};f._createClass(k,
[{key:"_markerError",get:function(){return this._errorTemplates.marker[0]}},{key:"_fillError",get:function(){return this._errorTemplates.fill[0]}},{key:"_lineError",get:function(){return this._errorTemplates.line[0]}},{key:"_textError",get:function(){return this._errorTemplates.line[0]}}]);return k}();p.WGLTemplateStore=n;p.errorPointSchema2D=D;p.errorPolygonSchema2D=F;p.errorPolylineSchema2D=E;p.isDynamicId=B;Object.defineProperties(p,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});