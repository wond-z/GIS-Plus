// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../intl ../../../core/Error ../../../core/lang ../../../core/Logger ../../../core/maybe ../../../core/unitUtils ../../../geometry/Polygon ../../../rest/support/FullTextSearch ./geometryUtils ../../../intl/substitute ../../../intl/date".split(" "),function(E,P,ia,w,Q,R,S,T,U,H,I,V,W){function J(a,c){const {filter:b,withinViewEnabled:h}=a;a=c&&c.extent;return b&&b.geometry||(h&&a?a:void 0)}function K(a){return F.apply(this,arguments)}function F(){F=
P._asyncToGenerator(function*(a){a&&(yield a.load())});return F.apply(this,arguments)}function L(a,c){return(a=a?.indexes)&&c?.length?a.filter(b=>"FullText"===b.indexType).some(b=>{const h=b.fields?.split(",").map(k=>k.trim().toLowerCase())||[];return c.every(k=>h.includes(k.toLowerCase()))}):!1}function M(a){return a?.fieldsIndex?.fields?.find(c=>"string"===c.type)?.name??""}function C(a,c){return a&&c?.length?c.every(b=>!!a.getField(b)):!1}function X(a,c,b){let h=null;({codedValues:a}=a);a&&a.some(k=>
{var l=k.name;l=b?l:l.toLowerCase();return(b?c:c.toLowerCase())===l?(h=k.code.toString(),!0):!1});return h}function A(a,c){return(c=c&&c.where)?`(${a}) AND (${c})`:a}function Y({currentTerm:a,field:c,filter:b,exactMatch:h,url:k,type:l}){var d=c.type;c=c.name;if("string"===d||"date"===d||"global-id"===d){if(d=k=Z.test(k))a:{for(d=0;d<a.length;d++)if(255<a.charCodeAt(d)){d=!0;break a}d=!1}d=d?"N":"";if(h&&"search"===l)return A(`${c} = ${d}'${a}'`,b);if(k)return A(`${c} LIKE ${d}${`'${a}%'`}`,b);h=`LOWER(${c})`;
a=a.toLowerCase();return A(`${h} LIKE ${d}${`'${a}%'`}`,b)}return"oid"===d||"small-integer"===d||"integer"===d||"single"===d||"double"===d?(a=Number(a),isNaN(a)?null:A(`${c} = ${a}`,b)):A(`${c} = ${a}`,b)}function N({searchTerm:a,layer:c,searchFields:b,filter:h,exactMatch:k,query:l,type:d}){const {definitionExpression:p,url:t}=c;let g="";!l.fullText&&a&&b&&b.forEach(f=>{var q=c.getField(f);f=((f="function"===typeof c.getFieldDomain&&c.getFieldDomain(f))&&"coded-value"===f.type?X(f,a,k):null)||a||
null;null!==f&&(q=Y({currentTerm:f,field:q,filter:h,exactMatch:k,url:t,type:d}))&&(g+=g?` OR (${q})`:`(${q})`)});return p&&g?`(${p}) AND (${g})`:p||g}function aa(a,c){let b=null;({codedValues:a}=a);a&&a.length&&a.some(h=>h.code===c?(b=h.name,!0):!1);return b}function ba(a,c){return a[Object.keys(a).find(b=>b.toLowerCase()===c.toLowerCase())]}function O(a,c,b){const h=a.sourceLayer,{attributes:k}=a;a="function"===typeof h.getFieldDomain&&h.getFieldDomain(b);return c?V.substitute(c,k):b&&k?(c=h.getField(b),
b=ba(k,b),null==b?"":a&&"coded-value"===a.type?aa(a,b):"date"===c?.type?W.formatDate(new Date(b)):"number"===typeof b?b.toString():"string"!==typeof b?"":b.trim()):""}function ca(a,c,b,h){return a.features.map(k=>{var l=k.sourceLayer,{attributes:d}=k;({objectIdField:l}=l);d=d[l];return{text:O(k,c.suggestionTemplate,h),key:d,sourceIndex:b}})}function da(a,c,b,h,k,l,d){return a.features.map(p=>{const t=p.clone();var g=p.sourceLayer;g=(g=g&&g.objectIdField)&&p.attributes[g];const f=O(p,b.searchTemplate,
k);var q=I.createExtentFromGeometry(t.geometry,c,l);q="number"===typeof d?I.scaleExtent(Q.clone(q),c,d):q;p=p.clone();S.isSome(q)&&(p.geometry=U.fromExtent(q));return{extent:q,target:p,feature:t,key:g,name:f,sourceIndex:h}})}const Z=/https?:\/\/services.*\.arcgis\.com/i,ea=/(?:\{([^}]+)\})/g,x=R.getLogger("esri.widgets.Search.support.layerSearchUtils");E.getResults=function(a,c){const {exactMatch:b=!1,location:h,maxResults:k,spatialReference:l,source:d,sourceIndex:p,suggestResult:t,view:g}=a,{layer:f,
filter:q,zoomScale:D}=d,y=g&&g.scale,v=J(d,g),u=c&&c.signal;return K(f).then(()=>{const e=f.popupTemplate;return e?e.getRequiredFields(f.fieldsIndex):null}).then(e=>{const {objectIdField:m,returnZ:G}=f,z=d.displayField||d.layer.displayField||M(d.layer);if(!f.getField(z))throw x.error("invalid-field: displayField is invalid."),new w("getResults():invalid-field","displayField is invalid.");e=e&&e.length?e:[z];var n=d.outFields||e;e=n&&n.includes("*");n.includes(m)||e||n.push(m);f.floorInfo?.floorField&&
n.push(f.floorInfo.floorField);if(!e&&!C(f,n))throw x.error("invalid-field: outField is invalid."),new w("getResults():invalid-field","outField is invalid.");e=f.createQuery();var {orderByFields:r}=d;r&&(e.orderByFields=r);l&&(e.outSpatialReference=l,r=1/T.getMetersPerUnitForSR(l))&&(e.maxAllowableOffset=r);r="mesh"===f.geometryType||"multipatch"===f.geometryType;e.returnZ=f.capabilities?.data?.supportsZ&&!r&&!1!==G;e.returnGeometry=!0;e.multipatchOption=r?"xyFootprint":null;n&&(e.outFields=n);if(h)e.geometry=
h;else if(t.key)e.objectIds=[t.key];else{n=d.searchFields||[z];if(!C(f,n))throw x.error("invalid-field: search field is invalid."),new w("getResults():invalid-field","search field is invalid.");(f?.capabilities?.query?.supportsPagination??!1)&&(e.num=k);v&&(e.geometry=v);if(!t.text.trim())return[];r=t.text;const {prefix:B="",suffix:fa=""}=d,ha=`${B}${r}${fa}`.replace(/'/g,"''");(f?.capabilities?.query?.supportsFullTextSearch??!1)&&L(f,n)&&!b&&r&&(e.fullText=[new H({onFields:n,searchTerm:r,searchType:"prefix"})]);
n=N({searchTerm:ha,layer:f,searchFields:n,filter:q,exactMatch:b,query:e,type:"search"});e.where=n;if(!e.fullText&&!e.where)return[]}return f.queryFeatures(e,{signal:u}).then(B=>da(B,g,d,p,z,y,D))})};E.getSuggestions=function(a,c){const {source:b,spatialReference:h,view:k,suggestTerm:l,maxSuggestions:d,sourceIndex:p,exactMatch:t}=a,{layer:g,filter:f}=b,q=c&&c.signal,D=J(b,k);return K(g).then(()=>{if(!(g?.capabilities?.query?.supportsPagination??!1))return[];const y=b.displayField||b.layer.displayField||
M(b.layer);var v=b.searchFields||[y];const u=[];b.suggestionTemplate?b.suggestionTemplate.replace(ea,(r,B)=>{u.push(B);return r}):u.push(y);var e=u&&u.includes("*");u.includes(g.objectIdField)||e||u.push(g.objectIdField);var m=!!g.getField(y);e=e||C(g,u);const G=C(g,v);if(!m)throw x.error("invalid-field: displayField is invalid."),new w("getSuggestions():invalid-field","displayField is invalid.");if(!e)throw x.error("invalid-field: outField is invalid."),new w("getSuggestions():invalid-field","outField is invalid.");
if(!G)throw x.error("invalid-field: search field is invalid."),new w("getSuggestions():invalid-field","search field is invalid.");m=g.createQuery();({orderByFields:e}=b);e&&(m.orderByFields=e);m.outSpatialReference=h;m.returnGeometry=!1;m.num=d;m.outFields=u;D&&(m.geometry=D);if(!l.trim())return[];const {prefix:z="",suffix:n=""}=b;e=`${z}${l}${n}`.replace(/'/g,"''");(g?.capabilities?.query?.supportsFullTextSearch??!1)&&L(g,v)&&!t&&l&&(m.fullText=[new H({onFields:v,searchTerm:l,searchType:"prefix"})]);
v=N({searchTerm:e,layer:g,searchFields:v,filter:f,exactMatch:t,query:m,type:"suggest"});m.where=v;return m.fullText||m.where?g.queryFeatures(m,{signal:q}).then(r=>ca(r,b,p,y)):[]})};Object.defineProperties(E,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});