// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../Graphic ../../../core/Accessor ../../../core/arrayUtils ../../../core/Collection ../../../core/Error ../../../core/lang ../../../core/Logger ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../rest/support/AttachmentQuery".split(" "),function(g,l,C,k,v,y,q,D,E,m,J,F,G){function z(w,r,e){H.error(new q(w,r,e))}const H=
E.getLogger("esri.widgets.FeatureTable.support.FeatureStore");k=function(w){function r(a){a=w.call(this,a)||this;a._loaded=!1;a._loadError=!1;a._loading=!1;a._editOperationQueue=[];a._queryOperationQueue=[];a._objectIdCache=new y;a._hasStaleCache=!1;a.count=0;a.failures=new y;a.itemCache=new y;a.relatedRecordsEnabled=!1;return a}g._inheritsLoose(r,w);var e=r.prototype;e.destroy=function(){this.layer=null;this.itemCache&&this.itemCache.destroy();this.failures&&this.failures.destroy();this._set("itemCache",
null)};e.load=function(){var a=g._asyncToGenerator(function*(){this._reset();const {layer:b}=this;if(b){this._loading=!0;this.notifyChange("state");try{yield b.when(),yield this._syncLayerInfo(),this._loading=!1,this._loaded=!0,this.notifyChange("state")}catch(c){throw this._reset(),this._loadError=!0,this.notifyChange("state"),z("store:load-error","An error ocurred.",{error:c}),c;}}});return function(){return a.apply(this,arguments)}}();e.refreshLayerInfo=function(){var a=g._asyncToGenerator(function*(){return this._syncLayerInfo()});
return function(){return a.apply(this,arguments)}}();e.addItems=function(){var a=g._asyncToGenerator(function*(b){});return function(b){return a.apply(this,arguments)}}();e.fetchItems=function(){var a=g._asyncToGenerator(function*(b){const {page:c,pageSize:d}=b;b=c*d;const f=b+d,{layer:h,state:p}=this;if(!h||"loaded"!==p)return[];this.notifyChange("querying");b=yield this._query({start:b,num:f,page:c,pageSize:d});this.notifyChange("state");return b});return function(b){return a.apply(this,arguments)}}();
e.verifyFeaturesByObjectId=function(){var a=g._asyncToGenerator(function*(b){const {layer:c,state:d}=this;if(!c||"loaded"!==d)return[];const {features:f}=yield this._verifyFeaturesByObjectId(b);return b.map(h=>f.some(p=>p?.getObjectId()===h))});return function(b){return a.apply(this,arguments)}}();e.query=function(){var a=g._asyncToGenerator(function*(b){const {layer:c,state:d}=this;if(!c||"loaded"!==d)return[];this.notifyChange("querying");b=yield this._query(b);this.notifyChange("state");return b});
return function(b){return a.apply(this,arguments)}}();e.removeItemAt=function(){var a=g._asyncToGenerator(function*(b){});return function(b){return a.apply(this,arguments)}}();e.reset=function(){var a=g._asyncToGenerator(function*(){this._reset()});return function(){return a.apply(this,arguments)}}();e.updateItem=function(){var a=g._asyncToGenerator(function*(b){return this._update(b).then(()=>{})});return function(b){return a.apply(this,arguments)}}();e.deleteRowsByObjectId=function(){var a=g._asyncToGenerator(function*(b){return this._delete({objectIds:b})});
return function(b){return a.apply(this,arguments)}}();e.getLocalItemByKey=function(a){return this.getItemByObjectId(a)};e.getItemByObjectId=function(a){const {itemCache:b,layer:{objectIdField:c}}=this;return b.find(d=>d.feature.attributes[c]===a)};e.getLocalItemAt=function(a){return this.itemCache.getItemAt(a)};e.getItemAt=function(a){return Promise.resolve(this.itemCache.getItemAt(a))};e.getObjectIdIndex=function(a){const {itemCache:b,layer:{objectIdField:c}}=this;return b.findIndex(d=>d.feature.attributes[c]===
a)};e._reset=function(){this.itemCache.removeAll();this.failures.removeAll();this._editOperationQueue=[];this._queryOperationQueue=[];this._loadError=this._loaded=this._loading=this._hasStaleCache=!1;this._set("count",0);this._objectIdCache.removeAll();this.notifyChange("querying");this.notifyChange("syncing");this.notifyChange("state")};e._getIdsFromFeatures=function(a){return a.map(b=>b.attributes[this.layer.objectIdField])};e._toFeatureData=function(a,b){const {layer:{objectIdField:c}}=this;return a.map(d=>
{var {attributes:f}=d;f=f[c];return{objectId:f,feature:d,attachments:b?b[f]:null,relatedRecords:null}})};e._update=function(){var a=g._asyncToGenerator(function*(b){const {layer:c}=this,{operations:d}=c.capabilities;if(!(d.supportsUpdate&&"applyEdits"in c))throw new q("store:update-error","Update is not supported.");const {index:f,name:h,value:p}=b;b=yield this.getItemAt(f);if(!b||!b.feature)throw new q("store:update-error","Feature with provided 'objectId' not found.");const {feature:n}=b,t=D.clone(n.attributes);
t[h]=p;b=new C({attributes:t});const x=c.applyEdits({updateFeatures:[b]}).then(u=>{const {updateFeatureResults:A}=u,B=A.find(I=>!!I.error);if(B)throw B.error;A.length&&(n.attributes=t);return u});return this._queueEditOperation(()=>x)});return function(b){return a.apply(this,arguments)}}();e._delete=function(){var a=g._asyncToGenerator(function*(b){const {layer:c}=this,{operations:d}=c.capabilities;if(!(d.supportsDelete&&"applyEdits"in c))throw new q("store:delete-error","Delete is not supported.");
({objectIds:b}=b);const f=b.map(h=>this.getItemByObjectId(h).feature);return this._queueEditOperation(()=>c.applyEdits({deleteFeatures:f}))});return function(b){return a.apply(this,arguments)}}();e._query=function(){var a=g._asyncToGenerator(function*(b){const {refresh:c}=b;if(!0===c)return this.itemCache.removeAll(),this._syncLayerInfo().then(()=>this._queryFeatureData(b));this._hasStaleCache&&(yield this._updateIds(),this._hasStaleCache=!1);return this._queryFeatureData(b)});return function(b){return a.apply(this,
arguments)}}();e._queryFeatureData=function(){var a=g._asyncToGenerator(function*(b){var c=this;return this._queueQueryOperation(g._asyncToGenerator(function*(){const {features:d}=yield c._queryFeatures(b);var f=c._getIdsFromFeatures(d);f=yield c._queryAttachments(f);return c._toFeatureData(d,f)||[]}))});return function(b){return a.apply(this,arguments)}}();e._syncLayerInfo=function(){var a=g._asyncToGenerator(function*(){yield this._updateCount();yield this._updateIds()});return function(){return a.apply(this,
arguments)}}();e._updateCount=function(){var a=g._asyncToGenerator(function*(){yield this._queryCount().then(b=>this._set("count",b))});return function(){return a.apply(this,arguments)}}();e._updateIds=function(){var a=g._asyncToGenerator(function*(){this.layer?.capabilities?.query?.supportsPagination||(this._objectIdCache.removeAll(),yield this._queryForObjectIds().then(b=>this._objectIdCache.addMany(b)))});return function(){return a.apply(this,arguments)}}();e._queryCount=function(){const {filterGeometry:a,
layer:b}=this,{capabilities:{query:{supportsCacheHint:c}}}=b,d=b.createQuery();d.geometry=a;d.returnGeometry=!1;d.where=this._getWhere();d.timeExtent=this._getTimeExtent();d.objectIds=this.objectIds;c&&(d.cacheHint=!0);return b.queryFeatureCount(d)};e._queryForObjectIds=function(){const {filterGeometry:a,layer:b,orderByFields:c}=this,{capabilities:{query:{supportsCacheHint:d,supportsOrderBy:f}}}=b,h=b.createQuery();h.geometry=a;h.outFields=[b.objectIdField];h.returnGeometry=!1;h.where=this._getWhere();
h.timeExtent=this._getTimeExtent();h.objectIds=this.objectIds;f&&(h.orderByFields=c);d&&(h.cacheHint=!0);return b.queryObjectIds(h)};e._queryFeatures=function(){var a=g._asyncToGenerator(function*(b){const {layer:c}=this;if(!c.capabilities.operations.supportsQuery)throw new q("store:query-error","Layer does not support query operation.");const {filterGeometry:d,layer:{capabilities:{query:{supportsCacheHint:f,supportsOrderBy:h,supportsPagination:p}}},orderByFields:n,returnGeometry:t}=this,{start:x,
pageSize:u}=b;b=c.createQuery();b.returnGeometry=t;p?(b.start=x,b.num=u,b.where=this._getWhere(),b.timeExtent=this._getTimeExtent(),b.objectIds=this.objectIds):b.objectIds=this.objectIds||this._getObjectIdsForPage(x,u);h&&(b.orderByFields=n);d&&(b.geometry=d);f&&(b.cacheHint=!0);return c.queryFeatures(b)});return function(b){return a.apply(this,arguments)}}();e._verifyFeaturesByObjectId=function(){var a=g._asyncToGenerator(function*(b){const {layer:c}=this;if(!c.capabilities.operations.supportsQuery)throw new q("store:query-error",
"Layer does not support query operation.");const {filterGeometry:d,layer:{capabilities:{query:{supportsCacheHint:f,supportsOrderBy:h}}},orderByFields:p}=this,n=c.createQuery();n.where=this._getWhere();n.timeExtent=this._getTimeExtent();n.returnGeometry=!1;n.objectIds=b;n.outFields=[c.objectIdField];h&&(n.orderByFields=p);d&&(n.geometry=d);f&&(n.cacheHint=!0);return c.queryFeatures(n)});return function(b){return a.apply(this,arguments)}}();e._getObjectIdsForPage=function(a,b){const c=this._objectIdCache.toArray();
return c.length>=a+b?c.slice(a,a+b):c.slice(a)};e._queryAttachments=function(a){const {attachmentsEnabled:b,layer:c}=this,{capabilities:{data:{supportsAttachment:d},operations:{supportsQueryAttachments:f}}}=c;return b&&d&&f&&"queryAttachments"in c?c.queryAttachments(new G({objectIds:a,where:this._getWhere()})):Promise.resolve(null)};e._queueQueryOperation=function(a){this._queryOperationQueue.push(a);this.notifyChange("querying");return a().then(b=>this._queryOperationQueue.includes(a)?(this.itemCache.addMany(b),
b):[]).catch(b=>{z("store:query-error","An error ocurred.",{error:b});const c={error:b,retry:()=>{this.failures.remove(c);this._queueQueryOperation(a)},cancel:()=>this.failures.remove(c)};this.failures.add(c);return[]}).then(b=>{v.remove(this._queryOperationQueue,a);this.notifyChange("querying");return b})};e._queueEditOperation=function(a){this._editOperationQueue.push(a);this.notifyChange("syncing");return a().then(b=>{v.remove(this._editOperationQueue,a);this.notifyChange("syncing");return b}).catch(b=>
{z("store:edit-error","An error ocurred.",{error:b});const c={error:b,retry:()=>{this.failures.remove(c);this._queueEditOperation(a)},cancel:()=>this.failures.remove(c)};this.failures.add(c);v.remove(this._editOperationQueue,a);this.notifyChange("syncing");throw b;})};e._getWhere=function(){return this.where||this.layer?.definitionExpression||"1\x3d1"};e._getTimeExtent=function(){const a=this.layer;return this.timeExtent||a&&"timeExtent"in a&&a.timeExtent||null};g._createClass(r,[{key:"attachmentsEnabled",
set:function(a){this._reset();this._set("attachmentsEnabled",a);this.notifyChange("state")}},{key:"filterGeometry",set:function(a){this._reset();this._set("filterGeometry",a);this.notifyChange("state")}},{key:"layer",set:function(a){this._reset();this._set("layer",a);this.notifyChange("state")}},{key:"objectIds",set:function(a){this._reset();this._set("objectIds",a||null);this.notifyChange("state")}},{key:"orderByFields",get:function(){return this._get("orderByFields")||[]},set:function(a){v.equals(a,
this.orderByFields)||(this.itemCache.removeAll(),this._hasStaleCache=!0,this._set("orderByFields",a))}},{key:"querying",get:function(){return 0<this._queryOperationQueue.length}},{key:"returnGeometry",set:function(a){this._reset();this._set("returnGeometry",a);this.notifyChange("state")}},{key:"state",get:function(){const {layer:a,_loaded:b,_loadError:c,_loading:d}=this;return c?"error":!a||this.get("layer.loadError")?"disabled":d?"loading":"loaded"===this.get("layer.loadStatus")&&b?"loaded":"ready"}},
{key:"syncing",get:function(){return 0<this._editOperationQueue.length}},{key:"timeExtent",set:function(a){this._reset();this._set("timeExtent",a);this.notifyChange("state")}},{key:"where",get:function(){return this._get("where")||null},set:function(a){this._reset();this._set("where",a);this.notifyChange("state")}}]);return r}(k);l.__decorate([m.property()],k.prototype,"attachmentsEnabled",null);l.__decorate([m.property({readOnly:!0})],k.prototype,"count",void 0);l.__decorate([m.property({readOnly:!0})],
k.prototype,"failures",void 0);l.__decorate([m.property()],k.prototype,"filterGeometry",null);l.__decorate([m.property({readOnly:!0})],k.prototype,"itemCache",void 0);l.__decorate([m.property({value:null})],k.prototype,"layer",null);l.__decorate([m.property({value:null})],k.prototype,"objectIds",null);l.__decorate([m.property()],k.prototype,"orderByFields",null);l.__decorate([m.property({readOnly:!0})],k.prototype,"querying",null);l.__decorate([m.property()],k.prototype,"relatedRecordsEnabled",void 0);
l.__decorate([m.property({value:!1})],k.prototype,"returnGeometry",null);l.__decorate([m.property({readOnly:!0})],k.prototype,"state",null);l.__decorate([m.property({readOnly:!0})],k.prototype,"syncing",null);l.__decorate([m.property()],k.prototype,"timeExtent",null);l.__decorate([m.property()],k.prototype,"where",null);return k=l.__decorate([F.subclass("esri.widgets.FeatureTable.support.FeatureStore")],k)});