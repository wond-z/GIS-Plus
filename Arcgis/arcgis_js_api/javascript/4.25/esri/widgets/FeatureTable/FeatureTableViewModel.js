// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../Graphic ../../intl ../../core/Collection ../../core/HandleOwner ../../core/Handles ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/arrayUtils ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ../../views/support/layerViewUtils ./AttachmentsColumn ./FieldColumn ./Grid/Column ./Grid/Grid ./Grid/GridViewModel ./Grid/GroupColumn ./support/FeatureStore ../support/widgetUtils ../support/decorators/messageBundle ../../intl/locale ../../intl/messages".split(" "),
function(r,g,K,e,x,L,M,N,G,t,h,Y,Z,O,P,Q,C,R,S,T,U,H,aa,I,V,D){e=function(J){function A(a){var b=J.call(this,a)||this;b._debounceRefresh=G.debounce(()=>b._refresh());b._defaultHiddenFields=["CreationDate","Creator","EditDate","Editor","GlobalID"];b._highlights=new M;b.activeFilters=new x;b.autoRefreshEnabled=!0;b.cellClassNameGenerator=(l,n)=>l.path||null;b.columns=new x;b.dataProvider=function(){var l=r._asyncToGenerator(function*(n,p){const {store:q}=r._assertThisInitialized(b),{page:u,pageSize:v,
sortOrders:m}=n;n=b._sortOrdersToLayerOrderByFields(m);p&&(q?(yield q.set({orderByFields:n}),"loaded"!==q.state&&"loading"!==q.state&&(yield q.load()),p&&p(yield q.fetchItems({page:u,pageSize:v}))):p&&p([]))});return function(n,p){return l.apply(this,arguments)}}();b.editingEnabled=!1;b.fieldConfigs=null;b.grid=null;b.highlightEnabled=!0;b.itemIdPath="objectId";b.messagesCommon=null;b.messagesURIUtils=null;b.relatedRecordsEnabled=!1;b.store=null;b.tableTemplate=null;b.view=null;const {hiddenFields:c,
itemIdPath:d}=r._assertThisInitialized(b);c.addMany(b._defaultHiddenFields);b._onLayerRefresh=b._onLayerRefresh.bind(r._assertThisInitialized(b));b._set("store",new H);b._set("grid",new S({itemIdPath:d,viewModel:r._assertThisInitialized(b)}));return b}r._inheritsLoose(A,J);var f=A.prototype;f.initialize=function(){var a=this;const b=function(){var c=r._asyncToGenerator(function*(){a.messages=yield D.fetchMessageBundle("esri/widgets/FeatureTable/t9n/FeatureTable");a.messagesCommon=yield D.fetchMessageBundle("esri/t9n/common");
a.messagesURIUtils=yield D.fetchMessageBundle("esri/widgets/support/t9n/uriUtils")});return function(){return c.apply(this,arguments)}}();b();this.handles.add([V.onLocaleChange(()=>{b();this._generateColumns()}),t.on(()=>this.highlightIds,"change",c=>this._onHighlightIdsChange(c),{onListenerAdd:()=>{this.highlightIds.forEach(c=>this._highlight(c))},onListenerRemove:()=>{this.highlightIds.forEach(c=>this._unhighlight(c))}}),t.watch(()=>this.layerView,()=>{this._highlights.removeAll();this.layerView&&
this.highlightEnabled&&this.highlightIds?.forEach(c=>this._highlight(c))}),t.watch(()=>this.highlightEnabled,()=>{this._highlights.removeAll();this.highlightEnabled&&this.highlightIds?.forEach(c=>this._highlight(c))}),t.watch(()=>this.relatedRecordsEnabled,c=>this.store.relatedRecordsEnabled=c),t.watch(()=>this.layer?.loaded,c=>c&&this._onLayerLoad()),t.watch(()=>this.store.state,c=>{"loaded"===c&&this.grid?.scrollToTop()}),t.watch(()=>[this.messages,this.tableTemplate,this.fieldConfigs],()=>this.layer?.loaded&&
this._generateColumns()),t.watch(()=>this.editingEnabled,c=>this.columns.forEach(d=>{"editingEnabled"in d&&(d.editingEnabled=c)})),t.watch(()=>this.layer?.definitionExpression,(c,d)=>(c||d)&&"loaded"===this.store.state&&this.reset()),t.watch(()=>this.layer&&"timeExtent"in this.layer&&this.layer.timeExtent,(c,d)=>(c||d)&&!this.timeExtent&&"loaded"===this.store.state&&this.reset()),t.on(()=>this.layer,"refresh",c=>this._onLayerRefresh(c))])};f.destroy=function(){this._resetColumns();this.handles.removeAll();
this._highlights.removeAll();this._highlights.destroy();this.grid?.destroy();this.columns?.destroy();this.view=this.layer=null};f.clearHighlights=function(){this._highlights.removeAll()};f.clearSelection=function(){this.grid?.clearSelection()};f.deleteSelection=function(){var a=r._asyncToGenerator(function*(){var b=this.highlightIds.toArray();b?.length&&({deleteFeatureResults:b}=yield this.store.deleteRowsByObjectId(b),b=b.filter(c=>!c.error).map(c=>c.objectId),b.length&&(this.deselectRows(b),yield this.refresh()))});
return function(){return a.apply(this,arguments)}}();f.deselectRows=function(a){a=this._getStoreItemsFromSelectionParams(a);this.grid.deselectRows(a)};f.filterBySelection=function(){const a=this.highlightIds.toArray();a.length&&(this.clearSelectionFilter(),this.store.objectIds=a,this.activeFilters.add({type:"selection",objectIds:a}))};f.getObjectIdIndex=function(a){return this.store?.getObjectIdIndex(a)};f.getValue=function(a,b){return this.store.getItemByObjectId(a)?.feature?.attributes[b]};f.refresh=
function(){var a=r._asyncToGenerator(function*(){return G.ignoreAbortErrors(this._debounceRefresh())});return function(){return a.apply(this,arguments)}}();f.reset=function(){this.grid.reset()};f.selectRows=function(a){a=this._getStoreItemsFromSelectionParams(a);return this.grid.selectRows(a)};f.scrollToIndex=function(a){this.grid?.scrollToIndex(a)};f.clearSelectionFilter=function(){this.store.objectIds=null;const a=this.activeFilters.find(b=>"selection"===b.type);a&&this.activeFilters.remove(a)};
f.zoomToSelection=function(){const {layer:a,view:b}=this,c=this.highlightIds.toArray();if(a&&b&&c.length){var d=a.createQuery();d.objectIds=c;d.returnGeometry=!0;a.queryFeatures(d).then(l=>{b.goTo(l.features).catch(n=>{"AbortError"!==n.name&&console.error(n)})})}};f._refresh=function(){var a=r._asyncToGenerator(function*(){yield this.store.refreshLayerInfo();const b=this.highlightIds.toArray();b.length&&(yield this.store.verifyFeaturesByObjectId(b)).forEach((c,d)=>{c||this.deselectRows(b[d])});this.grid.refreshPageCache()});
return function(){return a.apply(this,arguments)}}();f._onLayerLoad=function(){const a=this.layer.capabilities.query.maxRecordCount;a&&a<this.pageSize&&this.grid&&(this.grid.pageSize=a);this._generateColumns()};f._onLayerRefresh=function(a){this.autoRefreshEnabled&&a.dataChanged&&this.refresh()};f._generateColumns=function(){this._resetColumns();const a=[],b=this.tableTemplate?.columnTemplates?this._generateColumnsFromTemplates(this.tableTemplate.columnTemplates):this.fieldConfigs?.length?this._generateColumnsFromConfigs():
this._generateDefaultFieldColumns();a.push(...b);this.attachmentsEnabled&&a.push(this._generateDefaultAttachmentColumn());this.columns.addMany([...a])};f._generateColumnsFromTemplates=function(a){const {editingEnabled:b,grid:c,hiddenFields:d,layer:l,messages:n,messagesCommon:p,messagesURIUtils:q,store:u,tableTemplate:v}=this,m=this.layer?.fields??[];return a.filter(k=>(m||[]).find(w=>"fieldName"in k&&k.fieldName===w.name)||"group"===k.type&&"columnTemplates"in k).map(k=>{if("fieldName"in k){var w=
(m||[]).find(W=>k.fieldName===W.name),y=!1===k.visible||!0!==k.visible&&d.includes(w.name);const {direction:z,formatFunction:B,initialSortPriority:E,menuConfig:F,textAlign:X}=k;return new C({direction:z,editingEnabled:b,expressionInfos:v.expressionInfos||null,field:w,formatFunction:B,grid:c,hidden:y,initialSortPriority:E,layer:l,messages:n,messagesCommon:p,messagesURIUtils:q,menuConfig:F,store:u,template:k,textAlign:X})}if("group"===k.type&&"columnTemplates"in k){w=this._generateColumnsFromTemplates(k.columnTemplates);
y=!1===k.visible||!0!==k.visible&&d.includes(k.label);const {label:z}=k;return new U({header:z,columns:w,hidden:y})}return new R({...k})})};f._generateColumnsFromConfigs=function(){const {editingEnabled:a,fieldConfigs:b,grid:c,hiddenFields:d,layer:l,messages:n,messagesCommon:p,messagesURIUtils:q,store:u}=this,v=this.layer?.fields??[];return b.filter(m=>(v||[]).find(k=>m.name===k.name)).map(m=>{const k=m.direction||null,w=m.formatFunction||null,y=m.textAlign||null,z=N.isSome(m.initialSortPriority)?
m.initialSortPriority:null,B=(v||[]).find(F=>m.name===F.name),E=!1===m.visible||!0!==m.visible&&d.includes(B.name);return new C({config:m,direction:k,editingEnabled:a,field:B,formatFunction:w,grid:c,hidden:E,layer:l,store:u,messages:n,messagesCommon:p,messagesURIUtils:q,menuConfig:m.menuConfig||null,textAlign:y,initialSortPriority:z})})};f._generateDefaultFieldColumns=function(){const {editingEnabled:a,grid:b,hiddenFields:c,layer:d,messages:l,messagesCommon:n,messagesURIUtils:p,store:q}=this;return(this.layer?.fields??
[]).map(u=>{const v=c.includes(u.name);return new C({editingEnabled:a,field:u,grid:b,hidden:v,layer:d,store:q,messages:l,messagesCommon:n,messagesURIUtils:p})})};f._generateDefaultAttachmentColumn=function(){return new Q({header:this.messages?.attachments})};f._sortOrdersToLayerOrderByFields=function(a){return a&&a.length?a.filter((b,c,d)=>d.map(l=>l.path).indexOf(b.path)===c).filter(({direction:b})=>!!b).map(({direction:b,path:c})=>c+" "+b.toUpperCase()):[]};f._highlight=function(a){this.layerView&&
P.highlightsSupported(this.layerView)&&this._highlights.add(this.layerView.highlight(a),a)};f._unhighlight=function(a){this._highlights.remove(a)};f._getStoreItemsFromSelectionParams=function(a){const b=[];a=a instanceof Array?a:[a];a.forEach(c=>{let d=c instanceof K?c:null;c=d?d.getObjectId():c;if("number"===typeof c||"string"===typeof c){if(!d){const l=this.store.getItemByObjectId(c);l&&(d=l.feature)}b.push({objectId:c,feature:d})}});return b};f._onHighlightIdsChange=function(a){const {highlightEnabled:b}=
this,{added:c,removed:d}=a;b&&(c.forEach(l=>this._highlight(l)),d.forEach(l=>this._unhighlight(l)))};f._resetColumns=function(){this.columns.items.forEach(a=>a.destroy());this.columns.removeAll()};r._createClass(A,[{key:"activeSortOrders",get:function(){return this.grid?.sortOrders?this.grid.sortOrders.map(({path:a,direction:b})=>({fieldName:a,direction:b})):[]}},{key:"attachmentsEnabled",set:function(a){this.attachmentsEnabled!==a&&(this._set("attachmentsEnabled",a),this._generateColumns(),this.store.attachmentsEnabled=
a)}},{key:"filterGeometry",set:function(a){if(this.filterGeometry||a){var b=this.activeFilters.find(c=>"geometry"===c.type);b&&this.activeFilters.remove(b);this._set("filterGeometry",a);(this.store.filterGeometry=a)&&this.activeFilters.add({type:"geometry",geometry:a})}}},{key:"hiddenFields",get:function(){return this._get("hiddenFields")||new x},set:function(a){Array.isArray(a)?this._set("hiddenFields",new x(a)):this._set("hiddenFields",a)}},{key:"highlightOnRowSelectEnabled",get:function(){return this.highlightEnabled},
set:function(a){this.highlightEnabled=a}},{key:"layer",set:function(a){this._set("layer",a);this.grid?.clearSort();this._resetColumns();(this.store.layer=a)&&(a.loaded?this._onLayerLoad():a.load());this.notifyChange("state")}},{key:"layerView",get:function(){return this.view?.allLayerViews.find(a=>a.layer===this.layer)||null}},{key:"messages",set:function(a){this.grid?.set("messages",a);this._set("messages",a)}},{key:"state",get:function(){const {store:a}=this;return a&&"disabled"!==a.state?"loading"===
a.state?"loading":"loaded"===a.state?"loaded":"ready":"disabled"}},{key:"timeExtent",set:function(a){this._set("timeExtent",a);this.store.timeExtent=a}},{key:"highlightIds",get:function(){return this._get("highlightIds")||new x},set:function(a){Array.isArray(a)?this._set("highlightIds",new x(a)):this._set("highlightIds",a)}}]);return A}(L.HandleOwnerMixin(T));g.__decorate([h.property({readOnly:!0})],e.prototype,"activeFilters",void 0);g.__decorate([h.property({readOnly:!0})],e.prototype,"activeSortOrders",
null);g.__decorate([h.property()],e.prototype,"attachmentsEnabled",null);g.__decorate([h.property()],e.prototype,"autoRefreshEnabled",void 0);g.__decorate([h.property()],e.prototype,"cellClassNameGenerator",void 0);g.__decorate([h.property({readOnly:!0})],e.prototype,"columns",void 0);g.__decorate([h.property()],e.prototype,"dataProvider",void 0);g.__decorate([h.property()],e.prototype,"editingEnabled",void 0);g.__decorate([h.property()],e.prototype,"fieldConfigs",void 0);g.__decorate([h.property()],
e.prototype,"filterGeometry",null);g.__decorate([h.property({readOnly:!0})],e.prototype,"grid",void 0);g.__decorate([h.property()],e.prototype,"hiddenFields",null);g.__decorate([h.property()],e.prototype,"highlightEnabled",void 0);g.__decorate([h.property()],e.prototype,"highlightOnRowSelectEnabled",null);g.__decorate([h.property({readOnly:!0})],e.prototype,"itemIdPath",void 0);g.__decorate([h.property()],e.prototype,"layer",null);g.__decorate([h.property()],e.prototype,"layerView",null);g.__decorate([h.property()],
e.prototype,"messages",null);g.__decorate([h.property(),I.messageBundle("esri/t9n/common")],e.prototype,"messagesCommon",void 0);g.__decorate([h.property(),I.messageBundle("esri/widgets/support/t9n/uriUtils")],e.prototype,"messagesURIUtils",void 0);g.__decorate([h.property()],e.prototype,"relatedRecordsEnabled",void 0);g.__decorate([h.property({readOnly:!0})],e.prototype,"state",null);g.__decorate([h.property({readOnly:!0,type:H})],e.prototype,"store",void 0);g.__decorate([h.property()],e.prototype,
"tableTemplate",void 0);g.__decorate([h.property()],e.prototype,"timeExtent",null);g.__decorate([h.property()],e.prototype,"view",void 0);g.__decorate([h.property()],e.prototype,"highlightIds",null);return e=g.__decorate([O.subclass("esri.widgets.FeatureTable.FeatureTableViewModel")],e)});