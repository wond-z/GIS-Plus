// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Collection ../../core/Error ../../core/Evented ../../core/HandleOwner ../../core/Logger ../../core/maybe ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/arrayUtils ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ../../geometry/Point ../../networks/support/utils ../../rest/networks/trace ../../rest/networks/support/TraceLocation ../../rest/networks/support/TraceParameters ./support/GeometryHandler ./support/GraphicHandler".split(" "),
function(q,m,y,z,k,A,B,C,D,p,K,L,E,F,t,G,v,H,I,J){k=function(w){function r(b){b=w.call(this,b)||this;b._activeProgress=!1;b._clickHandler=null;b._flags=[];b._geometryHandler=null;b._graphicHandler=null;b._highlightHandler=[];b._traces=[];b._traceResults=[];b._unObject=null;b._watchHandler=null;b.defaultGraphicColor={color:[255,255,0,.6],haloOpacity:.9,fillOpacity:.2,hex:"#FFFF00"};b.flags=[];b.gdbVersion="sde.DEFAULT";b.selectedTraces=[];b.selectOnComplete=!0;b.showGraphicsOnComplete=!0;b.showSelectionAttributes=
!0;return b}q._inheritsLoose(r,w);var g=r.prototype;g.initialize=function(){this._geometryHandler=new I.GeometryHandler;this._graphicHandler=new J.GraphicHandler};g.destroy=function(){this.view=null};g.addFlagByHit=function(b,a){return new Promise((c,d)=>{this.view.popup.autoOpenEnabled=!1;this._clickHandler&&this._clickHandler.remove();this.emit("add-flag",{type:b});this._clickHandler=this.view.on("click",e=>{this.queryFlagByHitTest(e,b,a).then(f=>{this.view.popup.autoOpenEnabled=!0;this._clickHandler.remove();
this.emit("add-flag-complete",{type:b,symbol:a});c(f)}).catch(f=>{this.view.popup.autoOpenEnabled=!0;this._clickHandler.remove();this.emit("add-flag-error",{type:b,symbol:a});d(f)})})})};g.addFlagsOnLoad=function(){var b=q._asyncToGenerator(function*(){var a=this;return new Promise(c=>{const d=[];this._watchHandler=D.when(()=>!this.view.updating,q._asyncToGenerator(function*(){if(!(0<a._flags.length)){const e=a.flags.map(function(){var f=q._asyncToGenerator(function*(n){if(n.mapPoint){var h=new F({x:n.mapPoint.x,
y:n.mapPoint.y,spatialReference:n.mapPoint.spatialReference.wkid});h={screenPoint:a.view.toScreen(h),mapPoint:h};(yield a.queryFlagByHitTest(h,n.type))||("barrier"===n.type?d.push("barrier"):d.push("starting-point"))}});return function(n){return f.apply(this,arguments)}}());yield Promise.all(e)}c(d)}),{initial:!0})})});return function(){return b.apply(this,arguments)}}();g.addResultGraphicToView=function(){var b=q._asyncToGenerator(function*(a,c){for(const e in a.results.aggregatedGeometry)if("line,multipoint,polygon".includes(e)&&
null!==a.results.aggregatedGeometry[e]){a.results.aggregatedGeometry[e].spatialReference=this._unObject.spatialReference;a.graphicEnabled=!0;var d=yield this._geometryHandler.projectGeometry(a.results.aggregatedGeometry[e],this.view.spatialReference);const f={globalid:a.trace.globalId};null!==d&&(d=this._graphicHandler.makeGraphic(d,c.color,f,this.view.spatialReference),this.view.graphics.add(d))}});return function(a,c){return b.apply(this,arguments)}}();g.addTerminal=function(b,a){const c=[...this._flags];
c.forEach(d=>{d.globalId===a.globalId&&(a.selectedTerminals.includes(parseInt(b,10))||d.selectedTerminals.push(parseInt(b,10)))});this._flags=c};g.callTrace=function(){var b=q._asyncToGenerator(function*(){var a=this;const c=this._traces.filter(d=>d.selected);return 0<c.length?(0<this._traceResults.length&&this._traceResults.forEach(d=>{this.removeResultGraphicFromView(d)}),this._traceResults=[],this.removeSelection(),yield Promise.all(c.map(function(){var d=q._asyncToGenerator(function*(e,f){const n=
new H({gdbVersion:a.gdbVersion,moment:null,traceType:e.traceType,traceLocations:a._flags,namedTraceConfigurationGlobalId:e.globalId,traceConfiguration:null,outSpatialReference:null,resultTypes:null});yield a.executeTrace(e,a._unObject.networkServiceUrl,n).then(h=>{if(h.hasOwnProperty("results")){var l={...h};if(null!==l.results){h=[...l.results.elements];l.results.elements.length=0;const x=new Map;for(const u of h)x.has(u.globalId)||(x.set(u.globalId,!0),l.results.elements.push(u));h=[...a._traceResults];
h.splice(f,0,l);a._traceResults=h;null!==l.results&&(a.selectOnComplete&&a.mergeSelection(!0,l.trace),a.showGraphicsOnComplete&&a.addResultGraphicToView(l,l.graphicColor))}else l=[...a._traceResults],l.splice(f,0,h),a._traceResults=l;a._activeProgress=!1}else a._activeProgress=!1,l=[...a._traceResults],l.splice(f,0,h),a._traceResults=l}).catch(h=>{a._activeProgress=!1;throw h;})});return function(e,f){return d.apply(this,arguments)}}())),!0):!1});return function(){return b.apply(this,arguments)}}();
g.changeResultGraphicColor=function(b,a){const c=[...this._traceResults];0<c.length&&c.forEach(d=>{d.trace.globalId===a.trace.globalId&&(d.graphicColor=b,d.graphicEnabled=!0)});this._traceResults=c;this.removeResultGraphicFromView(a);this.addResultGraphicToView(a,b)};g.changeFlagSymbol=function(b,a){0<this._flags.length&&this._flags.forEach(c=>{c.type===b&&a&&(c.mapGraphic.symbol=a)})};g.checkCanTrace=function(){const b={status:!0,issues:[]};let a=!1;const c=this._flags.some(e=>"starting-point"===
e.type);var d=this._flags.filter(e=>null!==e.allTerminals);0<d.length&&(a=d.some(e=>0>=e.selectedTerminals.length));d=[];c?(d=this._traces.filter(e=>e.selected),0>=d.length?(b.status=!1,b.issues=["noTrace"],a&&(b.status=!1,b.issues=["noTrace","noTerminalSelected"])):a&&(b.status=!1,b.issues=["noTerminalSelected"])):(d=this._traces.filter(e=>!0===e.selected),0<d.length?(b.status=!1,b.issues=["noStart"],a&&(b.status=!1,b.issues=["noStart","noTerminalSelected"])):(b.status=!1,b.issues=["noStart","noTrace"],
a&&(b.status=!1,b.issues=["noStart","noTrace","noTerminalSelected"])));return b};g.checkSelectionExist=function(){let b=!1;this._highlightHandler.some(a=>{a&&(b=!0)});return b};g.clearResult=function(b){let a=this._traceResults;if(0<a.length){const c=a.filter(d=>d.trace.globalId===b.globalId);0<c.length&&this.removeResultGraphicFromView(c[0]);a=a.filter(d=>d.trace.globalId!==b.globalId)}this._traceResults=a;0===a.length?(this.removeSelection(),this.emit("clear-selection",{resultSet:[]})):this.mergeSelection(!1,
b)};g.executeTrace=function(b,a,c){const d=this._processFlags(c.traceLocations);c.traceLocations=d;return G.trace(a,c).then(e=>({trace:b,results:e,selectionEnabled:!1,graphicEnabled:!1,graphicColor:this.defaultGraphicColor,status:"success"})).catch(e=>({trace:b,results:null,selectionEnabled:!1,graphicEnabled:!1,graphicColor:this.defaultGraphicColor,status:e.message}))};g.getValidSources=function(){let b=[];const a=this._unObject.dataElement.domainNetworks;for(const c of a)b=b.concat(c.junctionSources),
b=b.concat(c.edgeSources);return b};g.loadUtilityNetwork=function(){var b=q._asyncToGenerator(function*(){yield this.view.when();const a=this.view.map;if(a.utilityNetworks?.length){const c=a.utilityNetworks.getItemAt(0);yield c.load();this._unObject=c;try{yield a.loadAll(),this._populateOutfields()}catch(d){this._populateOutfields()}return c}return null});return function(){return b.apply(this,arguments)}}();g.manageFilterBarrier=function(b,a){const c=[...this._flags];c.forEach(d=>{d.globalId===a.globalId&&
"barrier"===a.type&&d.id===a.id&&(d.isFilterBarrier=b)});this._flags=c};g.mergeSelection=function(b,a){let c=[];const d=[...this._traceResults],e=a.globalId;d.forEach(f=>{e===f.trace.globalId&&(f.selectionEnabled=b);f.selectionEnabled&&null!==f.results.elements&&(c=c.concat(f.results.elements))});this.selectResults([...(new Set(c))])};g.queryFeaturesById=function(){var b=q._asyncToGenerator(function*(a){var c=this;const d=t.getObjectIdsFromElements(this._unObject,a);a=this._getUniqueMapLayerViews(this.view);
const e={layerUrl:d[0].layerUrl,objectIds:d[0].objectIds,outFields:["*"]};a=a.filter(f=>f.layer?.parsedUrl?.path===d[0].layerUrl);return 0<a.length&&(a=(yield Promise.all(a.map(function(){var f=q._asyncToGenerator(function*(n){const h=new y;h.add(n.layer);return(yield t.getFeaturesFromLayers({layers:h,layerInfos:[e],returnGeometry:!0,outSpatialReference:c.view.spatialReference}))[0]});return function(n){return f.apply(this,arguments)}}()))).filter(f=>0<f.featureSet.features.length),0<a.length)?a:
null});return function(a){return b.apply(this,arguments)}}();g.queryFlagByHitTest=function(b,a,c){return this._lookupFlagByHit(b).then(d=>{if(0<d.length){const e=[...this._flags];d.forEach(f=>{f=f.graphic;const n=f.attributes.hasOwnProperty("GLOBALID")?f.attributes.GLOBALID:f.attributes.globalid;if(0>=e.filter(l=>l.globalId===n).length){var h=this._graphicHandler.getFlagGraphic(f.mapPoint,a,f,c);this.view.graphics.add(h);e.push({...f,type:a,globalId:f.attributes.globalid?f.attributes.globalid:f.attributes.GLOBALID,
details:f,mapGraphic:h,id:e.length+1})}else null!==f.percentAlong&&(h=this._graphicHandler.getFlagGraphic(f.mapPoint,a,f,c),this.view.graphics.add(h),e.push({...f,type:a,globalId:f.attributes.globalid?f.attributes.globalid:f.attributes.GLOBALID,details:f,mapGraphic:h,id:e.length+1}))});this._flags=e;return!0}return!1})};g.removeResultGraphicFromView=function(b){const a=this.view.graphics;b.graphicEnabled=!1;a.filter(c=>c.attributes[c.attributes.hasOwnProperty("GLOBALID")?"GLOBALID":"globalid"]===
b.trace.globalId).forEach(c=>{this.view.graphics.remove(c)})};g.removeFlag=function(b){const a=this._flags.filter(c=>{if(c.id!==b.id)return c});this._removeGraphic(b);this._flags=a};g.removeSelection=function(){this._highlightHandler.forEach(b=>{b&&b.remove()});this._highlightHandler=[]};g.removeTerminal=function(b,a){const c=[...this._flags];c.forEach(d=>{if(d.globalId===a.globalId&&a.selectedTerminals.includes(parseInt(b,10))){const e=a.selectedTerminals.indexOf(parseInt(b,10));d.selectedTerminals.splice(e,
1)}});this._flags=c};g.removeFlagsOnLoadWatcher=function(){this._watchHandler&&null!==this._watchHandler&&this._watchHandler.remove()};g.reset=function(){this._flags=[];this._traceResults=[];const b=[...this._traces];b.forEach(a=>{a.selected=!1});this._traces=b;this.view&&(this.view.graphics.removeAll(),this.removeSelection(),this.emit("clear-selection",{resultSet:[]}))};g.selectFeaturesById=function(b){const a=t.getObjectIdsFromElements(this._unObject,b);this._getUniqueMapLayerViews(this.view).forEach(c=>
{c.layer?.parsedUrl?.path===a[0].layerUrl&&this._highlightHandler.push(c.highlight(a[0].objectIds))})};g.selectResults=function(b){if(0<b.length){this.removeSelection();b=this._groupResultsByNetworkSource(b);const a=[];for(const c in b)this.selectFeaturesById(b[c]),a.push(this.queryFeaturesById(b[c]));Promise.all(a).then(c=>{this.emit("select-features",{resultSet:c})})}else this.removeSelection(),this.emit("clear-selection",{resultSet:[]})};g.selectTraces=function(b,a){const c=[...this._traces];c.forEach(d=>
{a===d.globalId&&(d.selected=b)});this._traces=c};g.selectTracesOnLoad=function(){this._unObject.hasOwnProperty("sharedNamedTraceConfigurations")&&(this._traces=[...this._unObject.sharedNamedTraceConfigurations],this._traces.forEach(b=>{b.selected=!1;this.selectedTraces.includes(b.globalId)&&(b.selected=!0)}))};g.zoomToAsset=function(b){this.view.goTo(b).catch(a=>{console.error(a)})};g._getUniqueMapLayerViews=function(b){const a=[];b.layerViews.filter(c=>"feature"===c.layer.type||"group"===c.layer.type).forEach(c=>
{"group"===c.type?c.layerViews.forEach(d=>{a.push(d)}):a.some(d=>d.layer.layerId===c.layer.layerId)||a.push(c)});return a};g._processFlags=function(b){const a=[];b.forEach(c=>{if(null!==c.selectedTerminals&&0<c.selectedTerminals.length)c.selectedTerminals.forEach(d=>{d=new v({globalId:c.globalId,percentAlong:c.percentAlong,terminalId:d,type:c.type,isFilterBarrier:c.isFilterBarrier});a.push(d)});else{const d=new v({globalId:c.globalId,percentAlong:c.percentAlong,terminalId:null,type:c.type,isFilterBarrier:c.isFilterBarrier});
a.push(d)}});return a};g._getDisplayField=function(b){const a=b.layer;let c=a.displayField;var d="";for(const e in b.attributes){const f=e.toLowerCase();f===c.toLowerCase()&&(d=b.attributes[e],"assetgroup"===f||"assettype"===f?((d=b.attributes[a.typeIdField.toUpperCase()])||(d=b.attributes[a.typeIdField.toLowerCase()]),c=a.typeIdField,d=this._checkSubtype(a,d)):d=this._checkDomain(a.fields,e,d))}return{field:c,value:d}};g._checkSubtype=function(b,a){let c=a;null!==b.types&&0<b.types.length&&(b=b.types.filter(d=>
d.id===a),0<b.length&&(c=b[0].name));return c};g._checkDomain=function(b,a,c){let d=c;b=b.filter(e=>e.name.toLowerCase()===a.toLowerCase());0<b.length&&null!==b[0].domain&&(b=b[0].domain.codedValues.filter(e=>e.code===c),0<b.length&&(d=b[0].name));return d};g._groupBy=function(b,a){return b.reduce((c,d)=>{(c[d[a]]=c[d[a]]||[]).push(d);return c},{})};g._groupResultsByNetworkSource=function(b){return 0<b.length?b[0].hasOwnProperty("results")?this._groupBy(b[0].results.elements,"networkSourceId"):this._groupBy(b,
"networkSourceId"):b.hasOwnProperty("results")?this._groupBy(b.results.elements,"networkSourceId"):[]};g._lookupFlagByHit=function(b){return this.view.hitTest(b.screenPoint).then(a=>{const c=[];if(0<a.results.length&&(a=a.results.find(f=>null!==f.layer),a.graphic&&C.isSome(a.graphic.geometry)))if("polyline"===a.graphic.geometry.type){var d=this._geometryHandler.getPercentageAlong(a.graphic.geometry,b.mapPoint,a.graphic.geometry.spatialReference),e=this._getDisplayField(a.graphic);a.graphic.terminalId=
null;a.graphic.isFilterBarrier=!1;a.graphic.allTerminals=null;a.graphic.selectedTerminals=null;a.graphic.percentAlong=d;a.graphic.displayValue=e;a.graphic.mapPoint=a.mapPoint;c.push(a)}else"point"!==a.graphic.geometry.type&&"polygon"!==a.graphic.geometry.type||null===this._unObject||(d=this._unObject.getTerminalConfiguration(a.graphic),e=this._getDisplayField(a.graphic),a.graphic.terminalId=d?d.terminals[0].id?d.terminals[0].id:null:1,a.graphic.isFilterBarrier=!1,a.graphic.allTerminals=d?d:null,a.graphic.selectedTerminals=
[d?d.terminals[0].id?d.terminals[0].id:null:1],a.graphic.percentAlong=null,a.graphic.displayValue=e,a.graphic.mapPoint=a.mapPoint,c.push(a));return c})};g._populateOutfields=function(){var b=q._asyncToGenerator(function*(){const a=this.view.map,c=this.getValidSources();a.layers.forEach(d=>{"group"===d.type?d.layers.forEach(e=>{c.some(f=>f.layerId===e.layerId)&&e.fields.some(f=>"assetgroup"===f.name.toLowerCase())&&(e.outFields=["assetgroup","assettype","globalid","objectid"])}):c.some(e=>e.layerId===
d.layerId)&&d.fields.some(e=>"assetgroup"===e.name.toLowerCase())&&(d.outFields=["assetgroup","assettype","globalid","objectid"])})});return function(){return b.apply(this,arguments)}}();g._removeGraphic=function(b){this.view.graphics.remove(b.mapGraphic)};q._createClass(r,[{key:"state",get:function(){return this.view?.ready?"ready":"loading"}},{key:"view",get:function(){return this._get("view")},set:function(b){b&&"2d"!==b.type&&B.getLogger(this.declaredClass).error(new z("view:invalid-view","SceneView is not supported",
{view:b}));this._set("view",b)}}]);return r}(A.HandleOwnerMixin(k.EventedAccessor));m.__decorate([p.property()],k.prototype,"_activeProgress",void 0);m.__decorate([p.property()],k.prototype,"_flags",void 0);m.__decorate([p.property()],k.prototype,"_traces",void 0);m.__decorate([p.property()],k.prototype,"_traceResults",void 0);m.__decorate([p.property()],k.prototype,"defaultGraphicColor",void 0);m.__decorate([p.property()],k.prototype,"flags",void 0);m.__decorate([p.property()],k.prototype,"gdbVersion",
void 0);m.__decorate([p.property()],k.prototype,"selectedTraces",void 0);m.__decorate([p.property()],k.prototype,"selectOnComplete",void 0);m.__decorate([p.property()],k.prototype,"showGraphicsOnComplete",void 0);m.__decorate([p.property()],k.prototype,"showSelectionAttributes",void 0);m.__decorate([p.property({readOnly:!0})],k.prototype,"state",null);m.__decorate([p.property({value:null})],k.prototype,"view",null);return k=m.__decorate([E.subclass("esri.widgets.UtilityNetworkTrace.UtilityNetworkTraceViewModel")],
k)});