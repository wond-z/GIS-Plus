// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("require exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/Logger ../../../core/promiseUtils ../../../layers/FeatureLayer ./featureUtils".split(" "),function(x,p,q,y,z,A,m){function B(b){return`<ul class="esri-widget__list">${b.map(a=>`<li>${"string"===typeof a?m.applyTextFormattingHTML(m.htmlEntities(a)):a}</li>`).join("")}</ul>`}function C(b){return`<table class="esri-widget__table">${b.keys().map(a=>{var c=b.field(a);c="string"===typeof c?m.applyTextFormattingHTML(m.htmlEntities(c)):
c;return`<tr><th>${a}</th><td>${c}</td></tr>`}).join("")}</table>`}function D({aggregatedFeatures:b,arcadeUtils:a,featureSetVars:c,context:e,viewInfo:g,map:l,graphic:k,interceptor:h}){c.forEach(d=>{d=d.toLowerCase();var f={map:l,spatialReference:g.sr,interceptor:h};"$map"===d&&(e.vars[d]=a.convertMapToFeatureSetCollection(f));"$layer"===d&&(e.vars[d]=a.convertFeatureLayerToFeatureSet({layer:k.sourceLayer,spatialReference:g.sr,interceptor:h}));"$datastore"===d&&(e.vars[d]=a.convertServiceUrlToWorkspace({url:k.sourceLayer.url,
spatialReference:g.sr,interceptor:h}));if("$aggregatedfeatures"===d){f=k.layer;const {fields:n,objectIdField:E,geometryType:F,spatialReference:G,displayField:H}=f;f=new A({fields:n,objectIdField:E,geometryType:F,spatialReference:G,displayField:H,...("feature"===f.type?{templates:f.templates,typeIdField:f.typeIdField,types:f.types}:null),source:b});e.vars[d]=a.convertFeatureLayerToFeatureSet({layer:f,spatialReference:g.sr,interceptor:h})}})}function v(){return new Promise((b,a)=>x(["../../../support/arcadeUtils"],
b,a))}function I(b){return r.apply(this,arguments)}function r(){r=q._asyncToGenerator(function*({graphic:b,view:a}){const {isAggregate:c,layer:e}=b;if(!c||!e||"2d"!==a?.type)return[];a=yield a.whenLayerView(e);if(!("createQuery"in a&&"queryFeatures"in a))return[];const g=a.createQuery();g.aggregateIds=[b.getObjectId()];({features:b}=yield a.queryFeatures(g));return b});return r.apply(this,arguments)}function w(b){return t.apply(this,arguments)}function t(){t=q._asyncToGenerator(function*({expressionInfo:b,
arcadeUtils:a,interceptor:c,spatialReference:e,map:g,graphic:l,view:k}){if(!b||!b.expression)return null;const h=a.createSyntaxTree(b.expression),d=J.filter(n=>a.hasVariable(h,n));[k]=yield Promise.all([I({graphic:l,view:k}),a.loadScriptDependencies(h,!0,d)]);const f=a.getViewInfo({spatialReference:e});e=a.createExecContext(l,f);e.interceptor=c;e.useAsync=!0;D({aggregatedFeatures:k,arcadeUtils:a,featureSetVars:d,context:e,viewInfo:f,map:g,graphic:l,interceptor:c});c=a.createFunction(h,e);return a.executeAsyncFunction(c,
e).catch(n=>K.error("arcade-execution-error",{error:n,graphic:l,expressionInfo:b}))});return t.apply(this,arguments)}function u(){u=q._asyncToGenerator(function*({expressionInfos:b,spatialReference:a,graphic:c,interceptor:e,map:g,view:l}){if(!b||!b.length)return{};const k=yield v(),h={};for(const d of b)h[`expression/${d.name}`]=w({expressionInfo:d,arcadeUtils:k,interceptor:e,spatialReference:a,map:g,graphic:c,view:l});b=yield z.eachAlways(h);a={};for(const d in b)c=b[d].value,c="string"===typeof c?
m.applyTextFormattingHTML(m.htmlEntities(c)):Array.isArray(c)?B(c):"esri.arcade.Dictionary"===c?.declaredClass?C(c):c,a[d]=c;return a});return u.apply(this,arguments)}const J=["$datastore","$map","$layer","$aggregatedfeatures"],K=y.getLogger("esri.widgets.Feature.support.arcadeFeatureUtils");p.createCompiledExpression=w;p.createCompiledExpressions=function(b){return u.apply(this,arguments)};p.loadArcadeUtils=v;Object.defineProperties(p,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});