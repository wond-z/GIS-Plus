// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("require ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../Color ../../../kernel ../../../request ../../../symbols ../../../core/Accessor ../../../core/Collection ../../../core/Handles ../../../core/jsonMap ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/screenUtils ../../../core/urlUtils ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../core/accessorSupport/PropertyOrigin ../../../layers/effects/EffectView ../../../layers/effects/jsonUtils ../../../layers/support/ExportImageParameters ../../../layers/support/fieldUtils ../../../renderers/support/jsonUtils ../../../renderers/support/rendererConversion ../../../renderers/visualVariables/support/SizeVariableLegendOptions ../../../symbols/support/cimSymbolUtils ../../../symbols/support/previewUtils ../../../symbols/support/renderUtils ../../../symbols/support/symbolUtils ../../../symbols/support/utils ./clusterUtils ./colorRampUtils ./heatmapRampUtils ./relationshipRampUtils ./sizeRampUtils ./utils ../../smartMapping/support/utils ../../../symbols/SimpleMarkerSymbol ../../../symbols/SimpleFillSymbol".split(" "),
function(xa,r,y,ja,ya,ka,x,za,Aa,Ba,Ca,D,I,F,B,Da,Ea,z,cb,db,Fa,P,Ga,Ha,Ia,Ja,Ka,La,Ma,Na,Oa,Pa,E,Qa,Ra,Q,Sa,la,da,J,Ta,R,ma){function K(t){return"esri.renderers.SimpleRenderer"===t.declaredClass}function L(t){return"esri.renderers.ClassBreaksRenderer"===t.declaredClass}function V(t){return"esri.renderers.UniqueValueRenderer"===t.declaredClass}function na(t){return"esri.renderers.HeatmapRenderer"===t.declaredClass}function ea(t){return"esri.renderers.PointCloudClassBreaksRenderer"===t.declaredClass}
function fa(t){return"esri.renderers.PointCloudStretchRenderer"===t.declaredClass}function ha(t){return"esri.renderers.PointCloudUniqueValueRenderer"===t.declaredClass}function oa(t){return"esri.renderers.DotDensityRenderer"===t.declaredClass}function pa(t){return"esri.renderers.PieChartRenderer"===t.declaredClass}function qa(t){return"esri.layers.SubtypeGroupLayer"===t.declaredClass}function Ua(t){t="authoringInfo"in t&&t?.authoringInfo;return"univariate-color-size"===t?.type&&"above-and-below"===
t?.univariateTheme}const W=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,Va=new Ca.JSONMap({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),ra={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-3.4*1E39,3.4*1E39],f64:[-Number.MAX_VALUE,Number.MAX_VALUE]},X=new R({size:6,outline:{color:[128,128,128,
.5],width:.5}}),Wa=new ma({style:"solid"}),Xa=new R({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}});let M={};x=function(t){function Y(b){b=t.call(this,b)||this;b._handles=new Ba;b._hasColorRamp=!1;b._hasOpacityRamp=!1;b._hasSizeRamp=!1;b._webStyleSymbolCache=new Map;b._dotDensityUrlCache=new Map;b._scaleDrivenSizeVariable=null;b._hasClusterSizeVariable=!1;b.children=new Aa;b.layerView=null;b.layer=null;b.legendElements=[];b.parent=null;b.hideLayersNotInCurrentView=
!1;b.keepCacheOnDestroy=!1;b.respectLayerVisibility=!0;b.sublayerIds=[];b.title=null;b.view=null;return b}r._inheritsLoose(Y,t);var k=Y.prototype;k.initialize=function(){const b=()=>this.notifyChange("ready");this._handles.add([B.on(()=>this.children,"change",a=>{const {added:c,removed:d}=a,f=this._handles;c.forEach(e=>{const g=`activeLayerInfo-ready-watcher-${e.layer.uid}`;f.add(B.watch(()=>e.ready,b,B.initial),g)});d.forEach(e=>f.remove(e.layer.uid));b()})]);this.keepCacheOnDestroy||(M={})};k.destroy=
function(){this._handles.destroy();this._scaleDrivenSizeVariable=this._dotDensityUrlCache=this._webStyleSymbolCache=this._handles=null;this.keepCacheOnDestroy||(M=null)};k.buildLegendElementsForFeatureCollections=function(){var b=r._asyncToGenerator(function*(a){if(this.hideLayersNotInCurrentView&&!(yield this._isLayerInCurrentView()))this.legendElements=[],this.notifyChange("ready");else{a=Array.from(a,c=>{if("esri.layers.FeatureLayer"===c.declaredClass)return this._getRendererLegendElements(c.renderer,
{title:c.title});if(c.featureSet&&c.featureSet.features.length){var d=c.layerDefinition,f=d&&d.drawingInfo;f=f&&Ka.fromJSON(f.renderer);d=Va.read(d.geometryType);return f?this._getRendererLegendElements(f,{title:c.name,geometryType:d}):(D.getLogger(this.declaredClass).warn("drawingInfo not available!"),null)}return null});try{const c=[];yield F.eachAlways(a).then(d=>{d.forEach(({value:f})=>f&&c.push(...f))});this.legendElements=c;this.notifyChange("ready")}catch(c){D.getLogger(this.declaredClass).warn("error while building legend for layer!",
c)}}});return function(a){return b.apply(this,arguments)}}();k.buildLegendElementsForRenderer=function(){var b=r._asyncToGenerator(function*(a){try{this.legendElements=(this.hideLayersNotInCurrentView?yield this._isLayerInCurrentView():1)?yield this._getRendererLegendElements(a):[],this.notifyChange("ready")}catch(c){D.getLogger(this.declaredClass).warn("error while building legend for layer!",c)}});return function(a){return b.apply(this,arguments)}}();k.buildLegendElementsForFeatureReduction=function(){var b=
r._asyncToGenerator(function*(a){try{this.legendElements=(this.hideLayersNotInCurrentView?yield this._isLayerInCurrentView():1)?yield this._getLegendElementsForFeatureReduction(a):[],this.notifyChange("ready")}catch(c){D.getLogger(this.declaredClass).warn("error while building legend for layer!",c)}});return function(a){return b.apply(this,arguments)}}();k.buildLegendElementsForTools=function(){var b=r._asyncToGenerator(function*(){var a=this;const c=this.layer;if("esri.layers.VoxelLayer"===c.declaredClass)this._constructLegendElementsForVoxellayer();
else if("esri.layers.WMTSLayer"===c.declaredClass)this._constructLegendElementsForWMTSlayer();else if("esri.layers.WMSLayer"===c.declaredClass)yield this._constructLegendElementsForWMSSublayers();else if("esri.layers.BuildingSceneLayer"===c.declaredClass)yield this._constructLegendElementsForBuildingSceneLayer();else if("esri.layers.MapImageLayer"===c.declaredClass||"esri.layers.TileLayer"===c.declaredClass||qa(c))yield this._constructLegendElementsForSublayers();else{this._handles.remove("imageryLayers-watcher");
var d="default";if("esri.layers.ImageryLayer"===c.declaredClass){d=c?.renderingRule?.functionName||"default";const f=c.bandIds?.length?c.bandIds.join(""):"###";d=d+"_"+f}yield this._getLegendLayers(`${c.uid}-${d}`).then(function(){var f=r._asyncToGenerator(function*(e){a.legendElements=[];a.notifyChange("ready");e=e.map(function(){var g=r._asyncToGenerator(function*(h){if("esri.layers.ImageryLayer"===c.declaredClass||"esri.layers.ImageryTileLayer"===c.declaredClass){const q=B.watch(()=>["renderingRule"in
c&&c.renderingRule,c.bandIds],()=>F.debounce(r._asyncToGenerator(function*(){M["default"]=null;c.renderer?yield a.buildLegendElementsForRenderer(c.renderer):yield a.buildLegendElementsForTools()}))());a._handles.add(q,"imageryLayers-watcher")}(h=a._generateSymbolTableElementForLegendLayer(h))&&h.infos.length&&("esri.layers.ImageryLayer"===c.declaredClass&&(h.title=c.title),a.legendElements.push(h));a.notifyChange("ready")});return function(h){return g.apply(this,arguments)}}());yield F.eachAlways(e)});
return function(e){return f.apply(this,arguments)}}()).catch(f=>{D.getLogger(this.declaredClass).warn("Request to server for legend has failed!",f)})}});return function(){return b.apply(this,arguments)}}();k._isLayerInCurrentView=function(){var b=r._asyncToGenerator(function*(){const a=this.layer,c=this.layerView,d=c&&"createQuery"in c&&"queryFeatureCount"in c;if(!(d||c&&"createQuery"in a&&"queryFeatureCount"in a))return!0;yield B.whenOnce(()=>!c.updating);const f=d?"createQuery"in c&&c.createQuery():
"createQuery"in a&&a.createQuery();f.geometry=this.view.extent;return 0!==(d?"queryFeatureCount"in c&&(yield c.queryFeatureCount(f)):"queryFeatureCount"in a&&(yield a.queryFeatureCount(f)))});return function(){return b.apply(this,arguments)}}();k._getParentLayerOpacity=function(b){let a=1;const c=b.parent;c&&"uid"in c&&(a=this._getParentLayerOpacity(c));return b.opacity*a};k._isGroupActive=function(){const b=this.children;return b.length?b.some(a=>a.ready):!1};k._isRendererScaleDriven=function(b){return"dot-density"===
b.type||W.test("valueExpression"in b&&b.valueExpression)?!0:(b="visualVariables"in b&&b.visualVariables)?b.some(a=>this._isScaleDrivenSizeVariable(a)):!1};k._isScaleDrivenSizeVariable=function(b){if(b&&"size"!==b.type)return!1;const a=b.minSize,c=b.maxSize;return"object"===typeof a&&a?this._isScaleDrivenSizeVariable(a):"object"===typeof c&&c?this._isScaleDrivenSizeVariable(c):!!b.expression||W.test(b.valueExpression)};k._isLayerScaleDriven=function(b){if("minScale"in b&&0<b.minScale||"maxScale"in
b&&0<b.maxScale)return!0;if("sublayers"in b&&b.sublayers)return b.sublayers.some(c=>this._isLayerScaleDriven(c));const a=b.parent;if(!1===b.loaded&&a&&"esri.layers.MapImageLayer"===a.declaredClass&&"source"in b&&b.source&&"map-layer"===b.source.type)for(const c of a.sourceJSON.layers)if(c.id===b.source.mapLayerId&&(0<c.minScale||0<c.maxScale))return!0;return!1};k._constructLegendElementsForVoxellayer=function(){var b=r._asyncToGenerator(function*(){this.legendElements=[];this._handles.remove("voxel-style-watcher");
this._handles.remove("voxel-current-variable");const a=this.layer;this._handles.add(B.watch(()=>a.currentVariableId,()=>this._constructLegendElementsForVoxellayer()),"voxel-current-variable");this._handles.add(B.watch(()=>a.getVariableStyles(),()=>this._constructLegendElementsForVoxellayer()),"voxel-style-watcher");var c=I.unwrap(a.getVariableStyle(null));const d=[];if(c)if(c.uniqueValues?.length){const e=[];c.uniqueValues.forEach(g=>{g.enabled&&e.push({label:g.label||`${g.value}`,value:g.value,symbol:new ma({color:g.color,
outline:null})})});e.length&&d.push({type:"symbol-table",title:c.label,infos:e})}else if(c.transferFunction){const {colorStops:e,stretchRange:g}=c.transferFunction,h=e.toArray().reverse(),q=g.map((A,l)=>`${0===l?J.SPECIAL_CHARS_LESS_THAN:J.SPECIAL_CHARS_GREATER_THAN} ${Ta.formatNumberLabel(A)}`).reverse(),v=h.map(A=>({color:A.color,value:null,label:null}));v[0].label=q[0];v[v.length-1].label=q[1];d.push({type:"color-ramp",title:c.label,infos:v,preview:E.renderColorRampPreviewHTML(h.map(A=>A.color))})}const f=
a.opacity;c=d.reduce((e,g)=>e.concat(this._getAllInfos(g)),[]).filter(e=>!!e?.symbol).map(e=>this._getSymbolPreview(e,f));yield F.eachAlways(c);this.legendElements=d;this.notifyChange("ready")});return function(){return b.apply(this,arguments)}}();k._constructLegendElementsForWMTSlayer=function(){this.legendElements=[];this._handles.remove("wmts-activeLayer-watcher");const b=this.layer.activeLayer;this._handles.add(B.watch(()=>{const {layer:a}=this;return a&&"activeLayer"in a&&a.activeLayer},()=>
this._constructLegendElementsForWMTSlayer()),"wmts-activeLayer-watcher");if(b.styleId&&b.styles){let a=null;b.styles.some(c=>b.styleId===c.id?(a=c.legendUrl,!0):!1);a&&(this.legendElements=[{type:"symbol-table",title:b.title,infos:[{src:a,opacity:this.opacity}]}])}this.notifyChange("ready")};k._constructLegendElementsForWMSSublayers=function(){var b=r._asyncToGenerator(function*(){this.legendElements=[];this._handles.remove("wms-sublayers-watcher");const a=this.layer;let c=null;if(a.customParameters||
a.customLayerParameters)c={...a.customParameters,...a.customLayerParameters};this._handles.add(B.watch(()=>{const {layer:d}=this;return d&&"sublayers"in d&&d.sublayers},()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher");this.legendElements=yield this._generateLegendElementsForWMSSublayers(a.sublayers,c);this.notifyChange("ready")});return function(){return b.apply(this,arguments)}}();k._generateLegendElementsForWMSSublayers=function(){var b=r._asyncToGenerator(function*(a,
c){const d=[];this._handles.add(a.on("change",()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher");a=a.toArray();for(const f of a)a=B.watch(()=>[f.title,f.visible,f.legendEnabled],()=>this._constructLegendElementsForWMSSublayers()),this._handles.add(a,"wms-sublayers-watcher"),(!this.respectLayerVisibility||f.visible&&f.legendEnabled)&&(a=yield this._generateSymbolTableElementForWMSSublayer(f,c))&&a.infos.length&&d.unshift(a);return d});return function(a,c){return b.apply(this,
arguments)}}();k._generateSymbolTableElementForWMSSublayer=function(){var b=r._asyncToGenerator(function*(a,c){return!a.legendUrl&&a.sublayers?(c=(yield this._generateLegendElementsForWMSSublayers(a.sublayers,c)).filter(d=>d),{type:"symbol-table",title:a.title,infos:c}):this._generateSymbolTableElementForLegendUrl(a,c)});return function(a,c){return b.apply(this,arguments)}}();k._generateSymbolTableElementForLegendUrl=function(){var b=r._asyncToGenerator(function*(a,c){let d=a.legendUrl;if(d){var f=
{type:"symbol-table",title:a.title||a.name||a.id&&a.id+"",infos:[]};c&&(d=Ea.addQueryParameters(d,c));c=null;a=a.layer?.opacity;try{if(c=(yield ka(d,{responseType:"image"})).data)c.style.opacity=a}catch{}f.infos.push({src:d,preview:c,opacity:a});return f}});return function(a,c){return b.apply(this,arguments)}}();k._getLegendLayers=function(b,a){const c=M&&M[b];return c?Promise.resolve(c):this._legendRequest(a).then(d=>{d=d.layers;return M[b]=d})};k._legendRequest=function(b){var a=this.layer;b={f:"json",
dynamicLayers:b};if("esri.layers.ImageryLayer"===a.declaredClass){var c=a.exportImageServiceParameters.renderingRule;c&&(b.renderingRule=JSON.stringify(c.rasterFunctionDefinition||c.toJSON()));a.bandIds&&(b.bandIds=a.bandIds.join());if(a.raster||a.viewId||a.customParameters){const {raster:d,viewId:f,customParameters:e}=a;b={raster:d,viewId:f,...b,...e}}}c=a.url.replace(/(\/)+$/,"");"version"in a&&10.01<=a.version?(a=c.indexOf("?"),c=-1<a?c.substring(0,a)+"/legend"+c.substring(a):c+"/legend"):(a=c.toLowerCase().indexOf("/rest/"),
a=c.substring(0,a)+c.substring(a+5,c.length),c="https://utility.arcgis.com/sharing/tools/legend?soapUrl\x3d"+encodeURI(a)+"\x26returnbytes\x3dtrue");return ka(c,{query:b}).then(d=>d.data)};k._constructLegendElementsForBuildingSceneLayer=function(){var b=r._asyncToGenerator(function*(){this.legendElements=[];this._handles.remove("sublayers-watcher");const a=this.layer;this._handles.add(B.watch(()=>a.sublayers,()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");try{this.legendElements=
yield this._generateLegendElementsForBuildingSublayers(a.sublayers,this.opacity),this.notifyChange("ready")}catch(c){D.getLogger(this.declaredClass).warn("Request to server for legend has failed!",c)}});return function(){return b.apply(this,arguments)}}();k._generateLegendElementsForBuildingSublayers=function(){var b=r._asyncToGenerator(function*(a,c){let d=[];this._handles.add(a.on("change",()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");a=a.toArray();for(const e of a)if(a=
B.watch(()=>["renderer"in e&&e.renderer,e.opacity,e.title,e.visible],()=>this._constructLegendElementsForBuildingSceneLayer()),this._handles.add(a,"sublayers-watcher"),!this.respectLayerVisibility||e.visible){a=e&&null!=e.opacity?e.opacity:null;var f=null!=a?a*c:c;"building-group"===e.type?(a={type:"symbol-table",title:e.title,infos:[]},f=yield this._generateLegendElementsForBuildingSublayers(e.sublayers,f),a.infos.push(...f),d=[a,...d]):e.renderer&&(d=[...(yield this._getRendererLegendElements(e.renderer,
{title:e.title,opacity:f,sublayer:e})),...d])}return d.filter(e=>!!e&&("infos"in e?0<e.infos.length:!0))});return function(a,c){return b.apply(this,arguments)}}();k._constructLegendElementsForSublayers=function(){var b=r._asyncToGenerator(function*(){this.legendElements=[];this._handles.remove("sublayers-watcher");const a=this.layer;this._handles.add(B.watch(()=>a.sublayers,()=>this._constructLegendElementsForSublayers),"sublayers-watcher");try{this.legendElements=yield this._generateLegendElementsForSublayers(a.sublayers,
this.opacity),this.notifyChange("ready")}catch(c){D.getLogger(this.declaredClass).warn("Request to server for legend has failed!",c)}});return function(){return b.apply(this,arguments)}}();k._generateLegendElementsForSublayers=function(){var b=r._asyncToGenerator(function*(a,c,d){const f=this.layer;let e=[];this._handles.add(a.on("change",()=>this._constructLegendElementsForSublayers()),"sublayers-watcher");a=a.toArray();!d&&this.sublayerIds&&this.sublayerIds.length&&(a=this.sublayerIds.map(g=>f.findSublayerById(g)).filter(Boolean));
for(const g of a)if(a=B.watch(()=>[g.renderer,g.opacity,g.title,g.visible,g.legendEnabled],()=>this._constructLegendElementsForSublayers()),this._handles.add(a,"sublayers-watcher"),!this.respectLayerVisibility||g.visible&&g.legendEnabled&&this._isSublayerInScale(g)){a=g&&null!=g.opacity?g.opacity:null;a=null!=a?a*c:c;const h=qa(f)?!0:g.originIdOf("renderer")>P.OriginId.SERVICE;g.renderer&&!g.sublayers&&h?(yield g.load(),e=[...(yield this._getRendererLegendElements(g.renderer,{title:g.title,opacity:a,
sublayer:g})),...e]):(a=yield this._generateSymbolTableElementForSublayer(g,a,d))&&e.unshift(a)}return e.filter(g=>!!g&&("infos"in g?0<g.infos.length:!0))});return function(a,c,d){return b.apply(this,arguments)}}();k._generateSymbolTableElementForSublayer=function(){var b=r._asyncToGenerator(function*(a,c,d){if(!d){d=new Map;var f=this.layer,e=a.source;let g=null;if(e&&("map-layer"!==e.type||e.mapLayerId!==a.id||e.gdbVersion&&e.gdbVersion!==("gdbVersion"in f&&f.gdbVersion))||a.originIdOf("renderer")>
P.OriginId.SERVICE||a.originIdOf("labelingInfo")>P.OriginId.SERVICE||a.originIdOf("labelsVisible")>P.OriginId.SERVICE)e=new Ia.ExportImageParameters({layer:this.layer}),g=e.hasDynamicLayers?e.dynamicLayers:null,e.destroy();(yield this._getLegendLayers(g||`${f.uid}-default`,g)).forEach(h=>d.set(h.layerId,h))}f=d.get(a.id);return(!f||f?.subLayerIds&&f.defaultVisibility)&&a.sublayers?(c=yield this._generateLegendElementsForSublayers(a.sublayers,c,d),{type:"symbol-table",title:a.title,infos:c}):this._generateSymbolTableElementForLegendLayer(f,
a,c)});return function(a,c,d){return b.apply(this,arguments)}}();k._generateSymbolTableElementForLegendLayer=function(b,a,c){if(!b||!b.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(b,a))return null;var d=a?.renderer;let f=a?.title||b.layerName;d&&(!a||a?.originIdOf("renderer")>P.OriginId.SERVICE)&&(d=a?.title||this._getRendererTitle(d,a))&&(f&&"string"!==typeof d&&"title"in d&&(d.title=f),f=d);const e={type:"symbol-table",title:f,legendType:b.legendType?b.legendType:null,infos:[]},
g=a?this._sanitizeLegendForSublayer(b.legend.slice(),a):b.legend;0<b.legendGroups?.length?b.legendGroups.forEach(h=>{const q={type:"symbol-table",title:h.heading,legendType:b.legendType?b.legendType:null,infos:this._generateSymbolTableElementInfosForLegendLayer(g.filter(v=>v.groupId===h.id),b.layerId,c)};0<q.infos?.length&&e.infos.push(q)}):e.infos=this._generateSymbolTableElementInfosForLegendLayer(g,b.layerId,c);return 0<e.infos.length?e:null};k._generateSymbolTableElementInfosForLegendLayer=function(b,
a,c){return b.map(d=>{let f=d.url;if(d.imageData&&0<d.imageData.length)f=`data:image/png;base64,${d.imageData}`;else if(0!==f.indexOf("http"))f=ya.addTokenParameter(`${this.layer.url}/${a}/images/${f}`);else return null;return{label:d.label,src:f,opacity:null==c?this.opacity:c,width:d.width,height:d.height}}).filter(d=>!!d)};k._isSublayerInScale=function(b){const a=b.minScale||0;b=b.maxScale||0;return 0<a&&a<this.scale||b>this.scale?!1:!0};k._isLegendLayerInScale=function(b,a){a=a||this.layer;let c=
null,d=null,f=!0;!a.minScale&&0!==a.minScale||!a.maxScale&&0!==a.maxScale?(0===b.minScale&&a.tileInfo&&(c=a.tileInfo.lods[0].scale),0===b.maxScale&&a.tileInfo&&(d=a.tileInfo.lods[a.tileInfo.lods.length-1].scale)):(c=Math.min(a.minScale,b.minScale)||a.minScale||b.minScale,d=Math.max(a.maxScale,b.maxScale));if(0<c&&c<this.scale||d>this.scale)f=!1;return f};k._sanitizeLegendForSublayer=function(b,a){if("version"in this.layer&&10.1>this.layer.version||0===b.length)return b;a=a.renderer;let c=null,d=null;
b.some(f=>f.values)&&b.some((f,e)=>{f.values||(c=e,d=f,d.label||(d.label="others"));return null!=d});a?"unique-value"===a.type?d&&(b.splice(c,1),b.push(d)):"class-breaks"===a.type&&(d&&b.splice(c,1),b.reverse(),d&&b.push(d)):d&&(b.splice(c,1),b.push(d));return b};k._getRendererLegendElements=function(){var b=r._asyncToGenerator(function*(a,c={}){var d=this.view;d=K(a)||L(a)||V(a)||na(a)||oa(a)||pa(a)?"2d"===d.type||La.isSupportedRenderer3D(a):"raster-stretch"===a.type||"raster-colormap"===a.type||
"raster-shaded-relief"===a.type||ea(a)||fa(a)||ha(a)||"vector-field"===a.type||"flow"===a.type;if(!d)return D.getLogger(this.declaredClass).warn(`Renderer of type '${a.type}' not supported!`),[];if(ea(a)||fa(a)||ha(a)||"esri.renderers.PointCloudRGBRenderer"===a.declaredClass)return this._constructPointCloudRendererLegendElements(a,c);if(oa(a))return this._constructDotDensityRendererLegendElements(a);a=yield this._loadRenderer(a);return pa(a)?this._constructPieChartRendererLegendElements(a):this._constructRendererLegendElements(a,
c)});return function(a){return b.apply(this,arguments)}}();k._getLegendElementsForFeatureReduction=function(){var b=r._asyncToGenerator(function*(a){let c=null;"binning"===a.type?c=a.renderer:"cluster"===a.type&&(c=this._getClusterRenderer(a));return c?this._getRendererLegendElements(c):[]});return function(a){return b.apply(this,arguments)}}();k._getPointCloudRendererTitle=function(b){return b.legendOptions&&b.legendOptions.title||b.field};k._constructPointCloudRendererLegendElements=function(b,
a={}){a=a.title;const c=[];let d=null;var f=null;if(ea(b))d={type:"symbol-table",title:a||this._getPointCloudRendererTitle(b),infos:[]},b.colorClassBreakInfos.forEach(e=>{d.infos.unshift({label:e.label||e.minValue+" - "+e.maxValue,value:[e.minValue,e.maxValue],symbol:this._getAppliedCloneSymbol(X,e.color)})});else if(fa(b)){f=b.stops;let e=null;if(f.length&&(1===f.length&&(e=f[0].color),!e)){const g=f[0].value,h=f[f.length-1].value;null!=g&&null!=h&&(e=Q.getColorFromPointCloudStops(g+(h-g)/2,f))}d=
{type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(X,e||X.color)}]};f=Q.getRampStopsForPointCloud(b.stops);f={type:"color-ramp",title:a||this._getPointCloudRendererTitle(b),infos:f,preview:E.renderColorRampPreviewHTML(f.map(g=>g.color))}}else ha(b)&&(d={type:"symbol-table",title:a||this._getPointCloudRendererTitle(b),infos:[]},b.colorUniqueValueInfos.forEach(e=>{d.infos.push({label:e.label||e.values.join(", "),value:e.values.join(", "),symbol:this._getAppliedCloneSymbol(X,
e.color)})}));d&&d.infos.length&&c.push(d);f&&f.infos.length&&c.push(f);a=c.reduce((e,g)=>e.concat(g.infos),[]).filter(e=>!!e.symbol).map(e=>this._getSymbolPreview(e,this.opacity,{symbolConfig:{applyColorModulation:!!b.colorModulation}}));return F.eachAlways(a).then(()=>c)};k._getElementInfoForDotDensity=function(b,a){const {backgroundColor:c,outline:d,dotSize:f}=b;var e=this.effectList?.effects.map(h=>h.toJSON());e=Ha.effectFunctionsFromJSON(e);e=f+"-"+a+"-"+c+"-"+(d&&JSON.stringify(d.toJSON()))+
"-"+e;const g=this._dotDensityUrlCache;b=g.has(e)?g.get(e):E.renderDotDensityPreviewHTML(b,a);g.set(e,b);a=Pa.renderSymbol([[{shape:{type:"image",x:0,y:0,width:b.width,height:b.height,src:b.src},fill:null,stroke:null,offset:[0,0]}]],[b.width,b.height],{effectView:this.effectList});return{opacity:1,src:b.src,preview:a,width:b.width,height:b.height}};k._constructDotDensityRendererLegendElements=function(b){const a=b.calculateDotValue(this.view.scale),c={type:"symbol-table",title:{value:a&&Math.round(a),
unit:b.legendOptions&&b.legendOptions.unit||""},infos:[]};b.attributes.forEach(d=>{const f=this._getElementInfoForDotDensity(b,d.color);f.label=d.label||d.valueExpressionTitle||d.field;c.infos.push(f)});return Promise.resolve([c])};k._constructPieChartRendererLegendElements=function(){var b=r._asyncToGenerator(function*(a){const c=this.layer.opacity,d=[],f=a.outline;a.attributes.forEach(h=>{const q=new R({color:h.color,outline:f});d.push({label:h.label||h.valueExpressionTitle||h.field,symbol:q})});
var e=d.length?[...d]:[];if(a.othersCategory?.color&&0!==a.othersCategory?.threshold){var g=new R({color:a.othersCategory.color,outline:f});d.push({label:a.othersCategory.label||"Others",symbol:g})}a.defaultColor?.a&&(g=new R({color:a.defaultColor,outline:f}),d.push({label:a.defaultLabel,symbol:g}));g=(yield this._getVisualVariableLegendElements(a,this.layer))||[];d.length&&(g.unshift({type:"symbol-table",title:null,infos:d}),e=e.filter(h=>"Others"!==h.label).map(h=>h.symbol.color).filter(Boolean),
e=E.renderPieChartPreviewHTML(e,{holePercentage:a.holePercentage,backgroundColor:a.backgroundFillSymbol?.color,effectList:this.effectList,outline:f}),g.unshift({type:"pie-chart-ramp",title:this._getRendererTitle(a,this.layer),infos:d,preview:e}));a=g.reduce((h,q)=>h.concat(this._getAllInfos(q)),[]).filter(h=>!!h?.symbol&&!h?.preview).map(h=>this._getSymbolPreview(h,c,{effectList:this.effectList}));yield F.eachAlways(a);return g});return function(a){return b.apply(this,arguments)}}();k._constructRendererLegendElements=
function(){var b=r._asyncToGenerator(function*(a,c={}){const {title:d,sublayer:f}=c,e=f||this.layer;this._hasSizeRamp=this._hasOpacityRamp=this._hasColorRamp=!1;this._scaleDrivenSizeVariable=null;const g=(yield this._getVisualVariableLegendElements(a,e))||[],h={type:"symbol-table",title:d||this._getRendererTitle(a,e),infos:[]};let q=null,v=!1;const A=new Set;if("flow"!==a.type||this._hasSizeRamp)if("univariate-color-size"===("authoringInfo"in a&&a?.authoringInfo)?.type){var l=d,n=Ua(a)?"univariate-above-and-below-ramp":
"univariate-color-size-ramp",u=g.findIndex(m=>"color-ramp"===m.type);u=-1!==u?g.splice(u,1)[0]:null;var p=g.findIndex(m=>"size-ramp"===m.type);p=-1!==p?g.splice(p,1)[0]:null;var w=[];u&&(l=u.title,w.push(u));p&&(l=p.title,w.push(p));0<w.length&&g.push({type:n,title:l,infos:w})}else if(na(a))l=Sa.getHeatmapRampStops(a),g.push({type:"heatmap-ramp",title:d||this._getRendererTitle(a,e),infos:l,preview:E.renderColorRampPreviewHTML(l.map(m=>m.color),{effectList:this.effectList})});else if(V(a)){if((n=a&&
a.authoringInfo)&&"relationship"===n.type){const {focus:m,numClasses:C,field1:N,field2:Z}=n;if(C&&N&&Z){u=[N,Z];n=la.getRotationAngleForFocus(m)||0;for(l of u){const {field:aa,normalizationField:ba,label:G}=l;u=G||{field:this._getFieldAlias(aa,e),normField:ba&&this._getFieldAlias(ba,e)};p=Xa.clone();p.angle=n;h.infos.push({label:u,symbol:p});A.add(p);n+=90}l=la.getRelationshipRampElement({focus:m,numClasses:C,infos:a.uniqueValueInfos});g.unshift(l)}}else if("esri.layers.ImageryLayer"===this.layer.declaredClass||
"esri.layers.ImageryTileLayer"===this.layer.declaredClass)a.uniqueValueInfos.forEach(m=>{m.symbol&&h.infos.push({label:m.label||m.value,value:m.value,symbol:m.symbol})});else{const {field:m,field2:C,field3:N,fieldDelimiter:Z,valueExpression:aa}=a,ba=!(!m&&!aa||!C&&!N),G=[];a.uniqueValueGroups.forEach(sa=>{const ia={type:"symbol-table",title:sa.heading,infos:[]};sa.classes.forEach(O=>{const {symbol:ta,values:Ya}=O;if(ta){var S=[],T=[];for(const Za of Ya){const {value:ua,value2:va,value3:wa}=Za,U=[],
ca=[];if(m||aa)U.push(ua),ca.push(this._getDomainName(m,ua,e));C&&(U.push(va),ca.push(this._getDomainName(C,va,e)));N&&(U.push(wa),ca.push(this._getDomainName(N,wa,e)));S.push(ba?U.join(Z||""):U[0]);T.push(ca.join(" - "))}S=S.join(", ");O=O.label;O||(T=T.filter(Boolean),O=T.length?T.join(", "):S);ia.infos.push({label:O,value:S,symbol:ta})}});ia.infos.length&&G.push(ia)});G.length&&(l=G[0],1===G.length&&"title"in l&&!l.title?h.infos.push(...l.infos):h.infos.push(...G))}a.defaultSymbol&&(h.infos.push({label:a.defaultLabel||
"others",symbol:a.defaultSymbol}),v=!0)}else if(L(a))q=this._isUnclassedRenderer(a),q&&this._hasSizeRamp||(a.classBreakInfos.forEach(m=>{m.symbol&&h.infos.unshift({label:m.label||(q?null:m.minValue+" - "+m.maxValue),value:[m.minValue,m.maxValue],symbol:m.symbol})}),q&&(h.title=null),this._updateInfosforClassedSizeRenderer(a,h.infos)),a.defaultSymbol&&!q&&(h.infos.push({label:a.defaultLabel||"others",symbol:a.defaultSymbol}),v=!0);else if("raster-stretch"===a.type)if("esri.layers.ImageryTileLayer"===
this.layer.declaredClass||"esri.layers.WCSLayer"===this.layer.declaredClass)l=this._constructTileImageryStretchRendererElements(a),"stretch-ramp"===l.type?g.push(l):h.infos=l;else{l=this.layer;a.statistics&&a.statistics.length&&(n=null!=a.statistics[0].min?a.statistics[0].min:a.statistics[0][0],u=null!=a.statistics[0].max?a.statistics[0].max:a.statistics[0][1]);p=[];p=I.unwrap(l.renderingRule?yield l.generateRasterInfo(l.renderingRule):l.serviceRasterInfo);const m=p.keyProperties.BandProperties;w=
ra[l.rasterInfo.pixelType.toLowerCase()];1===p.bandCount?(n=null!=n?n:p.statistics?p.statistics[l.bandIds[0]].min:w[0],u=null!=u?u:p.statistics?p.statistics[l.bandIds[0]].max:w[1],n||u?g.push(this._getStretchLegendElements(a,{min:n,max:u})):this._getServerSideLegend()):l.bandIds&&1===l.bandIds.length?(n=null!=n?n:p.statistics?p.statistics[l.bandIds[0]].min:w[0],u=null!=u?u:p.statistics?p.statistics[l.bandIds[0]].max:w[1],n||u?g.push(this._getStretchLegendElements(a,{min:n,max:u})):this._getServerSideLegend()):
3<=p.bandCount?m&&m.length>=p.bandCount?l.bandIds&&3===l.bandIds.length?(p=l.bandIds.map(C=>m[C].BandName),h.infos=this._createSymbolTableElementMultiBand(p)):"lerc"===l.format?(p=[0,1,2].map(C=>m[C].BandName),h.infos=this._createSymbolTableElementMultiBand(p)):this._getServerSideLegend():"lerc"===l.format?(p=["band1","band2","band3"],h.infos=this._createSymbolTableElementMultiBand(p)):this._getServerSideLegend():this._getServerSideLegend()}else if("raster-colormap"===a.type)a.colormapInfos.forEach(m=>
{h.infos.push({label:m.label,value:m.value,symbol:this._getAppliedCloneSymbol(Wa,m.color)})});else if(K(a)){l=a.symbol;switch(c.geometryType){case "point":l="pointSymbol"in e&&e.pointSymbol;break;case "polyline":l="lineSymbol"in e&&e.lineSymbol;break;case "polygon":l="polygonSymbol"in e&&e.polygonSymbol}n=this._hasClusterSizeVariable&&this._getClusterSymbol()||!this._hasSizeRamp;a.symbol&&n&&h.infos.push({label:a.label,symbol:l})}else"vector-field"===a.type?(a.outputUnit&&(this.title="("+a.toJSON().outputUnit+
")"),h.title=a.attributeField,l=a.getClassBreakInfos(),l?.length?l.forEach(m=>{h.infos.push({label:m.minValue+" - "+m.maxValue,symbol:m.symbol})}):h.infos.push({label:a.attributeField,symbol:a.getDefaultSymbol()})):"raster-shaded-relief"===a.type&&g.push(this._getStretchLegendElements(a,{min:0,max:255}));else l=yield J.getSymbolForFlowRenderer(a),h.infos.push({label:null,symbol:l});const H=a.defaultSymbol;!H||v||K(a)||q&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||g.push({type:"symbol-table",
infos:[{label:a.defaultLabel||"others",symbol:H}]});h.infos.length&&g.unshift(h);const $a=null==c.opacity?this.opacity:c.opacity,ab=this._isTallSymbol("visualVariables"in a&&a.visualVariables),bb="esri.layers.ImageryLayer"===this.layer.declaredClass||"esri.layers.ImageryTileLayer"===this.layer.declaredClass;c=g.reduce((m,C)=>m.concat(this._getAllInfos(C)),[]).filter(m=>!!m?.symbol).map(m=>this._getSymbolPreview(m,$a,{isDefault:m.symbol===H,applyScaleDrivenSize:!A.has(m.symbol),symbolConfig:{isTall:ab,
isSquareFill:bb},effectList:A.has(m.symbol)?null:this.effectList}));a=null;yield F.eachAlways(c);return g});return function(a){return b.apply(this,arguments)}}();k._getServerSideLegend=function(){setTimeout(()=>this.buildLegendElementsForTools(),0)};k._getAllInfos=function(b){const a=b?.infos;return a?a.reduce((c,d)=>c.concat(this._getAllInfos(d)),[]):[b]};k._constructTileImageryStretchRendererElements=function(b){function a(q){const v=(c?.bandIds?.length?c.bandIds:Array.from(Array(Math.min(d.bandCount,
3)).keys())).map(A=>q&&q[A]&&q[A].BandName||"band"+(A+1));3>v.length?v.push(v[1]):3<v.length&&v.splice(3);return v}const c=this.layer,d=c.rasterInfo,f=d.bandCount||b.statistics.length;var e;var g=[];const h=d.keyProperties&&d.keyProperties.BandProperties;(e=b?.statistics?.length?b.statistics:d?.statistics)?(g=void 0!==e[0].min?e[0].min:e[0][0],e=e[0].max||e[0][1]):(e=ra[c.rasterInfo.pixelType.toLowerCase()],g=e[0],e=e[1]);c.hasStandardTime()&&(g=c.getStandardTimeValue(g),e=c.getStandardTimeValue(e));
if(1===d.bandCount||1===c.bandIds?.length)return this._getStretchLegendElements(b,{min:g,max:e});g=h&&h.length>=f?a(h):a();return this._createSymbolTableElementMultiBand(g)};k._getStretchLegendElements=function(b,a){b=Q.getStrectchRampStops(b.colorRamp,a);return{type:"stretch-ramp",title:"",infos:b,preview:E.renderColorRampPreviewHTML(b.map(c=>c.color))}};k._getClusterSymbol=function(){var b=this.layer;const a=(b="featureReduction"in b&&b.featureReduction)&&"symbol"in b&&b.renderer;return a&&!0!==
a?.authoringInfo?.isAutoGenerated?null:b&&"symbol"in b&&b.symbol};k._getSizeLegendElement=function(){var b=r._asyncToGenerator(function*(a,c,d,f){return{type:"size-ramp",title:this._hasClusterSizeVariable?this._getClusterTitle(c):a,infos:yield da.getRampStops(d,c,yield J.getMedianColor(d),this.scale,this.view.type,f,this._hasClusterSizeVariable?this._getClusterSymbol():null)}});return function(a,c,d,f){return b.apply(this,arguments)}}();k._createSymbolTableElementMultiBand=function(b){const a=[],
c=["red","green","blue"];b.forEach((d,f)=>{a.push({label:{colorName:c[f],bandName:d},src:J.RGB_IMG_SOURCE[f],opacity:this.opacity??1})});return a};k._updateInfosforClassedSizeRenderer=function(b,a){const c=b.authoringInfo&&"class-breaks-size"===b.authoringInfo.type,d=b.classBreakInfos.some(f=>Qa.isVolumetricSymbol(f.symbol));if(c&&d){const f=da.REAL_WORLD_MAX_SIZE;b=b.classBreakInfos.length;const e=(f-da.REAL_WORLD_MIN_SIZE)/(1<b?b-1:b);a.forEach((g,h)=>{g.size=f-e*h})}};k._isTallSymbol=function(b){let a=
!1,c=!1;if(b)for(let d=0;d<b.length&&(!a||!c);d++){const f=b[d];"size"===f.type&&("height"===f.axis&&(a=!0),"width-and-depth"===f.axis&&(c=!0))}return a&&c};k._getSymbolPreview=function(){var b=r._asyncToGenerator(function*(a,c,d){var f=!d?.isDefault&&null==a.size&&this._hasSizeRamp?Da.px2pt(Oa.SymbolSizeDefaults.size):a.size;this._scaleDrivenSizeVariable&&d?.applyScaleDrivenSize&&({getSize:f}=yield new Promise((e,g)=>xa(["../../../renderers/visualVariables/support/visualVariableUtils"],e,g)),f=f(this._scaleDrivenSizeVariable,
null,{view:this.view.type,scale:this.scale,shape:"simple-marker"===a.symbol.type?a.symbol.style:null}));return E.renderPreviewHTML(a.symbol,{size:f,opacity:c,scale:!1,symbolConfig:d?.symbolConfig,effectView:d?.effectList}).then(e=>{a.preview=e;return a}).catch(()=>{a.preview=null;return a})});return function(a,c,d){return b.apply(this,arguments)}}();k._getClusterRenderer=function(b){this._hasClusterSizeVariable=!1;var a="renderer"in this.layer&&this.layer.renderer;a=b.renderer?.clone()||a?.clone();
const c=I.unwrap(Ra.getClusterSizeVariable(this.layerView._effectiveRenderer,this.view));if(c&&"visualVariables"in a&&!a.visualVariables?.some(d=>"size"===d.type&&"outline"!==d.target&&!W.test(d.valueExpression))){if("clusterMinSize"in b&&"clusterMaxSize"in b){const {clusterMinSize:d,clusterMaxSize:f}=b;c.legendOptions=new Ma({showLegend:d!==f})}a.visualVariables=(a.visualVariables||[]).concat([c]);this._hasClusterSizeVariable=!0}return a};k._loadRenderer=function(){var b=r._asyncToGenerator(function*(a){const c=
[],d=a.clone(),f=yield J.getMedianColor(d);if(L(d)||V(d))a=(d.classBreakInfos||d.uniqueValueInfos).map(e=>this._fetchSymbol(e.symbol,f).then(g=>{e.symbol=g}).catch(()=>{e.symbol=null})),Array.prototype.push.apply(c,a);c.push(this._fetchSymbol(d.symbol||d.defaultSymbol,d.defaultSymbol?null:f).then(e=>{this._applySymbolToRenderer(d,e,K(d))}).catch(()=>{this._applySymbolToRenderer(d,null,K(d))}));return F.eachAlways(c).then(()=>d)});return function(a){return b.apply(this,arguments)}}();k._applySymbolToRenderer=
function(b,a,c){c?b.symbol=a:b.defaultSymbol=a};k._fetchSymbol=function(){var b=r._asyncToGenerator(function*(a,c){if(!a)throw Error();if("web-style"===a.type){const d=this._webStyleSymbolCache;try{const f=yield"2d"===this.view.type?a.fetchCIMSymbol({cache:d}):a.fetchSymbol({cache:d});return this._getAppliedCloneSymbol(f,c)}catch{throw D.getLogger(this.declaredClass).warn("Fetching web-style failed!"),Error();}}return this._getAppliedCloneSymbol(a,c)});return function(a,c){return b.apply(this,arguments)}}();
k._getAppliedCloneSymbol=function(b,a){if(!b||!a)return b;b=b.clone();const c=a&&a.toRgba();b.type.includes("3d")?this._applyColorTo3dSymbol(b,c):"cim"===b.type?Na.applyCIMSymbolColor(b,a):b.color&&(b.color=new ja(c||b.color));return b};k._applyColorTo3dSymbol=function(b,a){a&&b.symbolLayers.forEach(c=>{c&&(c.material||(c.material={}),c.material.color=new ja(a))})};k._getVisualVariableLegendElements=function(){var b=r._asyncToGenerator(function*(a,c){var d=this;if(!("visualVariables"in a&&a.visualVariables)||
"vector-field"===a.type)return null;var f=a.visualVariables,e=[];const g=[],h=[];for(const l of f)"color"===l.type?e.push(l):"size"===l.type?g.push(l):"opacity"===l.type&&h.push(l);f=[...e,...g,...h];let q;if(0===e.length&&L(a)&&a.classBreakInfos&&1===a.classBreakInfos.length)var v=(v=a.classBreakInfos[0])&&v.symbol;0===e.length&&K(a)&&(v=a.symbol);v&&(v.type.includes("3d")?(e=v.symbolLayers.getItemAt(0),"water"===e.type?I.isSome(e.color)&&(q=e.color):I.isSome(e.material)&&I.isSome(e.material.color)&&
(q=e.material.color)):v.url||(q=v.color));const A=this.effectList;return(yield Promise.all(f.map(function(){var l=r._asyncToGenerator(function*(n){if(!n.legendOptions||!1!==n.legendOptions.showLegend){const p="flow"===a.type?n.field:d._getRampTitle(n,c);let w=null;var u="getField"in c&&c.getField&&c.getField(n.field);u=u&&Ja.isDateField(u);"color"===n.type?(n=yield Q.getRampStops(n,null,u),w={type:"color-ramp",title:p,infos:n,preview:E.renderColorRampPreviewHTML(n.map(H=>H.color),{effectList:A})},
d._hasColorRamp||(d._hasColorRamp=!(null==w.infos||!w.infos.length))):"size"===n.type&&"outline"!==n.target?W.test(n.valueExpression)?d._hasClusterSizeVariable||(d._scaleDrivenSizeVariable=n):(w=yield d._getSizeLegendElement(p,n,a,u),d._hasSizeRamp||(d._hasSizeRamp=!(null==w.infos||!w.infos.length))):"opacity"===n.type&&(n=yield Q.getRampStops(n,q,u),w={type:"opacity-ramp",title:p,infos:n,preview:E.renderColorRampPreviewHTML(n.map(H=>H.color),{effectList:A})},d._hasOpacityRamp||(d._hasOpacityRamp=
!(null==w.infos||!w.infos.length)));return w&&w.infos?w:null}});return function(n){return l.apply(this,arguments)}}()))).filter(l=>!!l)});return function(a,c){return b.apply(this,arguments)}}();k._getDomainName=function(b,a,c){return b&&"function"!==typeof b?(c=(b="getField"in c&&c.getField&&c.getField(b))&&"getFieldDomain"in c&&c.getFieldDomain?c.getFieldDomain(b.name):null)&&"coded-value"===c.type?c.getName(a):null:null};k._getClusterTitle=function(b){var a=this.layer;b=b.field;if("featureReduction"in
a&&a.featureReduction&&"cluster"===a.featureReduction.type&&(a=a.featureReduction,a=(a="popupTemplate"in a&&a.popupTemplate)&&a.fieldInfos))for(const c of a)if(c.fieldName===b)return"cluster_count"===b?c.label||{showCount:!0}:c.label;return{showCount:!0}};k._getRampTitle=function(b,a){let c=b.field,d=b.normalizationField,f=!1,e=!1,g=!1;var h=null;c="function"===typeof c?null:c;d="function"===typeof d?null:d;h=b.legendOptions&&b.legendOptions.title;if(null==h)if(b.valueExpressionTitle)h=b.valueExpressionTitle;
else{if("renderer"in a&&a.renderer&&"authoringInfo"in a.renderer&&a.renderer.authoringInfo&&a.renderer.authoringInfo.visualVariables)for(b=a.renderer.authoringInfo.visualVariables,h=0;h<b.length;h++){const q=b[h];if("color"===q.type){if("ratio"===q.style){f=!0;break}if("percent"===q.style){e=!0;break}if("percent-of-total"===q.style){g=!0;break}}}h={field:c&&this._getFieldAlias(c,a),normField:d&&this._getFieldAlias(d,a),ratio:f,ratioPercent:e,ratioPercentTotal:g}}return h};k._getRendererTitle=function(b,
a){if(b.legendOptions&&b.legendOptions.title)return b.legendOptions.title;if(b.valueExpressionTitle)return b.valueExpressionTitle;var c=b.field;let d=null,f=null;L(b)&&(d=b.normalizationField,f="percent-of-total"===b.normalizationType);c="function"===typeof c?null:c;d="function"===typeof d?null:d;if(V(b)){const {field2:e,field3:g,fieldDelimiter:h}=b;c=c&&this._getFieldAlias(c,a);e&&(c=`<${c}>${h}<${this._getFieldAlias(e,a)}>`,g&&(c=`${c}${h}<${this._getFieldAlias(g,a)}>`));return c}b=null;if(c||d)b=
{field:c&&this._getFieldAlias(c,a),normField:d&&this._getFieldAlias(d,a),normByPct:f};return b};k._getFieldAlias=function(b,a){var c="popupTemplate"in a&&a.popupTemplate;c=c&&c.fieldInfos;let d=null;c&&c.some(g=>b===g.fieldName?(d=g,!0):!1);c=null;"getField"in a&&a.getField?c=a.getField(b):"fieldsIndex"in a&&a.fieldsIndex&&(c=a.fieldsIndex.get(b));let f=null;if(a="featureReduction"in a&&a.featureReduction)!d&&"popupTemplate"in a&&a.popupTemplate&&a.popupTemplate.fieldInfos&&a.popupTemplate.fieldInfos.some(g=>
b?.toLowerCase()===g.fieldName?.toLowerCase()?(d=g,!0):!1),"fields"in a&&a.fields&&(f=a.fields.find(g=>g.name?.toLowerCase()===b?.toLowerCase()));a=d||c||f;let e=null;a&&(e=d?.label||c?.alias||f?.alias||"name"in a&&a.name||"fieldName"in a&&a.fieldName);return e};k._isUnclassedRenderer=function(b){const a=b.visualVariables;let c=!1;L(b)&&b.classBreakInfos&&1===b.classBreakInfos.length&&a&&(c=b.field?a.some(d=>!(!d||b.field!==d.field||(b.normalizationField||d.normalizationField)&&b.normalizationField!==
d.normalizationField)):!!a.length);return c};r._createClass(Y,[{key:"effectList",get:function(){const b=this.layer;let a=null;"effect"in b&&b.effect&&(a=new Ga.EffectView,a.effect=b.effect,a.endTransitions(),a.scale=this.scale);return a}},{key:"opacity",get:function(){const b=this.layer.opacity,a=this.parent?.opacity;var c=this.layer.parent;c=c&&"uid"in c?this._getParentLayerOpacity(c):null;return null!=a?a*b:null!=c?c*b:b}},{key:"ready",get:function(){return null===this.layer?!0:0<this.children.length?
this._isGroupActive():0<this.legendElements.length}},{key:"scale",get:function(){return this.view&&this.view.scale}},{key:"isScaleDriven",get:function(){const b=this.layer;if(null===b)return!1;if("effect"in b&&b.effect&&Array.isArray(b.effect))return!0;if("featureReduction"in b&&b.featureReduction){if("cluster"===b.featureReduction.type)return!0;if("binning"===b.featureReduction.type&&"renderer"in b.featureReduction&&b.featureReduction.renderer)return this._isRendererScaleDriven(b.featureReduction.renderer)}return"renderer"in
b&&b.renderer?this._isRendererScaleDriven(b.renderer):this._isLayerScaleDriven(this.layer)}},{key:"version",get:function(){return this._get("version")+1}}]);return Y}(za);y.__decorate([z.property()],x.prototype,"children",void 0);y.__decorate([z.property({readOnly:!0})],x.prototype,"effectList",null);y.__decorate([z.property()],x.prototype,"layerView",void 0);y.__decorate([z.property()],x.prototype,"layer",void 0);y.__decorate([z.property()],x.prototype,"legendElements",void 0);y.__decorate([z.property({readOnly:!0})],
x.prototype,"opacity",null);y.__decorate([z.property()],x.prototype,"parent",void 0);y.__decorate([z.property({readOnly:!0,dependsOn:[]})],x.prototype,"ready",null);y.__decorate([z.property()],x.prototype,"hideLayersNotInCurrentView",void 0);y.__decorate([z.property()],x.prototype,"keepCacheOnDestroy",void 0);y.__decorate([z.property()],x.prototype,"respectLayerVisibility",void 0);y.__decorate([z.property({readOnly:!0})],x.prototype,"scale",null);y.__decorate([z.property()],x.prototype,"sublayerIds",
void 0);y.__decorate([z.property({readOnly:!0})],x.prototype,"isScaleDriven",null);y.__decorate([z.property()],x.prototype,"title",void 0);y.__decorate([z.property({readOnly:!0,dependsOn:["ready"],value:0})],x.prototype,"version",null);y.__decorate([z.property()],x.prototype,"view",void 0);return x=y.__decorate([Fa.subclass("esri.widgets.Legend.support.ActiveLayerInfo")],x)});