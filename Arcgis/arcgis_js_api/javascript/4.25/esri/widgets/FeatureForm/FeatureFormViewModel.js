// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../Graphic ../../intl ../../core/Evented ../../core/HandleOwner ../../core/Logger ../../core/maybe ../../core/Promise ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/arrayUtils ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ../../form/FormTemplate ../../layers/support/ContingentValue ../../layers/support/editableLayers ../../layers/support/LayerContingentValuesCache ./FormExpressionArcadeExecutor ./FormExpressionsManager ./InputField ./InputFieldGroup ../../intl/locale ../../intl/messages".split(" "),
function(y,p,m,W,G,H,B,q,I,C,r,X,Y,J,K,D,L,M,N,O,E,P,Q,R){const z=new m({attributes:{}}),S=["editableExpression","requiredExpression","valueExpression","visibilityExpression"],T=["visibilityExpression"];m=function(x){function u(a){a=x.call(this,a)||this;a._expressionExecutorLookup=new Map;a._expressionLookup=new Map;a._expressionsManager=null;a._contingentValuesCache=null;a._featureClone=z.clone();a._initialFeature=z.clone();a.arcadeEditType="NA";a.contingencyConstraintViolations=new Map;a.inputFields=
[];a.messages=null;a.strict=!1;return a}y._inheritsLoose(u,x);var l=u.prototype;l.initialize=function(){var a=this;const b=function(){var e=y._asyncToGenerator(function*(){const f=yield R.fetchMessageBundle("esri/widgets/FeatureForm/t9n/FeatureForm");a.messages=f;for(const g of a.allInputFields)g.messages=f});return function(){return e.apply(this,arguments)}}();b();const d=C.watch(()=>[this.layer,this.layer?.loaded,this.formTemplate],()=>{q.isSome(this.layer)&&this.layer.loaded&&this._updateInputFields()},
{equals:([e,f,g],[k,h,n])=>e===k&&f===h&&g===n,initial:!0}),c=C.watch(()=>this.layer,e=>{"feature"===e?.type&&this.addResolvingPromise(M.createLoadedLayerContingentValuesCache(e).then(f=>{this._contingentValuesCache=f;this.notifyChange("fieldsWithContingentValues")}))},{initial:!0});this.handles.add([Q.onLocaleChange(b),d,c])};l.destroy=function(){this.layer=this.feature=null;this._contingentValuesCache=q.destroyMaybe(this._contingentValuesCache)};l.findField=function(a){return this.allInputFields.find(b=>
b.name===a)};l.getValue=function(a){const {_featureClone:b,layer:d}=this,c=!!d?.getField(a);return b.getAttribute(a)??(c?null:void 0)};l.setValue=function(a,b){const {_featureClone:d,strict:c}=this,e=this.findField(a);b=""===b?null:b;e&&d.getAttribute(a)!==b&&(e.value=b,!c||e.valid)&&(this._afterValueChange(e),q.isSome(this._expressionsManager)&&this.updatingHandles.addPromise(this._expressionsManager.evaluateInvalidated([e.name]).finally(()=>this._afterExpressionsEvaluated())))};l.getValues=function(){return{...this._featureClone.attributes}};
l.submit=function(){var a=this.allInputFields;const b=new Set(a.filter(c=>c.valid).map(({name:c})=>c));a=a.filter(c=>!c.valid).map(({name:c})=>c);const d=this.getValues();if(0<this.validateContingencyConstraints(d,{includeIncompleteViolations:!0}).length)for(const [c,e]of this.contingencyConstraintViolations.entries())"error"===e.type&&(b.delete(c),a.push(c));this.emit("submit",{valid:[...b],invalid:a,values:d})};l.validateContingencyConstraints=function(a,b){const {_contingentValuesCache:d}=this,
c=new Map;this.contingencyConstraintViolations=c;if(q.isNone(d))return[];const {invalid:e,incomplete:f}=d.validateContingencyConstraints(a);a=[...e,...(b?.includeIncompleteViolations?f:[])];for(const g of a)for(const k of g.fieldGroup.fields)c.set(k,g);return a};l.notifyFeatureGeometryChanged=function(){const {_expressionsManager:a,feature:b,_featureClone:d}=this;d.geometry=b.geometry;q.isSome(a)&&this.updatingHandles.addPromise(a.evaluateInvalidatedByGeometry().finally(()=>this._afterExpressionsEvaluated()))};
l._emitChangeEvent=function({name:a,valid:b,value:d}){this.emit("value-change",{layer:this.layer,feature:this.feature,fieldName:a,value:d,valid:b})};l._updateInputFields=function(){const {_featureClone:a,_initialFeature:b,formTemplate:d,inputFields:c,messages:e,layer:f}=this,g={feature:a,initialFeature:b,layer:f,messages:e},k=c.slice();this.inputFields=q.isSome(d)&&0<d.elements.length?this._updateInputFieldsFromElements(k,d.elements,g):this._updateInputFieldsFromLayerFields(k,f?.fields,g)};l._updateInputFieldsFromElements=
function(a,b,d){const c=new Map;for(const f of a)if(f.inputFields){A(c,f.groupElement,f);for(const g of f.inputFields)A(c,g.fieldElement,g)}else A(c,f.fieldElement,f);a=new Map;const e=this._updateInputFieldsRecursive({existingInputFieldsByElement:c,updatedElements:b.filter(this._isSupportedElement),sharedInitializationProperties:d,group:null,newExpressionExecutorPromises:a});this.updatingHandles.addPromise(Promise.all(Array.from(a.values())).then(()=>{const f=Array.from(this._expressionExecutorLookup.values()),
g=F(e);this._createExpressionsManager(f,g);return q.unwrap(this._expressionsManager).evaluateAll().finally(()=>this._afterExpressionsEvaluated())}));for(const [f,g]of c.entries())c.delete(f),g.destroy();return e};l._updateInputFieldsRecursive=function(a){const {existingInputFieldsByElement:b,updatedElements:d,sharedInitializationProperties:c,group:e,newExpressionExecutorPromises:f}=a;a=[];for(const k of d){var g=b.has(k);const h=g?b.get(k):"group"===k.type?this._makeInputFieldGroupFromGroupElement(k,
c):this._makeInputFieldFromFieldElement(k,c,e);a.push(h);g?(b.delete(k),h.inputFields?({feature:g}=c,h.set({feature:g})):h.set(c)):this._assignExpressionExecutors(h,k,f);"group"===k.type&&(g=k.elements.filter(n=>this._isSupportedElement(n)),h.inputFields=this._updateInputFieldsRecursive({existingInputFieldsByElement:b,updatedElements:g,sharedInitializationProperties:c,group:h,newExpressionExecutorPromises:f}))}return a};l._updateInputFieldsFromLayerFields=function(a,b,d){if(!Array.isArray(b))return B.getLogger(this.declaredClass).warn(this.declaredClass,
"No attribute fields found."),[];const c=new Map;for(const h of a)if(h.inputFields){for(const n of h.inputFields)n.destroy();h.inputFields.length=0;h.destroy()}else q.isSome(h.fieldElement)?h.destroy():c.set(h.field,h);a=[];const {feature:e,initialFeature:f,layer:g,messages:k}=d;for(const h of b)b=c.get(h)??new E({field:h,feature:e,initialFeature:f,layer:g,messages:k,value:e.getAttribute(h.name)??null}),a.push(b),c.delete(h);for(const [h,n]of c.entries())c.delete(h),n.destroy();return a};l._resetInputFieldValues=
function(a){for(const b of this.allInputFields)b.value=a.getAttribute(b.name)};l._makeInputFieldFromFieldElement=function(a,b,d=null){const {feature:c,initialFeature:e,layer:f,messages:g}=b;return new E({fieldElement:a,field:this._layerFieldsByName.get(a.fieldName),value:c.getAttribute(a.fieldName)??null,feature:c,initialFeature:e,layer:f,group:d,messages:g})};l._makeInputFieldGroupFromGroupElement=function(a,b){const {feature:d,initialFeature:c}=b;return new P({groupElement:a,inputFields:[],feature:d,
initialFeature:c})};l._assignExpressionExecutors=function(a,b,d){var c="group"===b.type?T:S;for(const e of c){c=b[e];const {_expressionExecutorLookup:f}=this;if(q.isSome(c)&&""!==c){const g=`${e}Executor`,k=this._expressionLookup.get(c)??this._addToExpressionLookup(c);f.has(k)?a[g]=f.get(k):d.has(k)?(c=d.get(k).then(h=>a[g]=h),d.set(k,c)):(c=N.createFormExpressionArcadeExecutor(k,this.layer).then(h=>{a[g]=h;f.set(k,h);return h}),d.set(k,c))}}return[]};l._createExpressionsManager=function(a,b){const {_arcadeContextInfo:d,
_featureClone:c}=this;this._expressionsManager=new O.FormExpressionsManager({executors:a,feature:c,arcadeContextInfo:d,inputFields:b})};l._afterValueChange=function(a){const {name:b,value:d}=a;if(this.get("layer.typeIdField")===b&&"types"in this.layer){const c=new Set;this.layer.types.forEach(e=>Object.keys(e.domains).forEach(f=>c.add(f)));c.forEach(e=>{(e=this.findField(e))&&e.notifyChange("domain")})}this._featureClone.setAttribute(b,d);this._emitChangeEvent(a)};l._afterExpressionsEvaluated=function(){const {_featureClone:a}=
this;for(const b of this.allInputFields)b.value!==a.getAttribute(b.name)&&this._afterValueChange(b)};l._addToExpressionLookup=function(a){const {_expressionLookup:b,formTemplate:d}=this,c=(q.isSome(d)&&q.isSome(d.expressionInfos)?Object.values(d.expressionInfos).find(e=>e.name===a):null)?.expression??a;b.set(a,c);a!==c&&b.set(c,c);return c};l._isSupportedElement=function(a){if("field"===a.type||"group"===a.type)return!0;B.getLogger(this.declaredClass).warn("form-info::unsupported-element-type","Only element types 'field' and 'group' are supported",
`Element ${a.label} has unsupported type '${a.type}'`);return!1};l._joinContingentValues=function(){var a=this._contingentValuesCache;if(q.isNone(a))return[];var b="typeIdField"in this.layer?this.layer.typeIdField:null;b=b?this.getValue(b):null;const d=[];for(var c of a.fieldGroups){const {contingencies:k,fields:h,name:n}=c;a=[];for(var e of k)e.isRetired||q.isSome(e.subtype)&&e.subtype.code!==b||a.push({values:e.values});0<a.length&&d.push({name:n,fields:h,contingencies:a})}const [f,g]=this._generateJoinPlan(d);
c=f.flatMap(k=>this._joinFieldGroupContingencies(k));e=g.flatMap(k=>k.contingencies);return[...c,...e]};l._generateJoinPlan=function(a){var b=new Map,d=[],c=new Set;for(var e of a)for(const h of e.fields)if(b.has(h)){const n=b.get(h),t=e,v=[n.name,t.name].sort().join("|");c.has(v)||(d.push([n,t]),c.add(v),b.set(h,t))}else b.set(h,e);b=new Set(d.flat());a=new Set(a);for(var f of b)a.delete(f);f=new Map;b=new Map;for(var g of new Set(d.flat()))c=Symbol(g.name),f.set(c,new Set([g])),b.set(g,c);for(const [h,
n]of d)if(d=b.get(h),g=b.get(n),d!==g){c=f.get(d);e=f.get(g);for(var k of e)c.add(k),b.set(k,d);f.delete(g)}k=[...f.values()].map(h=>[...h]);d=[...a];return[k,d]};l._joinFieldGroupContingencies=function(a){const b=a.slice();var d=b.shift(),c=b.shift();a=this._generateJoinKey(d.fields,c.fields);let e=new Set([...d.fields,...c.fields]),f=new Map;for(var g of d.contingencies)[d]=this._hashContingency(g,a.codedValueFields,!0),f.has(d)?f.get(d).push(g):f.set(d,[g]);for(;0<b.length;){g=new Map;d=b.shift();
const n=this._generateJoinKey(e,d.fields);for(var k of c.contingencies){const [t,v]=this._hashContingency(k,a.codedValueFields);c=v?this._findMatchingContingenciesWithAnyHashMask(f,t):f.get(t);f.has("#JSAPI_CONTINGENT_VALUE_ANY_HASH")&&c.push(...this._findMatchingContingenciesContainingAny(k,f.get("#JSAPI_CONTINGENT_VALUE_ANY_HASH"),a.codedValueFields));if(!q.isNone(c))for(var h of c){c=0<a.rangeFields.length?this._joinContingenciesWithRangeDomains(h,k,a.rangeFields):this._joinContingencies(h,k);
if(q.isNone(c))break;const [w]=this._hashContingency(c,n.codedValueFields,!0);g.has(w)?g.get(w).push(c):g.set(w,[c])}}f=g;c=d;a=n;e=new Set([...e,...c.fields])}k=[];for(const n of c.contingencies){const [t,v]=this._hashContingency(n,a.codedValueFields);h=v?this._findMatchingContingenciesWithAnyHashMask(f,t):f.get(t);f.has("#JSAPI_CONTINGENT_VALUE_ANY_HASH")&&h.push(...this._findMatchingContingenciesContainingAny(n,f.get("#JSAPI_CONTINGENT_VALUE_ANY_HASH"),a.codedValueFields));if(!q.isNone(h))for(const w of h)h=
0<a.rangeFields.length?this._joinContingenciesWithRangeDomains(w,n,a.rangeFields):this._joinContingencies(w,n),q.isSome(h)&&k.push(h)}return k};l._joinContingencies=function(a,b){b={values:{...a.values,...b.values}};for(const [d,c]of Object.entries(b.values))"any"===c.objectType&&q.isSome(a.values[d])&&(b.values[d]=a.values[d]);return b};l._joinContingenciesWithRangeDomains=function(a,b,d){const c=this._joinContingencies(a,b);for(const f of d){var e=a.values[f];const g=b.values[f],{leftIsNull:k,rightIsNull:h,
bothAreNull:n,leftIsAny:t,rightIsAny:v,bothAreAny:w,leftIsRange:U,rightIsRange:V}=this._compareObjectTypes(e.objectType,g.objectType);if(!n&&!w)if(k&&v||h&&t)c.values[f]=new D({objectType:"null"});else{if(k&&V||h&&U)return null;t?(e.minValue=-Infinity,e.maxValue=Infinity):v&&(g.minValue=-Infinity,g.maxValue=Infinity);d=Math.max(e.minValue,g.minValue);e=Math.min(e.maxValue,g.maxValue);if(d>e)return null;c.values[f]=new D({objectType:"range",minValue:d,maxValue:e})}}return c};l._findMatchingContingenciesContainingAny=
function(a,b,d){return b.filter(c=>d.every(e=>{const f=c.values[e];e=a.values[e];return"any"===f.objectType||"any"===e.objectType||f.codedValue?.code===e.codedValue?.code}))};l._findMatchingContingenciesWithAnyHashMask=function(a,b){b=RegExp(`${b}$`);const d=[];for(const [c,e]of a){if("#JSAPI_CONTINGENT_VALUE_ANY_HASH"===c)break;b.test(c)&&d.push(...e)}return d};l._generateJoinKey=function(a,b){a=Array.isArray(a)?new Set(a):a;var d=Array.isArray(b)?new Set(b):b;b=a.size<d.size?a:d;a=b===a?d:a;d=new Set;
const c=new Set;for(const e of b)if(a.has(e)&&(b=this.layer.getFieldDomain(e,{feature:this.feature}),!q.isNone(b)))switch(b.type){case "coded-value":d.add(e);break;case "range":c.add(e)}return{codedValueFields:[...d],rangeFields:[...c]}};l._hashContingency=function(a,b,d=!1){if(1>b.length)return["#JSAPI_CONTINGENT_VALUE_EMPTY_HASH",!1];const c=[];let e=!1;for(const f of b)if(b=a.values[f],"any"===b.objectType){if(d)return["#JSAPI_CONTINGENT_VALUE_ANY_HASH",!0];e=!0;c.push(`${f}:.*`)}else"null"===
b.objectType?c.push(`${f}:${"#JSAPI_CONTINGENT_VALUE_NULL_HASH"}`):c.push(`${f}:${b.codedValue?.code}`);return[c.sort().join("\x26"),e]};l._compareObjectTypes=function(a,b){return{leftIsNull:"null"===a,rightIsNull:"null"===b,bothAreNull:"null"===a&&"null"===b,leftIsAny:"any"===a,rightIsAny:"any"===b,bothAreAny:"any"===a&&"any"===b,leftIsRange:"range"===a,rightIsRange:"range"===b}};y._createClass(u,[{key:"_arcadeContextInfo",get:function(){const {_initialFeature:a,arcadeEditType:b,layer:d,spatialReference:c,
view:e}=this;return{layer:L.isEditableLayer(d)?d:null,originalFeature:a,editType:b,spatialReference:c,map:e?.map}}},{key:"updating",get:function(){return this.updatingHandles.updating}},{key:"allInputFields",get:function(){return F(this.inputFields)}},{key:"_layerFieldsByName",get:function(){return new Map(this.layer.fields.map(a=>[a.name,a]))}},{key:"feature",get:function(){return this._get("feature")},set:function(a){this._featureClone=a?a.clone():z.clone();this._initialFeature=this._featureClone.clone();
this._resetInputFieldValues(this._featureClone);this.contingencyConstraintViolations.clear();q.isSome(this._expressionsManager)&&(this._expressionsManager.resetExecutors(),this._expressionsManager.feature=this._featureClone,this.updatingHandles.addPromise(this._expressionsManager.evaluateAll().finally(()=>this._afterExpressionsEvaluated())));this._set("feature",a)}},{key:"fieldsWithContingentValues",get:function(){if(q.isNone(this._contingentValuesCache))return new Set;const a=this._contingentValuesCache.fieldGroups.flatMap(b=>
b.fields);return new Set(a)}},{key:"formTemplate",get:function(){return this.layer&&"formTemplate"in this.layer?this.layer.formTemplate:null},set:function(a){this._override("formTemplate",a)}},{key:"joinedContingentValues",get:function(){return this._joinContingentValues()}},{key:"layer",get:function(){return this.feature?.sourceLayer&&"applyEdits"in this.feature.sourceLayer?this.feature.sourceLayer:null},set:function(a){this._override("layer",a)}},{key:"spatialReference",get:function(){return this.layer?.spatialReference??
null},set:function(a){this._override("spatialReference",a)}},{key:"state",get:function(){return this.messages&&this.get("layer.loaded")?"ready":"disabled"}},{key:"submittable",get:function(){return this.valid?!0:this.allInputFields.filter(a=>!a.valid).every(({submittable:a})=>a)}},{key:"valid",get:function(){const a=this.allInputFields;return 0<a.length&&a.every(({valid:b})=>b)}}]);return u}(H.HandleOwnerMixin(I.EsriPromiseMixin(G.EventedAccessor)));p.__decorate([r.property()],m.prototype,"_arcadeContextInfo",
null);p.__decorate([r.property()],m.prototype,"updating",null);p.__decorate([r.property({readOnly:!0})],m.prototype,"allInputFields",null);p.__decorate([r.property()],m.prototype,"_layerFieldsByName",null);p.__decorate([r.property()],m.prototype,"arcadeEditType",void 0);p.__decorate([r.property()],m.prototype,"contingencyConstraintViolations",void 0);p.__decorate([r.property()],m.prototype,"feature",null);p.__decorate([r.property()],m.prototype,"fieldsWithContingentValues",null);p.__decorate([r.property({type:K})],
m.prototype,"formTemplate",null);p.__decorate([r.property()],m.prototype,"inputFields",void 0);p.__decorate([r.property()],m.prototype,"joinedContingentValues",null);p.__decorate([r.property()],m.prototype,"layer",null);p.__decorate([r.property()],m.prototype,"messages",void 0);p.__decorate([r.property()],m.prototype,"spatialReference",null);p.__decorate([r.property()],m.prototype,"state",null);p.__decorate([r.property()],m.prototype,"strict",void 0);p.__decorate([r.property()],m.prototype,"submittable",
null);p.__decorate([r.property()],m.prototype,"valid",null);p.__decorate([r.property()],m.prototype,"view",void 0);p.__decorate([r.property()],m.prototype,"getValues",null);p.__decorate([r.property()],m.prototype,"submit",null);m=p.__decorate([J.subclass("esri.widgets.FeatureForm.FeatureFormViewModel")],m);const F=x=>x.reduce((u,l)=>l.inputFields?[...u,...l.inputFields]:[...u,l],[]),A=(x,u,l)=>{q.isSome(u)&&x.set(u,l)};return m});