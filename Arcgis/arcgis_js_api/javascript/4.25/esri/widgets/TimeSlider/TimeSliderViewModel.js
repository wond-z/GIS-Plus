// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("require ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../TimeExtent ../../TimeInterval ../../core/Collection ../../core/Evented ../../core/HandleOwner ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/timeUtils ../../core/accessorSupport/decorators/property ../../core/arrayUtils ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ../../webdoc/Widgets ../../webdoc/widgets/TimeSlider".split(" "),
function(G,y,k,p,H,C,f,I,J,c,D,u,K,m,P,E,L,M,N){function B(g){return c.isSome(g)&&void 0!==g.count}function z(g){return c.isSome(g)&&void 0!==g.interval}function F(g){return c.isSome(g)&&void 0!==g.dates}f=function(g){function w(a){a=g.call(this,a)||this;a._animationController=null;a._isViewTimeExtentInitialized=!1;a._timerId=null;a.actions=new C;a.fullTimeExtent=null;a.loop=!1;a.mode="time-window";a.stops={count:10};a.timeExtent=null;a.view=null;return a}y._inheritsLoose(w,g);var l=w.prototype;l.initialize=
function(){this.handles.add([u.watch(()=>this.effectiveStops,()=>{c.isNone(this.timeExtent)&&(this.timeExtent=this._getDefaultTimeExtent())},u.initial),u.watch(()=>this.view,(a,b)=>{this._unregisterWidget(b);this._registerWidget(a)},u.syncAndInitial),u.watch(()=>this.timeExtent,a=>{if(!c.isNone(this.view)){var b=this.view.timeExtent;(c.isNone(a)||a.isAllTime)&&(c.isNone(b)||b.isAllTime)||c.isSome(a)&&c.isSome(b)&&a.equals(b)||(this.view.timeExtent=c.unwrap(a))}},u.initial),u.watch(()=>c.applySome(this.view,
a=>a.timeExtent),a=>{this._isViewTimeExtentInitialized?(c.isNone(a)||a.isAllTime)&&(c.isNone(this.timeExtent)||this.timeExtent.isAllTime)||c.isSome(a)&&c.isSome(this.timeExtent)&&a.equals(this.timeExtent)||(this.timeExtent=a):this._isViewTimeExtentInitialized=!0})])};l.destroy=function(){c.isSome(this._timerId)&&(clearInterval(this._timerId),this._timerId=null);this._unregisterWidget(this.view);this.view=null;c.isSome(this._animationController)&&(this._animationController.abort(),this._animationController=
null)};w.getPropertiesFromWebMap=function(){var a=y._asyncToGenerator(function*(b,d){if(c.isNone(b)||"esri.WebMap"!==b.declaredClass)return null;yield b.load({signal:d});var e=b?.widgets?.timeSlider;if(!e)return null;const {getFullTimeExtentFromWebDocument:n,getModeFromTimeSlider:q,getStopsFromTimeSlider:r,getTimeExtentFromTimeSlider:x}=yield new Promise((A,O)=>G(["./utils"],A,O));b=yield n(b,d);d=e.loop;const h=q(e),v=e.stopDelay??2E3,t=r(e);e=x(e,h);return{fullTimeExtent:b,loop:d,mode:h,playRate:v,
stops:t,timeExtent:e}});return function(b,d){return a.apply(this,arguments)}}();l.next=function(){this._step({forward:!0,allowRestart:!1})};l.play=function(){this._startAnimation()};l.previous=function(){this._step({forward:!1,allowRestart:!1})};l.stop=function(){this._stopAnimation()};l.triggerAction=function(a){this.emit("trigger-action",{action:a})};l.updateWebDocument=function(a){if("esri.WebMap"===a.declaredClass){const b=new N({currentTimeExtent:this.timeExtent,fullTimeExtent:this.fullTimeExtent,
loop:this.loop,numStops:B(this.stops)?this.stops.count:null,numThumbs:"time-window"===this.mode?2:1,stopDelay:this.playRate,stopInterval:z(this.stops)?this.stops.interval:null,stops:F(this.stops)?this.stops.dates:null});a.widgets?a.widgets.timeSlider=b:a.widgets=new M({timeSlider:b})}};l.valuesToTimeExtent=function(a){if(c.isNone(a))return null;var b=a.sort((d,e)=>d-e).map(d=>new Date(d));a=0<b.length?b[0]:null;b=1<b.length?b[1]:null;switch(this.mode){case "time-window":return new p({start:a,end:b});
case "instant":return new p({start:a,end:a});case "cumulative-from-start":return new p({start:null,end:a});case "cumulative-from-end":return new p({start:a,end:null});default:return p.allTime}};l._animate=function(){var a=y._asyncToGenerator(function*(){try{const b=this.view,d=c.applySome(this._animationController,e=>e.signal);yield Promise.all([D.after(this.playRate,null,d),c.isSome(b)&&u.whenOnce(()=>!1===b.updating,d)])}catch(b){D.isAbortError(b)||J.getLogger(this.declaredClass).error(b);this._animationController=
null;return}this._step({forward:!0,allowRestart:!1});c.isNone(this._animationController)||this._animate()});return function(){return a.apply(this,arguments)}}();l._divideTimeExtentByCount=function(a,b=10){if(!a||!b)return[];const {start:d,end:e}=a;if(c.isNone(d)||c.isNone(e))return[];if(1E4<b)return this._divideTimeExtentByCount(a);a=[];const n=d.getTime(),q=e.getTime()-n;for(let r=0;r<=b;r++)a.push(new Date(n+r/b*q));return a};l._divideTimeExtentByInterval=function(a,b,d=1E4){if(!a||!b)return[];
const {start:e,end:n}=a;if(c.isNone(e)||c.isNone(n))return[];const q=n.getTime()-e.getTime(),r=b.toMilliseconds();if(0>=r||q/r>d)return this._divideTimeExtentByCount(a);a=[];const {value:x,unit:h}=b;for(b=e;b.getTime()<=n.getTime();)a.push(new Date(b.getTime())),b=K.offsetDate(b,x,h);return a};l._getDefaultTimeExtent=function(){const {effectiveStops:a,mode:b}=this;if(c.isNone(a)||!b)return null;switch(b){case "time-window":return 1<a.length?new p({start:a[0],end:a[1]}):null;case "cumulative-from-start":return 0<
a.length?new p({start:null,end:a[0]}):null;case "cumulative-from-end":return 0<a.length?new p({start:a[0],end:null}):null;case "instant":return 0<a.length?new p({start:a[0],end:a[0]}):null;default:return null}};l._registerWidget=function(a){c.isSome(a)&&(a.persistableViewModels.includes(this)||a.persistableViewModels.add(this))};l._startAnimation=function(){this._stopAnimation();this._animationController=new AbortController;this._step({forward:!0,allowRestart:!0});this._animate()};l._step=function(a){const {forward:b,
allowRestart:d}=a;({effectiveStops:a}=this);if(!c.isNone(this.timeExtentValues)&&!c.isNone(a)){var e=a.map(h=>h.getTime());a=this.timeExtentValues.map(h=>{var v=e.indexOf(h);if(-1!==v)return v;v=e.reduce((t,A)=>Math.abs(A-h)<Math.abs(t-h)?A:t);return e.indexOf(v)});var n=a.map(h=>h+=b?1:-1),q=n.some(h=>0>h||h>e.length-1),{loop:r,state:x}=this;if(q)if(r||d){const h=Math.min(...a),v=Math.max(...a);a=(b?a.map(t=>t-h):a.map(t=>t+(e.length-1-v))).map(t=>e[t]);this.timeExtent=this.valuesToTimeExtent(a)}else"playing"===
x&&this.stop();else a=n.map(h=>e[h]),this.timeExtent=this.valuesToTimeExtent(a)}};l._stopAnimation=function(){c.isSome(this._animationController)&&(this._animationController.abort(),this._animationController=null)};l._unregisterWidget=function(a){c.isSome(a)&&a.persistableViewModels.remove(this)};y._createClass(w,[{key:"effectiveStops",get:function(){const {fullTimeExtent:a,stops:b}=this;if(F(b)){var {dates:d}=b;if(null==d||0===d.length)return null;d=d.sort((q,r)=>q.getTime()-r.getTime());if(c.isNone(a))return d;
const {start:e,end:n}=a;return c.isNone(e)||c.isNone(n)?d:d.filter(q=>!(q.getTime()<e.getTime()||q.getTime()>n.getTime()))}return B(b)?(d=b.timeExtent??c.unwrap(a),this._divideTimeExtentByCount(d,b.count)):z(b)?(d=b.timeExtent??c.unwrap(a),this._divideTimeExtentByInterval(d,b.interval)):[]}},{key:"playRate",set:function(a){0>=a||36E5<a||("playing"===this.state&&this._startAnimation(),this._set("playRate",a))}},{key:"state",get:function(){return c.isNone(this.fullTimeExtent)?"disabled":c.isSome(this._animationController)?
"playing":"ready"}},{key:"timeExtentValues",get:function(){const {mode:a,timeExtent:b}=this;if(c.isNone(b)||b.isAllTime||b.isEmpty)return null;const {start:d,end:e}=b;switch(a){case "cumulative-from-end":case "instant":return c.isSome(d)?[d.getTime()]:null;case "cumulative-from-start":return c.isSome(e)?[e.getTime()]:null;case "time-window":return c.isSome(d)&&c.isSome(e)?[d.getTime(),e.getTime()]:null}}}]);return w}(I.HandleOwnerMixin(f.EventedAccessor));k.__decorate([m.property()],f.prototype,"_animationController",
void 0);k.__decorate([m.property({type:C})],f.prototype,"actions",void 0);k.__decorate([m.property({readOnly:!0})],f.prototype,"effectiveStops",null);k.__decorate([m.property({type:p})],f.prototype,"fullTimeExtent",void 0);k.__decorate([m.property({nonNullable:!0})],f.prototype,"loop",void 0);k.__decorate([m.property({nonNullable:!0})],f.prototype,"mode",void 0);k.__decorate([m.property({nonNullable:!0,value:1E3})],f.prototype,"playRate",null);k.__decorate([m.property({readOnly:!0})],f.prototype,
"state",null);k.__decorate([m.property({cast:g=>{if(c.isNone(g))return null;z(g)&&(g.interval=E.ensureType(H,g.interval));if(z(g)||B(g))g.timeExtent=E.ensureType(p,g.timeExtent);return g}})],f.prototype,"stops",void 0);k.__decorate([m.property({type:p})],f.prototype,"timeExtent",void 0);k.__decorate([m.property({readOnly:!0})],f.prototype,"timeExtentValues",null);k.__decorate([m.property()],f.prototype,"view",void 0);k.__decorate([m.property()],f.prototype,"next",null);k.__decorate([m.property()],
f.prototype,"play",null);k.__decorate([m.property()],f.prototype,"previous",null);k.__decorate([m.property()],f.prototype,"stop",null);k.__decorate([m.property()],f.prototype,"updateWebDocument",null);return f=k.__decorate([L.subclass("esri.widgets.TimeSlider.TimeSliderViewModel")],f)});