// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/handleUtils ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/Logger ../../core/accessorSupport/ensureType ../../core/arrayUtils ../../core/Error ../../core/has ../../core/accessorSupport/decorators/subclass ../../views/support/layerViewUtils ./Edits ./UpdateWorkflowData ./Workflow ./workflowUtils".split(" "),function(h,O,H,D,A,I,E,U,V,W,X,P,Q,R,S,T,r){var F;E=F=function(J){function w(b){b=
J.call(this,b)||this;b.type="update";return b}h._inheritsLoose(w,J);w.create=function(b,p,a){b=new F({data:new S({edits:new R.Edits,viewModel:b}),onCommit:function(){var f=h._asyncToGenerator(function*(v){const c=v.edits.feature,d=c.sourceLayer,k=c.clone();if(!v.edits.attributesModified){const {objectIdField:e}=d;k.attributes={[e]:c.getAttribute(e)}}v.edits.geometryModified||(k.geometry=null);yield a(d,{updateFeatures:[k]})});return function(v){return f.apply(this,arguments)}}()});b._set("steps",
this._createWorkflowSteps(b,p));return b};var K=w.prototype;K.highlight=function(b){var {data:{viewModel:{view:p}}}=this;p=b&&p.allLayerViews.items.find(({layer:a})=>a===b.layer);Q.highlightsSupported(p)&&this.handles.add(p.highlight(b),"candidate-highlight")};K.unhighlight=function(){this.handles.remove("candidate-highlight")};w._createWorkflowSteps=function(b,p="awaiting-feature-to-update"){const {data:a,handles:f}=b,v=new Map;return r.createWorkflowSteps(["awaiting-feature-to-update","awaiting-update-feature-candidate",
"editing-existing-feature","adding-attachment","editing-attachment"],p,{"awaiting-feature-to-update":()=>({id:"awaiting-feature-to-update",setUp(){var c=this;return h._asyncToGenerator(function*(){const {spinnerViewModel:d,view:k}=a.viewModel;let e=null;f.add({remove(){e&&(e.abort(),e=null)}},c.id);a.edits.feature=null;const m=k.on("immediate-click",B=>{d.location=B.mapPoint;d.visible=!0;e&&e.abort();const {editableItems:C}=a.viewModel;e=new AbortController;(new Promise((l,q)=>{A.onAbort(e.signal,
()=>q(A.createAbortError()));l(r.fetchCandidates(C,k,B,e.signal))})).then(l=>{A.throwIfAborted(e);a.candidates=l.reduce((q,t)=>t.error?q:[...q,...t.value],[]);a.viewModel.spinnerViewModel.visible=1===a.candidates.length;0!==a.candidates.length&&(1===a.candidates.length?(a.edits.feature=a.candidates[0],a.viewModel.activeWorkflow.go("editing-existing-feature").catch(()=>{}).then(()=>a.viewModel.spinnerViewModel.visible=!1)):a.viewModel.activeWorkflow.next())})});k.focus();f.add(m,c.id)})()},tearDown(){var c=
this;return h._asyncToGenerator(function*(){f.remove(c.id)})()}}),"awaiting-update-feature-candidate":()=>({id:"awaiting-update-feature-candidate",setUp(){var c=this;return h._asyncToGenerator(function*(){const {edits:d}=a;d.feature=null;f.add(I.watch(()=>d.feature,k=>{b.unhighlight();b.highlight(k)}),c.id)})()},tearDown(){var c=this;return h._asyncToGenerator(function*(){b.unhighlight();f.remove(c.id)})()}}),"editing-existing-feature":()=>({id:"editing-existing-feature",setUp(){var c=this;return h._asyncToGenerator(function*(){if(!f.has("editing-existing-feature")){var d=
a.edits.feature,{attachmentsViewModel:k,editableItems:e,featureFormViewModel:m,layerInfos:B,sketchViewModel:C,view:l}=a.viewModel;a.editableItem=e.find(g=>g.layer===d.layer);var q=new AbortController;f.add({remove:()=>q.abort()},c.id);var t=l.whenLayerView(d.layer),u=r.fetchFullFeature(d,l,q.signal);t=yield t;var n=yield u;if(!A.isAborted(q)){a.edits.updateGeometry(n.geometry);a.edits.updateAttributes(n.attributes);a.edits.trackChanges();k.set({graphic:n,mode:"view"});u=r.findLayerInfo(B,n.sourceLayer);
m.set({arcadeEditType:"UPDATE",feature:n,formTemplate:u?.formTemplate,spatialReference:l.spatialReference,view:l});var x="createInteractiveEditSession"in t?t.createInteractiveEditSession(d):null;u=[m.on("value-change",g=>{a.edits.updateAttributes(m.getValues());n.attributes=a.edits.feature.attributes;x&&x.setAttribute(g.fieldName,g.value)}),I.watch(()=>k.mode,g=>{"add"===g&&a.viewModel.activeWorkflow.go("adding-attachment");"edit"===g&&a.viewModel.activeWorkflow.go("editing-attachment")})];x&&(u.push(H.makeHandle(()=>
x.rollback())),f.add(H.makeHandle(()=>x.commit()),b._handleKeys.afterCommit));if(a.editableItem.geometryUpdatesEnabled){C.allowDeleteKey=!1;const g=r.getVisualVariableAttributes(n),{interactive:L,visual:M}=yield r.setUpGeometryUpdate(n,g,C,l,({geometry:N,attributes:G},y)=>{if(D.isSome(g.rotation)){var {field:z}=g.rotation;m.setValue(z,G[z])}D.isSome(g.size)&&({field:z}=g.size,m.setValue(z,G[z]));a.edits.updateAttributes(G);a.edits.updateGeometry(N);m.feature.geometry=N;("undo"===y.type||"redo"===
y.type||"update"===y.type&&D.isSome(y.toolEventInfo)&&r.isTerminalUpdateEventType(y.toolEventInfo.type))&&m.notifyFeatureGeometryChanged()},v);u.push(L,M);f.add(L,b._handleKeys.beforeCommit);f.add(M,b._handleKeys.afterCommit)}else b.highlight(n);f.add(u,c.id)}}})()},tearDown({cancelled:c}){var d=this;return h._asyncToGenerator(function*(){c&&(b.unhighlight(),f.remove(d.id))})()}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-existing-feature",setUp(){return h._asyncToGenerator(function*(){})()},
tearDown(){return h._asyncToGenerator(function*(){a.viewModel.attachmentsViewModel.mode="view"})()}}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-existing-feature",setUp(){return h._asyncToGenerator(function*(){})()},tearDown(){return h._asyncToGenerator(function*(){a.viewModel.attachmentsViewModel.mode="view"})()}})})};return w}(T);return E=F=O.__decorate([P.subclass("esri.widgets.Editor.UpdateWorkflow")],E)});