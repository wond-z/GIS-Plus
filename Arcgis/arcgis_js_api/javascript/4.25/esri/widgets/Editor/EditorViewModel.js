// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Collection ../../core/Error ../../core/Evented ../../core/HandleOwner ../../core/Logger ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/arrayUtils ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ../../layers/GraphicsLayer ../Attachments/AttachmentsViewModel ./CreateFeaturesWorkflow ./CreateWorkflow ./deprecationUtils ./UpdateWorkflow ../FeatureForm/FeatureFormViewModel ../FeatureTemplates/FeatureTemplatesViewModel ../Sketch/SketchViewModel ../Spinner/SpinnerViewModel".split(" "),
function(l,k,A,x,h,B,C,u,m,O,P,D,E,F,G,H,w,I,J,K,L,M){function n(r,p,e){v.error(new x(r,p,e))}function N(r,p){return r&&r.find(e=>e.layer===p)}const v=C.getLogger("esri.widgets.Editor.EditorViewModel"),y=["create","create-features","update"];h=function(r){function p(a){a=r.call(this,a)||this;a._sketchGraphicsLayer=new E({listMode:"hide",internal:!0});a.activeWorkflow=null;a._activityQueue=[];a.failures=[];a.attachmentsViewModel=new F({abilities:{editing:!0}});a.featureFormViewModel=new J;a.featureTemplatesViewModel=
new K;a.layerInfos=null;a.sketchViewModel=new L({layer:a._sketchGraphicsLayer});a.spinnerViewModel=new M;return a}l._inheritsLoose(p,r);var e=p.prototype;e.initialize=function(){this.handles.add([u.on(()=>this.activeWorkflow,"cancel",()=>this.emit("workflow-cancel")),u.on(()=>this.activeWorkflow,"commit",()=>this.emit("workflow-commit")),u.when(()=>this.view?.map,a=>{a.add(this._sketchGraphicsLayer)},u.initial),u.watch(()=>this.editableItems.toArray(),()=>{const {activeWorkflow:a}=this;this.refreshCreationTemplates();
if(a){var {stepId:b}=a;"create"===a.type?"awaiting-feature-creation-info"!==b||this.canCreate||this._cancelWorkflow():"update"===a.type&&("awaiting-feature-to-update"===b&&!this.canUpdate||"awaiting-update-feature-candidate"===b&&!a.data.candidates.some(c=>{const d=this.editableItems.find(g=>g.layer===c.layer);return d&&d.supports.includes("update")}))&&this._cancelWorkflow()}})])};e.destroy=function(){this._cancelWorkflow().then(()=>{this.view?.map&&this.view.map.remove(this._sketchGraphicsLayer);
this.view=null})};e.startCreateWorkflowAtFeatureTypeSelection=function(){var a=l._asyncToGenerator(function*(){w.workflowDeprecation(v,"startCreateWorkflowAtFeatureTypeSelection","startCreateFeaturesWorkflowAtFeatureTypeSelection");if(this.canCreate){yield this._cancelWorkflow();var b=this._createCreateWorkflow();yield b.start();this._set("activeWorkflow",b)}else n("editing:unsupported-workflow","Create workflow is unsupported or disabled.")});return function(){return a.apply(this,arguments)}}();
e.startCreateFeaturesWorkflowAtFeatureTypeSelection=function(){var a=l._asyncToGenerator(function*(){return this.startCreateFeaturesWorkflow()});return function(){return a.apply(this,arguments)}}();e.startCreateWorkflowAtFeatureCreation=function(){var a=l._asyncToGenerator(function*(b){w.workflowDeprecation(v,"startCreateWorkflowAtFeatureCreation","startCreateFeaturesWorkflowAtFeatureCreation");if(this.canCreate){yield this._cancelWorkflow();var c=this._createCreateWorkflow("awaiting-feature-to-create");
c.data.creationInfo=b;yield c.start();this._set("activeWorkflow",c)}else n("editing:unsupported-workflow","Create workflow is unsupported or disabled.")});return function(b){return a.apply(this,arguments)}}();e.startCreateFeaturesWorkflowAtFeatureCreation=function(){var a=l._asyncToGenerator(function*(b){return this.startCreateFeaturesWorkflow(b,"creating-features")});return function(b){return a.apply(this,arguments)}}();e.startCreateFeaturesWorkflow=function(){var a=l._asyncToGenerator(function*(b,
c="awaiting-feature-creation-info"){if(!this.canCreate)throw new x("editing:unsupported-workflow","Creating features is unsupported or disabled.");yield this._cancelWorkflow();b=this._createCreateFeaturesWorkflow(b,c);yield b.start();this._set("activeWorkflow",b)});return function(b){return a.apply(this,arguments)}}();e.startCreateWorkflowAtFeatureEdit=function(){var a=l._asyncToGenerator(function*(b){w.workflowDeprecation(v,"startCreateWorkflowAtFeatureEdit");if(this.canCreate){yield this._cancelWorkflow();
var c=this._createCreateWorkflow("editing-new-feature");c.data.edits.feature=b;yield c.start();this._set("activeWorkflow",c)}else n("editing:unsupported-workflow","Create workflow is unsupported or disabled.")});return function(b){return a.apply(this,arguments)}}();e.startUpdateWorkflowAtFeatureSelection=function(){var a=l._asyncToGenerator(function*(){if(this.canUpdate){yield this._cancelWorkflow();var b=this._createUpdateWorkflow();yield b.start();this._set("activeWorkflow",b)}else n("editing:unsupported-workflow",
"Update workflow is unsupported or disabled.")});return function(){return a.apply(this,arguments)}}();e.startUpdateWorkflowAtMultipleFeatureSelection=function(){var a=l._asyncToGenerator(function*(b){if(this.canUpdate){yield this._cancelWorkflow();var c=this._createUpdateWorkflow("awaiting-update-feature-candidate");c.data.candidates=b;yield c.start();this._set("activeWorkflow",c)}else n("editing:unsupported-workflow","Update workflow is unsupported or disabled.")});return function(b){return a.apply(this,
arguments)}}();e.startUpdateWorkflowAtFeatureEdit=function(){var a=l._asyncToGenerator(function*(b){if(this.canUpdate){yield this._cancelWorkflow();var c=this._createUpdateWorkflow("editing-existing-feature");c.data.edits.feature=b;yield c.start();this._set("activeWorkflow",c)}else n("editing:unsupported-workflow","Update workflow is unsupported or disabled.")});return function(b){return a.apply(this,arguments)}}();e.deleteFeatureFromWorkflow=function(){var a=l._asyncToGenerator(function*(){const {activeWorkflow:b}=
this;b&&"update"===b.type?(yield this._delete(b.data.edits.feature),yield b.reset()):n("editing:unsupported-workflow","Deleting requires an active update workflow.")});return function(){return a.apply(this,arguments)}}();e.cancelWorkflow=function(){var a=l._asyncToGenerator(function*(b){return this._cancelWorkflow({warn:!0,...b})});return function(b){return a.apply(this,arguments)}}();e.refreshCreationTemplates=function(){const a=[];for(const {layer:b,supports:c}of this.editableItems)b.loaded&&c.includes("create")&&
a.push(b);this.featureTemplatesViewModel.layers=a};e._cancelWorkflow=function(){var a=l._asyncToGenerator(function*(b){const c=this.activeWorkflow;c?b&&!1===b.force?(yield c.cancel(b),this._set("activeWorkflow",null)):(this.emit("workflow-cancel"),this._set("activeWorkflow",null),yield c.cancel(b)):b&&b.warn&&n("editing:no-active-workflow","There is no active workflow to cancel.")});return function(b){return a.apply(this,arguments)}}();e._createCreateFeaturesWorkflow=function(a,b){return G.create(this,
a,b,(c,d,g)=>this._applyEdits(c,d,g),(c,d)=>this._addAttachments(c,d))};e._createCreateWorkflow=function(a){return H.create(this,a,(b,c,d)=>this._applyEdits(b,c,d))};e._createUpdateWorkflow=function(a){return I.create(this,a,(b,c)=>this._applyEdits(b,c))};e._delete=function(){var a=l._asyncToGenerator(function*(b){const c=b.sourceLayer;"applyEdits"in c&&(yield this._applyEdits(c,{deleteFeatures:[b]}))});return function(b){return a.apply(this,arguments)}}();e._addAttachments=function(a,b){const c=
[];b?.forEach(d=>c.push(this._addAttachment(a,d.feature,d.attachment)));return Promise.all(c)};e._addAttachment=function(){var a=l._asyncToGenerator(function*(b,c,d){let g=null;yield this._queueOperation(l._asyncToGenerator(function*(){return g=yield b.addAttachment(c,d).catch(f=>{throw f?.error||f;})}));return g});return function(b,c,d){return a.apply(this,arguments)}}();e._applyEdits=function(){var a=l._asyncToGenerator(function*(b,c,d){var g=this;let f=null;yield this._queueOperation(l._asyncToGenerator(function*(){if(b.capabilities.operations.supportsQuery){const t=
yield g.view.whenLayerView(b);f=yield b.applyEdits(c,d);yield u.whenOnce(()=>!t.updating);return f}return f=yield b.applyEdits(c,d)}));return f});return function(b,c,d){return a.apply(this,arguments)}}();e._queueOperation=function(a){this._activityQueue.push(a);this.notifyChange("syncing");const b=(c,d)=>{c=d.indexOf(c);-1<c&&d.splice(c,1)};return a().then(c=>{if("error"in c&&c.error)throw c.error;if("addFeatureResults"in c){const {addFeatureResults:d,deleteFeatureResults:g,updateFeatureResults:f}=
c,t=d.find(q=>!!q.error)||f.find(q=>!!q.error)||g.find(q=>!!q.error);if(t)throw t.error;}return c}).catch(c=>{n("editing:operation-error","An error occurred.",{error:c});const d={error:c,retry:()=>{b(d,this.failures);return this._queueOperation(a)},cancel:()=>{b(d,this.failures)}};this._set("failures",[...this.failures,d])}).then(()=>{b(a,this._activityQueue);this.notifyChange("syncing")})};e._getEditableItemFromLayer=function(a,b=!0){const {data:c,editing:d,operations:g}=a.capabilities,f=N(this.layerInfos,
a),t=!!c.supportsAttachment&&(!f||!1!==f.allowAttachments),q=d.supportsGeometryUpdate&&(!f||!1!==f.geometryUpdatesEnabled),z=!f||!1!==f.attributeUpdatesEnabled;if(b)return{hasAttachments:t,layer:a,supports:[],geometryUpdatesEnabled:q,attributeUpdatesEnabled:z};b=[];g.supportsAdd&&(this.allowedWorkflows.includes("create")||this.allowedWorkflows.includes("create-features"))&&(!f||!1!==f.enabled&&!1!==f.addEnabled)&&b.push("create");g.supportsUpdate&&this.allowedWorkflows.includes("update")&&(!f||!1!==
f.enabled&&!1!==f.updateEnabled)&&b.push("update");!1!==(f&&f.deleteEnabled)&&g.supportsDelete&&b.push("delete");return{hasAttachments:t,layer:a,supports:b,geometryUpdatesEnabled:q,attributeUpdatesEnabled:z}};l._createClass(p,[{key:"allowedWorkflows",get:function(){return this._get("allowedWorkflows")},set:function(a){a&&0!==a.length||(a=[...y]);this._set("allowedWorkflows",a)}},{key:"canCreate",get:function(){return this.editableItems.some(a=>a.supports.includes("create"))}},{key:"canUpdate",get:function(){return this.editableItems.some(a=>
a.supports.includes("update"))}},{key:"editableItems",get:function(){const a=this.view?.allLayerViews;if(!a)return new A;var b=this.view?.map?.editableLayers;const c=new Set(b);b=b?.filter(g=>g.visible&&g.capabilities.operations.supportsAdd&&!g.capabilities.operations.supportsQuery);const d=a.filter(g=>c.has(g.layer)).map(({layer:g,suspended:f})=>this._getEditableItemFromLayer(g,f)).reverse();b?.forEach(g=>d.push(this._getEditableItemFromLayer(g,!1)));return d}},{key:"labelOptions",get:function(){return this.sketchViewModel.labelOptions},
set:function(a){this.sketchViewModel.labelOptions=a}},{key:"snappingOptions",get:function(){return this.sketchViewModel.snappingOptions},set:function(a){this.sketchViewModel.snappingOptions=a}},{key:"state",get:function(){if(!this.get("view.ready")||0===this.editableItems.length)return"disabled";var a=this.attachmentsViewModel.mode;if("add"===a)return"adding-attachment";if("edit"===a)return"editing-attachment";({activeWorkflow:a}=this);return a?a.stepId:"ready"}},{key:"syncing",get:function(){return 0<
this._activityQueue.length}},{key:"tooltipOptions",get:function(){return this.sketchViewModel.tooltipOptions},set:function(a){this.sketchViewModel.tooltipOptions=a}},{key:"view",set:function(a){this.sketchViewModel.view=a;this.spinnerViewModel.view=a;this._set("view",a)}}]);return p}(B.HandleOwnerMixin(h.EventedAccessor));k.__decorate([m.property({readOnly:!0})],h.prototype,"activeWorkflow",void 0);k.__decorate([m.property({readOnly:!0})],h.prototype,"_activityQueue",void 0);k.__decorate([m.property({value:[...y]})],
h.prototype,"allowedWorkflows",null);k.__decorate([m.property({readOnly:!0})],h.prototype,"canCreate",null);k.__decorate([m.property({readOnly:!0})],h.prototype,"canUpdate",null);k.__decorate([m.property({readOnly:!0})],h.prototype,"editableItems",null);k.__decorate([m.property({readOnly:!0})],h.prototype,"failures",void 0);k.__decorate([m.property()],h.prototype,"attachmentsViewModel",void 0);k.__decorate([m.property()],h.prototype,"featureFormViewModel",void 0);k.__decorate([m.property()],h.prototype,
"featureTemplatesViewModel",void 0);k.__decorate([m.property()],h.prototype,"labelOptions",null);k.__decorate([m.property()],h.prototype,"layerInfos",void 0);k.__decorate([m.property()],h.prototype,"sketchViewModel",void 0);k.__decorate([m.property()],h.prototype,"snappingOptions",null);k.__decorate([m.property()],h.prototype,"spinnerViewModel",void 0);k.__decorate([m.property()],h.prototype,"state",null);k.__decorate([m.property({readOnly:!0})],h.prototype,"syncing",null);k.__decorate([m.property()],
h.prototype,"tooltipOptions",null);k.__decorate([m.property()],h.prototype,"view",null);return h=k.__decorate([D.subclass("esri.widgets.Editor.EditorViewModel")],h)});