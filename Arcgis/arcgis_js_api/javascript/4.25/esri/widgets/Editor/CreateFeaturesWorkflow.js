// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/arrayUtils ../../core/handleUtils ../../core/maybe ../../core/reactiveUtils ../../core/uuid ../../core/Logger ../../core/accessorSupport/ensureType ../../core/Error ../../core/has ../../core/accessorSupport/decorators/subclass ../../views/interactive/snapping/FeatureSnappingLayerSource ./CreateFeaturesWorkflowData ./Workflow ./workflowUtils".split(" "),function(k,I,F,z,p,A,G,B,U,V,W,J,K,L,M,u){var C;const D=Symbol();
B=C=function(H){function x(a){a=H.call(this,a)||this;a.type="create-features";a.createFeatureState="create-new";a._featureFormHandle=null;a._visualVariableAttributes={rotation:null,size:null};a._attachmentFileInfos=new Map;a._highlightHandles=new Map;a._preventDefaultActionOnCancel=!1;return a}k._inheritsLoose(x,H);var v=x.prototype;v.updatePendingFeature=function(){var a=k._asyncToGenerator(function*(f,b){this._preventDefaultActionOnCancel=!0;this.data.viewModel.sketchViewModel.cancel();F.remove(this._lastActiveGraphics,
f);return this._startUpdating(f,b)});return function(f,b){return a.apply(this,arguments)}}();x.create=function(a,f,b,h,r){const n=new C({data:new L.CreateFeaturesWorkflowData({creationInfo:p.unwrap(f),viewModel:a}),onCommit:function(){var m=k._asyncToGenerator(function*(d){var e=d.viewModel.sketchViewModel.layer.graphics.toArray();d=d.creationInfo.layer;var g=d.capabilities.editing.supportsGlobalId&&"globalIdField"in d;const y=n._attachmentFileInfos;0===y.size?yield h(d,{addFeatures:e}):g?(e=n._getAttachmentEditsWithGlobalIds(e,
d,y),yield h(d,e,"addAttachments"in e?{globalIdUsed:!0}:void 0)):({addFeatureResults:g}=yield h(d,{addFeatures:e}),e=n._getAddAttachmentsData(e,g,d,y),yield r(d,e))});return function(d){return m.apply(this,arguments)}}()});n._set("steps",this._createWorkflowSteps(n,b));return n};v._fadeExistingFeatures=function(a){if("effect"in a){const b=a.effect;a.effect="saturate(0.6) opacity(0.8)";return z.makeHandle(()=>a.effect=b)}const f=a.opacity;a.opacity=.7;return z.makeHandle(()=>a.opacity=f)};v._highlight=
function(a){const f=this.data.viewModel.view;"3d"===f.type&&this._highlightHandles.set(a,f.highlight(a))};v._removeHighlight=function(a){p.removeMaybe(this._highlightHandles.get(a));this._highlightHandles.delete(a)};v._startCreating=function(){var a=k._asyncToGenerator(function*(f){this.createFeatureState="create-new";return u.startCreatingNewFeature(this.data.viewModel.sketchViewModel,this.data.creationInfo,f)});return function(f){return a.apply(this,arguments)}}();v._startUpdating=function(){var a=
k._asyncToGenerator(function*(f,b){const {featureFormViewModel:h,layerInfos:r,sketchViewModel:n,view:m}=this.data.viewModel,d=this.data.creationInfo.layer,e=u.findLayerInfo(r,d);h.set({arcadeEditType:"INSERT",feature:f,formTemplate:e?.formTemplate,spatialReference:m.spatialReference,view:m});p.removeMaybe(this._featureFormHandle);this._featureFormHandle=z.handlesGroup([h.on("value-change",k._asyncToGenerator(function*(){f.attributes=h.getValues();yield u.updateGraphicSymbolWhenRequired(f,b)})),n.on(["update",
"undo","redo"],g=>{("undo"===g.type||"redo"===g.type||"update"===g.type&&p.isSome(g.toolEventInfo)&&u.isTerminalUpdateEventType(g.toolEventInfo.type))&&h.notifyFeatureGeometryChanged()})]);this._removeHighlight(f);this.createFeatureState="update-pending";this._visualVariableAttributes=u.getVisualVariableAttributes(f);return u.startUpdatingFeature(n,f,d,this._visualVariableAttributes,b)});return function(f,b){return a.apply(this,arguments)}}();x._createWorkflowSteps=function(a,f="awaiting-feature-creation-info"){const {data:b,
handles:h}=a;let r=null,n=!0;const m=new Map;f=u.createWorkflowSteps(["awaiting-feature-creation-info","creating-features","adding-attachment","editing-attachment"],f,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",setUp(){var d=this;return k._asyncToGenerator(function*(){b.creationInfo=null;h.add(b.viewModel.featureTemplatesViewModel.on("select",({item:e})=>{b.creationInfo={layer:e.layer,template:e.template};b.viewModel.activeWorkflow.next()}),d.id)})()},tearDown(){var d=
this;return k._asyncToGenerator(function*(){h.remove(d.id)})()}}),"creating-features":()=>({id:"creating-features",setUp(){var d=this;return k._asyncToGenerator(function*(){if(!h.has(d.id)){var e=b.viewModel.view,g=b.viewModel.sketchViewModel;n=g.updateOnGraphicClick;g.updateOnGraphicClick=!1;a._lastActiveGraphics=[];a._featureFormHandle=p.removeMaybe(a._featureFormHandle);a._visualVariableAttributes={rotation:null,size:null};var y="2d"===e.type?a._fadeExistingFeatures(b.creationInfo.layer):null,
N=g.on("create",function(){var q=k._asyncToGenerator(function*(c){if("cancel"===c.state){if(a._preventDefaultActionOnCancel){a._preventDefaultActionOnCancel=!1;return}if(1>a._lastActiveGraphics.length)return a._startCreating(m);c=a._lastActiveGraphics.pop();return a._startUpdating(c,m)}if("complete"===c.state)return a._startUpdating(c.graphic,m)});return function(c){return q.apply(this,arguments)}}()),P=g.on("update",function(){var q=k._asyncToGenerator(function*(c){var l=c.graphics[0];if("complete"===
c.state){l!==r&&(a._lastActiveGraphics.push(l),a._highlight(l));r=null;"add"!==b.viewModel.attachmentsViewModel.mode&&"edit"!==b.viewModel.attachmentsViewModel.mode||b.viewModel.activeWorkflow.previous();if(c.aborted&&a._preventDefaultActionOnCancel){a._preventDefaultActionOnCancel=!1;return}const w=e.cursor;e.cursor="progress";h.add([z.makeHandle(()=>e.cursor=w),e.on("click",E=>E.preventDefault())],D);return A.whenOnce(()=>!b.viewModel.featureFormViewModel.updating).then(()=>{h.remove(D);a._startCreating(m)})}if("start"===
c.state){a._removeHighlight(l);const w=b.viewModel.attachmentsViewModel;"add"!==w.mode&&"edit"!==w.mode||b.viewModel.activeWorkflow.previous();w.fileInfos.removeAll();w.graphic=l;w.mode="view";(a._attachmentFileInfos.get(l)||[]).forEach(({file:E,form:O})=>w.addFile(E,O))}yield u.visualVariableInteractiveUpdate(e,l,c,a._visualVariableAttributes,m);c=l.attributes;p.isSome(a._visualVariableAttributes.rotation)&&({field:l}=a._visualVariableAttributes.rotation,b.viewModel.featureFormViewModel.setValue(l,
c[l]));p.isSome(a._visualVariableAttributes.size)&&({field:l}=a._visualVariableAttributes.size,b.viewModel.featureFormViewModel.setValue(l,c[l]))});return function(c){return q.apply(this,arguments)}}()),Q=g.on("delete",function(){var q=k._asyncToGenerator(function*(c){c=c.graphics[0];F.remove(a._lastActiveGraphics,c);r=c});return function(c){return q.apply(this,arguments)}}()),t=null,R=A.watch(()=>{const q=g.snappingOptions.featureSources.find(c=>c.layer===b.creationInfo.layer);return{hasFeatureLayerSource:!!q,
enabled:q?.enabled??!1}},({hasFeatureLayerSource:q,enabled:c})=>{const l=g.snappingOptions.featureSources;q?(p.isNone(t)&&(t=new K({layer:g.layer,enabled:c}),l.add(t)),t.enabled=c):(p.isSome(t)&&l.remove(t),t=p.destroyMaybe(t))},A.syncAndInitial),S=e.on("immediate-click",function(){var q=k._asyncToGenerator(function*(c){({results:c}=yield e.hitTest(c,{include:g.layer}));if(c=c.find(l=>"graphic"===l.type))c=c.graphic,"transform"!==g.activeTool&&"reshape"!==g.activeTool||g.updateGraphics.getItemAt(0)===
c||(yield a.updatePendingFeature(c,m))});return function(c){return q.apply(this,arguments)}}()),T=A.watch(()=>b.viewModel.attachmentsViewModel.mode,q=>{"add"===q&&b.viewModel.activeWorkflow.go("adding-attachment");"edit"===q&&b.viewModel.activeWorkflow.go("editing-attachment")});yield a._startCreating(m);h.add({remove:()=>{p.removeMaybe(a._featureFormHandle);N.remove();P.remove();Q.remove();R.remove();p.isSome(t)&&g.snappingOptions.featureSources.remove(t);t=p.destroyMaybe(t);g.cancel();S.remove();
T.remove();p.removeMaybe(y)}},d.id)}})()},tearDown(d){var e=this;return k._asyncToGenerator(function*(){d.cancelled&&(b.viewModel.sketchViewModel.layer.removeAll(),h.remove([e.id,D]),b.viewModel.attachmentsViewModel.fileInfos.removeAll(),a._attachmentFileInfos.clear(),b.viewModel.sketchViewModel.updateOnGraphicClick=n)})()}}),"adding-attachment":()=>({id:"adding-attachment",parent:"creating-features",setUp(){return k._asyncToGenerator(function*(){})()},tearDown(){return k._asyncToGenerator(function*(){const {graphic:d,
fileInfos:e}=b.viewModel.attachmentsViewModel;a._attachmentFileInfos.set(d,e.toArray());b.viewModel.attachmentsViewModel.mode="view"})()}}),"editing-attachment":()=>({id:"editing-attachment",parent:"creating-features",setUp(){return k._asyncToGenerator(function*(){})()},tearDown(){return k._asyncToGenerator(function*(){const {graphic:d,fileInfos:e}=b.viewModel.attachmentsViewModel;a._attachmentFileInfos.set(d,e.toArray());b.viewModel.attachmentsViewModel.mode="view"})()}})});return u.avoidFeatureTemplateSelectionWithOnlyOneItem(b,
f)};v._getAddAttachmentsData=function(a,f,b,h){const r=[];f.forEach((n,m)=>{if(!n.error){const d=a[m];m=h.get(d)||[];d.attributes[b.objectIdField]=n.objectId;m.forEach(({form:e})=>r.push({feature:d,attachment:e}))}});return r};v._getAttachmentEditsWithGlobalIds=function(a,f,b){const h=[];a.forEach((r,n)=>{const m=b.get(r)||[];let d=r.attributes[f.globalIdField];p.isNone(d)&&(d=G.generateUUID(),a[n].attributes[f.globalIdField]=d);m.forEach(({file:e})=>h.push({feature:r,attachment:{globalId:G.generateUUID(),
data:e}}))});return h.length?{addFeatures:a,addAttachments:h}:{addFeatures:a}};k._createClass(x,[{key:"numPendingFeatures",get:function(){return this.data.viewModel.sketchViewModel.layer.graphics.length}},{key:"pendingFeatures",get:function(){return this.data.viewModel.sketchViewModel.layer.graphics}}]);return x}(M);return B=C=I.__decorate([J.subclass("esri.widgets.Editor.CreateFeaturesWorkflow")],B)});