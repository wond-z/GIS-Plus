// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../core/Accessor ../../core/asyncUtils ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/reactiveUtils ../../core/accessorSupport/decorators/property ../../core/arrayUtils ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass".split(" "),function(e,p,f,y,v,z,b,u,n,h,B,C,A){function w(g){return b.isSome(g)&&g.state>=q.RUNNING?(g.abort(),null):g}var q;(function(g){g[g.PENDING=
0]="PENDING";g[g.WAIT_FOR_VIEW_READY=1]="WAIT_FOR_VIEW_READY";g[g.RUNNING=2]="RUNNING"})(q||(q={}));e.AnalysisViewModel=function(g){function r(a={}){var c=g.call(this,a)||this;c.view=null;c.analysisView=null;c._reconnectViewTask=null;c._forceInteractiveHandle=null;c._parentChangeFromReconnect=!1;c._startUserOperation=null;c.logger=z.getLogger(c.declaredClass);const d=a?.analysis;b.isSome(d)?c.analysis=d:(c._set("analysis",c.constructAnalysis()),c._set("isAnalysisOwner",!0));a&&null!=a.visible&&(c.visible=
a.visible);return c}p._inheritsLoose(r,g);var k=r.prototype;k.normalizeCtorArgs=function(a){const {analysis:c,...d}=a;return d};k.initialize=function(){this.addHandles([n.watch(()=>({readyAndNotSupported:b.isSome(this.view)&&this.view.ready&&!this.supported}),({readyAndNotSupported:a})=>{a&&this.logger.errorOnce(this.unsupportedErrorMessage)},n.syncAndInitial),n.watch(()=>b.applySome(this.analysis,({parent:a})=>a),a=>{this._parentChangeFromReconnect||a===this.view||this._set("isAnalysisOwner",!1);
a=!this._parentChangeFromReconnect;this._parentChangeFromReconnect=!1;a&&this._scheduleViewReconnect()},n.sync),n.watch(()=>({view:this.view,ready:b.isSome(this.view)&&this.view.ready,supported:this.supported}),({view:a},{view:c})=>{a!==c&&(this._startUserOperation=b.abortMaybe(this._startUserOperation),this._disconnectFromView(c));this._scheduleViewReconnect()},n.syncAndInitial)])};k.destroy=function(){this._reconnectViewTask=b.abortMaybe(this._reconnectViewTask);this._startUserOperation=b.abortMaybe(this._startUserOperation);
b.isSome(this.analysisView)&&(this.analysisView.visible=void 0);this._disconnectFromView(this.view);this._set("view",null);b.isSome(this.analysis)&&this.isAnalysisOwner&&(this.analysis.destroy(),this._set("analysis",null))};k.clear=function(){this._startUserOperation=b.abortMaybe(this._startUserOperation);this._resetInteractiveCreationState();b.isSome(this.tool)&&b.isSome(this.view)&&this.view.activeTool===this.tool&&(this.view.activeTool=null)};k.start=function(){var a=p._asyncToGenerator(function*(){var c=
this;this.clear();const d={task:null,abort:null,state:q.PENDING},m=v.createTask(function(){var l=p._asyncToGenerator(function*(x){d.state=q.WAIT_FOR_VIEW_READY;yield n.whenOnce(()=>c.ready,x);d.state=q.RUNNING;if(!b.isNone(c.analysisView)&&!b.isNone(c.view)){var t=c.analysisView.tool;b.isNone(t)||(c.view.activeTool=t,n.when(()=>t.created,()=>{t.active&&b.isSome(c.view)&&(c.view.activeTool=null)},{initial:!0,once:!0}))}});return function(x){return l.apply(this,arguments)}}());d.task=m;d.abort=()=>
m.abort();this._startUserOperation=d;return m.promise});return function(){return a.apply(this,arguments)}}();k.onConnectToAnalysisView=function(a){};k.onDisconnectFromAnalysisView=function(){};k._scheduleViewReconnect=function(){var a=this;this._reconnectViewTask=b.abortMaybe(this._reconnectViewTask);const c=v.createTask(function(){var d=p._asyncToGenerator(function*(m){try{yield a._reconnectView(m)}catch(l){u.throwIfAborted(m);if(u.isAbortError(l))throw l;a.logger.warn("Failed to use analysis in view model",
l)}finally{c===a._reconnectViewTask&&(a._reconnectViewTask=null)}});return function(m){return d.apply(this,arguments)}}());this._reconnectViewTask=c};k._reconnectView=function(){var a=p._asyncToGenerator(function*(c){const {view:d}=this,m=b.isSome(d)&&d.ready&&this.supported,l=this.analysis;this._startUserOperation=w(this._startUserOperation);this._disconnectFromView(d);if(m&&!b.isNone(d)&&!b.isNone(l)){if(this.isAnalysisOwner){if(b.isSome(l.parent)){this.logger.errorOnce("expected owned analysis to have null parent when connecting to view");
return}this._parentChangeFromReconnect=!0;d.analyses.add(l)}this.analysisView=yield d.whenAnalysisView(l);u.isAborted(c)?this._startUserOperation=w(this._startUserOperation):(this.analysisView.visible=this.visible,this._forceInteractiveHandle=this.analysisView.forceInteractiveForViewModel(),this.addHandles(this._forceInteractiveHandle),this.onConnectToAnalysisView(this.analysisView))}});return function(c){return a.apply(this,arguments)}}();k._disconnectFromView=function(a){b.isSome(a)&&this.isAnalysisOwner&&
a.analyses.includes(this.analysis)&&(this._parentChangeFromReconnect=!0,this.analysis.clear(),a.analyses.remove(this.analysis));this.onDisconnectFromAnalysisView();this._forceInteractiveHandle=b.removeMaybe(this._forceInteractiveHandle);this.analysisView=null};k._setExternalAnalysis=function(a){b.isSome(this.analysisView)&&!this.isAnalysisOwner&&(this.analysisView.visible=void 0,this._forceInteractiveHandle=b.removeMaybe(this._forceInteractiveHandle));this.analysisView=null;this._set("isAnalysisOwner",
!1);this._set("analysis",a);this._parentChangeFromReconnect=!1};k._resetInteractiveCreationState=function(){this.analysis.clear();b.isSome(this.tool)&&this.tool.resetCreated()};p._createClass(r,[{key:"supported",get:function(){return b.isNone(this.view)||this.view.type===this.supportedViewType}},{key:"visible",set:function(a){this._set("visible",a);b.isSome(this.analysisView)&&(this.analysisView.visible=a)}},{key:"active",get:function(){return b.isSome(this.tool)&&this.tool.active}},{key:"disabled",
get:function(){return b.isNone(this.view)||!this.view.ready||!this.supported}},{key:"analysis",set:function(a){a!==this._get("analysis")&&(this._startUserOperation=b.abortMaybe(this._startUserOperation),this._disconnectFromView(this.view),this._setExternalAnalysis(a),this._scheduleViewReconnect())}},{key:"ready",get:function(){return b.isSome(this.analysisView)&&!this.connectingToView}},{key:"connectingToView",get:function(){return b.isSome(this._reconnectViewTask)}},{key:"isAnalysisOwner",get:function(){return this._get("isAnalysisOwner")}},
{key:"tool",get:function(){return b.isSome(this.analysisView)?this.analysisView.tool:null}},{key:"testInfo",get:function(){return{analysisView:this.analysisView}}}]);return r}(y);f.__decorate([h.property()],e.AnalysisViewModel.prototype,"supported",null);f.__decorate([h.property()],e.AnalysisViewModel.prototype,"view",void 0);f.__decorate([h.property({type:Boolean,value:!0})],e.AnalysisViewModel.prototype,"visible",null);f.__decorate([h.property()],e.AnalysisViewModel.prototype,"active",null);f.__decorate([h.property()],
e.AnalysisViewModel.prototype,"disabled",null);f.__decorate([h.property({nonNullable:!0})],e.AnalysisViewModel.prototype,"analysis",null);f.__decorate([h.property()],e.AnalysisViewModel.prototype,"analysisView",void 0);f.__decorate([h.property()],e.AnalysisViewModel.prototype,"ready",null);f.__decorate([h.property()],e.AnalysisViewModel.prototype,"connectingToView",null);f.__decorate([h.property({readOnly:!0})],e.AnalysisViewModel.prototype,"isAnalysisOwner",null);f.__decorate([h.property()],e.AnalysisViewModel.prototype,
"_reconnectViewTask",void 0);f.__decorate([h.property()],e.AnalysisViewModel.prototype,"_forceInteractiveHandle",void 0);f.__decorate([h.property()],e.AnalysisViewModel.prototype,"tool",null);e.AnalysisViewModel=f.__decorate([A.subclass("esri.widgets.support.AnalysisViewModel")],e.AnalysisViewModel);Object.defineProperties(e,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});