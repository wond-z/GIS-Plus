// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../request ../../core/Collection ../../core/Error ../../core/lang ../../core/Loadable ../../core/maybe ../../core/accessorSupport/decorators/property ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ../../intl/date ../../intl/locale ../../portal/Portal ../../rest/geoprocessor/execute ../../rest/geoprocessor/GPOptions ../../core/has ../../geometry/support/normalizeUtils ../../layers/support/Field ../../layers/support/MapImage ../../config ../../kernel ../../core/urlUtils ../../rest/support/DataFile ../../rest/support/FeatureSet ../../rest/support/LinearUnit ../../rest/support/ParameterValue ../../rest/support/RasterData ../../rest/support/JobInfo ../../rest/print ../../rest/support/fileFormat ../../rest/support/layoutTemplate ../../rest/support/PrintParameters ../../rest/support/PrintTemplate ./CustomTemplate".split(" "),
function(r,k,F,g,x,G,H,I,l,S,J,z,K,A,L,T,U,V,W,X,Y,Z,aa,ba,ca,da,ea,fa,ha,M,B,y,N,O,C){function P(p){p.layoutOptions||(p.layoutOptions={});p.layoutOptions.customTextElements||(p.layoutOptions.customTextElements=[]);if(!p.layoutOptions.customTextElements.find(t=>"date"in t)){({customTextElements:p}=p.layoutOptions);let t=z.formatDate(Date.now(),z.convertDateFormatToIntlOptions("short-date"));"ar"===K.getLanguage()&&(t="\u200f"+t);p.push({date:t})}}const D=g.ofType(C);g=function(p){function t(a){a=
p.call(this,a)||this;a.allowedFormats="all";a.allowedLayouts="all";a.defaultTemplates=new D;a.extraParameters=null;a.includeDefaultTemplates=!0;a.error=null;a.portal=A.getDefault();a.printServiceUrl=null;a.templatesInfo=null;a.updateDelay=1E3;a.view=null;a.templateCustomTextElements=null;a.print=a.print.bind(r._assertThisInitialized(a));return a}r._inheritsLoose(t,p);var u=t.prototype;u.destroy=function(){this.view=null};u.load=function(){var a=r._asyncToGenerator(function*(b){this.addResolvingPromise(this._loadResources(b).catch(f=>
this.error=f));return this});return function(b){return a.apply(this,arguments)}}();u.print=function(){var a=r._asyncToGenerator(function*(b){const {view:f,extraParameters:e,updateDelay:h}=this;if(!f)throw new x("print:view-required","view is not set");P(b);b=new N({view:f,template:b,extraParameters:e,updateDelay:h});try{return yield M.execute(this.effectivePrintServiceUrl,b)}catch(d){throw new x("print:export-error","An error occurred while exporting the web map.",{error:d});}});return function(b){return a.apply(this,
arguments)}}();u.toPrintTemplate=function({attributionEnabled:a,author:b,copyright:f,customTextElements:e,dpi:h,forceFeatureAttributes:d,format:c,height:q,layout:m,legendEnabled:v,northArrowEnabled:n,scale:w,scaleEnabled:Q,title:R,width:E}){a=new O({attributionVisible:a,forceFeatureAttributes:d,format:c,layout:m,layoutOptions:{authorText:b||"",copyrightText:f||"",customTextElements:e,titleText:R||""},outScale:w,scalePreserved:Q});E&&(a.exportOptions.width=E);q&&(a.exportOptions.height=q);h&&(a.exportOptions.dpi=
h);v||(a.layoutOptions.legendLayers=[]);(h=this.templateToNorthArrowInfo[m])&&h.visible!==n&&(a.layoutOptions.elementOverrides={[h.name]:{visible:n}});return a};u._loadResources=function(){var a=r._asyncToGenerator(function*(b){let f=[];var {printServiceUrl:e}=this;if(!e){if(this.destroyed)return;({portal:e}=this);try{yield e.load(b)}catch(h){throw new x("print:could-not-load-portal","Cannot load print resource information from portal",{url:this.effectivePrintServiceUrl});}if(e=e.helperServices?.printTask)this._set("effectivePrintServiceUrl",
e.url),f=(e?.templates??[]).map(h=>C.fromJSON(h))}0<f.length&&this.defaultTemplates.addMany(f);if(-1===this.effectivePrintServiceUrl.toLowerCase().split("/").indexOf("gpserver"))throw new x("print:invalid-print-service-url","Can't fetch print templates information from provided URL",{url:this.effectivePrintServiceUrl});this._processLayoutTemplateInfos(yield this._getLayoutTemplatesInfo(b));yield this._loadServiceDescription(b)});return function(b){return a.apply(this,arguments)}}();u._loadServiceDescription=
function(){var a=r._asyncToGenerator(function*(b){b=yield this._getPrintTemplatesFromService(b);this._set("templatesInfo",b)});return function(b){return a.apply(this,arguments)}}();u._getLayoutTemplatesInfo=function(){var a=r._asyncToGenerator(function*(b){var f=this;let e=[];const h=function(){var d=r._asyncToGenerator(function*(c){c=f.effectivePrintServiceUrl.replace(/(\/GPServer\/).+/i,`$1${encodeURI(c)}`);return(yield L.execute(c,null,null,I.unwrap(b))).results[0].value});return function(c){return d.apply(this,
arguments)}}();try{e=yield h("Get Layout Templates Info Task")}catch(d){}if(!e||1>e.length)try{e=yield h("Get Layout Templates Info")}catch(d){}return e});return function(b){return a.apply(this,arguments)}}();u._processLayoutTemplateInfos=function(a){const b={},f={};a.forEach(({layoutTemplate:e,layoutOptions:{customTextElements:h,mapSurroundInfos:d}})=>{e=y.fromJSON(e);b[e]=h;d&&(f[e]=d.find(c=>"CIMMarkerNorthArrow"===c.type))});this.templateCustomTextElements=Object.freeze(b);this.templateToNorthArrowInfo=
f};u._getPrintTemplatesFromService=function(){var a=r._asyncToGenerator(function*(b){return F(this.effectivePrintServiceUrl,{...b,query:{f:"json"},timeout:6E4}).then(f=>{f=f&&f.data;let e=null,h=null;(f&&f.parameters).forEach(d=>{var c=d.choiceList&&d.choiceList.slice(),q;c&&c.length&&d.defaultValue&&(q=c.indexOf(d.defaultValue));-1<q&&(c.splice(q,1),c.unshift(d.defaultValue));q=(m,v)=>{const n="all"===v?m:m.filter(w=>v.includes(w));return 0===n.length?m:n};if("Format"===d.name)c=q(c.map(B.fromJSON),
this.allowedFormats),d=B.fromJSON(d.defaultValue),e={defaultValue:c.includes(d)?d:c[0],choiceList:c};else if("Layout_Template"===d.name){c=c.filter(n=>"map_only"!==n.toLowerCase());let m,v;c.some((n,w)=>{n=n.toLowerCase();if(n.includes("letter")&&n.includes("landscape"))return m=w,!0;n.includes("a4")&&n.includes("landscape")&&(m=w);return!1});m&&(v=c[m],c.splice(m,1),c.unshift(v));c=q(c.map(y.fromJSON),this.allowedLayouts);d=y.fromJSON(d.defaultValue);h={defaultValue:c.includes(d)?d:c[0],choiceList:c}}});
this.error=null;return{format:e,layout:h}}).catch(f=>{throw new x("print:unavailable-service-info","Can't fetch templates info from service",{error:f});})});return function(b){return a.apply(this,arguments)}}();r._createClass(t,[{key:"effectivePrintServiceUrl",get:function(){return this.printServiceUrl??null}},{key:"effectiveTemplateCustomTextElements",get:function(){if(!this._serviceTemplateCustomTextElements)return{};const a=G.clone(this._serviceTemplateCustomTextElements);this.templateCustomTextElements&&
Object.keys(this.templateCustomTextElements).forEach(b=>{const f=a[b];if(f){const e=this.templateCustomTextElements[b];f.forEach(h=>{const [d]=Object.entries(h)[0];e.find(c=>{const [q,m]=Object.entries(c)[0];d===q&&(h[d]=m)})})}});return Object.freeze(a)}},{key:"state",get:function(){return"loading"===this.loadStatus?"initializing":this.error||"failed"===this.loadStatus?"error":this.get("view.ready")&&"loaded"===this.loadStatus?"ready":"disabled"}}]);return t}(H);k.__decorate([l.property()],g.prototype,
"_serviceTemplateCustomTextElements",void 0);k.__decorate([l.property()],g.prototype,"allowedFormats",void 0);k.__decorate([l.property()],g.prototype,"allowedLayouts",void 0);k.__decorate([l.property({type:D})],g.prototype,"defaultTemplates",void 0);k.__decorate([l.property()],g.prototype,"extraParameters",void 0);k.__decorate([l.property()],g.prototype,"includeDefaultTemplates",void 0);k.__decorate([l.property({readOnly:!0})],g.prototype,"effectivePrintServiceUrl",null);k.__decorate([l.property()],
g.prototype,"effectiveTemplateCustomTextElements",null);k.__decorate([l.property()],g.prototype,"error",void 0);k.__decorate([l.property({type:A})],g.prototype,"portal",void 0);k.__decorate([l.property()],g.prototype,"printServiceUrl",void 0);k.__decorate([l.property({readOnly:!0})],g.prototype,"state",null);k.__decorate([l.property({readOnly:!0})],g.prototype,"templatesInfo",void 0);k.__decorate([l.property()],g.prototype,"updateDelay",void 0);k.__decorate([l.property()],g.prototype,"view",void 0);
k.__decorate([l.property()],g.prototype,"templateCustomTextElements",void 0);k.__decorate([l.property()],g.prototype,"templateToNorthArrowInfo",void 0);return g=k.__decorate([J.subclass("esri.widgets.Print.PrintViewModel")],g)});