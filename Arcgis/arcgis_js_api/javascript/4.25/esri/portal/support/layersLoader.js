// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../core/Error ../../layers/Layer ../../layers/support/arcgisLayerUrl ../Portal ../PortalItem ./jsonContext ./portalItemUtils ../../renderers/support/styleUtils ../../support/requestPresets".split(" "),function(k,l,p,w,C,D,E,F,G,H,x){function q(){q=l._asyncToGenerator(function*(a,c){var b=a.instance.portalItem;if(b&&b.id){yield b.load(c);b=a.instance.portalItem;if(!a.supportedTypes.includes(b.type))throw new p("portal:invalid-layer-item-type",
"Invalid layer item type '${type}', expected '${expectedType}'",{type:b.type,expectedType:a.supportedTypes.join(", ")});return I(a,c)}});return q.apply(this,arguments)}function I(a,c){return r.apply(this,arguments)}function r(){r=l._asyncToGenerator(function*(a,c){const b=a.instance,d=b.portalItem,{url:f,title:e}=d,g=F.createForItemRead(d);if("group"===b.type)return b.read({title:e},g),J(b,a);f&&b.read({url:f},g);(a=yield y(a,c))&&b.read(a,g);b.resourceReferences={portalItem:d,paths:g.readResourcePaths};
"subtype-group"!==b.type&&b.read({title:e},g);return H.loadStyleRenderer(b,g)});return r.apply(this,arguments)}function J(a,c){const b=a.portalItem.type,d=c.layerModuleTypeMap;var f=G.hasTypeKeyword(a.portalItem,"Oriented Imagery Layer")??!1;switch(b){case "Feature Service":f=f?d.OrientedImageryLayer:d.FeatureLayer;break;case "Stream Service":f=d.StreamLayer;break;case "Scene Service":f=d.SceneLayer;break;case "Feature Collection":f=d.FeatureLayer;break;default:throw new p("portal:unsupported-item-type-as-group",
`The item type '${b}' is not supported as a 'IGroupLayer'`);}let e;return f().then(g=>{e=g;return y(c)}).then(function(){var g=l._asyncToGenerator(function*(h){let m=()=>e;if("Feature Service"===b){h=yield z(h,a.portalItem.url);if(t(h).length){const K=yield(0,d.SubtypeGroupLayer)();m=L=>"SubtypeGroupLayer"===L.layerType?K:e}return u(a,m,h)}return 0<n(h)?u(a,m,h):M(a,m)});return function(h){return g.apply(this,arguments)}}())}function M(a,c){return a.portalItem.url?x.requestArcGISServiceJSON(a.portalItem.url).then(b=>
{function d(f){return{id:f.id,name:f.name}}b&&u(a,c,{layers:b.layers?.map(d),tables:b.tables?.map(d)})}):Promise.resolve()}function u(a,c,b){let d=b.layers||[];const f=b.tables||[];"Feature Collection"===a.portalItem.type&&(d.forEach(e=>{"Table"===e?.layerDefinition?.type&&f.push(e)}),d=d.filter(e=>"Table"!==e?.layerDefinition?.type));if("coverage"in b){const e=N(b);a.add(e)}d.reverse().forEach(e=>{e=A(a,c(e),b,e);a.add(e)});f.reverse().forEach(e=>{e=A(a,c(e),b,e);a.tables.add(e)})}function A(a,c,
b,d){c=new c({portalItem:a.portalItem.clone(),layerId:d.id});"subtype-group"!==c.type&&(c.sublayerTitleMode="service-name");"Feature Collection"===a.portalItem.type&&(a={origin:"portal-item",portal:a.portalItem.portal||D.getDefault()},c.read(d,a),b=b.showLegend,null!=b&&c.read({showLegend:b},a));return c}function y(a,c){if(!1===a.supportsData)return Promise.resolve(void 0);const b=a.instance;return b.portalItem.fetchData("json",c).catch(()=>null).then(d=>{var f="stream"===b.type||"oriented-imagery"===
b.type?!1:"layerId"in b;if(f){f=!0;if(d&&0<n(d)){if(null==b.layerId){var e=t(d);b.layerId="subtype-group"===b.type?e?.[0]:B(d)}if(e=O(d,b))1===n(d)&&(f=!1),null!=d.showLegend&&(e.showLegend=d.showLegend)}f&&"service-name"!==b.sublayerTitleMode&&(b.sublayerTitleMode="item-title-and-service-name");return e}return d})}function z(a,c){return v.apply(this,arguments)}function v(){v=l._asyncToGenerator(function*(a,c){if(null==a?.layers||null==a?.tables)c=yield x.requestArcGISServiceJSON(c),a=a||{},a.layers=
a.layers||c?.layers,a.tables=a.tables||c?.tables;return a});return v.apply(this,arguments)}function B(a){const c=a.layers;return c&&c.length?c[0].id:(a=a.tables)&&a.length?a[0].id:null}function O(a,c){const {layerId:b}=c;a=a.layers?.find(f=>f.id===b)||a.tables?.find(f=>f.id===b);var d;if(d=a)d="feature"===c.type&&"layerType"in a&&"SubtypeGroupLayer"===a.layerType||"subtype-group"===c.type&&!("layerType"in a)?!1:!0;return d?a:null}function n(a){return(a?.layers?.length??0)+(a?.tables?.length??0)}function N(a){var {coverage:c}=
a;if(!c)return null;a=new URL(c);if(c.toLowerCase().includes("item.html"))return c=a.searchParams.get("id"),w.fromPortalItem({portalItem:new E({id:c,url:a.origin})});if(C.isArcGISUrl(c))return w.fromArcGISServerUrl({url:c});throw new p("portal:oriented-imagery-layer-coverage","the provided coverage url couldn't be loaded as a layer");}function t(a){const c=[];a?.layers?.forEach(b=>{"SubtypeGroupLayer"===b.layerType&&c.push(b.id)});return c}k.getFirstLayerOrTableId=B;k.getNumLayersAndTables=n;k.getSubtypeGroupLayerIds=
t;k.load=function(a,c){return q.apply(this,arguments)};k.preprocessFSItemData=z;Object.defineProperties(k,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});