// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define(["exports","../chunks/_rollupPluginBabelHelpers","./maybe","./PooledArray"],function(h,n,p,q){h.RemoveMode=void 0;(function(k){k[k.ALL=0]="ALL";k[k.SOME=1]="SOME"})(h.RemoveMode||(h.RemoveMode={}));let t=function(){function k(a,b,c){this._namespace=a;this._storage=b;this._removeFunc=!1;this._miss=this._hit=0;this._storage.register(this);this._namespace+=":";c&&(this._storage.registerRemoveFunc(this._namespace,c),this._removeFunc=!0)}var d=k.prototype;d.destroy=function(){this._storage.clear(this._namespace);
this._removeFunc&&this._storage.deregisterRemoveFunc(this._namespace);this._storage.deregister(this);this._storage=null};d.resetHitRate=function(){this._hit=this._miss=0};d.put=function(a,b,c,e=0){this._storage.put(this._namespace+a,b,c,e)};d.get=function(a){a=this._storage.get(this._namespace+a);void 0===a?++this._miss:++this._hit;return a};d.pop=function(a){a=this._storage.pop(this._namespace+a);void 0===a?++this._miss:++this._hit;return a};d.updateSize=function(a,b,c){this._storage.updateSize(this._namespace+
a,b,c)};d.clear=function(){this._storage.clear(this._namespace)};d.clearAll=function(){this._storage.clearAll()};d.getStats=function(){return this._storage.getStats()};d.resetStats=function(){this._storage.resetStats()};n._createClass(k,[{key:"namespace",get:function(){return this._namespace.slice(0,-1)}},{key:"hitRate",get:function(){return this._hit/(this._hit+this._miss)}},{key:"size",get:function(){return this._storage.size}},{key:"maxSize",get:function(){return this._storage.maxSize}}]);return k}(),
u=function(){function k(a=10485760){this._maxSize=a;this._db=new Map;this._miss=this._hit=this._size=0;this._removeFuncs=new q;this._users=new q}var d=k.prototype;d.destroy=function(){this.clearAll();this._removeFuncs.clear();this._users.clear();this._db=null};d.register=function(a){this._users.push(a)};d.deregister=function(a){this._users.removeUnordered(a)};d.registerRemoveFunc=function(a,b){this._removeFuncs.push([a,b])};d.deregisterRemoveFunc=function(a){this._removeFuncs.filterInPlace(b=>b[0]!==
a)};d.put=function(a,b,c,e){const f=this._db.get(a);f&&(this._size-=f.size,this._db.delete(a),f.entry!==b&&this._notifyRemove(a,f.entry,h.RemoveMode.ALL));c>this._maxSize?this._notifyRemove(a,b,h.RemoveMode.ALL):void 0===b?console.warn("Refusing to cache undefined entry "):!c||0>c?console.warn("Refusing to cache entry with invalid size "+c):(e=1+Math.max(e,-3)- -3,this._db.set(a,{entry:b,size:c,lifetime:e,lives:e}),this._size+=c,this._checkSizeLimit())};d.updateSize=function(a,b,c){const e=this._db.get(a);
if(e&&e.entry===b){for(this._size-=e.size;c>this._maxSize;)if(c=this._notifyRemove(a,b,h.RemoveMode.SOME),!(p.isSome(c)&&0<c)){this._db.delete(a);return}e.size=c;this._size+=c;this._checkSizeLimit()}};d.pop=function(a){const b=this._db.get(a);if(b)return this._size-=b.size,this._db.delete(a),++this._hit,b.entry;++this._miss};d.get=function(a){const b=this._db.get(a);if(void 0===b)++this._miss;else return this._db.delete(a),b.lives=b.lifetime,this._db.set(a,b),++this._hit,b.entry};d.getStats=function(){const a=
{Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},b={},c=[];this._db.forEach((g,l)=>{const r=g.lifetime;c[r]=(c[r]||0)+g.size;this._users.forAll(m=>{m=m.namespace;l.startsWith(m)&&(b[m]=(b[m]||0)+g.size)})});const e={};this._users.forAll(g=>{const l=g.namespace;!isNaN(g.hitRate)&&0<g.hitRate?(b[l]=b[l]||0,e[l]=Math.round(100*g.hitRate)+"%"):e[l]="0%"});var f=Object.keys(b);f.sort((g,l)=>
b[l]-b[g]);f.forEach(g=>a[g]=Math.round(b[g]/2**20)+"MB / "+e[g]);for(f=c.length-1;0<=f;--f){const g=c[f];g&&(a["Priority "+(f+-3-1)]=Math.round(g/this.size*100)+"%")}return a};d.resetStats=function(){this._hit=this._miss=0;this._users.forAll(a=>a.resetHitRate())};d.clear=function(a){this._db.forEach((b,c)=>{c.startsWith(a)&&(this._size-=b.size,this._db.delete(c),this._notifyRemove(c,b.entry,h.RemoveMode.ALL))})};d.clearAll=function(){this._db.forEach((a,b)=>this._notifyRemove(b,a.entry,h.RemoveMode.ALL));
this._size=0;this._db.clear()};d._getHitRate=function(){return this._hit/(this._hit+this._miss)};d._notifyRemove=function(a,b,c){let e;this._removeFuncs.some(f=>a.startsWith(f[0])?(f=f[1](b,c),"number"===typeof f&&(e=f),!0):!1);return e};d._checkSizeLimit=function(){if(!(this._size<=this._maxSize))for(const [a,b]of this._db){this._db.delete(a);if(1>=b.lives){this._size-=b.size;const c=this._notifyRemove(a,b.entry,h.RemoveMode.SOME);p.isSome(c)&&0<c&&(this._size+=c,b.lives=b.lifetime,b.size=c,this._db.set(a,
b))}else--b.lives,this._db.set(a,b);if(this._size<=.9*this.maxSize)break}};n._createClass(k,[{key:"size",get:function(){return this._size}},{key:"maxSize",get:function(){return this._maxSize},set:function(a){this._maxSize=Math.max(a,0);this._checkSizeLimit()}}]);return k}();h.MIN_PRIORITY=-3;h.MemCache=t;h.MemCacheStorage=u;Object.defineProperties(h,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});