// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../config ../Graphic ../PopupTemplate ../request ../core/Collection ../core/CollectionFlattener ../core/jsonMap ../core/lang ../core/maybe ../core/MultiOriginJSONSupport ../core/promiseUtils ../core/reactiveUtils ../core/urlUtils ../core/accessorSupport/decorators/property ../core/accessorSupport/ensureType ../core/accessorSupport/decorators/reader ../core/accessorSupport/decorators/subclass ../core/accessorSupport/decorators/writer ../core/accessorSupport/write ../geometry/Extent ../geometry/SpatialReference ../geometry/support/scaleUtils ../geometry/support/spatialReferenceUtils ./Layer ./mixins/BlendLayer ./mixins/OperationalLayer ./mixins/PortalLayer ./mixins/RefreshableLayer ./mixins/ScaleRangeLayer ./mixins/TemporalLayer ./ogc/crsUtils ./support/arcgisLayerUrl ./support/commonProperties ./support/ExportWMSImageParameters ./support/WMSSublayer ./support/wmsUtils".split(" "),
function(u,e,L,M,N,A,E,O,w,P,p,d,Q,v,B,l,R,x,S,C,T,U,z,F,V,W,X,Y,Z,aa,ba,ca,da,ea,G,H,D,t){function I(n){return"text/html"===n}function J(n){return"text/plain"===n}function fa(n,q){return n.some(h=>{for(const b in h)if(T.willPropertyWrite(h,b,null,q))return!0;return!1})}function K(n,q,h){n=n??[];const b=new Map;n.every(a=>null==a.id)&&(n=P.clone(n),n.forEach((a,c)=>a.id=c));for(const a of n){const c=new D;c.read(a,q);h&&!h.includes(c.name)&&(c.visible=!1);b.set(c.id,c)}q=[];for(const a of n)if(n=
null!=a.id?b.get(a.id):null)if(null!=a.parentLayerId&&0<=a.parentLayerId){if(h=b.get(a.parentLayerId))h.sublayers||(h.sublayers=new E),h.sublayers.push(n)}else q.push(n);return q}w=new w.JSONMap({bmp:"image/bmp",gif:"image/gif",jpg:"image/jpeg",png:"image/png",svg:"image/svg+xml"},{ignoreUnknown:!1});d=function(n){function q(...b){var a=n.call(this,...b)||this;a.allSublayers=new O({getCollections:()=>[a.sublayers],getChildrenFunction(c){return c.sublayers}});a.customParameters=null;a.customLayerParameters=
null;a.copyright=null;a.description=null;a.dimensions=null;a.fullExtent=null;a.fullExtents=null;a.featureInfoFormats=null;a.featureInfoUrl=null;a.fetchFeatureInfoFunction=null;a.imageFormat=null;a.imageMaxHeight=2048;a.imageMaxWidth=2048;a.imageTransparency=!0;a.legendEnabled=!0;a.mapUrl=null;a.isReference=null;a.operationalLayerType="WMS";a.spatialReference=null;a.spatialReferences=null;a.sublayers=null;a.type="wms";a.url=null;a.version=null;a.addHandles([v.on(()=>a.sublayers,"after-add",({item:c})=>
{c.parent=c.layer=u._assertThisInitialized(a)},v.sync),v.on(()=>a.sublayers,"after-remove",({item:c})=>{c.layer=c.parent=null},v.sync),v.watch(()=>a.sublayers,(c,g)=>{if(g)for(const f of g)f.layer=f.parent=null;if(c)for(const f of c)f.parent=f.layer=u._assertThisInitialized(a)},v.sync)]);return a}u._inheritsLoose(q,n);var h=q.prototype;h.normalizeCtorArgs=function(b,a){return"string"===typeof b?{url:b,...a}:b};h.load=function(b){const a=p.isSome(b)?b.signal:null;this.addResolvingPromise(this.loadFromPortal({supportedTypes:["WMS"]},
b).catch(Q.throwIfAbortError).then(()=>this._fetchService(a)));return Promise.resolve(this)};h.readFullExtentFromItemOrMap=function(b,a){return(b=a.extent)?new U({xmin:b[0][0],ymin:b[0][1],xmax:b[1][0],ymax:b[1][1]}):null};h.writeFullExtent=function(b,a){a.extent=[[b.xmin,b.ymin],[b.xmax,b.ymax]]};h.readImageFormat=function(b,a){return(b=a.supportedImageFormatTypes)&&b.includes("image/png")?"image/png":b&&b[0]};h.readSpatialReferenceFromItemOrDocument=function(b,a){return new z(a.spatialReferences[0])};
h.writeSpatialReferences=function(b,a){const c=this.spatialReference?.wkid;b&&c?(a.spatialReferences=b.filter(g=>g!==c),a.spatialReferences.unshift(c)):a.spatialReferences=b};h.readSublayersFromItemOrMap=function(b,a,c){return K(a.layers,c,a.visibleLayers)};h.readSublayers=function(b,a,c){return K(a.layers,c)};h.writeSublayers=function(b,a,c,g){a.layers=[];c=new Map;b=b.flatten(({sublayers:k})=>k);for(var f of b)if("number"===typeof f.parent?.id){var m=c.get(f.parent.id);null!=m?m.push(f.id):c.set(f.parent.id,
[f.id])}for(const k of b)f={sublayer:k,...g},m=k.write({parentLayerId:"number"===typeof k.parent?.id?k.parent.id:-1},f),c.has(k.id)&&(m.sublayerIds=c.get(k.id)),!k.sublayers&&k.name&&(f=k.write({},f),delete f.id,a.layers.push(f));a.visibleLayers=b.filter(({visible:k,sublayers:r})=>k&&!r).map(({name:k})=>k).toArray()};h.createExportImageParameters=function(b,a,c,g){c=g?.pixelRatio??1;a=F.getScale({extent:b,width:a})*c;a=new H.ExportWMSImageParameters({layer:this,scale:a});const {xmin:f,ymin:m,xmax:k,
ymax:r,spatialReference:y}=b;b=t.normalizeWKID(y,this.spatialReferences);c="1.3.0"===this.version&&da.isAxesOrderReversedForWkid(b)?`${m},${f},${r},${k}`:`${f},${m},${k},${r}`;a=a.toJSON();return{bbox:c,["1.3.0"===this.version?"crs":"srs"]:isNaN(b)?void 0:"EPSG:"+b,...a}};h.fetchImage=function(){var b=u._asyncToGenerator(function*(a,c,g,f){var m=this.mapUrl;a=this.createExportImageParameters(a,c,g,f);if(!a.layers)return m=document.createElement("canvas"),m.width=c,m.height=g,m;var k=f?.timeExtent?.start;
const r=f?.timeExtent?.end;k=p.isSome(k)&&p.isSome(r)?k.getTime()===r.getTime()?t.toISOString(k):`${t.toISOString(k)}/${t.toISOString(r)}`:void 0;c={responseType:"image",query:this._mixCustomParameters({width:c,height:g,...a,time:k,...this.refreshParameters}),signal:f?.signal};return A(m??"",c).then(y=>y.data)});return function(a,c,g,f){return b.apply(this,arguments)}}();h.fetchImageBitmap=function(){var b=u._asyncToGenerator(function*(a,c,g,f){var m=this.mapUrl;a=this.createExportImageParameters(a,
c,g,f);if(!a.layers)return m=document.createElement("canvas"),m.width=c,m.height=g,m;var k=f?.timeExtent?.start;const r=f?.timeExtent?.end;k=p.isSome(k)&&p.isSome(r)?k.getTime()===r.getTime()?t.toISOString(k):`${t.toISOString(k)}/${t.toISOString(r)}`:void 0;c={responseType:"blob",query:this._mixCustomParameters({width:c,height:g,...a,time:k,...this.refreshParameters}),signal:f?.signal};c=yield A(m??"",c).then(y=>y.data);return createImageBitmap(c)});return function(a,c,g,f){return b.apply(this,arguments)}}();
h.fetchFeatureInfo=function(b,a,c,g,f){var m=F.getScale({extent:b,width:a});m=new H.ExportWMSImageParameters({layer:this,scale:m});m=t.getPopupLayers(m.visibleSublayers);if(p.isNone(this.featureInfoUrl)||p.isNone(m)||p.isNone(this.fetchFeatureInfoFunction)&&p.isNone(this.featureInfoFormat))return Promise.resolve([]);g={query_layers:m,request:"GetFeatureInfo",info_format:this.featureInfoFormat,feature_count:25,width:a,height:c,...("1.3.0"===this.version?{I:g,J:f}:{x:g,y:f})};b={...this.createExportImageParameters(b,
a,c),...g};b=this._mixCustomParameters(b);return p.isSome(this.fetchFeatureInfoFunction)?this.fetchFeatureInfoFunction(b):this._defaultFetchFeatureInfoFunction(B.addQueryParameters(this.featureInfoUrl,b))};h.findSublayerById=function(b){return this.allSublayers.find(a=>a.id===b)};h.findSublayerByName=function(b){return this.allSublayers.find(a=>a.name===b)};h.serviceSupportsSpatialReference=function(b){return ea.isWmsServer(this.url)||null!=this.spatialReferences&&this.spatialReferences.some(a=>{a=
900913===a?z.WebMercator:new z({wkid:a});return V.equals(a,b)})};h._defaultFetchFeatureInfoFunction=function(b){const a=document.createElement("iframe");a.src=B.addProxy(b);a.style.border="none";a.style.margin="0";a.style.width="100%";a.setAttribute("sandbox","");b=new N({title:this.title,content:a});b=new M({sourceLayer:this,popupTemplate:b});return Promise.resolve([b])};h._fetchService=function(){var b=u._asyncToGenerator(function*(a){if(!this.resourceInfo){const {path:c,query:g}=this.parsedUrl??
{};g?.service&&(g.SERVICE=g.service,delete g.service);g?.request&&(g.REQUEST=g.request,delete g.request);({data:a}=yield A(c??"",{query:{SERVICE:"WMS",REQUEST:"GetCapabilities",...g,...this.customParameters},responseType:"xml",signal:a}));this.resourceInfo=t.parseCapabilities(a)}if(this.parsedUrl){a=new B.Url(this.parsedUrl.path);const {httpsDomains:c}=L.request;"https"!==a.scheme||a.port&&"443"!==a.port||!a.host||c.includes(a.host)||c.push(a.host)}this.read(this.resourceInfo,{origin:"service"})});
return function(a){return b.apply(this,arguments)}}();h._mixCustomParameters=function(b){if(!this.customLayerParameters&&!this.customParameters)return b;const a={...this.customParameters,...this.customLayerParameters};for(const c in a)b[c.toLowerCase()]=a[c];return b};u._createClass(q,[{key:"featureInfoFormat",get:function(){return p.isNone(this.featureInfoFormats)?null:this.featureInfoFormats.find(I)??this.featureInfoFormats.find(J)??null},set:function(b){p.isSome(b)?(I(b)||J(b))&&this._override("featureInfoFormat",
b):(this.revert("featureInfoFormat","service"),this._clearOverride("featureInfoFormat"))}}]);return q}(X.BlendLayer(ca.TemporalLayer(aa.RefreshableLayer(ba.ScaleRangeLayer(Y.OperationalLayer(Z.PortalLayer(d.MultiOriginJSONMixin(W))))))));e.__decorate([l.property({readOnly:!0})],d.prototype,"allSublayers",void 0);e.__decorate([l.property({json:{type:Object,write:!0}})],d.prototype,"customParameters",void 0);e.__decorate([l.property({json:{type:Object,write:!0}})],d.prototype,"customLayerParameters",
void 0);e.__decorate([l.property({type:String,json:{write:!0}})],d.prototype,"copyright",void 0);e.__decorate([l.property()],d.prototype,"description",void 0);e.__decorate([l.property({readOnly:!0})],d.prototype,"dimensions",void 0);e.__decorate([l.property({json:{type:[[Number]],read:{source:"extent"},write:{target:"extent"},origins:{"web-document":{write:{ignoreOrigin:!0}},"portal-item":{write:{ignoreOrigin:!0}}}}})],d.prototype,"fullExtent",void 0);e.__decorate([x.reader(["web-document","portal-item"],
"fullExtent",["extent"])],d.prototype,"readFullExtentFromItemOrMap",null);e.__decorate([C.writer(["web-document","portal-item"],"fullExtent",{extent:{type:[[Number]]}})],d.prototype,"writeFullExtent",null);e.__decorate([l.property()],d.prototype,"fullExtents",void 0);e.__decorate([l.property({type:String,json:{write:{ignoreOrigin:!0}}})],d.prototype,"featureInfoFormat",null);e.__decorate([l.property({type:[String],readOnly:!0})],d.prototype,"featureInfoFormats",void 0);e.__decorate([l.property({type:String,
json:{write:{ignoreOrigin:!0}}})],d.prototype,"featureInfoUrl",void 0);e.__decorate([l.property()],d.prototype,"fetchFeatureInfoFunction",void 0);e.__decorate([l.property({type:String,json:{origins:{"web-document":{default:"image/png",type:w.jsonValues,read:{reader:w.read,source:"format"},write:{writer:w.write,target:"format"}}}}})],d.prototype,"imageFormat",void 0);e.__decorate([x.reader("imageFormat",["supportedImageFormatTypes"])],d.prototype,"readImageFormat",null);e.__decorate([l.property({type:Number,
json:{read:{source:"maxHeight"},write:{target:"maxHeight"}}})],d.prototype,"imageMaxHeight",void 0);e.__decorate([l.property({type:Number,json:{read:{source:"maxWidth"},write:{target:"maxWidth"}}})],d.prototype,"imageMaxWidth",void 0);e.__decorate([l.property()],d.prototype,"imageTransparency",void 0);e.__decorate([l.property(G.legendEnabled)],d.prototype,"legendEnabled",void 0);e.__decorate([l.property({type:["show","hide","hide-children"]})],d.prototype,"listMode",void 0);e.__decorate([l.property({type:String,
json:{write:{ignoreOrigin:!0}}})],d.prototype,"mapUrl",void 0);e.__decorate([l.property({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],d.prototype,"isReference",void 0);e.__decorate([l.property({type:["WMS"]})],d.prototype,"operationalLayerType",void 0);e.__decorate([l.property()],d.prototype,"resourceInfo",void 0);e.__decorate([l.property({type:z,json:{origins:{service:{read:{source:"extent.spatialReference"}}},write:!1}})],d.prototype,"spatialReference",void 0);
e.__decorate([x.reader(["web-document","portal-item"],"spatialReference",["spatialReferences"])],d.prototype,"readSpatialReferenceFromItemOrDocument",null);e.__decorate([l.property({type:[R.Integer],json:{read:!1,origins:{service:{read:!0},"web-document":{read:!1,write:{ignoreOrigin:!0}},"portal-item":{read:!1,write:{ignoreOrigin:!0}}}}})],d.prototype,"spatialReferences",void 0);e.__decorate([C.writer(["web-document","portal-item"],"spatialReferences")],d.prototype,"writeSpatialReferences",null);
e.__decorate([l.property({type:E.ofType(D),json:{write:{target:"layers",overridePolicy(n,q,h){if(fa(this.allSublayers,h))return{ignoreOrigin:!0}}}}})],d.prototype,"sublayers",void 0);e.__decorate([x.reader(["web-document","portal-item"],"sublayers",["layers","visibleLayers"])],d.prototype,"readSublayersFromItemOrMap",null);e.__decorate([x.reader("service","sublayers",["layers"])],d.prototype,"readSublayers",null);e.__decorate([C.writer("sublayers",{layers:{type:[D]},visibleLayers:{type:[String]}})],
d.prototype,"writeSublayers",null);e.__decorate([l.property({json:{read:!1},readOnly:!0,value:"wms"})],d.prototype,"type",void 0);e.__decorate([l.property(G.url)],d.prototype,"url",void 0);e.__decorate([l.property({type:String,json:{write:{ignoreOrigin:!0}}})],d.prototype,"version",void 0);return d=e.__decorate([S.subclass("esri.layers.WMSLayer")],d)});