// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../core/Error ../../../core/maybe ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../RasterInfo ../RasterStorageInfo ./BaseRaster ./DBFParser ./pamParser ../rasterFormats/TiffDecoder ../rasterFormats/TiffTags ../rasterFunctions/stretchUtils ../rasterTransforms/PolynomialTransform ../../../rest/support/FeatureSet ../../../geometry/SpatialReference ../../../geometry/Extent ../../../geometry/Point".split(" "),
function(z,C,A,J,D,H,aa,ba,P,Q,R,S,T,M,E,I,U,V,W,X,N,F){A=function(O){function K(){var d=O.apply(this,arguments)||this;d._files=null;d._headerInfo=null;d._bufferSize=1048576;d.datasetFormat="TIFF";return d}z._inheritsLoose(K,O);var y=K.prototype;y.open=function(){var d=z._asyncToGenerator(function*(a){yield this.init();var b=a?D.unwrap(a.signal):null,{data:c}=yield this.request(this.url,{range:{from:0,to:this._bufferSize},responseType:"array-buffer",signal:b});if(!c)throw new J("tiffraster:open",
"failed to open url "+this.url);this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1);const {littleEndian:f,firstIFDPos:g,isBigTiff:e}=E.parseSignature(c),k=[];yield this._readIFDs(k,c,f,g,0,e?8:4,b);const {imageInfo:n,rasterInfo:h}=this._parseIFDs(k);this._headerInfo={littleEndian:f,isBigTiff:e,ifds:k,...n};this._set("rasterInfo",h);if(!n.isSupported)throw new J("tiffraster:open","this tiff is not supported: "+n.message);if(!n.tileWidth)throw new J("tiffraster:open","none-tiled tiff is not optimized for access, convert to COG and retry.");
({skipExtensions:b=[]}=this.ioConfig);b.includes("aux.xml")||(c=yield this._fetchAuxiliaryMetaData(a),null!=c&&this._processPAMInfo(c,h));b.includes("vat.dbf")||1!==h.bandCount||"u8"!==h.pixelType||(h.attributeTable=yield this._fetchAuxiliaryTable(a),D.isSome(h.attributeTable)&&(h.keyProperties.DataType="thematic"));this.updateTileInfo()});return function(a){return d.apply(this,arguments)}}();y.fetchRawTile=function(){var d=z._asyncToGenerator(function*(a,b,c,f={}){if(!this._headerInfo?.isSupported||
this.isBlockOutside(a,b,c))return null;b=this._getTileLocation(a,b,c);if(!b)return null;const {ranges:g,actualTileWidth:e,actualTileHeight:k,ifd:n}=b;b=g.map(t=>this.request(this.url,{range:t,responseType:"array-buffer",signal:f.signal}));b=yield Promise.all(b);c=b.map(t=>t.data.byteLength).reduce((t,m)=>t+m);c=1===b.length?b[0].data:new ArrayBuffer(c);var h=[0],u=[0];if(1<b.length){const t=new Uint8Array(c);for(let m=0,r=0;m<b.length;m++){const p=b[m].data;t.set(new Uint8Array(p),r);h[m]=r;r+=p.byteLength;
u[m]=p.byteLength}}const {blockWidth:v,blockHeight:x}=this.getBlockWidthHeight(a);a=yield this.decodePixelBlock(c,{format:"tiff",customOptions:{headerInfo:this._headerInfo,ifd:n,offsets:h,sizes:u},width:v,height:x,planes:null,pixelType:null});if(e!==v||k!==x)if(u=a.mask)for(b=0;b<x;b++)for(h=b*v,c=b<k?e:0;c<v;c++)u[h+c]=0;else for(u=new Uint8Array(v*x),a.mask=u,b=0;b<k;b++)for(h=b*v,c=0;c<e;c++)u[h+c]=1;return a});return function(a,b,c){return d.apply(this,arguments)}}();y._parseIFDs=function(d){const a=
E.getImageInfo(d),{width:b,height:c,tileWidth:f,tileHeight:g,planes:e,pixelType:k,compression:n,firstPyramidLevel:h,maximumPyramidLevel:u,pyramidBlockWidth:v,pyramidBlockHeight:x,tileBoundary:t,affine:m,metadata:r}=a;let p=M.parseSpatialReference(a.extent.spatialReference?.wkt||a.extent.spatialReference?.wkid);var l=!1;null==p&&(l=!0,p=new X({wkid:3857}));const q=new N({...a.extent,spatialReference:p});var w=q?new F({x:q.xmin,y:q.ymax,spatialReference:p}):new F({x:0,y:0});w=new R({blockWidth:f,blockHeight:g,
pyramidBlockWidth:v,pyramidBlockHeight:x,compression:n,origin:w,firstPyramidLevel:h,maximumPyramidLevel:u,blockBoundary:t});const Y=new F({x:(q.xmax-q.xmin)/b,y:(q.ymax-q.ymin)/c,spatialReference:p}),Z=r?{BandProperties:r.bandProperties,DataType:r.dataType}:{};let L=null;var G=d[0].get("PHOTOMETRICINTERPRETATION")?.values?.[0];d=d[0].get("COLORMAP")?.values;if(3===G&&3<d?.length&&0===d.length%3){L=[];G=d.length/3;for(let B=0;B<G;B++)L.push([B,d[B]>>>8,d[B+G]>>>8,d[B+2*G]>>>8])}l=new Q({width:b,height:c,
bandCount:e,pixelType:k,pixelSize:Y,storageInfo:w,spatialReference:p,isPseudoSpatialReference:l,keyProperties:Z,extent:q,colormap:L,statistics:r?r.statistics:null});m?.length&&(l.nativeExtent=new N({xmin:-.5,ymin:.5-c,xmax:b-.5,ymax:.5,spatialReference:p}),l.transform=new V({polynomialOrder:1,forwardCoefficients:[m[2]+m[0]/2,m[5]-m[3]/2,m[0],m[3],-m[1],-m[4]]}),l.extent=l.transform.forwardTransform(l.nativeExtent),l.pixelSize=new F({x:(q.xmax-q.xmin)/b,y:(q.ymax-q.ymin)/c,spatialReference:p}),w.origin.x=
-.5,w.origin.y=.5);return{imageInfo:a,rasterInfo:l}};y._processPAMInfo=function(d,a){a.statistics=d.statistics??a.statistics;(a.histograms=d.histograms)&&D.isNone(a.statistics)&&(a.statistics=U.estimateStatisticsFromHistograms(d.histograms));if(d.transform&&D.isNone(a.transform)){a.transform=d.transform;a.nativeExtent=a.extent;const b=a.transform.forwardTransform(a.nativeExtent);a.pixelSize=new F({x:(b.xmax-b.xmin)/a.width,y:(b.ymax-b.ymin)/a.height,spatialReference:a.spatialReference});a.extent=
b}a.spatialReference||(a.spatialReference=d.spatialReference)};y._readIFDs=function(){var d=z._asyncToGenerator(function*(a,b,c,f,g,e=4,k){if(!f)return null;if(f>=b.byteLength||0>f)b=(yield this.request(this.url,{range:{from:f+g,to:f+g+this._bufferSize},responseType:"array-buffer",signal:k})).data,g=f+g,f=0;f=yield this._readIFD(b,c,f,g,I.TIFF_TAGS,e,k);a.push(f.ifd);if(!f.nextIFD)return null;yield this._readIFDs(a,b,c,f.nextIFD-g,g,e,k)});return function(a,b,c,f,g){return d.apply(this,arguments)}}();
y._readIFD=function(){var d=z._asyncToGenerator(function*(a,b,c,f,g=I.TIFF_TAGS,e=4,k){if(!a)return null;c=E.parseIFD(a,b,c,f,g,e);if(c.success){const n=[];c.ifd?.forEach(h=>{h.values||n.push(h)});0<n.length&&(e=n.map(h=>h.offlineOffsetSize).filter(D.isSome),g=Math.min.apply(null,e.map(h=>h[0])),Math.min.apply(null,e.map(h=>h[0]+h[1]))-g<=this._bufferSize&&({data:e}=yield this.request(this.url,{range:{from:g,to:g+this._bufferSize},responseType:"array-buffer",signal:k}),a=e,f=g,n.forEach(h=>E.parseFieldValues(a,
b,h,f))));c.ifd?.has("GEOKEYDIRECTORY")&&(g=c.ifd.get("GEOKEYDIRECTORY"),(e=g?.values)&&4<e.length&&(e=e[0]+"."+e[1]+"."+e[2],k=yield this._readIFD(a,b,g.valueOffset+6-f,f,I.GEO_KEYS,2,k),g.data=k.ifd,g.data&&g.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[e]})));return c}if(c.requiredBufferSize&&c.requiredBufferSize!==a.byteLength)return a=(yield this.request(this.url,{range:{from:f,to:f+c.requiredBufferSize+4},responseType:"array-buffer",signal:k})).data,a.byteLength<
c.requiredBufferSize?null:this._readIFD(a,b,0,f,I.TIFF_TAGS,4,k)});return function(a,b,c,f){return d.apply(this,arguments)}}();y._getTileLocation=function(d,a,b){const {firstPyramidLevel:c,blockBoundary:f}=this.rasterInfo.storageInfo;var g=0===d?0:d-(c-1);d=this._headerInfo?.ifds[g];if(!d)return null;var e=E.isBSQConfig(d,this._headerInfo);const k=d.get("TILEOFFSETS")?.values;if(void 0===k)return null;var n=d.get("TILEBYTECOUNTS")?.values;const {minRow:h,minCol:u,maxRow:v,maxCol:x}=f[g];if(a>v||b>
x||a<h||b<u)return null;g=d.get("IMAGEWIDTH")?.values?.[0];const t=d.get("IMAGELENGTH")?.values?.[0],m=d.get("TILEWIDTH")?.values?.[0],r=d.get("TILELENGTH")?.values?.[0],p=e?this.rasterInfo.bandCount:1,l=p*a*(x+1)+b,q=[{from:k[l],to:k[l+p-1]+n[l+p-1]-1}];if(e){e=!0;for(let w=0;w<p;w++)if(k[l+w]+n[l+w]!==k[l+w+1]){e=!1;break}if(!e)for(e=0;e<p;e++)q[e]={from:k[l+e],to:k[l+e]+n[l+e]-1}}n=n[l];return null==k[l]||null==n?null:{ranges:q,ifd:d,actualTileWidth:b===x?g%m||m:m,actualTileHeight:a===v?t%r||r:
r}};y._fetchAuxiliaryMetaData=function(){var d=z._asyncToGenerator(function*(a){try{const {data:b}=yield this.request(this.url+".aux.xml",{responseType:"xml",signal:a?.signal});return M.parsePAMInfo(b)}catch{return null}});return function(a){return d.apply(this,arguments)}}();y._fetchAuxiliaryTable=function(){var d=z._asyncToGenerator(function*(a){try{const {data:b}=yield this.request(this.url+".vat.dbf",{responseType:"array-buffer",signal:a?.signal}),c=T.parse(b);return c?.recordSet?W.fromJSON(c.recordSet):
null}catch{return null}});return function(a){return d.apply(this,arguments)}}();return K}(S);C.__decorate([H.property()],A.prototype,"_files",void 0);C.__decorate([H.property()],A.prototype,"_headerInfo",void 0);C.__decorate([H.property()],A.prototype,"_bufferSize",void 0);C.__decorate([H.property({type:String,json:{write:!0}})],A.prototype,"datasetFormat",void 0);return A=C.__decorate([P.subclass("esri.layers.support.rasterDatasets.TIFFRaster")],A)});