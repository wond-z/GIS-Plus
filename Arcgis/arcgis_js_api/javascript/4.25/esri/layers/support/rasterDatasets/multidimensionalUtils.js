// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/maybe","../DimensionalDefinition"],function(m,n,r){function t(b,a,c){const e=a.shift();0===c.length&&c.push({sliceId:-1,multidimensionalDefinition:[]});const d=c.length;for(let f=0;f<d;f++){const l=c.shift().multidimensionalDefinition;e.values?.forEach(g=>{c.push({sliceId:-1,multidimensionalDefinition:[...l,{variableName:b,dimensionName:e.name,values:[g]}]})})}a.length&&t(b,a,c)}function u(b,a){return Array.isArray(b)?a[0]===a[1]?b[0]===a[0]||b[1]===a[0]:b[0]>=a[0]&&
b[0]<=a[1]&&b[1]>=a[0]&&b[1]<=a[1]:b>=a[0]&&b<=a[1]}function z(b,a){return b[0]<=a[0]&&b[1]>=a[0]||b[0]<=a[1]&&b[1]>=a[1]||b[0]>=a[0]&&b[1]<=a[1]}function v(b){return 1===b.length?[b[0],b[0]]:[b[0],b[b.length-1]]}function w(b,a,c){if(!a?.subsetDefinitions?.length)return b;if(c){const {variables:d}=a;if(d.length&&!d.includes(c))return null;a=a.subsetDefinitions.find(f=>f.dimensionName===b.name&&f.variableName===c);if(!a?.values?.length)return b;a=v(a.values)}else a=a.dimensions.find(({name:d})=>d===
b.name)?.extent;const e=a;if(!e||!e?.length)return b;a=b.values.filter(d=>u(d,e));return{...b,extent:[...e],values:a}}function A(b,a){var {values:c}=a;if(c?.length)return Array.isArray(c[0])!==Array.isArray(b)?-1:Array.isArray(c[0])?c.findIndex(f=>f[0]===b[0]&&f[1]===b[1]):c.indexOf(b);var {extent:e}=a;if(Array.isArray(b)||b<e[0]||b>e[1])return-1;c=a.interval||1;if("ISO8601"!==a.unit)return Math.round((b-e[0])/c);e=e[0];let d=-1;switch(a.intervalUnit?.toLowerCase()||"seconds"){case "seconds":d=Math.round((b-
e)/1E3/c);break;case "minutes":d=Math.round((b-e)/6E4/c);break;case "hours":d=Math.round((b-e)/36E5/c);break;case "days":d=Math.round((b-e)/864E5/c);break;case "months":a=(new Date(b)).getUTCFullYear()-(new Date(e)).getUTCFullYear();c=(new Date(e)).getUTCMonth();e=(new Date(b)).getUTCMonth();d=0===a?e-c:e+11-c+12*(a-1);break;case "years":d=Math.round(((new Date(b)).getUTCFullYear()-(new Date(e)).getUTCFullYear())/c);break;case "decades":d=Math.round(((new Date(b)).getUTCFullYear()-(new Date(e)).getUTCFullYear())/
10/c)}return d}function x(b){var a=b.values?.length;if(a)return a;const {extent:c,unit:e}=b;a=b.interval||1;var d=c?c[1]-c[0]:0;if("ISO8601"!==e)return Math.round(d/a);switch(b.intervalUnit?.toLowerCase()??"seconds"){case "seconds":a=Math.round(d/1E3/a);break;case "minutes":a=Math.round(d/6E4/a);break;case "hours":a=Math.round(d/36E5/a);break;case "days":a=Math.round(d/864E5/a);break;case "months":b=(new Date(c[1])).getUTCFullYear()-(new Date(c[0])).getUTCFullYear();a=(new Date(c[1][0])).getUTCMonth();
d=(new Date(c[1][1])).getUTCMonth();a=0===b?d-a+1:d+11-a+12*(b-1)+1;break;case "years":a=Math.round(((new Date(c[1])).getUTCFullYear()-(new Date(c[0])).getUTCFullYear())/a);break;case "decades":a=Math.round(((new Date(c[1])).getUTCFullYear()-(new Date(c[0])).getUTCFullYear())/10/a);break;default:a=0}return a}m.createSlices=function(b,a){const c=[];let e=0;(a?b.variables.filter(d=>d.name.toLowerCase()===a.toLowerCase()):[...b.variables].sort((d,f)=>d.name>f.name?1:-1)).forEach(d=>{const f=[],l=[...d.dimensions].sort((g,
h)=>g.name>h.name?-1:1);t(d.name,l,f);f.forEach(g=>{c.push({...g,sliceId:e++})})});return c};m.getDefaultMultidimensionalDefinition=function(b,a={}){const {multidimensionalInfo:c,keyProperties:e}=b;if(n.isNone(c))return null;const d=a.variableName||e?.DefaultVariable;({variables:b}=c);const {multidimensionalSubset:f}=a;f?.variables?.length&&(b=b.filter(({name:k})=>f.variables.includes(k)));var l=d?b.find(({name:k})=>k===d)??b[0]:b[0];if(!l)return null;b=[];const {dimensions:g,name:h}=l;if(0===g.length)return[new r({variableName:h,
dimensionName:"",values:[],isSlice:!0})];for(l=0;l<g.length;l++){const k=w(g[l],f,h);if(!k)return null;const {values:p,extent:q}=k;let y=p?.[0]??q[0];"stdz"===k.name.toLowerCase()&&!k.hasRanges&&Math.abs(q[1])<=Math.abs(q[0])&&(y=p?.length?p[p.length-1]:q[1]);b.push(new r({variableName:h,dimensionName:k.name,values:[y],isSlice:a.useRangeForRangedDimensionInfo?!!k.hasRanges:!0}))}return b};m.getSliceIds=function(b,a,c){let e=b;a&&(a=[...a].sort((d,f)=>d.dimensionName<f.dimensionName?-1:1),a.forEach(({dimensionName:d,
values:f,isSlice:l})=>{f.length&&(e=e.filter(g=>{g=g.multidimensionalDefinition.find(k=>k.dimensionName===d);if(null==g)return!1;const h=g.values[0];return"number"===typeof h?"number"===typeof f[0]?f.includes(h):f.some(k=>k[0]<=h&&k[1]>=h):"number"===typeof f[0]?f.some(k=>h[0]<=k&&h[1]>=k):l?f.some(k=>k[0]===h[0]&&k[0]===h[1]):f.some(k=>k[0]>=h[0]&&k[0]<=h[1]||k[1]>=h[0]&&k[1]<=h[1]||k[0]<h[0]&&k[1]>h[1])}))}));if(e.length&&c&&n.isSome(c.start)&&n.isSome(c.end)){const d=c.start.getTime(),f=c.end.getTime(),
l=e[0].multidimensionalDefinition.findIndex(g=>"StdTime"===g.dimensionName);-1<l&&(e=e.filter(g=>{g=g.multidimensionalDefinition[l].values[0];return d<=g&&f>=g}))}return e.map(d=>d.sliceId)};m.getSliceIndex=function(b,a){let c=0;var e=b[0].variableName;a=[...a.variables].sort((f,l)=>f.name>l.name?1:-1);for(var d=0;d<a.length;d++){const f=a[d],l=[...f.dimensions].sort((g,h)=>g.name>h.name?-1:1);if(f.name!==e)c+=l.map(g=>x(g)).reduce((g,h)=>g*h);else{e=l.map(g=>x(g));a=l.length;for(let g=0;g<a;g++){d=
b.find(h=>h.dimensionName===l[g].name);if(null==d)return null;d=A(d.values[0],l[g]);if(-1===d)return null;e.shift();c=g===a-1?c+d:c+d*e.reduce((h,k)=>h*k)}break}}return c};m.getSubsetVariablesFromMdInfo=function(b,a){if(n.isNone(a)||n.isNone(b))return null;a=a.variables.map(c=>({...c}));b?.variables?.length&&(a=a.filter(({name:c})=>b.variables.includes(c)),a.forEach(c=>{c.dimensions=c.dimensions.map(e=>w(e,b,c.name))}));return a};m.hasExcludedVariableOrDimension=function(b,a,c){if(!a?.subsetDefinitions?.length)return!1;
const {variables:e}=a;if(e.length&&b.some(({variableName:d})=>d&&!e.includes(d)))return!0;for(let d=0;d<b.length;d++){const f=b[d],l=a.subsetDefinitions.find(g=>(""===f.variableName||g.variableName===f.variableName)&&g.dimensionName===f.dimensionName);if(l?.values.length){const g=v(l.values);if(!f.isSlice&&2===f.values.length&&!Array.isArray(f.values[0])&&f.values[0]!==f.values[1]&&c){if(!z(f.values,g))return!0}else if(f.values.some(h=>!u(h,g)))return!0}}return!1};m.isMultiSliceOrRangeDefinition=
function(b){return n.isNone(b)||!b.length?!1:b.some(a=>{if(null==a.values)return!0;const c=a.values.length;return 0===c||1<c||!a.isSlice&&Array.isArray(a.values[0])})};Object.defineProperties(m,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});