// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../request ../../core/JSONSupport ../../core/Loadable ../../core/maybe ../../core/accessorSupport/decorators/property ../../core/arrayUtils ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/subclass ./arcgisLayerUrl ./Contingency ./ContingencyConstraintViolation ./ContingentValue ./ContingentValuesResult ./FieldGroup ./Subtype".split(" "),function(u,C,A,x,M,E,D,P,Q,N,F,H,I,t,O,G,J){var y;x=y=function(K){function B(c){c=
K.call(this,c)||this;c.request=A;c.fieldGroups=null;c.fieldGroupDefinitions=null;return c}u._inheritsLoose(B,K);var m=B.prototype;m.initialize=function(){};B.createLoadedLayerContingentValuesCache=function(){var c=u._asyncToGenerator(function*(a){yield a.load();if(void 0===a.layerId)return null;var b=a.sourceJSON.hasContingentValuesDefinition;if(b)return(new y({layer:a})).load();if(void 0===b){b=F.parse(a.url);if(E.isNone(b))return null;b=b.url.path;if((yield y._staticFetchEnterpriseFeatureRoot(b)).supportsQueryDataElements&&
(b=yield y._staticFetchEnterpriseFieldGroup(b,a.layerId.toString())))return b=b.map(d=>({name:d.name,isEditingRestrictive:d.isEditingRestrictive,fields:d.fieldNames.names})),(new y({layer:a,fieldGroupDefinitions:b})).load()}return null});return function(a){return c.apply(this,arguments)}}();m.load=function(){var c=u._asyncToGenerator(function*(a){const b=this.layer.load(a).then(()=>this._initializeContingentValues(this.fieldGroupDefinitions,a));this.addResolvingPromise(b);return this});return function(a){return c.apply(this,
arguments)}}();m.validateContingencyConstraints=function(c,a){const b=this.layer.typeIdField,d=Object.keys(c),e=[],f=[];for(const g of this.fieldGroups){const n=g.isEditingRestrictive?"error":"warning";if(a&&!g.fields.some(p=>a.includes(p)))continue;if(!g.fields.every(p=>d.includes(p))){f.push(new I({fieldGroup:g,type:n}));continue}let q=!1;const k=c[b];var l=g.contingencies.filter(p=>!p.isRetired&&p.subtype?p.subtype.code===k:!0);for(const p of l){l=!0;for(const r in p.values){const h=p.values[r];
if("any"!==h.objectType)if("null"===h.objectType){if(null!=c[r]){l=!1;break}}else if("code"===h.objectType){if(c[r]!==h.codedValue.code){l=!1;break}}else if("range"===h.objectType){const v=c[r];if(v<h.minValue||v>h.maxValue){l=!1;break}}}if(l){q=!0;break}}q||e.push(new I({fieldGroup:g,type:n}))}return{invalid:e,incomplete:f}};m.getContingentValues=function(c,a,b=!1){const d=c[this.layer.typeIdField],e=void 0!==d&&null!==d,f={};let l=[];const g=this.fieldGroups.filter(q=>q.fields.includes(a));l.push(new t({objectType:"any"}));
for(const q of g){let k=[];var n=q.contingencies.filter(h=>!h.isRetired&&(h.subtype&&e?h.subtype.code===d:!0));let p=!1;const r={};for(const h of n){let v;n=!0;for(const z in h.values){const w=h.values[z];if(a===z)v=w,p=p||"range"===w.objectType;else if(void 0!==c[z]&&"any"!==w.objectType)if("null"===w.objectType)null!==c[z]&&(n=!1);else if("code"===w.objectType)c[z]!==w.codedValue.code&&(n=!1);else if("range"===w.objectType){const L=c[z];if(L<w.minValue||L>w.maxValue)n=!1}}if(v&&n){if("any"===v.objectType){k.length=
0;k.push(v);break}n=this._generateKey(v);r[n]||k.push(v);r[n]=!0}}p&&(k=this._joinRange(k));f[q.name]=k;l=b?this._filterIntersection(l,k):null}1===g.length&&b&&(l=[]);return new O({contingentValuesAllGroups:l,contingentValuesByFieldGroup:f})};m._generateKey=function(c){switch(c.objectType){case "any":return"@any@";case "null":return"@null@";case "code":return c.codedValue.name+c.codedValue.code.toString();case "range":return c.minValue.toString()+"-"+c.maxValue.toString()}};m._joinRange=function(c){c.sort((e,
f)=>"null"===e.objectType?-1:"null"===f.objectType?1:e.minValue-f.minValue);let a,b;const d=[];for(const e of c)"null"===e.objectType?d.push(e):void 0===a?(a=e.minValue,b=e.maxValue):b<e.minValue?(d.push(new t({objectType:"range",minValue:a,maxValue:b})),a=e.minValue,b=e.maxValue):b<e.maxValue&&(b=e.maxValue);d.push(new t({objectType:"range",minValue:a,maxValue:b}));return d};m._filterIntersection=function(c,a){if(0===c.length||0===a.length)return[];if("any"===c[0].objectType)return a;if("any"===
a[0].objectType)return c;const b="range"===a[0].objectType||"range"===a[1]?.objectType;return"range"===c[0].objectType||"range"===c[1]?.objectType||b?this._intersectRanges(c,a):this._intersectValues(c,a)};m._intersectRanges=function(c,a){const b=[];let d=0;for(const e of c)for(;d<a.length;d++){const f=a[d];if("null"===e.objectType&&"null"===f.objectType)b.push(new t({objectType:"null"}));else if("null"===e.objectType)break;else if("null"===f.objectType)continue;if(e.maxValue<f.minValue)break;if(e.maxValue===
f.minValue){b.push(new t({objectType:"range",minValue:e.maxValue,maxValue:f.minValue}));break}if(!(e.minValue>f.maxValue))if(e.minValue===f.maxValue)b.push(new t({objectType:"range",minValue:e.minValue,maxValue:f.maxValue}));else{c=e.minValue>f.minValue?e.minValue:f.minValue;if(e.maxValue<f.maxValue){b.push(new t({objectType:"range",minValue:c,maxValue:e.maxValue}));break}b.push(new t({objectType:"range",minValue:c,maxValue:f.maxValue}))}}return b};m._intersectValues=function(c,a){const b=[];for(const d of c)a.some(e=>
{if(d.objectType===e.objectType)switch(d.objectType){case "any":case "null":return!0;case "code":return d.codedValue.code===e.codedValue.code&&d.codedValue.name===e.codedValue.name}return!1})&&b.push(d);return b};B._staticFetchEnterpriseFeatureRoot=function(){var c=u._asyncToGenerator(function*(a,b){return A(a,{responseType:"json",query:{f:"json"},...b}).then(d=>d.data)});return function(a,b){return c.apply(this,arguments)}}();B._staticFetchEnterpriseFieldGroup=function(){var c=u._asyncToGenerator(function*(a,
b,d){return A(`${a}/queryDataElements`,{responseType:"json",query:{layers:JSON.stringify([b]),f:"json"},...d}).then(e=>e.data.layerDataElements?.[0].dataElement.fieldGroups)});return function(a,b,d){return c.apply(this,arguments)}}();m._initializeContingentValues=function(){var c=u._asyncToGenerator(function*(a,b){a=a?a:yield this._fetchFieldGroupDefs(b);this.fieldGroups=0===a.length?[]:yield this._fetchContingentValues(a,b)});return function(a,b){return c.apply(this,arguments)}}();m._fetchFieldGroupDefs=
function(){var c=u._asyncToGenerator(function*(a){var b=this;if(void 0===this.layer.layerId)return[];const d=this.layer.sourceJSON,e=this.layer.layerId.toString(),f=E.unwrap(F.parse(this.layer.url)).url.path;return d.hasContingentValuesDefinition?(yield this._fetchAGOLFieldGroup(f,e,a)).map(l=>({name:l.name,isEditingRestrictive:l.restrictive,fields:l.fields.map(g=>this.layer.fieldsIndex.normalizeFieldName(g))})):void 0!==d.hasContingentValuesDefinition?[]:this._fetchEnterpriseFeatureRoot(f,a).then(function(){var l=
u._asyncToGenerator(function*(g){return g.supportsQueryDataElements?(yield b._fetchEnterpriseFieldGroup(f,e,a)).map(n=>({name:n.name,isEditingRestrictive:n.isEditingRestrictive,fields:n.fieldNames.names.map(q=>b.layer.fieldsIndex.normalizeFieldName(q))})):[]});return function(g){return l.apply(this,arguments)}}())});return function(a){return c.apply(this,arguments)}}();m._fetchAGOLFieldGroup=function(){var c=u._asyncToGenerator(function*(a,b,d){return A(`${a}/${b}/fieldgroups`,{responseType:"json",
query:{f:"json"},...d}).then(e=>e.data.fieldGroups)});return function(a,b,d){return c.apply(this,arguments)}}();m._fetchEnterpriseFieldGroup=function(){var c=u._asyncToGenerator(function*(a,b,d){return y._staticFetchEnterpriseFieldGroup(a,b,d)});return function(a,b,d){return c.apply(this,arguments)}}();m._fetchEnterpriseFeatureRoot=function(){var c=u._asyncToGenerator(function*(a,b){return y._staticFetchEnterpriseFeatureRoot(a,b)});return function(a,b){return c.apply(this,arguments)}}();m._fetchContingentValues=
function(){var c=u._asyncToGenerator(function*(a,b){if(void 0===this.layer.layerId)return[];const d=this.layer.sourceJSON,e=this.layer.layerId.toString(),f=E.unwrap(F.parse(this.layer.url)).url.path;if(d.hasContingentValuesDefinition)return b=yield this._fetchAGOLContingentValues(f,e,b),this._constructFieldGroupsAGOL(a,b);b=yield this._fetchEnterpriseContingentValues(f,e,b);return this._constructFieldGroupsEnterprise(a,b)});return function(a,b){return c.apply(this,arguments)}}();m._constructFieldGroupsAGOL=
function(c,a){return c.map(b=>{const d=a.contingentValuesDefinition.fieldGroups.find(e=>e.name===b.name);if(d){let e=[];e=a.contingentValuesDefinition.hasSubType?this._parseAGOLFieldGroupSubtype(b,a,d.subTypes):this._parseAGOLFieldGroup(b,a,d.contingentValues);return new G({name:b.name,isEditingRestrictive:b.isEditingRestrictive,fields:b.fields,contingencies:e})}return null}).filter(b=>null!==b)};m._parseAGOLFieldGroupSubtype=function(c,a,b){let d=[];b.forEach(e=>{const f=this._getSubtypeAGOL(e.name);
d=d.concat(this._parseAGOLFieldGroup(c,a,e.contingentValues,f))});return d};m._parseAGOLFieldGroup=function(c,a,b,d=null){const e=[];for(const f of b)b=this._parseAGOLContingency(f,c,a,d),e.push(b);return e};m._parseAGOLContingency=function(c,a,b,d){const e=c.id,f=c.retired?1===c.retired:!1,l={};for(let n=0,q=0;n<a.fields.length;n++){const k=a.fields[n];var g=b.typeCodes[c.types[n]];if("Code"===g){let p=c.values[q];q++;const r=this._getDomain(d,k);"string"===this.layer.getField(k).type&&(g=b.stringDicts.find(h=>
h.domain===r.name))&&(p=g.entries[p]);g=r.codedValues.find(h=>h.code===p);g=new t({codedValue:g,objectType:"code"});l[k]=g}else"Range"===g?(g=c.values[q],q++,g=new t({minValue:g.range[0],maxValue:g.range[1],objectType:"range"}),l[k]=g):"Any"===g?(g=new t({objectType:"any"}),l[k]=g):(g=new t({objectType:"null"}),l[k]=g)}return new H({id:e,isRetired:f,subtype:d,values:l})};m._constructFieldGroupsEnterprise=function(c,a){const b=a.fieldGroups;return c.map(d=>{var e=b.find(f=>f.name===d.name);return e?
(e=e.contingencies.map(f=>{const l=f.id,g=f.isRetired||!1,n=this._getSubtypeEnterprise(f.subtypeCode),q={};for(let p=0;p<d.fields.length;p++){const r=d.fields[p];let h=f.values[p];if("number"===typeof h||"string"===typeof h){var k=this._getDomain(n,r);const v=this.layer.getField(r);"string"===v.type?h=a.stringDictionary[h]:"date"===v.type&&(h=(new Date(`${h}+00:00`)).getTime());k=k.codedValues.find(z=>z.code===h);k=new t({codedValue:k,objectType:"code"});q[r]=k}else"object"===typeof h?(k=new t({minValue:h.minValue,
maxValue:h.maxValue,objectType:"range"}),q[r]=k):h?(k=new t({objectType:"any"}),q[r]=k):(k=new t({objectType:"null"}),q[r]=k)}return new H({id:l,isRetired:g,subtype:n,values:q})}),new G({name:d.name,isEditingRestrictive:d.isEditingRestrictive,fields:d.fields,contingencies:e})):null}).filter(d=>null!==d)};m._fetchEnterpriseContingentValues=function(){var c=u._asyncToGenerator(function*(a,b,d){return A(`${a}/queryContingentValues`,{responseType:"json",query:{layers:JSON.stringify([b]),f:"json"},...d}).then(e=>
e.data.contingentValueSets?.[0])});return function(a,b,d){return c.apply(this,arguments)}}();m._fetchAGOLContingentValues=function(){var c=u._asyncToGenerator(function*(a,b,d){return A(`${a}/${b}/contingentValues`,{responseType:"json",query:{f:"json"},...d}).then(e=>e.data)});return function(a,b,d){return c.apply(this,arguments)}}();m._getSubtypeEnterprise=function(c){var a=this.layer.sourceJSON;let b;a.subtypes&&(a=a.subtypes.find(d=>d.code===c),b=J.fromJSON(a));return b?b:null};m._getSubtypeAGOL=
function(c){var a=this.layer.sourceJSON;let b;a.subtypes&&(a=a.subtypes.find(d=>d.name===c),b=J.fromJSON(a));return b?b:null};m._getDomain=function(c,a){c=c?c.domains[a]:this.layer.getFieldDomain(a);return"inherited"===c.type?this.layer.getFieldDomain(a):c};return B}(x.JSONSupportMixin(M));C.__decorate([D.property({constructOnly:!0})],x.prototype,"layer",void 0);C.__decorate([D.property({constructOnly:!0})],x.prototype,"request",void 0);C.__decorate([D.property({type:[G]})],x.prototype,"fieldGroups",
void 0);C.__decorate([D.property({constructOnly:!0})],x.prototype,"fieldGroupDefinitions",void 0);return x=y=C.__decorate([N.subclass("esri.layers.support.LayerContingentValuesCache")],x)});