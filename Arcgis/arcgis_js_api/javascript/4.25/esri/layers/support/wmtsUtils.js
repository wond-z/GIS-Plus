// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../core/Error ../../core/maybe ../../geometry/Extent ../../geometry/Point ../../geometry/projectionEllipsoid ../../geometry/support/WKIDUnitConversion ../ogc/crsUtils ../ogc/xmlUtils ./TileInfo".split(" "),function(w,G,H,I,J,Q,C,D,K,R){function p(b,a){for(let d=0;d<a.childNodes.length;d++){const c=a.childNodes[d];if(c.nodeType===Node.ELEMENT_NODE&&c.nodeName===b)return c}return null}function v(b,a){const d=[];for(let c=0;c<a.childNodes.length;c++){const f=a.childNodes[c];f.nodeType===
Node.ELEMENT_NODE&&f.nodeName===b&&d.push(f)}return d}function x(b,a){const d=[];for(let c=0;c<a.childNodes.length;c++){const f=a.childNodes[c];f.nodeType===Node.ELEMENT_NODE&&f.nodeName===b&&d.push(f)}return d.map(c=>c.textContent).filter(H.isSome)}function l(b,a){b.split("\x3e").forEach(d=>{a&&(a=p(d,a))});return a&&a.textContent}function y(b,a,d,c){let f;Array.prototype.slice.call(c.childNodes).some(e=>{if(e.nodeName.includes(b)){var h=p(a,e);h=h&&h.textContent;if(h===d||d.split(":")&&d.split(":")[1]===
h)return f=e,!0}return!1});return f}function L(b,a){const d=[];var c=b.layerMap?.get(a);if(!c)return null;const f=v("ResourceURL",c);c=v("Dimension",c);let e,h,k,m;c.length&&(e=l("Identifier",c[0]),h=x("Default",c[0])||x("Value",c[0]));1<c.length&&(k=l("Identifier",c[1]),m=x("Default",c[1])||x("Value",c[1]));b.dimensionMap.set(a,{dimensions:h,dimensions2:m});f.forEach(q=>{let g=q.getAttribute("template");if("tile"===q.getAttribute("resourceType")){if(e&&h.length)if(g.includes("{"+e+"}"))g=g.replace("{"+
e+"}","{dimensionValue}");else{var n=g.toLowerCase().indexOf("{"+e.toLowerCase()+"}");-1<n&&(g=g.substring(0,n)+"{dimensionValue}"+g.substring(n+e.length+2))}k&&m.length&&(g.includes("{"+k+"}")?g=g.replace("{"+k+"}","{dimensionValue2}"):(n=g.toLowerCase().indexOf("{"+k.toLowerCase()+"}"),-1<n&&(g=g.substring(0,n)+"{dimensionValue2}"+g.substring(n+k.length+2))));d.push({template:g,format:q.getAttribute("format"),resourceType:"tile"})}});return d}function M(b,a,d){b=L(b,a);a=b?.filter(c=>c.format===
d);return(a?.length?a:b)??[]}function S(b){const a=[];K.visitXML(b,{BoundingBox:d=>{if(d.getAttribute("crs")){var c=d.getAttribute("crs").toLowerCase(),f=E(c),e=c.includes("epsg")&&D.isAxesOrderReversedForWkid(f.wkid),h,k,m,q;K.visitXML(d,{LowerCorner:g=>{[h,k]=g.textContent.split(" ").map(n=>Number.parseFloat(n));e&&([h,k]=[k,h])},UpperCorner:g=>{[m,q]=g.textContent.split(" ").map(n=>Number.parseFloat(n));e&&([m,q]=[q,m])}});a.push({xmin:h,ymin:k,xmax:m,ymax:q,spatialReference:f})}}});return a}function T(b,
a){return v("Style",b).map(d=>{var c=p("LegendURL",d),f=p("Keywords",d);f=f?x("Keyword",f):[];c=c&&c.getAttribute("xlink:href");a&&(c=c&&c.replace(/^http:/i,"https:"));return{abstract:l("Abstract",d),id:l("Identifier",d),isDefault:"true"===d.getAttribute("isDefault"),keywords:f,legendUrl:c,title:l("Title",d)}})}function U(b,a,d){return v("TileMatrixSetLink",a).map(c=>V(b,c,d))}function V(b,a,d){const c=p("TileMatrixSet",a).textContent;var f=x("TileMatrix",a);const e=d.find(g=>{g=(g=p("Identifier",
g))&&g.textContent;return g===c||c.split(":")&&c.split(":")[1]===g?!0:!1});a=(a=p("TileMatrixSetLimits",a))&&v("TileMatrixLimits",a);const h=new Map;if(a?.length)for(var k of a){a=p("TileMatrix",k).textContent;d=+p("MinTileRow",k).textContent;const g=+p("MaxTileRow",k).textContent,n=+p("MinTileCol",k).textContent,z=+p("MaxTileCol",k).textContent;h.set(a,{minCol:n,maxCol:z,minRow:d,maxRow:g})}const m=l("SupportedCRS",e).toLowerCase();k=W(e,m);a=k.spatialReference;d=p("TileMatrix",e);d=[parseInt(l("TileWidth",
d),10),parseInt(l("TileHeight",d),10)];const q=[];f.length?f.forEach((g,n)=>{g=y("TileMatrix","Identifier",g,e);q.push(N(g,m,n,c,h))}):v("TileMatrix",e).forEach((g,n)=>{q.push(N(g,m,n,c,h))});b=X(b,e,k,d,q[0]).toJSON();f=(new R({dpi:96,spatialReference:a,size:d,origin:k,lods:q})).toJSON();return{id:c,fullExtent:b,tileInfo:f}}function E(b){b=b.toLowerCase();let a=parseInt(b.split(":").pop(),10);if(900913===a||3857===a)a=102100;b=b.includes("crs84")||b.includes("crs:84")?A.CRS84:b.includes("crs83")||
b.includes("crs:83")?A.CRS83:b.includes("crs27")||b.includes("crs:27")?A.CRS27:null;H.isSome(b)&&(a=b);return{wkid:a}}function W(b,a){b=p("TileMatrix",b);return O(b,a)}function O(b,a){const d=E(a),[c,f]=l("TopLeftCorner",b).split(" ").map(e=>parseFloat(e));return a.includes("epsg")&&D.isAxesOrderReversedForWkid(d.wkid)?new J({x:f,y:c,spatialReference:d}):new J({x:c,y:f,spatialReference:d})}function X(b,a,d,c,f){var e=p("BoundingBox",a);if(e){var h=l("LowerCorner",e).split(" ");var k=l("UpperCorner",
e).split(" ")}h&&1<h.length&&k&&1<k.length?(a=parseFloat(h[0]),c=parseFloat(h[1]),h=parseFloat(k[0]),k=parseFloat(k[1])):(a=p("TileMatrix",a),h=parseInt(l("MatrixWidth",a),10),e=parseInt(l("MatrixHeight",a),10),a=d.x,k=d.y,h=a+h*c[0]*f.resolution,c=k-e*c[1]*f.resolution);return"1.0.0"!==b||!D.isAxesOrderReversedForWkid(d.spatialReference.wkid)||d.spatialReference.isGeographic&&-90>d.x&&-90<=d.y?new I(a,c,h,k,d.spatialReference):new I(c,a,k,h,d.spatialReference)}function N(b,a,d,c,f){var e=E(a);const h=
l("Identifier",b);let k=parseFloat(l("ScaleDenominator",b));c=P(e.wkid,k,c);k*=1.058267716535433;e=+l("MatrixWidth",b);const m=+l("MatrixHeight",b),{maxCol:q=e-1,maxRow:g=m-1,minCol:n=0,minRow:z=0}=f.get(h)??{},{x:F,y:r}=O(b,a);return{cols:[n,q],level:d,levelValue:h,origin:[F,r],scale:k,resolution:c,rows:[z,g]}}function P(b,a,d){b=C.hasOwnProperty(""+b)?C.values[C[b]]:"default028mm"===d?6370997*Math.PI/180:Q.getReferenceEllipsoidFromWKID(b).metersPerDegree;return 7*a/25E3/b}var A;(function(b){b[b.CRS84=
4326]="CRS84";b[b.CRS83=4269]="CRS83";b[b.CRS27=4267]="CRS27"})(A||(A={}));w.getTileUrlFromResourceUrls=function(b,a,d,c,f,e,h,k){c=M(b,a,c);if(!(0<c?.length))return"";const {dimensionMap:m}=b;b=m.get(a).dimensions?.[0];a=m.get(a).dimensions2?.[0];return c[h%c.length].template.replace(/\{Style\}/gi,f??"").replace(/\{TileMatrixSet\}/gi,d??"").replace(/\{TileMatrix\}/gi,e).replace(/\{TileRow\}/gi,""+h).replace(/\{TileCol\}/gi,""+k).replace(/\{dimensionValue\}/gi,b).replace(/\{dimensionValue2\}/gi,a)};
w.getTileUrlTemplateFromResourceUrls=function(b,a,d,c){const {dimensionMap:f}=b;b=L(b,a);let e="";if(b&&0<b.length){const h=f.get(a).dimensions&&f.get(a).dimensions[0];a=f.get(a).dimensions2&&f.get(a).dimensions2[0];e=b[0].template;e.indexOf(".xxx")===e.length-4&&(e=e.slice(0,e.length-4));e=e.replace(/\{Style\}/gi,c);e=e.replace(/\{TileMatrixSet\}/gi,d);e=e.replace(/\{TileMatrix\}/gi,"{level}");e=e.replace(/\{TileRow\}/gi,"{row}");e=e.replace(/\{TileCol\}/gi,"{col}");e=e.replace(/\{dimensionValue\}/gi,
h);e=e.replace(/\{dimensionValue2\}/gi,a)}return e};w.getTileUrlTemplates=M;w.parseCapabilities=function(b,a){b=b.replace(/ows:/gi,"");var d=(new DOMParser).parseFromString(b,"text/xml").documentElement;const c=new Map;b=new Map;var f=p("Contents",d);if(!f)throw new G("wmtslayer:wmts-capabilities-xml-is-not-valid");var e=p("OperationsMetadata",d)?.querySelector("[name\x3d'GetTile']")?.getElementsByTagName("Get");e=e&&Array.prototype.slice.call(e);const h=a.url?.indexOf("https"),k=void 0!==h&&-1<h;
let m=a.serviceMode,q,g=a?.url,n;e&&e.length&&e.some(r=>{const t=p("Constraint",r);if(!t||y("AllowedValues","Value",m,t))return g=r.attributes[0].nodeValue,!0;if(!t||y("AllowedValues","Value","RESTful",t)||y("AllowedValues","Value","REST",t))n=r.attributes[0].nodeValue;else if(!t||y("AllowedValues","Value","KVP",t))q=r.attributes[0].nodeValue;return!1});g||(n?(g=n,m="RESTful"):q?(g=q,m="KVP"):g=p("ServiceMetadataURL",d)?.getAttribute("xlink:href"));a=g.indexOf("1.0.0/");-1===a&&"RESTful"===m?g+="/":
-1<a&&(g=g.substring(0,a));"KVP"===m&&(g+=-1<a?"":"?");k&&(g=g.replace(/^http:/i,"https:"));const z=l("ServiceIdentification\x3eServiceTypeVersion",d);a=(a=l("ServiceIdentification\x3eAccessConstraints",d))&&/^none$/i.test(a)?null:a;d=v("Layer",f);const F=v("TileMatrixSet",f);f=d.map(r=>{const t=l("Identifier",r);c.set(t,r);const Y=l("Abstract",r),Z=x("Format",r);var u=p("WGS84BoundingBox",r);var B=u?l("LowerCorner",u).split(" "):["-180","-90"];u=u?l("UpperCorner",u).split(" "):["180","90"];B={xmin:parseFloat(B[0]),
ymin:parseFloat(B[1]),xmax:parseFloat(u[0]),ymax:parseFloat(u[1]),spatialReference:{wkid:4326}};u=S(r);const aa=T(r,k),ba=l("Title",r);r=U(z,r,F);return{id:t,fullExtent:B,fullExtents:u,description:Y,formats:Z,styles:aa,title:ba,tileMatrixSets:r}});return{copyright:a,dimensionMap:b,layerMap:c,layers:f,serviceMode:m,tileUrl:g}};w.parseResourceInfo=function(b){b.layers.forEach(a=>{a.tileMatrixSets?.forEach(d=>{const c=d.tileInfo;c&&96!==c.dpi&&(c.lods?.forEach(f=>{f.scale=96*f.scale/c.dpi;f.resolution=
P(c.spatialReference?.wkid,90.71428571428571*f.scale/96,d.id)}),c.dpi=96)})});return b};w.validateCapabilities=function(b){var a=b.replace(/ows:/gi,"");a=(new DOMParser).parseFromString(a,"text/xml").documentElement;if(!p("Contents",a))throw new G("wmtslayer:wmts-capabilities-xml-is-not-valid","the wmts get capabilities response is not compliant",{text:b});};Object.defineProperties(w,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});