// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../request ../core/Collection ../core/Error ../core/lang ../core/maybe ../core/MultiOriginJSONSupport ../core/object ../core/promiseUtils ../core/reactiveUtils ../core/urlUtils ../core/accessorSupport/decorators/property ../core/accessorSupport/ensureType ../core/accessorSupport/decorators/reader ../core/accessorSupport/decorators/subclass ../core/accessorSupport/decorators/writer ../geometry/Extent ./Layer ./WebTileLayer ./mixins/BlendLayer ./mixins/OperationalLayer ./mixins/PortalLayer ./mixins/RefreshableLayer ./mixins/ScaleRangeLayer ./support/TileInfo ./support/TileInfoTilemapCache ./support/WMTSLayerInfo ./support/WMTSSublayer ./support/wmtsUtils".split(" "),
function(l,f,v,B,x,y,C,e,D,z,m,w,h,T,q,E,F,G,H,I,J,K,L,M,N,O,P,Q,r,n){function R(u,p){return u.map(g=>{const a=new r;a.read(g,p);return a})}const A={"image/png":".png","image/png8":".png","image/png24":".png","image/png32":".png","image/jpg":".jpg","image/jpeg":".jpeg","image/gif":".gif","image/bmp":".bmp","image/tiff":".tif","image/jpgpng":"","image/jpegpng":"","image/unknown":""},S=new Set("version service request layer style format tilematrixset tilematrix tilerow tilecol".split(" "));e=function(u){function p(...a){var b=
u.call(this,...a)||this;b.copyright="";b.customParameters=null;b.customLayerParameters=null;b.fullExtent=null;b.operationalLayerType="WebTiledLayer";b.resourceInfo=null;b.serviceMode="RESTful";b.sublayers=null;b.type="wmts";b.version="1.0.0";b.addHandles([m.watch(()=>b.activeLayer,(c,d)=>{d&&(d.layer=null);c&&(c.layer=l._assertThisInitialized(b))},m.sync),m.on(()=>b.sublayers,"after-add",({item:c})=>{c.layer=l._assertThisInitialized(b)},m.sync),m.on(()=>b.sublayers,"after-remove",({item:c})=>{c.layer=
null},m.sync),m.watch(()=>b.sublayers,(c,d)=>{if(d)for(const k of d)k.layer=null;if(c)for(const k of c)k.layer=l._assertThisInitialized(b)},m.sync)]);return b}l._inheritsLoose(p,u);var g=p.prototype;g.normalizeCtorArgs=function(a,b){return"string"===typeof a?{url:a,...b}:a};g.load=function(a){if("KVP"!==this.serviceMode&&"RESTful"!==this.serviceMode)console.error("WMTS mode could only be 'KVP' or 'RESTful'");else return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["WMTS"]},a).catch(z.throwIfAbortError).then(()=>
this._fetchService(a)).catch(b=>{z.throwIfAbortError(b);throw new x("wmtslayer:unsupported-service-data","Invalid response from the WMTS service.",{error:b});})),Promise.resolve(this)};g.readActiveLayerFromService=function(a,b,c){this.activeLayer||(this.activeLayer=new r);(a=b.layers.find(d=>d.id===this.activeLayer.id))||(a=b.layers[0]);this.activeLayer.read(a,c);return this.activeLayer};g.readActiveLayerFromItemOrWebDoc=function(a,b){const {templateUrl:c,wmtsInfo:d}=b;a=c?this._getLowerCasedUrlParams(c):
null;b=d?.layerIdentifier;let k=null;const t=d?.tileMatrixSet;t&&(Array.isArray(t)?t.length&&(k=t[0]):k=t);return new r({id:b,imageFormat:a?.format,styleId:a?.style,tileMatrixSetId:k})};g.writeActiveLayer=function(a,b,c,d){a=this.activeLayer;b.templateUrl=this.getUrlTemplate(a.id,a.tileMatrixSetId,a.imageFormat,a.styleId);c=D.getDeepValue("tileMatrixSet.tileInfo",a);b.tileInfo=c?c.toJSON(d):null;b.wmtsInfo={...b.wmtsInfo,layerIdentifier:a.id,tileMatrixSet:a.tileMatrixSetId}};g.readCustomParameters=
function(a,b){return(a=b.wmtsInfo)?this._mergeParams(a.customParameters,a.url):null};g.readServiceMode=function(a,b){return b.templateUrl.includes("?")?"KVP":"RESTful"};g.readSublayersFromService=function(a,b,c){return R(b.layers,c)};g.createWebTileLayer=function(a){const b=this.getUrlTemplate(this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId),c=this._getTileMatrixSetById(a.tileMatrixSetId)?.tileInfo,d=a.fullExtent;a=new Q.WMTSLayerInfo({layerIdentifier:a.id,
tileMatrixSet:a.tileMatrixSetId,url:this.url});this.customLayerParameters&&(a.customLayerParameters=this.customLayerParameters);this.customParameters&&(a.customParameters=this.customParameters);return new I({fullExtent:d,urlTemplate:b,tileInfo:c,wmtsInfo:a})};g.fetchTile=function(a,b,c){a=this.getTileUrl(a,b,c);return v(a,{responseType:"image"}).then(d=>d.data)};g.fetchImageBitmapTile=function(){var a=l._asyncToGenerator(function*(b,c,d){b=this.getTileUrl(b,c,d);({data:b}=yield v(b,{responseType:"blob"}));
return createImageBitmap(b)});return function(b,c,d){return a.apply(this,arguments)}}();g.findSublayerById=function(a){return this.sublayers?.find(b=>b.id===a)};g.getTileUrl=function(a,b,c){var d=this._getTileMatrixSetById(this.activeLayer.tileMatrixSetId)?.tileInfo?.lods[a];a=d?d.levelValue?d.levelValue:`${d.level}`:`${a}`;(d=this.resourceInfo?"":n.getTileUrlFromResourceUrls({dimensionMap:this.dimensionMap,layerMap:this.layerMap},this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,
this.activeLayer.styleId,a,b,c))||(d=this.getUrlTemplate(this.activeLayer.id,this.activeLayer.tileMatrixSetId,this.activeLayer.imageFormat,this.activeLayer.styleId).replace(/\{level\}/gi,a).replace(/\{row\}/gi,`${b}`).replace(/\{col\}/gi,`${c}`));return d=this._appendCustomLayerParameters(d)};g.getUrlTemplate=function(a,b,c,d){if(!this.resourceInfo){var k=n.getTileUrlTemplateFromResourceUrls({dimensionMap:this.dimensionMap,layerMap:this.layerMap},a,b,d);if(k)return k}return"KVP"===this.serviceMode?
this.url+"?SERVICE\x3dWMTS\x26VERSION\x3d"+this.version+"\x26REQUEST\x3dGetTile\x26LAYER\x3d"+a+"\x26STYLE\x3d"+d+"\x26FORMAT\x3d"+c+"\x26TILEMATRIXSET\x3d"+b+"\x26TILEMATRIX\x3d{level}\x26TILEROW\x3d{row}\x26TILECOL\x3d{col}":"RESTful"===this.serviceMode?(k="",A[c.toLowerCase()]&&(k=A[c.toLowerCase()]),this.url+a+"/"+d+"/"+b+"/{level}/{row}/{col}"+k):""};g._fetchService=function(){var a=l._asyncToGenerator(function*(b){let c;if(this.resourceInfo)"KVP"===this.resourceInfo.serviceMode&&(this.url+=
this.url.includes("?")?"":"?"),c={ssl:!1,data:this.resourceInfo};else try{c=yield this._getCapabilities(this.serviceMode,b),n.validateCapabilities(c.data)}catch{const d="KVP"===this.serviceMode?"RESTful":"KVP";try{c=yield this._getCapabilities(d,b),n.validateCapabilities(c.data),this.serviceMode=d}catch(k){throw new x("wmtslayer:unsupported-service-data","Services does not support RESTful or KVP service modes.",{error:k});}}c.data=this.resourceInfo?n.parseResourceInfo(c.data):n.parseCapabilities(c.data,
{serviceMode:this.serviceMode,url:this.url});c.data&&this.read(c.data,{origin:"service"})});return function(b){return a.apply(this,arguments)}}();g._getCapabilities=function(){var a=l._asyncToGenerator(function*(b,c){b=this._getCapabilitiesUrl(b);return yield v(b,{...c,responseType:"text"})});return function(b,c){return a.apply(this,arguments)}}();g._getTileMatrixSetById=function(a){return this.findSublayerById(this.activeLayer.id)?.tileMatrixSets?.find(b=>b.id===a)};g._appendCustomParameters=function(a){return this._appendParameters(a,
this.customParameters)};g._appendCustomLayerParameters=function(a){return this._appendParameters(a,{...y.clone(this.customParameters),...this.customLayerParameters})};g._appendParameters=function(a,b){a=w.urlToObject(a);b=w.objectToQuery({...a.query,...b});return""===b?a.path:`${a.path}?${b}`};g._getCapabilitiesUrl=function(a){this.url=this.url.split("?")[0];return this._appendCustomParameters("KVP"===a?`${this.url}?request=GetCapabilities&service=WMTS&version=${this.version}`:`${this.url}/${this.version}/WMTSCapabilities.xml`)};
g._getLowerCasedUrlParams=function(a){if(!a)return null;const b=w.urlToObject(a).query;if(!b)return null;const c={};Object.keys(b).forEach(d=>{c[d.toLowerCase()]=b[d]});return c};g._mergeParams=function(a,b){const c=this._getLowerCasedUrlParams(b);c&&(b=Object.keys(c),b.length&&(a=a?y.clone(a):{},b.forEach(d=>{a.hasOwnProperty(d)||S.has(d)||(a[d]=c[d])})));return a};l._createClass(p,[{key:"activeLayer",get:function(){return this._get("activeLayer")},set:function(a){this._set("activeLayer",a)}},{key:"fullExtents",
get:function(){return this.activeLayer.fullExtents}},{key:"supportedSpatialReferences",get:function(){return this.activeLayer.tileMatrixSets?.map(a=>a.tileInfo?.spatialReference).toArray().filter(C.isSome)??[]}},{key:"tilemapCache",get:function(){const a=this.activeLayer?.tileMatrixSet?.tileInfo;return a?new P(a):void 0}},{key:"title",get:function(){return this.activeLayer?.title??"Layer"},set:function(a){this._overrideIfSome("title",a)}},{key:"url",get:function(){return this._get("url")},set:function(a){a&&
"/"===a.substr(-1)?this._set("url",a.slice(0,-1)):this._set("url",a)}}]);return p}(J.BlendLayer(M.RefreshableLayer(N.ScaleRangeLayer(K.OperationalLayer(L.PortalLayer(e.MultiOriginJSONMixin(H)))))));f.__decorate([h.property()],e.prototype,"dimensionMap",void 0);f.__decorate([h.property()],e.prototype,"layerMap",void 0);f.__decorate([h.property({type:r,json:{origins:{"web-document":{write:{ignoreOrigin:!0}}}}})],e.prototype,"activeLayer",null);f.__decorate([q.reader("service","activeLayer",["layers"])],
e.prototype,"readActiveLayerFromService",null);f.__decorate([q.reader(["web-document","portal-item"],"activeLayer",["wmtsInfo"])],e.prototype,"readActiveLayerFromItemOrWebDoc",null);f.__decorate([F.writer(["web-document","portal-item"],"activeLayer",{templateUrl:{type:String},tileInfo:{type:O},"wmtsInfo.layerIdentifier":{type:String},"wmtsInfo.tileMatrixSet":{type:String}})],e.prototype,"writeActiveLayer",null);f.__decorate([h.property({type:String,value:"",json:{write:!0}})],e.prototype,"copyright",
void 0);f.__decorate([h.property({type:["show","hide"]})],e.prototype,"listMode",void 0);f.__decorate([h.property({json:{read:!0,write:!0}})],e.prototype,"blendMode",void 0);f.__decorate([h.property({json:{origins:{"web-document":{read:{source:["wmtsInfo.customParameters","wmtsInfo.url"]},write:{target:"wmtsInfo.customParameters"}},"portal-item":{read:{source:["wmtsInfo.customParameters","wmtsInfo.url"]},write:{target:"wmtsInfo.customParameters"}}}}})],e.prototype,"customParameters",void 0);f.__decorate([q.reader(["portal-item",
"web-document"],"customParameters")],e.prototype,"readCustomParameters",null);f.__decorate([h.property({json:{origins:{"web-document":{read:{source:"wmtsInfo.customLayerParameters"},write:{target:"wmtsInfo.customLayerParameters"}},"portal-item":{read:{source:"wmtsInfo.customLayerParameters"},write:{target:"wmtsInfo.customLayerParameters"}}}}})],e.prototype,"customLayerParameters",void 0);f.__decorate([h.property({type:G,json:{write:{ignoreOrigin:!0},origins:{"web-document":{read:{source:"fullExtent"}},
"portal-item":{read:{source:"fullExtent"}}}}})],e.prototype,"fullExtent",void 0);f.__decorate([h.property({readOnly:!0})],e.prototype,"fullExtents",null);f.__decorate([h.property({type:["WebTiledLayer"]})],e.prototype,"operationalLayerType",void 0);f.__decorate([h.property()],e.prototype,"resourceInfo",void 0);f.__decorate([h.property()],e.prototype,"serviceMode",void 0);f.__decorate([q.reader(["portal-item","web-document"],"serviceMode",["templateUrl"])],e.prototype,"readServiceMode",null);f.__decorate([h.property({type:B.ofType(r)})],
e.prototype,"sublayers",void 0);f.__decorate([q.reader("service","sublayers",["layers"])],e.prototype,"readSublayersFromService",null);f.__decorate([h.property({readOnly:!0})],e.prototype,"supportedSpatialReferences",null);f.__decorate([h.property({readOnly:!0})],e.prototype,"tilemapCache",null);f.__decorate([h.property({json:{read:{source:"title"}}})],e.prototype,"title",null);f.__decorate([h.property({json:{read:!1},readOnly:!0,value:"wmts"})],e.prototype,"type",void 0);f.__decorate([h.property({json:{origins:{service:{read:{source:"tileUrl"}},
"web-document":{read:{source:"wmtsInfo.url"},write:{target:"wmtsInfo.url"}},"portal-item":{read:{source:"wmtsInfo.url"},write:{target:"wmtsInfo.url"}}}}})],e.prototype,"url",null);f.__decorate([h.property()],e.prototype,"version",void 0);return e=f.__decorate([E.subclass("esri.layers.WMTSLayer")],e)});