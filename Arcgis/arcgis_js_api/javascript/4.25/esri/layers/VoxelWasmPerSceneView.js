// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../chunks/_rollupPluginBabelHelpers ../request ../core/has ../core/Logger ../core/maybe ../core/promiseUtils ../core/reactiveUtils ../geometry/support/coordinateSystem ../geometry/support/frustum ../libs/vxl/enums ../libs/vxl/VxlModule ../views/ViewingMode ../views/3d/state/Frustum ../views/3d/support/RenderCoordsHelper ../views/3d/webgl-engine/core/shaderLibrary/ShaderOutput ../views/3d/webgl-engine/lib/RenderSlot ../views/webgl/context-util ../views/webgl/enums".split(" "),function(D,E,
C,F,y,G,B,H,t,q,I,J,K,L,M,N,O,v){const z=F.getLogger("esri.layers.VoxelWasmPerSceneView");var g;(function(u){u[u.Lifetime=1]="Lifetime";u[u.RequestResponse=2]="RequestResponse";u[u.Rendering=3]="Rendering";u[u.Error=4]="Error"})(g||(g={}));return function(){function u(a){this._havePreparedWithAllLayers=this._textureFloatLinearAvailable=this._halfIntTexturesAvailable=!1;this._vxl=this._renderPluginContext=null;this._moreToLoad=this._pluginIsActive=!1;this._viewportHeight=this._viewportWidth=-1;this._newLayers=
[];this._layers=new Map;this._shaderOutput=M.ShaderOutput.Color;this._renderSlot=N.RenderSlot.VOXEL;this._renderTargetToRestore=this._rctx=null;this._lastFrameWasStationary=!1;this._wasmMemBlockSizes=[512,1024,2048,4096,8192,16384,32768,65536];this._wasmMemBlocks=new Map;this._dbgFlags=new Set;this._captureFrustum=!1;this._frustum=null;this._frustumRenderableId=-1;this._renderCoordsHelper=null;this._view=a;this._initialize()}var e=u.prototype;e._dbg=function(a,b){this._dbgFlags.has(a)&&(a===g.Error?
z.error(b):z.warn(b))};e._removeRenderPlugin=function(){this._pluginIsActive&&this._view._stage&&(this._dbg(g.Lifetime,"--removeRenderPlugin--"),this._view._stage.removeRenderPlugin(this));this._pluginIsActive=!1};e._initialize=function(){this._dbg(g.Lifetime,"--initialize--");for(const a of this._wasmMemBlockSizes)this._wasmMemBlocks.set(a,0);this._readyWatchHandle=B.watch(()=>this._view.ready,a=>{a&&"local"===this._view.viewingMode?(this._dbg(g.Lifetime,"view ready status changed to ready on a local view, calling addRenderPlugin"),
this._view._stage.addRenderPlugin([this._renderSlot],this),this._pluginIsActive=!0):(this._dbg(g.Lifetime,"view ready status changed, not ready or not a local view!"),this._removeRenderPlugin())},{initial:!0});this._qualityWatchHandle=B.watch(()=>this._view?.qualityProfile,a=>{this._dbg(g.Rendering,"qualityProfile changed to "+a);this._vxl&&this._vxl.set_quality(this._toWasmQuality(a))},{initial:!0});this._timeExtentWatchHandle=B.watch(()=>this._view?.timeExtent,()=>{if(this._vxl){const a=this._getTimeArgs(this._view?.timeExtent);
this._dbg(g.Rendering,"sceneView timeExtent changed to useTime\x3d"+a.useTime+" st\x3d"+a.startTime+" et\x3d"+a.endTime);this._vxl.set_scene_time_extent(a.startTime,a.endTime,a.useTime);this._renderPluginContext.requestRender()}},{initial:!0});this._stationaryWatchHandle=B.watch(()=>this._view?.stationary,a=>{this._vxl&&a&&!this._lastFrameWasStationary&&this._renderPluginContext.requestRender()})};e.initializeRenderContext=function(a){this._dbg(g.Lifetime,"--initializeRenderContext--");const b=a.renderContext.rctx;
b.type===O.ContextType.WEBGL2?(this._renderPluginContext=a,this._rctx=a.renderContext.rctx,this._halfIntTexturesAvailable=!!this._rctx.capabilities.textureNorm16,this._textureFloatLinearAvailable=this._rctx.capabilities.textureFloatLinear,this._initializeWasm(b.gl)):this._dbg(g.Error,"WebGL 1 context only!")};e.uninitializeRenderContext=function(){this._rctx=this._renderPluginContext=null;this._dbg(g.Lifetime,"--uninitializeRenderContext--")};e._restoreFramebuffer=function(){if(this._renderTargetToRestore){var a=
this._renderTargetToRestore.fbo;this._rctx?(this._rctx.bindFramebuffer(a,!0),a=this._renderTargetToRestore.viewport,this._rctx.setViewport(a.x,a.y,a.width,a.height)):this._dbg(g.Error,"no context in restoreFramebuffer!")}};e._bindPreviousDepthToSlot=function(a,b){var c=!!this._renderTargetToRestore;if(!this._rctx||!c)return 0;c=this._renderTargetToRestore.fbo.depthStencilTexture;if(!c)return this._dbg(g.Error,"no depth/stencil texture exists!"),0;0===b?this._rctx.bindTexture(null,a,!0):this._rctx.bindTexture(c,
a,!0);return 1};e._modifyResourceCount=function(a,b,c){this._rctx?1===c?this._rctx.instanceCounter.increment(a,b):this._rctx.instanceCounter.decrement(a,b):this._dbg(g.Error,"modifyAllocation callback has no rendering context!")};e._setBlendState=function(a,b,c,d){this._rctx?(this._rctx.setBlendingEnabled(1===a),this._rctx.setBlendFunction(b,c),this._rctx.setBlendEquation(d)):this._dbg(g.Error,"setBlendState callback has no rendering context!")};e._setFrontFace=function(a){this._rctx?this._rctx.setFrontFace(a):
this._dbg(g.Error,"setFrontFace callback has no rendering context!")};e._setDepthStencilStateFunction=function(a,b,c){this._rctx?(this._rctx.setDepthFunction(c),this._rctx.setDepthTestEnabled(1===a),this._rctx.setDepthWriteEnabled(1===b),this._rctx.setStencilTestEnabled(!1),this._rctx.setStencilFunction(v.CompareFunction.ALWAYS,0,255),this._rctx.setStencilOpSeparate(v.Face.FRONT,v.StencilOperation.KEEP,v.StencilOperation.INCR,v.StencilOperation.KEEP),this._rctx.setStencilOpSeparate(v.Face.BACK,v.StencilOperation.KEEP,
v.StencilOperation.DECR,v.StencilOperation.KEEP)):this._dbg(g.Error,"setDepthStencilStateFunction callback has no rendering context!")};e._setRasterizerState=function(a){if(this._rctx)switch(a){case q.WasmCullMode.None:this._rctx.setFaceCullingEnabled(!1);break;case q.WasmCullMode.Back:this._rctx.setCullFace(v.Face.BACK);this._rctx.setFaceCullingEnabled(!0);break;case q.WasmCullMode.Front:this._rctx.setCullFace(v.Face.FRONT),this._rctx.setFaceCullingEnabled(!0)}else this._dbg(g.Error,"setRasterizerState callback has no rendering context!")};
e._setViewport=function(a,b,c,d){this._rctx?this._rctx.setViewport(a,b,c,d):this._dbg(g.Error,"setViewport callback has no rendering context!")};e._updateMemoryUsage=function(){this._layers.forEach((a,b)=>{a.needMemoryUsageUpdate&&(b=this._vxl.estimate_memory_usage(b),0<=b&&(a.needMemoryUsageUpdate=!1,a.layerView.setUsedMemory(b)))})};e._syncRequestsResponses=function(){this._layers.forEach((a,b)=>{const c=[];a.responses.forEach((k,p)=>{c.push(p);this._dbg(g.RequestResponse,"responding for requestID:"+
p+" size:"+k.size);this._vxl.respond(b,p,k);if(k.requestType===q.VoxelRequestType.TreeIndex||k.requestType===q.VoxelRequestType.Section)a.needMemoryUsageUpdate=!0});const d=a.responses;for(var f of c)d.delete(f);f=this._vxl.get_new_requests(b);const m=a.abortController.signal;for(const k in f){a.outstandingRequestCount+=1;1===a.outstandingRequestCount&&a.layerView.updatingFlagChanged();const p=f[k],x={responseType:"array-buffer",signal:m};this._dbg(g.RequestResponse,"making requestID:"+k+" url:"+
p.url);E(p.url,x).then(r=>{--a.outstandingRequestCount;0===a.outstandingRequestCount&&a.layerView.updatingFlagChanged();this._dbg(g.RequestResponse,"have response for requestID:"+k);let w=0;if(0<r.data.byteLength){w=this._vxl._malloc(r.data.byteLength);const A=new Uint8Array(this._vxl.HEAPU8.buffer,w,r.data.byteLength),h=new Uint8Array(r.data);for(let n=0;n<r.data.byteLength;++n)A[n]=h[n]}d.set(+k,{responseType:p.responseType,ptr:w,size:r.data.byteLength,success:!0,requestType:p.requestType})}).catch(r=>
{--a.outstandingRequestCount;0===a.outstandingRequestCount&&a.layerView.updatingFlagChanged();G.isAbortError(r)||(this._dbg(g.Error,`requestID:${k} failed, error=${r.toString()}`),d.set(+k,{responseType:p.responseType,ptr:0,size:0,success:!1,requestType:p.requestType}))})}})};e.updateWasmCamera=function(a){this._vxl.set_projection_matrix.apply(this._vxl,a.projectionMatrix);this._vxl.set_view_matrix.apply(this._vxl,a.viewMatrix);this._vxl.set_near_far(a.near,a.far)};e.isUpdating=function(a){return!this._vxl&&
this._vxlPromise?!0:this._layers.has(a)?0<this._layers.get(a).outstandingRequestCount:!1};e.getLayerTimes=function(a){const b=[];this._layers.forEach((c,d)=>{if(c.layerView.wasmLayerId===a.wasmLayerId)for(c=this._vxl.get_layer_epoch_times(d,a.layer.currentVariableId),d=0;d<c.length;++d)b.push(c[d])});return b};e.getCurrentLayerTimeIndex=function(a){let b=0;this._layers.forEach((c,d)=>{c.layerView.wasmLayerId===a.wasmLayerId&&(b=this._vxl.get_layer_current_time_id(d))});return b};e.setEnabled=function(a,
b){this._layers.forEach((c,d)=>{c.layerView.wasmLayerId===a.wasmLayerId&&(this._vxl.set_enabled(d,b),c.needMemoryUsageUpdate=!0,this._renderPluginContext.requestRender())})};e.setStaticSections=function(a,b){return this._doMaskedUIUpdate(a,{mask:q.UpdateFlags.StaticSections,staticSections:b},!0)};e.setCurrentVariable=function(a,b){return this._doMaskedUIUpdate(a,{mask:q.UpdateFlags.CurrentVariable,currentVariable:b},!0)};e.setRenderMode=function(a,b){return this._doMaskedUIUpdate(a,{mask:q.UpdateFlags.RenderMode,
renderMode:b},!0)};e.setVerticalExaggerationAndOffset=function(a,b,c,d){return this._doMaskedUIUpdate(a,{mask:q.UpdateFlags.ExaggerationAndOffset,volStyleDesc:{volumeId:b,verticalExaggeration:c,verticalOffset:d}},!0)};e.setVariableStyles=function(a,b){return this._doMaskedUIUpdate(a,{mask:q.UpdateFlags.VariableStyles,variableStyles:b},!0)};e.setVolumeStyles=function(a,b){return this._doMaskedUIUpdate(a,{mask:q.UpdateFlags.VolumeStyles,volumeStyles:b},!0)};e.setEnableDynamicSections=function(a,b){return this._doMaskedUIUpdate(a,
{mask:q.UpdateFlags.ContainerVisibility,containerIsVisible:b,container:q.ContainerType.DynamicSections},!0)};e.setEnableIsosurfaces=function(a,b){return this._doMaskedUIUpdate(a,{mask:q.UpdateFlags.ContainerVisibility,containerIsVisible:b,container:q.ContainerType.Isosurfaces},!0)};e.setEnableSections=function(a,b){return this._doMaskedUIUpdate(a,{mask:q.UpdateFlags.ContainerVisibility,containerIsVisible:b,container:q.ContainerType.StaticSections},!0)};e._doMaskedUIUpdate=function(a,b,c){if(!this._vxl)return!1;
let d=!1;this._layers.forEach((f,m)=>{f.layerView.wasmLayerId===a.wasmLayerId&&(f={str:JSON.stringify(b),byteCount:0,ptr:0,isReusable:!1},this._allocateBlock(f)&&(d=1===this._vxl.handle_masked_ui_update(m,f.ptr,f.byteCount)?!0:!1,f.isReusable||this._vxl._free(f.ptr)))});d&&c&&this._renderPluginContext.requestRender();return d};e._addTriangleToWasmBuffer=function(a,b,c,d,f){a[3*b]=c[0];a[3*b+1]=c[1];a[3*b+2]=c[2];b+=1;a[3*b]=d[0];a[3*b+1]=d[1];a[3*b+2]=d[2];b+=1;a[3*b]=f[0];a[3*b+1]=f[1];a[3*b+2]=
f[2];return b+1};e._addNormalToWasmBuffer=function(a,b,c){a[3*b]=c[0];a[3*b+1]=c[1];a[3*b+2]=c[2];return b+1};e._doCaptureFrustum=function(){if(this._vxl){var a=this._vxl._malloc(108*Float32Array.BYTES_PER_ELEMENT),b=new Float32Array(this._vxl.HEAPF32.buffer,a,108),c=this._vxl._malloc(36*Float32Array.BYTES_PER_ELEMENT),d=new Float32Array(this._vxl.HEAPF32.buffer,c,36),f=this._frustum.points[t.PointIndex.NEAR_BOTTOM_LEFT],m=this._frustum.points[t.PointIndex.NEAR_BOTTOM_RIGHT],k=this._frustum.points[t.PointIndex.NEAR_TOP_RIGHT],
p=this._frustum.points[t.PointIndex.NEAR_TOP_LEFT],x=this._frustum.points[t.PointIndex.FAR_BOTTOM_LEFT],r=this._frustum.points[t.PointIndex.FAR_BOTTOM_RIGHT],w=this._frustum.points[t.PointIndex.FAR_TOP_RIGHT],A=this._frustum.points[t.PointIndex.FAR_TOP_LEFT],h=0,n=this._frustum.planes[t.PlaneIndex.NEAR];var l=this._addTriangleToWasmBuffer(b,0,k,m,f);h=this._addNormalToWasmBuffer(d,h,n);l=this._addTriangleToWasmBuffer(b,l,f,p,k);h=this._addNormalToWasmBuffer(d,h,n);n=this._frustum.planes[t.PlaneIndex.FAR];
l=this._addTriangleToWasmBuffer(b,l,x,r,w);h=this._addNormalToWasmBuffer(d,h,n);l=this._addTriangleToWasmBuffer(b,l,w,A,x);h=this._addNormalToWasmBuffer(d,h,n);n=this._frustum.planes[t.PlaneIndex.TOP];l=this._addTriangleToWasmBuffer(b,l,w,k,p);h=this._addNormalToWasmBuffer(d,h,n);l=this._addTriangleToWasmBuffer(b,l,p,A,w);h=this._addNormalToWasmBuffer(d,h,n);n=this._frustum.planes[t.PlaneIndex.BOTTOM];l=this._addTriangleToWasmBuffer(b,l,f,m,r);h=this._addNormalToWasmBuffer(d,h,n);l=this._addTriangleToWasmBuffer(b,
l,r,x,f);h=this._addNormalToWasmBuffer(d,h,n);n=this._frustum.planes[t.PlaneIndex.LEFT];l=this._addTriangleToWasmBuffer(b,l,p,f,x);h=this._addNormalToWasmBuffer(d,h,n);l=this._addTriangleToWasmBuffer(b,l,x,A,p);h=this._addNormalToWasmBuffer(d,h,n);f=this._frustum.planes[t.PlaneIndex.RIGHT];l=this._addTriangleToWasmBuffer(b,l,k,w,r);h=this._addNormalToWasmBuffer(d,h,f);l=this._addTriangleToWasmBuffer(b,l,r,m,k);h=this._addNormalToWasmBuffer(d,h,f);-1!==this._frustumRenderableId&&this._vxl.remove_generic_mesh(this._frustumRenderableId);
this._frustumRenderableId=this._vxl.add_generic_mesh(a,108,c,36,255,0,0,64);this._vxl._free(a);this._vxl._free(c);this._captureFrustum=!1;this._renderPluginContext.requestRender()}};e.captureFrustum=function(){null===this._renderCoordsHelper&&(this._renderCoordsHelper=L.RenderCoordsHelper.create(J.ViewingMode.Local,H.renderSRFromViewSR(!1,this._view.spatialReference)));null===this._frustum&&(this._frustum=new K.Frustum(this._renderCoordsHelper));this._captureFrustum=!0;null!==this._renderPluginContext&&
this._renderPluginContext.requestRender()};e.toggleFullVolumeExtentDraw=function(a){this._vxl&&this._layers.forEach((b,c)=>{b.layerView.wasmLayerId===a.wasmLayerId&&(this._vxl.toggle_full_volume_extent_draw(c),this._renderPluginContext.requestRender())})};e.addVoxelLayer=function(a){if(!this._vxl){const b={layerView:a,resolveCallback:null,rejectCallback:null};a=new Promise((c,d)=>{b.resolveCallback=c;b.rejectCallback=d});this._newLayers.push(b);return a}a=this._addVoxelLayer(a);return 0>a?Promise.reject(-1):
Promise.resolve(a)};e.removeVoxelLayer=function(a){if(!this._vxl){var b=this._newLayers.findIndex(d=>a.uid===d.layerView.uid);0<=b&&(this._newLayers[b].resolveCallback(-1),this._newLayers.splice(b,1));b=this._newLayers.length;0===b&&(this._dbg(g.Lifetime," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy());return b}let c=-1;this._layers.forEach((d,f)=>{d.layerView.wasmLayerId===a.wasmLayerId&&(c=f,d.abortController.abort(),this._vxl.remove_layer(c))});
0<=c&&this._layers.delete(c);b=this._layers.size;0===b&&(this._dbg(g.Lifetime," no voxel layers left after removing a layer, removing RenderPlugin and destroying"),this.destroy());return b};e._getBlockSize=function(a){for(const b of this._wasmMemBlockSizes)if(a<b)return b;return-1};e._allocateBlock=function(a){a.byteCount=this._vxl.lengthBytesUTF8(a.str)+1;const b=this._getBlockSize(a.byteCount);0>b?(a.isReusable=!1,a.ptr=this._vxl._malloc(a.byteCount)):(a.isReusable=!0,a.ptr=this._wasmMemBlocks.get(b),
0===a.ptr&&(a.ptr=this._vxl._malloc(b),this._wasmMemBlocks.set(b,a.ptr)));return 0!==a.ptr?(this._vxl.stringToUTF8(a.str,a.ptr,a.byteCount),!0):!1};e._getTimeArgs=function(a){let b=-Number.MAX_VALUE,c=Number.MAX_VALUE,d=!1;y.isSome(a)&&(a.isAllTime?d=!0:(y.isSome(a.start)&&(d=!0,b=a.start.getTime()/1E3),y.isSome(a.end)&&(d=!0,c=a.end.getTime()/1E3)));return{startTime:b,endTime:c,useTime:d}};e._addVoxelLayer=function(a){var b=a.layer,c=-1;c=b.getConfiguration();if(1>c.length)return-1;var d={str:c,
byteCount:0,ptr:0,isReusable:!1};if(!this._allocateBlock(d))return-1;c=this._getTimeArgs(this._view?.timeExtent);const f=this._view.spatialReference.isWGS84&&b.spatialReference.isWGS84?111319.49079327357:1;c=this._vxl.add_layer(b.serviceRoot,d.ptr,d.byteCount,f,f,c.startTime,c.endTime,c.useTime,this._toWasmQuality(this._view.qualityProfile));d.isReusable||this._vxl._free(d.ptr);if(0<=c){b=new AbortController;this._layers.set(c,{layerView:a,responses:new Map,outstandingRequestCount:0,abortController:b,
needMemoryUsageUpdate:!1});if(!this._halfIntTexturesAvailable||C("mac")){b=[];d="";for(var m of a.layer.variables)if("Int16"===m.renderingFormat.type||"UInt16"===m.renderingFormat.type)b.push(m.name),m.id===a.layer.currentVariableId&&(d=m.name);""!==d&&z.error("#addVoxelLayer_error()",a.layer,`The voxel layer '${a.layer.title}' cannot render the current variable '${d}' in this browser`);0<b.length&&z.warn("#addVoxelLayer_warning()",a.layer,`The voxel layer '${a.layer.title}' cannot render the variables '${b.toString()}' in this browser`)}if(!this._textureFloatLinearAvailable){m=
[];b="";for(const k of a.layer.variables)"Float32"===k.renderingFormat.type&&(m.push(k.name),k.id===a.layer.currentVariableId&&(b=k.name));""!==b&&z.error("#addVoxelLayer_error()",a.layer,`The voxel layer '${a.layer.title}' cannot render the current variable '${b}' in this browser`);0<m.length&&z.warn("#addVoxelLayer_warning()",a.layer,`The voxel layer '${a.layer.title}' cannot render the variables '${m.toString()}' in this browser`)}C("esri-mobile")&&z.warnOnce("Mobile support differs across devices. Voxel layer might not display as expected.");
return c}return-1};e.prepareRender=function(a){if(this._vxl){var b=a.bindParameters.camera.viewForward;a=a.bindParameters.camera.eye;this._vxl.update_camera_pos_and_direction(a[0],a[1],a[2],b[0],b[1],b[2]);b=this._vxl.cull();this._dbg(g.RequestResponse,"missingResourceCount\x3d"+b);this._moreToLoad=0<b;this._havePreparedWithAllLayers=0===this._newLayers.length;this._updateMemoryUsage()}};e.render=function(a){if(this._vxl&&a.output===this._shaderOutput&&a.bindParameters.slot===this._renderSlot){for(var b of this._newLayers){const c=
this._addVoxelLayer(b.layerView);-1===c?b.rejectCallback(-1):b.resolveCallback(c)}this._newLayers=[];if(0===this._layers.size)this._dbg(g.Error,"No voxel layers but RenderPlugin instance is being asked to render!");else{this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()};this._syncRequestsResponses();this._lastFrameWasStationary=this._view.stationary;this._rctx.setPolygonOffsetFillEnabled(!1);this._rctx.setScissorTestEnabled(!1);this._rctx.setColorMask(!0,
!0,!0,!0);this._vxl.begin_color_frame(!this._view.stationary||this._moreToLoad,a.bindParameters.lighting.mainLight.direction[0],a.bindParameters.lighting.mainLight.direction[1],a.bindParameters.lighting.mainLight.direction[2]);b=this._renderTargetToRestore.viewport;if(b.width!==this._viewportWidth||b.height!==this._viewportHeight)this._viewportWidth=b.width,this._viewportHeight=b.height,this._vxl.set_viewport(b.width,b.height),this._layers.forEach(c=>{c.needMemoryUsageUpdate=!0});0===b.x&&0===b.y||
this._dbg(g.Error,"Unsupported viewport parameters detected!");this.updateWasmCamera(a.bindParameters.camera);this._captureFrustum&&(this._frustum.update(a.bindParameters.camera),this._doCaptureFrustum());this._vxl.draw();this._renderTargetToRestore.fbo=null;a.rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),this._vxl.get_active_texture_unit());a.rctx.externalVertexArrayObjectUpdate();a.rctx.externalVertexBufferUpdate();this._rctx.externalProgramUpdate();(this._moreToLoad||
!this._havePreparedWithAllLayers&&0<this._layers.size)&&this._renderPluginContext.requestRender()}}};e.destroy=function(){this._dbg(g.Lifetime,"--destroy--");this._removeRenderPlugin();this._readyWatchHandle=y.removeMaybe(this._readyWatchHandle);this._qualityWatchHandle=y.removeMaybe(this._qualityWatchHandle);this._timeExtentWatchHandle=y.removeMaybe(this._timeExtentWatchHandle);this._stationaryWatchHandle=y.removeMaybe(this._stationaryWatchHandle);this._vxl&&(this._layers.forEach(a=>{a.abortController.abort()}),
this._wasmMemBlocks.forEach(a=>{0!==a&&this._vxl._free(a)}),this._vxl.uninitialize_voxel_wasm(),this._vxl=null)};e._initializeWasm=function(a){if(this._vxl)return Promise.resolve();this._vxlPromise||(this._vxlPromise=I.loadVoxelWASM(a).then(b=>{this._vxl=b;this._vxlPromise=null;if(0>=this._newLayers.length)this._dbg(g.Lifetime," no voxel layers left after WASM downloaded, removing RenderPlugin and destroying"),this.destroy();else{b=this._getTimeArgs(this._view?.timeExtent);var c=this._vxl.addFunction(this._restoreFramebuffer.bind(this),
"v"),d=this._vxl.addFunction(this._setBlendState.bind(this),"viiii"),f=this._vxl.addFunction(this._setFrontFace.bind(this),"vi"),m=this._vxl.addFunction(this._setRasterizerState.bind(this),"vi"),k=this._vxl.addFunction(this._setDepthStencilStateFunction.bind(this),"viii"),p=this._vxl.addFunction(this._setViewport.bind(this),"viiii"),x=this._vxl.addFunction(this._bindPreviousDepthToSlot.bind(this),"iii"),r=this._vxl.addFunction(this._modifyResourceCount.bind(this),"viii"),w=this._halfIntTexturesAvailable&&
!C("mac");this._vxl.initialize_voxel_wasm(c,d,f,m,k,p,x,r,b.startTime,b.endTime,b.useTime,w,this._textureFloatLinearAvailable);this._renderPluginContext&&this._renderPluginContext.requestRender()}}).catch(()=>{for(const b of this._newLayers)b.rejectCallback(-2);this._dbg(g.Error," WASM failed to download, removing RenderPlugin and destroying");this.destroy()}));return this._vxlPromise};e.pickDepth=function(a,b,c){if(!this._vxl||!this._rctx||0===this._layers.size)return null;const d=c.viewport[3]-
b;if(0>a||a>c.viewport[2]||0>b||b>c.viewport[3])return this._dbg(g.Error,`pickDepth: outOfRange, screenXY=[${a}, ${d}], vp=[${c.viewport.toString()}]`),null;this._renderTargetToRestore={fbo:this._rctx.getBoundFramebufferObject(),viewport:this._rctx.getViewport()};b=c.viewForward;const f=c.eye;this._vxl.update_camera_pos_and_direction(f[0],f[1],f[2],b[0],b[1],b[2]);this.updateWasmCamera(c);this._vxl.begin_frame();a=this._vxl.pick_depth(a,d);this._renderTargetToRestore.fbo=null;this._rctx.externalTextureUnitUpdate(this._vxl.get_texture_units_bound_in_frame(),
this._vxl.get_active_texture_unit());this._rctx.externalVertexArrayObjectUpdate();this._rctx.externalVertexBufferUpdate();this._rctx.externalProgramUpdate();return a.success?a.distanceToCamera:null};e._toWasmQuality=function(a){switch(a){case "low":return 0;case "medium":return 1;case "high":return 2}};D._createClass(u,[{key:"canRender",get:function(){return!!this._vxl&&"local"===this._view.viewingMode}}]);return u}()});