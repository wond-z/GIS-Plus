// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../core/arrayUtils ../../core/Error ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/accessorSupport/originUtils ../FeatureLayer ../support/arcgisLayerUrl ../support/fetchService ../support/layerUtils ../../portal/Portal ../../portal/PortalItem ../../portal/support/jsonContext ../../portal/support/portalItemUtils".split(" "),function(q,g,U,k,t,u,r,v,V,W,X,M,Y,Z,w,h){function p(a,b){return`Layer (title: ${a.title}, id: ${a.id}) of type '${a.declaredClass}' ${b}`}
function N(a,b){if("Feature Service"!==b.type)throw new k("feature-layer:portal-item-wrong-type",p(a,'should have portal item of type "Feature Service"'));}function O(a){return x.apply(this,arguments)}function x(){x=g._asyncToGenerator(function*(a){yield a.load();if(M.isFeatureCollectionLayer(a))throw new k("feature-layer:save",p(a,"using an in-memory source cannot be saved to a portal item"));});return x.apply(this,arguments)}function aa(a,b){a=(a.messages??[]).filter(({type:c})=>"error"===c).map(({name:c,
message:d,details:e})=>new k(c,d,e));b?.ignoreUnsupported&&(a=a.filter(({name:c})=>"layer:unsupported"!==c&&"symbol:unsupported"!==c&&"symbol-layer:unsupported"!==c&&"property:unsupported"!==c&&"url:unsupported"!==c));if(0<a.length)throw new k("feature-layer:save","Failed to save feature layer due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:a});}function y(a,b,c){return z.apply(this,arguments)}function z(){z=g._asyncToGenerator(function*(a,b,c){"beforeSave"in
a&&"function"===typeof a.beforeSave&&(yield a.beforeSave());a=a.write({},b);aa(b,c);return a});return z.apply(this,arguments)}function P(a){const {layer:b,layerJSON:c}=a;return b.isTable?{layers:[],tables:[c]}:{layers:[c],tables:[]}}function A(a){h.addTypeKeyword(a,h.TypeKeyword.JSAPI);a.typeKeywords&&(a.typeKeywords=a.typeKeywords.filter((b,c,d)=>d.indexOf(b)===c))}function Q(a,b){return B.apply(this,arguments)}function B(){B=g._asyncToGenerator(function*(a,b){return/\/\d+\/?$/.test(a.url??"")?P(b[0]):
ba(a,b)});return B.apply(this,arguments)}function ba(a,b){return C.apply(this,arguments)}function C(){C=g._asyncToGenerator(function*(a,b){const {layer:{url:c,customParameters:d,apiKey:e}}=b[0];(a=yield a.fetchData("json"))&&null!=a.layers&&null!=a.tables||(a=yield ca(a,{url:c??"",customParameters:d,apiKey:e},b.map(f=>f.layer.layerId)));for(const f of b)R(f.layer,f.layerJSON,a);return a});return C.apply(this,arguments)}function ca(a,b,c){return D.apply(this,arguments)}function D(){D=g._asyncToGenerator(function*(a,
b,c){var d,e;a||(a={});(d=a).layers||(d.layers=[]);(e=a).tables||(e.tables=[]);const {url:f,customParameters:m,apiKey:l}=b,{serviceJSON:n,layersJSON:E}=yield X.fetchFeatureService(f,{customParameters:m,apiKey:l});b=S(a.layers,n.layers,c);c=S(a.tables,n.tables,c);a.layers=b.itemResources;a.tables=c.itemResources;c=[...b.added,...c.added];b=E?[...E.layers,...E.tables]:[];yield da(a,c,f,b);return a});return D.apply(this,arguments)}function S(a,b,c){const d=U.difference(a,b,(e,f)=>e.id===f.id);a=a.filter(e=>
!d.removed.some(f=>f.id===e.id));b=d.added.map(({id:e})=>({id:e}));b.forEach(({id:e})=>{a.push({id:e})});return{itemResources:a,added:b.filter(({id:e})=>!c.includes(e))}}function da(a,b,c,d){return F.apply(this,arguments)}function F(){F=g._asyncToGenerator(function*(a,b,c,d){b=b.map(({id:e})=>new V({url:c,layerId:e,sourceJSON:d.find(({id:f})=>f===e)}));yield r.eachAlways(b.map(e=>e.load()));b.forEach(e=>{const {layerId:f,loaded:m,defaultPopupTemplate:l}=e;if(m&&!u.isNone(l)){var n={id:f,popupInfo:l.toJSON()};
R(e,n,a)}})});return F.apply(this,arguments)}function R(a,b,c){a.isTable?T(c.tables,b):T(c.layers,b)}function T(a,b){if(a){var c=a.findIndex(({id:d})=>d===b.id);-1===c?a.push(b):a[c]=b}}function ea(a){const {portalItem:b}=a;return M.isFeatureServiceLayer(a)&&!a.dynamicDataSource&&!!b?.loaded&&"Feature Service"===b.type}function fa(a){return G.apply(this,arguments)}function G(){G=g._asyncToGenerator(function*(a){if(!a?.length)throw new k("feature-layer-utils-saveall:missing-parameters","'layers' array should contain at least one feature layer");
yield Promise.all(a.map(c=>c.load()));for(var b of a)if(!ea(b))throw new k("feature-layer-utils-saveall:invalid-parameters",`'layers' array should only contain layers or tables in a feature service loaded from 'Feature Service' item. ${p(b,"does not conform")}`,{layer:b});b=a.map(c=>c.portalItem.id);if(1<(new Set(b)).size)throw new k("feature-layer-utils-saveall:invalid-parameters","All layers in the 'layers' array should be loaded from the same portal item");a=a.map(c=>c.layerId);if((new Set(a)).size!==
a.length)throw new k("feature-layer-utils-saveall:invalid-parameters","'layers' array should contain only one instance each of layer or table in a feature service");});return G.apply(this,arguments)}function ha(a,b){return H.apply(this,arguments)}function H(){H=g._asyncToGenerator(function*(a,b){const {url:c,layerId:d,title:e,fullExtent:f,isTable:m}=a;a=W.parse(c);a=u.isSome(a)&&"FeatureServer"===a.serverType;b.url=a?c:`${c}/${d}`;b.title||(b.title=e);b.extent=null;!m&&u.isSome(f)&&(b.extent=yield h.getWGS84ExtentForItem(f));
h.removeTypeKeyword(b,h.TypeKeyword.METADATA);h.removeTypeKeyword(b,h.TypeKeyword.MULTI_LAYER);h.addTypeKeyword(b,h.TypeKeyword.SINGLE_LAYER);m&&h.addTypeKeyword(b,h.TypeKeyword.TABLE);A(b)});return H.apply(this,arguments)}function ia(a,b,c){return I.apply(this,arguments)}function I(){I=g._asyncToGenerator(function*(a,b,c){const d=a.portal;yield d?._signIn();yield d?.user?.addItem({item:a,data:b,folder:c?.folder})});return I.apply(this,arguments)}function J(){J=g._asyncToGenerator(function*(a,b){yield O(a);
var c=a.portalItem;if(!c)throw ja.error("save: requires the portalItem property to be set"),new k("feature-layer:portal-item-not-set",p(a,"requires the portalItem property to be set"));if(!c.loaded)throw new k("feature-layer:portal-item-not-loaded",p(a,"cannot be saved to a portal item that does not exist or is inaccessible"));N(a,c);c=a.portalItem;const d=w.createForItemWrite(c);b=yield y(a,d,b);a=yield Q(c,[{layer:a,layerJSON:b}]);A(c);yield c.update({data:a});v.updateOrigins(d);return c});return J.apply(this,
arguments)}function K(){K=g._asyncToGenerator(function*(a,b,c){yield O(a);var d,e;b=Z.from(b);b.id&&(b=b.clone(),b.id=null);(d=b).type??(d.type="Feature Service");(e=b).portal??(e.portal=Y.getDefault());N(a,b);d=b;e=w.createForItemWrite(d);b=yield y(a,e,c);b=P({layer:a,layerJSON:b});yield ha(a,d);yield ia(d,b,c);a.portalItem=d;v.updateOrigins(e);return d});return K.apply(this,arguments)}const ja=t.getLogger("esri.layers.FeatureLayer");t=r.debounce(function(a,b){return J.apply(this,arguments)});var L=
function(){var a=g._asyncToGenerator(function*(b,c){yield fa(b);const d=b[0].portalItem,e=w.createForItemWrite(d),f=yield Promise.all(b.map(l=>y(l,e,c))),m=yield Q(d,b.map((l,n)=>({layer:l,layerJSON:f[n]})));A(d);yield d.update({data:m});yield Promise.all(b.slice(1).map(l=>l.portalItem.reload()));v.updateOrigins(e);return d.clone()});return function(b,c){return a.apply(this,arguments)}}();L=r.debounce(L);const ka=r.debounce(function(a,b,c){return K.apply(this,arguments)});q.save=t;q.saveAll=L;q.saveAs=
ka;Object.defineProperties(q,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});