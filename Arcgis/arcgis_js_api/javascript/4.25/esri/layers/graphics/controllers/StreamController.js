// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../Graphic ../../../core/Accessor ../../../core/HandleOwner ../../../core/maybe ../../../core/Promise ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../data/StreamFeatureManager ../sources/connections/createConnection ../../../views/3d/support/EventedSet ../../../geometry/support/typeUtils".split(" "),
function(d,m,g,N,r,t,u,n,v,w,l,O,P,p,x,y,z,A){d.StreamGraphic=function(f){function c(){return f.apply(this,arguments)||this}m._inheritsLoose(c,f);c.prototype.getObjectId=function(){return this.objectId};return c}(r);g.__decorate([l.property({type:Number,json:{read:!0}})],d.StreamGraphic.prototype,"objectId",void 0);d.StreamGraphic=g.__decorate([p.subclass("esri.layers.graphics.controllers.StreamGraphic")],d.StreamGraphic);let B=function(){function f(b){this.onUpdate=b;this._idToGraphic=new Map}var c=
f.prototype;c.destroy=function(){this._idToGraphic.clear()};c.add=function(b){this._idToGraphic.set(b.objectId,b)};c.get=function(b){return this._idToGraphic.get(b)};c.forEach=function(b){this._idToGraphic.forEach(b)};c.removeById=function(b){const a=this._idToGraphic.get(b);if(!a)return null;a.sourceLayer=a.layer=null;this._idToGraphic.delete(b);return a};c.update=function(b,a){this.onUpdate(b,a)};m._createClass(f,[{key:"size",get:function(){return this._idToGraphic.size}}]);return f}();d.StreamController=
function(f){function c(){var a=f.apply(this,arguments)||this;a._updateInfo={websocket:0,client:0};a.graphics=new z.EventedSet;return a}m._inheritsLoose(c,f);var b=c.prototype;b.initialize=function(){this.addResolvingPromise(this.layer.when(()=>this._startup()))};b.destroy=function(){this.clear()};b._clearInterval=function(){this._updateIntervalId&&(clearInterval(this._updateIntervalId),this._updateIntervalId=0)};b.clear=function(){this._clearInterval();this.connection&&(this.connection.destroy(),
this.connection=null);this.store&&(this.store.destroy(),this.store=null);this.graphics.clear();this.handles.removeAll()};b._startup=function(){const {layer:a,layerView:e}=this,{parsedUrl:k,spatialReference:h,definitionExpression:C,geometryDefinition:D,objectIdField:E,timeInfo:F,purgeOptions:G,maxReconnectionAttempts:H,maxReconnectionInterval:I,customParameters:J}=a,K=A.featureGeometryTypeKebabDictionary.toJSON(a.geometryType),q=e.view.spatialReference,L={geometry:D,where:C};this.clear();this._set("connection",
y.createConnection(k,h,q,K,L,H,I,J));this._outSpatialReference=q.toJSON();this.store=new B(this._onUpdate.bind(this));this.featuresManager=new x.StreamFeatureManager(this.store,E,F.toJSON(),G);this.handles.remove("startup-watches");this.handles.add([this.connection.on("data-received",M=>this._onFeature(M)),w.watch(()=>[a.definitionExpression,a.geometryDefinition,a.purgeOptions],()=>this._startup())],"startup-watches");this._initUpdateInterval()};b._onFeature=function(a){this._updateInfo.websocket++;
this.layerView.hasEventListener("data-received")&&this.layerView.emit("data-received",{attributes:a.attributes,centroid:a.centroid,geometry:a.geometry});try{n.isSome(a.geometry)&&!a.geometry.spatialReference&&(a.geometry.spatialReference=this._outSpatialReference);const e=d.StreamGraphic.fromJSON(a);e.sourceLayer=e.layer=this.layer;this.featuresManager.add(e)}catch{}};b._onUpdate=function(a,e){n.isSome(e)&&this.graphics.removeMany(e);n.isSome(a)&&(this._updateInfo.client+=a.length,this.graphics.addMany(a))};
b._initUpdateInterval=function(){this._clearInterval();const {updateInterval:a}=this.layer;let e=performance.now();this._updateIntervalId=setInterval(()=>{var k=performance.now(),h=k-e;2500<h&&(e=k,k=Math.round(this._updateInfo.client/(h/1E3)),h=Math.round(this._updateInfo.websocket/(h/1E3)),this._updateInfo.client=0,this._updateInfo.websocket=0,this.layerView.emit("update-rate",{client:k,websocket:h}));this.featuresManager.checkForUpdates()},a)};b.pauseStream=function(){this._clearInterval()};b.resumeStream=
function(){this._initUpdateInterval()};m._createClass(c,[{key:"updating",get:function(){return!this.connection||"connected"===this.connection.connectionStatus}}]);return c}(u.HandleOwnerMixin(v.EsriPromiseMixin(t)));g.__decorate([l.property()],d.StreamController.prototype,"connection",void 0);g.__decorate([l.property()],d.StreamController.prototype,"layer",void 0);g.__decorate([l.property()],d.StreamController.prototype,"layerView",void 0);g.__decorate([l.property({readOnly:!0})],d.StreamController.prototype,
"updating",null);d.StreamController=g.__decorate([p.subclass("esri.layers.graphics.controllers.StreamController")],d.StreamController);Object.defineProperties(d,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});