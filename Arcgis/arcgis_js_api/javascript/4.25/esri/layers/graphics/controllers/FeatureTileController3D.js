// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../core/Accessor ../../../core/asyncUtils ../../../core/Collection ../../../core/has ../../../core/Error ../../../core/Handles ../../../core/lang ../../../core/Logger ../../../core/maybe ../../../core/Promise ../../../core/promiseUtils ../../../core/reactiveUtils ../../../core/accessorSupport/decorators/property ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../core/support/WatchUpdatingTracking ../../support/arcgisLayerUrl ../../../portal/support/geometryServiceUtils ../../../rest/support/StatisticDefinition ../../../views/3d/layers/support/FeatureTileFetcher3D ../../../views/3d/layers/support/FeatureTileFetcher3DDebugger ../../../views/3d/support/debugFlags".split(" "),
function(c,t,l,D,z,A,P,E,F,B,x,f,G,w,p,m,Q,H,I,J,K,L,M,N,O){function C(q,u){if(!u)return!1;for(const k of u)if(!q.has(k))return!0;return!1}c.FeatureTileController3D=function(q){function u(a){a=q.call(this,a)||this;a.type="feature-tile-3d";a._watchUpdatingTracking=new I.WatchUpdatingTracking;a.serviceDataExtent=null;a.serviceDataCount=c.FeatureTileController3DConstants.NO_SERVICE_DATA_COUNT;a.vertexLimitExceeded=!1;a.displayFeatureLimit=null;a._suspended=!1;a._tileFetcher=null;a._handles=new F;a._fetchDataInfoPromise=
null;a._fetchDataInfoAbortController=null;a._lifeCycleAbortController=new AbortController;return a}t._inheritsLoose(u,q);var k=u.prototype;k._approximateExtentSizeAtScale=function(a,b){const d=this.layerView.view,e=b.levels[0];return(e.tileSize[0]/(e.scale/a)+e.tileSize[1]/(e.scale/a))/2*Math.ceil((d.width/b.pixelSize+d.height/b.pixelSize)/2)};k.initialize=function(){this._watchUpdatingTracking.add(()=>this.vertexLimitInfo,()=>this._watchUpdatingTracking.addPromise(this._updateVertexLimitExceeded(null,
this._lifeCycleAbortController.signal)));this._watchUpdatingTracking.add(()=>this.mode,()=>this._modeChanged(),p.initial);this.addResolvingPromise(Promise.resolve().then(()=>this._verifyCapabilities()).then(()=>this._watchUpdatingTracking.addPromise(this._fetchServiceDataInfo())).then(()=>this._initializeTileFetcher()))};k._verifyCapabilities=function(){const a=this.layerView.layer;if(!a.get("capabilities.operations.supportsQuery")&&"ogc-feature"!==a.type)throw new E("graphicscontroller:query-capability-required",
"Service requires query capabilities to be used as a feature layer",{layer:a});};k.destroy=function(){this._cancelFetchServiceDataInfo();this._tileFetcher=f.destroyMaybe(this._tileFetcher);this._handles=f.destroyMaybe(this._handles);this._tilesHandle=f.removeMaybe(this._tilesHandle);this._lifeCycleAbortController&&(this._lifeCycleAbortController.abort(),this._lifeCycleAbortController=null);this._watchUpdatingTracking.destroy();this._set("watchUpdatingTracking",null)};k.suspend=function(){this._suspended||
(this._suspended=!0,f.isSome(this._tileFetcher)&&this._tileFetcher.suspend())};k.resume=function(){this._suspended&&(this._suspended=!1,f.isSome(this._tileFetcher)&&this._tileFetcher.resume())};k.restart=function(){const a=()=>{f.isSome(this._tileFetcher)&&this._tileFetcher.restart()};this._watchUpdatingTracking.addPromise(this._fetchServiceDataInfo().then(a,a))};k.refetch=function(){const a=()=>{f.isSome(this._tileFetcher)&&this._tileFetcher.refetch()};this._watchUpdatingTracking.addPromise(this._fetchServiceDataInfo().then(a,
a))};k._initializeTileFetcher=function(){const a=this.layerView.view;if(a){var b=p.whenOnce(()=>a.featureTiles?.tilingScheme,this._lifeCycleAbortController.signal);this._watchUpdatingTracking.addPromise(b);b.then(()=>{const {layerView:d,tileDescriptors:e}=this,n=d.layer,g=new M.FeatureTileFetcher3D({context:this.context,filterExtent:this.extent,tileDescriptors:e,features:this.graphics});this._tileFetcher=g;this._suspended?this._tileFetcher.suspend():this._tileFetcher.resume();const r=this.layerView.view.resourceController;
r&&this._handles.add(p.watch(()=>r.memoryController.memoryFactor,h=>g.memoryFactor=h,p.syncAndInitial));const v="polygon"===this.context.geometryType?"polygonLodFactor":"polyline"===this.context.geometryType?"polylineLodFactor":null;v&&this._handles.add(p.watch(()=>this.layerView.view?.qualitySettings?.graphics3D?.[v],h=>g.lodFactor=h||1,p.initial));"ogc-feature"!==n.type&&this._watchUpdatingTracking.add(()=>n.createQueryVersion,()=>this._dataFilterChanged());this._watchUpdatingTracking.add(()=>d.availableFields,
(h,y)=>this._availableFieldsChanged(y,h));this._watchUpdatingTracking.add(()=>d.requiredFields,(h,y)=>this._requiredFieldsChanged(y,h));this._handles.add([n.on("apply-edits",h=>this._applyEdits(h)),p.watch(()=>this.extent,h=>g.filterExtent=h,p.sync),p.watch(()=>this.tileDescriptors,h=>g.tileDescriptors=h,p.sync),p.watch(()=>this.maximumNumberOfFeatures,h=>{g.maximumNumberOfFeatures=h;g.useTileCount=this.serviceDataCount>h},p.syncAndInitial),p.watch(()=>this.serviceDataCount,h=>g.useTileCount=h>this.maximumNumberOfFeatures,
p.syncAndInitial),p.watch(()=>O.FEATURE_TILE_FETCH_SHOW_TILES,h=>{h&&g&&!g.debugger?(g.debugger=new N.FeatureTileFetcher3DDebugger(g,a.featureTiles.tilingScheme.toTileInfo(),a),g.debugger.update()):!h&&this._tileFetcher&&g.debugger&&(g.debugger.destroy(),g.debugger=null)},p.syncAndInitial)]);this._supportsExceedsLimitQuery||this._watchUpdatingTracking.add(()=>this.maxTotalSnapshotVertices,()=>this._watchUpdatingTracking.addPromise(this._updateVertexLimitExceeded(null,this._lifeCycleAbortController.signal)))}).catch(()=>
{})}};k._modeChanged=function(){switch(this.mode){case "tiles":this._tilesHandle||(this._tilesHandle=this.layerView.view.featureTiles.addClient());break;default:x.getLogger(this.declaredClass).warn("Unhandled feature layer mode "+this.mode);case "snapshot":f.isSome(this._tilesHandle)&&(this._tilesHandle.remove(),this._tilesHandle=null)}};k._dataFilterChanged=function(){this._set("maxTotalSnapshotVertices",0);this.notifyChange("maxTotalSnapshotVertices");this.refetch()};k._applyEdits=function(a){f.isNone(this._tileFetcher)||
this._tileFetcher.applyEdits(a).then(b=>{b&&(b.deletedFeatures.length||b.updatedFeatures.length||b.addedFeatures.length)&&this._watchUpdatingTracking.addPromise(this._updateServiceDataExtent(this._lifeCycleAbortController.signal))}).catch(b=>{if(!w.isAbortError(b))throw b;})};k._availableFieldsChanged=function(a,b){f.isSome(this._tileFetcher)&&C(this._tileFetcher.availableFields,b)&&this.refetch()};k._requiredFieldsChanged=function(a,b){f.isSome(this._tileFetcher)&&C(this._tileFetcher.availableFields,
b)&&this.restart()};k._createVertexLimitExceededQuery=function(a){const b=this.layerView.layer,d=b.createQuery();d.outStatistics=[new L({statisticType:"exceedslimit",maxVertexCount:a,outStatisticFieldName:"exceedslimit",maxPointCount:1E8,maxRecordCount:1E8})];b.capabilities.query.supportsCacheHint&&(d.cacheHint=!0);return d};k._createDataInfoQuery=function(){const a=this.layerView.layer,b=a.createQuery();b.outSpatialReference=this.layerView.view.spatialReference;a.capabilities.query.supportsCacheHint&&
(b.cacheHint=!0);return b};k._fullExtentIsAccurate=function(){const a=this.layerView.layer;if(a.definitionExpression)return!1;switch(a.type){case "feature":case "oriented-imagery":return J.isHostedAgolService(a.url);case "csv":case "geojson":case "ogc-feature":case "wfs":return!0}};k._updateServiceDataExtent=function(){var a=t._asyncToGenerator(function*(b){try{yield this._tryUpdateServiceDataExtent(b)}catch(d){w.isAbortError(d)||this._set("serviceDataExtent",B.clone(this.layerView.fullExtentInLocalViewSpatialReference))}});
return function(b){return a.apply(this,arguments)}}();k._tryUpdateServiceDataExtent=function(){var a=t._asyncToGenerator(function*(b){var d=this.layerView;const e=d.layer,n=e.capabilities.query.supportsExtent,g=B.clone(d.fullExtentInLocalViewSpatialReference),r=e.fullExtent,v=this._fullExtentIsAccurate(),h=this.serviceDataCount;n&&h<=c.FeatureTileController3DConstants.MAX_FEATURE_COUNT_FOR_EXTENT&&(!g||!v)&&"queryExtent"in e?(d=this._createDataInfoQuery(),b=yield e.queryExtent(d,{timeout:c.FeatureTileController3DConstants.QUERY_EXTENT_TIMEOUT,
signal:b}),this._set("serviceDataExtent",b.extent)):g?this._set("serviceDataExtent",g):f.isSome(r)?(b=yield K.projectGeometry(r,d.view.spatialReference,"portalItem"in e?e.portalItem:null,b),this._set("serviceDataExtent",b)):this._set("serviceDataExtent",null)});return function(b){return a.apply(this,arguments)}}();k._updateServiceDataCount=function(){var a=t._asyncToGenerator(function*(b){const d=this.layerView.layer;if("queryFeatureCount"in d)if(b=yield z.result(d.queryFeatureCount(this._createDataInfoQuery(),
{timeout:c.FeatureTileController3DConstants.QUERY_STATISTICS_TIMEOUT,signal:b})),!0===b.ok)this._set("serviceDataCount",b.value);else{if(w.isAbortError(b.error))throw b.error;this._set("serviceDataCount",c.FeatureTileController3DConstants.NO_SERVICE_DATA_COUNT)}else this._set("serviceDataCount",c.FeatureTileController3DConstants.NO_SERVICE_DATA_COUNT)});return function(b){return a.apply(this,arguments)}}();k._updateVertexLimitExceeded=function(){var a=t._asyncToGenerator(function*(b,d){var e=this.vertexLimitInfo;
if(f.isNone(e))this._set("vertexLimitExceeded",!1);else{var n=1<this._minimumNumberOfVerticesForGeometry;if(0>=e.primitivesPerFeature||n){var {primitivesPerFeature:g,primitivesPerCoordinate:r,maximumTotalNumberOfPrimitives:v}=e;0!==g&&f.isSome(b)&&(yield b);e=this.serviceDataCount;var h=e!==c.FeatureTileController3DConstants.NO_SERVICE_DATA_COUNT;b=h?Math.ceil((v-e*g)/(r||1)):Math.ceil(v/(r||1));n&&(b=Math.min(b,5E6));if(h&&this._minimumNumberOfVerticesForGeometry*e>b)this._set("vertexLimitExceeded",
!0);else if(this._supportsExceedsLimitQuery)if(d=yield z.result(this.layerView.layer.queryFeatures(this._createVertexLimitExceededQuery(b),{timeout:c.FeatureTileController3DConstants.QUERY_STATISTICS_TIMEOUT,signal:d})),!1===d.ok){if(w.isAbortError(d.error))throw d.error;this._set("vertexLimitExceeded",!1)}else(d=d.value.features[0])&&d.attributes?this._set("vertexLimitExceeded",!!d.attributes.exceedslimit):this._set("vertexLimitExceeded",!1);else this._set("vertexLimitExceeded",this.maxTotalSnapshotVertices>
b)}else this._set("vertexLimitExceeded",!1)}});return function(b,d){return a.apply(this,arguments)}}();k._fetchServiceDataInfo=function(){var a=t._asyncToGenerator(function*(){this._cancelFetchServiceDataInfo();let b=new AbortController;const d=b.signal;var e=this._updateServiceDataCount(d);e=w.eachAlways([e,this._updateVertexLimitExceeded(e,d)]);const n=e.then(()=>this._updateServiceDataExtent(d)).catch(g=>{w.isAbortError(g)||x.getLogger(this.declaredClass).error("#fetchServiceDataInfo()",g)}).then(()=>
{n===this._fetchDataInfoPromise&&(this._fetchDataInfoAbortController=this._fetchDataInfoPromise=null);b=null});b&&(this._fetchDataInfoPromise=n);this._fetchDataInfoAbortController=b;return e.then(()=>{},()=>{})});return function(){return a.apply(this,arguments)}}();k._cancelFetchServiceDataInfo=function(){const a=this._fetchDataInfoAbortController;a&&(this._fetchDataInfoPromise=this._fetchDataInfoAbortController=null,a.abort())};t._createClass(u,[{key:"extent",set:function(a){if(a&&!a.spatialReference.equals(this.layerView.view.spatialReference))x.getLogger(this.declaredClass).error("#extent\x3d",
"extent needs to be in the same spatial reference as the view");else{var b=this._get("extent");b===a||b&&a&&b.equals(a)||(a=a?a.clone():null,this._set("extent",a))}}},{key:"updating",get:function(){return!!(f.isSome(this._tileFetcher)&&this._tileFetcher.updating||null!=this._fetchDataInfoPromise||"tiles"===this.mode&&this.layerView.view.featureTiles&&this.layerView.view.featureTiles.updating||this._watchUpdatingTracking&&this._watchUpdatingTracking.updating)}},{key:"updatingTotal",get:function(){return this.updating&&
f.isSome(this._tileFetcher)?this._tileFetcher.updatingTotal:0}},{key:"updatingRemaining",get:function(){return this.updating&&f.isSome(this._tileFetcher)?this._tileFetcher.updatingRemaining:0}},{key:"expectedFeatureDiff",get:function(){return this.updating&&f.isSome(this._tileFetcher)?this._tileFetcher.expectedFeatureDiff:0}},{key:"memoryForUnusedFeatures",get:function(){return f.isSome(this._tileFetcher)?this._tileFetcher.memoryForUnusedFeatures:0}},{key:"maximumNumberOfFeaturesExceeded",get:function(){return!(!f.isSome(this._tileFetcher)||
!this._tileFetcher.maximumNumberOfFeaturesExceeded)}},{key:"maximumNumberOfFeatures",get:function(){return f.isSome(this.displayFeatureLimit)?this.displayFeatureLimit.maximumNumberOfFeatures:0},set:function(a){a!==this.maximumNumberOfFeatures&&this._overrideIfSome("maximumNumberOfFeatures",a)}},{key:"hasMaximumNumberOfFeaturesOverride",get:function(){return this._isOverridden("maximumNumberOfFeatures")}},{key:"mode",get:function(){var a=this.layerView.layer;if("feature"===a.type&&f.isSome(a.infoFor3D))return"snapshot";
if(!1===this.layerView.view.qualitySettings?.graphics3D?.snapshotAvailable||this.serviceDataCount===c.FeatureTileController3DConstants.NO_SERVICE_DATA_COUNT||this.vertexLimitExceeded)return"tiles";var b=this.layerView.view;b=(b=b&&b.featureTiles)&&b.tilingScheme;return a&&a.minScale&&this.serviceDataExtent&&b&&(a=this._approximateExtentSizeAtScale(a.minScale,b),(this.serviceDataExtent.width/a+this.serviceDataExtent.height/a)/2>c.FeatureTileController3DConstants.MAX_SNAPSHOT_MIN_SCALE_FACTOR)?"tiles":
!this.maximumNumberOfFeatures||this.serviceDataCount<=this.maximumNumberOfFeatures?"snapshot":"tiles"}},{key:"maxTotalSnapshotVertices",get:function(){const a=this._get("maxTotalSnapshotVertices")||0,b="snapshot"===this.mode&&f.isSome(this._tileFetcher)&&this._tileFetcher.totalVertices||0;return Math.max(a,b)}},{key:"tileDescriptors",get:function(){return"snapshot"===this.mode?new A([{id:"dummy-tile-full-extent",lij:[0,0,0]}]):this.layerView.view.featureTiles?this.layerView.view.featureTiles.tiles:
new A}},{key:"test",get:function(){return{fetchDataInfoPromise:this._fetchDataInfoPromise,tileFetcher:this._tileFetcher}}},{key:"vertexLimitInfo",get:function(){if(f.isNone(this.displayFeatureLimit)||f.isNone(this.displayFeatureLimit.averageSymbolComplexity))return null;const {averageSymbolComplexity:a,maximumTotalNumberOfPrimitives:b}=this.displayFeatureLimit,{primitivesPerCoordinate:d,primitivesPerFeature:e}=a,n=this._get("vertexLimitInfo");return f.isNone(n)||n.maximumTotalNumberOfPrimitives!==
b||n.primitivesPerCoordinate!==d||n.primitivesPerFeature!==e?{primitivesPerCoordinate:d,primitivesPerFeature:e,maximumTotalNumberOfPrimitives:b}:n}},{key:"_supportsExceedsLimitQuery",get:function(){const a=this.layerView.layer;return a.capabilities&&a.capabilities.operations&&a.capabilities.operations.supportsExceedsLimitStatistics}},{key:"_minimumNumberOfVerticesForGeometry",get:function(){switch(this.layerView.layer.geometryType){case "point":return 1;case "multipoint":return 1;case "polygon":return 4;
case "polyline":return 2;case "multipatch":case "mesh":return 3;default:return 0}}},{key:"debug",get:function(){return{storedFeatures:f.isSome(this._tileFetcher)?this._tileFetcher.storedFeatures:0,totalFeatures:f.isSome(this._tileFetcher)?this._tileFetcher.totalFeatures:0,totalVertices:f.isSome(this._tileFetcher)?this._tileFetcher.totalVertices:0}}}]);return u}(G.EsriPromiseMixin(D));l.__decorate([m.property({readOnly:!0})],c.FeatureTileController3D.prototype,"type",void 0);l.__decorate([m.property({constructOnly:!0})],
c.FeatureTileController3D.prototype,"graphics",void 0);l.__decorate([m.property({constructOnly:!0})],c.FeatureTileController3D.prototype,"layerView",void 0);l.__decorate([m.property({constructOnly:!0})],c.FeatureTileController3D.prototype,"context",void 0);l.__decorate([m.property()],c.FeatureTileController3D.prototype,"extent",null);l.__decorate([m.property()],c.FeatureTileController3D.prototype,"updating",null);l.__decorate([m.property({readOnly:!0})],c.FeatureTileController3D.prototype,"_watchUpdatingTracking",
void 0);l.__decorate([m.property()],c.FeatureTileController3D.prototype,"updatingTotal",null);l.__decorate([m.property()],c.FeatureTileController3D.prototype,"updatingRemaining",null);l.__decorate([m.property()],c.FeatureTileController3D.prototype,"expectedFeatureDiff",null);l.__decorate([m.property()],c.FeatureTileController3D.prototype,"memoryForUnusedFeatures",null);l.__decorate([m.property()],c.FeatureTileController3D.prototype,"maximumNumberOfFeaturesExceeded",null);l.__decorate([m.property({readOnly:!0})],
c.FeatureTileController3D.prototype,"serviceDataExtent",void 0);l.__decorate([m.property({readOnly:!0})],c.FeatureTileController3D.prototype,"serviceDataCount",void 0);l.__decorate([m.property({readOnly:!0})],c.FeatureTileController3D.prototype,"vertexLimitExceeded",void 0);l.__decorate([m.property()],c.FeatureTileController3D.prototype,"displayFeatureLimit",void 0);l.__decorate([m.property({type:Number})],c.FeatureTileController3D.prototype,"maximumNumberOfFeatures",null);l.__decorate([m.property({readOnly:!0})],
c.FeatureTileController3D.prototype,"mode",null);l.__decorate([m.property({readOnly:!0})],c.FeatureTileController3D.prototype,"maxTotalSnapshotVertices",null);l.__decorate([m.property({readOnly:!0,dependsOn:["mode"]})],c.FeatureTileController3D.prototype,"tileDescriptors",null);l.__decorate([m.property()],c.FeatureTileController3D.prototype,"_tileFetcher",void 0);l.__decorate([m.property()],c.FeatureTileController3D.prototype,"_fetchDataInfoPromise",void 0);l.__decorate([m.property({readOnly:!0})],
c.FeatureTileController3D.prototype,"vertexLimitInfo",null);c.FeatureTileController3D=l.__decorate([H.subclass("esri.layers.graphics.controllers.FeatureTileController3D")],c.FeatureTileController3D);c.FeatureTileController3DConstants=void 0;(function(q){q.NO_SERVICE_DATA_COUNT=Infinity;q.MAX_SNAPSHOT_MIN_SCALE_FACTOR=5;q.reset=function(){q.MAX_FEATURE_COUNT_FOR_EXTENT=1E4;q.QUERY_STATISTICS_TIMEOUT=12E3;q.QUERY_EXTENT_TIMEOUT=1E4}})(c.FeatureTileController3DConstants||(c.FeatureTileController3DConstants=
{}));c.FeatureTileController3DConstants.reset();Object.defineProperties(c,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});