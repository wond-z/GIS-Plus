// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../core/Error ../../core/Logger ../../core/maybe ../../geometry/support/jsonUtils ./OptimizedFeature ./OptimizedFeatureSet ./OptimizedGeometry".split(" "),function(p,D,pa,v,J,E,qa,B){function w(a,b){return a?b?4:3:b?3:2}function K(a,b,c,d){if(a){if(c)return b&&d?ra:ia;if(b&&d)return sa}else if(b&&d)return ia;return ta}function L({scale:a,translate:b},c){return Math.round((c-b[0])/a[0])}function M({scale:a,translate:b},c){return Math.round((b[1]-c)/a[1])}function F({scale:a,translate:b},
c,d){return c*a[d]+b[d]}function N(a){a=a.coords;return{x:a[0],y:a[1]}}function ja(a,b){a.coords[0]=b.x;a.coords[1]=b.y;return a}function O(a){a=a.coords;return{x:a[0],y:a[1],z:a[2]}}function ua(a,b){a.coords[0]=b.x;a.coords[1]=b.y;a.coords[2]=b.z;return a}function P(a){a=a.coords;return{x:a[0],y:a[1],m:a[2]}}function va(a,b){a.coords[0]=b.x;a.coords[1]=b.y;a.coords[2]=b.m;return a}function Q(a){a=a.coords;return{x:a[0],y:a[1],z:a[2],m:a[3]}}function wa(a,b){a.coords[0]=b.x;a.coords[1]=b.y;a.coords[2]=
b.z;a.coords[3]=b.m;return a}function R(a,b){return a&&b?wa:a?ua:b?va:ja}function S(a,b,c,d,e){c=R(c,d);for(const {geometry:f,attributes:g}of b)b=v.isSome(f)?c(new B,f):null,a.push(new E.OptimizedFeature(b,g,null,e?g[e]:void 0));return a}function ka(a,b,c,d){for(const {geometry:e,attributes:f}of b)a.push({attributes:f,geometry:v.isSome(e)?T(e,c,d):null});return a}function T(a,b,c){if(v.isNone(a))return null;const d=w(b,c),e=[];for(let f=0;f<a.coords.length;f+=d){const g=[];for(let h=0;h<d;h++)g.push(a.coords[f+
h]);e.push(g)}return b?c?{points:e,hasZ:b,hasM:c}:{points:e,hasZ:b}:c?{points:e,hasM:c}:{points:e}}function U(a,b,c,d,e){c=w(c,d);for(const {geometry:f,attributes:g}of b)b=v.isSome(f)?V(new B,f,c):null,a.push(new E.OptimizedFeature(b,g,null,e?g[e]:void 0));return a}function V(a,b,c=w(b.hasZ,b.hasM)){a.lengths[0]=b.points.length;const d=a.coords;let e=0;for(const f of b.points)for(b=0;b<c;b++)d[e++]=f[b];return a}function W(a,b,c){if(!a)return null;const d=w(b,c),{coords:e,lengths:f}=a;a=[];let g=
0;for(const h of f){const k=[];for(let m=0;m<h;m++){const l=[];for(let n=0;n<d;n++)l.push(e[g++]);k.push(l)}a.push(k)}return b?c?{paths:a,hasZ:b,hasM:c}:{paths:a,hasZ:b}:c?{paths:a,hasM:c}:{paths:a}}function X(a,b,c,d,e){c=w(c,d);for(const {geometry:f,attributes:g}of b)b=v.isSome(f)?Y(new B,f,c):null,a.push(new E.OptimizedFeature(b,g,null,e?g[e]:void 0));return a}function Y(a,b,c=w(b.hasZ,b.hasM)){const {lengths:d,coords:e}=a;let f=0;for(const g of b.paths){for(const h of g)for(b=0;b<c;b++)e[f++]=
h[b];d.push(g.length)}return a}function Z(a,b,c){if(!a)return null;const d=w(b,c),{coords:e,lengths:f}=a;a=[];let g=0;for(const h of f){const k=[];for(let m=0;m<h;m++){const l=[];for(let n=0;n<d;n++)l.push(e[g++]);k.push(l)}a.push(k)}return b?c?{rings:a,hasZ:b,hasM:c}:{rings:a,hasZ:b}:c?{rings:a,hasM:c}:{rings:a}}function la(a,b,c,d,e){for(const {geometry:f,centroid:g,attributes:h}of b){b=v.isSome(f)?aa(new B,f,c,d):null;const k=e?h[e]:void 0;v.isSome(g)?a.push(new E.OptimizedFeature(b,h,ja(new B,
g),k)):a.push(new E.OptimizedFeature(b,h,null,k))}return a}function aa(a,b,c=b.hasZ,d=b.hasM){ma(a,b.rings,c,d);return a}function ma(a,b,c,d){c=w(c,d);const {lengths:e,coords:f}=a;d=0;A(a);for(const g of b){for(const h of g)for(b=0;b<c;b++)f[d++]=h[b];e.push(g.length)}return a}function ba(a,b,c,d,e,f){z(a);if(!c){for(const g of b)a.push(new E.OptimizedFeature(null,g.attributes,null,f?g.attributes[f]:void 0));return a}switch(c){case "esriGeometryPoint":return S(a,b,d,e,f);case "esriGeometryMultipoint":return U(a,
b,d,e,f);case "esriGeometryPolyline":return X(a,b,d,e,f);case "esriGeometryPolygon":return la(a,b,d,e,f);default:G.error("convertToFeatureSet:unknown-geometry",new D(`Unable to parse unknown geometry type '${c}'`)),z(a)}return a}function na(a,b,c,d){a=a&&("coords"in a?a:a.geometry);if(v.isNone(a))return null;switch(b){case "esriGeometryPoint":return b=N,c&&d?b=Q:c?b=O:d&&(b=P),b(a);case "esriGeometryMultipoint":return T(a,c,d);case "esriGeometryPolyline":return W(a,c,d);case "esriGeometryPolygon":return Z(a,
c,d);default:return G.error("convertToGeometry:unknown-geometry",new D(`Unable to parse unknown geometry type '${b}'`)),null}}function ca(a,b,c,d,e){z(a);if(v.isNone(c)){for(const g of b)a.push({attributes:g.attributes});return a}switch(c){case "esriGeometryPoint":c=N;d&&e?c=Q:d?c=O:e&&(c=P);for(var f of b){const {geometry:g,attributes:h}=f;d=v.isSome(g)?c(g):null;a.push({attributes:h,geometry:d})}break;case "esriGeometryMultipoint":return ka(a,b,d,e);case "esriGeometryPolyline":for(const {geometry:g,
attributes:h}of b)a.push({attributes:h,geometry:v.isSome(g)?W(g,d,e):null});break;case "esriGeometryPolygon":for(const {geometry:g,attributes:h,centroid:k}of b)f=v.isSome(g)?Z(g,d,e):null,v.isSome(k)?(b=N(k),a.push({attributes:h,centroid:b,geometry:f})):a.push({attributes:h,geometry:f});break;default:G.error("convertToFeatureSet:unknown-geometry",new D(`Unable to parse unknown geometry type '${c}'`))}return a}function da(a,b,c,d,e,f,g=c,h=d){A(a);if(v.isNone(b)||!b.coords.length)return null;e=ea[e];
const {coords:k,lengths:m}=b;b=w(c,d);const l=w(c&&g,d&&h);c=K(c,d,g,h);if(!m.length)return c(a.coords,k,0,0,L(f,k[0]),M(f,k[1])),A(a,b,0),a;let n,q=0,r,u=0;for(const x of m){if(x<e)continue;let t=0;r=u;h=d=L(f,k[q]);n=g=M(f,k[q+1]);c(a.coords,k,r,q,h,n);t++;q+=b;r+=l;for(let y=1;y<x;y++,q+=b)if(h=L(f,k[q]),n=M(f,k[q+1]),h!==d||n!==g)c(a.coords,k,r,q,h-d,n-g),r+=l,t++,d=h,g=n;t>=e&&(a.lengths.push(t),u=r)}z(a.coords,u);return a.coords.length?a:null}function fa(a,b,c,d,e,f,g){let h=d,k=0;for(let l=
f+c;l<g;l+=c){var m=b[l];const n=b[l+1],q=b[g],r=b[g+1];let u=b[f],x=b[f+1],t=q-u,y=r-x;if(0!==t||0!==y){const C=((m-u)*t+(n-x)*y)/(t*t+y*y);1<C?(u=q,x=r):0<C&&(u+=t*C,x+=y*C)}t=m-u;y=n-x;m=t*t+y*y;m>h&&(k=l,h=m)}h>d&&(k-f>c&&fa(a,b,c,d,e,f,k),e(a,b,a.length,k,b[k],b[k+1]),g-k>c&&fa(a,b,c,d,e,k,g))}function ha(a,b,c,d,e){const {coords:f,lengths:g}=b;c=w(c,d);if(!f.length)return a!==b&&A(a),a;v.assertIsSome(e);const {originPosition:h,scale:k,translate:m}=e;e=xa;e.originPosition=h;d=e.scale;d[0]=k[0]??
1;d[1]=-(k[1]??1);d[2]=k[2]??1;d[3]=k[3]??1;var l=e.translate;l[0]=m[0]??0;l[1]=m[1]??0;l[2]=m[2]??0;l[3]=m[3]??0;if(!g.length){for(d=0;d<c;++d)a.coords[d]=F(e,f[d],d);a!==b&&A(a,c,0);return a}l=0;for(let q=0;q<g.length;q++){const r=g[q];a.lengths[q]=r;for(var n=0;n<c;++n)a.coords[l+n]=F(e,f[l+n],n);n=a.coords[l];let u=a.coords[l+1];l+=c;for(let x=1;x<r;x++,l+=c){n+=f[l]*d[0];u+=f[l+1]*d[1];a.coords[l]=n;a.coords[l+1]=u;for(let t=2;t<c;++t)a.coords[l+t]=F(e,f[l+t],t)}}a!==b&&A(a,f.length,g.length);
return a}function oa(a,b,c,d){let e=0,f=a[d*b],g=a[d*(b+1)];for(let h=1;h<c;h++){const k=f+a[d*(b+h)],m=g+a[d*(b+h)+1],l=(k-f)*(m+g);f=k;g=m;e+=l}return.5*e}function A(a,b=0,c=0){z(a.lengths,c);z(a.coords,b)}function z(a,b=0){a.length!==b&&(a.length=b)}const G=pa.getLogger("esri.layers.graphics.featureConversionUtils"),ea={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0},ta=(a,b,c,d,e,f)=>{a[c]=e;a[c+1]=f},ia=(a,b,c,d,e,f)=>{a[c]=e;a[c+1]=f;a[c+2]=b[d+2]},
sa=(a,b,c,d,e,f)=>{a[c]=e;a[c+1]=f;a[c+2]=b[d+3]},ra=(a,b,c,d,e,f)=>{a[c]=e;a[c+1]=f;a[c+2]=b[d+2];a[c+3]=b[d+3]},H=[],I=[],xa={originPosition:"lowerLeft",scale:[1,1,1,1],translate:[0,0,0,0]};p.convertFromFeature=function(a,b,c,d,e){H[0]=a;[a]=ba(I,H,b,c,d,e);z(H);z(I);return a};p.convertFromFeatureSet=function(a,b){const c=new qa,{hasM:d,hasZ:e,features:f,objectIdFieldName:g,spatialReference:h,geometryType:k,exceededTransferLimit:m,transform:l,fields:n}=a;n&&(c.fields=n);c.geometryType=k??null;c.objectIdFieldName=
g??b??null;c.spatialReference=h??null;if(!c.objectIdFieldName)return G.error(new D("optimized-features:invalid-objectIdFieldName","objectIdFieldName is missing")),c;f&&ba(c.features,f,k,e,d,c.objectIdFieldName);m&&(c.exceededTransferLimit=m);d&&(c.hasM=d);e&&(c.hasZ=e);l&&(c.transform=l);return c};p.convertFromFeatures=ba;p.convertFromGeometry=function(a,b,c){if(v.isNone(a))return null;const d=new B;"hasZ"in a&&null==b&&(b=a.hasZ);"hasM"in a&&null==c&&(c=a.hasM);if(J.isPoint(a))return R(null!=b?b:
null!=a.z,null!=c?c:null!=a.m)(d,a);if(J.isPolygon(a))return aa(d,a,b,c);if(J.isPolyline(a))return Y(d,a,w(b,c));if(J.isMultipoint(a))return V(d,a,w(b,c));G.error("convertFromGeometry:unknown-geometry",new D(`Unable to parse unknown geometry type '${a}'`))};p.convertFromGraphics=function(a,b,c,d,e,f){const g=a.length;switch(c){case "esriGeometryPoint":S(a,b,d,e,f);break;case "esriGeometryMultipoint":U(a,b,d,e,f);break;case "esriGeometryPolyline":X(a,b,d,e,f);break;case "esriGeometryPolygon":la(a,
b,d,e,f);break;default:G.error("convertToFeatureSet:unknown-geometry",new D(`Unable to parse unknown geometry type '${c}'`))}for(d=0;d<b.length;d++)a[d+g].geometryType=c,a[d+g].insertAfter=b[d].insertAfter,a[d+g].groupId=b[d].groupId;return a};p.convertFromMultipoint=V;p.convertFromMultipointFeatures=U;p.convertFromNestedArray=ma;p.convertFromPoint=function(a,b,c=R(null!=b.z,null!=b.m)){return c(a,b)};p.convertFromPointFeatures=S;p.convertFromPolygon=aa;p.convertFromPolyline=Y;p.convertFromPolylineFeatures=
X;p.convertToFeature=function(a,b,c,d){I[0]=a;ca(H,I,b,c,d);a=H[0];z(H);z(I);return a};p.convertToFeatureSet=function(a){const {objectIdFieldName:b,spatialReference:c,transform:d,fields:e,hasM:f,hasZ:g,features:h,geometryType:k,exceededTransferLimit:m,uniqueIdField:l,queryGeometry:n,queryGeometryType:q}=a;a=ca([],h,k,g,f);const r=na(n,q,!1,!1);a={features:a,fields:e,geometryType:k,objectIdFieldName:b,spatialReference:c,uniqueIdField:l,queryGeometry:r};d&&(a.transform=d);m&&(a.exceededTransferLimit=
m);f&&(a.hasM=f);g&&(a.hasZ=g);return a};p.convertToFeatures=ca;p.convertToGeometry=na;p.convertToMultipoint=T;p.convertToMultipointFeatures=ka;p.convertToPoint=function(a,b,c){return a?b?c?Q(a):O(a):c?P(a):N(a):null};p.convertToPolygon=Z;p.convertToPolyline=W;p.deltaDecodeGeometry=function(a,b){if(v.isNone(a))return null;const c=a.clone(),d=a.coords;a=a.lengths;let e=0;for(let h=0;h<a.length;h++){const k=a[h];var f=d[b*e],g=d[b*e+1];for(let m=1;m<k;m++)f+=d[b*(e+m)],g+=d[b*(e+m)+1],c.coords[b*(e+
m)]=f,c.coords[b*(e+m)+1]=g;e+=k}return c};p.deltaEncodeGeometry=function(a,b){const c=a.clone(),d=a.coords;a=a.lengths;let e=0;for(let g=0;g<a.length;g++){const h=a[g];let k=d[b*e];var f=d[b*e+1];for(let m=1;m<h;m++){const l=d[b*(e+m)],n=d[b*(e+m)+1];f=n-f;c.coords[b*(e+m)]=l-k;c.coords[b*(e+m)+1]=f;k=l;f=n}e+=h}return c};p.generalizeOptimizedGeometry=function(a,b,c,d,e,f,g=c,h=d){A(a);if(!b||!b.coords.length)return null;e=ea[e];const {coords:k,lengths:m}=b;b=w(c,d);const l=w(c&&g,d&&h);c=K(c,d,
g,h);if(!m.length)return c(a.coords,k,0,0,k[0],k[1]),A(a,b,0),a;d=0;f*=f;for(const n of m){if(n<e){d+=n*b;continue}g=a.coords.length/l;h=d;const q=d+(n-1)*b;c(a.coords,k,a.coords.length,h,k[h],k[h+1]);fa(a.coords,k,b,f,c,h,q);c(a.coords,k,a.coords.length,q,k[q],k[q+1]);h=a.coords.length/l-g;h>=e?a.lengths.push(h):z(a.coords,g*l);d+=n*b}return a.coords.length?a:null};p.getBoundsOptimizedGeometry=function(a,b,c,d){if(v.isNone(b)||!b.coords||!b.coords.length)return null;c=w(c,d);let e=d=Number.POSITIVE_INFINITY,
f=Number.NEGATIVE_INFINITY,g=Number.NEGATIVE_INFINITY;if(b&&b.coords){b=b.coords;for(let h=0;h<b.length;h+=c){const k=b[h],m=b[h+1];d=Math.min(d,k);f=Math.max(f,k);e=Math.min(e,m);g=Math.max(g,m)}}a[0]=d;a[1]=e;a[2]=f;a[3]=g;return a};p.getQuantizedArea=function(a,b){const {coords:c,lengths:d}=a;let e=a=0;for(let f=0;f<d.length;f++){const g=d[f];e+=oa(c,a,g,b);a+=g}return Math.abs(e)};p.getQuantizedBoundsOptimizedGeometry=function(a,b,c,d){c=w(c,d);const {lengths:e,coords:f}=b;d=b=Number.POSITIVE_INFINITY;
let g=Number.NEGATIVE_INFINITY,h=Number.NEGATIVE_INFINITY,k=0;for(const m of e){let l=f[k],n=f[k+1];b=Math.min(l,b);d=Math.min(n,d);g=Math.max(l,g);h=Math.max(n,h);k+=c;for(let q=1;q<m;q++,k+=c){const r=f[k],u=f[k+1];l+=r;n+=u;0>r&&(b=Math.min(b,l));0<r&&(g=Math.max(g,l));0>u?d=Math.min(d,n):0<u&&(h=Math.max(h,n))}}a[0]=b;a[1]=d;a[2]=g;a[3]=h;return a};p.getSignedQuantizedRingArea=oa;p.quantizeOptimizedFeatureSet=function(a,b){const {geometryType:c,features:d,hasM:e,hasZ:f}=b;if(!a)return b;for(let g=
0;g<d.length;g++){const h=d[g],k=h.weakClone();k.geometry=new B;da(k.geometry,h.geometry,e,f,c,a);h.centroid&&(k.centroid=new B,da(k.centroid,h.centroid,e,f,"esriGeometryPoint",a));d[g]=k}b.transform=a;return b};p.quantizeOptimizedGeometry=da;p.quantizeX=L;p.quantizeY=M;p.removeCollinearVectices=function(a,b,c,d,e){if(!b||!b.coords||!b.coords.length)return null;c=ea[c];const {coords:f,lengths:g}=b;b=K(d,e,d,e);d=w(d,e);let h=e=0,k=0,m=0;for(const q of g){h=m;b(a.coords,f,h,e,f[e],f[e+1]);e+=d;var l=
f[e];let r=f[e+1],u=l,x=r;var n=r/l;h+=d;b(a.coords,f,h,e,u,x);e+=d;for(let t=2;t<q;t++){l=f[e];r=f[e+1];const y=r/l,C=n===y||!isFinite(n)&&!isFinite(y);n=C&&isFinite(y)?0<=n&&0<=y||0>=n&&0>=y:0<=x&&0<=r||0>=x&&0>=r;C&&n?(u+=l,x+=r):(u=l,x=r,h+=d);b(a.coords,f,h,e,u,x);e+=d;n=y}h+=d;l=(h-m)/d;l>=c&&(a.lengths[k]=l,m=h,k++)}a.coords.length>m&&(a.coords.length=m);a.lengths.length>k&&(a.lengths.length=k);return a.coords.length&&a.lengths.length?a:null};p.removeZMValues=function(a,b,c,d,e,f){A(a);a.lengths.push(...b.lengths);
if(c===e&&d===f)for(var g=0;g<b.coords.length;g++)a.coords.push(b.coords[g]);else for(g=w(c,d),c=K(c,d,e,f),b=b.coords,d=0;d<b.length;d+=g)c(a.coords,b,a.coords.length,d,b[d],b[d+1]);return a};p.unquantizeOptimizedFeatureSet=function(a){const {transform:b,features:c,hasM:d,hasZ:e}=a;if(!b)return a;for(const f of c)v.isSome(f.geometry)&&ha(f.geometry,f.geometry,d,e,b),v.isSome(f.centroid)&&ha(f.centroid,f.centroid,d,e,b);a.transform=null;return a};p.unquantizeOptimizedGeometry=ha;p.unquantizeValue=
F;p.unquantizeX=function(a,b){return F(a,b,0)};p.unquantizeY=function(a,b){return F(a,-b,1)};Object.defineProperties(p,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});