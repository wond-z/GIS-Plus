// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../../../chunks/_rollupPluginBabelHelpers ../../../../chunks/tslib.es6 ../../../../core/Error ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/urlUtils ../../../../core/accessorSupport/decorators/property ../../../../core/arrayUtils ../../../../core/accessorSupport/ensureType ../../../../core/accessorSupport/decorators/subclass ../../../../geometry/support/zscale ../../../support/StreamConnection".split(" "),function(m,p,v,h,g,r,y,A,
z,E,F,B,C,D){var n;(function(f){f[f.CONNECTING=0]="CONNECTING";f[f.OPEN=1]="OPEN";f[f.CLOSING=2]="CLOSING";f[f.CLOSED=3]="CLOSED"})(n||(n={}));m.WebSocketConnection=function(f){function t(c){var b=f.call(this)||this;b.errorString=null;const {geometryType:d,spatialReference:a,sourceSpatialReference:e}=c;b._config=c;b._featureZScaler=C.getGeometryZScaler(d,e,a);b._open();return b}p._inheritsLoose(t,f);var k=t.prototype;k._open=function(){var c=p._asyncToGenerator(function*(){yield this._tryCreateWebSocket();
this.destroyed||(yield this._handshake())});return function(){return c.apply(this,arguments)}}();k.destroy=function(){r.isSome(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close());this._websocket=null};k._tryCreateWebSocket=function(){var c=p._asyncToGenerator(function*(b=this._config.source.path,d=1E3,a=0){try{if(!this.destroyed){var e=A.addQueryParameters(b,this._config.customParameters);
this._websocket=yield this._createWebSocket(e);this.notifyChange("connectionStatus")}}catch(q){if(e=d/1E3,this._config.maxReconnectionAttempts&&a>=this._config.maxReconnectionAttempts)g.getLogger(this.declaredClass).error(new h("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),this.destroy();else return g.getLogger(this.declaredClass).error(new h("websocket-connection",`Failed to connect. Attempting to reconnect in ${e}s`,q)),yield y.after(d),this._tryCreateWebSocket(b,
Math.min(1.5*d,1E3*this._config.maxReconnectionInterval),a+1)}});return function(){return c.apply(this,arguments)}}();k._createWebSocket=function(c){return new Promise((b,d)=>{const a=new WebSocket(c);a.onopen=()=>{a.onopen=null;this.destroyed?(a.onclose=null,a.close()):(a.onclose=e=>this._onClose(e),a.onerror=e=>this._onError(e),a.onmessage=e=>this._onMessage(e),b(a))};a.onclose=e=>{a.onopen=a.onclose=null;d(e)}})};k._handshake=function(){var c=p._asyncToGenerator(function*(b=1E4){const d=this._websocket;
if(!r.isNone(d)){var a=y.createResolver(),e=d.onmessage,{filter:q,outFields:w,spatialReference:x}=this._config;a.timeout(b);d.onmessage=u=>{let l=null;try{l=JSON.parse(u.data)}catch(G){}l&&"object"===typeof l||(g.getLogger(this.declaredClass).error(new h("websocket-connection","Protocol violation. Handshake failed - malformed message",u.data)),a.reject(),this.destroy());l.spatialReference?.wkid!==x?.wkid&&(g.getLogger(this.declaredClass).error(new h("websocket-connection",`Protocol violation. Handshake failed - expected wkid of ${x.wkid}`,
u.data)),a.reject(),this.destroy());"json"!==l.format&&(g.getLogger(this.declaredClass).error(new h("websocket-connection","Protocol violation. Handshake failed - format is not set",u.data)),a.reject(),this.destroy());q&&l.filter!==q&&g.getLogger(this.declaredClass).error(new h("websocket-connection","Tried to set filter, but server doesn't support it"));w&&l.outFields!==w&&g.getLogger(this.declaredClass).error(new h("websocket-connection","Tried to set outFields, but server doesn't support it"));
d.onmessage=e;a.resolve()};d.send(JSON.stringify({filter:q,outFields:w,format:"json",spatialReference:{wkid:x.wkid}}));return a.promise}});return function(){return c.apply(this,arguments)}}();k._onMessage=function(c){try{const b=JSON.parse(c.data);if("featureResult"!==b.type)throw new h("websocket-connection","Protocol violation - Expected to find message of type 'featureResult'",b);for(const d of b.features)r.isSome(this._featureZScaler)&&this._featureZScaler(d.geometry),this.onFeature(d)}catch(b){g.getLogger(this.declaredClass).error(new h("websocket-connection",
"Failed to parse message",b)),this.destroy()}};k._onError=function(c){this._set("errorString","Encountered an error over WebSocket connection");g.getLogger(this.declaredClass).error("websocket-connection","Encountered an error over WebSocket connection")};k._onClose=function(c){this._websocket=null;this.notifyChange("connectionStatus");1E3!==c.code&&g.getLogger(this.declaredClass).error("websocket-connection",`WebSocket closed unexpectedly with error code ${c.code}`);this.destroyed||this._open()};
p._createClass(t,[{key:"connectionStatus",get:function(){if(r.isNone(this._websocket))return"disconnected";switch(this._websocket.readyState){case n.CONNECTING:case n.OPEN:return"connected";case n.CLOSING:case n.CLOSED:return"disconnected"}}}]);return t}(D);v.__decorate([z.property()],m.WebSocketConnection.prototype,"connectionStatus",null);v.__decorate([z.property()],m.WebSocketConnection.prototype,"errorString",void 0);m.WebSocketConnection=v.__decorate([B.subclass("esri.layers.graphics.sources.connections.WebSocketConnection")],
m.WebSocketConnection);Object.defineProperties(m,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});