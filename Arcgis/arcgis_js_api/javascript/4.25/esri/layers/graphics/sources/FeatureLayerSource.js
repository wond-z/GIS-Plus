// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("../../../chunks/_rollupPluginBabelHelpers ../../../chunks/tslib.es6 ../../../geometry ../../../Graphic ../../../request ../../../TimeExtent ../../../core/Error ../../../core/has ../../../core/jsonMap ../../../core/Loadable ../../../core/maybe ../../../core/object ../../../core/promiseUtils ../../../core/urlUtils ../../../core/accessorSupport/decorators/property ../../../core/arrayUtils ../../../core/accessorSupport/ensureType ../../../core/accessorSupport/decorators/subclass ../../../geometry/Extent ../../../geometry/support/jsonUtils ../assetEditingSupport ./support/clientSideDefaults ./support/QueryTask ../../support/arcgisLayerUrl ../../../rest/query/operations/editsZScale ../../../rest/query/operations/queryAttachments ../../../geometry/SpatialReference".split(" "),
function(k,A,z,H,v,I,y,E,F,J,t,K,L,B,C,Z,aa,M,N,O,P,Q,R,S,T,U,V){function G(x){return D.apply(this,arguments)}function D(){D=k._asyncToGenerator(function*(x){if("string"===typeof x){const w=B.dataComponents(x);return w?w:{data:x}}return new Promise((w,g)=>{const b=new FileReader;b.readAsDataURL(x);b.onload=()=>w(B.dataComponents(b.result));b.onerror=a=>g(a)})});return D.apply(this,arguments)}const W=new F.JSONMap({originalAndCurrentFeatures:"original-and-current-features",none:"none"}),X=new Set(["Feature Layer",
"Table"]),Y=new F.JSONMap({Started:"published",Publishing:"publishing",Stopped:"unavailable"});z=function(x){function w(){var b=x.apply(this,arguments)||this;b.type="feature-layer";b.refresh=L.debounce(k._asyncToGenerator(function*(){yield b.load();var a=b.sourceJSON.editingInfo?.lastEditDate;if(null==a)return{dataChanged:!0,updates:{}};try{yield b._fetchService(null)}catch{return{dataChanged:!0,updates:{}}}a=a!==b.sourceJSON.editingInfo?.lastEditDate;return{dataChanged:a,updates:a?{editingInfo:b.sourceJSON.editingInfo,
extent:b.sourceJSON.extent}:null}}));return b}k._inheritsLoose(w,x);var g=w.prototype;g.load=function(b){b=t.isSome(b)?b.signal:null;this.addResolvingPromise(this._fetchService(this.layer.sourceJSON,b));return Promise.resolve(this)};g.addAttachment=function(){var b=k._asyncToGenerator(function*(a,c){yield this.load();a=a.attributes[this.layer.objectIdField];const e=this.layer.parsedUrl.path+"/"+a+"/addAttachment",d=this._getLayerRequestOptions();c=this._getFormDataForAttachment(c,d.query);try{const f=
yield v(e,{body:c});return this._createFeatureEditResult(f.data.addAttachmentResult)}catch(f){throw this._createAttachmentErrorResult(a,f);}});return function(a,c){return b.apply(this,arguments)}}();g.updateAttachment=function(){var b=k._asyncToGenerator(function*(a,c,e){yield this.load();a=a.attributes[this.layer.objectIdField];const d=this.layer.parsedUrl.path+"/"+a+"/updateAttachment";c=this._getLayerRequestOptions({query:{attachmentId:c}});e=this._getFormDataForAttachment(e,c.query);try{const f=
yield v(d,{body:e});return this._createFeatureEditResult(f.data.updateAttachmentResult)}catch(f){throw this._createAttachmentErrorResult(a,f);}});return function(a,c,e){return b.apply(this,arguments)}}();g.applyEdits=function(){var b=k._asyncToGenerator(function*(a,c){yield this.load();const e=this.layer.infoFor3D;var d=t.isSome(e),f=d||c?.globalIdUsed,h=a.addFeatures.map(n=>this._serializeFeature(n,e)),l=a.updateFeatures.map(n=>this._serializeFeature(n,e));const p=this._getFeatureIds(a.deleteFeatures,
f);T.unapplyEditsZUnitScaling(h,l,this.layer.spatialReference);var r=[],u=[],m=[...a.deleteAttachments];for(const n of a.addAttachments)r.push(yield this._serializeAttachment(n));for(const n of a.updateAttachments)u.push(yield this._serializeAttachment(n));u=r.length||u.length||m.length?{adds:r,updates:u,deletes:m}:null;m=void 0;r=null;if(d){r=new Map;m=[];for(const n of a.addAssets)m.push(this._serializeAssetMapEditAndUploadAssets(n,r));a=yield Promise.all(m);m=a.length?{adds:a,updates:[],deletes:[]}:
void 0}a={gdbVersion:c?.gdbVersion||this.layer.gdbVersion,rollbackOnFailure:c?.rollbackOnFailureEnabled,useGlobalIds:f,returnEditMoment:c?.returnEditMoment,usePreviousEditMoment:c?.usePreviousEditMoment,sessionId:c?.sessionId};c?.returnServiceEditsOption?(a.edits=JSON.stringify([{id:this.layer.layerId,adds:h,updates:l,deletes:p,attachments:u,assetMaps:t.unwrap(m)}]),a.returnServiceEditsOption=W.toJSON(c?.returnServiceEditsOption),a.returnServiceEditsInSourceSR=c?.returnServiceEditsInSourceSR):(a.adds=
h.length?JSON.stringify(h):null,a.updates=l.length?JSON.stringify(l):null,a.deletes=p.length?f?JSON.stringify(p):p.join(","):null,a.attachments=u&&JSON.stringify(u),a.assetMaps=t.isSome(m)?JSON.stringify(m):void 0);h=this._getLayerRequestOptions({method:"post",query:a});f=c?.returnServiceEditsOption?this.layer.url:this.layer.parsedUrl.path;c=yield v(f+"/applyEdits",h);if(d&&null!=c.data&&null!=c.data.assetMaps){l=c.data;d=this.layer.objectIdField;h=[];for(var q of l.addResults)q.success&&h.push(q.objectId);
for(const n of l.updateResults)n.success&&h.push(n.objectId);q=this._createRequestQueryOptions();if((q=yield v(f+"/query",{...q,query:{f:"json",formatOf3DObjects:"3D_glb",where:`OBJECTID IN (${h.join(",")})`,outFields:`${d}`}}))&&q.data&&q.data.assetMaps&&t.isSome(r)){q=q.data.assetMaps;for(const n of q)q=r.get(n.parentGlobalId).geometry,t.isSome(q)&&"mesh"===q.type&&q.updateExternalSource({source:[{name:n.assetName,source:n.assetName}],extent:q.extent})}}return this._createEditsResult(c)});return function(a,
c){return b.apply(this,arguments)}}();g.deleteAttachments=function(){var b=k._asyncToGenerator(function*(a,c){yield this.load();a=a.attributes[this.layer.objectIdField];const e=this.layer.parsedUrl.path+"/"+a+"/deleteAttachments";try{return(yield v(e,this._getLayerRequestOptions({query:{attachmentIds:c.join(",")},method:"post"}))).data.deleteAttachmentResults.map(this._createFeatureEditResult)}catch(d){throw this._createAttachmentErrorResult(a,d);}});return function(a,c){return b.apply(this,arguments)}}();
g.fetchRecomputedExtents=function(b={}){var a=this;return this.load({signal:b.signal}).then(k._asyncToGenerator(function*(){var c=a._getLayerRequestOptions({...b,query:{returnUpdates:!0}});const {layerId:e,url:d}=a.layer;({data:c}=yield v(`${d}/${e}`,c));const {id:f,extent:h,fullExtent:l,timeExtent:p}=c;c=h||l;return{id:f,fullExtent:c&&N.fromJSON(c),timeExtent:p&&I.fromJSON({start:p[0],end:p[1]})}}))};g.queryAttachments=function(){var b=k._asyncToGenerator(function*(a,c={}){const {parsedUrl:e}=this.layer,
d=e.path;yield this.load();c=this._getLayerRequestOptions(c);if(!this.layer.get("capabilities.operations.supportsQueryAttachments")){const {objectIds:f}=a;a=[];for(const h of f)a.push(v(d+"/"+h+"/attachments",c));return Promise.all(a).then(h=>f.map((l,p)=>({parentObjectId:l,attachmentInfos:h[p].data.attachmentInfos}))).then(h=>U.processAttachmentQueryResult(h,d))}return this.queryTask.executeAttachmentQuery(a,c)});return function(a){return b.apply(this,arguments)}}();g.queryFeatures=function(){var b=
k._asyncToGenerator(function*(a,c){yield this.load();return this.queryTask.execute(a,{...c,query:this._createRequestQueryOptions(c)})});return function(a,c){return b.apply(this,arguments)}}();g.queryFeaturesJSON=function(){var b=k._asyncToGenerator(function*(a,c){yield this.load();return this.queryTask.executeJSON(a,{...c,query:this._createRequestQueryOptions(c)})});return function(a,c){return b.apply(this,arguments)}}();g.queryObjectIds=function(){var b=k._asyncToGenerator(function*(a,c){yield this.load();
return this.queryTask.executeForIds(a,{...c,query:this._createRequestQueryOptions(c)})});return function(a,c){return b.apply(this,arguments)}}();g.queryFeatureCount=function(){var b=k._asyncToGenerator(function*(a,c){yield this.load();return this.queryTask.executeForCount(a,{...c,query:this._createRequestQueryOptions(c)})});return function(a,c){return b.apply(this,arguments)}}();g.queryExtent=function(){var b=k._asyncToGenerator(function*(a,c){yield this.load();return this.queryTask.executeForExtent(a,
{...c,query:this._createRequestQueryOptions(c)})});return function(a,c){return b.apply(this,arguments)}}();g.queryRelatedFeatures=function(){var b=k._asyncToGenerator(function*(a,c){yield this.load();return this.queryTask.executeRelationshipQuery(a,{...c,query:this._createRequestQueryOptions(c)})});return function(a,c){return b.apply(this,arguments)}}();g.queryRelatedFeaturesCount=function(){var b=k._asyncToGenerator(function*(a,c){yield this.load();return this.queryTask.executeRelationshipQueryForCount(a,
{...c,query:this._createRequestQueryOptions(c)})});return function(a,c){return b.apply(this,arguments)}}();g.queryTopFeatures=function(){var b=k._asyncToGenerator(function*(a,c){yield this.load();return this.queryTask.executeTopFeaturesQuery(a,{...c,query:this._createRequestQueryOptions(c)})});return function(a,c){return b.apply(this,arguments)}}();g.queryTopObjectIds=function(){var b=k._asyncToGenerator(function*(a,c){yield this.load();return this.queryTask.executeForTopIds(a,{...c,query:this._createRequestQueryOptions(c)})});
return function(a,c){return b.apply(this,arguments)}}();g.queryTopExtents=function(){var b=k._asyncToGenerator(function*(a,c){yield this.load();return this.queryTask.executeForTopExtents(a,{...c,query:this._createRequestQueryOptions(c)})});return function(a,c){return b.apply(this,arguments)}}();g.queryTopCount=function(){var b=k._asyncToGenerator(function*(a,c){yield this.load();return this.queryTask.executeForTopCount(a,{...c,query:this._createRequestQueryOptions(c)})});return function(a,c){return b.apply(this,
arguments)}}();g.fetchPublishingStatus=function(){var b=k._asyncToGenerator(function*(){if(!S.isHostedAgolService(this.layer.url))return"unavailable";var a=B.join(this.layer.url,"status");a=yield v(a,{query:{f:"json"}});return Y.fromJSON(a.data.status)});return function(){return b.apply(this,arguments)}}();g._createRequestQueryOptions=function(b){b={...this.layer.customParameters,token:this.layer.apiKey,...b?.query};this.layer.datesInUnknownTimezone&&(b.timeReferenceUnknownClient=!0);return b};g._fetchService=
function(){var b=k._asyncToGenerator(function*(a,c){a||({data:a}=yield v(this.layer.parsedUrl.path,this._getLayerRequestOptions({query:E("featurelayer-advanced-symbols")?{returnAdvancedSymbols:!0}:{},signal:c})));this.sourceJSON=this._patchServiceJSON(a);a=a.type;if(!X.has(a))throw new y("feature-layer-source:unsupported-type",`Source type "${a}" is not supported`);});return function(a,c){return b.apply(this,arguments)}}();g._patchServiceJSON=function(b){if("Table"!==b.type&&b.geometryType&&!b?.drawingInfo?.renderer&&
!b.defaultSymbol){const a=Q.createDrawingInfo(b.geometryType).renderer;K.setDeepValue("drawingInfo.renderer",a,b)}"esriGeometryMultiPatch"===b.geometryType&&b.infoFor3D&&(b.geometryType="mesh");return b};g._serializeFeature=function(b,a){const {geometry:c,attributes:e}=b;if(t.isSome(a)&&t.isSome(b.geometry)&&"mesh"===b.geometry.type){const f={...e};b=b.geometry;var d=b.origin;b=b.transform;f[a.transformFieldRoles.originX]=d.x;f[a.transformFieldRoles.originY]=d.y;f[a.transformFieldRoles.originZ]=d.z;
if(t.isSome(b)){d=b.translation;const h=b.scale;b=b.rotation;f[a.transformFieldRoles.translationX]=d[0];f[a.transformFieldRoles.translationY]=d[1];f[a.transformFieldRoles.translationZ]=d[2];f[a.transformFieldRoles.scaleX]=h[0];f[a.transformFieldRoles.scaleY]=h[1];f[a.transformFieldRoles.scaleZ]=h[2];f[a.transformFieldRoles.rotationX]=b[0];f[a.transformFieldRoles.rotationY]=b[1];f[a.transformFieldRoles.rotationZ]=b[2];f[a.transformFieldRoles.rotationDeg]=b[3]}return{geometry:null,attributes:f}}return t.isNone(c)?
{attributes:e}:"mesh"===c.type||"extent"===c.type?null:{geometry:c.toJSON(),attributes:e}};g._serializeAttachment=function(){var b=k._asyncToGenerator(function*(a){const {feature:c,attachment:e}=a,{globalId:d,name:f,contentType:h,data:l,uploadId:p}=e;a={globalId:d,parentGlobalId:null,contentType:null,name:null,uploadId:null,data:null};c&&(a.parentGlobalId="attributes"in c?c.attributes&&c.attributes[this.layer.globalIdField]:c.globalId);if(p)a.uploadId=p;else if(l){const r=yield G(l);a.contentType=
r.mediaType;a.data=r.data;l instanceof File&&(a.name=l.name)}f&&(a.name=f);h&&(a.contentType=h);return a});return function(a){return b.apply(this,arguments)}}();g._serializeAssetMapEditAndUploadAssets=function(){var b=k._asyncToGenerator(function*(a,c){var e=this.layer.url,d=null;try{const f=new Blob([a.data],{type:a.mimeType}),h=new FormData;h.append("f","json");h.append("file",f,`${a.assetName}`);const {data:l}=yield v(`${e}/uploads/upload`,{body:h,method:"post",responseType:"json"});if(!l.success)throw new y("feature-layer-source:upload-failure",
"Expected upload to be successfull.");d={assetType:a.assetType,assetUploadId:l.item.itemID}}catch(f){d=null}if(t.isNone(d)){e=yield G(new Blob([a.data]));if(!e.isBase64)throw new y("feature-layer-source:uploadAssets-failure","Expected gltf data in base64 format after conversion.");d={assetType:a.assetType,assetData:e.data}}if(t.isNone(d))throw new y("feature-layer-source:uploadAssets-failure","Unable to prepare uploadAsset request options.");e={method:"post",query:{f:"json",assets:JSON.stringify([d])},
responseType:"json"};e=yield v(B.join(this.layer.parsedUrl.path,"uploadAssets"),e);if(1!==e.data.uploadResults.length||!e.data.uploadResults[0].success)throw new y("feature-layer-source:uploadAssets-failure","Bad response.");e=e.data.uploadResults[0].assetHash;d=[];a.flags&P.AssetMapEditFlags.PROJECT_VERTICES&&d.push("PROJECT_VERTICES");e={globalId:a.assetMapGlobalId,parentGlobalId:a.featureGlobalId,assetName:a.assetName,assetHash:e,flags:d};c.set(a.featureGlobalId,a.feature);return e});return function(a,
c){return b.apply(this,arguments)}}();g._getFeatureIds=function(b,a){const c=b[0];return c?this._canUseGlobalIds(a,b)?this._getGlobalIdsFromFeatureIdentifier(b):"objectId"in c?this._getObjectIdsFromFeatureIdentifier(b):this._getIdsFromFeatures(b):[]};g._getIdsFromFeatures=function(b){const a=this.layer.objectIdField;return b.map(c=>c.attributes&&c.attributes[a])};g._canUseGlobalIds=function(b,a){return b&&"globalId"in a[0]};g._getObjectIdsFromFeatureIdentifier=function(b){return b.map(a=>a.objectId)};
g._getGlobalIdsFromFeatureIdentifier=function(b){return b.map(a=>a.globalId)};g._createEditsResult=function(b){const a=b.data,{layerId:c}=this.layer;b=[];let e=null;if(Array.isArray(a))for(var d of a)b.push({id:d.id,editedFeatures:d.editedFeatures}),d.id===c&&(e={addResults:d.addResults,updateResults:d.updateResults,deleteResults:d.deleteResults,attachments:d.attachments,editMoment:d.editMoment});else e=a;d=e?.attachments;d={addFeatureResults:e.addResults?e.addResults.map(this._createFeatureEditResult,
this):[],updateFeatureResults:e.updateResults?e.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:e.deleteResults?e.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:d&&d.addResults?d.addResults.map(this._createFeatureEditResult,this):[],updateAttachmentResults:d&&d.updateResults?d.updateResults.map(this._createFeatureEditResult,this):[],deleteAttachmentResults:d&&d.deleteResults?d.deleteResults.map(this._createFeatureEditResult,this):[]};e.editMoment&&
(d.editMoment=e.editMoment);if(0<b.length){d.editedFeatureResults=[];for(const f of b){const {adds:h,updates:l,deletes:p,spatialReference:r}=f.editedFeatures,u=r?new V(r):null;d.editedFeatureResults.push({layerId:f.id,editedFeatures:{adds:h?.map(m=>this._createEditedFeature(m,u))||[],updates:l?.map(m=>({original:this._createEditedFeature(m[0],u),current:this._createEditedFeature(m[1],u)}))||[],deletes:p?.map(m=>this._createEditedFeature(m,u))||[],spatialReference:u}})}}return d};g._createEditedFeature=
function(b,a){return new H({attributes:b.attributes,geometry:O.fromJSON({...b.geometry,spatialReference:a})})};g._createFeatureEditResult=function(b){const a=!0===b.success?null:b.error||{code:void 0,description:void 0};return{objectId:b.objectId,globalId:b.globalId,error:a?new y("feature-layer-source:edit-failure",a.description,{code:a.code}):null}};g._createAttachmentErrorResult=function(b,a){return{objectId:b,globalId:null,error:new y("feature-layer-source:attachment-failure",a.details.messages&&
a.details.messages[0]||a.message,{code:a.details.httpStatus||a.details.messageCode})}};g._getFormDataForAttachment=function(b,a){if(b=b instanceof FormData?b:b&&b.elements?new FormData(b):null)for(const c in a){const e=a[c];null!=e&&(b.set?b.set(c,e):b.append(c,e))}return b};g._getLayerRequestOptions=function(b={}){const {parsedUrl:a,gdbVersion:c,dynamicDataSource:e}=this.layer;return{...b,query:{gdbVersion:c,layer:e?JSON.stringify({source:e}):void 0,...a.query,f:"json",...this._createRequestQueryOptions(b)},
responseType:"json"}};k._createClass(w,[{key:"queryTask",get:function(){const {capabilities:{query:{supportsFormatPBF:b}},parsedUrl:a,dynamicDataSource:c,infoFor3D:e,gdbVersion:d,spatialReference:f,fieldsIndex:h}=this.layer,l=E("featurelayer-pbf")&&b&&t.isNone(e)?"pbf":"json";return new R({url:a.path,format:l,fieldsIndex:h,infoFor3D:e,dynamicDataSource:c,gdbVersion:d,sourceSpatialReference:f})}}]);return w}(J);A.__decorate([C.property()],z.prototype,"type",void 0);A.__decorate([C.property({constructOnly:!0})],
z.prototype,"layer",void 0);A.__decorate([C.property({readOnly:!0})],z.prototype,"queryTask",null);return z=A.__decorate([M.subclass("esri.layers.graphics.sources.FeatureLayerSource")],z)});