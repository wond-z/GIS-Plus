// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("require exports ../../../chunks/_rollupPluginBabelHelpers ../../../core/maybe ../../../geometry/support/centroid ../../../geometry/support/extentUtils ../../../geometry/support/quantizationUtils ../../../geometry/support/spatialReferenceUtils ./AttributesBuilder ./projectionSupport ./SnappingCandidate ./utils ../../support/fieldUtils ../../../statistics/utils ../../../support/arcadeOnDemand".split(" "),function(ba,G,C,N,S,O,T,P,M,U,V,F,W,A,ca){function da(v,m,c,a){const b=a.x-c.x;a=a.y-c.y;
m=Math.min(1,Math.max(0,((m.x-c.x)*b+(m.y-c.y)*a)/(b*b+a*a)));v.x=c.x+b*m;v.y=c.y+a*m}function X(v,m){return v?m?4:3:m?3:2}let ia=function(){function v(c,a,b){this.items=c;this.query=a;this.geometryType=b.geometryType;this.hasM=b.hasM;this.hasZ=b.hasZ;this.fieldsIndex=b.fieldsIndex;this.objectIdField=b.objectIdField;this.spatialReference=b.spatialReference;this.featureAdapter=b.featureAdapter}var m=v.prototype;m.createQueryResponseForCount=function(){const c=new M(this.query,this.featureAdapter,this.fieldsIndex);
if(!this.query.outStatistics)return c.countDistinctValues(this.items);const {groupByFieldsForStatistics:a,having:b,outStatistics:h}=this.query;if(!a?.length)return 1;const d=new Map,f=new Map,l=new Set;for(const k of h){var {statisticType:g}=k;g="exceedslimit"!==g?k.onStatisticField:void 0;if(!f.has(g)){var e=[];for(const n of a){const p=this._getAttributeValues(c,n,d);e.push(p)}f.set(g,this._calculateUniqueValues(e,c.returnDistinctValues))}g=f.get(g);for(const n in g){const {data:p,items:q}=g[n];
e=p.join(",");b&&!c.validateItems(q,b)||l.add(e)}}return l.size};m.createQueryResponse=function(){var c=C._asyncToGenerator(function*(){let a;a=this.query.outStatistics?this.query.outStatistics.some(b=>"exceedslimit"===b.statisticType)?this._createExceedsLimitQueryResponse(this.query):yield this._createStatisticsQueryResponse(this.query):this._createFeatureQueryResponse(this.query);this.query.returnQueryGeometry&&(P.isValid(this.query.outSR)&&!P.equals(this.query.geometry.spatialReference,this.query.outSR)?
a.queryGeometry=F.cleanFromGeometryEngine({spatialReference:this.query.outSR,...U.project(this.query.geometry,this.query.geometry.spatialReference,this.query.outSR)}):a.queryGeometry=F.cleanFromGeometryEngine({spatialReference:this.query.outSR,...this.query.geometry}));return a});return function(){return c.apply(this,arguments)}}();m.createSnappingResponse=function(c,a){const b=this.featureAdapter,h=X(this.hasZ,this.hasM),{point:d}=c,f="number"===typeof c.distance?c.distance:c.distance.x,l="number"===
typeof c.distance?c.distance:c.distance.y,g={candidates:[]},e="esriGeometryPolygon"===this.geometryType;a=this._getPointCreator(d,null!=d.z,null!=d.m,this.spatialReference,a);const k=new Y(null,0),n=new Y(null,0),p={x:0,y:0,z:0};for(const y of this.items){var q=b.getGeometry(y);if(N.isNone(q))continue;const {coords:t,lengths:E}=q;k.coords=t;n.coords=t;if(c.types&G.SnappingTypes.EDGE){q=0;for(var u=0;u<E.length;u++){var z=E[u];for(var x=0;x<z;x++,q+=h){var r=k;r.coordsIndex=q;if(x!==z-1){const B=n;
B.coordsIndex=q+h;const D=p;da(p,d,r,B);var w=(d.x-D.x)/f;const J=(d.y-D.y)/l;w=w*w+J*J;1>=w&&g.candidates.push(V.makeEdgeCandidate(b.getObjectId(y),a(D),Math.sqrt(w),a(r),a(B)))}}}}if(c.types&G.SnappingTypes.VERTEX)for(q=e?t.length-h:t.length,u=0;u<q;u+=h)z=k,z.coordsIndex=u,x=(d.x-z.x)/f,r=(d.y-z.y)/l,x=x*x+r*r,1>=x&&g.candidates.push(V.makeVertexCandidate(b.getObjectId(y),a(z),Math.sqrt(x)))}g.candidates.sort((y,t)=>y.distance-t.distance);return g};m._getPointCreator=function(c,a,b,h,d){const f=
N.isSome(d)&&!P.equals(h,d)?e=>U.project(e,h,d):e=>e,{hasZ:l}=this,g=c.m;return a&&b?l?({x:e,y:k,z:n})=>f({x:e,y:k,z:n,m:g}):({x:e,y:k})=>f({x:e,y:k,z:0,m:g}):a?l?({x:e,y:k,z:n})=>f({x:e,y:k,z:n}):({x:e,y:k})=>f({x:e,y:k,z:0}):b?({x:e,y:k})=>f({x:e,y:k,m:g}):({x:e,y:k})=>f({x:e,y:k})};m.createSummaryStatisticsResponse=function(){var c=C._asyncToGenerator(function*(a){const {field:b,valueExpression:h,normalizationField:d,normalizationType:f,normalizationTotal:l,minValue:g,maxValue:e,scale:k}=a;a=this.fieldsIndex.isDateField(b);
var n=yield this._getDataValues({field:b,valueExpression:h,normalizationField:d,normalizationType:f,normalizationTotal:l,scale:k});const p=A.isNullCountSupported({normalizationType:f,normalizationField:d,minValue:g,maxValue:e}),q=this.fieldsIndex.get(b),u={value:.5,fieldType:q?.type};n=W.isStringField(q)?A.calculateStringStatistics({values:n,supportsNullCount:p,percentileParams:u}):A.calculateStatistics({values:n,minValue:g,maxValue:e,useSampleStdDev:!f,supportsNullCount:p,percentileParams:u});return A.processSummaryStatisticsResult(n,
a)});return function(a){return c.apply(this,arguments)}}();m.createUniqueValuesResponse=function(){var c=C._asyncToGenerator(function*(a){const {field:b,valueExpression:h,domains:d,returnAllCodedValues:f,scale:l}=a;var g=yield this._getDataValues({field:b,field2:a.field2,field3:a.field3,fieldDelimiter:a.fieldDelimiter,valueExpression:h,scale:l});g=A.calculateUniqueValuesCount(g);return A.createUVResult(g,d,f,a.fieldDelimiter)});return function(a){return c.apply(this,arguments)}}();m.createClassBreaksResponse=
function(){var c=C._asyncToGenerator(function*(a){const {field:b,valueExpression:h,normalizationField:d,normalizationType:f,normalizationTotal:l,classificationMethod:g,standardDeviationInterval:e,minValue:k,maxValue:n,numClasses:p,scale:q}=a;a=yield this._getDataValues({field:b,valueExpression:h,normalizationField:d,normalizationType:f,normalizationTotal:l,scale:q});a=A.calculateClassBreaks(a,{field:b,normalizationField:d,normalizationType:f,normalizationTotal:l,classificationMethod:g,standardDeviationInterval:e,
minValue:k,maxValue:n,numClasses:p});return A.resolveCBResult(a,g)});return function(a){return c.apply(this,arguments)}}();m.createHistogramResponse=function(){var c=C._asyncToGenerator(function*(a){const {field:b,valueExpression:h,normalizationField:d,normalizationType:f,normalizationTotal:l,classificationMethod:g,standardDeviationInterval:e,minValue:k,maxValue:n,numBins:p,scale:q}=a;a=yield this._getDataValues({field:b,valueExpression:h,normalizationField:d,normalizationType:f,normalizationTotal:l,
scale:q});return A.calculateHistogram(a,{field:b,normalizationField:d,normalizationType:f,normalizationTotal:l,classificationMethod:g,standardDeviationInterval:e,minValue:k,maxValue:n,numBins:p})});return function(a){return c.apply(this,arguments)}}();m._sortFeatures=function(c,a,b){if(1<c.length&&a&&a.length)for(const h of a.reverse()){a=h.split(" ");const d=a[0],f=this.fieldsIndex.get(d);a=a[1]&&"desc"===a[1].toLowerCase();const l=A.getAttributeComparator(f?.type,a);c.sort((g,e)=>{g=b(g,d,f);e=
b(e,d,f);return l(g,e)})}};m._createFeatureQueryResponse=function(c){const a=this.items,{geometryType:b,hasM:h,hasZ:d,objectIdField:f,spatialReference:l}=this,{outFields:g,outSR:e,quantizationParameters:k,resultRecordCount:n,resultOffset:p,returnZ:q,returnM:u}=c,z=null!=n?a.length>(p||0)+n:!1,x=g&&(g.includes("*")?[...this.fieldsIndex.fields]:g.map(r=>this.fieldsIndex.get(r)));return{exceededTransferLimit:z,features:this._createFeatures(c,a),fields:x,geometryType:b,hasM:h&&u,hasZ:d&&q,objectIdFieldName:f,
spatialReference:F.cleanFromGeometryEngine(e?e:l),transform:k&&T.toQuantizationTransform(k)||null}};m._createFeatures=function(c,a){const b=new M(c,this.featureAdapter,this.fieldsIndex),{hasM:h,hasZ:d}=this,{orderByFields:f,quantizationParameters:l,returnGeometry:g,returnCentroid:e,maxAllowableOffset:k,resultOffset:n,resultRecordCount:p,returnZ:q=!1,returnM:u=!1}=c,z=d&&q,x=h&&u;c=[];var r=0;a=[...a];this._sortFeatures(a,f,(t,E,B)=>b.getFieldValue(t,E,B));if(g||e){var w=T.toQuantizationTransform(l);
if(g&&!e)for(var y of a)c[r++]={attributes:b.getAttributes(y),geometry:F.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(y),k,w,z,x)};else if(!g&&e)for(const t of a)c[r++]={attributes:b.getAttributes(t),centroid:F.transformCentroid(this,this.featureAdapter.getCentroid(t,this),w)};else for(const t of a)c[r++]={attributes:b.getAttributes(t),centroid:F.transformCentroid(this,this.featureAdapter.getCentroid(t,this),w),geometry:F.getGeometry(this.geometryType,this.hasZ,
this.hasM,this.featureAdapter.getGeometry(t),k,w,z,x)}}else for(w of a)(y=b.getAttributes(w))&&(c[r++]={attributes:y});r=n||0;null!=p&&(c=c.slice(r,Math.min(c.length,r+p)));return c};m._createExceedsLimitQueryResponse=function(c){var a=!1;let b=Number.POSITIVE_INFINITY,h=Number.POSITIVE_INFINITY;a=Number.POSITIVE_INFINITY;for(const d of c.outStatistics)if("exceedslimit"===d.statisticType){b=null!=d.maxPointCount?d.maxPointCount:Number.POSITIVE_INFINITY;h=null!=d.maxRecordCount?d.maxRecordCount:Number.POSITIVE_INFINITY;
a=null!=d.maxVertexCount?d.maxVertexCount:Number.POSITIVE_INFINITY;break}if("esriGeometryPoint"===this.geometryType)a=this.items.length>b;else if(this.items.length>h)a=!0;else{c=X(this.hasZ,this.hasM);const d=this.featureAdapter;a=this.items.reduce((f,l)=>{l=d.getGeometry(l);return f+(N.isSome(l)&&l.coords.length||0)},0)/c>a}return{fields:[{name:"exceedslimit",type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(a)}}]}};
m._createStatisticsQueryResponse=function(){var c=C._asyncToGenerator(function*(a){var b={attributes:{}};const h=[],d=new Map,f=new Map,l=new Map,g=new Map,e=new M(a,this.featureAdapter,this.fieldsIndex);var k=a.outStatistics;const {groupByFieldsForStatistics:n,having:p,orderByFields:q}=a;a=n&&n.length;const u=!!a,z=u&&n[0],x=u&&!this.fieldsIndex.get(z);for(const E of k){const {outStatisticFieldName:B,statisticType:D}=E;k=E;var r="exceedslimit"!==D?E.onStatisticField:void 0;const J="percentile_disc"===
D||"percentile_cont"===D,Q="EnvelopeAggregate"===D||"CentroidAggregate"===D||"ConvexHullAggregate"===D,ea=u&&1===a&&(r===z||x)&&"count"===D;if(u){if(!l.has(r)){var w=[];for(const K of n){var y=this._getAttributeValues(e,K,d);w.push(y)}l.set(r,this._calculateUniqueValues(w,Q?!1:e.returnDistinctValues))}w=l.get(r);for(const K in w){const {count:R,data:Z,items:aa,itemPositions:fa}=w[K];y=Z.join(",");if(!p||e.validateItems(aa,p)){const H=g.get(y)||{attributes:{}};if(Q){H.aggregateGeometries||(H.aggregateGeometries=
{});const {aggregateGeometries:I,outStatisticFieldName:L}=yield this._getAggregateGeometry(k,aa);H.aggregateGeometries[L]=I}else{var t=null;if(ea)t=R;else{const I=this._getAttributeValues(e,r,d);t=fa.map(L=>I[L]);t=J&&"statisticParameters"in k?this._getPercentileValue(k,t):this._getStatisticValue(k,t,null,e.returnDistinctValues)}H.attributes[B]=t}let ha=0;n.forEach((I,L)=>H.attributes[this.fieldsIndex.get(I)?I:`EXPR_${++ha}`]=Z[L]);g.set(y,H)}}}else if(Q){b.aggregateGeometries||(b.aggregateGeometries=
{});const {aggregateGeometries:K,outStatisticFieldName:R}=yield this._getAggregateGeometry(k,this.items);b.aggregateGeometries[R]=K}else r=this._getAttributeValues(e,r,d),b.attributes[B]=J&&"statisticParameters"in k?this._getPercentileValue(k,r):this._getStatisticValue(k,r,f,e.returnDistinctValues);h.push({name:B,alias:B,type:"esriFieldTypeDouble"})}b=u?Array.from(g.values()):[b];this._sortFeatures(b,q,(E,B)=>E.attributes[B]);return{fields:h,features:b}});return function(a){return c.apply(this,arguments)}}();
m._getAggregateGeometry=function(){var c=C._asyncToGenerator(function*(a,b){var h=yield new Promise((q,u)=>ba(["../../../geometry/geometryEngineJSON"],q,u));const {statisticType:d,outStatisticFieldName:f}=a,{featureAdapter:l,spatialReference:g,geometryType:e,hasZ:k,hasM:n}=this;b=b.map(q=>F.getGeometry(e,k,n,l.getGeometry(q)));const p=h.convexHull(g,b,!0)[0];a={aggregateGeometries:null,outStatisticFieldName:null};"EnvelopeAggregate"===d?(h=p?O.getPolygonExtent(p):O.getGeometryExtent(h.union(g,b)),
a.aggregateGeometries={...h,spatialReference:g},a.outStatisticFieldName=f||"extent"):"CentroidAggregate"===d?(h=p?S.polygonCentroid(p):S.extentCentroid(O.getGeometryExtent(h.union(g,b))),a.aggregateGeometries={x:h[0],y:h[1],spatialReference:g},a.outStatisticFieldName=f||"centroid"):"ConvexHullAggregate"===d&&(a.aggregateGeometries=p,a.outStatisticFieldName=f||"convexHull");return a});return function(a,b){return c.apply(this,arguments)}}();m._getStatisticValue=function(c,a,b,h){const {onStatisticField:d,
statisticType:f}=c;c=null;c=b?.has(d)?b.get(d):W.isStringField(this.fieldsIndex.get(d))?A.calculateStringStatistics({values:a,returnDistinct:h}):A.calculateStatistics({values:a,minValue:null,maxValue:null,useSampleStdDev:!0});b&&b.set(d,c);return c["var"===f?"variance":f]};m._getPercentileValue=function(c,a){const {onStatisticField:b,statisticParameters:h,statisticType:d}=c,{value:f,orderBy:l}=h;c=this.fieldsIndex.get(b);return A.calculatePercentile(a,{value:f,orderBy:l,fieldType:c?.type,isDiscrete:"percentile_disc"===
d})};m._getAttributeValues=function(c,a,b){if(b.has(a))return b.get(a);const h=this.fieldsIndex.get(a),d=this.items.map(f=>c.getFieldValue(f,a,h));b.set(a,d);return d};m._getAttributeDataValues=function(c,a){return this.items.map(b=>c.getDataValue(b,{field:a.field,field2:a.field2,field3:a.field3,fieldDelimiter:a.fieldDelimiter,normalizationField:a.normalizationField,normalizationType:a.normalizationType,normalizationTotal:a.normalizationTotal}))};m._getAttributeExpressionValues=function(){var c=C._asyncToGenerator(function*(a,
b,h){const {arcadeUtils:d}=yield ca.loadArcade();b=d.createFunction(b);h=h&&d.getViewInfo(h);return a.getExpressionValues(this.items,b,h,d)});return function(a,b,h){return c.apply(this,arguments)}}();m._calculateUniqueValues=function(c,a){const b={},h=this.items,d=h.length;for(let f=0;f<d;f++){const l=h[f],g=[];for(const k of c)g.push(k[f]);const e=g.join(",");a?null==b[e]&&(b[e]={count:1,data:g,items:[l],itemPositions:[f]}):null==b[e]?b[e]={count:1,data:g,items:[l],itemPositions:[f]}:(b[e].count++,
b[e].items.push(l),b[e].itemPositions.push(f))}return b};m._getDataValues=function(){var c=C._asyncToGenerator(function*(a){const b=new M(this.query,this.featureAdapter,this.fieldsIndex),{valueExpression:h,field:d,normalizationField:f,normalizationType:l,normalizationTotal:g,scale:e}=a,k=h?{viewingMode:"map",scale:e,spatialReference:this.query.outSR||this.spatialReference}:null;return h?this._getAttributeExpressionValues(b,h,k):this._getAttributeDataValues(b,{field:d,field2:a.field2,field3:a.field3,
fieldDelimiter:a.fieldDelimiter,normalizationField:f,normalizationType:l,normalizationTotal:g})});return function(a){return c.apply(this,arguments)}}();C._createClass(v,[{key:"size",get:function(){return this.items.length}}]);return v}();G.SnappingTypes=void 0;(function(v){v[v.NONE=0]="NONE";v[v.EDGE=1]="EDGE";v[v.VERTEX=2]="VERTEX"})(G.SnappingTypes||(G.SnappingTypes={}));let Y=function(){function v(m,c){this.coords=m;this.coordsIndex=c}C._createClass(v,[{key:"x",get:function(){return this.coords[this.coordsIndex]}},
{key:"y",get:function(){return this.coords[this.coordsIndex+1]}},{key:"z",get:function(){return this.coords[this.coordsIndex+2]}}]);return v}();G.QueryEngineResult=ia;Object.defineProperties(G,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});