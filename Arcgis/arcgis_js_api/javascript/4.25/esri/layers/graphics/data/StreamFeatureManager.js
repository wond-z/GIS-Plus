// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define(["exports","../../../core/CircularArray","../../../core/mathUtils","../../../core/maybe"],function(h,k,m,d){let n=function(){function l(a,b,c,e,g=128){this._trackIdToObservations=new Map;this._idCounter=0;this._lastPurge=performance.now();this._addOrUpdated=new Map;this._removed=[];this._maxAge=0;this._timeInfo=c;this._purgeOptions=e;this.store=a;this.objectIdField=b;this.purgeInterval=g;this._useGeneratedIds="__esri_stream_id__"===this.objectIdField}var f=l.prototype;f.add=function(a){if(this._useGeneratedIds){var b=
this._nextId();a.attributes[this.objectIdField]=b;a.objectId=b}else a.objectId=a.attributes[this.objectIdField];this._addOrUpdated.set(a.objectId,a);this._maxAge=Math.max(this._maxAge,a.attributes[this._timeInfo.startTimeField]);if(this._timeInfo.trackIdField){b=a.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(b)){var c=d.isSome(this._purgeOptions)&&null!=this._purgeOptions.maxObservations?this._purgeOptions.maxObservations:1E3;c=m.clamp(c,0,1E3);this._trackIdToObservations.set(b,
new k(c))}a=this._trackIdToObservations.get(b).enqueue(a.objectId);d.isSome(a)&&(this._addOrUpdated.has(a)?this._addOrUpdated.delete(a):this._removed.push(a))}else d.isNone(this._trackIdLessObservations)&&(this._trackIdLessObservations=new k(1E5)),this._trackIdLessObservations.enqueue(a.objectId)};f.checkForUpdates=function(){const a=this._getToAdd();var b=this._getToRemove();const c=performance.now();c-this._lastPurge>=this.purgeInterval&&(this._purge(c),this._lastPurge=c);const e=[];if(d.isSome(b))for(const g of b)b=
this.store.removeById(g),d.isSome(b)&&e.push(b);if(d.isSome(a))for(const g of a)g.attributes.__esri_timestamp__=c,this.store.add(g);(a||e?.length)&&this.store.update(a,e)};f._getToAdd=function(){if(!this._addOrUpdated.size)return null;const a=Array(this._addOrUpdated.size);let b=0;this._addOrUpdated.forEach(c=>a[b++]=c);this._addOrUpdated.clear();return a};f._getToRemove=function(){const a=this._removed;if(!this._removed.length)return null;this._removed=[];return a};f._nextId=function(){const a=this._idCounter;
this._idCounter=(this._idCounter+1)%4294967294+1;return a};f._purge=function(a){const b=this._purgeOptions;d.isSome(b)&&(this._purgeSomeByDisplayCount(b),this._purgeByAge(b),this._purgeByAgeReceived(a,b),this._purgeTracks())};f._purgeSomeByDisplayCount=function(a){if(a.displayCount){var b=this.store.size;if(b>a.displayCount){if(this._timeInfo.trackIdField)for(const c of this._trackIdToObservations.values())if(b>a.displayCount&&c.size){const e=d.unwrap(c.dequeue());this._removed.push(e);b--}if(d.isSome(this._trackIdLessObservations))for(a=
b-a.displayCount;0<a--;)b=this._trackIdLessObservations.dequeue(),d.isSome(b)&&this._removed.push(b)}}};f._purgeByAge=function(a){if(a.age&&this._timeInfo?.startTimeField){var b=this._maxAge-6E4*a.age;this.store.forEach(c=>{c.attributes[this._timeInfo.startTimeField]<b&&this._removed.push(c.objectId)})}};f._purgeByAgeReceived=function(a,b){if(b.ageReceived){var c=a-6E4*b.ageReceived;this.store.forEach(e=>{e.attributes.__esri_timestamp__<c&&this._removed.push(e.objectId)})}};f._purgeTracks=function(){this._trackIdToObservations.forEach((a,
b)=>{0===a.size&&this._trackIdToObservations.delete(b)})};return l}();h.DEFAULT_STREAM_ID_FIELD="__esri_stream_id__";h.ESRI_TIMESTAMP="__esri_timestamp__";h.StreamFeatureManager=n;Object.defineProperties(h,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});