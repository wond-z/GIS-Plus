// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("require ../chunks/_rollupPluginBabelHelpers ../chunks/tslib.es6 ../core/Collection ../core/Error ../core/HandleOwner ../core/Handles ../core/maybe ../core/MultiOriginJSONSupport ../core/promiseUtils ../core/reactiveUtils ../core/sql ../core/urlUtils ../core/accessorSupport/decorators/property ../core/arrayUtils ../core/accessorSupport/ensureType ../core/accessorSupport/decorators/reader ../core/accessorSupport/decorators/subclass ../core/accessorSupport/PropertyOrigin ./Layer ./mixins/APIKeyMixin ./mixins/ArcGISService ./mixins/BlendLayer ./mixins/CustomParametersMixin ./mixins/EditBusLayer ./mixins/FeatureLayerBase ./mixins/OperationalLayer ./mixins/PortalLayer ./mixins/RefreshableLayer ./mixins/ScaleRangeLayer ./mixins/TemporalLayer ./support/arcgisLayerUrl ./support/commonProperties ./support/featureLayerUtils ./support/fieldProperties ./support/fieldUtils ./support/Subtype ./support/SubtypeSublayer ./support/TimeInfo ./support/versionUtils ../rest/support/Query".split(" "),
function(C,f,g,v,q,e,D,w,E,y,z,F,A,l,t,ca,G,H,x,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,m,W,X,Y,u,Z,aa,ba){function B(h,n){return new q("layer:unsupported",`Layer (${h.title}, ${h.id}) of type '${h.declaredClass}' ${n}`,{layer:h})}t=W.defineFieldProperties();e=function(h){function n(...b){var a=h.call(this,...b)||this;a._handles=new D;a._sublayersCollectionChanged=!1;a.fields=null;a.fieldsIndex=null;a.outFields=null;a.subtypes=null;a.sublayers=new (v.ofType(u));a.timeInfo=null;a.title="Layer";a.type="subtype-group";
a.addHandles(z.watch(()=>a.sublayers,(c,k)=>a._handleSublayersChange(c,k),z.sync));return a}f._inheritsLoose(n,h);var d=n.prototype;d.destroy=function(){this.source?.destroy();this._handles=w.destroyMaybe(this._handles)};d.normalizeCtorArgs=function(b,a){return"string"===typeof b?{url:b,...a}:b};d.load=function(b){var a=this;const c=w.isSome(b)?b.signal:null,k=this.loadFromPortal({supportedTypes:["Feature Service"]},b).catch(y.throwIfAbortError).then(f._asyncToGenerator(function*(){if(!a.url)throw new q("subtype-grouplayer:missing-url-or-source",
"SubtypeGroupLayer must be created with either a url or a portal item");if(null==a.layerId)throw new q("subtype-grouplayer:missing-layerid","layerId is required for a SubtypeGroupLayer created with url");return a._initLayerProperties(yield a.createGraphicsSource(c))})).then(()=>this.finishLoadEditablePortalLayer(b));this.addResolvingPromise(k);return Promise.resolve(this)};d.readTitleFromService=function(b,{name:a}){return this.url?U.titleFromUrlAndName(this.url,a):a};d.addAttachment=function(){var b=
f._asyncToGenerator(function*(a,c){return m.addAttachment(this,a,c,"SubtypeGroupLayer")});return function(a,c){return b.apply(this,arguments)}}();d.updateAttachment=function(){var b=f._asyncToGenerator(function*(a,c,k){return m.updateAttachment(this,a,c,k,"SubtypeGroupLayer")});return function(a,c,k){return b.apply(this,arguments)}}();d.applyEdits=function(){var b=f._asyncToGenerator(function*(a,c){return m.applyEdits(this,a,c)});return function(a,c){return b.apply(this,arguments)}}();d.on=function(b,
a){return h.prototype.on.call(this,b,a)};d.createGraphicsSource=function(){var b=f._asyncToGenerator(function*(a){const {default:c}=yield y.whenOrAbort(new Promise((k,p)=>C(["./graphics/sources/FeatureLayerSource"],r=>k(Object.freeze(Object.defineProperty({__proto__:null,default:r},Symbol.toStringTag,{value:"Module"}))),p)),a);return(new c({layer:this})).load({signal:a})});return function(a){return b.apply(this,arguments)}}();d.createQuery=function(){const b=m.createQuery(this),a=this.sublayers.map(c=>
c.subtypeCode);b.where=F.sqlAnd(`${this.subtypeField} IN (${a.join(",")})`,this.definitionExpression);return b};d.deleteAttachments=function(){var b=f._asyncToGenerator(function*(a,c){return m.deleteAttachments(this,a,c,"SubtypeGroupLayer")});return function(a,c){return b.apply(this,arguments)}}();d.fetchRecomputedExtents=function(){var b=f._asyncToGenerator(function*(a){return m.fetchRecomputedExtents(this,a,"SubtypeGroupLayer")});return function(a){return b.apply(this,arguments)}}();d.getFieldDomain=
function(b,a){return this._getLayerDomain(b)};d.getField=function(b){return this.fieldsIndex.get(b)};d.queryAttachments=function(){var b=f._asyncToGenerator(function*(a,c){return m.queryAttachments(this,a,c,"SubtypeGroupLayer")});return function(a,c){return b.apply(this,arguments)}}();d.queryFeatures=function(){var b=f._asyncToGenerator(function*(a,c){const k=yield this.load();a=ba.from(a)??k.createQuery();const p=w.unwrapOr(a.outFields,[]);p.includes(this.subtypeField)||(p.push(this.subtypeField),
a.outFields=p);c=yield k.source.queryFeatures(a,c);if(c?.features)for(const r of c.features)r.layer=this._findSublayerForFeature(r),r.sourceLayer=this;return c});return function(a,c){return b.apply(this,arguments)}}();d.queryObjectIds=function(){var b=f._asyncToGenerator(function*(a,c){return m.queryObjectIds(this,a,c,"SubtypeGroupLayer")});return function(a,c){return b.apply(this,arguments)}}();d.queryFeatureCount=function(){var b=f._asyncToGenerator(function*(a,c){return m.queryFeatureCount(this,
a,c,"SubtypeGroupLayer")});return function(a,c){return b.apply(this,arguments)}}();d.queryExtent=function(){var b=f._asyncToGenerator(function*(a,c){return m.queryExtent(this,a,c,"SubtypeGroupLayer")});return function(a,c){return b.apply(this,arguments)}}();d.queryRelatedFeatures=function(){var b=f._asyncToGenerator(function*(a,c){return m.queryRelatedFeatures(this,a,c,"SubtypeGroupLayer")});return function(a,c){return b.apply(this,arguments)}}();d.queryRelatedFeaturesCount=function(){var b=f._asyncToGenerator(function*(a,
c){return m.queryRelatedFeaturesCount(this,a,c,"SubtypeGroupLayer")});return function(a,c){return b.apply(this,arguments)}}();d.write=function(b,a){const {origin:c,layerContainerType:k,messages:p}=a;if(this.isTable){if("web-scene"===c||"web-map"===c&&"tables"!==k)return p?.push(B(this,"using a table source cannot be written to web scenes and web maps")),null}else if(this.loaded&&"web-map"===c&&"tables"===k)return p?.push(B(this,"using a non-table source cannot be written to tables in web maps")),
null;return this.sublayers?.length?h.prototype.write.call(this,b,a):(p?.push(new q("web-document-write:invalid-property",`Layer (${this.title}, ${this.id}) of type '${this.declaredClass}' has invalid value for 'sublayers' property. 'sublayers' collection should contain at least one sublayer`,{layer:this})),null)};d.serviceSupportsSpatialReference=function(b){return this.loaded?aa.serviceSupportsSpatialReference(this,b):!1};d._findSublayerForFeature=function(b){const a=this.fieldsIndex.get(this.subtypeField),
c=b.attributes[a.name];return this.sublayers.find(k=>k.subtypeCode===c)};d._getLayerDomain=function(b){return(b=this.fieldsIndex.get(b))?b.domain:null};d._initLayerProperties=function(){var b=f._asyncToGenerator(function*(a){this._set("source",a);({sourceJSON:a}=a);a&&(this.sourceJSON=a,this.read(a,{origin:"service",url:this.parsedUrl}));if(this.isTable)throw new q("subtype-grouplayer:unsupported-source","SubtypeGroupLayer cannot be created using a layer with table source");if(!this.subtypes?.length)throw new q("subtype-grouplayer:missing-subtypes",
"SubtypeGroupLayer must be created using a layer with subtypes");this._verifyFields();X.fixTimeInfoFields(this.timeInfo,this.fieldsIndex)});return function(a){return b.apply(this,arguments)}}();d.hasDataChanged=function(){var b=f._asyncToGenerator(function*(){return m.hasDataChanged(this)});return function(){return b.apply(this,arguments)}}();d._verifyFields=function(){const b=this.parsedUrl?.path??"undefined";this.objectIdField||console.log("SubtypeGroupLayer: 'objectIdField' property is not defined (url: "+
b+")");this.isTable||-1!==b.search(/\/FeatureServer\//i)||this.fields?.some(a=>"geometry"===a.type)||console.log("SubtypeGroupLayer: unable to find field of type 'geometry' in the layer 'fields' list. If you are using a map service layer, features will not have geometry (url: "+b+")")};d._handleSublayersChange=function(b,a){a&&(a.forEach(c=>{c.parent=null}),this.handles.remove("sublayers-owner"));b&&(b.forEach(c=>{c.parent=this}),this._sublayersCollectionChanged=!1,this.handles.add([b.on("after-add",
({item:c})=>{c.parent=this}),b.on("after-remove",({item:c})=>{c.parent=null}),b.on("after-changes",()=>{this._sublayersCollectionChanged=!0})],"sublayers-owner"))};f._createClass(n,[{key:"createQueryVersion",get:function(){this.commitProperty("definitionExpression");this.commitProperty("timeExtent");this.commitProperty("timeOffset");this.commitProperty("geometryType");this.commitProperty("gdbVersion");this.commitProperty("historicMoment");this.commitProperty("returnZ");this.commitProperty("capabilities");
this.commitProperty("returnM");return(this._get("createQueryVersion")??0)+1}},{key:"editingEnabled",get:function(){return this.loaded&&this.capabilities.operations.supportsEditing&&this.userHasEditingPrivileges}},{key:"parsedUrl",get:function(){const b=A.urlToObject(this.url);null!=b&&null!=this.layerId&&(b.path=A.join(b.path,this.layerId.toString()));return b}},{key:"source",set:function(b){this._get("source")!==b&&this._set("source",b)}}]);return n}(O.FeatureLayerBase(N.EditBusLayer(L.BlendLayer(T.TemporalLayer(S.ScaleRangeLayer(R.RefreshableLayer(K.ArcGISService(P.OperationalLayer(Q.PortalLayer(E.MultiOriginJSONMixin(M.CustomParametersMixin(J.APIKeyMixin(e.HandleOwnerMixin(I))))))))))))));
g.__decorate([l.property({readOnly:!0})],e.prototype,"createQueryVersion",null);g.__decorate([l.property({type:Boolean,readOnly:!0})],e.prototype,"editingEnabled",null);g.__decorate([l.property({...t.fields,readOnly:!0,json:{origins:{service:{read:!0}},read:!1}})],e.prototype,"fields",void 0);g.__decorate([l.property(t.fieldsIndex)],e.prototype,"fieldsIndex",void 0);g.__decorate([l.property(V.id)],e.prototype,"id",void 0);g.__decorate([l.property({type:["show","hide","hide-children"]})],e.prototype,
"listMode",void 0);g.__decorate([l.property({value:"SubtypeGroupLayer",type:["SubtypeGroupLayer"]})],e.prototype,"operationalLayerType",void 0);g.__decorate([l.property(t.outFields)],e.prototype,"outFields",void 0);g.__decorate([l.property({readOnly:!0})],e.prototype,"parsedUrl",null);g.__decorate([l.property()],e.prototype,"source",null);g.__decorate([l.property({type:[Y],readOnly:!0,json:{read:!1,origins:{service:{read:!0}}}})],e.prototype,"subtypes",void 0);g.__decorate([l.property({type:v.ofType(u),
json:{origins:{service:{read:{source:"subtypes",reader:(h,n,d)=>{h=h.map(({code:b})=>{b=new u({subtypeCode:b});b.read(n,d);return b});return new (v.ofType(u))(h)}}}},name:"layers",write:{overridePolicy(h,n,d){n=this.originOf("sublayers");const b=x.OriginId.PORTAL_ITEM;let a=!0;x.nameToId(n)===b&&x.nameToId(d.origin)>b&&(h=h.some(c=>c.hasUserOverrides()),a=this._sublayersCollectionChanged||h);return{enabled:a,ignoreOrigin:!0}}}}})],e.prototype,"sublayers",void 0);g.__decorate([l.property({type:Z})],
e.prototype,"timeInfo",void 0);g.__decorate([l.property({json:{origins:{"portal-item":{write:{ignoreOrigin:!0,writerEnsuresNonNull:!0}}}}})],e.prototype,"title",void 0);g.__decorate([G.reader("service","title",["name"])],e.prototype,"readTitleFromService",null);g.__decorate([l.property({json:{read:!1}})],e.prototype,"type",void 0);return e=g.__decorate([H.subclass("esri.layers.SubtypeGroupLayer")],e)});