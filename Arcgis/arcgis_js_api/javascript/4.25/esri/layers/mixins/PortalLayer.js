// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("require exports ../../chunks/_rollupPluginBabelHelpers ../../chunks/tslib.es6 ../../kernel ../../request ../../core/asyncUtils ../../core/Error ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/urlUtils ../../core/accessorSupport/decorators/property ../../core/arrayUtils ../../core/accessorSupport/ensureType ../../core/accessorSupport/decorators/reader ../../core/accessorSupport/decorators/subclass ../../core/accessorSupport/decorators/writer ../../portal/Portal ../../portal/PortalItem ../../portal/PortalUser".split(" "),
function(y,r,g,h,t,z,A,B,C,m,n,p,q,J,K,D,E,F,u,v,G){var w=null,x=null;r.PortalLayer=e=>{e=function(k){function l(){var c=k.apply(this,arguments)||this;c.resourceReferences={portalItem:null,paths:[]};c.userHasEditingPrivileges=!0;return c}g._inheritsLoose(l,k);var f=l.prototype;f.destroy=function(){this.portalItem=m.destroyMaybe(this.portalItem)};f.readPortalItem=function(c,a,b){if(a.itemId)return new v({id:a.itemId,portal:b&&b.portal})};f.writePortalItem=function(c,a){c&&c.id&&(a.itemId=c.id)};f.loadFromPortal=
function(){var c=g._asyncToGenerator(function*(a,b){if(this.portalItem&&this.portalItem.id)try{const d=yield new Promise((H,I)=>y(["../../portal/support/layersLoader"],H,I));n.throwIfAborted(b);return yield d.load({instance:this,supportedTypes:a.supportedTypes,validateItem:a.validateItem,supportsData:a.supportsData,layerModuleTypeMap:a.layerModuleTypeMap},b)}catch(d){throw n.isAbortError(d)||C.getLogger(this.declaredClass).warn(`Failed to load layer (${this.title}, ${this.id}) portal item (${this.portalItem.id})\n  ${d}`),
d;}});return function(a,b){return c.apply(this,arguments)}}();f.finishLoadEditablePortalLayer=function(){var c=g._asyncToGenerator(function*(a){this._set("userHasEditingPrivileges",yield this._fetchUserHasEditingPrivileges(a).catch(b=>{n.throwIfAbortError(b);return!0}))});return function(a){return c.apply(this,arguments)}}();f._fetchUserHasEditingPrivileges=function(){var c=g._asyncToGenerator(function*(a){const b=this.url?t.id?.findCredential(this.url):null;if(!b)return!0;a=w===b?x:yield this._fetchEditingUser(a);
w=b;x=a;return m.isNone(a)||null==a.privileges||a.privileges.includes("features:user:edit")});return function(a){return c.apply(this,arguments)}}();f._fetchEditingUser=function(){var c=g._asyncToGenerator(function*(a){var b=this.portalItem?.portal?.user;if(b)return b;b=t.id.findServerInfo(this.url??"");if(!b?.owningSystemUrl)return null;b=`${b.owningSystemUrl}/sharing/rest`;const d=u.getDefault();if(d&&d.loaded&&p.normalize(d.restUrl)===p.normalize(b))return d.user;b=`${b}/community/self`;a=m.isSome(a)?
a.signal:null;a=yield A.result(z(b,{authMode:"no-prompt",query:{f:"json"},signal:a}));return a.ok?G.fromJSON(a.value.data):null});return function(a){return c.apply(this,arguments)}}();f.read=function(c,a){a&&(a.layer=this);k.prototype.read.call(this,c,a)};f.write=function(c,a){const b=a&&a.portal,d=this.portalItem&&this.portalItem.id&&(this.portalItem.portal||u.getDefault());return b&&d&&!p.hasSamePortal(d.restUrl,b.restUrl)?(a.messages&&a.messages.push(new B("layer:cross-portal",`The layer '${this.title} (${this.id})' cannot be persisted because it refers to an item on a different portal than the one being saved to. To save, set layer.portalItem to null or save to the same portal as the item associated with the layer`,
{layer:this})),null):k.prototype.write.call(this,c,{...a,layer:this})};g._createClass(l,[{key:"portalItem",set:function(c){c!==this._get("portalItem")&&(this.removeOrigin("portal-item"),this._set("portalItem",c))}}]);return l}(e);h.__decorate([q.property({type:v})],e.prototype,"portalItem",null);h.__decorate([D.reader("web-document","portalItem",["itemId"])],e.prototype,"readPortalItem",null);h.__decorate([F.writer("web-document","portalItem",{itemId:{type:String}})],e.prototype,"writePortalItem",
null);h.__decorate([q.property({clonable:!1})],e.prototype,"resourceReferences",void 0);h.__decorate([q.property({readOnly:!0})],e.prototype,"userHasEditingPrivileges",void 0);return e=h.__decorate([E.subclass("esri.layers.mixins.PortalLayer")],e)};Object.defineProperties(r,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});