// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define(["../../core/screenUtils"],function(r){return function(){function q(b){b&&(this._textRasterizationCanvas=b)}var n=q.prototype;n.rasterizeText=function(b,a){this._textRasterizationCanvas||(this._textRasterizationCanvas=document.createElement("canvas"));const d=this._textRasterizationCanvas;var c=d.getContext("2d");this._setFontProperties(c,a);this._parameters=a;this._textLines=b.split(/\r?\n/);this._lineHeight=this._computeLineHeight();b=this._computeTextWidth(c,a);const {decoration:h,weight:m}=
a.font;this._lineThroughWidthOffset=h&&"line-through"===h?.1*this._lineHeight:0;var e=this._lineHeight*this._textLines.length;d.width=b+2*this._lineThroughWidthOffset;d.height=e;this._renderedLineHeight=Math.round(this._lineHeight*a.pixelRatio);this._renderedHaloSize=a.halo.size*a.pixelRatio;this._renderedWidth=b*a.pixelRatio;this._renderedHeight=e*a.pixelRatio;this._lineThroughWidthOffset*=a.pixelRatio;b=a.halo&&a.halo.color?a.halo.color:[0,0,0,0];e=a.color??[0,0,0,0];this._fillStyle=`rgba(${e.slice(0,
3).toString()},${e[3]})`;this._haloStyle=`rgb(${b.slice(0,3).toString()})`;b=this._renderedLineHeight;e=this._renderedHaloSize;c.save();c.clearRect(0,0,d.width,d.height);this._setFontProperties(c,a);var f=c.textAlign,l=this._renderedWidth;f=("center"===f?.5*l:"right"===f?l:0)+e;l=0<e;let g=this._lineThroughWidthOffset,k=0;l&&this._renderHalo(c,f,e,g,k,a);k+=e;g+=f;for(var p of this._textLines)l&&(c.globalCompositeOperation="destination-out",c.fillStyle="rgb(0, 0, 0)",c.fillText(p,g,k),c.globalCompositeOperation=
"source-over"),c.fillStyle=this._fillStyle,c.fillText(p,g,k),h&&"none"!==h&&this._renderDecoration(c,g,k,h,m),k+=b;c.restore();p=this._renderedWidth+2*this._lineThroughWidthOffset;b=this._renderedHeight;c=c.getImageData(0,0,p,b);c=new Uint8Array(c.data);if(a.premultiplyColors)for(f=0;f<c.length;f+=4)e=c[f+3]/255,c[f]*=e,c[f+1]*=e,c[f+2]*=e;switch(a.horizontalAlignment){case "left":e=-.5;break;case "right":e=.5;break;default:e=0}switch(a.verticalAlignment){case "bottom":a=-.5;break;case "top":a=.5;
break;default:a=0}return{size:[p,b],image:new Uint32Array(c.buffer),sdf:!1,simplePattern:!1,anchorX:e,anchorY:a,canvas:d}};n._renderHalo=function(b,a,d,c,h,m){const e=this._renderedWidth,f=this._renderedHeight;this._haloRasterizationCanvas||(this._haloRasterizationCanvas=document.createElement("canvas"));this._haloRasterizationCanvas.width=e;this._haloRasterizationCanvas.height=f;const l=this._haloRasterizationCanvas,g=l.getContext("2d");g.clearRect(0,0,e,f);this._setFontProperties(g,m);const {decoration:k,
weight:p}=m.font;g.fillStyle=this._haloStyle;g.strokeStyle=this._haloStyle;g.lineJoin="round";this._renderHaloNative(g,a,d,k,p);b.globalAlpha=this._parameters.halo.color[3];b.drawImage(l,0,0,e,f,c,h,e,f);b.globalAlpha=1};n._renderHaloNative=function(b,a,d,c,h){const m=this._renderedLineHeight,e=this._renderedHaloSize;for(const f of this._textLines){const l=2*e;for(let g=0;5>g;g++){const k=(.6+.1*g)*l;b.lineWidth=k;b.strokeText(f,a,d);c&&"none"!==c&&this._renderDecoration(b,a,d,c,h,k)}d+=m}};n._setFontProperties=
function(b,a){var d=a.font;d=`${d.style} ${d.weight} ${r.pt2px(Math.max(a.size,.5)*a.pixelRatio).toFixed(1)}px ${d.family}, sans-serif`;b.font=d;b.textBaseline="top";switch(a.horizontalAlignment){case "left":a="left";break;case "right":a="right";break;case "center":a="center";break;default:a="left"}b.textAlign=a};n.computeTextSize=function(b,a){this._textRasterizationCanvas||(this._textRasterizationCanvas=document.createElement("canvas"));const d=this._textRasterizationCanvas;var c=d.getContext("2d");
this._setFontProperties(c,a);this._parameters=a;this._textLines=b.split(/\r?\n/);this._lineHeight=this._computeLineHeight();b=this._computeTextWidth(c,a);c=this._lineHeight*this._textLines.length;d.width=b;d.height=c;return[b*a.pixelRatio,c*a.pixelRatio]};n._computeTextWidth=function(b,a){let d=0;for(const c of this._textLines)d=Math.max(d,b.measureText(c).width);a=a.font;if("italic"===a.style||"oblique"===a.style||"string"===typeof a.weight&&("bold"===a.weight||"bolder"===a.weight)||"number"===typeof a.weight&&
600<a.weight)d+=.3*b.measureText("w").width;d+=2*this._parameters.halo.size;return Math.round(d)};n._computeLineHeight=function(){let b=1.275*this._parameters.size;const a=this._parameters.font.decoration;a&&"underline"===a&&(b*=1.3);return Math.round(b+2*this._parameters.halo.size)};n._renderDecoration=function(b,a,d,c,h,m){const e=.9*this._lineHeight;switch(b.textAlign){case "center":a-=this._renderedWidth/2;break;case "right":a-=this._renderedWidth}const f=b.textBaseline;if("underline"===c)switch(f){case "top":d+=
e;break;case "middle":d+=e/2}else if("line-through"===c)switch(f){case "top":d+=e/1.5;break;case "middle":d+=e/3}c=m?1.5*m:Math.ceil(e*("bold"===h?.06:"bolder"===h?.09:.04));b.save();b.beginPath();b.strokeStyle=b.fillStyle;b.lineWidth=c;b.moveTo(a-this._lineThroughWidthOffset,d);b.lineTo(a+this._renderedWidth+2*this._lineThroughWidthOffset,d);b.stroke();b.restore()};return q}()});