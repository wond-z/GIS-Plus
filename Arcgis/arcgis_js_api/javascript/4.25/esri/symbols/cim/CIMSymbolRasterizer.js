// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../Color ../../request ../../core/maybe ../../core/promiseUtils ../../core/screenUtils ./cimAnalyzer ./CIMResourceManager ./CIMSymbolDrawHelper ./CIMSymbolHelper ./Rasterizer ./TextRasterizer ./utils ../support/cimSymbolUtils ../support/Symbol3DAnchorPosition2D".split(" "),function(B,C,Q,R,D,S,v,F,T,G,E,U,V,r,W,X){B.GeometryStyle=void 0;(function(A){A.Legend="legend";A.Preview="preview"})(B.GeometryStyle||(B.GeometryStyle={}));const Y=96/72;
let Z=function(){function A(b,a){this._spatialReference=b;this._avoidSDF=a;this._resourceCache=new Map;this._imageDataCanvas=null;this._pictureMarkerCache=new Map;this._textRasterizer=new V;this._cimResourceManager=new T;this._rasterizer=new U(this._cimResourceManager)}var w=A.prototype;w.rasterizeCIMSymbolAsync=function(){var b=C._asyncToGenerator(function*(a,f,c,d,h,l,n,e){if(!a)return null;var {data:k}=a;if(!k||"CIMSymbolReference"!==k.type||!k.symbol)return null;({symbol:a}=k);l||(l=r.mapCIMSymbolToGeometryType(a));
f=yield E.OverrideHelper.resolveSymbolOverrides(k,f,this._spatialReference,h,l,n,e);this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));h=this._imageDataCanvas;n=this._cimResourceManager;e=[];E.CIMSymbolHelper.fetchResources(f,n,e);0<e.length&&(yield Promise.all(e));const {width:m,height:p}=c;a:{c=-m/2+1;e=m/2-1;k=p/2-1;var t=-p/2+1;switch(l){case "esriGeometryPoint":l={x:0,y:0};break a;case "esriGeometryPolyline":l={paths:[[[c,0],[0,0],[e,0]]]};break a;default:l="legend"===
d?{rings:[[[c,k],[e,0],[e,t],[c,t],[c,k]]]}:{rings:[[[c,k],[e,k],[e,t],[c,t],[c,k]]]}}}var g=E.CIMSymbolHelper.getEnvelope(f,l,n);if(!g)return null;c=(window.devicePixelRatio||1)*Y;k=1;t=e=0;switch(a.type){case "CIMPointSymbol":case "CIMTextSymbol":a=1;g.width>m&&(a=m/g.width);e=1;g.height>p&&(e=p/g.height);"preview"===d&&(g.width<m&&(a=m/g.width),g.height<p&&(e=p/g.height));k=Math.min(a,e);e=g.x+g.width/2;t=g.y+g.height/2;break;case "CIMLineSymbol":d=1;g.height>p&&(d=p/g.height);k=d;t=g.y+g.height/
2;d=g.x*k+m/2;a=(g.x+g.width)*k+m/2;0>d&&({paths:g}=l,g[0][0][0]-=d);a>m&&({paths:d}=l,d[0][2][0]-=a-m);break;case "CIMPolygonSymbol":e=g.x+g.width/2;t=g.y+g.height/2;d=g.x*k+m/2;a=(g.x+g.width)*k+m/2;const u=g.y*k+p/2;g=(g.y+g.height)*k+p/2;const {rings:q}=l;0>d&&(q[0][0][0]-=d,q[0][3][0]-=d,q[0][4][0]-=d);0>u&&(q[0][0][1]+=u,q[0][1][1]+=u,q[0][4][1]+=u);a>m&&(q[0][1][0]-=a-m,q[0][2][0]-=a-m);g>p&&(q[0][2][1]+=g-p,q[0][3][1]+=g-p)}h.width=m*c;h.height=p*c;h.width+=2;h.height+=2;d=h.getContext("2d");
a=G.Transformation.createIdentity();a.translate(-e,-t);a.scale(k*c,-k*c);a.translate(m*c/2+1,p*c/2+1);d.clearRect(0,0,h.width,h.height);(new G.CanvasDrawHelper(d,n,a,!0)).drawSymbol(f,l);return d.getImageData(0,0,h.width,h.height)});return function(a,f,c,d,h,l,n,e){return b.apply(this,arguments)}}();w.analyzeCIMSymbol=function(){var b=C._asyncToGenerator(function*(a,f,c,d,h){const l=[];yield F.analyzeCIMSymbol(a.data,f?{geometryType:d,spatialReference:this._spatialReference,fields:f}:null,this._cimResourceManager,
l,this._avoidSDF);S.throwIfAborted(h);let n;for(const e of l){if("CIMPictureMarker"===e.cim.type||"CIMPictureFill"===e.cim.type||"CIMPictureStroke"===e.cim.type)n||(n=[]),n.push(this._fetchPictureMarkerResource(e,h));c&&"text"===e.type&&"string"===typeof e.text&&e.text.includes("[")&&(e.text=r.createLabelOverrideFunction(c,e.text,e.cim.textCase))}n&&(yield Promise.all(n));return l});return function(a,f,c,d,h){return b.apply(this,arguments)}}();w.rasterizeCIMSymbol3D=function(b,a,f,c,d,h){const l=
[];for(const e of b){c&&"function"===typeof c.scaleFactor&&(c.scaleFactor=c.scaleFactor(a,d,h));b=this._getRasterizedResource(e,a,f,c,d,h);if(!b)continue;let k=0,m=b.anchorX||0,p=b.anchorY||0,t=!1,g=0;var n=0;if("esriGeometryPoint"===f)if(n=c&&c.scaleFactor?c.scaleFactor:1,g=r.evaluateValueOrFunction(e.offsetX,a,d,h)*n||0,n=r.evaluateValueOrFunction(e.offsetY,a,d,h)*n||0,"marker"===e.type)k=r.evaluateValueOrFunction(e.rotation,a,d,h)||0,t=e.rotateClockwise?e.rotateClockwise:!1;else if("text"===e.type){k=
r.evaluateValueOrFunction(e.angle,a,d,h)||0;if(void 0!==e.horizontalAlignment)switch(e.horizontalAlignment){case "left":m=-.5;break;case "right":m=.5;break;default:m=0}if(void 0!==e.verticalAlignment)switch(e.verticalAlignment){case "top":p=.5;break;case "bottom":p=-.5;break;case "baseline":p=-.25;break;default:p=0}}null!=b&&l.push({angle:k,rotateClockWise:t,anchorX:m,anchorY:p,offsetX:g,offsetY:n,rasterizedResource:b})}return this.getSymbolImage(l)};w.getSymbolImage=function(b){const a=document.createElement("canvas"),
f=D.unwrapOrThrow(a.getContext("2d"));var c=0,d=0,h=0,l=0,n=[];for(var e=0;e<b.length;e++){var k=b[e],m=k.rasterizedResource;if(!m)continue;var p=m.size,t=k.offsetX;const H=k.offsetY,I=k.anchorX,J=k.anchorY,K=k.rotateClockWise||!1;k=k.angle;var g=v.pt2px(t)-p[0]*(.5+I);let x=v.pt2px(H)-p[1]*(.5+J),z=g+p[0];var u=x+p[1];if(k){K&&(k=-k);var q=Math.sin(k*Math.PI/180);const y=Math.cos(k*Math.PI/180);p=g*y-x*q;const L=g*q+x*y,M=g*y-u*q,N=g*q+u*y,O=z*y-u*q;u=z*q+u*y;const P=z*y-x*q;q=z*q+x*y;g=Math.min(p,
M,O,P);x=Math.min(L,N,u,q);z=Math.max(p,M,O,P);u=Math.max(L,N,u,q)}c=g<c?g:c;d=x<d?x:d;h=z>h?z:h;l=u>l?u:l;g=f.createImageData(m.size[0],m.size[1]);g.data.set(new Uint8ClampedArray(m.image.buffer));n.push({offsetX:t,offsetY:H,rotateClockwise:K,angle:k,rasterizedImage:g,anchorX:I,anchorY:J})}a.width=h-c;a.height=l-d;b=-c;for(c=0;c<n.length;c++)d=n[c],h=this._imageDataToCanvas(d.rasterizedImage),e=b-d.rasterizedImage.width*(.5+d.anchorX),m=l-d.rasterizedImage.height*(.5-d.anchorY),d.angle?(t=(360-d.angle)*
Math.PI/180,f.save(),f.translate(v.pt2px(d.offsetX),-v.pt2px(d.offsetY)),f.translate(b,l),f.rotate(t),f.translate(-b,-l),f.drawImage(h,e,m),f.restore()):f.drawImage(h,e+v.pt2px(d.offsetX),m-v.pt2px(d.offsetY));n=new X.Symbol3DAnchorPosition2D({x:b/a.width-.5,y:l/a.height-.5});return{imageData:0!==a.width&&0!==a.height?f.getImageData(0,0,a.width,a.height):f.createImageData(1,1),anchorPosition:n}};w._fetchPictureMarkerResource=function(){var b=C._asyncToGenerator(function*(a,f){const c=a.materialHash;
this._pictureMarkerCache.get(c)||(a=(yield R(a.cim.url,{responseType:"image",signal:f&&f.signal})).data,this._pictureMarkerCache.set(c,a))});return function(a,f){return b.apply(this,arguments)}}();w._imageDataToCanvas=function(b){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const a=this._imageDataCanvas,f=D.unwrapOrThrow(a.getContext("2d"));a.width=b.width;a.height=b.height;f.putImageData(b,0,0);return a};w._imageTo32Array=function(b,a,f,c){this._imageDataCanvas||
(this._imageDataCanvas=document.createElement("canvas"));const d=this._imageDataCanvas,h=D.unwrapOrThrow(d.getContext("2d"));d.width=a;d.height=f;h.drawImage(b,0,0,a,f);c&&(h.save(),c=new Q(c),h.fillStyle=c.toHex(),h.globalCompositeOperation="multiply",h.fillRect(0,0,a,f),h.globalCompositeOperation="destination-atop",h.drawImage(b,0,0,a,f),h.restore());return new Uint32Array(h.getImageData(0,0,a,f).data.buffer)};w._getRasterizedResource=function(b,a,f,c,d,h){if("text"===b.type)return this._rasterizeTextResource(b,
a,c,d,h);if("function"===typeof b.materialHash){var l=b.materialHash;l=l(a,d,h);var n=F.analyzeCIMResource(b.cim,b.materialOverrides)}else l=b.materialHash,n=b.cim;({analyzedCIM:n,hash:l}={analyzedCIM:n,hash:l});const e=c&&c.scaleFactor?c.scaleFactor:1;if("CIMPictureMarker"===b.cim.type){f=r.evaluateValueOrFunction(b.size,a,d,h)*e;const {image:k,width:m,height:p}=D.unwrapOrThrow(this._getPictureResource(b,f,r.evaluateValueOrFunction(b.color,a,d,h)));return b={image:k,size:[m,p],sdf:!1,simplePattern:!1,
anchorX:b.anchorPoint?b.anchorPoint.x:0,anchorY:b.anchorPoint?b.anchorPoint.y:0}}W.scaleCIMMarker(n,e,{preserveOutlineWidth:!1});a=n;l+=f;c&&(l+=JSON.stringify(c));f=this._resourceCache;if(f.has(l))return f.get(l);b=this._rasterizer.rasterizeJSONResource({cim:a,type:b.type,url:b.url,mosaicHash:l,size:null,path:null},window.devicePixelRatio||1,this._avoidSDF);f.set(l,b);return b};w._rasterizeTextResource=function(b,a,f,c,d){var h=f&&f.scaleFactor?f.scaleFactor:1;f=r.evaluateValueOrFunction(b.text,
a,c,d);if(!f||0===f.length)return null;const l=r.evaluateValueOrFunction(b.fontName,a,c,d),n=r.evaluateValueOrFunction(b.style,a,c,d),e=r.evaluateValueOrFunction(b.weight,a,c,d),k=r.evaluateValueOrFunction(b.decoration,a,c,d);h*=r.evaluateValueOrFunction(b.size,a,c,d);const m=r.evaluateValueOrFunction(b.horizontalAlignment,a,c,d),p=r.evaluateValueOrFunction(b.verticalAlignment,a,c,d),t=r.colorToArray(r.evaluateValueOrFunction(b.color,a,c,d)),g=r.colorToArray(r.evaluateValueOrFunction(b.outlineColor,
a,c,d));b=r.evaluateValueOrFunction(b.outlineSize,a,c,d);return this._textRasterizer.rasterizeText(f,{color:t,size:h,horizontalAlignment:m,verticalAlignment:p,font:{family:l,style:n,weight:e,decoration:k},halo:{size:b||0,color:g,style:n},pixelRatio:1,premultiplyColors:!this._avoidSDF})};w._getPictureResource=function(b,a,f){b=this._pictureMarkerCache.get(b.materialHash);if(!b)return null;const c=b.height/b.width,d=a?1<c?v.pt2px(a):v.pt2px(a)/c:b.width;a=a?1<c?v.pt2px(a)*c:v.pt2px(a):b.height;return{image:this._imageTo32Array(b,
d,a,f),width:d,height:a}};C._createClass(A,[{key:"resourceManager",get:function(){return this._cimResourceManager}}]);return A}();B.CIMSymbolRasterizer=Z;Object.defineProperties(B,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});