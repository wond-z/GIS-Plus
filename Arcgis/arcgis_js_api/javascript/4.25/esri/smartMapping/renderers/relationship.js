// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.25/esri/copyright.txt for details.
//>>built
define("exports ../../chunks/_rollupPluginBabelHelpers ../../core/Error ../../core/lang ../../core/maybe ../../intl/messages ../../renderers/support/AuthoringInfo ../../renderers/support/AuthoringInfoClassBreakInfo ../../renderers/support/AuthoringInfoFieldInfo ./type ./support/utils ../support/binningUtils ../support/adapters/support/layerUtils ../symbology/relationship ../../symbols/support/utils".split(" "),function(x,n,h,N,y,O,P,I,J,Q,t,R,u,v,S){function T(a){return z.apply(this,arguments)}function z(){z=
n._asyncToGenerator(function*(a){if(!(a&&a.layer&&a.view&&a.field1&&a.field2))throw new h("relationship-renderer:missing-parameters","'layer', 'view', 'field1' and 'field2' parameters are required");a.forBinning&&R.verifyBinningParams(a,"relationship-renderer");const b={...a};b.symbolType=b.symbolType||"2d";b.defaultSymbolEnabled=null==b.defaultSymbolEnabled?!0:b.defaultSymbolEnabled;b.classificationMethod=b.classificationMethod||"quantile";b.numClasses=b.numClasses||3;b.focus=b.focus||null;if(!U.includes(b.classificationMethod))throw new h("relationship-renderer:invalid-parameters",
`classification method ${b.classificationMethod} is not supported`);if(2>b.numClasses||4<b.numClasses)throw new h("relationship-renderer:invalid-parameters","'numClasses' must be 2, 3 or 4");if(a.focus&&!V.includes(a.focus))throw new h("relationship-renderer:invalid-parameters","'focus' must be 'HH', 'HL', 'LH', 'LL' or null");var c=a.forBinning?u.binningCapableLayerTypes:u.featureCapableLayerTypes;a=u.createLayerAdapter(b.layer,c,a.forBinning);b.layer=a;if(!a)throw new h("relationship-renderer:invalid-parameters",
"'layer' must be one of these types: "+u.getLayerTypeLabels(c).join(", "));c=y.isSome(b.signal)?{signal:b.signal}:null;yield a.load(c);c=a.geometryType;const d=b.symbolType.includes("3d");b.outlineOptimizationEnabled="polygon"===c?b.outlineOptimizationEnabled:!1;b.sizeOptimizationEnabled="point"===c||"multipoint"===c||"polyline"===c?b.sizeOptimizationEnabled:!1;if("mesh"===c)b.symbolType="3d-volumetric",b.colorMixMode=b.colorMixMode||"replace",b.edgesType=b.edgesType||"none";else{if("3d-volumetric-uniform"===
b.symbolType&&"point"!==c)throw new h("relationship-renderer:not-supported","3d-volumetric-uniform symbols are supported for point layers only");if(d&&"polygon"===c)throw new h("relationship-renderer:not-supported","3d symbols are not supported for polygon layers");if(b.symbolType.includes("3d-volumetric")&&(!b.view||"3d"!==b.view.type))throw new h("relationship-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'");
}const {field1:e,field2:f}=b;c=[e.field,f.field];e.normalizationField&&c.push(e.normalizationField);f.normalizationField&&c.push(f.normalizationField);if(a=t.verifyBasicFieldValidity(a,c,"relationship-renderer:invalid-parameters"))throw a;return b});return z.apply(this,arguments)}function W(a){return A.apply(this,arguments)}function A(){A=n._asyncToGenerator(function*(a){if(!(a&&a.renderer&&a.numClasses))throw new h("update-relationship-renderer:missing-parameters","'renderer' and 'numClasses' parameters are required");
const {field1:b,field2:c,renderer:d,numClasses:e,colors:f}=a,g=e**2;if((b||c)&&!(b&&c&&b.field&&c.field))throw new h("update-relationship-renderer:missing-parameters","'field1' and 'field2' parameters are required");if(b&&!b.classBreakInfos||c&&!c.classBreakInfos)throw new h("update-relationship-renderer:missing-parameters","'field1.classBreakInfos' and 'field2.classBreakInfos' are required");if(!d.authoringInfo)throw new h("update-relationship-renderer:missing-parameters","'renderer.authoringInfo' is required");
if(d.uniqueValueInfos.length!==g)throw new h("update-relationship-renderer:invalid-parameters",`Renderer must have ${g} unique value infos to support ${e} classes`);if(f&&f.length!==g)throw new h("update-relationship-renderer:invalid-parameters",`The scheme must have ${g} colors`);return a});return A.apply(this,arguments)}function X(a){return B.apply(this,arguments)}function B(){B=n._asyncToGenerator(function*(a){let b=a.relationshipScheme,c=null;var d=null;d=yield t.getBasemapInfo(a.basemap,a.view);
c=y.isSome(d.basemapId)?d.basemapId:null;d=y.isSome(d.basemapTheme)?d.basemapTheme:null;if(b)return{scheme:v.cloneScheme(b),basemapId:c,basemapTheme:d};if(a=v.getSchemes({basemap:c,basemapTheme:d,geometryType:a.geometryType,theme:a.theme,worldScale:a.worldScale,view:a.view}))b=a.primaryScheme,c=a.basemapId,d=a.basemapTheme;return{scheme:b,basemapId:c,basemapTheme:d}});return B.apply(this,arguments)}function K(a,b){a=N.clone(Y[a]);return v.flatten2DArray(a,b)}function Z(a,b){return K(a,b).map(c=>({value:c,
count:0}))}function L(a,b,c,d){const {field:e,normalizationField:f}=a,{field:g,normalizationField:k}=b;a=c.map(l=>[l.minValue,l.maxValue]);d=d.map(l=>[l.minValue,l.maxValue]);b=aa[a.length];return`\n  var field1 = $feature['${e}'];\n  var field2 = $feature['${g}'];\n  var hasNormField1 = ${f?"true":"false"};\n  var hasNormField2 = ${k?"true":"false"};\n  var normField1 = ${f?`$feature['${f}']`:"null"};\n  var normField2 = ${k?`$feature['${k}']`:"null"};\n\n  if (\n    IsEmpty(field1) ||\n    IsEmpty(field2) ||\n    (hasNormField1 && (IsEmpty(normField1) || normField1 == 0)) ||\n    (hasNormField2 && (IsEmpty(normField2) || normField2 == 0))\n  ) {\n    return null;\n  }\n\n  var value1 = IIf(hasNormField1, (field1 / normField1), field1);\n  var value2 = IIf(hasNormField2, (field2 / normField2), field2);\n\n  var breaks1 = ${JSON.stringify(a)};\n  var breaks2 = ${JSON.stringify(d)};\n  var classCodes = ${JSON.stringify(b)};\n\n  function getClassCode(value, breaks) {\n    var code = null;\n\n    for (var i in breaks) {\n      var info = breaks[i];\n      if (value >= info[0] && value <= info[1]) {\n        code = classCodes[i];\n        break;\n      }\n    }\n\n    return code;\n  }\n\n  var code1 = getClassCode(value1, breaks1);\n  var code2 = getClassCode(value2, breaks2);\n\n  var classValue = IIf(IsEmpty(code1) || IsEmpty(code2), null, code1 + code2);\n  return classValue;\n  `}
function ba(a,b,c){return C.apply(this,arguments)}function C(){C=n._asyncToGenerator(function*(a,b,c){var d=yield O.fetchMessageBundle("esri/smartMapping/t9n/smartMapping");const {basemap:e,classificationMethod:f,field1:g,field2:k,focus:l,numClasses:m,signal:p}=a;var q=a.layer,r=b.classBreakInfos;const D=c.classBreakInfos;if(m!==r.length||r.length!==D.length)throw new h("relationship-renderer:error","incompatible class breaks");var E=Z(m,l);const ca=L(a.field1,a.field2,r,D),F=(yield X({basemap:e,
geometryType:q.geometryType,theme:"default",relationshipScheme:a.relationshipScheme,worldScale:a.symbolType.includes("3d-volumetric"),view:a.view})).scheme;a=yield Q.createRenderer({layer:q,basemap:e,valueExpression:ca,valueExpressionTitle:d.relationship.legendTitle,numTypes:-1,sortEnabled:!1,defaultSymbolEnabled:a.defaultSymbolEnabled,typeScheme:{colors:v.getColors(F,m,l),...F},statistics:{uniqueValueInfos:E},legendOptions:a.legendOptions,outlineOptimizationEnabled:a.outlineOptimizationEnabled,sizeOptimizationEnabled:a.sizeOptimizationEnabled,
symbolType:a.symbolType,colorMixMode:a.colorMixMode,edgesType:a.edgesType,view:a.view,signal:p});q=a.renderer;E=q.uniqueValueInfos;d=d.relationship;for(const M of E)M.label=d[M.value];r=new P({type:"relationship",classificationMethod:f,numClasses:m,focus:l,field1:{field:g.field,normalizationField:g.normalizationField,label:g.label,classBreakInfos:r.map(w)},field2:{field:k.field,normalizationField:k.normalizationField,label:k.label,classBreakInfos:D.map(w)}});q.authoringInfo=r;return{renderer:q,classBreaks:{field1:b,
field2:c},uniqueValueInfos:a.uniqueValueInfos,relationshipScheme:F,basemapId:a.basemapId,basemapTheme:a.basemapTheme}});return C.apply(this,arguments)}function da(a,b,c){const d=K(b,c);a.sort((e,f)=>{e=d.indexOf(e.value);f=d.indexOf(f.value);let g=0;e<f?g=-1:e>f&&(g=1);return g})}function ea(a,b){const {authoringInfo:c}=a;c.numClasses=b.numClasses;c.focus=b.focus||null;c.focus||delete c.focus;const {field1:d,field2:e}=b;c.field1=new J.AuthoringInfoFieldInfo({field:d.field,normalizationField:d.normalizationField,
label:d.label,classBreakInfos:d.classBreakInfos.map(f=>new I.AuthoringInfoClassBreakInfo(w(f)))});c.field2=new J.AuthoringInfoFieldInfo({field:e.field,normalizationField:e.normalizationField,label:e.label,classBreakInfos:e.classBreakInfos.map(f=>new I.AuthoringInfoClassBreakInfo(w(f)))});a.authoringInfo=c}function G(){G=n._asyncToGenerator(function*(a){a=yield W(a);const {field1:b,field2:c,renderer:d,numClasses:e,focus:f,colors:g}=a,k=d.clone();k.valueExpression=L(b,c,b.classBreakInfos,c.classBreakInfos);
da(k.uniqueValueInfos,e,f);if(g){const l=t.createColors(g,g.length);k.uniqueValueInfos.forEach((m,p)=>S.applyColorToSymbol(m.symbol,l[p]))}ea(k,a);return k});return G.apply(this,arguments)}function H(){H=n._asyncToGenerator(function*(a){a=yield T(a);const {layer:b,classificationMethod:c,field1:d,field2:e,numClasses:f,view:g,signal:k}=a,l={layer:b,classificationMethod:c,field:e.field,normalizationField:e.normalizationField,normalizationType:e.normalizationField?"field":null,minValue:e.minValue,maxValue:e.maxValue,
analyzeData:!(null!=e.minValue&&null!=e.maxValue),numClasses:f,view:g,signal:k},[m,p]=yield Promise.all([t.getClassBreaks({layer:b,classificationMethod:c,field:d.field,normalizationField:d.normalizationField,normalizationType:d.normalizationField?"field":null,minValue:d.minValue,maxValue:d.maxValue,analyzeData:!(null!=d.minValue&&null!=d.maxValue),numClasses:f,view:g,signal:k}),t.getClassBreaks(l)]);if(!m||!p)throw new h("relationship-renderer:error","error when calculating class breaks");return ba(a,
m.result,p.result)});return H.apply(this,arguments)}const U=["equal-interval","natural-breaks","quantile"],V=["HH","HL","LH","LL"],Y={2:[["HL","HH"],["LL","LH"]],3:[["HL","HM","HH"],["ML","MM","MH"],["LL","LM","LH"]],4:[["HL","HM1","HM2","HH"],["M2L","M2M1","M2M2","M2H"],["M1L","M1M1","M1M2","M1H"],["LL","LM1","LM2","LH"]]},aa={2:["L","H"],3:["L","M","H"],4:["L","M1","M2","H"]},w=a=>({minValue:a.minValue,maxValue:a.maxValue});x.createRenderer=function(a){return H.apply(this,arguments)};x.updateRenderer=
function(a){return G.apply(this,arguments)};Object.defineProperties(x,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});